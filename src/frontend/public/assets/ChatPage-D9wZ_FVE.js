import{r as o,j as e,a as l,a2 as J,a3 as Z,b as ee,g as te,a4 as re,a5 as se,V as ae,a6 as ne,a7 as oe,a8 as ie,o as le,a9 as ce,O as P,N as I,aa as de,ab as xe,ac as me,ad as ue,ae as pe}from"./main-fI1tvvj5.js";import{C as ge}from"./chevron-down-Cv_bzBMP.js";import{R as he}from"./rotate-cw-CtFbDYPA.js";import{S as fe}from"./send-DbUBalGk.js";import{P as be}from"./plus-B5uVkXEF.js";function Q({contact:t,compact:a}){const s=ee(t);return e.jsxs("div",{className:l("flex items-center gap-2 min-w-0",a?"py-0":"py-0.5"),children:[s?e.jsx("img",{src:s,alt:"",className:l("rounded-full object-cover shrink-0 bg-secondary",a?"w-5 h-5":"w-7 h-7")}):e.jsx("div",{className:l("rounded-full bg-primary/10 text-primary font-bold flex items-center justify-center shrink-0",a?"w-5 h-5 text-[8px]":"w-7 h-7 text-[10px]"),children:te(t.name||"?")}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:l("font-medium text-foreground block truncate",a?"text-[11px]":"text-xs"),children:t.name}),!a&&(t.role||t.organization)&&e.jsx("span",{className:"text-[10px] text-muted-foreground block truncate",children:[t.role,t.organization].filter(Boolean).join(" · ")})]}),t.role&&a&&e.jsx("span",{className:"text-[9px] px-1.5 py-0.5 rounded-full bg-secondary text-muted-foreground shrink-0",children:t.role})]})}function q({contacts:t,value:a,onChange:s,placeholder:n="No context",className:c,compact:i}){const[u,f]=o.useState(!1),[b,m]=o.useState(""),N=o.useRef(null),v=o.useRef(null),j=t.find(d=>d.id===a)??null,w=b.trim()?t.filter(d=>{const g=b.toLowerCase();return d.name?.toLowerCase().includes(g)||d.role?.toLowerCase().includes(g)||d.organization?.toLowerCase().includes(g)||d.email?.toLowerCase().includes(g)}):t;o.useEffect(()=>{if(!u)return;const d=g=>{N.current&&!N.current.contains(g.target)&&(f(!1),m(""))};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[u]),o.useEffect(()=>{u&&v.current&&v.current.focus()},[u]);const p=o.useCallback(d=>{s(d),f(!1),m("")},[s]);return e.jsxs("div",{ref:N,className:l("relative",c),children:[e.jsxs("button",{type:"button",onClick:()=>f(!u),className:l("w-full flex items-center gap-2 rounded-lg border border-border bg-card px-2.5 text-left transition-colors hover:bg-secondary/50 focus:outline-none focus:ring-2 focus:ring-ring",i?"py-1":"py-1.5"),children:[j?e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(Q,{contact:j,compact:i})}):e.jsx("span",{className:l("flex-1 text-muted-foreground",i?"text-[11px]":"text-xs"),children:n}),j&&e.jsx("button",{type:"button",onClick:d=>{d.stopPropagation(),p(null)},className:"p-0.5 rounded hover:bg-secondary text-muted-foreground hover:text-foreground shrink-0",children:e.jsx(J,{className:"w-3 h-3"})}),e.jsx(ge,{className:l("w-3 h-3 text-muted-foreground shrink-0 transition-transform",u&&"rotate-180")})]}),u&&e.jsxs("div",{className:"absolute z-50 top-full left-0 right-0 mt-1 rounded-lg border border-border bg-popover shadow-lg overflow-hidden animate-in fade-in-0 zoom-in-95 duration-100",children:[t.length>5&&e.jsxs("div",{className:"flex items-center gap-2 px-2.5 py-2 border-b border-border",children:[e.jsx(Z,{className:"w-3 h-3 text-muted-foreground shrink-0"}),e.jsx("input",{ref:v,type:"text",value:b,onChange:d=>m(d.target.value),placeholder:"Search contacts...",className:"flex-1 bg-transparent text-xs text-foreground placeholder:text-muted-foreground focus:outline-none"})]}),e.jsx("button",{type:"button",onClick:()=>p(null),className:l("w-full text-left px-3 py-2 text-xs text-muted-foreground hover:bg-secondary/50 transition-colors border-b border-border/50",!a&&"bg-primary/5 text-primary font-medium"),children:n}),e.jsx("div",{className:"max-h-[240px] overflow-y-auto scrollbar-thin",children:w.length===0?e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"No contacts found"}):w.map(d=>e.jsx("button",{type:"button",onClick:()=>p(d.id),className:l("w-full text-left px-3 py-2 hover:bg-secondary/50 transition-colors",d.id===a&&"bg-primary/5"),children:e.jsx(Q,{contact:d})},d.id))})]})]})}const B="rounded-xl border border-[var(--gm-border-primary)] bg-[var(--gm-surface-primary)] shadow-[var(--shadow-sm)] transition-all duration-200",ye="w-full bg-[var(--gm-bg-tertiary)] border border-[var(--gm-border-primary)] rounded-lg px-3 py-2 text-sm text-[var(--gm-text-primary)] placeholder:text-[var(--gm-text-placeholder)] focus:outline-none focus:border-[var(--gm-border-focus)] focus:shadow-[var(--shadow-focus)] transition-all duration-150",M="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-[var(--gm-interactive-primary)] text-[var(--gm-text-on-brand)] hover:bg-[var(--gm-interactive-primary-hover)] shadow-sm transition-all duration-150 disabled:opacity-50",ve="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-[var(--gm-interactive-secondary)] text-[var(--gm-text-primary)] hover:bg-[var(--gm-interactive-secondary-hover)] border border-[var(--gm-border-primary)] transition-all duration-150",O=["Summarize key risks","List open questions","What actions are overdue?","Who are the key contacts?"];function je(t){if(!t)return"—";const a=new Date(t).getTime();if(isNaN(a))return"—";const s=Date.now()-a,n=Math.floor(s/6e4);if(n<1)return"just now";if(n<60)return`${n}m ago`;const c=Math.floor(n/60);return c<24?`${c}h ago`:`${Math.floor(c/24)}d ago`}function Ne({msg:t}){if(t.role!=="assistant")return null;const a=[];if(t.confidence){const s=t.confidence==="high"?"bg-emerald-500/15 text-emerald-400":t.confidence==="medium"?"bg-amber-500/15 text-amber-400":"bg-red-500/15 text-red-400";a.push({label:t.confidence,cls:s,title:"Confidence"})}if(t.queryType&&a.push({label:t.queryType,cls:"bg-indigo-500/15 text-indigo-400",title:"Query type"}),t.rag){const s=t.rag.usedHyDE?"HyDE+RRF":t.rag.graphResults>0?"Graph+Vector":"Hybrid";a.push({label:s,cls:"bg-purple-500/15 text-purple-400",title:`RAG: ${t.rag.method??s}`});const n=t.rag.fusedResults||t.rag.vectorResults+t.rag.graphResults;n>0&&a.push({label:`${n} sources`,cls:"bg-sky-500/15 text-sky-400",title:"Sources found"})}return a.length===0?null:e.jsx("div",{className:"flex flex-wrap gap-1.5 mt-2 pt-2 border-t border-white/10",children:a.map((s,n)=>e.jsx("span",{title:s.title,className:l("text-[10px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded-full",s.cls),children:s.label},n))})}function we({sources:t}){const a=t.filter(s=>s.contactName);return a.length===0?null:e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:a.map((s,n)=>e.jsxs("div",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/20 text-xs",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-purple-500/30 text-purple-400 flex items-center justify-center text-[10px] font-bold shrink-0",children:(s.contactName||"?")[0]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("span",{className:"font-semibold text-purple-300 block truncate",children:s.contactName}),s.contactRole&&e.jsx("span",{className:"text-[10px] text-purple-400/70",children:s.contactRole})]})]},n))})}function Ce({sources:t}){const[a,s]=o.useState(!1),n=t.filter(i=>!i.contactName);if(n.length===0)return null;const c=n.slice(0,5);return e.jsxs("div",{className:"mt-2 text-xs",children:[e.jsxs("button",{onClick:()=>s(!a),className:"flex items-center gap-1 text-[var(--gm-text-tertiary)] hover:text-[var(--gm-text-primary)] transition-colors",children:[e.jsx(pe,{className:l("w-3 h-3 transition-transform",a&&"rotate-90")}),t.length," sources used"]}),a&&e.jsxs("div",{className:"mt-1.5 p-2 rounded-lg bg-[var(--gm-bg-tertiary)] space-y-1",children:[c.map((i,u)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-[var(--gm-bg-tertiary)] text-[var(--gm-text-tertiary)] capitalize text-[10px] font-medium",children:i.type||"unknown"}),e.jsxs("span",{className:"text-[var(--gm-accent-primary)] font-semibold text-[10px] min-w-[30px]",children:[Math.round((i.rrfScore??i.score??0)*100),"%"]}),i.sourceCount&&i.sourceCount>1&&e.jsxs("span",{className:"text-[9px] px-1 rounded bg-purple-500/20 text-purple-400 font-semibold",children:["x",i.sourceCount]}),i.source&&e.jsx("span",{className:"ml-auto text-[var(--gm-text-tertiary)] text-[9px] truncate max-w-[120px]",children:i.source})]},u)),n.length>5&&e.jsxs("div",{className:"text-[var(--gm-text-tertiary)] text-[10px] text-center pt-1 border-t border-[var(--gm-border-primary)]",children:["+",n.length-5," more"]})]})]})}function ke({sessions:t,currentId:a,onSelect:s,onCreate:n,contacts:c,onContextChange:i}){const[u,f]=o.useState(""),b=t.find(m=>m.id===a);return e.jsxs("div",{className:"w-60 min-w-[200px] border-r border-[var(--gm-border-primary)] bg-[var(--gm-bg-tertiary)] flex flex-col overflow-hidden shrink-0",children:[e.jsxs("button",{onClick:()=>n(u||null),className:l(M,"m-2 px-3 py-2 text-sm"),children:[e.jsx(be,{className:"w-4 h-4"})," New Conversation"]}),c.length>0&&e.jsxs("div",{className:"px-3 pb-2 space-y-1",children:[e.jsx("span",{className:"text-[10px] text-[var(--gm-text-tertiary)]",children:"As who?"}),e.jsx(q,{contacts:c,value:u||null,onChange:m=>f(m??""),placeholder:"No context",compact:!0})]}),b&&c.length>0&&e.jsxs("div",{className:"px-3 pb-2 pt-1 border-t border-[var(--gm-border-primary)] space-y-1",children:[e.jsx("span",{className:"text-[10px] text-[var(--gm-text-tertiary)]",children:"Session context"}),e.jsx(q,{contacts:c,value:b.context_contact_id??null,onChange:i,placeholder:"No context",compact:!0})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-0.5",children:[t.map(m=>e.jsxs("button",{onClick:()=>s(m.id),className:l("w-full text-left flex flex-col gap-0.5 px-3 py-2 rounded-lg text-xs transition-colors",m.id===a?"bg-[var(--gm-interactive-primary)]/15 text-[var(--gm-accent-primary)] font-medium":"text-[var(--gm-text-tertiary)] hover:bg-[var(--gm-surface-hover)] hover:text-[var(--gm-text-primary)]"),children:[e.jsx("span",{className:"truncate",children:(m.title||"Untitled").length>40?(m.title||"Untitled").substring(0,37)+"...":m.title||"Untitled"}),e.jsx("span",{className:"text-[10px] opacity-60",children:je(m.updated_at)})]},m.id)),t.length===0&&e.jsx("p",{className:"text-xs text-[var(--gm-text-tertiary)] text-center py-4",children:"No conversations yet"})]})]})}function Te(){const[t,a]=o.useState("rag"),[s,n]=o.useState(null),[c,i]=o.useState([]),[u,f]=o.useState(""),[b,m]=o.useState(!1),N=o.useRef(null),v=o.useRef(null),j=re(),w=se(),p=ae(b),{data:d,refetch:g}=ne(),T=oe(),E=ie(),{data:C}=le(),{data:D}=ce(s),$=d?.sessions??[],z=o.useMemo(()=>{if(!C)return[];const r=C?.contacts??C;return Array.isArray(r)?r:[]},[C]),k=j.isPending||w.isPending;o.useEffect(()=>{if(!D)return;const r=D?.messages??[];i(r.map(x=>({id:x.id,role:x.role,content:x.content,timestamp:x.created_at,sources:x.sources,confidence:x.metadata?.confidence,queryType:x.metadata?.queryType,rag:x.metadata?.rag,contextQuality:x.metadata?.contextQuality})))},[D]),o.useEffect(()=>{N.current?.scrollIntoView({behavior:"smooth"})},[c]);const F=o.useCallback(r=>{f(r.target.value);const x=r.target;x.style.height="auto",x.style.height=Math.min(x.scrollHeight,120)+"px"},[]),U=o.useCallback(r=>{n(r)},[]),G=o.useCallback(r=>{T.mutate({title:"New conversation",contextContactId:r??null},{onSuccess:x=>{const R=x?.session;R&&(n(R.id),i([]),g())}})},[T,g]),H=o.useCallback(r=>{s&&E.mutate({sessionId:s,contextContactId:r},{onSuccess:()=>{P.success("Context updated"),g()},onError:()=>P.error("Failed to update context")})},[s,E,g]),S=o.useCallback(r=>{const x=(r??u).trim();if(!x||k)return;const R={id:`msg-${Date.now()}-user`,role:"user",content:x,timestamp:new Date().toISOString()};i(y=>[...y,R]),f(""),v.current&&(v.current.style.height="auto");const V=c.slice(-10).map(y=>({role:y.role,content:y.content})),W=t==="sot"?w:j,L={message:x,history:V};t==="rag"&&s&&(L.sessionId=s),W.mutate(L,{onSuccess:y=>{const h=y,Y={id:`msg-${Date.now()}-assistant`,role:"assistant",content:h.response,timestamp:new Date().toISOString(),sources:h.sources,contextQuality:h.contextQuality,confidence:h.confidence,queryType:h.queryType,rag:h.rag};i(X=>[...X,Y]),h.sessionId&&!s&&(n(h.sessionId),g())},onError:y=>{i(h=>[...h,{id:`msg-${Date.now()}-error`,role:"system",content:`Error: ${y.message}`,timestamp:new Date().toISOString()}])}})},[u,c,k,t,j,w,s,g]),K=o.useCallback(()=>{i([]),n(null)},[]),A=[{key:"rag",label:"RAG Chat",icon:de,desc:"Query all project knowledge"},{key:"sot",label:"SOT Chat",icon:xe,desc:"Source of Truth focused"},{key:"briefing",label:"Briefing",icon:me,desc:"Daily project briefing"}];return t==="briefing"?e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-[var(--gm-text-primary)]",children:"Daily Briefing"}),e.jsxs("button",{onClick:()=>{m(!0),p.refetch().then(()=>m(!1))},disabled:p.isFetching,className:l(M,"flex items-center gap-1.5"),children:[p.isFetching?e.jsx(I,{className:"w-3.5 h-3.5 animate-spin"}):e.jsx(he,{className:"w-3.5 h-3.5"}),"Refresh"]})]}),e.jsx(_,{modes:A,current:t,onChange:a}),p.isLoading?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(I,{className:"h-8 w-8 animate-spin text-[var(--gm-accent-primary)]"})}):p.error?e.jsx("div",{className:l(B,"p-6 text-center text-[var(--gm-text-tertiary)]"),children:"Failed to load briefing."}):e.jsxs("div",{className:l(B,"p-6"),children:[p.data?.generated_at&&e.jsxs("p",{className:"text-[10px] text-[var(--gm-text-tertiary)] mb-4",children:["Generated: ",new Date(p.data.generated_at).toLocaleString()]}),e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none text-[var(--gm-text-primary)] whitespace-pre-wrap",children:p.data?.briefing||p.data?.content||"No briefing available."}),p.data?.analysis&&e.jsxs("div",{className:"mt-6 pt-4 border-t border-[var(--gm-border-primary)]",children:[e.jsx("h3",{className:"text-sm font-semibold text-[var(--gm-text-primary)] mb-2",children:"Analysis"}),e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none text-[var(--gm-text-tertiary)] whitespace-pre-wrap",children:p.data.analysis})]})]})]}):e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[t==="rag"&&e.jsx(ke,{sessions:$,currentId:s,onSelect:U,onCreate:G,contacts:z,onContextChange:H}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-3 border-b border-[var(--gm-border-primary)] shrink-0",children:[e.jsx("h1",{className:"text-lg font-bold text-[var(--gm-text-primary)]",children:"Chat"}),e.jsx("div",{className:"flex gap-2",children:c.length>0&&e.jsxs("button",{onClick:K,className:l(ve,"flex items-center gap-1.5"),children:[e.jsx(ue,{className:"w-3.5 h-3.5"})," Clear"]})})]}),e.jsx("div",{className:"px-6 pt-3",children:e.jsx(_,{modes:A,current:t,onChange:a})}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4",children:[c.length===0&&e.jsxs("div",{className:"text-center text-[var(--gm-text-tertiary)] py-12 space-y-4",children:[e.jsx("p",{children:t==="sot"?"Ask about facts, decisions, risks, and actions.":"Ask a question about your project knowledge base."}),e.jsx("div",{className:"flex flex-wrap justify-center gap-2",children:O.map(r=>e.jsx("button",{onClick:()=>S(r),className:"px-3 py-1.5 text-xs rounded-full border border-[var(--gm-border-primary)] bg-[var(--gm-surface-primary)] text-[var(--gm-text-tertiary)] hover:border-[var(--gm-accent-primary)] hover:text-[var(--gm-accent-primary)] transition-colors",children:r},r))})]}),c.map(r=>e.jsxs("div",{children:[e.jsxs("div",{className:l("max-w-[80%] rounded-xl p-3 text-sm",r.role==="user"?"ml-auto bg-[var(--gm-interactive-primary)] text-[var(--gm-text-on-brand)]":r.role==="system"?"mx-auto bg-[var(--color-danger-500)]/10 text-[var(--color-danger-500)]":"bg-[var(--gm-bg-tertiary)]"),children:[e.jsx("div",{className:"whitespace-pre-wrap",children:r.content}),e.jsxs("div",{className:"flex items-center justify-between mt-1.5",children:[e.jsx("span",{className:"text-[10px] opacity-50",children:r.timestamp?new Date(r.timestamp).toLocaleTimeString():"—"}),r.contextQuality&&r.role==="assistant"&&e.jsxs("span",{className:l("text-[9px] px-2 py-0.5 rounded-full font-medium ml-2",r.contextQuality==="high"?"bg-emerald-500/10 text-emerald-400":r.contextQuality==="medium"?"bg-amber-500/10 text-amber-400":"bg-[var(--gm-bg-tertiary)] text-[var(--gm-text-tertiary)]"),children:[r.contextQuality," confidence"]})]}),e.jsx(Ne,{msg:r})]}),r.sources&&r.sources.length>0&&e.jsxs("div",{className:"max-w-[80%]",children:[e.jsx(we,{sources:r.sources}),e.jsx(Ce,{sources:r.sources})]})]},r.id)),k&&e.jsxs("div",{className:"max-w-[80%] rounded-xl p-3 text-sm bg-[var(--gm-bg-tertiary)] flex items-center gap-2",children:[e.jsx(I,{className:"h-3.5 w-3.5 animate-spin text-[var(--gm-text-tertiary)]"}),e.jsx("span",{className:"text-[var(--gm-text-tertiary)]",children:"Thinking..."})]}),e.jsx("div",{ref:N})]}),c.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5 px-6 pb-2",children:O.map(r=>e.jsx("button",{onClick:()=>S(r),className:"px-2.5 py-1 text-[10px] rounded-full border border-[var(--gm-border-primary)] bg-[var(--gm-surface-primary)] text-[var(--gm-text-tertiary)] hover:border-[var(--gm-accent-primary)] hover:text-[var(--gm-accent-primary)] transition-colors",children:r},r))}),e.jsxs("div",{className:"flex gap-2 px-6 py-3 border-t border-[var(--gm-border-primary)] bg-[var(--gm-bg-tertiary)] shrink-0",children:[e.jsx("textarea",{ref:v,value:u,onChange:F,onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),S())},placeholder:t==="sot"?"Ask about facts, decisions, risks...":"Ask a question...",rows:1,className:l(ye,"flex-1 min-h-[44px] max-h-[120px] resize-none py-2.5")}),e.jsx("button",{onClick:()=>S(),disabled:!u.trim()||k,className:l(M,"h-11 px-4 text-sm self-end"),children:e.jsx(fe,{className:"h-4 w-4"})})]})]})]})}function _({modes:t,current:a,onChange:s}){return e.jsx("div",{className:"flex gap-1 bg-[var(--gm-bg-tertiary)] rounded-xl p-1 max-w-md mb-3",children:t.map(n=>{const c=n.icon;return e.jsxs("button",{onClick:()=>s(n.key),className:l("flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors",a===n.key?"bg-[var(--gm-surface-primary)] text-[var(--gm-text-primary)] shadow-sm":"text-[var(--gm-text-tertiary)] hover:text-[var(--gm-text-primary)]"),children:[e.jsx(c,{className:"w-3.5 h-3.5"})," ",n.label]},n.key)})})}export{Te as default};
//# sourceMappingURL=ChatPage-D9wZ_FVE.js.map
