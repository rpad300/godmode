import{c as s,o as y,b as g,h as w,f as G,t as I}from"./main-v_cFye9p.js";import"./modulepreload-polyfill-B5Qt9EMX.js";function X(e={}){const v=e.showSessions!==!1,x=s("div",{className:"chat-layout"});let c=null,l=[],p=[];const r=s("div",{className:"chat-sidebar"}),u=s("button",{className:"chat-new-conversation",innerHTML:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova conversa'}),C=s("div",{className:"chat-new-context-wrap"}),$=s("span",{className:"chat-new-context-label",textContent:"Como quem?"}),o=s("select",{className:"chat-new-context-select"});C.appendChild($),C.appendChild(o);const d=s("div",{className:"chat-sessions-list"});r.appendChild(u),r.appendChild(C),r.appendChild(d);const R=s("div",{className:"chat-main"}),S=s("div",{className:"chat-container"}),H=s("div",{className:"chat-header"}),B=s("label",{className:"chat-context-label",textContent:"Como quem?"}),N=s("select",{className:"chat-context-select"});H.appendChild(B),H.appendChild(N);async function F(){try{p=(await w.get("/api/contacts")).data?.contacts||[],k()}catch{p=[]}}function k(){const n=l.find(a=>a.id===c)?.context_contact_id||null;N.innerHTML=`<option value="">Sem contexto</option>${p.map(a=>`<option value="${a.id}" ${a.id===n?"selected":""}>${m(a.name)}${a.role?` - ${a.role}`:""}${a.organization?` (${a.organization})`:""}</option>`).join("")}`,N.disabled=!c}function O(){o.innerHTML=`<option value="">Sem contexto</option>${p.map(t=>`<option value="${t.id}">${m(t.name)}${t.role?` - ${t.role}`:""}${t.organization?` (${t.organization})`:""}</option>`).join("")}`}async function Q(){if(!c)return;const t=N.value||null;try{await w.put(`/api/chat/sessions/${c}`,{contextContactId:t});const n=l.findIndex(a=>a.id===c);n!==-1&&(l[n]={...l[n],context_contact_id:t}),I.success("Contexto actualizado")}catch(n){I.error("Falha ao actualizar contexto"),console.error("[Chat] Update context error:",n),k()}}const f=s("div",{className:"chat-messages"}),q=s("div",{className:"chat-input-container"}),h=s("textarea",{className:"chat-input",placeholder:e.placeholder||"Ask a question about your project..."}),M=s("button",{className:"chat-send-btn",innerHTML:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
    </svg>`});y(h,"input",()=>{h.style.height="auto",h.style.height=Math.min(h.scrollHeight,120)+"px"}),y(h,"keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),_())}),y(M,"click",_);let E=!1;async function D(){try{l=(await w.get("/api/chat/sessions")).data?.sessions||[],L()}catch{l=[]}}function L(){d.innerHTML=l.map(t=>`
      <button class="chat-session-item ${t.id===c?"active":""}" data-session-id="${t.id}">
        <span class="session-title">${m(t.title.length>40?t.title.substring(0,37)+"...":t.title)}</span>
        <span class="session-date">${G(t.updated_at)}</span>
      </button>
    `).join(""),d.querySelectorAll(".chat-session-item").forEach(t=>{y(t,"click",()=>z(t.getAttribute("data-session-id")))})}async function U(t){try{const a=(await w.get(`/api/chat/sessions/${t}/messages`)).data?.messages||[];g.setChatHistory(a.map(i=>({id:i.id,role:i.role,content:i.content,timestamp:i.created_at,sources:i.sources,queryType:i.metadata?.queryType,confidence:i.metadata?.confidence})))}catch{g.setChatHistory([])}}async function z(t){c=t,L(),g.clearChatHistory(),await U(t),f.innerHTML="",g.getState().chatHistory.forEach(n=>b(n,f,e.showSources))}async function W(t){try{const a=(await w.post("/api/chat/sessions",{title:"Nova conversa",contextContactId:t||null})).data?.session;a&&(l.unshift({id:a.id,title:a.title||"Nova conversa",context_contact_id:a.context_contact_id??null,created_at:a.created_at||new Date().toISOString(),updated_at:a.updated_at||new Date().toISOString()}),await z(a.id),L())}catch(n){I.error("Failed to create new conversation"),console.error("[Chat] Create session error:",n)}}async function _(){const t=h.value.trim();if(!t||E)return;h.value="",h.style.height="auto",E=!0,M.setAttribute("disabled","true");const n={id:`msg-${Date.now()}`,role:"user",content:t,timestamp:new Date().toISOString()};g.addChatMessage(n),b(n,f);const a=s("div",{className:"chat-loading"});a.innerHTML=`
      <div class="chat-loading-dots">
        <span></span><span></span><span></span>
      </div>
      <span>Thinking...</span>
    `,f.appendChild(a),A(f);try{if(e.onSend)await e.onSend(t);else{const i=await w.post("/api/chat",{message:t,history:g.getState().chatHistory.slice(-10),sessionId:c}),T={id:`msg-${Date.now()}`,role:"assistant",content:i.data.response,timestamp:new Date().toISOString(),sources:i.data.sources,queryType:i.data.queryType,confidence:i.data.confidence,contextQuality:i.data.contextQuality,rag:i.data.rag};g.addChatMessage(T),b(T,f,e.showSources),i.data.sessionId&&!c&&(c=i.data.sessionId,await D(),L(),k())}}catch{const T={role:"system",content:"Failed to get response. Please try again.",timestamp:new Date().toISOString()};b(T,f)}finally{a.remove(),E=!1,M.removeAttribute("disabled"),h.focus()}}q.appendChild(h),q.appendChild(M);const j=s("div",{className:"quick-prompts"});return["Summarize key risks","List open questions","What actions are overdue?","Who are the key contacts?"].forEach(t=>{const n=s("button",{className:"quick-prompt",textContent:t});y(n,"click",()=>{h.value=t,_()}),j.appendChild(n)}),y(N,"change",Q),S.appendChild(H),S.appendChild(f),S.appendChild(j),S.appendChild(q),R.appendChild(S),v?(x.appendChild(r),y(u,"click",()=>W()),F().then(()=>O()),D()):H.classList.add("hidden"),x.appendChild(R),g.getState().chatHistory.forEach(t=>b(t,f,e.showSources)),x}function b(e,v,x=!0){const c=s("div",{className:`chat-message ${e.role}`});let l=m(e.content);if(l=l.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>"),c.innerHTML=`<div class="chat-message-content">${l}</div>`,e.role==="assistant"&&(e.confidence||e.rag)){const p=s("div",{className:"chat-meta"}),r=e.confidence==="high"?"confidence-high":e.confidence==="medium"?"confidence-medium":"confidence-low";let u="";if(e.confidence&&(u+=`<span class="chat-badge ${r}" title="Confidence level">${e.confidence}</span>`),e.queryType&&(u+=`<span class="chat-badge query-type" title="Query classification">${e.queryType}</span>`),e.rag){const C=e.rag.usedHyDE?"HyDE+RRF":e.rag.graphResults>0?"Graph+Vector":"Hybrid";u+=`<span class="chat-badge rag-method" title="RAG method: ${e.rag.method}">${C}</span>`;const $=e.rag.fusedResults||e.rag.vectorResults+e.rag.graphResults;$>0&&(u+=`<span class="chat-badge sources-count" title="Sources found">${$} sources</span>`)}p.innerHTML=u,c.appendChild(p)}if(x&&e.sources&&e.sources.length>0){const p=s("div",{className:"chat-sources"});if(typeof e.sources[0]=="string")p.innerHTML=`
        <span class="sources-label">Sources:</span>
        ${e.sources.map(r=>`<span class="source-link">${m(r)}</span>`).join("")}
      `;else{const r=e.sources,u=r.filter(o=>o.contactName),$=r.filter(o=>!o.contactName).slice(0,5);if(u.length>0){const o=s("div",{className:"chat-contact-pills"});o.innerHTML=u.map(d=>`
          <div class="contact-pill">
            ${d.avatarUrl?`<img class="contact-pill-avatar" src="${m(d.avatarUrl)}" alt="" onerror="this.classList.add('hidden')"/>`:`<div class="contact-pill-avatar-placeholder">${m((d.contactName||d.type||"?")[0])}</div>`}
            <div class="contact-pill-info">
              <span class="contact-pill-name">${m(d.contactName||d.type||"Contact")}</span>
              ${d.contactRole?`<span class="contact-pill-role">${m(d.contactRole)}</span>`:""}
            </div>
          </div>
        `).join(""),c.appendChild(o)}p.innerHTML=`
        <details class="sources-details">
          <summary class="sources-label">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            ${r.length} sources used
          </summary>
          <div class="sources-list">
            ${$.map(o=>`
              <div class="source-item">
                <span class="source-type">${m(o.type||"unknown")}</span>
                <span class="source-score" title="Relevance score">${Math.round((o.rrfScore||o.score||0)*100)}%</span>
                ${o.sourceCount&&o.sourceCount>1?`<span class="source-multi" title="Found in multiple searches">x${o.sourceCount}</span>`:""}
                ${o.source?`<span class="source-from">${m(o.source)}</span>`:""}
              </div>
            `).join("")}
            ${r.length>5?`<div class="sources-more">+${r.length-5} more</div>`:""}
          </div>
        </details>
      `}c.appendChild(p)}return v.appendChild(c),A(v),c}function A(e){e.scrollTop=e.scrollHeight}function m(e){const v=document.createElement("div");return v.textContent=e,v.innerHTML}export{X as createChat};
//# sourceMappingURL=ChatPage-CNk0fPqu.js.map
