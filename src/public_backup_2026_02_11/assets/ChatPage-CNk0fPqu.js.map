{"version":3,"file":"ChatPage-CNk0fPqu.js","sources":["../../frontend/src/pages/ChatPage.ts"],"sourcesContent":["/**\r\n * Chat Component\r\n * AI chat interface with multiple sessions, persistence, and contact pills\r\n */\r\n\r\nimport { createElement, on, scrollIntoView } from '@lib/dom';\r\nimport { dataStore, ChatMessage, ChatSource, ChatRAGInfo } from '@stores/data';\r\nimport { http } from '@services/api';\r\nimport { toast } from '@services/toast';\r\nimport { formatRelativeTime } from '@lib/format';\r\n\r\ninterface ChatSession {\r\n  id: string;\r\n  title: string;\r\n  context_contact_id?: string | null;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\ninterface ContactOption {\r\n  id: string;\r\n  name: string;\r\n  role?: string;\r\n  organization?: string;\r\n}\r\n\r\ninterface ChatAPIResponse {\r\n  success: boolean;\r\n  response: string;\r\n  sessionId?: string;\r\n  model?: string;\r\n  provider?: string;\r\n  confidence?: 'high' | 'medium' | 'low';\r\n  contextQuality?: string;\r\n  queryType?: string;\r\n  sources?: ChatSource[];\r\n  rag?: ChatRAGInfo;\r\n}\r\n\r\nexport interface ChatProps {\r\n  onSend?: (message: string) => Promise<void>;\r\n  placeholder?: string;\r\n  showSources?: boolean;\r\n  showSessions?: boolean; // Show sidebar with multiple conversations\r\n}\r\n\r\n/**\r\n * Create chat component\r\n */\r\nexport function createChat(props: ChatProps = {}): HTMLElement {\r\n  const showSessions = props.showSessions !== false;\r\n\r\n  const chat = createElement('div', { className: 'chat-layout' });\r\n\r\n  // State for multiple sessions\r\n  let currentSessionId: string | null = null;\r\n  let sessions: ChatSession[] = [];\r\n  let contacts: ContactOption[] = [];\r\n\r\n  // Sidebar (sessions list)\r\n  const sidebar = createElement('div', { className: 'chat-sidebar' });\r\n  const newChatBtn = createElement('button', {\r\n    className: 'chat-new-conversation',\r\n    innerHTML: `<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg> Nova conversa`\r\n  });\r\n  const newChatContextWrap = createElement('div', { className: 'chat-new-context-wrap' });\r\n  const newChatContextLabel = createElement('span', { className: 'chat-new-context-label', textContent: 'Como quem?' });\r\n  const newChatContextSelect = createElement('select', { className: 'chat-new-context-select' }) as HTMLSelectElement;\r\n  newChatContextWrap.appendChild(newChatContextLabel);\r\n  newChatContextWrap.appendChild(newChatContextSelect);\r\n  const sessionsList = createElement('div', { className: 'chat-sessions-list' });\r\n  sidebar.appendChild(newChatBtn);\r\n  sidebar.appendChild(newChatContextWrap);\r\n  sidebar.appendChild(sessionsList);\r\n\r\n  // Main area\r\n  const mainArea = createElement('div', { className: 'chat-main' });\r\n  const chatContainer = createElement('div', { className: 'chat-container' });\r\n\r\n  // Chat header: \"Como quem?\" context selector\r\n  const chatHeader = createElement('div', { className: 'chat-header' });\r\n  const contextLabel = createElement('label', { className: 'chat-context-label', textContent: 'Como quem?' });\r\n  const contextSelect = createElement('select', { className: 'chat-context-select' }) as HTMLSelectElement;\r\n  chatHeader.appendChild(contextLabel);\r\n  chatHeader.appendChild(contextSelect);\r\n\r\n  async function loadContacts(): Promise<void> {\r\n    try {\r\n      const res = await http.get<{ contacts?: Array<{ id: string; name: string; role?: string; organization?: string }> }>('/api/contacts');\r\n      contacts = res.data?.contacts || [];\r\n      renderContextSelect();\r\n    } catch {\r\n      contacts = [];\r\n    }\r\n  }\r\n\r\n  function renderContextSelect(): void {\r\n    const currentSession = sessions.find(s => s.id === currentSessionId);\r\n    const currentContextId = currentSession?.context_contact_id || null;\r\n    contextSelect.innerHTML = `<option value=\"\">Sem contexto</option>${contacts.map(c => `<option value=\"${c.id}\" ${c.id === currentContextId ? 'selected' : ''}>${escapeHtml(c.name)}${c.role ? ` - ${c.role}` : ''}${c.organization ? ` (${c.organization})` : ''}</option>`).join('')}`;\r\n    contextSelect.disabled = !currentSessionId;\r\n  }\r\n\r\n  function renderNewChatContextSelect(): void {\r\n    newChatContextSelect.innerHTML = `<option value=\"\">Sem contexto</option>${contacts.map(c => `<option value=\"${c.id}\">${escapeHtml(c.name)}${c.role ? ` - ${c.role}` : ''}${c.organization ? ` (${c.organization})` : ''}</option>`).join('')}`;\r\n  }\r\n\r\n  async function onContextChange(): Promise<void> {\r\n    if (!currentSessionId) return;\r\n    const contactId = contextSelect.value || null;\r\n    try {\r\n      await http.put(`/api/chat/sessions/${currentSessionId}`, { contextContactId: contactId });\r\n      const idx = sessions.findIndex(s => s.id === currentSessionId);\r\n      if (idx !== -1) sessions[idx] = { ...sessions[idx], context_contact_id: contactId };\r\n      toast.success('Contexto actualizado');\r\n    } catch (e) {\r\n      toast.error('Falha ao actualizar contexto');\r\n      console.error('[Chat] Update context error:', e);\r\n      renderContextSelect();\r\n    }\r\n  }\r\n\r\n  // Messages container\r\n  const messagesContainer = createElement('div', { className: 'chat-messages' });\r\n\r\n  // Input container\r\n  const inputContainer = createElement('div', { className: 'chat-input-container' });\r\n\r\n  const input = createElement('textarea', {\r\n    className: 'chat-input',\r\n    placeholder: props.placeholder || 'Ask a question about your project...',\r\n  }) as HTMLTextAreaElement;\r\n\r\n  const sendBtn = createElement('button', {\r\n    className: 'chat-send-btn',\r\n    innerHTML: `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n      <path d=\"M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z\"/>\r\n    </svg>`,\r\n  });\r\n\r\n  // Auto-resize textarea\r\n  on(input, 'input', () => {\r\n    input.style.height = 'auto';\r\n    input.style.height = Math.min(input.scrollHeight, 120) + 'px';\r\n  });\r\n\r\n  // Send on Enter (Shift+Enter for new line)\r\n  on(input, 'keydown', (e) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSend();\r\n    }\r\n  });\r\n\r\n  // Send button click\r\n  on(sendBtn, 'click', handleSend);\r\n\r\n  let isLoading = false;\r\n\r\n  async function loadSessions(): Promise<void> {\r\n    try {\r\n      const res = await http.get<{ ok: boolean; sessions?: ChatSession[] }>('/api/chat/sessions');\r\n      sessions = res.data?.sessions || [];\r\n      renderSessionsList();\r\n    } catch {\r\n      sessions = [];\r\n    }\r\n  }\r\n\r\n  function renderSessionsList(): void {\r\n    sessionsList.innerHTML = sessions.map(s => `\r\n      <button class=\"chat-session-item ${s.id === currentSessionId ? 'active' : ''}\" data-session-id=\"${s.id}\">\r\n        <span class=\"session-title\">${escapeHtml(s.title.length > 40 ? s.title.substring(0, 37) + '...' : s.title)}</span>\r\n        <span class=\"session-date\">${formatRelativeTime(s.updated_at)}</span>\r\n      </button>\r\n    `).join('');\r\n    sessionsList.querySelectorAll('.chat-session-item').forEach(btn => {\r\n      on(btn as HTMLElement, 'click', () => selectSession((btn as HTMLElement).getAttribute('data-session-id')!));\r\n    });\r\n  }\r\n\r\n  async function loadMessages(sessionId: string): Promise<void> {\r\n    try {\r\n      const res = await http.get<{ ok: boolean; messages?: Array<{ id: string; role: string; content: string; sources?: ChatSource[]; metadata?: Record<string, unknown>; created_at: string }> }>(`/api/chat/sessions/${sessionId}/messages`);\r\n      const msgs = res.data?.messages || [];\r\n      dataStore.setChatHistory(msgs.map(m => ({\r\n        id: m.id,\r\n        role: m.role as 'user' | 'assistant' | 'system',\r\n        content: m.content,\r\n        timestamp: m.created_at,\r\n        sources: m.sources,\r\n        queryType: m.metadata?.queryType as string | undefined,\r\n        confidence: m.metadata?.confidence as 'high' | 'medium' | 'low' | undefined\r\n      })));\r\n    } catch {\r\n      dataStore.setChatHistory([]);\r\n    }\r\n  }\r\n\r\n  async function selectSession(sessionId: string): Promise<void> {\r\n    currentSessionId = sessionId;\r\n    renderSessionsList();\r\n    dataStore.clearChatHistory();\r\n    await loadMessages(sessionId);\r\n    messagesContainer.innerHTML = '';\r\n    dataStore.getState().chatHistory.forEach(msg => renderMessage(msg, messagesContainer, props.showSources));\r\n  }\r\n\r\n  async function createNewSession(contextContactId?: string | null): Promise<void> {\r\n    try {\r\n      const res = await http.post<{ ok: boolean; session?: { id: string; title?: string; context_contact_id?: string | null; created_at?: string; updated_at?: string } }>('/api/chat/sessions', { title: 'Nova conversa', contextContactId: contextContactId || null });\r\n      const session = res.data?.session;\r\n      if (session) {\r\n        sessions.unshift({\r\n          id: session.id,\r\n          title: session.title || 'Nova conversa',\r\n          context_contact_id: session.context_contact_id ?? null,\r\n          created_at: session.created_at || new Date().toISOString(),\r\n          updated_at: session.updated_at || new Date().toISOString()\r\n        });\r\n        await selectSession(session.id);\r\n        renderSessionsList();\r\n      }\r\n    } catch (e) {\r\n      toast.error('Failed to create new conversation');\r\n      console.error('[Chat] Create session error:', e);\r\n    }\r\n  }\r\n\r\n  async function handleSend(): Promise<void> {\r\n    const message = input.value.trim();\r\n    if (!message || isLoading) return;\r\n\r\n    input.value = '';\r\n    input.style.height = 'auto';\r\n    isLoading = true;\r\n    sendBtn.setAttribute('disabled', 'true');\r\n\r\n    // Add user message\r\n    const userMessage: ChatMessage = {\r\n      id: `msg-${Date.now()}`,\r\n      role: 'user',\r\n      content: message,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n    dataStore.addChatMessage(userMessage);\r\n    renderMessage(userMessage, messagesContainer);\r\n\r\n    // Show loading\r\n    const loadingEl = createElement('div', { className: 'chat-loading' });\r\n    loadingEl.innerHTML = `\r\n      <div class=\"chat-loading-dots\">\r\n        <span></span><span></span><span></span>\r\n      </div>\r\n      <span>Thinking...</span>\r\n    `;\r\n    messagesContainer.appendChild(loadingEl);\r\n    scrollToBottom(messagesContainer);\r\n\r\n    try {\r\n      if (props.onSend) {\r\n        await props.onSend(message);\r\n      } else {\r\n        const response = await http.post<ChatAPIResponse>('/api/chat', {\r\n          message,\r\n          history: dataStore.getState().chatHistory.slice(-10),\r\n          sessionId: currentSessionId,\r\n        });\r\n\r\n        const assistantMessage: ChatMessage = {\r\n          id: `msg-${Date.now()}`,\r\n          role: 'assistant',\r\n          content: response.data.response,\r\n          timestamp: new Date().toISOString(),\r\n          sources: response.data.sources,\r\n          queryType: response.data.queryType,\r\n          confidence: response.data.confidence,\r\n          contextQuality: response.data.contextQuality,\r\n          rag: response.data.rag,\r\n        };\r\n        dataStore.addChatMessage(assistantMessage);\r\n        renderMessage(assistantMessage, messagesContainer, props.showSources);\r\n\r\n        // Update current session if backend created one\r\n        if (response.data.sessionId && !currentSessionId) {\r\n          currentSessionId = response.data.sessionId;\r\n          await loadSessions();\r\n          renderSessionsList();\r\n          renderContextSelect();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      const errorMessage: ChatMessage = {\r\n        id: `msg-${Date.now()}`,\r\n        role: 'system',\r\n        content: 'Failed to get response. Please try again.',\r\n        timestamp: new Date().toISOString(),\r\n      };\r\n      renderMessage(errorMessage, messagesContainer);\r\n    } finally {\r\n      loadingEl.remove();\r\n      isLoading = false;\r\n      sendBtn.removeAttribute('disabled');\r\n      input.focus();\r\n    }\r\n  }\r\n\r\n  inputContainer.appendChild(input);\r\n  inputContainer.appendChild(sendBtn);\r\n\r\n  // Quick prompts\r\n  const quickPrompts = createElement('div', { className: 'quick-prompts' });\r\n  const prompts = [\r\n    'Summarize key risks',\r\n    'List open questions',\r\n    'What actions are overdue?',\r\n    'Who are the key contacts?',\r\n  ];\r\n\r\n  prompts.forEach(prompt => {\r\n    const btn = createElement('button', {\r\n      className: 'quick-prompt',\r\n      textContent: prompt,\r\n    });\r\n    on(btn, 'click', () => {\r\n      input.value = prompt;\r\n      handleSend();\r\n    });\r\n    quickPrompts.appendChild(btn);\r\n  });\r\n\r\n  // Layout assembly\r\n  on(contextSelect, 'change', onContextChange);\r\n  chatContainer.appendChild(chatHeader);\r\n  chatContainer.appendChild(messagesContainer);\r\n  chatContainer.appendChild(quickPrompts);\r\n  chatContainer.appendChild(inputContainer);\r\n  mainArea.appendChild(chatContainer);\r\n\r\n  if (showSessions) {\r\n    chat.appendChild(sidebar);\r\n    on(newChatBtn as HTMLElement, 'click', () => createNewSession());\r\n    loadContacts().then(() => renderNewChatContextSelect());\r\n    loadSessions();\r\n  } else {\r\n    chatHeader.classList.add('hidden');\r\n  }\r\n  chat.appendChild(mainArea);\r\n\r\n  // Render existing messages (from dataStore - may be empty initially)\r\n  const existingMessages = dataStore.getState().chatHistory;\r\n  existingMessages.forEach(msg => renderMessage(msg, messagesContainer, props.showSources));\r\n\r\n  return chat;\r\n}\r\n\r\n/**\r\n * Render a chat message with SOTA RAG info\r\n */\r\nfunction renderMessage(\r\n  message: ChatMessage,\r\n  container: HTMLElement,\r\n  showSources = true\r\n): HTMLElement {\r\n  const msgEl = createElement('div', {\r\n    className: `chat-message ${message.role}`,\r\n  });\r\n\r\n  let content = escapeHtml(message.content);\r\n\r\n  // Parse markdown-like formatting\r\n  content = content\r\n    .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\r\n    .replace(/\\*(.*?)\\*/g, '<em>$1</em>')\r\n    .replace(/`(.*?)`/g, '<code>$1</code>')\r\n    .replace(/\\n/g, '<br>');\r\n\r\n  msgEl.innerHTML = `<div class=\"chat-message-content\">${content}</div>`;\r\n\r\n  // Add RAG metadata badge for assistant messages\r\n  if (message.role === 'assistant' && (message.confidence || message.rag)) {\r\n    const metaEl = createElement('div', { className: 'chat-meta' });\r\n    const confidenceClass = message.confidence === 'high' ? 'confidence-high' :\r\n      message.confidence === 'medium' ? 'confidence-medium' : 'confidence-low';\r\n\r\n    let metaHtml = '';\r\n\r\n    // Confidence badge\r\n    if (message.confidence) {\r\n      metaHtml += `<span class=\"chat-badge ${confidenceClass}\" title=\"Confidence level\">${message.confidence}</span>`;\r\n    }\r\n\r\n    // Query type badge\r\n    if (message.queryType) {\r\n      metaHtml += `<span class=\"chat-badge query-type\" title=\"Query classification\">${message.queryType}</span>`;\r\n    }\r\n\r\n    // RAG method badge\r\n    if (message.rag) {\r\n      const methodLabel = message.rag.usedHyDE ? 'HyDE+RRF' :\r\n        message.rag.graphResults > 0 ? 'Graph+Vector' : 'Hybrid';\r\n      metaHtml += `<span class=\"chat-badge rag-method\" title=\"RAG method: ${message.rag.method}\">${methodLabel}</span>`;\r\n\r\n      // Sources count\r\n      const totalSources = message.rag.fusedResults || (message.rag.vectorResults + message.rag.graphResults);\r\n      if (totalSources > 0) {\r\n        metaHtml += `<span class=\"chat-badge sources-count\" title=\"Sources found\">${totalSources} sources</span>`;\r\n      }\r\n    }\r\n\r\n    metaEl.innerHTML = metaHtml;\r\n    msgEl.appendChild(metaEl);\r\n  }\r\n\r\n  // Add detailed sources if present\r\n  if (showSources && message.sources && message.sources.length > 0) {\r\n    const sourcesEl = createElement('div', { className: 'chat-sources' });\r\n\r\n    // Handle both string[] (legacy) and ChatSource[] (SOTA) formats\r\n    if (typeof message.sources[0] === 'string') {\r\n      // Legacy format\r\n      sourcesEl.innerHTML = `\r\n        <span class=\"sources-label\">Sources:</span>\r\n        ${(message.sources as string[]).map(s => `<span class=\"source-link\">${escapeHtml(s)}</span>`).join('')}\r\n      `;\r\n    } else {\r\n      // SOTA format with detailed sources and contact pills\r\n      const sources = message.sources as ChatSource[];\r\n      const contactSources = sources.filter(s => s.contactName);\r\n      const otherSources = sources.filter(s => !s.contactName);\r\n      const topSources = otherSources.slice(0, 5);\r\n\r\n      // Contact pills (avatar + name + role)\r\n      if (contactSources.length > 0) {\r\n        const pillsEl = createElement('div', { className: 'chat-contact-pills' });\r\n        pillsEl.innerHTML = contactSources.map(s => `\r\n          <div class=\"contact-pill\">\r\n            ${s.avatarUrl ? `<img class=\"contact-pill-avatar\" src=\"${escapeHtml(s.avatarUrl)}\" alt=\"\" onerror=\"this.classList.add('hidden')\"/>` : `<div class=\"contact-pill-avatar-placeholder\">${escapeHtml((s.contactName || s.type || '?')[0])}</div>`}\r\n            <div class=\"contact-pill-info\">\r\n              <span class=\"contact-pill-name\">${escapeHtml(s.contactName || s.type || 'Contact')}</span>\r\n              ${s.contactRole ? `<span class=\"contact-pill-role\">${escapeHtml(s.contactRole)}</span>` : ''}\r\n            </div>\r\n          </div>\r\n        `).join('');\r\n        msgEl.appendChild(pillsEl);\r\n      }\r\n\r\n      sourcesEl.innerHTML = `\r\n        <details class=\"sources-details\">\r\n          <summary class=\"sources-label\">\r\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n              <polyline points=\"9 18 15 12 9 6\"></polyline>\r\n            </svg>\r\n            ${sources.length} sources used\r\n          </summary>\r\n          <div class=\"sources-list\">\r\n            ${topSources.map(s => `\r\n              <div class=\"source-item\">\r\n                <span class=\"source-type\">${escapeHtml(s.type || 'unknown')}</span>\r\n                <span class=\"source-score\" title=\"Relevance score\">${Math.round((s.rrfScore || s.score || 0) * 100)}%</span>\r\n                ${s.sourceCount && s.sourceCount > 1 ? `<span class=\"source-multi\" title=\"Found in multiple searches\">x${s.sourceCount}</span>` : ''}\r\n                ${s.source ? `<span class=\"source-from\">${escapeHtml(s.source)}</span>` : ''}\r\n              </div>\r\n            `).join('')}\r\n            ${sources.length > 5 ? `<div class=\"sources-more\">+${sources.length - 5} more</div>` : ''}\r\n          </div>\r\n        </details>\r\n      `;\r\n    }\r\n    msgEl.appendChild(sourcesEl);\r\n  }\r\n\r\n  container.appendChild(msgEl);\r\n  scrollToBottom(container);\r\n\r\n  return msgEl;\r\n}\r\n\r\n/**\r\n * Scroll container to bottom\r\n */\r\nfunction scrollToBottom(container: HTMLElement): void {\r\n  container.scrollTop = container.scrollHeight;\r\n}\r\n\r\n/**\r\n * Escape HTML to prevent XSS\r\n */\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Mount chat to container\r\n */\r\nexport function mountChat(selector: string, props: ChatProps = {}): HTMLElement | null {\r\n  const container = document.querySelector(selector);\r\n  if (!container) {\r\n    console.warn(`Chat: Container not found: ${selector}`);\r\n    return null;\r\n  }\r\n\r\n  const chat = createChat(props);\r\n  container.appendChild(chat);\r\n  return chat;\r\n}\r\n\r\nexport default createChat;\r\n"],"names":["createChat","props","showSessions","chat","createElement","currentSessionId","sessions","contacts","sidebar","newChatBtn","newChatContextWrap","newChatContextLabel","newChatContextSelect","sessionsList","mainArea","chatContainer","chatHeader","contextLabel","contextSelect","loadContacts","http","renderContextSelect","currentContextId","s","c","escapeHtml","renderNewChatContextSelect","onContextChange","contactId","idx","toast","e","messagesContainer","inputContainer","input","sendBtn","on","handleSend","isLoading","loadSessions","renderSessionsList","formatRelativeTime","btn","selectSession","loadMessages","sessionId","msgs","dataStore","m","msg","renderMessage","createNewSession","contextContactId","session","message","userMessage","loadingEl","scrollToBottom","response","assistantMessage","errorMessage","quickPrompts","prompt","container","showSources","msgEl","content","metaEl","confidenceClass","metaHtml","methodLabel","totalSources","sourcesEl","sources","contactSources","topSources","pillsEl","text","div"],"mappings":"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"}