{"version":3,"file":"OrgChartPage-CHL2JSo3.js","sources":["../../frontend/src/pages/OrgChartPage.ts"],"sourcesContent":["/**\r\n * Org Chart Component\r\n * Interactive organization chart using vis-network\r\n */\r\n\r\nimport { createElement, on } from '@lib/dom';\r\nimport { contactsService, Contact } from '@services/contacts';\r\nimport { showContactModal } from '@components/modals/ContactModal';\r\n\r\nexport interface OrgChartProps {\r\n  onNodeClick?: (contact: Contact) => void;\r\n}\r\n\r\ninterface OrgNode {\r\n  id: string;\r\n  label: string;\r\n  title: string;\r\n  level: number;\r\n  color?: string;\r\n}\r\n\r\ninterface OrgEdge {\r\n  from: string;\r\n  to: string;\r\n  arrows: string;\r\n}\r\n\r\n// vis.js types - using any for callback params to avoid conflicts with other vis.js declarations\r\ninterface VisNetworkOrgChart {\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  on: (event: string, callback: (params: any) => void) => void;\r\n  fit: () => void;\r\n  destroy: () => void;\r\n}\r\n\r\n// Helper to get vis module from window\r\nfunction getVisOrgChart(): { Network: new (container: HTMLElement, data: unknown, options: unknown) => VisNetworkOrgChart; DataSet: new (data: unknown[]) => unknown } | undefined {\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  return (window as any).vis;\r\n}\r\n\r\n/**\r\n * Create org chart\r\n */\r\nexport function createOrgChart(props: OrgChartProps = {}): HTMLElement {\r\n  const container = createElement('div', { className: 'org-chart' });\r\n\r\n  container.innerHTML = `\r\n    <div class=\"chart-toolbar\">\r\n      <button class=\"btn btn-sm\" id=\"fit-chart-btn\">Fit</button>\r\n      <button class=\"btn btn-sm\" id=\"refresh-chart-btn\">Refresh</button>\r\n    </div>\r\n    <div class=\"chart-container\" id=\"org-chart-container\">\r\n      <div class=\"loading\">Loading org chart...</div>\r\n    </div>\r\n  `;\r\n\r\n  // Bind toolbar events\r\n  const fitBtn = container.querySelector('#fit-chart-btn');\r\n  if (fitBtn) {\r\n    on(fitBtn as HTMLElement, 'click', () => {\r\n      const network = (container as unknown as { _network?: { fit: () => void } })._network;\r\n      network?.fit();\r\n    });\r\n  }\r\n\r\n  const refreshBtn = container.querySelector('#refresh-chart-btn');\r\n  if (refreshBtn) {\r\n    on(refreshBtn as HTMLElement, 'click', () => loadOrgChart(container, props));\r\n  }\r\n\r\n  // Initial load\r\n  loadOrgChart(container, props);\r\n\r\n  return container;\r\n}\r\n\r\n/**\r\n * Load org chart data\r\n */\r\nasync function loadOrgChart(container: HTMLElement, props: OrgChartProps): Promise<void> {\r\n  const chartContainer = container.querySelector('#org-chart-container') as HTMLElement;\r\n  chartContainer.innerHTML = '<div class=\"loading\">Loading...</div>';\r\n\r\n  try {\r\n    // Get contacts with relationships\r\n    const { contacts } = await contactsService.getAll({});\r\n\r\n    if (contacts.length === 0) {\r\n      chartContainer.innerHTML = `\r\n        <div class=\"empty-state\">\r\n          <p>No contacts to display</p>\r\n        </div>\r\n      `;\r\n      return;\r\n    }\r\n\r\n    // Build org chart data\r\n    const { nodes, edges } = buildOrgData(contacts);\r\n\r\n    // Check if vis-network is available\r\n    if (!getVisOrgChart()) {\r\n      renderFallbackChart(chartContainer, contacts, props);\r\n      return;\r\n    }\r\n\r\n    // Create vis-network\r\n    renderVisNetwork(chartContainer, nodes, edges, contacts, props);\r\n  } catch {\r\n    chartContainer.innerHTML = '<div class=\"error\">Failed to load org chart</div>';\r\n  }\r\n}\r\n\r\n/**\r\n * Build org chart data from contacts\r\n */\r\nfunction buildOrgData(contacts: Contact[]): { nodes: OrgNode[]; edges: OrgEdge[] } {\r\n  const nodes: OrgNode[] = [];\r\n  const edges: OrgEdge[] = [];\r\n  const levels: Map<string, number> = new Map();\r\n\r\n  // First pass: identify hierarchy\r\n  contacts.forEach(contact => {\r\n    const reportsTo = contact.relationships?.find(r => r.type === 'reports_to');\r\n    if (reportsTo) {\r\n      // Has a manager\r\n      const managerLevel = levels.get(reportsTo.contactId) || 0;\r\n      levels.set(String(contact.id), managerLevel + 1);\r\n    } else {\r\n      // Top level\r\n      levels.set(String(contact.id), 0);\r\n    }\r\n  });\r\n\r\n  // Build nodes\r\n  contacts.forEach(contact => {\r\n    nodes.push({\r\n      id: String(contact.id),\r\n      label: contact.name,\r\n      title: `${contact.name}${contact.role ? `\\n${contact.role}` : ''}${contact.organization ? `\\n${contact.organization}` : ''}`,\r\n      level: levels.get(String(contact.id)) || 0,\r\n      color: contact.teams?.[0]?.color,\r\n    });\r\n  });\r\n\r\n  // Build edges (reports_to relationships)\r\n  contacts.forEach(contact => {\r\n    contact.relationships?.forEach(rel => {\r\n      if (rel.type === 'reports_to') {\r\n        edges.push({\r\n          from: rel.contactId,\r\n          to: String(contact.id),\r\n          arrows: 'to',\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  return { nodes, edges };\r\n}\r\n\r\n/**\r\n * Render vis-network\r\n */\r\nfunction renderVisNetwork(\r\n  container: HTMLElement,\r\n  nodes: OrgNode[],\r\n  edges: OrgEdge[],\r\n  contacts: Contact[],\r\n  props: OrgChartProps\r\n): void {\r\n  container.innerHTML = '';\r\n\r\n  const visNodes = nodes.map(n => ({\r\n    id: n.id,\r\n    label: n.label,\r\n    title: n.title,\r\n    level: n.level,\r\n    color: {\r\n      background: n.color || '#6366f1',\r\n      border: n.color || '#4f46e5',\r\n      highlight: { background: '#818cf8', border: '#6366f1' },\r\n    },\r\n    font: { color: '#ffffff' },\r\n    shape: 'box',\r\n    margin: 10,\r\n  }));\r\n\r\n  const options = {\r\n    layout: {\r\n      hierarchical: {\r\n        direction: 'UD',\r\n        sortMethod: 'directed',\r\n        levelSeparation: 100,\r\n        nodeSpacing: 150,\r\n      },\r\n    },\r\n    nodes: {\r\n      borderWidth: 2,\r\n      shadow: true,\r\n    },\r\n    edges: {\r\n      color: { color: '#9ca3af', highlight: '#6366f1' },\r\n      width: 2,\r\n      smooth: { type: 'cubicBezier' },\r\n    },\r\n    physics: false,\r\n    interaction: {\r\n      hover: true,\r\n      tooltipDelay: 200,\r\n    },\r\n  };\r\n\r\n  const vis = getVisOrgChart()!;\r\n  const network = new vis.Network(container, {\r\n    nodes: new vis.DataSet(visNodes),\r\n    edges: new vis.DataSet(edges),\r\n  }, options);\r\n\r\n  // Store reference for fit button\r\n  (container.closest('.org-chart') as unknown as { _network: typeof network })._network = network;\r\n\r\n  // Node click handler\r\n  network.on('click', (params) => {\r\n    if (params.nodes.length > 0) {\r\n      const nodeId = params.nodes[0];\r\n      const contact = contacts.find(c => String(c.id) === nodeId);\r\n      if (contact) {\r\n        if (props.onNodeClick) {\r\n          props.onNodeClick(contact);\r\n        } else {\r\n          showContactModal({ mode: 'view', contact });\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  network.fit();\r\n}\r\n\r\n/**\r\n * Render fallback chart (when vis-network not available)\r\n */\r\nfunction renderFallbackChart(container: HTMLElement, contacts: Contact[], props: OrgChartProps): void {\r\n  // Group by organization\r\n  const byOrg: Record<string, Contact[]> = {};\r\n  contacts.forEach(c => {\r\n    const org = c.organization || 'Other';\r\n    if (!byOrg[org]) byOrg[org] = [];\r\n    byOrg[org].push(c);\r\n  });\r\n\r\n  container.innerHTML = `\r\n    <div class=\"fallback-org-chart\">\r\n      ${Object.entries(byOrg).map(([org, members]) => `\r\n        <div class=\"org-group\">\r\n          <h4 class=\"org-name\">${escapeHtml(org)}</h4>\r\n          <div class=\"org-members\">\r\n            ${members.map(contact => `\r\n              <div class=\"org-member\" data-id=\"${contact.id}\">\r\n                <div class=\"member-avatar\">${getInitials(contact.name)}</div>\r\n                <div class=\"member-info\">\r\n                  <div class=\"member-name\">${escapeHtml(contact.name)}</div>\r\n                  ${contact.role ? `<div class=\"member-role\">${escapeHtml(contact.role)}</div>` : ''}\r\n                </div>\r\n              </div>\r\n            `).join('')}\r\n          </div>\r\n        </div>\r\n      `).join('')}\r\n    </div>\r\n  `;\r\n\r\n  // Bind click events\r\n  container.querySelectorAll('.org-member').forEach(el => {\r\n    on(el as HTMLElement, 'click', () => {\r\n      const id = el.getAttribute('data-id');\r\n      const contact = contacts.find(c => String(c.id) === id);\r\n      if (contact) {\r\n        if (props.onNodeClick) {\r\n          props.onNodeClick(contact);\r\n        } else {\r\n          showContactModal({ mode: 'view', contact });\r\n        }\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Get initials\r\n */\r\nfunction getInitials(name: string): string {\r\n  return name\r\n    .split(' ')\r\n    .map(n => n[0])\r\n    .join('')\r\n    .toUpperCase()\r\n    .slice(0, 2);\r\n}\r\n\r\n/**\r\n * Escape HTML\r\n */\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\nexport default createOrgChart;\r\n"],"names":["getVisOrgChart","createOrgChart","props","container","createElement","fitBtn","on","refreshBtn","loadOrgChart","chartContainer","contacts","contactsService","nodes","edges","buildOrgData","renderFallbackChart","renderVisNetwork","levels","contact","reportsTo","r","managerLevel","rel","visNodes","n","options","vis","network","params","nodeId","c","showContactModal","byOrg","org","members","escapeHtml","getInitials","el","id","name","text","div"],"mappings":"yGAoCA,SAASA,GAA0K,CAEjL,OAAQ,OAAe,GACzB,CAKO,SAASC,EAAeC,EAAuB,GAAiB,CACrE,MAAMC,EAAYC,EAAc,MAAO,CAAE,UAAW,YAAa,EAEjED,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAWtB,MAAME,EAASF,EAAU,cAAc,gBAAgB,EACnDE,GACFC,EAAGD,EAAuB,QAAS,IAAM,CACtBF,EAA4D,UACpE,IAAA,CACX,CAAC,EAGH,MAAMI,EAAaJ,EAAU,cAAc,oBAAoB,EAC/D,OAAII,GACFD,EAAGC,EAA2B,QAAS,IAAMC,EAAaL,EAAWD,CAAK,CAAC,EAI7EM,EAAaL,EAAWD,CAAK,EAEtBC,CACT,CAKA,eAAeK,EAAaL,EAAwBD,EAAqC,CACvF,MAAMO,EAAiBN,EAAU,cAAc,sBAAsB,EACrEM,EAAe,UAAY,wCAE3B,GAAI,CAEF,KAAM,CAAE,SAAAC,CAAA,EAAa,MAAMC,EAAgB,OAAO,CAAA,CAAE,EAEpD,GAAID,EAAS,SAAW,EAAG,CACzBD,EAAe,UAAY;AAAA;AAAA;AAAA;AAAA,QAK3B,MACF,CAGA,KAAM,CAAE,MAAAG,EAAO,MAAAC,GAAUC,EAAaJ,CAAQ,EAG9C,GAAI,CAACV,IAAkB,CACrBe,EAAoBN,EAAgBC,EAAUR,CAAK,EACnD,MACF,CAGAc,EAAiBP,EAAgBG,EAAOC,EAAOH,EAAUR,CAAK,CAChE,MAAQ,CACNO,EAAe,UAAY,mDAC7B,CACF,CAKA,SAASK,EAAaJ,EAA6D,CACjF,MAAME,EAAmB,CAAA,EACnBC,EAAmB,CAAA,EACnBI,MAAkC,IAGxC,OAAAP,EAAS,QAAQQ,GAAW,CAC1B,MAAMC,EAAYD,EAAQ,eAAe,KAAKE,GAAKA,EAAE,OAAS,YAAY,EAC1E,GAAID,EAAW,CAEb,MAAME,EAAeJ,EAAO,IAAIE,EAAU,SAAS,GAAK,EACxDF,EAAO,IAAI,OAAOC,EAAQ,EAAE,EAAGG,EAAe,CAAC,CACjD,MAEEJ,EAAO,IAAI,OAAOC,EAAQ,EAAE,EAAG,CAAC,CAEpC,CAAC,EAGDR,EAAS,QAAQQ,GAAW,CAC1BN,EAAM,KAAK,CACT,GAAI,OAAOM,EAAQ,EAAE,EACrB,MAAOA,EAAQ,KACf,MAAO,GAAGA,EAAQ,IAAI,GAAGA,EAAQ,KAAO;AAAA,EAAKA,EAAQ,IAAI,GAAK,EAAE,GAAGA,EAAQ,aAAe;AAAA,EAAKA,EAAQ,YAAY,GAAK,EAAE,GAC1H,MAAOD,EAAO,IAAI,OAAOC,EAAQ,EAAE,CAAC,GAAK,EACzC,MAAOA,EAAQ,QAAQ,CAAC,GAAG,KAAA,CAC5B,CACH,CAAC,EAGDR,EAAS,QAAQQ,GAAW,CAC1BA,EAAQ,eAAe,QAAQI,GAAO,CAChCA,EAAI,OAAS,cACfT,EAAM,KAAK,CACT,KAAMS,EAAI,UACV,GAAI,OAAOJ,EAAQ,EAAE,EACrB,OAAQ,IAAA,CACT,CAEL,CAAC,CACH,CAAC,EAEM,CAAE,MAAAN,EAAO,MAAAC,CAAA,CAClB,CAKA,SAASG,EACPb,EACAS,EACAC,EACAH,EACAR,EACM,CACNC,EAAU,UAAY,GAEtB,MAAMoB,EAAWX,EAAM,IAAIY,IAAM,CAC/B,GAAIA,EAAE,GACN,MAAOA,EAAE,MACT,MAAOA,EAAE,MACT,MAAOA,EAAE,MACT,MAAO,CACL,WAAYA,EAAE,OAAS,UACvB,OAAQA,EAAE,OAAS,UACnB,UAAW,CAAE,WAAY,UAAW,OAAQ,SAAA,CAAU,EAExD,KAAM,CAAE,MAAO,SAAA,EACf,MAAO,MACP,OAAQ,EAAA,EACR,EAEIC,EAAU,CACd,OAAQ,CACN,aAAc,CACZ,UAAW,KACX,WAAY,WACZ,gBAAiB,IACjB,YAAa,GAAA,CACf,EAEF,MAAO,CACL,YAAa,EACb,OAAQ,EAAA,EAEV,MAAO,CACL,MAAO,CAAE,MAAO,UAAW,UAAW,SAAA,EACtC,MAAO,EACP,OAAQ,CAAE,KAAM,aAAA,CAAc,EAEhC,QAAS,GACT,YAAa,CACX,MAAO,GACP,aAAc,GAAA,CAChB,EAGIC,EAAM1B,EAAA,EACN2B,EAAU,IAAID,EAAI,QAAQvB,EAAW,CACzC,MAAO,IAAIuB,EAAI,QAAQH,CAAQ,EAC/B,MAAO,IAAIG,EAAI,QAAQb,CAAK,CAAA,EAC3BY,CAAO,EAGTtB,EAAU,QAAQ,YAAY,EAA8C,SAAWwB,EAGxFA,EAAQ,GAAG,QAAUC,GAAW,CAC9B,GAAIA,EAAO,MAAM,OAAS,EAAG,CAC3B,MAAMC,EAASD,EAAO,MAAM,CAAC,EACvBV,EAAUR,EAAS,KAAKoB,GAAK,OAAOA,EAAE,EAAE,IAAMD,CAAM,EACtDX,IACEhB,EAAM,YACRA,EAAM,YAAYgB,CAAO,EAEzBa,EAAiB,CAAE,KAAM,OAAQ,QAAAb,CAAA,CAAS,EAGhD,CACF,CAAC,EAEDS,EAAQ,IAAA,CACV,CAKA,SAASZ,EAAoBZ,EAAwBO,EAAqBR,EAA4B,CAEpG,MAAM8B,EAAmC,CAAA,EACzCtB,EAAS,QAAQoB,GAAK,CACpB,MAAMG,EAAMH,EAAE,cAAgB,QACzBE,EAAMC,CAAG,IAAGD,EAAMC,CAAG,EAAI,CAAA,GAC9BD,EAAMC,CAAG,EAAE,KAAKH,CAAC,CACnB,CAAC,EAED3B,EAAU,UAAY;AAAA;AAAA,QAEhB,OAAO,QAAQ6B,CAAK,EAAE,IAAI,CAAC,CAACC,EAAKC,CAAO,IAAM;AAAA;AAAA,iCAErBC,EAAWF,CAAG,CAAC;AAAA;AAAA,cAElCC,EAAQ,IAAIhB,GAAW;AAAA,iDACYA,EAAQ,EAAE;AAAA,6CACdkB,EAAYlB,EAAQ,IAAI,CAAC;AAAA;AAAA,6CAEzBiB,EAAWjB,EAAQ,IAAI,CAAC;AAAA,oBACjDA,EAAQ,KAAO,4BAA4BiB,EAAWjB,EAAQ,IAAI,CAAC,SAAW,EAAE;AAAA;AAAA;AAAA,aAGvF,EAAE,KAAK,EAAE,CAAC;AAAA;AAAA;AAAA,OAGhB,EAAE,KAAK,EAAE,CAAC;AAAA;AAAA,IAKff,EAAU,iBAAiB,aAAa,EAAE,QAAQkC,GAAM,CACtD/B,EAAG+B,EAAmB,QAAS,IAAM,CACnC,MAAMC,EAAKD,EAAG,aAAa,SAAS,EAC9BnB,EAAUR,EAAS,KAAKoB,GAAK,OAAOA,EAAE,EAAE,IAAMQ,CAAE,EAClDpB,IACEhB,EAAM,YACRA,EAAM,YAAYgB,CAAO,EAEzBa,EAAiB,CAAE,KAAM,OAAQ,QAAAb,CAAA,CAAS,EAGhD,CAAC,CACH,CAAC,CACH,CAKA,SAASkB,EAAYG,EAAsB,CACzC,OAAOA,EACJ,MAAM,GAAG,EACT,OAASf,EAAE,CAAC,CAAC,EACb,KAAK,EAAE,EACP,cACA,MAAM,EAAG,CAAC,CACf,CAKA,SAASW,EAAWK,EAAsB,CACxC,MAAMC,EAAM,SAAS,cAAc,KAAK,EACxC,OAAAA,EAAI,YAAcD,EACXC,EAAI,SACb"}