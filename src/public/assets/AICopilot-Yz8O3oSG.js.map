{"version":3,"file":"AICopilot-Yz8O3oSG.js","sources":["../../frontend/components/graph/AICopilot.ts"],"sourcesContent":["/**\r\n * AICopilot - AI-powered chat for the Knowledge Graph\r\n * \r\n * Features:\r\n * - Natural language queries using GraphRAG\r\n * - Voice input (Web Speech API)\r\n * - Reasoning chain visualization\r\n * - Node highlighting\r\n * - Query suggestions\r\n * - Persistent chat history\r\n */\r\n\r\nimport { createElement, on } from '../../utils/dom';\r\nimport { graphService, GraphRAGResponse, GraphChatMessage } from '../../services/graph';\r\nimport { toast } from '../../services/toast';\r\n\r\nexport interface AICopilotProps {\r\n  onClose?: () => void;\r\n  onHighlightNodes?: (nodeIds: string[]) => void;\r\n  onExecuteQuery?: (cypher: string) => void;\r\n}\r\n\r\ninterface CopilotState {\r\n  messages: Array<{\r\n    role: 'user' | 'assistant' | 'system';\r\n    content: string;\r\n    metadata?: GraphRAGResponse;\r\n    timestamp: Date;\r\n  }>;\r\n  isLoading: boolean;\r\n  sessionId: string;\r\n  isRecording: boolean;\r\n}\r\n\r\n/**\r\n * Create the AI Copilot component\r\n */\r\nexport function createAICopilot(props: AICopilotProps = {}): HTMLElement {\r\n  const state: CopilotState = {\r\n    messages: [],\r\n    isLoading: false,\r\n    sessionId: crypto.randomUUID(),\r\n    isRecording: false,\r\n  };\r\n\r\n  const container = createElement('div', { className: 'ai-copilot' });\r\n  \r\n  container.innerHTML = `\r\n    <div class=\"copilot-header\">\r\n      <div class=\"copilot-title\">\r\n        <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <path d=\"M12 2a10 10 0 0 1 10 10c0 5.5-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2\"/>\r\n          <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n          <path d=\"M12 6v1M12 17v1M6 12h1M17 12h1\"/>\r\n        </svg>\r\n        <span>AI Copilot</span>\r\n      </div>\r\n      <div class=\"copilot-actions\">\r\n        <button class=\"copilot-btn\" id=\"copilot-history\" title=\"Chat History\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n            <polyline points=\"12 6 12 12 16 14\"/>\r\n          </svg>\r\n        </button>\r\n        <button class=\"copilot-btn\" id=\"copilot-clear\" title=\"Clear Chat\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <polyline points=\"3 6 5 6 21 6\"/>\r\n            <path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/>\r\n          </svg>\r\n        </button>\r\n        <button class=\"copilot-btn\" id=\"copilot-close\" title=\"Close\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"/>\r\n            <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"/>\r\n          </svg>\r\n        </button>\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"copilot-messages\" id=\"copilot-messages\">\r\n      <div class=\"copilot-welcome\">\r\n        <div class=\"welcome-icon\">\r\n          <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\">\r\n            <path d=\"M12 2a10 10 0 0 1 10 10c0 5.5-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2\"/>\r\n            <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n          </svg>\r\n        </div>\r\n        <h3>Hello! I'm your AI assistant.</h3>\r\n        <p>Ask me anything about your knowledge graph. I can help you:</p>\r\n        <ul class=\"welcome-list\">\r\n          <li>Find connections between people and projects</li>\r\n          <li>Explain relationships and patterns</li>\r\n          <li>Summarize information about entities</li>\r\n          <li>Generate Cypher queries</li>\r\n        </ul>\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"copilot-suggestions\" id=\"copilot-suggestions\">\r\n      <button class=\"suggestion-chip\" data-query=\"Who are the key people in this project?\">\r\n        Key people\r\n      </button>\r\n      <button class=\"suggestion-chip\" data-query=\"What are the main risks?\">\r\n        Main risks\r\n      </button>\r\n      <button class=\"suggestion-chip\" data-query=\"Show recent decisions\">\r\n        Recent decisions\r\n      </button>\r\n      <button class=\"suggestion-chip\" data-query=\"Find connections between teams\">\r\n        Team connections\r\n      </button>\r\n    </div>\r\n    \r\n    <div class=\"copilot-input-area\">\r\n      <div class=\"copilot-input-wrapper\">\r\n        <textarea\r\n          id=\"copilot-input\"\r\n          class=\"copilot-input\"\r\n          placeholder=\"Ask about your knowledge graph...\"\r\n          rows=\"1\"\r\n        ></textarea>\r\n        <button class=\"copilot-voice-btn ${isVoiceSupported() ? '' : 'hidden'}\" id=\"copilot-voice\" title=\"Voice Input\">\r\n          <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <path d=\"M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z\"/>\r\n            <path d=\"M19 10v2a7 7 0 0 1-14 0v-2\"/>\r\n            <line x1=\"12\" y1=\"19\" x2=\"12\" y2=\"23\"/>\r\n            <line x1=\"8\" y1=\"23\" x2=\"16\" y2=\"23\"/>\r\n          </svg>\r\n        </button>\r\n      </div>\r\n      <button class=\"copilot-send-btn\" id=\"copilot-send\" title=\"Send\">\r\n        <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"/>\r\n          <polygon points=\"22 2 15 22 11 13 2 9 22 2\"/>\r\n        </svg>\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  // Initialize\r\n  initCopilot(container, state, props);\r\n\r\n  return container;\r\n}\r\n\r\n/**\r\n * Initialize the copilot\r\n */\r\nfunction initCopilot(container: HTMLElement, state: CopilotState, props: AICopilotProps): void {\r\n  const messagesEl = container.querySelector('#copilot-messages') as HTMLElement;\r\n  const inputEl = container.querySelector('#copilot-input') as HTMLTextAreaElement;\r\n  const sendBtn = container.querySelector('#copilot-send') as HTMLElement;\r\n  const voiceBtn = container.querySelector('#copilot-voice') as HTMLElement;\r\n  const clearBtn = container.querySelector('#copilot-clear') as HTMLElement;\r\n  const closeBtn = container.querySelector('#copilot-close') as HTMLElement;\r\n  const historyBtn = container.querySelector('#copilot-history') as HTMLElement;\r\n\r\n  // Send message\r\n  const sendMessage = async () => {\r\n    const query = inputEl.value.trim();\r\n    if (!query || state.isLoading) return;\r\n\r\n    inputEl.value = '';\r\n    inputEl.style.height = 'auto';\r\n    await processQuery(container, state, query, props);\r\n  };\r\n\r\n  // Bind send button\r\n  on(sendBtn, 'click', sendMessage);\r\n\r\n  // Bind enter key\r\n  on(inputEl, 'keydown', (e: Event) => {\r\n    const event = e as KeyboardEvent;\r\n    if (event.key === 'Enter' && !event.shiftKey) {\r\n      event.preventDefault();\r\n      sendMessage();\r\n    }\r\n  });\r\n\r\n  // Auto-resize textarea\r\n  on(inputEl, 'input', () => {\r\n    inputEl.style.height = 'auto';\r\n    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';\r\n  });\r\n\r\n  // Voice input\r\n  if (voiceBtn && isVoiceSupported()) {\r\n    on(voiceBtn, 'click', () => toggleVoiceInput(container, state, inputEl));\r\n  }\r\n\r\n  // Clear chat\r\n  on(clearBtn, 'click', () => {\r\n    state.messages = [];\r\n    state.sessionId = crypto.randomUUID();\r\n    messagesEl.innerHTML = getWelcomeHTML();\r\n  });\r\n\r\n  // Close\r\n  on(closeBtn, 'click', () => props.onClose?.());\r\n\r\n  // History\r\n  on(historyBtn, 'click', () => showChatHistory(container));\r\n\r\n  // Suggestion chips\r\n  const chips = container.querySelectorAll('.suggestion-chip');\r\n  chips.forEach(chip => {\r\n    on(chip as HTMLElement, 'click', () => {\r\n      const query = chip.getAttribute('data-query');\r\n      if (query) {\r\n        inputEl.value = query;\r\n        sendMessage();\r\n      }\r\n    });\r\n  });\r\n\r\n  // Load previous session if exists\r\n  loadSession(state);\r\n}\r\n\r\n/**\r\n * Process query\r\n */\r\nasync function processQuery(\r\n  container: HTMLElement,\r\n  state: CopilotState,\r\n  query: string,\r\n  props: AICopilotProps\r\n): Promise<void> {\r\n  state.isLoading = true;\r\n  const messagesEl = container.querySelector('#copilot-messages') as HTMLElement;\r\n  const suggestionsEl = container.querySelector('#copilot-suggestions') as HTMLElement;\r\n\r\n  // Hide welcome and suggestions\r\n  const welcome = messagesEl.querySelector('.copilot-welcome');\r\n  if (welcome) welcome.remove();\r\n  suggestionsEl.classList.add('hidden');\r\n\r\n  // Add user message\r\n  const userMessage = { role: 'user' as const, content: query, timestamp: new Date() };\r\n  state.messages.push(userMessage);\r\n  appendMessage(messagesEl, userMessage);\r\n\r\n  // Add loading indicator\r\n  const loadingEl = createElement('div', { className: 'copilot-message assistant loading' });\r\n  loadingEl.innerHTML = `\r\n    <div class=\"message-avatar\">\r\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n        <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n        <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n      </svg>\r\n    </div>\r\n    <div class=\"message-content\">\r\n      <div class=\"typing-indicator\">\r\n        <span></span><span></span><span></span>\r\n      </div>\r\n    </div>\r\n  `;\r\n  messagesEl.appendChild(loadingEl);\r\n  scrollToBottom(messagesEl);\r\n\r\n  try {\r\n    // Call GraphRAG\r\n    const response = await graphService.query(query);\r\n\r\n    // Remove loading\r\n    loadingEl.remove();\r\n\r\n    // Add assistant message\r\n    const assistantMessage = {\r\n      role: 'assistant' as const,\r\n      content: response.answer,\r\n      metadata: response,\r\n      timestamp: new Date(),\r\n    };\r\n    state.messages.push(assistantMessage);\r\n    appendMessage(messagesEl, assistantMessage, props);\r\n\r\n    // Save to history\r\n    saveMessage(state, userMessage);\r\n    saveMessage(state, assistantMessage);\r\n\r\n    // Highlight nodes if available\r\n    if (response.highlightedNodes?.length && props.onHighlightNodes) {\r\n      props.onHighlightNodes(response.highlightedNodes);\r\n    }\r\n\r\n  } catch (error) {\r\n    loadingEl.remove();\r\n    const errorMessage = {\r\n      role: 'assistant' as const,\r\n      content: 'Sorry, I encountered an error processing your question. Please try again.',\r\n      timestamp: new Date(),\r\n    };\r\n    state.messages.push(errorMessage);\r\n    appendMessage(messagesEl, errorMessage);\r\n  }\r\n\r\n  state.isLoading = false;\r\n  scrollToBottom(messagesEl);\r\n}\r\n\r\n/**\r\n * Append message to chat\r\n */\r\nfunction appendMessage(\r\n  container: HTMLElement,\r\n  message: { role: 'user' | 'assistant' | 'system'; content: string; metadata?: GraphRAGResponse; timestamp: Date },\r\n  props?: AICopilotProps\r\n): void {\r\n  const el = createElement('div', { className: `copilot-message ${message.role}` });\r\n  \r\n  if (message.role === 'user') {\r\n    el.innerHTML = `\r\n      <div class=\"message-content\">${escapeHtml(message.content)}</div>\r\n      <div class=\"message-avatar user-avatar\">\r\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/>\r\n          <circle cx=\"12\" cy=\"7\" r=\"4\"/>\r\n        </svg>\r\n      </div>\r\n    `;\r\n  } else {\r\n    const meta = message.metadata;\r\n    \r\n    el.innerHTML = `\r\n      <div class=\"message-avatar\">\r\n        <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n          <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n        </svg>\r\n      </div>\r\n      <div class=\"message-content\">\r\n        <div class=\"message-text\">${formatMarkdown(message.content)}</div>\r\n        \r\n        ${meta?.reasoningChain?.length ? `\r\n          <div class=\"reasoning-chain\">\r\n            <button class=\"reasoning-toggle\" data-expanded=\"false\">\r\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                <polyline points=\"9 18 15 12 9 6\"/>\r\n              </svg>\r\n              Reasoning Chain (${meta.reasoningChain.length} steps)\r\n            </button>\r\n            <div class=\"reasoning-steps hidden\">\r\n              ${meta.reasoningChain.map((step, i) => `\r\n                <div class=\"reasoning-step\">\r\n                  <div class=\"step-number\">${i + 1}</div>\r\n                  <div class=\"step-content\">\r\n                    <div class=\"step-name\">${escapeHtml(step.step)}</div>\r\n                    ${step.reasoning ? `<div class=\"step-reasoning\">${escapeHtml(step.reasoning)}</div>` : ''}\r\n                  </div>\r\n                </div>\r\n              `).join('')}\r\n            </div>\r\n          </div>\r\n        ` : ''}\r\n        \r\n        ${meta?.cypherGenerated ? `\r\n          <div class=\"cypher-preview\">\r\n            <button class=\"cypher-toggle\" data-expanded=\"false\">\r\n              <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                <polyline points=\"16 18 22 12 16 6\"/>\r\n                <polyline points=\"8 6 2 12 8 18\"/>\r\n              </svg>\r\n              Generated Cypher\r\n            </button>\r\n            <div class=\"cypher-code hidden\">\r\n              <pre><code>${escapeHtml(meta.cypherGenerated)}</code></pre>\r\n              <button class=\"cypher-run-btn\" title=\"Execute Query\">\r\n                <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n                  <polygon points=\"5 3 19 12 5 21 5 3\"/>\r\n                </svg>\r\n                Run\r\n              </button>\r\n            </div>\r\n          </div>\r\n        ` : ''}\r\n        \r\n        ${meta?.sources?.length ? `\r\n          <div class=\"message-sources\">\r\n            <span class=\"sources-label\">Sources:</span>\r\n            ${meta.sources.slice(0, 3).map(s => `\r\n              <span class=\"source-chip\">${s.type}</span>\r\n            `).join('')}\r\n            ${meta.sources.length > 3 ? `<span class=\"source-more\">+${meta.sources.length - 3} more</span>` : ''}\r\n          </div>\r\n        ` : ''}\r\n        \r\n        <div class=\"message-meta\">\r\n          <span class=\"meta-type\">${meta?.queryType || 'hybrid'}</span>\r\n          ${meta?.latencyMs ? `<span class=\"meta-latency\">${meta.latencyMs}ms</span>` : ''}\r\n          ${meta?.confidence ? `<span class=\"meta-confidence\">${Math.round(meta.confidence * 100)}% confident</span>` : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Bind reasoning toggle\r\n    setTimeout(() => {\r\n      const reasoningToggle = el.querySelector('.reasoning-toggle');\r\n      if (reasoningToggle) {\r\n        on(reasoningToggle as HTMLElement, 'click', () => {\r\n          const steps = el.querySelector('.reasoning-steps');\r\n          const expanded = reasoningToggle.getAttribute('data-expanded') === 'true';\r\n          reasoningToggle.setAttribute('data-expanded', String(!expanded));\r\n          steps?.classList.toggle('hidden');\r\n          const icon = reasoningToggle.querySelector('svg');\r\n          if (icon) icon.style.transform = expanded ? '' : 'rotate(90deg)';\r\n        });\r\n      }\r\n\r\n      const cypherToggle = el.querySelector('.cypher-toggle');\r\n      if (cypherToggle) {\r\n        on(cypherToggle as HTMLElement, 'click', () => {\r\n          const code = el.querySelector('.cypher-code');\r\n          const expanded = cypherToggle.getAttribute('data-expanded') === 'true';\r\n          cypherToggle.setAttribute('data-expanded', String(!expanded));\r\n          code?.classList.toggle('hidden');\r\n        });\r\n      }\r\n\r\n      const cypherRunBtn = el.querySelector('.cypher-run-btn');\r\n      if (cypherRunBtn && meta?.cypherGenerated && props?.onExecuteQuery) {\r\n        on(cypherRunBtn as HTMLElement, 'click', () => {\r\n          props.onExecuteQuery!(meta.cypherGenerated!);\r\n          toast.info('Executing query...');\r\n        });\r\n      }\r\n    }, 0);\r\n  }\r\n\r\n  container.appendChild(el);\r\n}\r\n\r\n/**\r\n * Toggle voice input\r\n */\r\nfunction toggleVoiceInput(container: HTMLElement, state: CopilotState, inputEl: HTMLTextAreaElement): void {\r\n  if (!isVoiceSupported()) {\r\n    toast.error('Voice input not supported in this browser');\r\n    return;\r\n  }\r\n\r\n  const voiceBtn = container.querySelector('#copilot-voice') as HTMLElement;\r\n  \r\n  if (state.isRecording) {\r\n    // Stop recording\r\n    state.isRecording = false;\r\n    voiceBtn.classList.remove('recording');\r\n    // Recognition will be stopped by the recognition object\r\n  } else {\r\n    // Start recording\r\n    state.isRecording = true;\r\n    voiceBtn.classList.add('recording');\r\n\r\n    const SpeechRecognition = (window as unknown as { SpeechRecognition?: new () => SpeechRecognition; webkitSpeechRecognition?: new () => SpeechRecognition }).SpeechRecognition || \r\n                              (window as unknown as { webkitSpeechRecognition?: new () => SpeechRecognition }).webkitSpeechRecognition;\r\n    \r\n    if (!SpeechRecognition) {\r\n      toast.error('Speech recognition not available');\r\n      state.isRecording = false;\r\n      voiceBtn.classList.remove('recording');\r\n      return;\r\n    }\r\n\r\n    const recognition = new SpeechRecognition();\r\n    recognition.continuous = false;\r\n    recognition.interimResults = true;\r\n    recognition.lang = 'pt-PT'; // Portuguese, change as needed\r\n\r\n    recognition.onresult = (event: SpeechRecognitionEvent) => {\r\n      const transcript = Array.from(event.results)\r\n        .map(result => result[0].transcript)\r\n        .join('');\r\n      inputEl.value = transcript;\r\n      inputEl.style.height = 'auto';\r\n      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';\r\n    };\r\n\r\n    recognition.onend = () => {\r\n      state.isRecording = false;\r\n      voiceBtn.classList.remove('recording');\r\n    };\r\n\r\n    recognition.onerror = (event: SpeechRecognitionErrorEvent) => {\r\n      console.error('Speech recognition error:', event.error);\r\n      state.isRecording = false;\r\n      voiceBtn.classList.remove('recording');\r\n      if (event.error !== 'aborted') {\r\n        toast.error('Voice recognition failed');\r\n      }\r\n    };\r\n\r\n    recognition.start();\r\n  }\r\n}\r\n\r\n/**\r\n * Check if voice is supported\r\n */\r\nfunction isVoiceSupported(): boolean {\r\n  return !!(\r\n    (window as unknown as { SpeechRecognition?: unknown }).SpeechRecognition || \r\n    (window as unknown as { webkitSpeechRecognition?: unknown }).webkitSpeechRecognition\r\n  );\r\n}\r\n\r\n/**\r\n * Show chat history\r\n */\r\nasync function showChatHistory(container: HTMLElement): Promise<void> {\r\n  try {\r\n    const sessions = await graphService.getChatSessions();\r\n    \r\n    if (sessions.length === 0) {\r\n      toast.info('No chat history found');\r\n      return;\r\n    }\r\n\r\n    // TODO: Show history modal\r\n    toast.info(`${sessions.length} previous sessions found`);\r\n  } catch {\r\n    toast.error('Failed to load chat history');\r\n  }\r\n}\r\n\r\n/**\r\n * Load session\r\n */\r\nfunction loadSession(state: CopilotState): void {\r\n  // Could load from localStorage for quick resume\r\n  const saved = localStorage.getItem('copilot_session');\r\n  if (saved) {\r\n    try {\r\n      const data = JSON.parse(saved);\r\n      if (data.sessionId && data.messages) {\r\n        state.sessionId = data.sessionId;\r\n        // Don't restore messages for now, start fresh\r\n      }\r\n    } catch {\r\n      // Ignore\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Save message to Supabase\r\n */\r\nasync function saveMessage(\r\n  state: CopilotState,\r\n  message: { role: 'user' | 'assistant' | 'system'; content: string; metadata?: GraphRAGResponse }\r\n): Promise<void> {\r\n  try {\r\n    await graphService.saveChatMessage({\r\n      session_id: state.sessionId,\r\n      role: message.role,\r\n      content: message.content,\r\n      metadata: message.metadata ? {\r\n        queryType: message.metadata.queryType,\r\n        cypherGenerated: message.metadata.cypherGenerated,\r\n        sources: message.metadata.sources,\r\n        reasoningChain: message.metadata.reasoningChain,\r\n        highlightedNodes: message.metadata.highlightedNodes,\r\n        executionTimeMs: message.metadata.latencyMs,\r\n        confidence: message.metadata.confidence,\r\n      } : undefined,\r\n      is_pinned: false,\r\n    });\r\n  } catch {\r\n    // Silent fail - don't interrupt UX\r\n  }\r\n}\r\n\r\n/**\r\n * Get welcome HTML\r\n */\r\nfunction getWelcomeHTML(): string {\r\n  return `\r\n    <div class=\"copilot-welcome\">\r\n      <div class=\"welcome-icon\">\r\n        <svg width=\"32\" height=\"32\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\">\r\n          <path d=\"M12 2a10 10 0 0 1 10 10c0 5.5-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2\"/>\r\n          <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n        </svg>\r\n      </div>\r\n      <h3>Hello! I'm your AI assistant.</h3>\r\n      <p>Ask me anything about your knowledge graph.</p>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Scroll to bottom\r\n */\r\nfunction scrollToBottom(container: HTMLElement): void {\r\n  container.scrollTop = container.scrollHeight;\r\n}\r\n\r\n/**\r\n * Format markdown (basic)\r\n */\r\nfunction formatMarkdown(text: string): string {\r\n  return escapeHtml(text)\r\n    .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\r\n    .replace(/\\*(.*?)\\*/g, '<em>$1</em>')\r\n    .replace(/`(.*?)`/g, '<code>$1</code>')\r\n    .replace(/\\n/g, '<br>');\r\n}\r\n\r\n/**\r\n * Escape HTML\r\n */\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n// TypeScript interfaces for Web Speech API\r\ninterface SpeechRecognition extends EventTarget {\r\n  continuous: boolean;\r\n  interimResults: boolean;\r\n  lang: string;\r\n  start(): void;\r\n  stop(): void;\r\n  onresult: (event: SpeechRecognitionEvent) => void;\r\n  onend: () => void;\r\n  onerror: (event: SpeechRecognitionErrorEvent) => void;\r\n}\r\n\r\ninterface SpeechRecognitionEvent {\r\n  results: SpeechRecognitionResultList;\r\n}\r\n\r\ninterface SpeechRecognitionResultList {\r\n  length: number;\r\n  [index: number]: SpeechRecognitionResult;\r\n}\r\n\r\ninterface SpeechRecognitionResult {\r\n  [index: number]: SpeechRecognitionAlternative;\r\n  isFinal: boolean;\r\n}\r\n\r\ninterface SpeechRecognitionAlternative {\r\n  transcript: string;\r\n  confidence: number;\r\n}\r\n\r\ninterface SpeechRecognitionErrorEvent {\r\n  error: string;\r\n}\r\n\r\nexport default createAICopilot;\r\n"],"names":["createAICopilot","props","state","container","createElement","isVoiceSupported","initCopilot","messagesEl","inputEl","sendBtn","voiceBtn","clearBtn","closeBtn","historyBtn","sendMessage","query","processQuery","on","e","event","toggleVoiceInput","getWelcomeHTML","showChatHistory","chip","loadSession","suggestionsEl","welcome","userMessage","appendMessage","loadingEl","scrollToBottom","response","graphService","assistantMessage","saveMessage","errorMessage","message","el","escapeHtml","meta","formatMarkdown","step","i","reasoningToggle","steps","expanded","icon","cypherToggle","code","cypherRunBtn","toast","SpeechRecognition","recognition","transcript","result","sessions","saved","data","text","div"],"mappings":"yGAqCO,SAASA,EAAgBC,EAAwB,GAAiB,CACvE,MAAMC,EAAsB,CAC1B,SAAU,CAAA,EACV,UAAW,GACX,UAAW,OAAO,WAAA,EAClB,YAAa,EAAA,EAGTC,EAAYC,EAAc,MAAO,CAAE,UAAW,aAAc,EAElE,OAAAD,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2CA0EmBE,EAAA,EAAqB,GAAK,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAmB3EC,EAAYH,EAAWD,EAAOD,CAAK,EAE5BE,CACT,CAKA,SAASG,EAAYH,EAAwBD,EAAqBD,EAA6B,CAC7F,MAAMM,EAAaJ,EAAU,cAAc,mBAAmB,EACxDK,EAAUL,EAAU,cAAc,gBAAgB,EAClDM,EAAUN,EAAU,cAAc,eAAe,EACjDO,EAAWP,EAAU,cAAc,gBAAgB,EACnDQ,EAAWR,EAAU,cAAc,gBAAgB,EACnDS,EAAWT,EAAU,cAAc,gBAAgB,EACnDU,EAAaV,EAAU,cAAc,kBAAkB,EAGvDW,EAAc,SAAY,CAC9B,MAAMC,EAAQP,EAAQ,MAAM,KAAA,EACxB,CAACO,GAASb,EAAM,YAEpBM,EAAQ,MAAQ,GAChBA,EAAQ,MAAM,OAAS,OACvB,MAAMQ,EAAab,EAAWD,EAAOa,EAAOd,CAAK,EACnD,EAGAgB,EAAGR,EAAS,QAASK,CAAW,EAGhCG,EAAGT,EAAS,UAAYU,GAAa,CACnC,MAAMC,EAAQD,EACVC,EAAM,MAAQ,SAAW,CAACA,EAAM,WAClCA,EAAM,eAAA,EACNL,EAAA,EAEJ,CAAC,EAGDG,EAAGT,EAAS,QAAS,IAAM,CACzBA,EAAQ,MAAM,OAAS,OACvBA,EAAQ,MAAM,OAAS,KAAK,IAAIA,EAAQ,aAAc,GAAG,EAAI,IAC/D,CAAC,EAGGE,GAAYL,KACdY,EAAGP,EAAU,QAAS,IAAMU,EAAiBjB,EAAWD,EAAOM,CAAO,CAAC,EAIzES,EAAGN,EAAU,QAAS,IAAM,CAC1BT,EAAM,SAAW,CAAA,EACjBA,EAAM,UAAY,OAAO,WAAA,EACzBK,EAAW,UAAYc,EAAA,CACzB,CAAC,EAGDJ,EAAGL,EAAU,QAAS,IAAMX,EAAM,WAAW,EAG7CgB,EAAGJ,EAAY,QAAS,IAAMS,EAAyB,CAAC,EAG1CnB,EAAU,iBAAiB,kBAAkB,EACrD,QAAQoB,GAAQ,CACpBN,EAAGM,EAAqB,QAAS,IAAM,CACrC,MAAMR,EAAQQ,EAAK,aAAa,YAAY,EACxCR,IACFP,EAAQ,MAAQO,EAChBD,EAAA,EAEJ,CAAC,CACH,CAAC,EAGDU,EAAYtB,CAAK,CACnB,CAKA,eAAec,EACbb,EACAD,EACAa,EACAd,EACe,CACfC,EAAM,UAAY,GAClB,MAAMK,EAAaJ,EAAU,cAAc,mBAAmB,EACxDsB,EAAgBtB,EAAU,cAAc,sBAAsB,EAG9DuB,EAAUnB,EAAW,cAAc,kBAAkB,EACvDmB,KAAiB,OAAA,EACrBD,EAAc,UAAU,IAAI,QAAQ,EAGpC,MAAME,EAAc,CAAE,KAAM,OAAiB,QAASZ,EAAO,UAAW,IAAI,IAAK,EACjFb,EAAM,SAAS,KAAKyB,CAAW,EAC/BC,EAAcrB,EAAYoB,CAAW,EAGrC,MAAME,EAAYzB,EAAc,MAAO,CAAE,UAAW,oCAAqC,EACzFyB,EAAU,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAatBtB,EAAW,YAAYsB,CAAS,EAChCC,EAAevB,CAAU,EAEzB,GAAI,CAEF,MAAMwB,EAAW,MAAMC,EAAa,MAAMjB,CAAK,EAG/Cc,EAAU,OAAA,EAGV,MAAMI,EAAmB,CACvB,KAAM,YACN,QAASF,EAAS,OAClB,SAAUA,EACV,cAAe,IAAK,EAEtB7B,EAAM,SAAS,KAAK+B,CAAgB,EACpCL,EAAcrB,EAAY0B,EAAkBhC,CAAK,EAGjDiC,EAAYhC,EAAOyB,CAAW,EAC9BO,EAAYhC,EAAO+B,CAAgB,EAG/BF,EAAS,kBAAkB,QAAU9B,EAAM,kBAC7CA,EAAM,iBAAiB8B,EAAS,gBAAgB,CAGpD,MAAgB,CACdF,EAAU,OAAA,EACV,MAAMM,EAAe,CACnB,KAAM,YACN,QAAS,4EACT,cAAe,IAAK,EAEtBjC,EAAM,SAAS,KAAKiC,CAAY,EAChCP,EAAcrB,EAAY4B,CAAY,CACxC,CAEAjC,EAAM,UAAY,GAClB4B,EAAevB,CAAU,CAC3B,CAKA,SAASqB,EACPzB,EACAiC,EACAnC,EACM,CACN,MAAMoC,EAAKjC,EAAc,MAAO,CAAE,UAAW,mBAAmBgC,EAAQ,IAAI,GAAI,EAEhF,GAAIA,EAAQ,OAAS,OACnBC,EAAG,UAAY;AAAA,qCACkBC,EAAWF,EAAQ,OAAO,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAQvD,CACL,MAAMG,EAAOH,EAAQ,SAErBC,EAAG,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oCAQiBG,EAAeJ,EAAQ,OAAO,CAAC;AAAA;AAAA,UAEzDG,GAAM,gBAAgB,OAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCAMRA,EAAK,eAAe,MAAM;AAAA;AAAA;AAAA,gBAG3CA,EAAK,eAAe,IAAI,CAACE,EAAMC,IAAM;AAAA;AAAA,6CAERA,EAAI,CAAC;AAAA;AAAA,6CAELJ,EAAWG,EAAK,IAAI,CAAC;AAAA,sBAC5CA,EAAK,UAAY,+BAA+BH,EAAWG,EAAK,SAAS,CAAC,SAAW,EAAE;AAAA;AAAA;AAAA,eAG9F,EAAE,KAAK,EAAE,CAAC;AAAA;AAAA;AAAA,UAGb,EAAE;AAAA;AAAA,UAEJF,GAAM,gBAAkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAUPD,EAAWC,EAAK,eAAe,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAS/C,EAAE;AAAA;AAAA,UAEJA,GAAM,SAAS,OAAS;AAAA;AAAA;AAAA,cAGpBA,EAAK,QAAQ,MAAM,EAAG,CAAC,EAAE,IAAI,GAAK;AAAA,0CACN,EAAE,IAAI;AAAA,aACnC,EAAE,KAAK,EAAE,CAAC;AAAA,cACTA,EAAK,QAAQ,OAAS,EAAI,8BAA8BA,EAAK,QAAQ,OAAS,CAAC,eAAiB,EAAE;AAAA;AAAA,UAEpG,EAAE;AAAA;AAAA;AAAA,oCAGsBA,GAAM,WAAa,QAAQ;AAAA,YACnDA,GAAM,UAAY,8BAA8BA,EAAK,SAAS,YAAc,EAAE;AAAA,YAC9EA,GAAM,WAAa,iCAAiC,KAAK,MAAMA,EAAK,WAAa,GAAG,CAAC,qBAAuB,EAAE;AAAA;AAAA;AAAA,MAMtH,WAAW,IAAM,CACf,MAAMI,EAAkBN,EAAG,cAAc,mBAAmB,EACxDM,GACF1B,EAAG0B,EAAgC,QAAS,IAAM,CAChD,MAAMC,EAAQP,EAAG,cAAc,kBAAkB,EAC3CQ,EAAWF,EAAgB,aAAa,eAAe,IAAM,OACnEA,EAAgB,aAAa,gBAAiB,OAAO,CAACE,CAAQ,CAAC,EAC/DD,GAAO,UAAU,OAAO,QAAQ,EAChC,MAAME,EAAOH,EAAgB,cAAc,KAAK,EAC5CG,IAAMA,EAAK,MAAM,UAAYD,EAAW,GAAK,gBACnD,CAAC,EAGH,MAAME,EAAeV,EAAG,cAAc,gBAAgB,EAClDU,GACF9B,EAAG8B,EAA6B,QAAS,IAAM,CAC7C,MAAMC,EAAOX,EAAG,cAAc,cAAc,EACtCQ,EAAWE,EAAa,aAAa,eAAe,IAAM,OAChEA,EAAa,aAAa,gBAAiB,OAAO,CAACF,CAAQ,CAAC,EAC5DG,GAAM,UAAU,OAAO,QAAQ,CACjC,CAAC,EAGH,MAAMC,EAAeZ,EAAG,cAAc,iBAAiB,EACnDY,GAAgBV,GAAM,iBAAmBtC,GAAO,gBAClDgB,EAAGgC,EAA6B,QAAS,IAAM,CAC7ChD,EAAM,eAAgBsC,EAAK,eAAgB,EAC3CW,EAAM,KAAK,oBAAoB,CACjC,CAAC,CAEL,EAAG,CAAC,CACN,CAEA/C,EAAU,YAAYkC,CAAE,CAC1B,CAKA,SAASjB,EAAiBjB,EAAwBD,EAAqBM,EAAoC,CACzG,GAAI,CAACH,IAAoB,CACvB6C,EAAM,MAAM,2CAA2C,EACvD,MACF,CAEA,MAAMxC,EAAWP,EAAU,cAAc,gBAAgB,EAEzD,GAAID,EAAM,YAERA,EAAM,YAAc,GACpBQ,EAAS,UAAU,OAAO,WAAW,MAEhC,CAELR,EAAM,YAAc,GACpBQ,EAAS,UAAU,IAAI,WAAW,EAElC,MAAMyC,EAAqB,OAAiI,mBACjI,OAAgF,wBAE3G,GAAI,CAACA,EAAmB,CACtBD,EAAM,MAAM,kCAAkC,EAC9ChD,EAAM,YAAc,GACpBQ,EAAS,UAAU,OAAO,WAAW,EACrC,MACF,CAEA,MAAM0C,EAAc,IAAID,EACxBC,EAAY,WAAa,GACzBA,EAAY,eAAiB,GAC7BA,EAAY,KAAO,QAEnBA,EAAY,SAAYjC,GAAkC,CACxD,MAAMkC,EAAa,MAAM,KAAKlC,EAAM,OAAO,EACxC,IAAImC,GAAUA,EAAO,CAAC,EAAE,UAAU,EAClC,KAAK,EAAE,EACV9C,EAAQ,MAAQ6C,EAChB7C,EAAQ,MAAM,OAAS,OACvBA,EAAQ,MAAM,OAAS,KAAK,IAAIA,EAAQ,aAAc,GAAG,EAAI,IAC/D,EAEA4C,EAAY,MAAQ,IAAM,CACxBlD,EAAM,YAAc,GACpBQ,EAAS,UAAU,OAAO,WAAW,CACvC,EAEA0C,EAAY,QAAWjC,GAAuC,CAC5D,QAAQ,MAAM,4BAA6BA,EAAM,KAAK,EACtDjB,EAAM,YAAc,GACpBQ,EAAS,UAAU,OAAO,WAAW,EACjCS,EAAM,QAAU,WAClB+B,EAAM,MAAM,0BAA0B,CAE1C,EAEAE,EAAY,MAAA,CACd,CACF,CAKA,SAAS/C,GAA4B,CACnC,MAAO,CAAC,EACL,OAAsD,mBACtD,OAA4D,wBAEjE,CAKA,eAAeiB,EAAgBnB,EAAuC,CACpE,GAAI,CACF,MAAMoD,EAAW,MAAMvB,EAAa,gBAAA,EAEpC,GAAIuB,EAAS,SAAW,EAAG,CACzBL,EAAM,KAAK,uBAAuB,EAClC,MACF,CAGAA,EAAM,KAAK,GAAGK,EAAS,MAAM,0BAA0B,CACzD,MAAQ,CACNL,EAAM,MAAM,6BAA6B,CAC3C,CACF,CAKA,SAAS1B,EAAYtB,EAA2B,CAE9C,MAAMsD,EAAQ,aAAa,QAAQ,iBAAiB,EACpD,GAAIA,EACF,GAAI,CACF,MAAMC,EAAO,KAAK,MAAMD,CAAK,EACzBC,EAAK,WAAaA,EAAK,WACzBvD,EAAM,UAAYuD,EAAK,UAG3B,MAAQ,CAER,CAEJ,CAKA,eAAevB,EACbhC,EACAkC,EACe,CACf,GAAI,CACF,MAAMJ,EAAa,gBAAgB,CACjC,WAAY9B,EAAM,UAClB,KAAMkC,EAAQ,KACd,QAASA,EAAQ,QACjB,SAAUA,EAAQ,SAAW,CAC3B,UAAWA,EAAQ,SAAS,UAC5B,gBAAiBA,EAAQ,SAAS,gBAClC,QAASA,EAAQ,SAAS,QAC1B,eAAgBA,EAAQ,SAAS,eACjC,iBAAkBA,EAAQ,SAAS,iBACnC,gBAAiBA,EAAQ,SAAS,UAClC,WAAYA,EAAQ,SAAS,UAAA,EAC3B,OACJ,UAAW,EAAA,CACZ,CACH,MAAQ,CAER,CACF,CAKA,SAASf,GAAyB,CAChC,MAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAYT,CAKA,SAASS,EAAe3B,EAA8B,CACpDA,EAAU,UAAYA,EAAU,YAClC,CAKA,SAASqC,EAAekB,EAAsB,CAC5C,OAAOpB,EAAWoB,CAAI,EACnB,QAAQ,iBAAkB,qBAAqB,EAC/C,QAAQ,aAAc,aAAa,EACnC,QAAQ,WAAY,iBAAiB,EACrC,QAAQ,MAAO,MAAM,CAC1B,CAKA,SAASpB,EAAWoB,EAAsB,CACxC,MAAMC,EAAM,SAAS,cAAc,KAAK,EACxC,OAAAA,EAAI,YAAcD,EACXC,EAAI,SACb"}