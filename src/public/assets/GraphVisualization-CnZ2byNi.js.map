{"version":3,"file":"GraphVisualization-CnZ2byNi.js","sources":["../../frontend/components/graph/GraphVisualization.ts"],"sourcesContent":["/**\n * GraphVisualization - SOTA vis-network component\n * \n * Features:\n * - Avatar nodes for Person entities\n * - Semantic zoom (avatar → initials → dot)\n * - Community coloring\n * - Rich hover cards\n * - Context menu\n * - Minimap\n * - Animated edges\n */\n\nimport { createElement, on } from '../../utils/dom';\nimport { graphService, GraphNode, GraphEdge } from '../../services/graph';\nimport { toast } from '../../services/toast';\n\nexport interface GraphVisualizationProps {\n  height?: number;\n  onNodeClick?: (node: GraphNode) => void;\n  onNodeDoubleClick?: (node: GraphNode) => void;\n  onEdgeClick?: (edge: GraphEdge) => void;\n  onSelectionChange?: (nodes: GraphNode[], edges: GraphEdge[]) => void;\n}\n\ninterface VisNetwork {\n  setData: (data: { nodes: unknown; edges: unknown }) => void;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  on: (event: string, callback: (params: any) => void) => void;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  off: (event: string, callback?: (params: any) => void) => void;\n  fit: (options?: { animation?: boolean }) => void;\n  focus: (nodeId: string, options?: { scale?: number; animation?: boolean }) => void;\n  getScale: () => number;\n  moveTo: (options: { position?: { x: number; y: number }; scale?: number; animation?: boolean }) => void;\n  getSelectedNodes: () => string[];\n  getSelectedEdges: () => string[];\n  selectNodes: (nodeIds: string[]) => void;\n  unselectAll: () => void;\n  destroy: () => void;\n  getPosition: (nodeId: string) => { x: number; y: number };\n  getViewPosition: () => { x: number; y: number };\n  redraw: () => void;\n}\n\ninterface VisDataSet<T> {\n  add: (data: T | T[]) => void;\n  update: (data: T | T[]) => void;\n  remove: (ids: string | string[]) => void;\n  get: (id?: string) => T | T[] | null;\n  clear: () => void;\n}\n\n// Type for vis.js library loaded via CDN\ninterface VisModule {\n  Network: new (container: HTMLElement, data: unknown, options: unknown) => VisNetwork;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  DataSet: new <T = any>(data?: T[]) => VisDataSet<T>;\n}\n\n// Helper to get vis module from window\nfunction getVis(): VisModule | undefined {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  return (window as any).vis as VisModule | undefined;\n}\n\nconst TYPE_COLORS: Record<string, string> = {\n  Person: '#6366f1',\n  Project: '#22c55e',\n  Document: '#8b5cf6',\n  Decision: '#06b6d4',\n  Risk: '#ef4444',\n  Question: '#f59e0b',\n  Fact: '#84cc16',\n  Meeting: '#ec4899',\n  Task: '#3b82f6',\n  Technology: '#f97316',\n  Organization: '#a855f7',\n  Client: '#14b8a6',\n  Email: '#e879f9',\n  Conversation: '#9333ea',\n  Answer: '#10b981',\n  Briefing: '#eab308',\n};\n\n/**\n * Create the graph visualization component\n */\nexport function createGraphVisualization(props: GraphVisualizationProps = {}): HTMLElement {\n  const { height = 600 } = props;\n\n  const container = createElement('div', { className: 'graph-visualization-container' });\n  \n  container.innerHTML = `\n    <div class=\"viz-toolbar\">\n      <div class=\"viz-toolbar-left\">\n        <button class=\"viz-btn\" id=\"viz-zoom-in\" title=\"Zoom In\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <circle cx=\"11\" cy=\"11\" r=\"8\"/>\n            <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\n            <line x1=\"11\" y1=\"8\" x2=\"11\" y2=\"14\"/>\n            <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\n          </svg>\n        </button>\n        <button class=\"viz-btn\" id=\"viz-zoom-out\" title=\"Zoom Out\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <circle cx=\"11\" cy=\"11\" r=\"8\"/>\n            <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\n            <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\n          </svg>\n        </button>\n        <button class=\"viz-btn\" id=\"viz-fit\" title=\"Fit to View\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <path d=\"M8 3H5a2 2 0 0 0-2 2v3\"/>\n            <path d=\"M21 8V5a2 2 0 0 0-2-2h-3\"/>\n            <path d=\"M3 16v3a2 2 0 0 0 2 2h3\"/>\n            <path d=\"M16 21h3a2 2 0 0 0 2-2v-3\"/>\n          </svg>\n        </button>\n        <div class=\"viz-divider\"></div>\n        <button class=\"viz-btn\" id=\"viz-physics\" title=\"Toggle Physics\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <circle cx=\"12\" cy=\"12\" r=\"3\"/>\n            <path d=\"M12 1v2\"/>\n            <path d=\"M12 21v2\"/>\n            <path d=\"M4.22 4.22l1.42 1.42\"/>\n            <path d=\"M18.36 18.36l1.42 1.42\"/>\n            <path d=\"M1 12h2\"/>\n            <path d=\"M21 12h2\"/>\n            <path d=\"M4.22 19.78l1.42-1.42\"/>\n            <path d=\"M18.36 5.64l1.42-1.42\"/>\n          </svg>\n        </button>\n      </div>\n      <div class=\"viz-toolbar-center\">\n        <span class=\"viz-status\" id=\"viz-status\">Loading...</span>\n      </div>\n      <div class=\"viz-toolbar-right\">\n        <button class=\"viz-btn\" id=\"viz-screenshot\" title=\"Screenshot\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\n            <circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/>\n            <polyline points=\"21 15 16 10 5 21\"/>\n          </svg>\n        </button>\n        <button class=\"viz-btn\" id=\"viz-minimap-toggle\" title=\"Toggle Minimap\">\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/>\n            <rect x=\"7\" y=\"7\" width=\"3\" height=\"3\"/>\n            <rect x=\"14\" y=\"7\" width=\"3\" height=\"3\"/>\n            <rect x=\"7\" y=\"14\" width=\"3\" height=\"3\"/>\n            <rect x=\"14\" y=\"14\" width=\"3\" height=\"3\"/>\n          </svg>\n        </button>\n      </div>\n    </div>\n    \n    <div class=\"viz-canvas-wrapper\">\n      <div class=\"viz-canvas\" id=\"viz-canvas\" style=\"height: ${height}px;\">\n        <div class=\"viz-loading\">\n          <div class=\"loading-spinner\"></div>\n          <p>Loading graph data...</p>\n        </div>\n      </div>\n      \n      <div class=\"viz-minimap hidden\" id=\"viz-minimap\">\n        <div class=\"minimap-viewport\" id=\"minimap-viewport\"></div>\n      </div>\n      \n      <div class=\"viz-legend\" id=\"viz-legend\">\n        <!-- Legend will be rendered here -->\n      </div>\n    </div>\n    \n    <div class=\"viz-hover-card hidden\" id=\"viz-hover-card\">\n      <!-- Hover card content -->\n    </div>\n    \n    <div class=\"viz-context-menu hidden\" id=\"viz-context-menu\">\n      <button class=\"context-menu-item\" data-action=\"expand\">\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n          <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"16\"/>\n          <line x1=\"8\" y1=\"12\" x2=\"16\" y2=\"12\"/>\n        </svg>\n        Expand Connections\n      </button>\n      <button class=\"context-menu-item\" data-action=\"focus\">\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <circle cx=\"12\" cy=\"12\" r=\"3\"/>\n          <path d=\"M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42\"/>\n        </svg>\n        Focus on Node\n      </button>\n      <button class=\"context-menu-item\" data-action=\"hide\">\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94\"/>\n          <line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"/>\n        </svg>\n        Hide Node\n      </button>\n      <div class=\"context-menu-divider\"></div>\n      <button class=\"context-menu-item\" data-action=\"bookmark\">\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"/>\n        </svg>\n        Bookmark\n      </button>\n      <button class=\"context-menu-item\" data-action=\"annotate\">\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"/>\n          <path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"/>\n        </svg>\n        Add Note\n      </button>\n      <div class=\"context-menu-divider\"></div>\n      <button class=\"context-menu-item\" data-action=\"ai-explain\">\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n          <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n          <path d=\"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3\"/>\n          <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\n        </svg>\n        AI Explain\n      </button>\n    </div>\n  `;\n\n  // Initialize visualization\n  initVisualization(container, props);\n\n  return container;\n}\n\n/**\n * Initialize the visualization\n */\nasync function initVisualization(container: HTMLElement, props: GraphVisualizationProps): Promise<void> {\n  const canvas = container.querySelector('#viz-canvas') as HTMLElement;\n  const statusEl = container.querySelector('#viz-status') as HTMLElement;\n\n  // Check if vis.js is available\n  if (!getVis()) {\n    // Try to load vis.js\n    await loadVisJs();\n  }\n\n  if (!getVis()) {\n    canvas.innerHTML = `\n      <div class=\"viz-error\">\n        <p>Graph visualization library not available</p>\n        <p class=\"text-muted\">Please ensure vis-network is loaded</p>\n      </div>\n    `;\n    return;\n  }\n\n  try {\n    // Load graph data\n    statusEl.textContent = 'Loading nodes...';\n    const data = await graphService.getVisualizationData({ limit: 500 });\n\n    if (data.nodes.length === 0) {\n      canvas.innerHTML = `\n        <div class=\"viz-empty\">\n          <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\" opacity=\"0.4\">\n            <circle cx=\"12\" cy=\"12\" r=\"3\"/>\n            <circle cx=\"4\" cy=\"6\" r=\"2\"/>\n            <circle cx=\"20\" cy=\"6\" r=\"2\"/>\n            <circle cx=\"4\" cy=\"18\" r=\"2\"/>\n            <circle cx=\"20\" cy=\"18\" r=\"2\"/>\n            <line x1=\"6\" y1=\"6\" x2=\"9.5\" y2=\"10\"/>\n            <line x1=\"18\" y1=\"6\" x2=\"14.5\" y2=\"10\"/>\n            <line x1=\"6\" y1=\"18\" x2=\"9.5\" y2=\"14\"/>\n            <line x1=\"18\" y1=\"18\" x2=\"14.5\" y2=\"14\"/>\n          </svg>\n          <h3>No graph data</h3>\n          <p>Process some documents to populate the knowledge graph, or sync existing data.</p>\n          <button class=\"btn btn-primary\" id=\"btn-sync-empty\">Sync Data</button>\n        </div>\n      `;\n      \n      const syncBtn = canvas.querySelector('#btn-sync-empty');\n      if (syncBtn) {\n        on(syncBtn as HTMLElement, 'click', async () => {\n          toast.info('Syncing data...');\n          await fetch('/api/graph/sync', { method: 'POST' });\n          toast.success('Sync complete. Reloading...');\n          initVisualization(container, props);\n        });\n      }\n      return;\n    }\n\n    statusEl.textContent = 'Rendering graph...';\n    canvas.innerHTML = '';\n\n    // Create vis.js network\n    const network = createNetwork(canvas, data.nodes, data.edges, props);\n\n    // Bind toolbar actions\n    bindToolbarActions(container, network);\n\n    // Render legend\n    renderLegend(container, data.nodes);\n\n    // Update status\n    statusEl.textContent = `${data.nodes.length} nodes • ${data.edges.length} edges`;\n\n  } catch (error) {\n    console.error('[GraphVisualization] Error:', error);\n    canvas.innerHTML = `\n      <div class=\"viz-error\">\n        <p>Failed to load graph data</p>\n        <button class=\"btn btn-sm\" onclick=\"location.reload()\">Retry</button>\n      </div>\n    `;\n  }\n}\n\n/**\n * Load vis.js dynamically\n */\nasync function loadVisJs(): Promise<void> {\n  return new Promise((resolve) => {\n    if (getVis()) {\n      resolve();\n      return;\n    }\n\n    const script = document.createElement('script');\n    script.src = 'https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js';\n    script.onload = () => resolve();\n    script.onerror = () => resolve();\n    document.head.appendChild(script);\n  });\n}\n\n/**\n * Create vis.js network\n */\nfunction createNetwork(\n  container: HTMLElement,\n  nodes: GraphNode[],\n  edges: GraphEdge[],\n  props: GraphVisualizationProps\n): VisNetwork {\n  // Deduplicate nodes by ID (keep first occurrence)\n  const seenNodeIds = new Set<string>();\n  const uniqueNodes = nodes.filter(node => {\n    if (seenNodeIds.has(node.id)) {\n      console.warn('[GraphVisualization] Skipping duplicate node:', node.id);\n      return false;\n    }\n    seenNodeIds.add(node.id);\n    return true;\n  });\n  \n  // Transform nodes for vis.js with avatar support\n  const visNodes = uniqueNodes.map(node => {\n    const props = (node.properties || {}) as Record<string, unknown>;\n    const avatarUrl = node.avatarUrl || node.photoUrl || \n      props.avatar_url || props.photo_url || props.avatarUrl || props.photoUrl;\n    \n    const isPerson = node.type === 'Person';\n    const color = TYPE_COLORS[node.type] || '#6b7280';\n    \n    // For Person nodes, prioritize name from properties; for others use label\n    const displayName = isPerson \n      ? (node.name || props.name || node.label || node.id)\n      : (node.name || node.label || props.title || props.content?.toString().substring(0, 30) || node.id);\n    const label = String(displayName);\n    const initials = getInitials(label);\n\n    return {\n      id: node.id,\n      label: label.length > 25 ? label.substring(0, 22) + '...' : label,\n      title: createTooltip(node),\n      color: {\n        background: color,\n        border: color,\n        highlight: {\n          background: adjustColor(color, 20),\n          border: adjustColor(color, -20),\n        },\n        hover: {\n          background: adjustColor(color, 10),\n          border: adjustColor(color, -10),\n        },\n      },\n      shape: isPerson && avatarUrl ? 'circularImage' : 'dot',\n      image: isPerson && avatarUrl ? avatarUrl : undefined,\n      size: getNodeSize(node),\n      font: {\n        size: 12,\n        color: getTextColor(),\n        face: 'Inter, -apple-system, system-ui, sans-serif',\n      },\n      borderWidth: 2,\n      borderWidthSelected: 4,\n      // Store original data\n      _data: node,\n    };\n  });\n\n  // Deduplicate edges by ID\n  const seenEdgeIds = new Set<string>();\n  const uniqueEdges = edges.filter(edge => {\n    const edgeId = edge.id || `${edge.source}-${edge.target}-${edge.type}`;\n    if (seenEdgeIds.has(edgeId)) {\n      return false;\n    }\n    seenEdgeIds.add(edgeId);\n    return true;\n  });\n  \n  // Transform edges for vis.js\n  const visEdges = uniqueEdges.map(edge => ({\n    id: edge.id,\n    from: edge.source,\n    to: edge.target,\n    label: edge.label,\n    title: `${edge.type}`,\n    color: {\n      color: 'rgba(156, 163, 175, 0.6)',\n      highlight: 'rgba(99, 102, 241, 0.8)',\n      hover: 'rgba(99, 102, 241, 0.6)',\n    },\n    arrows: {\n      to: {\n        enabled: true,\n        scaleFactor: 0.5,\n      },\n    },\n    font: {\n      size: 10,\n      color: 'rgba(156, 163, 175, 0.8)',\n      strokeWidth: 0,\n      align: 'middle',\n    },\n    smooth: {\n      type: 'continuous',\n      roundness: 0.5,\n    },\n    width: 1,\n    selectionWidth: 2,\n    _data: edge,\n  }));\n\n  const options = {\n    nodes: {\n      borderWidth: 2,\n      shadow: {\n        enabled: true,\n        color: 'rgba(0,0,0,0.1)',\n        size: 5,\n        x: 2,\n        y: 2,\n      },\n    },\n    edges: {\n      width: 1,\n      shadow: false,\n    },\n    physics: {\n      enabled: true,\n      stabilization: {\n        enabled: true,\n        iterations: 100,\n        updateInterval: 25,\n      },\n      barnesHut: {\n        gravitationalConstant: -3000,\n        centralGravity: 0.3,\n        springLength: 120,\n        springConstant: 0.04,\n        damping: 0.09,\n      },\n    },\n    interaction: {\n      hover: true,\n      tooltipDelay: 200,\n      hideEdgesOnDrag: true,\n      hideEdgesOnZoom: true,\n      multiselect: true,\n      navigationButtons: false,\n      keyboard: {\n        enabled: true,\n        bindToWindow: false,\n      },\n    },\n    layout: {\n      improvedLayout: true,\n      hierarchical: false,\n    },\n  };\n\n  const vis = getVis()!;\n  const network = new vis.Network(\n    container,\n    {\n      nodes: new vis.DataSet(visNodes),\n      edges: new vis.DataSet(visEdges),\n    },\n    options\n  );\n\n  // Bind events\n  network.on('click', (params: { nodes: string[]; edges: string[] }) => {\n    if (params.nodes.length > 0) {\n      const nodeId = params.nodes[0];\n      const node = nodes.find(n => n.id === nodeId);\n      if (node && props.onNodeClick) {\n        props.onNodeClick(node);\n      }\n    }\n    // Hide context menu\n    const contextMenu = container.closest('.graph-visualization-container')?.querySelector('#viz-context-menu');\n    if (contextMenu) contextMenu.classList.add('hidden');\n  });\n\n  network.on('doubleClick', (params: { nodes: string[] }) => {\n    if (params.nodes.length > 0) {\n      const nodeId = params.nodes[0];\n      const node = nodes.find(n => n.id === nodeId);\n      if (node && props.onNodeDoubleClick) {\n        props.onNodeDoubleClick(node);\n      }\n    }\n  });\n\n  network.on('oncontext', (params: { nodes: string[]; pointer: { DOM: { x: number; y: number } }; event: Event }) => {\n    params.event.preventDefault();\n    if (params.nodes.length > 0) {\n      showContextMenu(container, params.pointer.DOM.x, params.pointer.DOM.y, params.nodes[0], nodes);\n    }\n  });\n\n  network.on('hoverNode', (params: { node: string }) => {\n    const node = nodes.find(n => n.id === params.node);\n    if (node) {\n      showHoverCard(container, node);\n    }\n  });\n\n  network.on('blurNode', () => {\n    hideHoverCard(container);\n  });\n\n  network.on('stabilizationProgress', (params: { iterations: number; total: number }) => {\n    const status = container.closest('.graph-visualization-container')?.querySelector('#viz-status');\n    if (status) {\n      const progress = Math.round((params.iterations / params.total) * 100);\n      status.textContent = `Stabilizing... ${progress}%`;\n    }\n  });\n\n  network.on('stabilizationIterationsDone', () => {\n    const status = container.closest('.graph-visualization-container')?.querySelector('#viz-status');\n    if (status) {\n      status.textContent = `${nodes.length} nodes • ${edges.length} edges`;\n    }\n  });\n\n  return network;\n}\n\n/**\n * Bind toolbar actions\n */\nfunction bindToolbarActions(container: HTMLElement, network: VisNetwork): void {\n  const btnZoomIn = container.querySelector('#viz-zoom-in');\n  const btnZoomOut = container.querySelector('#viz-zoom-out');\n  const btnFit = container.querySelector('#viz-fit');\n  const btnPhysics = container.querySelector('#viz-physics');\n  const btnScreenshot = container.querySelector('#viz-screenshot');\n  const btnMinimap = container.querySelector('#viz-minimap-toggle');\n\n  let physicsEnabled = true;\n\n  if (btnZoomIn) {\n    on(btnZoomIn as HTMLElement, 'click', () => {\n      const scale = network.getScale();\n      network.moveTo({ scale: scale * 1.3, animation: true });\n    });\n  }\n\n  if (btnZoomOut) {\n    on(btnZoomOut as HTMLElement, 'click', () => {\n      const scale = network.getScale();\n      network.moveTo({ scale: scale / 1.3, animation: true });\n    });\n  }\n\n  if (btnFit) {\n    on(btnFit as HTMLElement, 'click', () => {\n      network.fit({ animation: true });\n    });\n  }\n\n  if (btnPhysics) {\n    on(btnPhysics as HTMLElement, 'click', () => {\n      physicsEnabled = !physicsEnabled;\n      // Note: vis.js doesn't have a simple toggle, would need to recreate network\n      btnPhysics.classList.toggle('active', physicsEnabled);\n      toast.info(physicsEnabled ? 'Physics enabled' : 'Physics disabled');\n    });\n  }\n\n  if (btnScreenshot) {\n    on(btnScreenshot as HTMLElement, 'click', () => {\n      const canvas = container.querySelector('canvas');\n      if (canvas) {\n        const link = document.createElement('a');\n        link.download = `graph-${Date.now()}.png`;\n        link.href = canvas.toDataURL('image/png');\n        link.click();\n        toast.success('Screenshot saved');\n      }\n    });\n  }\n\n  if (btnMinimap) {\n    on(btnMinimap as HTMLElement, 'click', () => {\n      const minimap = container.querySelector('#viz-minimap');\n      if (minimap) {\n        minimap.classList.toggle('hidden');\n        btnMinimap.classList.toggle('active');\n      }\n    });\n  }\n}\n\n/**\n * Show context menu\n */\nfunction showContextMenu(\n  container: HTMLElement,\n  x: number,\n  y: number,\n  nodeId: string,\n  nodes: GraphNode[]\n): void {\n  const menu = container.closest('.graph-visualization-container')?.querySelector('#viz-context-menu') as HTMLElement;\n  if (!menu) return;\n\n  menu.style.left = `${x}px`;\n  menu.style.top = `${y}px`;\n  menu.classList.remove('hidden');\n  menu.setAttribute('data-node-id', nodeId);\n\n  // Bind menu actions\n  const items = menu.querySelectorAll('.context-menu-item');\n  items.forEach(item => {\n    const newItem = item.cloneNode(true) as HTMLElement;\n    item.parentNode?.replaceChild(newItem, item);\n    \n    on(newItem, 'click', () => {\n      const action = newItem.getAttribute('data-action');\n      const node = nodes.find(n => n.id === nodeId);\n      handleContextAction(action || '', node, container);\n      menu.classList.add('hidden');\n    });\n  });\n\n  // Close on outside click\n  setTimeout(() => {\n    const closeHandler = (e: Event) => {\n      if (!menu.contains(e.target as Node)) {\n        menu.classList.add('hidden');\n        document.removeEventListener('click', closeHandler);\n      }\n    };\n    document.addEventListener('click', closeHandler);\n  }, 100);\n}\n\n/**\n * Handle context menu action\n */\nasync function handleContextAction(action: string, node: GraphNode | undefined, container: HTMLElement): Promise<void> {\n  if (!node) return;\n\n  switch (action) {\n    case 'expand':\n      toast.info(`Expanding connections for ${node.label || node.name}`);\n      // TODO: Load and add connected nodes\n      break;\n    case 'focus':\n      toast.info(`Focusing on ${node.label || node.name}`);\n      // TODO: Center and zoom to node\n      break;\n    case 'hide':\n      toast.info(`Hiding ${node.label || node.name}`);\n      // TODO: Remove node from visualization\n      break;\n    case 'bookmark':\n      await graphService.addBookmark({\n        node_id: node.id,\n        node_type: node.type,\n        node_label: node.label || node.name || node.id,\n        node_avatar_url: node.avatarUrl || node.photoUrl,\n        sort_order: 0,\n      });\n      toast.success('Bookmark added');\n      break;\n    case 'annotate':\n      const note = prompt('Add a note for this node:');\n      if (note) {\n        await graphService.createAnnotation({\n          target_type: 'node',\n          target_id: node.id,\n          target_label: node.label || node.name,\n          content: note,\n          annotation_type: 'note',\n          is_shared: false,\n          is_resolved: false,\n        });\n        toast.success('Note added');\n      }\n      break;\n    case 'ai-explain':\n      toast.info('Generating AI explanation...');\n      // TODO: Call AI explain endpoint\n      break;\n  }\n}\n\n/**\n * Show hover card\n */\nfunction showHoverCard(container: HTMLElement, node: GraphNode): void {\n  const card = container.closest('.graph-visualization-container')?.querySelector('#viz-hover-card') as HTMLElement;\n  if (!card) return;\n\n  const avatarUrl = node.avatarUrl || node.photoUrl || \n    (node.properties as Record<string, unknown>)?.avatar_url || \n    (node.properties as Record<string, unknown>)?.photo_url;\n  const role = node.role || (node.properties as Record<string, unknown>)?.role;\n  const org = node.organization || (node.properties as Record<string, unknown>)?.organization;\n\n  card.innerHTML = `\n    <div class=\"hover-card-content\">\n      ${avatarUrl \n        ? `<img class=\"hover-avatar\" src=\"${avatarUrl}\" alt=\"\" onerror=\"this.style.display='none'\">`\n        : `<div class=\"hover-avatar hover-avatar-placeholder\" style=\"background: ${TYPE_COLORS[node.type] || '#6b7280'}\">${getInitials(node.label || node.name || '?')}</div>`\n      }\n      <div class=\"hover-info\">\n        <div class=\"hover-name\">${escapeHtml(node.label || node.name || node.id)}</div>\n        <div class=\"hover-type\" style=\"color: ${TYPE_COLORS[node.type] || '#6b7280'}\">${node.type}</div>\n        ${role ? `<div class=\"hover-role\">${escapeHtml(String(role))}</div>` : ''}\n        ${org ? `<div class=\"hover-org\">@ ${escapeHtml(String(org))}</div>` : ''}\n      </div>\n      ${node.connections ? `<div class=\"hover-stat\">${node.connections} connections</div>` : ''}\n    </div>\n  `;\n\n  card.classList.remove('hidden');\n}\n\n/**\n * Hide hover card\n */\nfunction hideHoverCard(container: HTMLElement): void {\n  const card = container.closest('.graph-visualization-container')?.querySelector('#viz-hover-card');\n  if (card) {\n    card.classList.add('hidden');\n  }\n}\n\n/**\n * Render legend\n */\nfunction renderLegend(container: HTMLElement, nodes: GraphNode[]): void {\n  const legend = container.querySelector('#viz-legend');\n  if (!legend) return;\n\n  // Count by type\n  const typeCounts: Record<string, number> = {};\n  nodes.forEach(node => {\n    typeCounts[node.type] = (typeCounts[node.type] || 0) + 1;\n  });\n\n  const sortedTypes = Object.entries(typeCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 8);\n\n  legend.innerHTML = `\n    <div class=\"legend-title\">Entity Types</div>\n    <div class=\"legend-items\">\n      ${sortedTypes.map(([type, count]) => `\n        <div class=\"legend-item\">\n          <span class=\"legend-color\" style=\"background: ${TYPE_COLORS[type] || '#6b7280'}\"></span>\n          <span class=\"legend-label\">${type}</span>\n          <span class=\"legend-count\">${count}</span>\n        </div>\n      `).join('')}\n    </div>\n  `;\n}\n\n/**\n * Create tooltip content (plain text - vis.js escapes HTML)\n */\nfunction createTooltip(node: GraphNode): string {\n  const props = (node.properties || {}) as Record<string, unknown>;\n  const name = node.name || props.name || node.label || node.id;\n  const role = node.role || props.role;\n  const org = node.organization || props.organization;\n  const content = props.content ? String(props.content).substring(0, 100) : null;\n  \n  const lines: string[] = [];\n  lines.push(String(name));\n  lines.push(`[${node.type}]`);\n  if (role) lines.push(String(role));\n  if (org) lines.push(`@ ${org}`);\n  if (content && node.type !== 'Person') lines.push(`\"${content}...\"`);\n  \n  return lines.join('\\n');\n}\n\n/**\n * Get node size based on connections\n */\nfunction getNodeSize(node: GraphNode): number {\n  const connections = node.connections || 1;\n  return Math.min(15 + connections * 2, 40);\n}\n\n/**\n * Get initials from name\n */\nfunction getInitials(name: string): string {\n  return name\n    .split(' ')\n    .map(part => part.charAt(0))\n    .join('')\n    .substring(0, 2)\n    .toUpperCase();\n}\n\n/**\n * Adjust color brightness\n */\nfunction adjustColor(color: string, amount: number): string {\n  const hex = color.replace('#', '');\n  const r = Math.max(0, Math.min(255, parseInt(hex.substring(0, 2), 16) + amount));\n  const g = Math.max(0, Math.min(255, parseInt(hex.substring(2, 4), 16) + amount));\n  const b = Math.max(0, Math.min(255, parseInt(hex.substring(4, 6), 16) + amount));\n  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;\n}\n\n/**\n * Get text color based on theme\n */\nfunction getTextColor(): string {\n  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';\n  return isDark ? '#e5e7eb' : '#374151';\n}\n\n/**\n * Escape HTML\n */\nfunction escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\nexport default createGraphVisualization;\n"],"names":["getVis","TYPE_COLORS","createGraphVisualization","props","height","container","createElement","initVisualization","canvas","statusEl","loadVisJs","data","graphService","syncBtn","on","toast","network","createNetwork","bindToolbarActions","renderLegend","error","resolve","script","nodes","edges","seenNodeIds","visNodes","node","avatarUrl","isPerson","color","displayName","label","getInitials","createTooltip","adjustColor","getNodeSize","getTextColor","seenEdgeIds","visEdges","edge","edgeId","options","vis","params","nodeId","n","contextMenu","showContextMenu","showHoverCard","hideHoverCard","status","progress","btnZoomIn","btnZoomOut","btnFit","btnPhysics","btnScreenshot","btnMinimap","physicsEnabled","scale","link","minimap","x","y","menu","item","newItem","action","handleContextAction","closeHandler","e","note","card","role","org","escapeHtml","legend","typeCounts","sortedTypes","a","b","type","count","name","content","lines","connections","part","amount","hex","r","g","text","div"],"mappings":"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"}