{"version":3,"file":"ChatPage-C-kldbdp.js","sources":["../../frontend/src/components/ui/ContactSelect.tsx","../../frontend/src/pages/ChatPage.tsx"],"sourcesContent":["/**\r\n * ContactSelect — custom dropdown for selecting contacts with rich badges.\r\n * Shows avatar, name, role, and organization for each contact.\r\n * Replaces native <select> wherever contacts need to be picked.\r\n */\r\nimport { useState, useRef, useEffect, useCallback } from 'react';\r\nimport { ChevronDown, X, Search } from 'lucide-react';\r\nimport { cn, getInitials, resolveAvatarUrl } from '../../lib/utils';\r\nimport type { Contact } from '../../types/godmode';\r\n\r\ninterface ContactSelectProps {\r\n  contacts: Contact[];\r\n  value: string | null;\r\n  onChange: (contactId: string | null) => void;\r\n  placeholder?: string;\r\n  className?: string;\r\n  compact?: boolean;\r\n}\r\n\r\nfunction ContactBadge({ contact, compact }: { contact: Contact; compact?: boolean }) {\r\n  const avatar = resolveAvatarUrl(contact as any);\r\n  return (\r\n    <div className={cn('flex items-center gap-2 min-w-0', compact ? 'py-0' : 'py-0.5')}>\r\n      {avatar ? (\r\n        <img src={avatar} alt=\"\" className={cn('rounded-full object-cover shrink-0 bg-secondary', compact ? 'w-5 h-5' : 'w-7 h-7')} />\r\n      ) : (\r\n        <div className={cn(\r\n          'rounded-full bg-primary/10 text-primary font-bold flex items-center justify-center shrink-0',\r\n          compact ? 'w-5 h-5 text-[8px]' : 'w-7 h-7 text-[10px]'\r\n        )}>\r\n          {getInitials(contact.name || '?')}\r\n        </div>\r\n      )}\r\n      <div className=\"min-w-0 flex-1\">\r\n        <span className={cn('font-medium text-foreground block truncate', compact ? 'text-[11px]' : 'text-xs')}>\r\n          {contact.name}\r\n        </span>\r\n        {!compact && (contact.role || contact.organization) && (\r\n          <span className=\"text-[10px] text-muted-foreground block truncate\">\r\n            {[contact.role, contact.organization].filter(Boolean).join(' · ')}\r\n          </span>\r\n        )}\r\n      </div>\r\n      {contact.role && compact && (\r\n        <span className=\"text-[9px] px-1.5 py-0.5 rounded-full bg-secondary text-muted-foreground shrink-0\">{contact.role}</span>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport function ContactSelect({ contacts, value, onChange, placeholder = 'No context', className, compact }: ContactSelectProps) {\r\n  const [open, setOpen] = useState(false);\r\n  const [search, setSearch] = useState('');\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const searchRef = useRef<HTMLInputElement>(null);\r\n\r\n  const selected = contacts.find(c => c.id === value) ?? null;\r\n\r\n  const filtered = search.trim()\r\n    ? contacts.filter(c => {\r\n        const q = search.toLowerCase();\r\n        return c.name?.toLowerCase().includes(q)\r\n          || c.role?.toLowerCase().includes(q)\r\n          || c.organization?.toLowerCase().includes(q)\r\n          || c.email?.toLowerCase().includes(q);\r\n      })\r\n    : contacts;\r\n\r\n  // Close on outside click\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    const handler = (e: MouseEvent) => {\r\n      if (containerRef.current && !containerRef.current.contains(e.target as Node)) {\r\n        setOpen(false);\r\n        setSearch('');\r\n      }\r\n    };\r\n    document.addEventListener('mousedown', handler);\r\n    return () => document.removeEventListener('mousedown', handler);\r\n  }, [open]);\r\n\r\n  // Focus search on open\r\n  useEffect(() => {\r\n    if (open && searchRef.current) searchRef.current.focus();\r\n  }, [open]);\r\n\r\n  const handleSelect = useCallback((id: string | null) => {\r\n    onChange(id);\r\n    setOpen(false);\r\n    setSearch('');\r\n  }, [onChange]);\r\n\r\n  return (\r\n    <div ref={containerRef} className={cn('relative', className)}>\r\n      {/* Trigger */}\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => setOpen(!open)}\r\n        className={cn(\r\n          'w-full flex items-center gap-2 rounded-lg border border-border bg-card px-2.5 text-left transition-colors hover:bg-secondary/50 focus:outline-none focus:ring-2 focus:ring-ring',\r\n          compact ? 'py-1' : 'py-1.5'\r\n        )}\r\n      >\r\n        {selected ? (\r\n          <div className=\"flex-1 min-w-0\">\r\n            <ContactBadge contact={selected} compact={compact} />\r\n          </div>\r\n        ) : (\r\n          <span className={cn('flex-1 text-muted-foreground', compact ? 'text-[11px]' : 'text-xs')}>\r\n            {placeholder}\r\n          </span>\r\n        )}\r\n        {selected && (\r\n          <button\r\n            type=\"button\"\r\n            onClick={(e) => { e.stopPropagation(); handleSelect(null); }}\r\n            className=\"p-0.5 rounded hover:bg-secondary text-muted-foreground hover:text-foreground shrink-0\"\r\n          >\r\n            <X className=\"w-3 h-3\" />\r\n          </button>\r\n        )}\r\n        <ChevronDown className={cn('w-3 h-3 text-muted-foreground shrink-0 transition-transform', open && 'rotate-180')} />\r\n      </button>\r\n\r\n      {/* Dropdown */}\r\n      {open && (\r\n        <div className=\"absolute z-50 top-full left-0 right-0 mt-1 rounded-lg border border-border bg-popover shadow-lg overflow-hidden animate-in fade-in-0 zoom-in-95 duration-100\">\r\n          {/* Search */}\r\n          {contacts.length > 5 && (\r\n            <div className=\"flex items-center gap-2 px-2.5 py-2 border-b border-border\">\r\n              <Search className=\"w-3 h-3 text-muted-foreground shrink-0\" />\r\n              <input\r\n                ref={searchRef}\r\n                type=\"text\"\r\n                value={search}\r\n                onChange={e => setSearch(e.target.value)}\r\n                placeholder=\"Search contacts...\"\r\n                className=\"flex-1 bg-transparent text-xs text-foreground placeholder:text-muted-foreground focus:outline-none\"\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {/* \"No context\" option */}\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => handleSelect(null)}\r\n            className={cn(\r\n              'w-full text-left px-3 py-2 text-xs text-muted-foreground hover:bg-secondary/50 transition-colors border-b border-border/50',\r\n              !value && 'bg-primary/5 text-primary font-medium'\r\n            )}\r\n          >\r\n            {placeholder}\r\n          </button>\r\n\r\n          {/* Contact list */}\r\n          <div className=\"max-h-[240px] overflow-y-auto scrollbar-thin\">\r\n            {filtered.length === 0 ? (\r\n              <p className=\"text-xs text-muted-foreground text-center py-4\">No contacts found</p>\r\n            ) : (\r\n              filtered.map(c => (\r\n                <button\r\n                  key={c.id}\r\n                  type=\"button\"\r\n                  onClick={() => handleSelect(c.id)}\r\n                  className={cn(\r\n                    'w-full text-left px-3 py-2 hover:bg-secondary/50 transition-colors',\r\n                    c.id === value && 'bg-primary/5'\r\n                  )}\r\n                >\r\n                  <ContactBadge contact={c} />\r\n                </button>\r\n              ))\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","/**\n * Purpose:\n *   Multi-mode conversational interface with session management, RAG-powered\n *   knowledge search, SOT chat, daily briefing, and contact-context support.\n *\n * Key features ported from the original GODMODE CSS chat:\n *   - Sessions sidebar: list, create, switch conversations (persisted server-side)\n *   - Contact context (\"Como quem?\"): chat in the perspective of a contact\n *   - Quick prompt chips for common queries\n *   - RAG metadata badges: confidence, query type, RAG method, sources count\n *   - Contact pills on sources with avatar placeholders\n *   - Collapsible detailed sources with relevance scores\n *   - Auto-resize textarea input\n *   - Three chat modes: RAG Chat, SOT Chat, Briefing\n */\nimport { useState, useRef, useEffect, useCallback, useMemo } from 'react';\nimport {\n  Send, Trash2, Info, MessageCircle, Shield, FileBarChart,\n  RotateCw, Loader2, Plus, ChevronRight, User as UserIcon,\n} from 'lucide-react';\nimport { toast } from 'sonner';\nimport {\n  useSendChatMessage, useSotChat, useBriefing,\n  useChatSessions, useCreateChatSession, useUpdateChatSession, useChatMessages,\n  useContacts,\n  type ChatSource, type ChatRAGInfo, type ChatResponse, type ChatSession,\n} from '../hooks/useGodMode';\nimport { cn } from '../lib/utils';\nimport { ContactSelect } from '../components/ui/ContactSelect';\nimport type { Contact } from '../types/godmode';\n\nconst CARD = 'rounded-xl border border-[var(--gm-border-primary)] bg-[var(--gm-surface-primary)] shadow-[var(--shadow-sm)] transition-all duration-200';\nconst INPUT = 'w-full bg-[var(--gm-bg-tertiary)] border border-[var(--gm-border-primary)] rounded-lg px-3 py-2 text-sm text-[var(--gm-text-primary)] placeholder:text-[var(--gm-text-placeholder)] focus:outline-none focus:border-[var(--gm-border-focus)] focus:shadow-[var(--shadow-focus)] transition-all duration-150';\nconst BTN_PRIMARY = 'inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-[var(--gm-interactive-primary)] text-[var(--gm-text-on-brand)] hover:bg-[var(--gm-interactive-primary-hover)] shadow-sm transition-all duration-150 disabled:opacity-50';\nconst BTN_SECONDARY = 'inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-[var(--gm-interactive-secondary)] text-[var(--gm-text-primary)] hover:bg-[var(--gm-interactive-secondary-hover)] border border-[var(--gm-border-primary)] transition-all duration-150';\n\ntype ChatMode = 'rag' | 'sot' | 'briefing';\n\ninterface LocalMessage {\n  id: string;\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n  timestamp: string;\n  sources?: ChatSource[];\n  contextQuality?: string;\n  confidence?: string;\n  queryType?: string;\n  rag?: ChatRAGInfo;\n}\n\nconst QUICK_PROMPTS = [\n  'Summarize key risks',\n  'List open questions',\n  'What actions are overdue?',\n  'Who are the key contacts?',\n];\n\nfunction formatRelativeTime(dateStr: string): string {\n  if (!dateStr) return '—';\n  const ts = new Date(dateStr).getTime();\n  if (isNaN(ts)) return '—';\n  const diff = Date.now() - ts;\n  const mins = Math.floor(diff / 60_000);\n  if (mins < 1) return 'just now';\n  if (mins < 60) return `${mins}m ago`;\n  const hrs = Math.floor(mins / 60);\n  if (hrs < 24) return `${hrs}h ago`;\n  const days = Math.floor(hrs / 24);\n  return `${days}d ago`;\n}\n\n// ── RAG Badge ────────────────────────────────────────────────────────────────\n\nfunction RagBadges({ msg }: { msg: LocalMessage }) {\n  if (msg.role !== 'assistant') return null;\n  const badges: Array<{ label: string; cls: string; title: string }> = [];\n\n  if (msg.confidence) {\n    const cls = msg.confidence === 'high' ? 'bg-emerald-500/15 text-emerald-400'\n      : msg.confidence === 'medium' ? 'bg-amber-500/15 text-amber-400'\n        : 'bg-red-500/15 text-red-400';\n    badges.push({ label: msg.confidence, cls, title: 'Confidence' });\n  }\n  if (msg.queryType) {\n    badges.push({ label: msg.queryType, cls: 'bg-indigo-500/15 text-indigo-400', title: 'Query type' });\n  }\n  if (msg.rag) {\n    const method = msg.rag.usedHyDE ? 'HyDE+RRF'\n      : msg.rag.graphResults > 0 ? 'Graph+Vector' : 'Hybrid';\n    badges.push({ label: method, cls: 'bg-purple-500/15 text-purple-400', title: `RAG: ${msg.rag.method ?? method}` });\n    const total = msg.rag.fusedResults || (msg.rag.vectorResults + msg.rag.graphResults);\n    if (total > 0) {\n      badges.push({ label: `${total} sources`, cls: 'bg-sky-500/15 text-sky-400', title: 'Sources found' });\n    }\n  }\n\n  if (badges.length === 0) return null;\n  return (\n    <div className=\"flex flex-wrap gap-1.5 mt-2 pt-2 border-t border-white/10\">\n      {badges.map((b, i) => (\n        <span key={i} title={b.title} className={cn('text-[10px] font-semibold uppercase tracking-wide px-2 py-0.5 rounded-full', b.cls)}>\n          {b.label}\n        </span>\n      ))}\n    </div>\n  );\n}\n\n// ── Contact Pill ─────────────────────────────────────────────────────────────\n\nfunction ContactPills({ sources }: { sources: ChatSource[] }) {\n  const contactSources = sources.filter(s => s.contactName);\n  if (contactSources.length === 0) return null;\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-2\">\n      {contactSources.map((s, i) => (\n        <div key={i} className=\"inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/20 text-xs\">\n          <div className=\"w-6 h-6 rounded-full bg-purple-500/30 text-purple-400 flex items-center justify-center text-[10px] font-bold shrink-0\">\n            {(s.contactName || '?')[0]}\n          </div>\n          <div className=\"min-w-0\">\n            <span className=\"font-semibold text-purple-300 block truncate\">{s.contactName}</span>\n            {s.contactRole && <span className=\"text-[10px] text-purple-400/70\">{s.contactRole}</span>}\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n\n// ── Collapsible Sources ──────────────────────────────────────────────────────\n\nfunction CollapsibleSources({ sources }: { sources: ChatSource[] }) {\n  const [open, setOpen] = useState(false);\n  const nonContact = sources.filter(s => !s.contactName);\n  if (nonContact.length === 0) return null;\n  const top5 = nonContact.slice(0, 5);\n  return (\n    <div className=\"mt-2 text-xs\">\n      <button onClick={() => setOpen(!open)} className=\"flex items-center gap-1 text-[var(--gm-text-tertiary)] hover:text-[var(--gm-text-primary)] transition-colors\">\n        <ChevronRight className={cn('w-3 h-3 transition-transform', open && 'rotate-90')} />\n        {sources.length} sources used\n      </button>\n      {open && (\n        <div className=\"mt-1.5 p-2 rounded-lg bg-[var(--gm-bg-tertiary)] space-y-1\">\n          {top5.map((s, i) => (\n            <div key={i} className=\"flex items-center gap-2\">\n              <span className=\"px-1.5 py-0.5 rounded bg-[var(--gm-bg-tertiary)] text-[var(--gm-text-tertiary)] capitalize text-[10px] font-medium\">{s.type || 'unknown'}</span>\n              <span className=\"text-[var(--gm-accent-primary)] font-semibold text-[10px] min-w-[30px]\">\n                {Math.round((s.rrfScore ?? s.score ?? 0) * 100)}%\n              </span>\n              {s.sourceCount && s.sourceCount > 1 && (\n                <span className=\"text-[9px] px-1 rounded bg-purple-500/20 text-purple-400 font-semibold\">x{s.sourceCount}</span>\n              )}\n              {s.source && <span className=\"ml-auto text-[var(--gm-text-tertiary)] text-[9px] truncate max-w-[120px]\">{s.source}</span>}\n            </div>\n          ))}\n          {nonContact.length > 5 && <div className=\"text-[var(--gm-text-tertiary)] text-[10px] text-center pt-1 border-t border-[var(--gm-border-primary)]\">+{nonContact.length - 5} more</div>}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ── Sessions Sidebar ─────────────────────────────────────────────────────────\n\nfunction SessionsSidebar({\n  sessions, currentId, onSelect, onCreate, contacts, onContextChange,\n}: {\n  sessions: ChatSession[];\n  currentId: string | null;\n  onSelect: (id: string) => void;\n  onCreate: (contextContactId?: string | null) => void;\n  contacts: Contact[];\n  onContextChange: (contactId: string | null) => void;\n}) {\n  const [newCtx, setNewCtx] = useState('');\n  const currentSession = sessions.find(s => s.id === currentId);\n\n  return (\n    <div className=\"w-60 min-w-[200px] border-r border-[var(--gm-border-primary)] bg-[var(--gm-bg-tertiary)] flex flex-col overflow-hidden shrink-0\">\n      <button\n        onClick={() => onCreate(newCtx || null)}\n        className={cn(BTN_PRIMARY, 'm-2 px-3 py-2 text-sm')}\n      >\n        <Plus className=\"w-4 h-4\" /> New Conversation\n      </button>\n\n      {/* Context selector for new chat */}\n      {contacts.length > 0 && (\n        <div className=\"px-3 pb-2 space-y-1\">\n          <span className=\"text-[10px] text-[var(--gm-text-tertiary)]\">As who?</span>\n          <ContactSelect\n            contacts={contacts}\n            value={newCtx || null}\n            onChange={id => setNewCtx(id ?? '')}\n            placeholder=\"No context\"\n            compact\n          />\n        </div>\n      )}\n\n      {/* Active session context */}\n      {currentSession && contacts.length > 0 && (\n        <div className=\"px-3 pb-2 pt-1 border-t border-[var(--gm-border-primary)] space-y-1\">\n          <span className=\"text-[10px] text-[var(--gm-text-tertiary)]\">Session context</span>\n          <ContactSelect\n            contacts={contacts}\n            value={currentSession.context_contact_id ?? null}\n            onChange={onContextChange}\n            placeholder=\"No context\"\n            compact\n          />\n        </div>\n      )}\n\n      {/* Sessions list */}\n      <div className=\"flex-1 overflow-y-auto p-2 space-y-0.5\">\n        {sessions.map(s => (\n          <button\n            key={s.id}\n            onClick={() => onSelect(s.id)}\n            className={cn(\n              'w-full text-left flex flex-col gap-0.5 px-3 py-2 rounded-lg text-xs transition-colors',\n              s.id === currentId\n                ? 'bg-[var(--gm-interactive-primary)]/15 text-[var(--gm-accent-primary)] font-medium'\n                : 'text-[var(--gm-text-tertiary)] hover:bg-[var(--gm-surface-hover)] hover:text-[var(--gm-text-primary)]'\n            )}\n          >\n            <span className=\"truncate\">{(s.title || 'Untitled').length > 40 ? (s.title || 'Untitled').substring(0, 37) + '...' : (s.title || 'Untitled')}</span>\n            <span className=\"text-[10px] opacity-60\">{formatRelativeTime(s.updated_at)}</span>\n          </button>\n        ))}\n        {sessions.length === 0 && (\n          <p className=\"text-xs text-[var(--gm-text-tertiary)] text-center py-4\">No conversations yet</p>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// ── Main ChatPage ────────────────────────────────────────────────────────────\n\nexport default function ChatPage() {\n  const [mode, setMode] = useState<ChatMode>('rag');\n  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);\n  const [localMessages, setLocalMessages] = useState<LocalMessage[]>([]);\n  const [input, setInput] = useState('');\n  const [refreshBriefing, setRefreshBriefing] = useState(false);\n  const bottomRef = useRef<HTMLDivElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const sendRagMessage = useSendChatMessage();\n  const sendSotMessage = useSotChat();\n  const briefing = useBriefing(refreshBriefing);\n  const { data: sessionsData, refetch: refetchSessions } = useChatSessions();\n  const createSession = useCreateChatSession();\n  const updateSession = useUpdateChatSession();\n  const { data: contactsData } = useContacts();\n  const { data: serverMessages } = useChatMessages(currentSessionId);\n\n  const sessions = (sessionsData as { sessions?: ChatSession[] })?.sessions ?? [];\n  const contacts = useMemo(() => {\n    if (!contactsData) return [];\n    const raw = (contactsData as { contacts?: Contact[] })?.contacts ?? (contactsData as Contact[]);\n    return Array.isArray(raw) ? raw : [];\n  }, [contactsData]);\n\n  const isPending = sendRagMessage.isPending || sendSotMessage.isPending;\n\n  // When switching session, load messages from server\n  useEffect(() => {\n    if (!serverMessages) return;\n    const msgs = (serverMessages as { messages?: Array<Record<string, unknown>> })?.messages ?? [];\n    setLocalMessages(msgs.map((m: Record<string, unknown>) => ({\n      id: m.id as string,\n      role: m.role as 'user' | 'assistant',\n      content: m.content as string,\n      timestamp: m.created_at as string,\n      sources: m.sources as ChatSource[] | undefined,\n      confidence: (m.metadata as Record<string, unknown>)?.confidence as string | undefined,\n      queryType: (m.metadata as Record<string, unknown>)?.queryType as string | undefined,\n      rag: (m.metadata as Record<string, unknown>)?.rag as ChatRAGInfo | undefined,\n      contextQuality: (m.metadata as Record<string, unknown>)?.contextQuality as string | undefined,\n    })));\n  }, [serverMessages]);\n\n  // Auto-scroll\n  useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [localMessages]);\n\n  // Auto-resize textarea\n  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setInput(e.target.value);\n    const el = e.target;\n    el.style.height = 'auto';\n    el.style.height = Math.min(el.scrollHeight, 120) + 'px';\n  }, []);\n\n  // Select a session\n  const handleSelectSession = useCallback((id: string) => {\n    setCurrentSessionId(id);\n  }, []);\n\n  // Create new session\n  const handleCreateSession = useCallback((contextContactId?: string | null) => {\n    createSession.mutate({ title: 'New conversation', contextContactId: contextContactId ?? null }, {\n      onSuccess: (data: unknown) => {\n        const session = (data as { session?: ChatSession })?.session;\n        if (session) {\n          setCurrentSessionId(session.id);\n          setLocalMessages([]);\n          refetchSessions();\n        }\n      },\n    });\n  }, [createSession, refetchSessions]);\n\n  // Update session context\n  const handleContextChange = useCallback((contactId: string | null) => {\n    if (!currentSessionId) return;\n    updateSession.mutate({ sessionId: currentSessionId, contextContactId: contactId }, {\n      onSuccess: () => { toast.success('Context updated'); refetchSessions(); },\n      onError: () => toast.error('Failed to update context'),\n    });\n  }, [currentSessionId, updateSession, refetchSessions]);\n\n  // Send message\n  const handleSend = useCallback((text?: string) => {\n    const msg = (text ?? input).trim();\n    if (!msg || isPending) return;\n\n    const userMsg: LocalMessage = {\n      id: `msg-${Date.now()}-user`, role: 'user', content: msg, timestamp: new Date().toISOString(),\n    };\n    setLocalMessages(prev => [...prev, userMsg]);\n    setInput('');\n    if (textareaRef.current) { textareaRef.current.style.height = 'auto'; }\n\n    const history = localMessages.slice(-10).map(m => ({ role: m.role, content: m.content }));\n    const mutationFn = mode === 'sot' ? sendSotMessage : sendRagMessage;\n\n    const payload: Record<string, unknown> = { message: msg, history };\n    if (mode === 'rag' && currentSessionId) payload.sessionId = currentSessionId;\n\n    mutationFn.mutate(payload as Parameters<typeof mutationFn.mutate>[0], {\n      onSuccess: (data: unknown) => {\n        const d = data as ChatResponse;\n        const assistantMsg: LocalMessage = {\n          id: `msg-${Date.now()}-assistant`, role: 'assistant',\n          content: d.response, timestamp: new Date().toISOString(),\n          sources: d.sources, contextQuality: d.contextQuality,\n          confidence: d.confidence, queryType: d.queryType, rag: d.rag,\n        };\n        setLocalMessages(prev => [...prev, assistantMsg]);\n\n        // Auto-create session if backend created one\n        if (d.sessionId && !currentSessionId) {\n          setCurrentSessionId(d.sessionId);\n          refetchSessions();\n        }\n      },\n      onError: (error: Error) => {\n        setLocalMessages(prev => [...prev, {\n          id: `msg-${Date.now()}-error`, role: 'system' as const,\n          content: `Error: ${error.message}`, timestamp: new Date().toISOString(),\n        }]);\n      },\n    });\n  }, [input, localMessages, isPending, mode, sendRagMessage, sendSotMessage, currentSessionId, refetchSessions]);\n\n  // Clear\n  const handleClear = useCallback(() => {\n    setLocalMessages([]);\n    setCurrentSessionId(null);\n  }, []);\n\n  const modes = [\n    { key: 'rag' as ChatMode, label: 'RAG Chat', icon: MessageCircle, desc: 'Query all project knowledge' },\n    { key: 'sot' as ChatMode, label: 'SOT Chat', icon: Shield, desc: 'Source of Truth focused' },\n    { key: 'briefing' as ChatMode, label: 'Briefing', icon: FileBarChart, desc: 'Daily project briefing' },\n  ];\n\n  // ── Briefing view ──────────────────────────────────────────────────────────\n  if (mode === 'briefing') {\n    return (\n      <div className=\"p-6 space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-2xl font-bold text-[var(--gm-text-primary)]\">Daily Briefing</h1>\n          <button\n            onClick={() => { setRefreshBriefing(true); briefing.refetch().then(() => setRefreshBriefing(false)); }}\n            disabled={briefing.isFetching}\n            className={cn(BTN_PRIMARY, 'flex items-center gap-1.5')}\n          >\n            {briefing.isFetching ? <Loader2 className=\"w-3.5 h-3.5 animate-spin\" /> : <RotateCw className=\"w-3.5 h-3.5\" />}\n            Refresh\n          </button>\n        </div>\n        <ModeSwitcher modes={modes} current={mode} onChange={setMode} />\n        {briefing.isLoading ? (\n          <div className=\"flex items-center justify-center h-32\"><Loader2 className=\"h-8 w-8 animate-spin text-[var(--gm-accent-primary)]\" /></div>\n        ) : briefing.error ? (\n          <div className={cn(CARD, 'p-6 text-center text-[var(--gm-text-tertiary)]')}>Failed to load briefing.</div>\n        ) : (\n          <div className={cn(CARD, 'p-6')}>\n            {briefing.data?.generated_at && (\n              <p className=\"text-[10px] text-[var(--gm-text-tertiary)] mb-4\">Generated: {new Date(briefing.data.generated_at).toLocaleString()}</p>\n            )}\n            <div className=\"prose prose-sm dark:prose-invert max-w-none text-[var(--gm-text-primary)] whitespace-pre-wrap\">\n              {(briefing.data as Record<string, unknown>)?.briefing as string || briefing.data?.content || 'No briefing available.'}\n            </div>\n            {(briefing.data as Record<string, unknown>)?.analysis && (\n              <div className=\"mt-6 pt-4 border-t border-[var(--gm-border-primary)]\">\n                <h3 className=\"text-sm font-semibold text-[var(--gm-text-primary)] mb-2\">Analysis</h3>\n                <div className=\"prose prose-sm dark:prose-invert max-w-none text-[var(--gm-text-tertiary)] whitespace-pre-wrap\">\n                  {(briefing.data as Record<string, unknown>).analysis as string}\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  // ── Chat view (RAG or SOT) ─────────────────────────────────────────────────\n  return (\n    <div className=\"flex h-[calc(100vh-4rem)]\">\n      {/* Sessions sidebar (only in RAG mode) */}\n      {mode === 'rag' && (\n        <SessionsSidebar\n          sessions={sessions}\n          currentId={currentSessionId}\n          onSelect={handleSelectSession}\n          onCreate={handleCreateSession}\n          contacts={contacts}\n          onContextChange={handleContextChange}\n        />\n      )}\n\n      {/* Main chat area */}\n      <div className=\"flex-1 flex flex-col min-w-0\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between px-6 py-3 border-b border-[var(--gm-border-primary)] shrink-0\">\n          <h1 className=\"text-lg font-bold text-[var(--gm-text-primary)]\">Chat</h1>\n          <div className=\"flex gap-2\">\n            {localMessages.length > 0 && (\n              <button onClick={handleClear} className={cn(BTN_SECONDARY, 'flex items-center gap-1.5')}>\n                <Trash2 className=\"w-3.5 h-3.5\" /> Clear\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* Mode switcher */}\n        <div className=\"px-6 pt-3\">\n          <ModeSwitcher modes={modes} current={mode} onChange={setMode} />\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto px-6 py-4 space-y-4\">\n          {localMessages.length === 0 && (\n            <div className=\"text-center text-[var(--gm-text-tertiary)] py-12 space-y-4\">\n              <p>{mode === 'sot' ? 'Ask about facts, decisions, risks, and actions.' : 'Ask a question about your project knowledge base.'}</p>\n              {/* Quick prompts */}\n              <div className=\"flex flex-wrap justify-center gap-2\">\n                {QUICK_PROMPTS.map(p => (\n                  <button\n                    key={p}\n                    onClick={() => handleSend(p)}\n                    className=\"px-3 py-1.5 text-xs rounded-full border border-[var(--gm-border-primary)] bg-[var(--gm-surface-primary)] text-[var(--gm-text-tertiary)] hover:border-[var(--gm-accent-primary)] hover:text-[var(--gm-accent-primary)] transition-colors\"\n                  >\n                    {p}\n                  </button>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {localMessages.map(msg => (\n            <div key={msg.id}>\n              <div className={cn(\n                'max-w-[80%] rounded-xl p-3 text-sm',\n                msg.role === 'user' ? 'ml-auto bg-[var(--gm-interactive-primary)] text-[var(--gm-text-on-brand)]' :\n                  msg.role === 'system' ? 'mx-auto bg-[var(--color-danger-500)]/10 text-[var(--color-danger-500)]' :\n                    'bg-[var(--gm-bg-tertiary)]'\n              )}>\n                <div className=\"whitespace-pre-wrap\">{msg.content}</div>\n                <div className=\"flex items-center justify-between mt-1.5\">\n                  <span className=\"text-[10px] opacity-50\">{msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '—'}</span>\n                  {msg.contextQuality && msg.role === 'assistant' && (\n                    <span className={cn(\n                      'text-[9px] px-2 py-0.5 rounded-full font-medium ml-2',\n                      msg.contextQuality === 'high' ? 'bg-emerald-500/10 text-emerald-400' :\n                        msg.contextQuality === 'medium' ? 'bg-amber-500/10 text-amber-400' :\n                          'bg-[var(--gm-bg-tertiary)] text-[var(--gm-text-tertiary)]'\n                    )}>\n                      {msg.contextQuality} confidence\n                    </span>\n                  )}\n                </div>\n                <RagBadges msg={msg} />\n              </div>\n              {msg.sources && msg.sources.length > 0 && (\n                <div className=\"max-w-[80%]\">\n                  <ContactPills sources={msg.sources} />\n                  <CollapsibleSources sources={msg.sources} />\n                </div>\n              )}\n            </div>\n          ))}\n\n          {isPending && (\n            <div className=\"max-w-[80%] rounded-xl p-3 text-sm bg-[var(--gm-bg-tertiary)] flex items-center gap-2\">\n              <Loader2 className=\"h-3.5 w-3.5 animate-spin text-[var(--gm-text-tertiary)]\" />\n              <span className=\"text-[var(--gm-text-tertiary)]\">Thinking...</span>\n            </div>\n          )}\n          <div ref={bottomRef} />\n        </div>\n\n        {/* Quick prompts inline (when there are already messages) */}\n        {localMessages.length > 0 && (\n          <div className=\"flex flex-wrap gap-1.5 px-6 pb-2\">\n            {QUICK_PROMPTS.map(p => (\n              <button\n                key={p}\n                onClick={() => handleSend(p)}\n                className=\"px-2.5 py-1 text-[10px] rounded-full border border-[var(--gm-border-primary)] bg-[var(--gm-surface-primary)] text-[var(--gm-text-tertiary)] hover:border-[var(--gm-accent-primary)] hover:text-[var(--gm-accent-primary)] transition-colors\"\n              >\n                {p}\n              </button>\n            ))}\n          </div>\n        )}\n\n        {/* Input */}\n        <div className=\"flex gap-2 px-6 py-3 border-t border-[var(--gm-border-primary)] bg-[var(--gm-bg-tertiary)] shrink-0\">\n          <textarea\n            ref={textareaRef}\n            value={input}\n            onChange={handleInputChange}\n            onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }}\n            placeholder={mode === 'sot' ? 'Ask about facts, decisions, risks...' : 'Ask a question...'}\n            rows={1}\n            className={cn(INPUT, 'flex-1 min-h-[44px] max-h-[120px] resize-none py-2.5')}\n          />\n          <button\n            onClick={() => handleSend()}\n            disabled={!input.trim() || isPending}\n            className={cn(BTN_PRIMARY, 'h-11 px-4 text-sm self-end')}\n          >\n            <Send className=\"h-4 w-4\" />\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ── Mode Switcher ────────────────────────────────────────────────────────────\n\nfunction ModeSwitcher({ modes, current, onChange }: {\n  modes: Array<{ key: ChatMode; label: string; icon: typeof MessageCircle }>;\n  current: ChatMode;\n  onChange: (m: ChatMode) => void;\n}) {\n  return (\n    <div className=\"flex gap-1 bg-[var(--gm-bg-tertiary)] rounded-xl p-1 max-w-md mb-3\">\n      {modes.map(m => {\n        const Icon = m.icon;\n        return (\n          <button\n            key={m.key}\n            onClick={() => onChange(m.key)}\n            className={cn(\n              'flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors',\n              current === m.key ? 'bg-[var(--gm-surface-primary)] text-[var(--gm-text-primary)] shadow-sm' : 'text-[var(--gm-text-tertiary)] hover:text-[var(--gm-text-primary)]'\n            )}\n          >\n            <Icon className=\"w-3.5 h-3.5\" /> {m.label}\n          </button>\n        );\n      })}\n    </div>\n  );\n}\n"],"names":["ContactBadge","contact","compact","avatar","resolveAvatarUrl","jsxs","cn","jsx","getInitials","ContactSelect","contacts","value","onChange","placeholder","className","open","setOpen","useState","search","setSearch","containerRef","useRef","searchRef","selected","c","filtered","q","useEffect","handler","e","handleSelect","useCallback","id","X","ChevronDown","Search","CARD","INPUT","BTN_PRIMARY","BTN_SECONDARY","QUICK_PROMPTS","formatRelativeTime","dateStr","ts","diff","mins","hrs","RagBadges","msg","badges","cls","method","total","b","i","ContactPills","sources","contactSources","CollapsibleSources","nonContact","s","top5","ChevronRight","SessionsSidebar","sessions","currentId","onSelect","onCreate","onContextChange","newCtx","setNewCtx","currentSession","Plus","ChatPage","mode","setMode","currentSessionId","setCurrentSessionId","localMessages","setLocalMessages","input","setInput","refreshBriefing","setRefreshBriefing","bottomRef","textareaRef","sendRagMessage","useSendChatMessage","sendSotMessage","useSotChat","briefing","useBriefing","sessionsData","refetchSessions","useChatSessions","createSession","useCreateChatSession","updateSession","useUpdateChatSession","contactsData","useContacts","serverMessages","useChatMessages","useMemo","raw","isPending","msgs","m","handleInputChange","el","handleSelectSession","handleCreateSession","contextContactId","data","session","handleContextChange","contactId","toast","handleSend","text","userMsg","prev","history","mutationFn","payload","d","assistantMsg","error","handleClear","modes","MessageCircle","Shield","FileBarChart","Loader2","RotateCw","ModeSwitcher","Trash2","p","Send","current","Icon"],"mappings":"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"}