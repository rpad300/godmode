const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/KrispManager-GdNHfUwe.js","assets/modulepreload-polyfill-B5Qt9EMX.js","assets/DocumentPreviewModal-hKXOUBAt.js","assets/TranscriptComposer-DdklGiRc.js","assets/ProjectsPage-Czx4uj8q.js","assets/SettingsPage-CinL5LtU.js","assets/GraphExplorer-7mjX8jdS.js","assets/TeamAnalysis-TQHHOzIo.js"])))=>i.map(i=>d[i]);
import"./modulepreload-polyfill-B5Qt9EMX.js";const bf="modulepreload",yf=function(e){return"/"+e},Md={},xe=function(t,n,s){let a=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(u=>Promise.resolve(u).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),r=i?.nonce||i?.getAttribute("nonce");a=c(n.map(l=>{if(l=yf(l),l in Md)return;Md[l]=!0;const u=l.endsWith(".css"),p=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${p}`))return;const g=document.createElement("link");if(g.rel=u?"stylesheet":bf,u||(g.as="script"),g.crossOrigin="",g.href=l,r&&g.setAttribute("nonce",r),document.head.appendChild(g),u)return new Promise((f,h)=>{g.addEventListener("load",f),g.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return a.then(i=>{for(const r of i||[])r.status==="rejected"&&o(r.reason);return t().catch(o)})};class wf{mode;listeners=new Set;mediaQuery;constructor(){this.mode=this.getSavedTheme(),this.mediaQuery=window.matchMedia("(prefers-color-scheme: light)"),this.apply(),this.watchSystemChanges()}getSavedTheme(){const t=localStorage.getItem("theme");return t==="light"||t==="dark"||t==="system"?t:"system"}getSystemTheme(){return this.mediaQuery.matches?"light":"dark"}watchSystemChanges(){this.mediaQuery.addEventListener("change",()=>{this.mode==="system"&&this.apply()})}getEffective(){return this.mode==="system"?this.getSystemTheme():this.mode}getMode(){return this.mode}apply(){const t=this.getEffective();document.documentElement.setAttribute("data-theme",t),this.listeners.forEach(n=>n(t))}set(t){this.mode=t,localStorage.setItem("theme",t),this.apply()}cycle(){const t=["light","dark","system"],s=(t.indexOf(this.mode)+1)%t.length;return this.set(t[s]),this.mode}toggle(){const n=this.getEffective()==="dark"?"light":"dark";return this.set(n),n}onChange(t){return this.listeners.add(t),()=>this.listeners.delete(t)}getIcon(){switch(this.mode){case"light":return"‚òÄÔ∏è";case"dark":return"üåô";case"system":return"üíª"}}getLabel(){switch(this.mode){case"light":return"Light";case"dark":return"Dark";case"system":return"System"}}}const tt=new wf,kf={success:'<svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',error:'<svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',warning:'<svg class="w-5 h-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',info:'<svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'};let Ga=null;const xf=5;function $f(){return Ga||(Ga=document.createElement("div"),Ga.className="toast-container",document.body.appendChild(Ga)),Ga}const m={show(e,t="info",n={}){const s=$f(),a=n.duration||4e3;if(s.children.length>=xf){const c=s.firstElementChild;c&&(c.classList.add("toast-leaving"),setTimeout(()=>c.remove(),200))}const o=document.createElement("div");o.className=`toast-sota ${t}`,o.innerHTML=`
      <div class="toast-icon">${kf[t]}</div>
      <div class="toast-content">
        ${n.title?`<div class="toast-title">${n.title}</div>`:""}
        <p class="toast-message">${e}</p>
      </div>
      <button class="toast-close" aria-label="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    `;const i=o.querySelector(".toast-close"),r=()=>{o.classList.add("toast-leaving"),setTimeout(()=>{o.parentElement&&o.remove()},200)};i?.addEventListener("click",r),a>0&&setTimeout(r,a),s.appendChild(o)},success(e,t){this.show(e,"success",t)},error(e,t){this.show(e,"error",t)},warning(e,t){this.show(e,"warning",t)},info(e,t){this.show(e,"info",t)}};let Tp=null;function Sf(e){Tp=e}const Ct={baseUrl:"",defaultHeaders:{"Content-Type":"application/json"},showErrorToasts:!0,timeout:3e4,retryCount:2,retryDelay:1e3},ko=[],Cf=[];function _f(e){return ko.push(e),()=>{const t=ko.indexOf(e);t>-1&&ko.splice(t,1)}}async function En(e,t={},n=0){const s=`${Ct.baseUrl}${e}`;let a={...t,headers:{...Ct.defaultHeaders,...t.headers}};for(const l of ko)a=await l(a);const i=a.timeout??Ct.timeout;delete a.timeout;const r=new AbortController,c=setTimeout(()=>r.abort(),i);try{const l=await fetch(s,{...a,signal:r.signal,credentials:"include"});clearTimeout(c);const u=(l.headers.get("content-type")||"").toLowerCase(),p=await l.text();let g;if(u.includes("application/json")&&p)try{g=JSON.parse(p)}catch{const h="Invalid server response (not JSON). You may be seeing an error page or wrong endpoint.";throw Ct.showErrorToasts&&m.error(h),new Za(h,l.status||0)}else g=p;if(!l.ok){switch(l.status){case 401:Ct.onUnauthorized&&Ct.onUnauthorized();break;case 403:Ct.onForbidden&&Ct.onForbidden();break;case 429:if(n<3){const k=parseInt(l.headers.get("Retry-After")||"5",10);return await Pr(k*1e3),En(e,t,n+1)}break;case 503:case 504:if(n<Ct.retryCount)return await Pr(Ct.retryDelay*Math.pow(2,n)),En(e,t,n+1);break}const h=Lf(g,l.statusText);throw Ct.showErrorToasts&&m.error(h),new Za(h,l.status,g)}let f={data:g,ok:!0,status:l.status,statusText:l.statusText};for(const h of Cf)f=await h(f);return f}catch(l){if(clearTimeout(c),l instanceof Za)throw l;if(l instanceof DOMException&&l.name==="AbortError"){const f="Request timed out";throw Ct.showErrorToasts&&m.error(f),new Za(f,0)}if(n<Ct.retryCount)return await Pr(Ct.retryDelay*Math.pow(2,n)),En(e,t,n+1);const u=l instanceof Error?l.message:"Network error",g=u.includes("JSON")||u.includes("Unexpected token")?"Invalid server response. Check that the server is running and the URL is correct.":u;throw Ct.showErrorToasts&&m.error(`Connection error: ${g}`),new Za(g,0)}}function Lf(e,t){if(typeof e=="object"&&e!==null){const n=e;return String(n.error||n.message||n.detail||t)}return t||"Request failed"}function Pr(e){return new Promise(t=>setTimeout(t,e))}class Za extends Error{status;details;constructor(t,n,s){super(t),this.name="ApiError",this.status=n,this.details=s}}const v={get:(e,t)=>En(e,{...t,method:"GET"}),post:(e,t,n)=>En(e,{...n,method:"POST",body:t?JSON.stringify(t):void 0}),put:(e,t,n)=>En(e,{...n,method:"PUT",body:t?JSON.stringify(t):void 0}),patch:(e,t,n)=>En(e,{...n,method:"PATCH",body:t?JSON.stringify(t):void 0}),delete:(e,t)=>En(e,{...t,method:"DELETE"})};function Ap(e){Object.assign(Ct,e)}function Tf(){const e=Tp?.()??null;return e?{"X-Project-Id":e}:{}}async function at(e,t){const n=new Headers(t?.headers);return Object.entries(Tf()).forEach(([s,a])=>n.set(s,a)),fetch(e,{...t,headers:n,credentials:"include"})}function Af(e,t){try{const n=localStorage.getItem(e);return n===null?t:JSON.parse(n)}catch{return t}}function Mf(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch{}}function Ef(e){try{localStorage.removeItem(e)}catch{}}function qf(){try{localStorage.clear()}catch{}}function jf(e){try{return localStorage.getItem(e)!==null}catch{return!1}}function Pf(){try{return Object.keys(localStorage)}catch{return[]}}const Yt={get:Af,set:Mf,remove:Ef,clear:qf,has:jf,keys:Pf};class Df{shortcuts=new Map;enabled=!0;isMac=typeof navigator<"u"&&/Mac|iPod|iPhone|iPad/.test(navigator.platform);constructor(){this.handleKeydown=this.handleKeydown.bind(this),document.addEventListener("keydown",this.handleKeydown)}parseShortcut(t,n,s=""){const a=t.toLowerCase().split("+"),o=a.pop()||t;return{key:o,ctrl:a.includes("ctrl")||a.includes("mod")&&!this.isMac,shift:a.includes("shift"),alt:a.includes("alt"),meta:a.includes("meta")||a.includes("mod")&&this.isMac,description:s,handler:()=>{const r=new KeyboardEvent("keydown",{key:o});n(r)}}}getShortcutKey(t){const n=[];return t.ctrl&&n.push("ctrl"),t.shift&&n.push("shift"),t.alt&&n.push("alt"),t.meta&&n.push("meta"),t.key&&n.push(t.key.toLowerCase()),n.join("+")}handleKeydown(t){if(!this.enabled)return;const n=t.target;if((n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.isContentEditable)&&t.key!=="Escape")return;const s=this.getShortcutKey({key:t.key,ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey}),a=this.shortcuts.get(s);a&&(t.preventDefault(),a.handler())}register(t,n,s){let a;if(typeof t=="string"){if(!n)throw new Error("Handler is required when using string shortcut format");a=this.parseShortcut(t,n,s||"")}else a=t;const o=this.getShortcutKey(a);return this.shortcuts.set(o,a),()=>this.shortcuts.delete(o)}unregister(t){const n=this.getShortcutKey(t);this.shortcuts.delete(n)}setEnabled(t){this.enabled=t}getAll(){return Array.from(this.shortcuts.values())}showHelp(){const t=this.getAll();console.log("Keyboard Shortcuts:"),t.forEach(n=>{const s=[];n.ctrl&&s.push("Ctrl"),n.shift&&s.push("Shift"),n.alt&&s.push("Alt"),n.meta&&s.push("Cmd"),s.push(n.key.toUpperCase()),console.log(`  ${s.join("+")} - ${n.description}`)})}destroy(){document.removeEventListener("keydown",this.handleKeydown),this.shortcuts.clear()}}const Qt=new Df;class zf{undoStack=[];redoStack=[];maxSize=50;listeners=new Set;push(t){this.undoStack.push({...t,timestamp:Date.now()}),this.redoStack=[],this.undoStack.length>this.maxSize&&this.undoStack.shift(),this.notify()}async undo(){const t=this.undoStack.pop();if(!t)return!1;try{return await t.undo(),this.redoStack.push(t),this.notify(),!0}catch(n){return console.error("Undo failed:",n),this.undoStack.push(t),!1}}async redo(){const t=this.redoStack.pop();if(!t||!t.redo)return!1;try{return await t.redo(),this.undoStack.push(t),this.notify(),!0}catch(n){return console.error("Redo failed:",n),this.redoStack.push(t),!1}}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoDescription(){return this.undoStack[this.undoStack.length-1]?.description??null}getRedoDescription(){return this.redoStack[this.redoStack.length-1]?.description??null}clear(){this.undoStack=[],this.redoStack=[],this.notify()}onChange(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t())}getState(){return{undoCount:this.undoStack.length,redoCount:this.redoStack.length}}}const mn=new zf,Mp={currentProjectId:Yt.get("currentProjectId",null),currentProject:Yt.get("currentProject",null),currentUser:null,authConfigured:!1,config:{},isLoading:!1,error:null,isOnline:navigator.onLine,version:"1.0.0"};let Ye={...Mp};const yc=new Set;function is(){yc.forEach(e=>e(Ye))}function If(){return Ye}function Hf(e){return yc.add(e),()=>yc.delete(e)}function Bf(e){Ye={...Ye,currentProjectId:e},e?Yt.set("currentProjectId",e):(Yt.remove("currentProjectId"),Yt.remove("currentProject"),Ye={...Ye,currentProject:null}),is()}function Rf(e){Ye={...Ye,currentProject:e,currentProjectId:e?.id||null},e?(Yt.set("currentProject",e),Yt.set("currentProjectId",e.id)):(Yt.remove("currentProject"),Yt.remove("currentProjectId")),is()}function Nf(e){Ye={...Ye,currentUser:e},is()}function Of(e){Ye={...Ye,authConfigured:e},is()}function Ff(e){Ye={...Ye,config:{...Ye.config,...e}},is()}function Uf(e){Ye={...Ye,isLoading:e},is()}function Vf(e){Ye={...Ye,error:e},is()}function wc(e){Ye={...Ye,isOnline:e},is()}function Gf(){Ye={...Mp},is()}function Zf(){window.addEventListener("online",()=>wc(!0)),window.addEventListener("offline",()=>wc(!1))}const N={getState:If,subscribe:Hf,setCurrentProject:Rf,setCurrentProjectId:Bf,setCurrentUser:Nf,setAuthConfigured:Of,setConfig:Ff,setLoading:Uf,setError:Vf,setOnline:wc,reset:Gf,init:Zf};let xo=!1,Wa=null;async function Ep(){try{const e=await v.get("/api/auth/status"),t=e.data.configured;return N.setAuthConfigured(t),e.data}catch{return N.setAuthConfigured(!1),{configured:!1}}}async function qp(){try{const e=await v.get("/api/auth/me");if(e.data.authenticated&&e.data.user){const t=e.data.user,n=pr(t);return N.setCurrentUser(n),n}return N.setCurrentUser(null),null}catch{return N.setCurrentUser(null),null}}async function Wf(){return Wa||(Wa=(async()=>{try{if(!(await Ep()).configured)return xo=!0,!1;const t=await qp();return xo=!0,t?!0:(N.setCurrentUser(null),console.log("üîê Supabase configured but no valid session - login required"),!1)}catch{return N.setCurrentUser(null),xo=!0,!1}finally{Wa=null}})(),Wa)}async function Kf(e){const t=await v.post("/api/auth/login",e);if(!t.data.success)throw new Error("Login failed");const n=pr(t.data.user);return N.setCurrentUser(n),n}async function Qf(e){if(e.password.length<12)throw new Error("Password must be at least 12 characters");if(e.username&&e.username.length<3)throw new Error("Username must be at least 3 characters");if(e.username&&!/^[a-zA-Z0-9_]+$/.test(e.username))throw new Error("Username can only contain letters, numbers, and underscores");const t=await v.post("/api/auth/register",e);if(!t.data.success)throw new Error("Registration failed");const n=pr(t.data.user);return t.data.needsEmailVerification||N.setCurrentUser(n),{user:n,needsEmailVerification:t.data.needsEmailVerification}}async function Jf(){try{await v.post("/api/auth/logout")}catch{}N.setCurrentUser(null),N.setCurrentProject(null)}async function Yf(e){await v.post("/api/auth/forgot-password",{email:e})}async function Xf(e,t){if(e.length<12)throw new Error("Password must be at least 12 characters");if(!(await v.post("/api/auth/reset-password",{password:e,access_token:t})).data.success)throw new Error("Password reset failed")}async function eh(){try{return(await v.post("/api/auth/refresh")).data.success}catch{return!1}}async function th(e){return(await v.post("/api/auth/otp/request",{email:e})).data}async function nh(e,t){const n=await v.post("/api/auth/otp/verify",{email:e,code:t});if(!n.data.success){const a=new Error(n.data.error||"Verification failed");throw a.attemptsRemaining=n.data.attemptsRemaining,a.needsEmailVerification=n.data.needsEmailVerification,a.fallbackToPassword=n.data.fallbackToPassword,a}if(n.data.redirectTo)throw window.location.href=n.data.redirectTo,new Error("Redirecting...");if(!n.data.user)throw new Error("Login completed but no user data received");const s=pr(n.data.user);return N.setCurrentUser(s),s}async function sh(){try{return(await v.get("/api/auth/otp/config")).data}catch{return{codeLength:6,expirationMinutes:10,resendCooldownSeconds:60}}}async function ah(e,t){const n=await v.post("/api/auth/confirm-email",{email:e,code:t});if(!n.data.success)throw new Error(n.data.error||"Confirmation failed")}async function ih(e){const t=await v.post("/api/auth/resend-confirmation",{email:e});if(!t.data.success){const n=new Error(t.data.error||"Failed to resend confirmation");throw n.retryAfter=t.data.retryAfter,n}return{expiresInMinutes:t.data.expiresInMinutes}}function pr(e){const t=e.profile,n=e.user_metadata||{};return{id:e.id,email:e.email,name:t?.display_name||n.display_name||n.username||e.email.split("@")[0],avatar:t?.avatar_url,role:t?.role==="superadmin"?"superadmin":t?.role==="admin"?"admin":"member"}}function oh(){return N.getState().currentUser!==null}function rh(){return xo}function ch(){return N.getState().currentUser}function lh(e){const t=()=>e();return window.addEventListener("godmode:auth-required",t),()=>window.removeEventListener("godmode:auth-required",t)}function dh(){window.dispatchEvent(new CustomEvent("godmode:auth-required"))}const Nt={checkStatus:Ep,checkSession:qp,init:Wf,login:Kf,register:Qf,logout:Jf,forgotPassword:Yf,resetPassword:Xf,refreshSession:eh,isAuthenticated:oh,isInitialized:rh,getCurrentUser:ch,onAuthRequired:lh,triggerAuthRequired:dh,requestLoginCode:th,verifyLoginCode:nh,getOTPConfig:sh,confirmEmail:ah,resendConfirmation:ih},jp={questions:[],risks:[],actions:[],decisions:[],facts:[],contacts:[],chatHistory:[],projects:[],lastUpdated:{}};let je={...jp};const kc=new Set;function wn(){kc.forEach(e=>e(je))}function uh(){return je}function ph(e){return kc.add(e),()=>kc.delete(e)}function mh(e){je={...je,questions:e,lastUpdated:{...je.lastUpdated,questions:Date.now()}},wn()}function gh(e){je={...je,risks:e,lastUpdated:{...je.lastUpdated,risks:Date.now()}},wn()}function vh(e){je={...je,actions:e,lastUpdated:{...je.lastUpdated,actions:Date.now()}},wn()}function fh(e){je={...je,decisions:e,lastUpdated:{...je.lastUpdated,decisions:Date.now()}},wn()}function hh(e){je={...je,facts:e,lastUpdated:{...je.lastUpdated,facts:Date.now()}},wn()}function bh(e){je={...je,contacts:e,lastUpdated:{...je.lastUpdated,contacts:Date.now()}},wn()}function yh(e){je={...je,chatHistory:e},wn()}function wh(e){je={...je,chatHistory:[...je.chatHistory,e]},wn()}function kh(e){je={...je,projects:e,lastUpdated:{...je.lastUpdated,projects:Date.now()}},wn()}function xh(){je={...je,chatHistory:[]},wn()}function $h(){je={...jp},wn()}const ce={getState:uh,subscribe:ph,setQuestions:mh,setRisks:gh,setActions:vh,setDecisions:fh,setFacts:hh,setContacts:bh,setChatHistory:yh,addChatMessage:wh,setProjects:kh,clearChatHistory:xh,reset:$h};async function Qs(){try{const t=(await v.get("/api/projects")).data.projects||[];return ce.setProjects(t),t}catch{return[]}}async function Pp(){try{const t=(await v.get("/api/projects/current")).data.project;return t?(N.setCurrentProject(t),t):null}catch{return null}}async function Sh(e){const n={id:(await v.post("/api/projects",e)).data.id,name:e.name,description:e.description};return await Qs(),n}async function Ch(e,t){await v.put(`/api/projects/${e}`,t);const n=N.getState().currentProject;n?.id===e&&N.setCurrentProject({...n,...t}),await Qs()}async function _h(e){await v.delete(`/api/projects/${e}`),N.getState().currentProjectId===e&&N.setCurrentProject(null),await Qs()}async function Dp(e){try{N.setCurrentProjectId(e),await v.put(`/api/projects/${e}/activate`);let t=null;for(let n=0;n<5;n++){const a=(await v.get("/api/projects/current")).data.project;if(a&&a.id===e){t=a;break}await new Promise(o=>setTimeout(o,500))}if(t)return N.setCurrentProject(t),t;{const n=ce.getState().projects.find(s=>s.id===e);if(n){const s={id:n.id,name:n.name};return N.setCurrentProject(s),s}return console.warn(`[Projects] Activation timed out or inconsistent state for ${e}`),null}}catch(t){console.error("[Projects] Activation failed",t);const n=N.getState().currentProject;return N.setCurrentProject(n),null}}async function Lh(e){await v.post(`/api/projects/${e}/set-default`),await Qs()}async function Th(e){try{return(await v.get(`/api/projects/${e}/stats`)).data.stats||{}}catch{return{}}}async function Ah(e){const t=await at(`/api/projects/${e}/export`);if(!t.ok)throw new Error("Failed to export project");return t.blob()}async function Mh(e){const t=new FormData;t.append("file",e);const n=await at("/api/projects/import",{method:"POST",body:t});if(!n.ok){const a=await n.json().catch(()=>({error:"Import failed"}));throw new Error(a.error||"Import failed")}const s=await n.json();return await Qs(),s.project}async function Eh(){if(await Qs(),!await Pp()){const t=ce.getState().projects;if(t.length>0){const n=t.find(s=>s.isDefault)||t[0];await Dp(n.id)}}}const ks={getAll:Qs,getCurrent:Pp,create:Sh,update:Ch,delete:_h,activate:Dp,setDefault:Lh,getStats:Th,export:Ah,import:Mh,init:Eh};async function mr(){try{const t=(await v.get("/api/companies")).data?.companies;return Array.isArray(t)?t:[]}catch{return[]}}async function $i(e){try{return(await v.get(`/api/companies/${e}`)).data?.company??null}catch{return null}}async function zp(e){return(await v.post("/api/companies",e)).data.company}async function Ip(e,t){return(await v.put(`/api/companies/${e}`,t)).data.company}async function Hp(e){await v.delete(`/api/companies/${e}`)}async function Mo(e){return(await v.post(`/api/companies/${e}/analyze`,{},{timeout:3e5})).data.company}async function Si(e,t){return(await v.get(`/api/companies/${e}/templates/${t}`)).data?.html??""}async function Bp(e,t,n){await v.put(`/api/companies/${e}/templates/${t}`,{html:n})}async function Rp(e,t){const n=await v.post(`/api/companies/${e}/templates/generate`,{type:t},{timeout:3e5});return{html:n.data.html,company:n.data.company}}async function Np(){try{return(await v.get("/api/dashboard")).data}catch{return null}}async function qh(){try{return(await v.get("/api/stats")).data}catch{return null}}async function jh(e=7){try{return(await v.get(`/api/trends?days=${e}`)).data}catch{return null}}async function Op(){try{return(await v.get("/api/sot/health")).data}catch{return null}}async function Fp(){try{return(await v.get("/api/sot/insights")).data.insights||[]}catch{return[]}}async function Up(){try{return(await v.get("/api/sot/alerts")).data.alerts||[]}catch{return[]}}async function Ph(){const[e,t,n,s]=await Promise.all([Np(),Op(),Fp(),Up()]);return{dashboard:e,health:t,insights:n,alerts:s}}const xl={getDashboard:Np,getStats:qh,getTrends:jh,getHealth:Op,getInsights:Fp,getAlerts:Up,loadAll:Ph};async function Dh(e){try{const t=new URLSearchParams;e?.status&&t.set("status",e.status),e?.priority&&t.set("priority",e.priority);const n=t.toString(),s=n?`/api/questions?${n}`:"/api/questions";return(await v.get(s)).data.questions||[]}catch{return[]}}async function zh(e){try{return(await v.get(`/api/questions/${e}`)).data.question||null}catch{return null}}async function Ih(e){return(await v.post("/api/questions",e)).data}async function Hh(e,t){return(await v.put(`/api/questions/${e}`,t)).data.question}async function Bh(e,t){await v.delete(`/api/questions/${e}`,{body:JSON.stringify({reason:t})})}async function Rh(e,t){return(await v.post(`/api/questions/${e}/answer`,t)).data}async function Nh(){try{return(await v.get("/api/questions/by-person")).data.questionsByPerson||{}}catch{return{}}}async function Oh(){try{return(await v.get("/api/questions/by-team")).data.questionsByTeam||{}}catch{return{}}}async function Fh(e){const t=new URLSearchParams;return e.content&&t.set("content",e.content),e.id&&t.set("id",String(e.id)),e.useAI===!1&&t.set("ai","false"),e.refresh&&t.set("refresh","true"),(await v.get(`/api/questions/suggest-assignee?${t.toString()}`,{signal:AbortSignal.timeout(9e4)})).data}async function Uh(e,t){return(await v.post(`/api/questions/${e}/reopen`,{reason:t})).data.question}async function Vh(e,t,n){return(await v.post(`/api/questions/${e}/dismiss`,{reason:t,details:n})).data.question}async function Gh(e,t,n){return(await v.post(`/api/questions/${e}/defer`,{until:typeof t=="string"?t:t.toISOString(),reason:n})).data.question}async function Zh(e,t,n){return(await v.post(`/api/questions/${e}/feedback`,{wasUseful:t,feedback:n})).data.question}function Wh(e){const t=new Date,n=new Date(t.getTime()-10080*60*1e3);return{total:e.length,pending:e.filter(s=>s.status==="pending").length,assigned:e.filter(s=>s.status==="assigned").length,resolved:e.filter(s=>s.status==="resolved").length,critical:e.filter(s=>s.priority==="critical"&&s.status!=="resolved").length,overdue:e.filter(s=>s.status==="resolved"?!1:new Date(s.created_at)<n).length}}const Qe={getAll:Dh,get:zh,create:Ih,update:Hh,delete:Bh,answer:Rh,getByPerson:Nh,getByTeam:Oh,suggestAssignee:Fh,reopen:Uh,getStats:Wh,dismissQuestion:Vh,deferQuestion:Gh,submitAnswerFeedback:Zh};async function Kh(e){try{const t=e?`/api/risks?status=${e}`:"/api/risks";return(await v.get(t)).data.risks||[]}catch{return[]}}async function Qh(e){try{return(await v.get(`/api/risks/${e}`)).data.risk??null}catch{return null}}async function Jh(){try{return(await v.get("/api/risks/deleted")).data.risks||[]}catch{return[]}}async function Yh(e){return(await v.post(`/api/risks/${e}/restore`,{})).data.risk}async function Xh(e){try{return(await v.get(`/api/risks/${e}/events`)).data.events||[]}catch{return[]}}async function eb(){try{return(await v.get("/api/risks/by-category")).data.risksByCategory||{}}catch{return{}}}async function tb(e){const t=await v.post("/api/risks",e);return t.data.risk||{...e,id:t.data.id,status:"open",created_at:new Date().toISOString()}}async function nb(e,t){return(await v.put(`/api/risks/${e}`,t)).data.risk}async function sb(e){await v.delete(`/api/risks/${e}`)}function ab(e,t){const n={low:1,medium:2,high:3,critical:4},s={low:1,medium:2,high:3};return(n[e]||2)*(s[t]||2)}async function ib(e){const t=await v.post("/api/risks/suggest",{content:e.content?.trim()||"",impact:e.impact||"medium",likelihood:e.likelihood??e.probability??"medium"});if(t.data.error)throw new Error(t.data.error);const n=Array.isArray(t.data.suggested_owners)?t.data.suggested_owners:[];return{suggested_owner:t.data.suggested_owner??n[0]?.name??"",suggested_mitigation:t.data.suggested_mitigation??"",suggested_owners:n}}function ob(e){const t={};return e.filter(n=>n.status!=="mitigated"&&n.status!=="closed").forEach(n=>{const s=(n.impact||"").toString().toLowerCase(),a=(n.likelihood||"").toString().toLowerCase(),o=`${s}-${a}`;t[o]||(t[o]=[]),t[o].push(n)}),t}const jt={getAll:Kh,get:Qh,getByCategory:eb,getDeleted:Jh,restore:Yh,getEvents:Xh,suggest:ib,create:tb,update:nb,delete:sb,calculateScore:ab,getMatrixData:ob};function Ia(e){return{...e,content:e.content??e.task,assignee:e.assignee??e.owner,due_date:e.due_date??e.deadline,definition_of_done:Array.isArray(e.definition_of_done)?e.definition_of_done:[],acceptance_criteria:Array.isArray(e.acceptance_criteria)?e.acceptance_criteria:[],depends_on:Array.isArray(e.depends_on)?e.depends_on:[],sprint_id:e.sprint_id,sprint_name:e.sprint_name??e.sprints?.name??e.sprint?.name}}async function $l(e,t,n){try{const s=new URLSearchParams;e&&s.set("status",e),t&&s.set("sprint_id",t),n&&s.set("decision_id",n);const a=s.toString(),o=a?`/api/actions?${a}`:"/api/actions";return((await v.get(o)).data.actions||[]).map(Ia)}catch{return[]}}async function rb(e){try{const t=await v.get(`/api/actions/${e}`);return t.data.action?Ia(t.data.action):null}catch{return null}}async function cb(e){const t={content:e.content,task:e.content,assignee:e.assignee,owner:e.assignee,due_date:e.due_date,deadline:e.due_date,status:e.status,priority:e.priority,parent_story_ref:e.parent_story_ref,parent_story_id:e.parent_story_id,size_estimate:e.size_estimate,description:e.description,definition_of_done:e.definition_of_done,acceptance_criteria:e.acceptance_criteria,depends_on:e.depends_on,generation_source:e.generation_source,source_document_id:e.source_document_id,source_email_id:e.source_email_id,source_type:e.source_type,requested_by:e.requested_by,requested_by_contact_id:e.requested_by_contact_id,supporting_document_ids:e.supporting_document_ids,sprint_id:e.sprint_id,task_points:e.task_points,decision_id:e.decision_id??null},n=await v.post("/api/actions",t),s=n.data.action||{...t,id:n.data.id,created_at:new Date().toISOString()};return Ia(s)}async function lb(e,t){const n={task:t.content??t.task,owner:t.assignee??t.owner,deadline:t.due_date??t.deadline,parent_story_ref:t.parent_story_ref,parent_story_id:t.parent_story_id,size_estimate:t.size_estimate,description:t.description,definition_of_done:t.definition_of_done,acceptance_criteria:t.acceptance_criteria,depends_on:t.depends_on,sprint_id:t.sprint_id,task_points:t.task_points,status:t.status,priority:t.priority,decision_id:t.decision_id!==void 0?t.decision_id:void 0};t.refined_with_ai===!0&&(n.refined_with_ai=!0),t.restore_snapshot!=null&&(n.restore_snapshot=t.restore_snapshot);const a=(await v.put(`/api/actions/${e}`,n)).data.action;return a?Ia(a):{}}async function db(e){await v.delete(`/api/actions/${e}`)}async function ub(){try{return((await v.get("/api/actions/deleted")).data.actions||[]).map(Ia)}catch{return[]}}async function pb(e){const t=await v.post(`/api/actions/${e}/restore`,{});return Ia(t.data.action||{})}async function mb(e){try{const t=await v.post("/api/actions/suggest",{content:(e.content||"").trim()});return{suggested_assignees:Array.isArray(t.data.suggested_assignees)?t.data.suggested_assignees:[]}}catch{return{suggested_assignees:[]}}}async function gb(e){const t=await v.post("/api/actions/suggest-task",{user_input:(e.user_input||"").trim(),parent_story_ref:e.parent_story_ref||""});return{task:t.data.task||"",description:t.data.description||"",size_estimate:t.data.size_estimate||"1 day",definition_of_done:Array.isArray(t.data.definition_of_done)?t.data.definition_of_done:[],acceptance_criteria:Array.isArray(t.data.acceptance_criteria)?t.data.acceptance_criteria:[]}}async function vb(e){try{return(await v.get(`/api/actions/${e}/events`)).data.events||[]}catch{return[]}}function Vp(e){return!e.due_date||e.status==="completed"||e.status==="cancelled"?!1:new Date(e.due_date)<new Date}function fb(e){return{total:e.length,pending:e.filter(t=>t.status==="pending").length,inProgress:e.filter(t=>t.status==="in_progress").length,completed:e.filter(t=>t.status==="completed").length,overdue:e.filter(t=>Vp(t)).length}}async function hb(){try{const e=await v.get("/api/actions/report");return{by_status:e.data?.by_status||{},by_assignee:e.data?.by_assignee||{},by_sprint:e.data?.by_sprint||{}}}catch{return{by_status:{},by_assignee:{},by_sprint:{}}}}async function bb(e){try{return(await v.get(`/api/actions/${e}/similar`)).data?.similar||[]}catch{return[]}}async function yb(e){try{const t=e?`/api/user-stories?status=${e}`:"/api/user-stories";return(await v.get(t)).data.user_stories||[]}catch{return[]}}async function wb(e){const t=await v.post("/api/user-stories",e);return t.data.user_story||{id:t.data.id,...e}}async function kb(e){try{return(await v.get(`/api/user-stories/${e}`)).data?.user_story??null}catch{return null}}async function xb(e,t){return(await v.put(`/api/user-stories/${e}`,t)).data.user_story}const Ee={getAll:$l,get:rb,create:cb,update:lb,delete:db,getDeletedActions:ub,restoreAction:pb,getEvents:vb,suggest:mb,suggestTaskFromDescription:gb,getUserStories:yb,getUserStory:kb,addUserStory:wb,updateUserStory:xb,isOverdue:Vp,getStats:fb,getReport:hb,getSimilar:bb};async function $b(e){try{const t=e?`/api/decisions?status=${e}`:"/api/decisions";return(await v.get(t)).data.decisions||[]}catch{return[]}}async function Sb(e){try{return(await v.get(`/api/decisions/${e}`)).data.decision}catch{return null}}async function Cb(){try{return(await v.get("/api/decisions/deleted")).data.decisions||[]}catch{return[]}}async function _b(e){return(await v.post(`/api/decisions/${e}/restore`,{})).data.decision}async function Lb(e){try{return(await v.get(`/api/decisions/${e}/events`)).data.events||[]}catch{return[]}}async function Tb(e,t=10){try{const n=new URLSearchParams;t!==10&&n.set("limit",String(t));const s=n.toString(),a=s?`/api/decisions/${e}/similar?${s}`:`/api/decisions/${e}/similar`;return(await v.get(a)).data.similar||[]}catch{return[]}}async function Ab(){return(await v.post("/api/decision-check/run",{})).data}async function Mb(){try{return(await v.get("/api/conflicts/decisions")).data.conflicts||[]}catch{return[]}}async function Eb(e,t){return(await v.post("/api/decisions/suggest",{content:e.trim(),rationale:t?.trim()||""})).data}async function qb(e,t){return(await v.post("/api/decisions/suggest-owner",{content:e.trim(),rationale:t?.trim()||""})).data}async function jb(e){const t=await v.post("/api/decisions",e);return t.data.decision||{...e,id:t.data.id,status:e.status||"proposed",created_at:new Date().toISOString()}}async function Sl(e,t){return(await v.put(`/api/decisions/${e}`,t)).data.decision}async function Pb(e){await v.delete(`/api/decisions/${e}`)}async function Db(e,t){return Sl(e,{status:"approved",approved_by:t,decided_at:new Date().toISOString()})}async function zb(e,t){return Sl(e,{status:"rejected",rationale:t,decided_at:new Date().toISOString()})}const Ue={getAll:$b,get:Sb,create:jb,update:Sl,delete:Pb,approve:Db,reject:zb,getDeletedDecisions:Cb,restore:_b,getEvents:Lb,getSimilarDecisions:Tb,runDecisionCheck:Ab,detectConflicts:Mb,suggest:Eb,suggestOwner:qb};let Bi=[];async function Ib(e){const t=await v.post("/api/chat",{message:e.message,context:e.context,history:e.history||Bi.slice(-10).map(a=>({role:a.role,content:a.content})),semantic:e.semantic??!0,deepReasoning:e.deepReasoning??!1}),n={id:`msg-${Date.now()}-user`,role:"user",content:e.message,timestamp:new Date().toISOString()},s={id:`msg-${Date.now()}-assistant`,role:"assistant",content:t.data.response,timestamp:new Date().toISOString(),sources:t.data.sources,contextQuality:t.data.contextQuality};return Bi.push(n,s),t.data}async function Hb(e){return(await v.post("/api/ask",e)).data}async function Bb(e){return(await v.post("/api/sot/chat",e)).data}async function Rb(e=!1){const t=e?"/api/briefing?refresh=true":"/api/briefing";return(await v.get(t)).data}async function Nb(e=30){return(await v.get(`/api/briefing/history?limit=${e}`)).data.history||[]}async function Ob(){const e=await v.get("/api/reports/weekly");return typeof e.data=="string"?e.data:""}async function Fb(){return(await v.post("/api/sot/executive-summary")).data.summary||""}function Ub(){return[...Bi]}function Vb(){Bi=[]}function Gb(e){Bi.push(e)}const Ri={send:Ib,ask:Hb,sotChat:Bb,getBriefing:Rb,getBriefingHistory:Nb,getWeeklyReport:Ob,generateExecutiveSummary:Fb,getHistory:Ub,clearHistory:Vb,addToHistory:Gb};async function Zb(e){try{const t=new URLSearchParams;e?.organization&&t.set("organization",e.organization),e?.tag&&t.set("tag",e.tag),e?.search&&t.set("search",e.search);const n=t.toString(),s=n?`/api/contacts?${n}`:"/api/contacts",a=await v.get(s),i=(a.data.contacts||[]).map(r=>({...r,photoUrl:r.photo_url||r.avatar_url||r.photoUrl||r.avatarUrl,avatarUrl:r.avatar_url||r.photo_url||r.avatarUrl||r.photoUrl,isFavorite:r.is_favorite??r.isFavorite??!1,company:r.organization||r.company}));return{contacts:i,total:a.data.total||i.length}}catch(t){return console.error("[ContactsService] Failed to get contacts:",t),{contacts:[],total:0}}}async function Gp(e){try{return(await v.get(`/api/contacts/${e}`)).data.contact}catch{return null}}async function Wb(e){const t=await v.post("/api/contacts",e);return{...e,id:t.data.id,created_at:new Date().toISOString()}}async function Kb(e,t){await v.put(`/api/contacts/${e}`,t)}async function Qb(e){await v.delete(`/api/contacts/${e}`)}async function Jb(){return(await v.get("/api/contacts/stats")).data}async function Yb(e){try{const t=await v.get(`/api/contacts/find-by-name?name=${encodeURIComponent(e)}`);return t.data.found?t.data.contact:null}catch{return null}}async function Xb(){return(await v.get("/api/contacts/duplicates")).data}async function Ed(e){return(await v.post("/api/contacts/merge",{contactIds:e})).data.mergedId}async function ey(e){return(await v.post(`/api/contacts/${e}/enrich`)).data.suggestions}async function ty(e="json"){try{const t=await at(`/api/contacts/export?format=${e}`);if(!t.ok)throw new Error("Export failed");const n=await t.blob(),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=`contacts-export.${e}`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}catch(t){throw console.error("Export failed:",t),t}}async function ny(e){try{return(await v.get(`/api/contacts/${e}/associations`)).data.contact}catch{return Gp(e)}}async function sy(e,t,n){await v.post(`/api/contacts/${e}/projects`,{projectId:t,...n})}async function ay(e,t){await v.delete(`/api/contacts/${e}/projects/${t}`)}async function iy(e){try{return(await v.get(`/api/contacts/${e}/projects`)).data.projects||[]}catch{return[]}}async function oy(){try{return(await v.get("/api/teams")).data.teams||[]}catch{return[]}}async function ry(e){try{return(await v.get(`/api/teams/${e}`)).data}catch{return null}}async function cy(e){const t=await v.post("/api/teams",e);return{...e,id:t.data.id,created_at:new Date().toISOString()}}async function ly(e,t){await v.put(`/api/teams/${e}`,t)}async function dy(e){await v.delete(`/api/teams/${e}`)}async function uy(e,t,n,s=!1){await v.post(`/api/teams/${e}/members`,{contactId:t,role:n,isLead:s})}async function py(e,t){await v.delete(`/api/teams/${e}/members/${t}`)}const Ne={getAll:Zb,get:Gp,create:Wb,update:Kb,delete:Qb,getStats:Jb,findByName:Yb,getDuplicates:Xb,merge:Ed,mergeContacts:Ed,enrich:ey,export:ty,getWithAssociations:ny,addToProject:sy,removeFromProject:ay,getProjects:iy},Zp={getAll:oy,get:ry,create:cy,update:ly,delete:dy,addMember:uy,removeMember:py};async function my(e,t){const n=new FormData;e.forEach(a=>{n.append("files",a)});const s=new XMLHttpRequest;return new Promise((a,o)=>{s.upload.addEventListener("progress",i=>{i.lengthComputable&&t&&t(Math.round(i.loaded/i.total*100))}),s.addEventListener("load",()=>{if(s.status>=200&&s.status<300)try{a(JSON.parse(s.responseText))}catch{o(new Error("Invalid response"))}else o(new Error(`Upload failed: ${s.statusText}`))}),s.addEventListener("error",()=>{o(new Error("Upload failed"))}),s.open("POST","/api/upload"),s.send(n)})}async function gy(e){const t=new FormData;t.append("file",e);const n=await at("/api/upload-extract",{method:"POST",body:t});if(!n.ok)throw new Error("Upload failed");return n.json()}async function vy(){return(await v.get("/api/processing-status")).data}async function fy(e){try{const t=typeof e=="string"?{status:e}:e||{},n=new URLSearchParams;t.status&&t.status!=="all"&&n.set("status",t.status),t.type&&t.type!=="all"&&n.set("type",t.type),t.search&&n.set("search",t.search),t.sort&&n.set("sort",t.sort),t.order&&n.set("order",t.order),t.limit&&n.set("limit",String(t.limit)),t.offset&&n.set("offset",String(t.offset));const s=n.toString(),a=s?`/api/documents?${s}`:"/api/documents",o=await v.get(a);return{documents:o.data.documents||[],total:o.data.total||0,limit:o.data.limit,offset:o.data.offset,hasMore:o.data.hasMore,statuses:o.data.statuses||{processed:0,pending:0,failed:0,deleted:0}}}catch{return{documents:[],total:0,statuses:{processed:0,pending:0,failed:0,deleted:0}}}}async function hy(e){try{return(await v.get(`/api/documents/${e}`)).data.document}catch{return null}}async function by(e,t){const n=t?.softDelete?"?soft=true":"";await v.delete(`/api/documents/${e}${n}`)}async function yy(e){await v.post(`/api/documents/${e}/restore`),m.success("Document restored")}async function wy(e){await v.post(`/api/documents/${e}/reprocess`),m.info("Document queued for reprocessing")}async function ky(e){return(await v.get(`/api/documents/${e}/summary`)).data.summary||""}async function xy(e){try{const t=e?`/api/knowledge?category=${e}`:"/api/knowledge";return(await v.get(t)).data.items||[]}catch{return[]}}async function $y(e,t){const n=await v.post("/api/knowledge",{content:e,category:t});return n.data.item||{id:n.data.id,content:e,category:t,created_at:new Date().toISOString()}}async function Sy(e,t=10){return(await v.get(`/api/knowledge/search?q=${encodeURIComponent(e)}&limit=${t}`)).data.results||[]}async function Cy(){try{return(await v.get("/api/conversations")).data.conversations||[]}catch{return[]}}async function qd(e){try{return(await v.get(`/api/conversations/${e}`)).data.conversation}catch{return null}}async function _y(e){return(await v.post("/api/conversations/parse",{text:e})).data}async function Ly(e,t){return(await v.post("/api/conversations",{text:e,...t})).data.conversation}async function Ty(e){await v.delete(`/api/conversations/${e}`)}async function Ay(e){await v.post(`/api/conversations/${e}/reembed`)}async function My(e){return(await v.post("/api/documents/bulk/delete",{ids:e})).data}async function Ey(e){return(await v.post("/api/documents/bulk/reprocess",{ids:e})).data}async function Wp(e,t="original"){const n=await at("/api/documents/bulk/export",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e,format:t})});if(!n.ok)throw new Error("Failed to export documents");return n.blob()}async function qy(e,t="original"){const n=await Wp(e,t),s=URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download=`documents_export_${Date.now()}.zip`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}const Cs={upload:my,uploadWithExtraction:gy,getProcessingStatus:vy,getAll:fy,get:hy,delete:by,restore:yy,reprocess:wy,getSummary:ky,bulkDelete:My,bulkReprocess:Ey,bulkExport:Wp,downloadBulkExport:qy};async function jy(){try{return(await v.get("/api/knowledge/status")).data.status}catch{return{total:0,embedded:0,pending:0,models:[]}}}async function Py(){return(await v.get("/api/knowledge/export?format=markdown")).data.markdown||""}async function Dy(){return(await v.get("/api/knowledge/export?format=json")).data.items||[]}async function zy(){return(await v.post("/api/knowledge/regenerate")).data}async function Iy(e){return(await v.post("/api/knowledge/synthesize",{topic:e})).data}const _a={getAll:xy,add:$y,search:Sy,getStatus:jy,exportMarkdown:Py,exportJson:Dy,regenerate:zy,synthesize:Iy},pa={getAll:Cy,get:qd,getById:qd,parsePreview:_y,import:Ly,delete:Ty,reembed:Ay};async function Hy(e){try{const t=new URLSearchParams;e?.folder&&t.set("folder",e.folder),e?.label&&t.set("label",e.label),e?.unread&&t.set("unread","true"),e?.starred&&t.set("starred","true"),e?.search&&t.set("search",e.search),e?.limit&&t.set("limit",String(e.limit)),e?.offset&&t.set("offset",String(e.offset));const n=t.toString(),s=n?`/api/emails?${n}`:"/api/emails";return(await v.get(s)).data}catch{return{emails:[],total:0}}}async function Kp(e){try{return(await v.get(`/api/emails/${e}`)).data.email}catch{return null}}async function By(e){try{return(await v.get(`/api/emails/thread/${e}`)).data.thread}catch{return null}}async function Ry(e){await v.put(`/api/emails/${e}/read`)}async function Ny(e){await v.put(`/api/emails/${e}/unread`)}async function Oy(e){await v.put(`/api/emails/${e}/star`)}async function Fy(e){await v.put(`/api/emails/${e}/unstar`)}async function Uy(e){await v.put(`/api/emails/${e}/archive`)}async function Vy(e){await v.delete(`/api/emails/${e}`)}async function Gy(e){return(await v.post("/api/emails/send",e)).data}async function Zy(e){return(await v.post("/api/emails/draft",e)).data}async function Qp(e,t){return(await v.post(`/api/emails/${e}/ai-response`,{tone:t})).data.suggestions||[]}async function Wy(e){return(await v.post(`/api/emails/${e}/summarize`)).data.summary||""}async function Ky(e){return(await v.post(`/api/emails/${e}/categorize`)).data}async function Qy(){return(await v.get("/api/emails/stats")).data}async function Jy(){return(await v.post("/api/emails/sync")).data}async function Yy(e){return Kp(e)}async function Xy(){try{return(await v.get("/api/emails?requires_response=true&response_sent=false")).data.emails||[]}catch{return[]}}async function e0(e){await v.put(`/api/emails/${e}/responded`)}async function t0(e,t){return Qp(e,t)}const ma={getAll:Hy,get:Kp,getById:Yy,getThread:By,markAsRead:Ry,markAsUnread:Ny,star:Oy,unstar:Fy,archive:Uy,delete:Vy,send:Gy,saveDraft:Zy,generateAIResponse:Qp,generateResponse:t0,generateSummary:Wy,categorize:Ky,getStats:Qy,sync:Jy,getNeedingResponse:Xy,markResponded:e0};async function n0(e){try{const t=new URLSearchParams;e?.types?.length&&t.set("types",e.types.join(",")),e?.limit&&t.set("limit",String(e.limit)),e?.communityId!==void 0&&t.set("communityId",String(e.communityId));const n=await v.get(`/api/graph/nodes?${t.toString()}`),s=await v.get(`/api/graph/relationships?${t.toString()}`),a=n.data.nodes||n.data.results?.map(r=>{const c=r;return{id:String(c.id||c.nodeId||""),label:String(c.name||c.label||c.title||c.content?.substring(0,50)||""),name:String(c.name||""),type:String(c.type||c.label||"Unknown"),avatarUrl:c.avatarUrl||c.avatar_url||c.photoUrl||c.photo_url,role:c.role,organization:c.organization,properties:c}})||[],i=(s.data.relationships||s.data.results||[]).map(r=>{const c=r;return{id:String(c.id||`${c.from||c.source}-${c.to||c.target}-${c.type}`),source:String(c.from||c.source||""),target:String(c.to||c.target||""),label:String(c.type||c.label||""),type:String(c.type||"")}});return{nodes:a,edges:i}}catch(t){return console.error("[GraphService] getVisualizationData error:",t),{nodes:[],edges:[]}}}async function s0(){try{const e=await v.get("/api/graph/status");return e.data.stats?{...e.data.stats,graphName:e.data.graphName,connected:e.data.connected}:{nodeCount:e.data.nodes||0,edgeCount:e.data.relationships||0,graphName:e.data.graphName,connected:e.data.connected}}catch{return{nodeCount:0,edgeCount:0,connected:!1}}}async function a0(e){try{const t=new URLSearchParams;e?.type&&t.set("type",e.type),e?.depth&&t.set("depth",String(e.depth)),e?.limit&&t.set("limit",String(e.limit));const n=t.toString(),s=n?`/api/graph?${n}`:"/api/graph";return(await v.get(s)).data}catch{return{nodes:[],edges:[]}}}async function i0(e,t=2){try{return(await v.get(`/api/graph/entity/${e}?depth=${t}`)).data}catch{return{nodes:[],edges:[]}}}async function o0(e){try{return(await v.get(`/api/graph/related/${e}`)).data.related||[]}catch{return[]}}async function Jp(){try{return(await v.get("/api/ontology/schema")).data.schema||null}catch{return null}}async function r0(){try{return(await v.get("/api/ontology/entities")).data.entityTypes||[]}catch{return[]}}async function c0(){try{return(await v.get("/api/ontology/relations")).data.relationTypes||[]}catch{return[]}}async function l0(){try{return(await v.get("/api/ontology/suggestions")).data.suggestions||[]}catch{return[]}}async function d0(e){try{return(await v.post(`/api/ontology/suggestions/${e}/approve`,{})).data.ok}catch{return!1}}async function u0(e){try{return(await v.post(`/api/ontology/suggestions/${e}/reject`,{})).data.ok}catch{return!1}}async function p0(){try{return(await v.get("/api/ontology/stats")).data.stats||null}catch{return null}}async function m0(){try{return(await v.get("/api/ontology/sync/status")).data.status||null}catch{return null}}async function g0(){try{return(await v.post("/api/ontology/sync/force",{})).data}catch(e){return{ok:!1,error:String(e)}}}async function v0(){try{const e=await v.post("/api/ontology/analyze",{});return e.data.ok?e.data:null}catch{return null}}async function f0(e=.85){try{const t=await v.post("/api/ontology/suggestions/auto-approve",{threshold:e});return{approved:t.data.approved||0,skipped:t.data.skipped||0}}catch{return{approved:0,skipped:0}}}async function h0(e={}){try{const t=new URLSearchParams;return e.targetType&&t.append("targetType",e.targetType),e.targetName&&t.append("targetName",e.targetName),e.limit&&t.append("limit",String(e.limit)),(await v.get(`/api/ontology/changes?${t.toString()}`)).data.changes||[]}catch{return[]}}async function b0(){try{return(await v.post("/api/ontology/migrate",{})).data}catch(e){return{success:!1,error:String(e)}}}async function y0(){try{const e=await v.get("/api/ontology/worker/status");return e.data.ok?{status:e.data.status,stats:e.data.stats}:null}catch{return null}}async function w0(e,t={}){try{const n=await v.post("/api/ontology/worker/trigger",{type:e,config:t});return n.data.ok?n.data:null}catch{return null}}async function k0(e={}){try{const t=new URLSearchParams;return e.type&&t.append("type",e.type),e.status&&t.append("status",e.status),e.limit&&t.append("limit",String(e.limit)),(await v.get(`/api/ontology/worker/log?${t.toString()}`)).data.log||[]}catch{return[]}}async function x0(){try{return(await v.get("/api/ontology/jobs")).data.jobs||[]}catch{return[]}}async function $0(e,t){try{const n=await v.post(`/api/ontology/jobs/${e}/toggle`,{enabled:t});return n.data.ok?n.data.job:null}catch{return null}}async function S0(){try{return(await v.get("/api/ontology/extract-from-graph")).data}catch{return{ok:!1,error:"Failed to extract ontology"}}}async function C0(){try{const e=await v.get("/api/ontology/validate-compliance");return e.data.ok?e.data:null}catch{return null}}async function _0(){try{const e=await v.get("/api/ontology/diff");return e.data.ok?{diff:e.data.diff,extractedOntology:e.data.extractedOntology}:null}catch{return null}}async function L0(){try{return(await v.get("/api/ontology/unused-types")).data.unused||{entities:[],relations:[]}}catch{return{entities:[],relations:[]}}}async function T0(e){try{return(await v.post("/api/ontology/merge",e)).data}catch{return{ok:!1}}}async function A0(e){try{return(await v.post("/api/ontology/cleanup",e)).data}catch{return{ok:!1}}}async function M0(){try{const e=await v.get("/api/graph/falkordb-browser");return e.data.ok?e.data:null}catch{return null}}async function E0(){try{return(await v.get("/api/graph/list-all")).data}catch{return{ok:!1,graphs:[]}}}async function q0(e=!1){try{return(await v.post("/api/graph/sync-projects",{dryRun:e})).data}catch{return{ok:!1,error:"Request failed",graphs:[],validGraphs:[],orphanGraphs:[],deleted:[],dryRun:e}}}async function j0(e){try{return(await v.delete(`/api/graph/delete/${encodeURIComponent(e)}`)).data}catch{return{ok:!1,error:"Request failed"}}}async function P0(){try{return(await v.get("/api/graphrag/communities")).data.communities||[]}catch{return[]}}async function D0(){try{return(await v.get("/api/graphrag/centrality")).data.centrality||{topNodes:[]}}catch{return{topNodes:[]}}}async function z0(){try{return(await v.get("/api/graphrag/bridges")).data.bridges||[]}catch{return[]}}async function I0(){try{return(await v.get("/api/graph/insights")).data.insights||[]}catch{return[]}}async function H0(e,t){try{return(await v.post("/api/graphrag/query",{query:e,noCache:t?.noCache})).data}catch{return{ok:!1,answer:"Failed to process query",sources:[],queryType:"hybrid",latencyMs:0}}}function B0(e,t,n,s){const a=new AbortController;return at("/api/graphrag/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e}),signal:a.signal}).then(async o=>{if(!o.ok)throw new Error("Stream request failed");const i=o.body?.getReader();if(!i)throw new Error("No reader available");const r=new TextDecoder;let c="";for(;;){const{done:l,value:u}=await i.read();if(l)break;const g=r.decode(u,{stream:!0}).split(`
`);for(const f of g)if(f.startsWith("data: ")){const h=f.slice(6);if(h==="[DONE]"){n({ok:!0,answer:c,sources:[],queryType:"hybrid",latencyMs:0});return}try{const k=JSON.parse(h);k.content&&(c+=k.content,t(k.content))}catch{c+=h,t(h)}}}}).catch(o=>{o.name!=="AbortError"&&s(o)}),()=>a.abort()}async function R0(e){try{return(await v.post("/api/graphrag/multihop",{query:e})).data}catch{return{answer:"Failed to process multi-hop query",reasoningChain:[],confidence:0}}}async function N0(e,t){try{return(await v.post("/api/graphrag/explain",{nodeId1:e,nodeId2:t})).data}catch{return{explanation:"Unable to explain connection",paths:[],facts:[]}}}async function O0(e){try{return(await v.post("/api/graphrag/summarize",{nodeIds:e})).data}catch{return{summary:"Unable to generate summary",insights:[],suggestedActions:[]}}}async function F0(e){try{return(await v.post("/api/graphrag/filter",{filterText:e})).data}catch{return{filters:{},explanation:"Unable to parse filter"}}}async function U0(e){try{return(await v.post("/api/graphrag/suggest-related",{nodeId:e})).data.suggestions||[]}catch{return[]}}async function V0(e){try{return(await v.post("/api/graph/query",{cypher:e})).data}catch(t){return{ok:!1,results:[],error:t instanceof Error?t.message:"Query failed"}}}async function G0(){try{const e=await Jp();return e?.queryPatterns?Object.entries(e.queryPatterns).map(([t,n])=>({id:t,name:t.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase()),description:n.description,cypher:n.cypher,category:"ontology"})):[]}catch{return[]}}async function Z0(){try{return(await v.get("/api/graph/projects")).data.graphs||[]}catch{return[]}}async function W0(e){try{return(await v.get(`/api/graph/cross-project/${e}`)).data.entities||[]}catch{return[]}}async function K0(e){try{return(await v.post("/api/graph/queries",e)).data.query||null}catch{return null}}async function Q0(e){try{const t=new URLSearchParams;return e?.limit&&t.set("limit",String(e.limit)),e?.favoritesOnly&&t.set("favorites","true"),(await v.get(`/api/graph/queries?${t.toString()}`)).data.queries||[]}catch{return[]}}async function J0(e){try{return(await v.patch(`/api/graph/queries/${e}/favorite`,{})).data.ok}catch{return!1}}async function Y0(e){try{return(await v.delete(`/api/graph/queries/${e}`)).data.ok}catch{return!1}}async function X0(e){try{return(await v.post("/api/graph/views",e)).data.view||null}catch{return null}}async function e1(){try{return(await v.get("/api/graph/views")).data.views||[]}catch{return[]}}async function t1(e,t){try{return(await v.patch(`/api/graph/views/${e}`,t)).data.ok}catch{return!1}}async function n1(e){try{return(await v.delete(`/api/graph/views/${e}`)).data.ok}catch{return!1}}async function s1(e){try{return(await v.post("/api/graph/bookmarks",e)).data.bookmark||null}catch{return null}}async function a1(){try{return(await v.get("/api/graph/bookmarks")).data.bookmarks||[]}catch{return[]}}async function i1(e,t){try{return(await v.patch(`/api/graph/bookmarks/${e}`,t)).data.ok}catch{return!1}}async function o1(e){try{return(await v.delete(`/api/graph/bookmarks/${e}`)).data.ok}catch{return!1}}async function r1(e){try{return(await v.post("/api/graph/annotations",e)).data.annotation||null}catch{return null}}async function c1(e){try{const t=new URLSearchParams;return e?.targetType&&t.set("targetType",e.targetType),e?.targetId&&t.set("targetId",e.targetId),e?.includeShared&&t.set("includeShared","true"),(await v.get(`/api/graph/annotations?${t.toString()}`)).data.annotations||[]}catch{return[]}}async function l1(e,t){try{return(await v.patch(`/api/graph/annotations/${e}`,t)).data.ok}catch{return!1}}async function d1(e){try{return(await v.delete(`/api/graph/annotations/${e}`)).data.ok}catch{return!1}}async function u1(e){try{return(await v.post("/api/graph/chat",e)).data.message||null}catch{return null}}async function p1(){try{return(await v.get("/api/graph/chat/sessions")).data.sessions||[]}catch{return[]}}async function m1(e){try{return(await v.get(`/api/graph/chat/session/${e}`)).data.messages||[]}catch{return[]}}async function g1(e){try{return(await v.patch(`/api/graph/chat/${e}/pin`,{})).data.ok}catch{return!1}}async function v1(e){try{return(await v.post("/api/graph/snapshots",e)).data.snapshot||null}catch{return null}}async function f1(){try{return(await v.get("/api/graph/snapshots")).data.snapshots||[]}catch{return[]}}async function h1(e){try{return(await v.get(`/api/graph/snapshots/${e}`)).data.snapshot||null}catch{return null}}async function b1(e,t){try{return(await v.get(`/api/graph/snapshots/compare?id1=${e}&id2=${t}`)).data}catch{return{diff:{nodesAdded:[],nodesRemoved:[],edgesAdded:[],edgesRemoved:[],statsComparison:{nodeCountDiff:0,edgeCountDiff:0}}}}}async function y1(e){try{return(await v.delete(`/api/graph/snapshots/${e}`)).data.ok}catch{return!1}}async function xc(e){try{const t=new URLSearchParams;e?.startDate&&t.set("startDate",e.startDate),e?.endDate&&t.set("endDate",e.endDate),e?.types?.length&&t.set("types",e.types.join(",")),e?.limit&&t.set("limit",String(e.limit));const n=t.toString(),s=n?`/api/timeline?${n}`:"/api/timeline",a=await v.get(s),i=(a.data.events||[]).map(r=>({id:String(r.id??""),date:String(r.date??""),title:String(r.title??""),description:r.content!=null?String(r.content):void 0,content:r.content!=null?String(r.content):void 0,type:r.type??"document",entity_id:r.entity_id!=null?String(r.entity_id):void 0,entity_type:r.entity_type!=null?String(r.entity_type):void 0,metadata:r.metadata??void 0,user:r.owner!=null?String(r.owner):r.user,actor:r.owner!=null?String(r.owner):r.actor,owner:r.owner!=null?String(r.owner):void 0,icon:r.icon,color:r.color,status:r.status}));return{events:i,totalEvents:a.data.totalEvents??i.length,startDate:a.data.startDate??"",endDate:a.data.endDate??""}}catch{return{events:[],startDate:"",endDate:"",totalEvents:0}}}async function w1(e,t){try{return(await v.get(`/api/timeline/${e}/${t}`)).data.events||[]}catch{return[]}}async function k1(e){try{const t=new URLSearchParams;e?.startDate&&t.set("startDate",e.startDate),e?.endDate&&t.set("endDate",e.endDate),e?.provider&&t.set("provider",e.provider),e?.model&&t.set("model",e.model);const n=t.toString(),s=n?`/api/costs?${n}`:"/api/costs";return(await v.get(s)).data.costs||[]}catch{return[]}}async function x1(e){try{const t=e?`/api/costs/summary?period=${e}`:"/api/costs/summary",s=(await v.get(t)).data;if(!s)return{total:0,byProvider:{},byModel:{},byOperation:{},period:{start:"",end:""},dailyBreakdown:[]};const o=(s.dailyBreakdown??s.daily_breakdown??[]).map(i=>({date:i.date,cost:typeof i.cost=="number"?i.cost:parseFloat(String(i.cost))||0,calls:i.calls??i.requests??0}));return{total:typeof s.total=="number"?s.total:parseFloat(String(s.total))||0,byProvider:s.byProvider??s.by_provider??{},byModel:s.byModel??s.by_model??{},byOperation:s.byOperation??s.by_operation??{},byContext:s.byContext??s.by_context,period:s.period??{start:"",end:""},dailyBreakdown:o,totalInputTokens:s.totalInputTokens??s.total_input_tokens,totalOutputTokens:s.totalOutputTokens??s.total_output_tokens,previousPeriodCost:s.previousPeriodCost??s.previous_period_cost,percentChange:s.percentChange??s.percent_change,budgetLimit:s.budgetLimit??s.budget_limit,budgetUsedPercent:s.budgetUsedPercent??s.budget_used_percent,budgetAlertTriggered:s.budgetAlertTriggered??s.budget_alert_triggered}}catch{return{total:0,byProvider:{},byModel:{},byOperation:{},period:{start:"",end:""},dailyBreakdown:[]}}}async function $1(e=20){try{return(await v.get(`/api/costs/recent?limit=${e}`)).data?.requests??[]}catch{return[]}}async function S1(){try{return(await v.get("/api/costs/pricing")).data?.pricing??[]}catch{return[]}}async function C1(e){try{const n=(await v.get(`/api/costs/budget?period=${e}`)).data?.budget;if(!n)return null;const s=n.limitUsd??n.limit_usd,a=n.alertThresholdPercent??n.alert_threshold_percent;return s==null||!Number.isFinite(Number(s))?null:{period:n.period??e,limitUsd:Number(s),alertThresholdPercent:a!=null?Math.min(100,Math.max(0,Number(a))):80,notifiedAt:n.notifiedAt??n.notified_at}}catch{return null}}async function _1(e,t,n){await v.post("/api/costs/budget",{period:e,limitUsd:t,alertThresholdPercent:n})}async function L1(){try{return(await v.get("/api/llm/config")).data}catch{return{provider:"unknown",model:"unknown",available:[]}}}const Cl={getVisualizationData:n0,getStats:s0,getGraph:a0,getEntityGraph:i0,getRelated:o0,getOntologySchema:Jp,getOntologyEntities:r0,getOntologyRelations:c0,getOntologySuggestions:l0,approveOntologySuggestion:d0,rejectOntologySuggestion:u0,getOntologyTypeStats:p0,getOntologySyncStatus:m0,forceOntologySync:g0,runLLMAnalysis:v0,autoApproveHighConfidence:f0,getOntologyChanges:h0,migrateOntologyToSupabase:b0,getBackgroundWorkerStatus:y0,triggerBackgroundAnalysis:w0,getBackgroundWorkerLog:k0,getOntologyJobs:x0,toggleOntologyJob:$0,extractOntologyFromGraph:S0,validateOntologyCompliance:C0,getOntologyDiff:_0,findUnusedOntologyTypes:L0,mergeOntology:T0,cleanupOntology:A0,getFalkorDBBrowserInfo:M0,listAllFalkorDBGraphs:E0,syncFalkorDBGraphs:q0,deleteFalkorDBGraph:j0,getCommunities:P0,getCentrality:D0,getBridges:z0,getInsights:I0,query:H0,stream:B0,multiHop:R0,explainConnection:N0,summarizeSelection:O0,naturalLanguageFilter:F0,suggestRelated:U0,executeCypher:V0,getQueryTemplates:G0,getProjectGraphs:Z0,getCrossProjectEntities:W0,saveQueryHistory:K0,getQueryHistory:Q0,toggleQueryFavorite:J0,deleteQueryHistory:Y0,saveView:X0,getSavedViews:e1,updateView:t1,deleteView:n1,addBookmark:s1,getBookmarks:a1,updateBookmark:i1,removeBookmark:o1,createAnnotation:r1,getAnnotations:c1,updateAnnotation:l1,deleteAnnotation:d1,saveChatMessage:u1,getChatSessions:p1,getChatHistory:m1,toggleChatPin:g1,createSnapshot:v1,getSnapshots:f1,getSnapshot:h1,compareSnapshots:b1,deleteSnapshot:y1},Yp={getAll:xc,getTimeline:xc,getForEntity:w1},La={getAll:k1,getSummary:x1,getRecentRequests:$1,getPricing:S1,getBudget:C1,setBudget:_1,getLLMConfig:L1};async function T1(e){try{const t=new URLSearchParams;e?.unread&&t.set("unread","true"),e?.type&&t.set("type",e.type),e?.limit&&t.set("limit",String(e.limit));const n=t.toString(),s=n?`/api/notifications?${n}`:"/api/notifications";return(await v.get(s)).data.notifications||[]}catch{return[]}}async function A1(){try{return(await v.get("/api/notifications/count")).data.count||0}catch{return 0}}async function jd(e){await v.post(`/api/notifications/${e}/read`)}async function Pd(){await v.post("/api/notifications/read-all")}async function M1(e){await v.delete(`/api/notifications/${e}`)}async function E1(e,t){try{return(await v.get(`/api/comments/${e}/${t}`)).data.comments||[]}catch{return[]}}async function Xp(e,t,n,s){const a=await v.post(`/api/comments/${e}/${t}`,{content:n,parentId:s});return a.data.comment||{id:a.data.id,entity_type:e,entity_id:t,content:n,author:"You",created_at:new Date().toISOString(),is_edited:!1}}async function q1(e,t){await v.put(`/api/comments/${e}`,{content:t})}async function j1(e){await v.delete(`/api/comments/${e}`)}async function P1(e,t){await v.post(`/api/comments/${e}/react`,{emoji:t})}async function D1(e,t){await v.delete(`/api/comments/${e}/react/${t}`)}async function z1(e,t,n,s){return Xp(e,t,n,s)}async function I1(e){await v.put(`/api/comments/${e}/resolve`)}async function H1(e){try{const t=e?`/api/projects/${e}/members`:"/api/project/members";return(await v.get(t)).data.members||[]}catch{return[]}}async function B1(e,t,n){const s=n?`/api/projects/${n}/members`:"/api/project/members";return(await v.post(s,{email:e,role:t})).data}async function R1(e,t,n){const s=n?`/api/projects/${n}/members/${e}`:`/api/project/members/${e}`;await v.put(s,{role:t})}async function N1(e,t){const n=t?`/api/projects/${t}/members/${e}`:`/api/project/members/${e}`;await v.delete(n)}const Ta={getAll:T1,getUnreadCount:A1,markAsRead:jd,markRead:jd,markAllAsRead:Pd,markAllRead:Pd,delete:M1},ga={getAll:E1,add:Xp,create:z1,update:q1,delete:j1,addReaction:P1,removeReaction:D1,resolve:I1};async function O1(e){try{const t=e?`/api/projects/${e}/invites`:"/api/project/invites";return(await v.get(t)).data.invites||[]}catch{return[]}}const Ni={getAll:H1,invite:B1,updateRole:R1,remove:N1,getInvites:O1};async function F1(){try{return(await v.get("/api/settings")).data}catch{return{}}}async function U1(e){await v.put("/api/settings",e)}async function V1(e){try{const t=e?`/api/projects/${e}/settings`:"/api/project/settings";return(await v.get(t)).data.settings}catch{return null}}async function G1(e,t){const n=t?`/api/projects/${t}/settings`:"/api/project/settings";await v.put(n,e)}async function Z1(){try{return(await v.get("/api/api-keys")).data.keys||[]}catch{return[]}}async function W1(e,t){return(await v.post("/api/api-keys",{name:e,permissions:t})).data}async function K1(e){await v.delete(`/api/api-keys/${e}`)}async function Q1(){try{return(await v.get("/api/webhooks")).data.webhooks||[]}catch{return[]}}async function J1(e){const t=await v.post("/api/webhooks",e);return t.data.webhook||{...e,id:t.data.id,is_active:!0,failure_count:0,created_at:new Date().toISOString()}}async function Y1(e,t){await v.put(`/api/webhooks/${e}`,t)}async function X1(e){await v.delete(`/api/webhooks/${e}`)}async function ew(e){return(await v.post(`/api/webhooks/${e}/test`)).data}async function tw(e){try{const t=new URLSearchParams;e?.action&&t.set("action",e.action),e?.entity_type&&t.set("entity_type",e.entity_type),e?.user_id&&t.set("user_id",e.user_id),e?.startDate&&t.set("startDate",e.startDate),e?.endDate&&t.set("endDate",e.endDate),e?.limit&&t.set("limit",String(e.limit)),e?.offset&&t.set("offset",String(e.offset));const n=t.toString(),s=n?`/api/audit?${n}`:"/api/audit";return(await v.get(s)).data}catch{return{logs:[],total:0}}}async function nw(e,t){const n=new URLSearchParams;n.set("format",e),t?.startDate&&n.set("startDate",t.startDate),t?.endDate&&n.set("endDate",t.endDate);const s=await at(`/api/audit/export?${n.toString()}`);if(!s.ok)throw new Error("Export failed");return s.blob()}const sw={get:F1,update:U1},aw={get:V1,update:G1},iw={getAll:Z1,create:W1,revoke:K1},ow={getAll:Q1,create:J1,update:Y1,delete:X1,test:ew},rw={getAll:tw,export:nw};async function cw(){try{return(await v.get("/api/profile")).data.profile}catch{return null}}async function lw(e){const t=await v.put("/api/profile",e),n=N.getState().currentUser;return n&&N.setCurrentUser({...n,name:e.display_name||n.name,avatar:e.avatar_url||n.avatar}),t.data.profile}async function dw(e){const t=new FormData;t.append("avatar",e);const n=await at("/api/profile/avatar",{method:"POST",body:t});if(!n.ok)throw new Error("Avatar upload failed");const s=await n.json(),a=N.getState().currentUser;return a&&N.setCurrentUser({...a,avatar:s.avatar_url}),s.avatar_url}async function uw(){await v.delete("/api/profile/avatar");const e=N.getState().currentUser;e&&N.setCurrentUser({...e,avatar:void 0})}async function pw(e){if(e.new_password.length<12)throw new Error("New password must be at least 12 characters");await v.post("/api/profile/change-password",e)}async function mw(e){await v.post("/api/profile/delete",{password:e}),N.setCurrentUser(null),N.setCurrentProject(null)}async function gw(e=50){try{return(await v.get(`/api/profile/activity?limit=${e}`)).data.activities||[]}catch{return[]}}async function vw(){try{return(await v.get("/api/profile/sessions")).data.sessions||[]}catch{return[]}}async function fw(e){await v.delete(`/api/profile/sessions/${e}`)}async function hw(){await v.post("/api/profile/sessions/revoke-all")}const Kn={get:cw,update:lw,uploadAvatar:dw,removeAvatar:uw,changePassword:pw,deleteAccount:mw,getActivity:gw,getSessions:vw,revokeSession:fw,revokeAllSessions:hw};async function Qi(e){try{const t=new URLSearchParams;e?.limit&&t.set("limit",String(e.limit)),e?.offset&&t.set("offset",String(e.offset)),e?.search&&t.set("search",e.search),e?.category&&t.set("category",e.category),e?.verified!==void 0&&t.set("verified",String(e.verified));const n=t.toString(),s=n?`/api/facts?${n}`:"/api/facts",a=await v.get(s);return{facts:a.data.facts||[],total:a.data.total||a.data.facts?.length||0}}catch{return{facts:[],total:0}}}async function em(e){try{return(await v.get(`/api/facts/${e}`)).data.fact}catch{return null}}async function tm(e){const t=await v.post("/api/facts",e);return t.data.fact||{...e,id:t.data.id,created_at:new Date().toISOString()}}async function _l(e,t){return(await v.put(`/api/facts/${e}`,t)).data.fact}async function $c(e){await v.delete(`/api/facts/${e}`)}async function nm(){try{return(await v.get("/api/facts/deleted")).data.facts||[]}catch{return[]}}async function sm(e){return(await v.post(`/api/facts/${e}/restore`,{})).data.fact}async function Sc(e){return _l(e,{verified:!0})}async function am(){return(await v.post("/api/fact-check/run",{})).data}async function im(){try{return(await v.get("/api/conflicts")).data.conflicts||[]}catch{return[]}}async function om(){try{const{facts:e}=await Qi({limit:1e3}),t={};return e.forEach(n=>{const s=n.category||"Uncategorized";t[s]||(t[s]=[]),t[s].push(n)}),t}catch{return{}}}async function rm(){try{const{facts:e}=await Qi({limit:1e3}),t={};return e.forEach(n=>{const s=n.source_file||n.source||"Unknown source";t[s]||(t[s]=[]),t[s].push(n)}),t}catch{return{}}}async function cm(e){try{const t=new URLSearchParams({document_id:e});return(await v.get(`/api/facts?${t}`)).data.facts||[]}catch{return[]}}async function lm(e){try{return(await v.get(`/api/facts/${e}/events`)).data.events||[]}catch{return[]}}async function dm(e,t=10){try{const n=new URLSearchParams;t!==10&&n.set("limit",String(t));const s=n.toString(),a=s?`/api/facts/${e}/similar?${s}`:`/api/facts/${e}/similar`;return(await v.get(a)).data.similar||[]}catch{return[]}}async function um(e,t=20){const{facts:n}=await Qi({search:e,limit:t});return n}function pm(e){const t={total:e.length,verified:e.filter(n=>n.verified).length,unverified:e.filter(n=>!n.verified).length,byCategory:{}};return e.forEach(n=>{const s=n.category||"Uncategorized";t.byCategory[s]=(t.byCategory[s]||0)+1}),t}const nt={getAll:Qi,get:em,create:tm,update:_l,delete:$c,deleteFact:$c,verify:Sc,verifyFact:Sc,detectConflicts:im,getByCategory:om,getBySource:rm,getByDocument:cm,getEvents:lm,getSimilarFacts:dm,search:um,getStats:pm,getDeletedFacts:nm,restoreFact:sm,runFactCheck:am},bw=Object.freeze(Object.defineProperty({__proto__:null,createFact:tm,deleteFact:$c,detectConflicts:im,factsService:nt,getDeletedFacts:nm,getFact:em,getFactEvents:lm,getFactStats:pm,getFacts:Qi,getFactsByCategory:om,getFactsByDocument:cm,getFactsBySource:rm,getSimilarFacts:dm,restoreFact:sm,runFactCheck:am,searchFacts:um,updateFact:_l,verifyFact:Sc},Symbol.toStringTag,{value:"Module"}));async function Dd(){try{return(await v.get("/api/krisp/webhook")).data.webhook}catch{return null}}async function yw(){try{return(await v.post("/api/krisp/webhook/regenerate")).data.webhook}catch{return null}}async function ww(e){try{return await v.put("/api/krisp/webhook/toggle",{is_active:e}),!0}catch{return!1}}async function kw(e={}){const t=new URLSearchParams;e.status&&(Array.isArray(e.status)?t.append("status",e.status.join(",")):t.append("status",e.status)),e.projectId&&t.append("project_id",e.projectId),e.limit&&t.append("limit",String(e.limit)),e.offset&&t.append("offset",String(e.offset));const n=`/api/krisp/transcripts${t.toString()?`?${t}`:""}`;return(await v.get(n)).data.transcripts}async function xw(){try{return(await v.get("/api/krisp/transcripts/summary")).data.summary}catch{return null}}async function YA(e,t){try{return await v.post(`/api/krisp/transcripts/${e}/assign`,{project_id:t}),!0}catch{return!1}}async function XA(e,t){try{return await v.post(`/api/krisp/transcripts/${e}/skip`,{reason:t}),!0}catch{return!1}}async function eM(e){try{return await v.post(`/api/krisp/transcripts/${e}/retry`),!0}catch{return!1}}async function tM(e){try{return await v.post(`/api/krisp/transcripts/${e}/process`),!0}catch{return!1}}async function nM(){try{return(await v.get("/api/krisp/mappings")).data.mappings}catch{return[]}}async function sM(e){try{return await v.delete(`/api/krisp/mappings/${e}`),!0}catch{return!1}}async function aM(e,t={}){try{return(await v.post(`/api/krisp/transcripts/${e}/summary`,{forceRegenerate:t.forceRegenerate||!1})).data.summary}catch{return null}}async function iM(){return kw({status:["quarantine","ambiguous"]})}async function oM(e={}){try{const t=new URLSearchParams;e.limit&&t.set("limit",String(e.limit)),e.offset&&t.set("offset",String(e.offset)),e.showImported===!1&&t.set("showImported","false"),e.startDate&&t.set("startDate",e.startDate),e.endDate&&t.set("endDate",e.endDate),e.search&&t.set("search",e.search);const n=`/api/krisp/available${t.toString()?"?"+t.toString():""}`;return(await v.get(n)).data}catch{return null}}async function rM(e,t){try{return(await v.post("/api/krisp/available/import",{meetingIds:e,projectId:t})).data}catch{return null}}async function cM(e){try{return(await v.post("/api/krisp/available/summary",{meetingId:e})).data}catch{return null}}function lM(e){return{pending:{label:"Pending",color:"blue"},quarantine:{label:"Quarantine",color:"yellow"},ambiguous:{label:"Ambiguous",color:"orange"},matched:{label:"Matched",color:"cyan"},processed:{label:"Processed",color:"green"},failed:{label:"Failed",color:"red"},skipped:{label:"Skipped",color:"gray"}}[e]||{label:e,color:"gray"}}function dM(e){if(!e)return"-";const t=Math.floor(e/60),n=e%60;return t>0?`${t}h ${n}m`:`${n}m`}const{entries:mm,setPrototypeOf:zd,isFrozen:$w,getPrototypeOf:Sw,getOwnPropertyDescriptor:Cw}=Object;let{freeze:Pt,seal:tn,create:Cc}=Object,{apply:_c,construct:Lc}=typeof Reflect<"u"&&Reflect;Pt||(Pt=function(t){return t});tn||(tn=function(t){return t});_c||(_c=function(t,n){for(var s=arguments.length,a=new Array(s>2?s-2:0),o=2;o<s;o++)a[o-2]=arguments[o];return t.apply(n,a)});Lc||(Lc=function(t){for(var n=arguments.length,s=new Array(n>1?n-1:0),a=1;a<n;a++)s[a-1]=arguments[a];return new t(...s)});const to=Dt(Array.prototype.forEach),_w=Dt(Array.prototype.lastIndexOf),Id=Dt(Array.prototype.pop),Ka=Dt(Array.prototype.push),Lw=Dt(Array.prototype.splice),$o=Dt(String.prototype.toLowerCase),Dr=Dt(String.prototype.toString),zr=Dt(String.prototype.match),Qa=Dt(String.prototype.replace),Tw=Dt(String.prototype.indexOf),Aw=Dt(String.prototype.trim),cn=Dt(Object.prototype.hasOwnProperty),Et=Dt(RegExp.prototype.test),Ja=Mw(TypeError);function Dt(e){return function(t){t instanceof RegExp&&(t.lastIndex=0);for(var n=arguments.length,s=new Array(n>1?n-1:0),a=1;a<n;a++)s[a-1]=arguments[a];return _c(e,t,s)}}function Mw(e){return function(){for(var t=arguments.length,n=new Array(t),s=0;s<t;s++)n[s]=arguments[s];return Lc(e,n)}}function Ae(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:$o;zd&&zd(e,null);let s=t.length;for(;s--;){let a=t[s];if(typeof a=="string"){const o=n(a);o!==a&&($w(t)||(t[s]=o),a=o)}e[a]=!0}return e}function Ew(e){for(let t=0;t<e.length;t++)cn(e,t)||(e[t]=null);return e}function Cn(e){const t=Cc(null);for(const[n,s]of mm(e))cn(e,n)&&(Array.isArray(s)?t[n]=Ew(s):s&&typeof s=="object"&&s.constructor===Object?t[n]=Cn(s):t[n]=s);return t}function Ya(e,t){for(;e!==null;){const s=Cw(e,t);if(s){if(s.get)return Dt(s.get);if(typeof s.value=="function")return Dt(s.value)}e=Sw(e)}function n(){return null}return n}const Hd=Pt(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Ir=Pt(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Hr=Pt(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),qw=Pt(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Br=Pt(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),jw=Pt(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Bd=Pt(["#text"]),Rd=Pt(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Rr=Pt(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Nd=Pt(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),no=Pt(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Pw=tn(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Dw=tn(/<%[\w\W]*|[\w\W]*%>/gm),zw=tn(/\$\{[\w\W]*/gm),Iw=tn(/^data-[\-\w.\u00B7-\uFFFF]+$/),Hw=tn(/^aria-[\-\w]+$/),gm=tn(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Bw=tn(/^(?:\w+script|data):/i),Rw=tn(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),vm=tn(/^html$/i),Nw=tn(/^[a-z][.\w]*(-[.\w]+)+$/i);var Od=Object.freeze({__proto__:null,ARIA_ATTR:Hw,ATTR_WHITESPACE:Rw,CUSTOM_ELEMENT:Nw,DATA_ATTR:Iw,DOCTYPE_NAME:vm,ERB_EXPR:Dw,IS_ALLOWED_URI:gm,IS_SCRIPT_OR_DATA:Bw,MUSTACHE_EXPR:Pw,TMPLIT_EXPR:zw});const Xa={element:1,text:3,progressingInstruction:7,comment:8,document:9},Ow=function(){return typeof window>"u"?null:window},Fw=function(t,n){if(typeof t!="object"||typeof t.createPolicy!="function")return null;let s=null;const a="data-tt-policy-suffix";n&&n.hasAttribute(a)&&(s=n.getAttribute(a));const o="dompurify"+(s?"#"+s:"");try{return t.createPolicy(o,{createHTML(i){return i},createScriptURL(i){return i}})}catch{return console.warn("TrustedTypes policy "+o+" could not be created."),null}},Fd=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function fm(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ow();const t=be=>fm(be);if(t.version="3.3.1",t.removed=[],!e||!e.document||e.document.nodeType!==Xa.document||!e.Element)return t.isSupported=!1,t;let{document:n}=e;const s=n,a=s.currentScript,{DocumentFragment:o,HTMLTemplateElement:i,Node:r,Element:c,NodeFilter:l,NamedNodeMap:u=e.NamedNodeMap||e.MozNamedAttrMap,HTMLFormElement:p,DOMParser:g,trustedTypes:f}=e,h=c.prototype,k=Ya(h,"cloneNode"),C=Ya(h,"remove"),x=Ya(h,"nextSibling"),$=Ya(h,"childNodes"),w=Ya(h,"parentNode");if(typeof i=="function"){const be=n.createElement("template");be.content&&be.content.ownerDocument&&(n=be.content.ownerDocument)}let y,S="";const{implementation:P,createNodeIterator:j,createDocumentFragment:H,getElementsByTagName:J}=n,{importNode:B}=s;let Z=Fd();t.isSupported=typeof mm=="function"&&typeof w=="function"&&P&&P.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:O,ERB_EXPR:F,TMPLIT_EXPR:ee,DATA_ATTR:ie,ARIA_ATTR:oe,IS_SCRIPT_OR_DATA:me,ATTR_WHITESPACE:ze,CUSTOM_ELEMENT:re}=Od;let{IS_ALLOWED_URI:Le}=Od,le=null;const te=Ae({},[...Hd,...Ir,...Hr,...Br,...Bd]);let ne=null;const T=Ae({},[...Rd,...Rr,...Nd,...no]);let _=Object.seal(Cc(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),A=null,E=null;const U=Object.seal(Cc(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let M=!0,z=!0,q=!1,I=!0,X=!1,se=!0,Se=!1,fe=!1,we=!1,Te=!1,Oe=!1,an=!1,xn=!0,At=!1;const zt="user-content-";let Y=!0,W=!1,V={},D=null;const G=Ae({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let ae=null;const ue=Ae({},["audio","video","img","source","image","track"]);let $e=null;const Re=Ae({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Mt="http://www.w3.org/1998/Math/MathML",et="http://www.w3.org/2000/svg",ct="http://www.w3.org/1999/xhtml";let os=ct,Ua=!1,qs=null;const eo=Ae({},[Mt,et,ct],Dr);let js=Ae({},["mi","mo","mn","ms","mtext"]),Ft=Ae({},["annotation-xml"]);const Mr=Ae({},["title","style","font","a","script"]);let Va=null;const mf=["application/xhtml+xml","text/html"],gf="text/html";let it=null,Xs=null;const vf=n.createElement("form"),bd=function(L){return L instanceof RegExp||L instanceof Function},Er=function(){let L=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Xs&&Xs===L)){if((!L||typeof L!="object")&&(L={}),L=Cn(L),Va=mf.indexOf(L.PARSER_MEDIA_TYPE)===-1?gf:L.PARSER_MEDIA_TYPE,it=Va==="application/xhtml+xml"?Dr:$o,le=cn(L,"ALLOWED_TAGS")?Ae({},L.ALLOWED_TAGS,it):te,ne=cn(L,"ALLOWED_ATTR")?Ae({},L.ALLOWED_ATTR,it):T,qs=cn(L,"ALLOWED_NAMESPACES")?Ae({},L.ALLOWED_NAMESPACES,Dr):eo,$e=cn(L,"ADD_URI_SAFE_ATTR")?Ae(Cn(Re),L.ADD_URI_SAFE_ATTR,it):Re,ae=cn(L,"ADD_DATA_URI_TAGS")?Ae(Cn(ue),L.ADD_DATA_URI_TAGS,it):ue,D=cn(L,"FORBID_CONTENTS")?Ae({},L.FORBID_CONTENTS,it):G,A=cn(L,"FORBID_TAGS")?Ae({},L.FORBID_TAGS,it):Cn({}),E=cn(L,"FORBID_ATTR")?Ae({},L.FORBID_ATTR,it):Cn({}),V=cn(L,"USE_PROFILES")?L.USE_PROFILES:!1,M=L.ALLOW_ARIA_ATTR!==!1,z=L.ALLOW_DATA_ATTR!==!1,q=L.ALLOW_UNKNOWN_PROTOCOLS||!1,I=L.ALLOW_SELF_CLOSE_IN_ATTR!==!1,X=L.SAFE_FOR_TEMPLATES||!1,se=L.SAFE_FOR_XML!==!1,Se=L.WHOLE_DOCUMENT||!1,Te=L.RETURN_DOM||!1,Oe=L.RETURN_DOM_FRAGMENT||!1,an=L.RETURN_TRUSTED_TYPE||!1,we=L.FORCE_BODY||!1,xn=L.SANITIZE_DOM!==!1,At=L.SANITIZE_NAMED_PROPS||!1,Y=L.KEEP_CONTENT!==!1,W=L.IN_PLACE||!1,Le=L.ALLOWED_URI_REGEXP||gm,os=L.NAMESPACE||ct,js=L.MATHML_TEXT_INTEGRATION_POINTS||js,Ft=L.HTML_INTEGRATION_POINTS||Ft,_=L.CUSTOM_ELEMENT_HANDLING||{},L.CUSTOM_ELEMENT_HANDLING&&bd(L.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(_.tagNameCheck=L.CUSTOM_ELEMENT_HANDLING.tagNameCheck),L.CUSTOM_ELEMENT_HANDLING&&bd(L.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(_.attributeNameCheck=L.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),L.CUSTOM_ELEMENT_HANDLING&&typeof L.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(_.allowCustomizedBuiltInElements=L.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),X&&(z=!1),Oe&&(Te=!0),V&&(le=Ae({},Bd),ne=[],V.html===!0&&(Ae(le,Hd),Ae(ne,Rd)),V.svg===!0&&(Ae(le,Ir),Ae(ne,Rr),Ae(ne,no)),V.svgFilters===!0&&(Ae(le,Hr),Ae(ne,Rr),Ae(ne,no)),V.mathMl===!0&&(Ae(le,Br),Ae(ne,Nd),Ae(ne,no))),L.ADD_TAGS&&(typeof L.ADD_TAGS=="function"?U.tagCheck=L.ADD_TAGS:(le===te&&(le=Cn(le)),Ae(le,L.ADD_TAGS,it))),L.ADD_ATTR&&(typeof L.ADD_ATTR=="function"?U.attributeCheck=L.ADD_ATTR:(ne===T&&(ne=Cn(ne)),Ae(ne,L.ADD_ATTR,it))),L.ADD_URI_SAFE_ATTR&&Ae($e,L.ADD_URI_SAFE_ATTR,it),L.FORBID_CONTENTS&&(D===G&&(D=Cn(D)),Ae(D,L.FORBID_CONTENTS,it)),L.ADD_FORBID_CONTENTS&&(D===G&&(D=Cn(D)),Ae(D,L.ADD_FORBID_CONTENTS,it)),Y&&(le["#text"]=!0),Se&&Ae(le,["html","head","body"]),le.table&&(Ae(le,["tbody"]),delete A.tbody),L.TRUSTED_TYPES_POLICY){if(typeof L.TRUSTED_TYPES_POLICY.createHTML!="function")throw Ja('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof L.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Ja('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');y=L.TRUSTED_TYPES_POLICY,S=y.createHTML("")}else y===void 0&&(y=Fw(f,a)),y!==null&&typeof S=="string"&&(S=y.createHTML(""));Pt&&Pt(L),Xs=L}},yd=Ae({},[...Ir,...Hr,...qw]),wd=Ae({},[...Br,...jw]),ff=function(L){let Q=w(L);(!Q||!Q.tagName)&&(Q={namespaceURI:os,tagName:"template"});const ge=$o(L.tagName),Ge=$o(Q.tagName);return qs[L.namespaceURI]?L.namespaceURI===et?Q.namespaceURI===ct?ge==="svg":Q.namespaceURI===Mt?ge==="svg"&&(Ge==="annotation-xml"||js[Ge]):!!yd[ge]:L.namespaceURI===Mt?Q.namespaceURI===ct?ge==="math":Q.namespaceURI===et?ge==="math"&&Ft[Ge]:!!wd[ge]:L.namespaceURI===ct?Q.namespaceURI===et&&!Ft[Ge]||Q.namespaceURI===Mt&&!js[Ge]?!1:!wd[ge]&&(Mr[ge]||!yd[ge]):!!(Va==="application/xhtml+xml"&&qs[L.namespaceURI]):!1},$n=function(L){Ka(t.removed,{element:L});try{w(L).removeChild(L)}catch{C(L)}},Ps=function(L,Q){try{Ka(t.removed,{attribute:Q.getAttributeNode(L),from:Q})}catch{Ka(t.removed,{attribute:null,from:Q})}if(Q.removeAttribute(L),L==="is")if(Te||Oe)try{$n(Q)}catch{}else try{Q.setAttribute(L,"")}catch{}},kd=function(L){let Q=null,ge=null;if(we)L="<remove></remove>"+L;else{const st=zr(L,/^[\r\n\t ]+/);ge=st&&st[0]}Va==="application/xhtml+xml"&&os===ct&&(L='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+L+"</body></html>");const Ge=y?y.createHTML(L):L;if(os===ct)try{Q=new g().parseFromString(Ge,Va)}catch{}if(!Q||!Q.documentElement){Q=P.createDocument(os,"template",null);try{Q.documentElement.innerHTML=Ua?S:Ge}catch{}}const xt=Q.body||Q.documentElement;return L&&ge&&xt.insertBefore(n.createTextNode(ge),xt.childNodes[0]||null),os===ct?J.call(Q,Se?"html":"body")[0]:Se?Q.documentElement:xt},xd=function(L){return j.call(L.ownerDocument||L,L,l.SHOW_ELEMENT|l.SHOW_COMMENT|l.SHOW_TEXT|l.SHOW_PROCESSING_INSTRUCTION|l.SHOW_CDATA_SECTION,null)},qr=function(L){return L instanceof p&&(typeof L.nodeName!="string"||typeof L.textContent!="string"||typeof L.removeChild!="function"||!(L.attributes instanceof u)||typeof L.removeAttribute!="function"||typeof L.setAttribute!="function"||typeof L.namespaceURI!="string"||typeof L.insertBefore!="function"||typeof L.hasChildNodes!="function")},$d=function(L){return typeof r=="function"&&L instanceof r};function Nn(be,L,Q){to(be,ge=>{ge.call(t,L,Q,Xs)})}const Sd=function(L){let Q=null;if(Nn(Z.beforeSanitizeElements,L,null),qr(L))return $n(L),!0;const ge=it(L.nodeName);if(Nn(Z.uponSanitizeElement,L,{tagName:ge,allowedTags:le}),se&&L.hasChildNodes()&&!$d(L.firstElementChild)&&Et(/<[/\w!]/g,L.innerHTML)&&Et(/<[/\w!]/g,L.textContent)||L.nodeType===Xa.progressingInstruction||se&&L.nodeType===Xa.comment&&Et(/<[/\w]/g,L.data))return $n(L),!0;if(!(U.tagCheck instanceof Function&&U.tagCheck(ge))&&(!le[ge]||A[ge])){if(!A[ge]&&_d(ge)&&(_.tagNameCheck instanceof RegExp&&Et(_.tagNameCheck,ge)||_.tagNameCheck instanceof Function&&_.tagNameCheck(ge)))return!1;if(Y&&!D[ge]){const Ge=w(L)||L.parentNode,xt=$(L)||L.childNodes;if(xt&&Ge){const st=xt.length;for(let It=st-1;It>=0;--It){const On=k(xt[It],!0);On.__removalCount=(L.__removalCount||0)+1,Ge.insertBefore(On,x(L))}}}return $n(L),!0}return L instanceof c&&!ff(L)||(ge==="noscript"||ge==="noembed"||ge==="noframes")&&Et(/<\/no(script|embed|frames)/i,L.innerHTML)?($n(L),!0):(X&&L.nodeType===Xa.text&&(Q=L.textContent,to([O,F,ee],Ge=>{Q=Qa(Q,Ge," ")}),L.textContent!==Q&&(Ka(t.removed,{element:L.cloneNode()}),L.textContent=Q)),Nn(Z.afterSanitizeElements,L,null),!1)},Cd=function(L,Q,ge){if(xn&&(Q==="id"||Q==="name")&&(ge in n||ge in vf))return!1;if(!(z&&!E[Q]&&Et(ie,Q))){if(!(M&&Et(oe,Q))){if(!(U.attributeCheck instanceof Function&&U.attributeCheck(Q,L))){if(!ne[Q]||E[Q]){if(!(_d(L)&&(_.tagNameCheck instanceof RegExp&&Et(_.tagNameCheck,L)||_.tagNameCheck instanceof Function&&_.tagNameCheck(L))&&(_.attributeNameCheck instanceof RegExp&&Et(_.attributeNameCheck,Q)||_.attributeNameCheck instanceof Function&&_.attributeNameCheck(Q,L))||Q==="is"&&_.allowCustomizedBuiltInElements&&(_.tagNameCheck instanceof RegExp&&Et(_.tagNameCheck,ge)||_.tagNameCheck instanceof Function&&_.tagNameCheck(ge))))return!1}else if(!$e[Q]){if(!Et(Le,Qa(ge,ze,""))){if(!((Q==="src"||Q==="xlink:href"||Q==="href")&&L!=="script"&&Tw(ge,"data:")===0&&ae[L])){if(!(q&&!Et(me,Qa(ge,ze,"")))){if(ge)return!1}}}}}}}return!0},_d=function(L){return L!=="annotation-xml"&&zr(L,re)},Ld=function(L){Nn(Z.beforeSanitizeAttributes,L,null);const{attributes:Q}=L;if(!Q||qr(L))return;const ge={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:ne,forceKeepAttr:void 0};let Ge=Q.length;for(;Ge--;){const xt=Q[Ge],{name:st,namespaceURI:It,value:On}=xt,ea=it(st),jr=On;let gt=st==="value"?jr:Aw(jr);if(ge.attrName=ea,ge.attrValue=gt,ge.keepAttr=!0,ge.forceKeepAttr=void 0,Nn(Z.uponSanitizeAttribute,L,ge),gt=ge.attrValue,At&&(ea==="id"||ea==="name")&&(Ps(st,L),gt=zt+gt),se&&Et(/((--!?|])>)|<\/(style|title|textarea)/i,gt)){Ps(st,L);continue}if(ea==="attributename"&&zr(gt,"href")){Ps(st,L);continue}if(ge.forceKeepAttr)continue;if(!ge.keepAttr){Ps(st,L);continue}if(!I&&Et(/\/>/i,gt)){Ps(st,L);continue}X&&to([O,F,ee],Ad=>{gt=Qa(gt,Ad," ")});const Td=it(L.nodeName);if(!Cd(Td,ea,gt)){Ps(st,L);continue}if(y&&typeof f=="object"&&typeof f.getAttributeType=="function"&&!It)switch(f.getAttributeType(Td,ea)){case"TrustedHTML":{gt=y.createHTML(gt);break}case"TrustedScriptURL":{gt=y.createScriptURL(gt);break}}if(gt!==jr)try{It?L.setAttributeNS(It,st,gt):L.setAttribute(st,gt),qr(L)?$n(L):Id(t.removed)}catch{Ps(st,L)}}Nn(Z.afterSanitizeAttributes,L,null)},hf=function be(L){let Q=null;const ge=xd(L);for(Nn(Z.beforeSanitizeShadowDOM,L,null);Q=ge.nextNode();)Nn(Z.uponSanitizeShadowNode,Q,null),Sd(Q),Ld(Q),Q.content instanceof o&&be(Q.content);Nn(Z.afterSanitizeShadowDOM,L,null)};return t.sanitize=function(be){let L=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},Q=null,ge=null,Ge=null,xt=null;if(Ua=!be,Ua&&(be="<!-->"),typeof be!="string"&&!$d(be))if(typeof be.toString=="function"){if(be=be.toString(),typeof be!="string")throw Ja("dirty is not a string, aborting")}else throw Ja("toString is not a function");if(!t.isSupported)return be;if(fe||Er(L),t.removed=[],typeof be=="string"&&(W=!1),W){if(be.nodeName){const On=it(be.nodeName);if(!le[On]||A[On])throw Ja("root node is forbidden and cannot be sanitized in-place")}}else if(be instanceof r)Q=kd("<!---->"),ge=Q.ownerDocument.importNode(be,!0),ge.nodeType===Xa.element&&ge.nodeName==="BODY"||ge.nodeName==="HTML"?Q=ge:Q.appendChild(ge);else{if(!Te&&!X&&!Se&&be.indexOf("<")===-1)return y&&an?y.createHTML(be):be;if(Q=kd(be),!Q)return Te?null:an?S:""}Q&&we&&$n(Q.firstChild);const st=xd(W?be:Q);for(;Ge=st.nextNode();)Sd(Ge),Ld(Ge),Ge.content instanceof o&&hf(Ge.content);if(W)return be;if(Te){if(Oe)for(xt=H.call(Q.ownerDocument);Q.firstChild;)xt.appendChild(Q.firstChild);else xt=Q;return(ne.shadowroot||ne.shadowrootmode)&&(xt=B.call(s,xt,!0)),xt}let It=Se?Q.outerHTML:Q.innerHTML;return Se&&le["!doctype"]&&Q.ownerDocument&&Q.ownerDocument.doctype&&Q.ownerDocument.doctype.name&&Et(vm,Q.ownerDocument.doctype.name)&&(It="<!DOCTYPE "+Q.ownerDocument.doctype.name+`>
`+It),X&&to([O,F,ee],On=>{It=Qa(It,On," ")}),y&&an?y.createHTML(It):It},t.setConfig=function(){let be=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Er(be),fe=!0},t.clearConfig=function(){Xs=null,fe=!1},t.isValidAttribute=function(be,L,Q){Xs||Er({});const ge=it(be),Ge=it(L);return Cd(ge,Ge,Q)},t.addHook=function(be,L){typeof L=="function"&&Ka(Z[be],L)},t.removeHook=function(be,L){if(L!==void 0){const Q=_w(Z[be],L);return Q===-1?void 0:Lw(Z[be],Q,1)[0]}return Id(Z[be])},t.removeHooks=function(be){Z[be]=[]},t.removeAllHooks=function(){Z=Fd()},t}fm();function b(e,t,n){const s=document.createElement(e);return t&&Object.entries(t).forEach(([a,o])=>{a==="className"?s.className=o:a==="style"?typeof o=="object"?Object.assign(s.style,o):typeof o=="string"&&(s.style.cssText=o):a.startsWith("data")?s.setAttribute(a.replace(/([A-Z])/g,"-$1").toLowerCase(),String(o)):s[a]=o}),n&&n.forEach(a=>{typeof a=="string"?s.appendChild(document.createTextNode(a)):s.appendChild(a)}),s}function d(e,t,n,s){return e.addEventListener(t,n,s),()=>e.removeEventListener(t,n,s)}function bn(e,...t){e.classList.add(...t)}function ss(e,...t){e.classList.remove(...t)}function Ll(e){const t=b("button",{className:"btn btn-ghost theme-toggle",title:`Theme: ${tt.getLabel()} (Ctrl+Shift+T)`});function n(){t.innerHTML=s(),t.title=`Theme: ${tt.getLabel()} (Ctrl+Shift+T)`,t.setAttribute("data-theme-mode",tt.getMode())}function s(){switch(tt.getMode()){case"light":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>`;case"dark":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>`;case"system":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
          <line x1="8" y1="21" x2="16" y2="21"/>
          <line x1="12" y1="17" x2="12" y2="21"/>
        </svg>`}}return d(t,"click",()=>{tt.cycle(),n(),m.info(`Theme: ${tt.getLabel()}`)}),tt.onChange(()=>{n()}),n(),e&&e.appendChild(t),t}function Uw(e){const t=document.querySelector(e);return t?Ll(t):(console.warn(`ThemeToggle: Container not found: ${e}`),null)}const hm={currentTab:"dashboard",currentDevTab:"info",sotCurrentView:"questions",selectedPerson:null,sidebarOpen:!0,modalOpen:null,searchQuery:"",filterActive:!1};let Ve={...hm};const Tc=new Set;function kn(){Tc.forEach(e=>e(Ve))}function Vw(){return Ve}function Gw(e){return Tc.add(e),()=>Tc.delete(e)}function Zw(e){Ve={...Ve,currentTab:e},kn()}function Ww(e){Ve={...Ve,currentDevTab:e},kn()}function Kw(e){Ve={...Ve,sotCurrentView:e},kn()}function Qw(e){Ve={...Ve,selectedPerson:e},kn()}function Jw(){Ve={...Ve,sidebarOpen:!Ve.sidebarOpen},kn()}function Yw(e){Ve={...Ve,sidebarOpen:e},kn()}function Xw(e){Ve={...Ve,modalOpen:e},kn()}function e2(){Ve={...Ve,modalOpen:null},kn()}function t2(e){Ve={...Ve,searchQuery:e},kn()}function n2(){Ve={...Ve,filterActive:!Ve.filterActive},kn()}function s2(){Ve={...hm},kn()}const Ie={getState:Vw,subscribe:Gw,setTab:Zw,setDevTab:Ww,setSotView:Kw,setSelectedPerson:Qw,toggleSidebar:Jw,setSidebarOpen:Yw,openModal:Xw,closeModal:e2,setSearchQuery:t2,toggleFilter:n2,reset:s2};function bm(e={}){const t=b("header",{className:"app-header"}),n=b("div",{className:"header-logo"});n.innerHTML=`
    <span class="logo-icon">‚ö°</span>
    <h1>GodMode</h1>
  `;const s=b("div",{className:"header-actions"}),a=a2(e.onProjectChange);s.appendChild(a);const o=Ll();s.appendChild(o);const i=i2(e);s.appendChild(i);const r=b("button",{className:"mobile-menu-btn",innerHTML:"‚ò∞"});return d(r,"click",()=>{Ie.toggleSidebar()}),t.appendChild(r),t.appendChild(n),t.appendChild(s),t}function a2(e){const t=b("div",{className:"project-selector"}),n=b("button",{className:"project-btn"}),s=b("div",{className:"project-dropdown"});function a(){const r=N.getState().currentProjectId||"Select Project";n.innerHTML=`
      <span class="project-name">${r}</span>
      <span class="dropdown-arrow">‚ñº</span>
    `}let o=!1;return d(n,"click",i=>{i.stopPropagation(),o=!o,s.classList.toggle("show",o)}),d(document,"click",()=>{o=!1,s.classList.remove("show")}),N.subscribe(()=>{a()}),a(),t.appendChild(n),t.appendChild(s),t}function i2(e){const t=b("div",{className:"user-menu"}),n=b("button",{className:"user-menu-btn"}),s=b("div",{className:"user-dropdown"});function a(){const l=N.getState().currentUser,u=l?.name?l.name.split(" ").map(p=>p[0]).join("").toUpperCase().slice(0,2):l?.email?.[0]?.toUpperCase()||"?";n.innerHTML=`
      <div class="user-avatar">${u}</div>
      <span class="user-name">${l?.name||l?.email||"Guest"}</span>
    `}function o(){const l=N.getState().currentUser;s.innerHTML=`
      <div class="user-dropdown-header">
        <strong>${l?.name||"Guest"}</strong>
        <span class="text-muted">${l?.email||""}</span>
        ${l?.role?`<span class="role-badge ${l.role}">${l.role}</span>`:""}
      </div>
      <div class="user-dropdown-items">
        <button data-action="settings">
          <span>‚öôÔ∏è</span> Settings
        </button>
        <button data-action="shortcuts">
          <span>‚å®Ô∏è</span> Shortcuts
        </button>
        <button data-action="logout" class="text-error">
          <span>üö™</span> Logout
        </button>
      </div>
    `;const u=s.querySelector('[data-action="settings"]'),p=s.querySelector('[data-action="shortcuts"]'),g=s.querySelector('[data-action="logout"]');u&&d(u,"click",()=>{e.onSettings?.(),r()}),p&&d(p,"click",()=>{Ie.openModal("shortcuts"),r()}),g&&d(g,"click",()=>{e.onLogout?.(),r()})}let i=!1;function r(){i=!1,s.classList.remove("show")}return d(n,"click",c=>{c.stopPropagation(),i=!i,s.classList.toggle("show",i),i&&o()}),d(document,"click",r),N.subscribe(a),a(),t.appendChild(n),t.appendChild(s),t}function o2(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Header: Container not found: ${e}`),null;const s=bm(t);return n.appendChild(s),s}const Ud=[{id:"dashboard",label:"Dashboard",icon:"üìä"},{id:"chat",label:"Chat",icon:"üí¨"},{id:"sot",label:"Source of Truth",icon:"üìã"},{id:"timeline",label:"Timeline",icon:"üìÖ"},{id:"org",label:"Org Chart",icon:"üë•"},{id:"files",label:"Files",icon:"üìÅ"},{id:"emails",label:"Emails",icon:"üìß"},{id:"contacts",label:"Contacts",icon:"üìá"},{id:"roles",label:"Roles",icon:"üîê"},{id:"graph",label:"Graph DB",icon:"üï∏Ô∏è"},{id:"costs",label:"Costs",icon:"üí∞"},{id:"history",label:"History",icon:"üïê"}],r2={id:"admin",label:"Admin",icon:"‚öôÔ∏è"};function c2(){return N.getState().currentUser?.role==="superadmin"?[...Ud,r2]:Ud}function l2(e,t){const n=b("button",{className:"sidebar-tab"});return n.setAttribute("data-tab",e.id),n.innerHTML=`
    <span class="tab-icon">${e.icon}</span>
    <span class="tab-label">${e.label}</span>
    ${e.badge?`<span class="tab-badge">${e.badge}</span>`:""}
  `,d(n,"click",()=>{Ie.setTab(e.id),t.onTabChange?.(e.id),window.innerWidth<768&&Ie.setSidebarOpen(!1)}),n}function Vd(e,t){const n=t.tabs||c2(),s=Ie.getState().currentTab;e.innerHTML="",n.forEach(a=>{const o=l2(a,t);a.id===s&&bn(o,"active"),e.appendChild(o)})}function ym(e={}){const t=b("aside",{className:"sidebar"}),n=b("button",{className:"sidebar-close-btn",innerHTML:"‚úï"});d(n,"click",()=>{Ie.setSidebarOpen(!1)}),t.appendChild(n);const s=b("nav",{className:"sidebar-nav"});Vd(s,e),t.appendChild(s),N.subscribe(()=>{Vd(s,e)}),Ie.subscribe(i=>{s.querySelectorAll(".sidebar-tab").forEach(c=>{c.getAttribute("data-tab")===i.currentTab?bn(c,"active"):ss(c,"active")}),i.sidebarOpen?bn(t,"mobile-open"):ss(t,"mobile-open")});const a=Ie.getState(),o=s.querySelector(`[data-tab="${a.currentTab}"]`);return o&&bn(o,"active"),t}function d2(e,t){const n=document.querySelector(`.sidebar-tab[data-tab="${e}"]`);if(!n)return;let s=n.querySelector(".tab-badge");if(t===null||t===0){s?.remove();return}s||(s=b("span",{className:"tab-badge"}),n.appendChild(s)),s.textContent=t>99?"99+":String(t)}function u2(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Sidebar: Container not found: ${e}`),null;const s=ym(t);return n.appendChild(s),s}let Nr=null;function wm(e={}){if(Nr)return Nr;const t=e.position||"bottom-right",n=b("div",{className:`toast-container toast-${t}`});return document.body.appendChild(n),Nr=n,n}function km(e,t="info",n=3e3){const s=b("div",{className:`toast toast-${t} fade-in`}),a={success:"‚úì",error:"‚úï",warning:"‚ö†",info:"‚Ñπ"};return s.innerHTML=`
    <span class="toast-icon">${a[t]}</span>
    <span class="toast-message">${e}</span>
  `,d(s,"click",()=>{Gd(s)}),n>0&&setTimeout(()=>{Gd(s)},n),s}function Gd(e){e.classList.add("toast-dismiss"),setTimeout(()=>{e.remove()},300)}function p2(e,t="info",n=3e3){const s=wm(),a=km(e,t,n);return s.appendChild(a),a}const nn=new Map;function Pe(e){const{id:t,title:n,content:s,size:a="md",closable:o=!0,onClose:i,onOpen:r,footer:c}=e,l=b("div",{className:`modal modal-${a}`});l.setAttribute("data-modal-id",t);const u=b("div",{className:"modal-content"}),p=b("div",{className:"modal-header"});if(p.innerHTML=`<h3>${n}</h3>`,o){const h=b("button",{className:"modal-close",innerHTML:"√ó"});d(h,"click",()=>K(t)),p.appendChild(h)}const g=b("div",{className:"modal-body"});typeof s=="string"?g.innerHTML=s:s&&g.appendChild(s);const f=c||b("div",{className:"modal-footer"});return u.appendChild(p),u.appendChild(g),c!==null&&u.appendChild(f),l.appendChild(u),o&&d(l,"click",h=>{h.target===l&&K(t)}),nn.set(t,l),l}function De(e){const t=nn.get(e)||document.querySelector(`[data-modal-id="${e}"]`);if(!t){console.warn(`Modal not found: ${e}`);return}bn(t,"open"),document.body.classList.add("modal-open"),Ie.openModal(e),setTimeout(()=>{t.querySelector("input, textarea, select, button")?.focus()},100)}function K(e){const t=nn.get(e)||document.querySelector(`[data-modal-id="${e}"]`);t&&(ss(t,"open"),document.body.classList.remove("modal-open"),Ie.closeModal())}function xm(){nn.forEach((e,t)=>K(t))}function $m(e){return nn.get(e)?.classList.contains("open")||!1}function Sm(e,t){const n=nn.get(e);if(!n)return;const s=n.querySelector(".modal-body");s&&(typeof t=="string"?s.innerHTML=t:(s.innerHTML="",s.appendChild(t)))}function Cm(e,t){const n=nn.get(e);if(!n)return;const s=n.querySelector(".modal-header h3");s&&(s.textContent=t)}function xs(e,t={}){return new Promise(n=>{const{title:s="Confirm",confirmText:a="Confirm",cancelText:o="Cancel",confirmClass:i="btn-primary"}=t,r=`confirm-${Date.now()}`,c=b("div",{className:"modal-footer"}),l=b("button",{className:"btn btn-secondary",textContent:o}),u=b("button",{className:`btn ${i}`,textContent:a});d(l,"click",()=>{K(r),p.remove(),nn.delete(r),n(!1)}),d(u,"click",()=>{K(r),p.remove(),nn.delete(r),n(!0)}),c.appendChild(l),c.appendChild(u);const p=Pe({id:r,title:s,content:`<p>${e}</p>`,size:"sm",closable:!0,onClose:()=>n(!1),footer:c});document.body.appendChild(p),De(r)})}function _m(e,t="Alert"){return new Promise(n=>{const s=`alert-${Date.now()}`,a=b("div",{className:"modal-footer"}),o=b("button",{className:"btn btn-primary",textContent:"OK"});d(o,"click",()=>{K(s),i.remove(),nn.delete(s),n()}),a.appendChild(o);const i=Pe({id:s,title:t,content:`<p>${e}</p>`,size:"sm",closable:!0,onClose:()=>n(),footer:a});document.body.appendChild(i),De(s)})}function m2(e,t={}){return new Promise(n=>{const s=`prompt-${Date.now()}`,{title:a="Input",placeholder:o="",defaultValue:i=""}=t,r=b("div",{className:"prompt-content"});r.innerHTML=`
      <p>${e}</p>
      <input type="text" class="prompt-input gm-w-full gm-p-2 gm-mt-2" placeholder="${o}" value="${i}">
    `;const c=b("div",{className:"modal-footer"}),l=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),u=b("button",{className:"btn btn-primary",textContent:"OK"});d(l,"click",()=>{K(s),p.remove(),nn.delete(s),n(null)}),d(u,"click",()=>{const f=p.querySelector(".prompt-input")?.value||"";K(s),p.remove(),nn.delete(s),n(f)}),c.appendChild(l),c.appendChild(u);const p=Pe({id:s,title:a,content:r,size:"sm",closable:!0,onClose:()=>n(null),footer:c});document.body.appendChild(p),De(s),setTimeout(()=>{p.querySelector(".prompt-input")?.focus()},100)})}Qt.register({key:"Escape",description:"Close modal",handler:()=>{const e=Ie.getState();e.modalOpen&&K(e.modalOpen)}});const In=Object.freeze(Object.defineProperty({__proto__:null,alert:_m,closeAllModals:xm,closeModal:K,confirm:xs,createModal:Pe,isModalOpen:$m,openModal:De,prompt:m2,updateModalContent:Sm,updateModalTitle:Cm},Symbol.toStringTag,{value:"Module"})),ei="member-permissions-modal",g2=[{id:"view",name:"View",icon:"üëÅÔ∏è",color:"#3b82f6",permissions:[{id:"view:dashboard",name:"Dashboard",desc:"View project dashboard and stats"},{id:"view:chat",name:"AI Chat",desc:"Use the AI assistant"},{id:"view:sot",name:"Source of Truth",desc:"View decisions, risks, actions, questions"},{id:"view:contacts",name:"Contacts",desc:"View project contacts"},{id:"view:documents",name:"Documents",desc:"View uploaded documents"},{id:"view:emails",name:"Emails",desc:"View email history"},{id:"view:team",name:"Team",desc:"View team members"}]},{id:"comment",name:"Comment",icon:"üí¨",color:"#8b5cf6",permissions:[{id:"comment:sot",name:"Comment on Items",desc:"Add comments to decisions, risks, etc."},{id:"comment:documents",name:"Comment on Docs",desc:"Add comments to documents"}]},{id:"edit",name:"Edit",icon:"‚úèÔ∏è",color:"#10b981",permissions:[{id:"edit:questions",name:"Questions",desc:"Create and edit questions"},{id:"edit:risks",name:"Risks",desc:"Create and edit risks"},{id:"edit:actions",name:"Actions",desc:"Create and edit actions"},{id:"edit:decisions",name:"Decisions",desc:"Create and edit decisions"},{id:"edit:contacts",name:"Contacts",desc:"Create and edit contacts"},{id:"edit:documents",name:"Documents",desc:"Upload and edit documents"}]},{id:"manage",name:"Manage",icon:"‚öôÔ∏è",color:"#f59e0b",permissions:[{id:"manage:team",name:"Team",desc:"Invite and remove team members"},{id:"manage:roles",name:"Roles",desc:"Create and assign roles"},{id:"manage:settings",name:"Settings",desc:"Change project settings"},{id:"manage:integrations",name:"Integrations",desc:"Configure integrations"}]},{id:"delete",name:"Delete",icon:"üóëÔ∏è",color:"#ef4444",permissions:[{id:"delete:data",name:"Delete Data",desc:"Permanently delete items"},{id:"export:data",name:"Export Data",desc:"Export project data"}]}],Zd={viewer:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team"],editor:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team","comment:sot","comment:documents","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","edit:documents"],admin:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team","comment:sot","comment:documents","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","edit:documents","manage:team","manage:roles","manage:settings","manage:integrations","delete:data","export:data"],owner:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team","comment:sot","comment:documents","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","edit:documents","manage:team","manage:roles","manage:settings","manage:integrations","delete:data","export:data"]};function Lm(e){const{projectId:t,userId:n,userName:s,userEmail:a,avatarUrl:o,currentRole:i,onSave:r}=e;let c=new Set(e.currentPermissions||Zd[i]||[]);const l=document.querySelector(`[data-modal-id="${ei}"]`);l&&l.remove();const u=document.createElement("div");u.className="member-permissions-content",u.innerHTML=`
    <style>
      .member-permissions-content {
        padding: 0;
      }
      
      .member-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px 24px;
        background: linear-gradient(135deg, rgba(225,29,72,0.08) 0%, rgba(225,29,72,0.03) 100%);
        border-bottom: 1px solid var(--border-color);
      }
      
      .member-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
        overflow: hidden;
      }
      
      .member-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .member-info h4 {
        margin: 0 0 4px;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .member-info p {
        margin: 0;
        font-size: 13px;
        color: var(--text-secondary);
      }
      
      .role-selector {
        margin-left: auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      
      .role-selector label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .role-selector select {
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
      }
      
      .permissions-body {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .permission-category {
        margin-bottom: 20px;
      }
      
      .permission-category:last-child {
        margin-bottom: 0;
      }
      
      .category-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
      }
      
      .category-icon {
        font-size: 16px;
      }
      
      .category-name {
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }
      
      .category-toggle {
        font-size: 11px;
        padding: 4px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: transparent;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.15s;
      }
      
      .category-toggle:hover {
        background: var(--bg-secondary);
        border-color: #e11d48;
        color: #e11d48;
      }
      
      .permission-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 8px;
      }
      
      .permission-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.15s;
        border: 1px solid transparent;
      }
      
      .permission-item:hover {
        background: var(--bg-tertiary);
      }
      
      .permission-item.selected {
        background: linear-gradient(135deg, rgba(225,29,72,0.1) 0%, rgba(225,29,72,0.05) 100%);
        border-color: rgba(225,29,72,0.3);
      }
      
      .permission-item input {
        margin-top: 2px;
        accent-color: #e11d48;
        width: 16px;
        height: 16px;
      }
      
      .permission-info {
        flex: 1;
        min-width: 0;
      }
      
      .permission-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .permission-desc {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
      }
      
      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      
      .btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }
      
      .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      
      .btn-secondary:hover {
        background: var(--bg-tertiary);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
    </style>
    
    <div class="member-header">
      <div class="member-avatar">
        ${o?`<img src="${o}" alt="">`:f2(s||a)}
      </div>
      <div class="member-info">
        <h4>${Wd(s||a)}</h4>
        <p>${Wd(a)}</p>
      </div>
      <div class="role-selector">
        <label>Base Role</label>
        <select id="base-role">
          <option value="viewer" ${i==="viewer"?"selected":""}>Viewer</option>
          <option value="editor" ${i==="editor"?"selected":""}>Editor</option>
          <option value="admin" ${i==="admin"?"selected":""}>Admin</option>
          <option value="owner" ${i==="owner"?"selected":""}>Owner</option>
        </select>
      </div>
    </div>
    
    <div class="permissions-body">
      ${g2.map(g=>`
        <div class="permission-category" data-category="${g.id}">
          <div class="category-header">
            <span class="category-icon">${g.icon}</span>
            <span class="category-name">${g.name}</span>
            <button type="button" class="category-toggle" data-action="toggle">Toggle All</button>
          </div>
          <div class="permission-grid">
            ${g.permissions.map(f=>`
              <label class="permission-item${c.has(f.id)?" selected":""}">
                <input type="checkbox" name="permission" value="${f.id}" ${c.has(f.id)?"checked":""}>
                <div class="permission-info">
                  <div class="permission-name">${f.name}</div>
                  <div class="permission-desc">${f.desc}</div>
                </div>
              </label>
            `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
    
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="btn-save">Save Permissions</button>
    </div>
  `,setTimeout(()=>{const g=u.querySelector("#base-role");g&&d(g,"change",()=>{const k=g.value,C=Zd[k]||[];c=new Set(C),v2(u,c)}),u.querySelectorAll('input[name="permission"]').forEach(k=>{d(k,"change",()=>{const C=k.value;k.checked?c.add(C):c.delete(C),Ac(u)})}),u.querySelectorAll(".category-toggle").forEach(k=>{d(k,"click",()=>{const C=k.closest(".permission-category");if(!C)return;const x=C.querySelectorAll('input[name="permission"]'),$=Array.from(x).every(w=>w.checked);x.forEach(w=>{const y=w;y.checked=!$,$?c.delete(y.value):c.add(y.value)}),Ac(u)})});const f=u.querySelector("#btn-cancel");f&&d(f,"click",()=>K(ei));const h=u.querySelector("#btn-save");h&&d(h,"click",async()=>{const k=g?.value||i,C=Array.from(c);h.disabled=!0,h.textContent="Saving...";try{await v.put(`/api/projects/${t}/members/${n}/permissions`,{role:k,permissions:C}),m.success("Permissions updated"),K(ei),r?.()}catch{m.error("Failed to update permissions"),h.disabled=!1,h.textContent="Save Permissions"}})},0);const p=Pe({id:ei,title:"Member Permissions",content:u,size:"lg"});document.body.appendChild(p),De(ei)}function v2(e,t){e.querySelectorAll('input[name="permission"]').forEach(n=>{const s=n;s.checked=t.has(s.value)}),Ac(e)}function Ac(e){e.querySelectorAll(".permission-item").forEach(t=>{const n=t.querySelector('input[name="permission"]');t.classList.toggle("selected",n?.checked||!1)})}function f2(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function Wd(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function R(e,t,n){function s(r,c){if(r._zod||Object.defineProperty(r,"_zod",{value:{def:c,constr:i,traits:new Set},enumerable:!1}),r._zod.traits.has(e))return;r._zod.traits.add(e),t(r,c);const l=i.prototype,u=Object.keys(l);for(let p=0;p<u.length;p++){const g=u[p];g in r||(r[g]=l[g].bind(r))}}const a=n?.Parent??Object;class o extends a{}Object.defineProperty(o,"name",{value:e});function i(r){var c;const l=n?.Parent?new o:this;s(l,r),(c=l._zod).deferred??(c.deferred=[]);for(const u of l._zod.deferred)u();return l}return Object.defineProperty(i,"init",{value:s}),Object.defineProperty(i,Symbol.hasInstance,{value:r=>n?.Parent&&r instanceof n.Parent?!0:r?._zod?.traits?.has(e)}),Object.defineProperty(i,"name",{value:e}),i}class va extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class Tm extends Error{constructor(t){super(`Encountered unidirectional transform during encode: ${t}`),this.name="ZodEncodeError"}}const Am={};function Zs(e){return Am}function Mm(e){const t=Object.values(e).filter(s=>typeof s=="number");return Object.entries(e).filter(([s,a])=>t.indexOf(+s)===-1).map(([s,a])=>a)}function Mc(e,t){return typeof t=="bigint"?t.toString():t}function Tl(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function Al(e){return e==null}function Ml(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}const Kd=Symbol("evaluating");function He(e,t,n){let s;Object.defineProperty(e,t,{get(){if(s!==Kd)return s===void 0&&(s=Kd,s=n()),s},set(a){Object.defineProperty(e,t,{value:a})},configurable:!0})}function Js(e,t,n){Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}function _s(...e){const t={};for(const n of e){const s=Object.getOwnPropertyDescriptors(n);Object.assign(t,s)}return Object.defineProperties({},t)}function Qd(e){return JSON.stringify(e)}function h2(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}const Em="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function Eo(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const b2=Tl(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function Oi(e){if(Eo(e)===!1)return!1;const t=e.constructor;if(t===void 0||typeof t!="function")return!0;const n=t.prototype;return!(Eo(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}function qm(e){return Oi(e)?{...e}:Array.isArray(e)?[...e]:e}const y2=new Set(["string","number","symbol"]);function gr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ls(e,t,n){const s=new e._zod.constr(t??e._zod.def);return(!t||n?.parent)&&(s._zod.parent=e),s}function _e(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function w2(e){return Object.keys(e).filter(t=>e[t]._zod.optin==="optional"&&e[t]._zod.optout==="optional")}function k2(e,t){const n=e._zod.def,s=n.checks;if(s&&s.length>0)throw new Error(".pick() cannot be used on object schemas containing refinements");const o=_s(e._zod.def,{get shape(){const i={};for(const r in t){if(!(r in n.shape))throw new Error(`Unrecognized key: "${r}"`);t[r]&&(i[r]=n.shape[r])}return Js(this,"shape",i),i},checks:[]});return Ls(e,o)}function x2(e,t){const n=e._zod.def,s=n.checks;if(s&&s.length>0)throw new Error(".omit() cannot be used on object schemas containing refinements");const o=_s(e._zod.def,{get shape(){const i={...e._zod.def.shape};for(const r in t){if(!(r in n.shape))throw new Error(`Unrecognized key: "${r}"`);t[r]&&delete i[r]}return Js(this,"shape",i),i},checks:[]});return Ls(e,o)}function $2(e,t){if(!Oi(t))throw new Error("Invalid input to extend: expected a plain object");const n=e._zod.def.checks;if(n&&n.length>0){const o=e._zod.def.shape;for(const i in t)if(Object.getOwnPropertyDescriptor(o,i)!==void 0)throw new Error("Cannot overwrite keys on object schemas containing refinements. Use `.safeExtend()` instead.")}const a=_s(e._zod.def,{get shape(){const o={...e._zod.def.shape,...t};return Js(this,"shape",o),o}});return Ls(e,a)}function S2(e,t){if(!Oi(t))throw new Error("Invalid input to safeExtend: expected a plain object");const n=_s(e._zod.def,{get shape(){const s={...e._zod.def.shape,...t};return Js(this,"shape",s),s}});return Ls(e,n)}function C2(e,t){const n=_s(e._zod.def,{get shape(){const s={...e._zod.def.shape,...t._zod.def.shape};return Js(this,"shape",s),s},get catchall(){return t._zod.def.catchall},checks:[]});return Ls(e,n)}function _2(e,t,n){const a=t._zod.def.checks;if(a&&a.length>0)throw new Error(".partial() cannot be used on object schemas containing refinements");const i=_s(t._zod.def,{get shape(){const r=t._zod.def.shape,c={...r};if(n)for(const l in n){if(!(l in r))throw new Error(`Unrecognized key: "${l}"`);n[l]&&(c[l]=e?new e({type:"optional",innerType:r[l]}):r[l])}else for(const l in r)c[l]=e?new e({type:"optional",innerType:r[l]}):r[l];return Js(this,"shape",c),c},checks:[]});return Ls(t,i)}function L2(e,t,n){const s=_s(t._zod.def,{get shape(){const a=t._zod.def.shape,o={...a};if(n)for(const i in n){if(!(i in o))throw new Error(`Unrecognized key: "${i}"`);n[i]&&(o[i]=new e({type:"nonoptional",innerType:a[i]}))}else for(const i in a)o[i]=new e({type:"nonoptional",innerType:a[i]});return Js(this,"shape",o),o}});return Ls(t,s)}function oa(e,t=0){if(e.aborted===!0)return!0;for(let n=t;n<e.issues.length;n++)if(e.issues[n]?.continue!==!0)return!0;return!1}function jm(e,t){return t.map(n=>{var s;return(s=n).path??(s.path=[]),n.path.unshift(e),n})}function so(e){return typeof e=="string"?e:e?.message}function Ws(e,t,n){const s={...e,path:e.path??[]};if(!e.message){const a=so(e.inst?._zod.def?.error?.(e))??so(t?.error?.(e))??so(n.customError?.(e))??so(n.localeError?.(e))??"Invalid input";s.message=a}return delete s.inst,delete s.continue,t?.reportInput||delete s.input,s}function El(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function Fi(...e){const[t,n,s]=e;return typeof t=="string"?{message:t,code:"custom",input:n,inst:s}:{...t}}const Pm=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,Mc,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},Dm=R("$ZodError",Pm),zm=R("$ZodError",Pm,{Parent:Error});function T2(e,t=n=>n.message){const n={},s=[];for(const a of e.issues)a.path.length>0?(n[a.path[0]]=n[a.path[0]]||[],n[a.path[0]].push(t(a))):s.push(t(a));return{formErrors:s,fieldErrors:n}}function A2(e,t=n=>n.message){const n={_errors:[]},s=a=>{for(const o of a.issues)if(o.code==="invalid_union"&&o.errors.length)o.errors.map(i=>s({issues:i}));else if(o.code==="invalid_key")s({issues:o.issues});else if(o.code==="invalid_element")s({issues:o.issues});else if(o.path.length===0)n._errors.push(t(o));else{let i=n,r=0;for(;r<o.path.length;){const c=o.path[r];r===o.path.length-1?(i[c]=i[c]||{_errors:[]},i[c]._errors.push(t(o))):i[c]=i[c]||{_errors:[]},i=i[c],r++}}};return s(e),n}const ql=e=>(t,n,s,a)=>{const o=s?Object.assign(s,{async:!1}):{async:!1},i=t._zod.run({value:n,issues:[]},o);if(i instanceof Promise)throw new va;if(i.issues.length){const r=new(a?.Err??e)(i.issues.map(c=>Ws(c,o,Zs())));throw Em(r,a?.callee),r}return i.value},jl=e=>async(t,n,s,a)=>{const o=s?Object.assign(s,{async:!0}):{async:!0};let i=t._zod.run({value:n,issues:[]},o);if(i instanceof Promise&&(i=await i),i.issues.length){const r=new(a?.Err??e)(i.issues.map(c=>Ws(c,o,Zs())));throw Em(r,a?.callee),r}return i.value},vr=e=>(t,n,s)=>{const a=s?{...s,async:!1}:{async:!1},o=t._zod.run({value:n,issues:[]},a);if(o instanceof Promise)throw new va;return o.issues.length?{success:!1,error:new(e??Dm)(o.issues.map(i=>Ws(i,a,Zs())))}:{success:!0,data:o.value}},M2=vr(zm),fr=e=>async(t,n,s)=>{const a=s?Object.assign(s,{async:!0}):{async:!0};let o=t._zod.run({value:n,issues:[]},a);return o instanceof Promise&&(o=await o),o.issues.length?{success:!1,error:new e(o.issues.map(i=>Ws(i,a,Zs())))}:{success:!0,data:o.value}},E2=fr(zm),q2=e=>(t,n,s)=>{const a=s?Object.assign(s,{direction:"backward"}):{direction:"backward"};return ql(e)(t,n,a)},j2=e=>(t,n,s)=>ql(e)(t,n,s),P2=e=>async(t,n,s)=>{const a=s?Object.assign(s,{direction:"backward"}):{direction:"backward"};return jl(e)(t,n,a)},D2=e=>async(t,n,s)=>jl(e)(t,n,s),z2=e=>(t,n,s)=>{const a=s?Object.assign(s,{direction:"backward"}):{direction:"backward"};return vr(e)(t,n,a)},I2=e=>(t,n,s)=>vr(e)(t,n,s),H2=e=>async(t,n,s)=>{const a=s?Object.assign(s,{direction:"backward"}):{direction:"backward"};return fr(e)(t,n,a)},B2=e=>async(t,n,s)=>fr(e)(t,n,s),R2=/^[cC][^\s-]{8,}$/,N2=/^[0-9a-z]+$/,O2=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,F2=/^[0-9a-vA-V]{20}$/,U2=/^[A-Za-z0-9]{27}$/,V2=/^[a-zA-Z0-9_-]{21}$/,G2=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,Z2=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Jd=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,W2=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,K2="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function Q2(){return new RegExp(K2,"u")}const J2=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Y2=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,X2=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,ek=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,tk=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,Im=/^[A-Za-z0-9_-]*$/,nk=/^\+[1-9]\d{6,14}$/,Hm="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",sk=new RegExp(`^${Hm}$`);function Bm(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${t}`:e.precision===0?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function ak(e){return new RegExp(`^${Bm(e)}$`)}function ik(e){const t=Bm({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const s=`${t}(?:${n.join("|")})`;return new RegExp(`^${Hm}T(?:${s})$`)}const ok=e=>{const t=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${t}$`)},rk=/^[^A-Z]*$/,ck=/^[^a-z]*$/,Hn=R("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),lk=R("$ZodCheckMaxLength",(e,t)=>{var n;Hn.init(e,t),(n=e._zod.def).when??(n.when=s=>{const a=s.value;return!Al(a)&&a.length!==void 0}),e._zod.onattach.push(s=>{const a=s._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<a&&(s._zod.bag.maximum=t.maximum)}),e._zod.check=s=>{const a=s.value;if(a.length<=t.maximum)return;const i=El(a);s.issues.push({origin:i,code:"too_big",maximum:t.maximum,inclusive:!0,input:a,inst:e,continue:!t.abort})}}),dk=R("$ZodCheckMinLength",(e,t)=>{var n;Hn.init(e,t),(n=e._zod.def).when??(n.when=s=>{const a=s.value;return!Al(a)&&a.length!==void 0}),e._zod.onattach.push(s=>{const a=s._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>a&&(s._zod.bag.minimum=t.minimum)}),e._zod.check=s=>{const a=s.value;if(a.length>=t.minimum)return;const i=El(a);s.issues.push({origin:i,code:"too_small",minimum:t.minimum,inclusive:!0,input:a,inst:e,continue:!t.abort})}}),uk=R("$ZodCheckLengthEquals",(e,t)=>{var n;Hn.init(e,t),(n=e._zod.def).when??(n.when=s=>{const a=s.value;return!Al(a)&&a.length!==void 0}),e._zod.onattach.push(s=>{const a=s._zod.bag;a.minimum=t.length,a.maximum=t.length,a.length=t.length}),e._zod.check=s=>{const a=s.value,o=a.length;if(o===t.length)return;const i=El(a),r=o>t.length;s.issues.push({origin:i,...r?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:s.value,inst:e,continue:!t.abort})}}),hr=R("$ZodCheckStringFormat",(e,t)=>{var n,s;Hn.init(e,t),e._zod.onattach.push(a=>{const o=a._zod.bag;o.format=t.format,t.pattern&&(o.patterns??(o.patterns=new Set),o.patterns.add(t.pattern))}),t.pattern?(n=e._zod).check??(n.check=a=>{t.pattern.lastIndex=0,!t.pattern.test(a.value)&&a.issues.push({origin:"string",code:"invalid_format",format:t.format,input:a.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(s=e._zod).check??(s.check=()=>{})}),pk=R("$ZodCheckRegex",(e,t)=>{hr.init(e,t),e._zod.check=n=>{t.pattern.lastIndex=0,!t.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),mk=R("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=rk),hr.init(e,t)}),gk=R("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=ck),hr.init(e,t)}),vk=R("$ZodCheckIncludes",(e,t)=>{Hn.init(e,t);const n=gr(t.includes),s=new RegExp(typeof t.position=="number"?`^.{${t.position}}${n}`:n);t.pattern=s,e._zod.onattach.push(a=>{const o=a._zod.bag;o.patterns??(o.patterns=new Set),o.patterns.add(s)}),e._zod.check=a=>{a.value.includes(t.includes,t.position)||a.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:a.value,inst:e,continue:!t.abort})}}),fk=R("$ZodCheckStartsWith",(e,t)=>{Hn.init(e,t);const n=new RegExp(`^${gr(t.prefix)}.*`);t.pattern??(t.pattern=n),e._zod.onattach.push(s=>{const a=s._zod.bag;a.patterns??(a.patterns=new Set),a.patterns.add(n)}),e._zod.check=s=>{s.value.startsWith(t.prefix)||s.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:s.value,inst:e,continue:!t.abort})}}),hk=R("$ZodCheckEndsWith",(e,t)=>{Hn.init(e,t);const n=new RegExp(`.*${gr(t.suffix)}$`);t.pattern??(t.pattern=n),e._zod.onattach.push(s=>{const a=s._zod.bag;a.patterns??(a.patterns=new Set),a.patterns.add(n)}),e._zod.check=s=>{s.value.endsWith(t.suffix)||s.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:s.value,inst:e,continue:!t.abort})}}),bk=R("$ZodCheckOverwrite",(e,t)=>{Hn.init(e,t),e._zod.check=n=>{n.value=t.tx(n.value)}});class yk{constructor(t=[]){this.content=[],this.indent=0,this&&(this.args=t)}indented(t){this.indent+=1,t(this),this.indent-=1}write(t){if(typeof t=="function"){t(this,{execution:"sync"}),t(this,{execution:"async"});return}const s=t.split(`
`).filter(i=>i),a=Math.min(...s.map(i=>i.length-i.trimStart().length)),o=s.map(i=>i.slice(a)).map(i=>" ".repeat(this.indent*2)+i);for(const i of o)this.content.push(i)}compile(){const t=Function,n=this?.args,a=[...(this?.content??[""]).map(o=>`  ${o}`)];return new t(...n,a.join(`
`))}}const wk={major:4,minor:3,patch:6},ot=R("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=wk;const s=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&s.unshift(e);for(const a of s)for(const o of a._zod.onattach)o(e);if(s.length===0)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const a=(i,r,c)=>{let l=oa(i),u;for(const p of r){if(p._zod.def.when){if(!p._zod.def.when(i))continue}else if(l)continue;const g=i.issues.length,f=p._zod.check(i);if(f instanceof Promise&&c?.async===!1)throw new va;if(u||f instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await f,i.issues.length!==g&&(l||(l=oa(i,g)))});else{if(i.issues.length===g)continue;l||(l=oa(i,g))}}return u?u.then(()=>i):i},o=(i,r,c)=>{if(oa(i))return i.aborted=!0,i;const l=a(r,s,c);if(l instanceof Promise){if(c.async===!1)throw new va;return l.then(u=>e._zod.parse(u,c))}return e._zod.parse(l,c)};e._zod.run=(i,r)=>{if(r.skipChecks)return e._zod.parse(i,r);if(r.direction==="backward"){const l=e._zod.parse({value:i.value,issues:[]},{...r,skipChecks:!0});return l instanceof Promise?l.then(u=>o(u,i,r)):o(l,i,r)}const c=e._zod.parse(i,r);if(c instanceof Promise){if(r.async===!1)throw new va;return c.then(l=>a(l,s,r))}return a(c,s,r)}}He(e,"~standard",()=>({validate:a=>{try{const o=M2(e,a);return o.success?{value:o.data}:{issues:o.error?.issues}}catch{return E2(e,a).then(i=>i.success?{value:i.data}:{issues:i.error?.issues})}},vendor:"zod",version:1}))}),Pl=R("$ZodString",(e,t)=>{ot.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??ok(e._zod.bag),e._zod.parse=(n,s)=>{if(t.coerce)try{n.value=String(n.value)}catch{}return typeof n.value=="string"||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),We=R("$ZodStringFormat",(e,t)=>{hr.init(e,t),Pl.init(e,t)}),kk=R("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=Z2),We.init(e,t)}),xk=R("$ZodUUID",(e,t)=>{if(t.version){const s={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(s===void 0)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=Jd(s))}else t.pattern??(t.pattern=Jd());We.init(e,t)}),$k=R("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=W2),We.init(e,t)}),Sk=R("$ZodURL",(e,t)=>{We.init(e,t),e._zod.check=n=>{try{const s=n.value.trim(),a=new URL(s);t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(a.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:t.hostname.source,input:n.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(a.protocol.endsWith(":")?a.protocol.slice(0,-1):a.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:n.value,inst:e,continue:!t.abort})),t.normalize?n.value=a.href:n.value=s;return}catch{n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!t.abort})}}}),Ck=R("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=Q2()),We.init(e,t)}),_k=R("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=V2),We.init(e,t)}),Lk=R("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=R2),We.init(e,t)}),Tk=R("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=N2),We.init(e,t)}),Ak=R("$ZodULID",(e,t)=>{t.pattern??(t.pattern=O2),We.init(e,t)}),Mk=R("$ZodXID",(e,t)=>{t.pattern??(t.pattern=F2),We.init(e,t)}),Ek=R("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=U2),We.init(e,t)}),qk=R("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=ik(t)),We.init(e,t)}),jk=R("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=sk),We.init(e,t)}),Pk=R("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=ak(t)),We.init(e,t)}),Dk=R("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=G2),We.init(e,t)}),zk=R("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=J2),We.init(e,t),e._zod.bag.format="ipv4"}),Ik=R("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=Y2),We.init(e,t),e._zod.bag.format="ipv6",e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!t.abort})}}}),Hk=R("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=X2),We.init(e,t)}),Bk=R("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=ek),We.init(e,t),e._zod.check=n=>{const s=n.value.split("/");try{if(s.length!==2)throw new Error;const[a,o]=s;if(!o)throw new Error;const i=Number(o);if(`${i}`!==o)throw new Error;if(i<0||i>128)throw new Error;new URL(`http://[${a}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!t.abort})}}});function Rm(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const Rk=R("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=tk),We.init(e,t),e._zod.bag.contentEncoding="base64",e._zod.check=n=>{Rm(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!t.abort})}});function Nk(e){if(!Im.test(e))return!1;const t=e.replace(/[-_]/g,s=>s==="-"?"+":"/"),n=t.padEnd(Math.ceil(t.length/4)*4,"=");return Rm(n)}const Ok=R("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=Im),We.init(e,t),e._zod.bag.contentEncoding="base64url",e._zod.check=n=>{Nk(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!t.abort})}}),Fk=R("$ZodE164",(e,t)=>{t.pattern??(t.pattern=nk),We.init(e,t)});function Uk(e,t=null){try{const n=e.split(".");if(n.length!==3)return!1;const[s]=n;if(!s)return!1;const a=JSON.parse(atob(s));return!("typ"in a&&a?.typ!=="JWT"||!a.alg||t&&(!("alg"in a)||a.alg!==t))}catch{return!1}}const Vk=R("$ZodJWT",(e,t)=>{We.init(e,t),e._zod.check=n=>{Uk(n.value,t.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!t.abort})}}),Gk=R("$ZodUnknown",(e,t)=>{ot.init(e,t),e._zod.parse=n=>n}),Zk=R("$ZodNever",(e,t)=>{ot.init(e,t),e._zod.parse=(n,s)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:e}),n)});function Yd(e,t,n){e.issues.length&&t.issues.push(...jm(n,e.issues)),t.value[n]=e.value}const Wk=R("$ZodArray",(e,t)=>{ot.init(e,t),e._zod.parse=(n,s)=>{const a=n.value;if(!Array.isArray(a))return n.issues.push({expected:"array",code:"invalid_type",input:a,inst:e}),n;n.value=Array(a.length);const o=[];for(let i=0;i<a.length;i++){const r=a[i],c=t.element._zod.run({value:r,issues:[]},s);c instanceof Promise?o.push(c.then(l=>Yd(l,n,i))):Yd(c,n,i)}return o.length?Promise.all(o).then(()=>n):n}});function qo(e,t,n,s,a){if(e.issues.length){if(a&&!(n in s))return;t.issues.push(...jm(n,e.issues))}e.value===void 0?n in s&&(t.value[n]=void 0):t.value[n]=e.value}function Nm(e){const t=Object.keys(e.shape);for(const s of t)if(!e.shape?.[s]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${s}": expected a Zod schema`);const n=w2(e.shape);return{...e,keys:t,keySet:new Set(t),numKeys:t.length,optionalKeys:new Set(n)}}function Om(e,t,n,s,a,o){const i=[],r=a.keySet,c=a.catchall._zod,l=c.def.type,u=c.optout==="optional";for(const p in t){if(r.has(p))continue;if(l==="never"){i.push(p);continue}const g=c.run({value:t[p],issues:[]},s);g instanceof Promise?e.push(g.then(f=>qo(f,n,p,t,u))):qo(g,n,p,t,u)}return i.length&&n.issues.push({code:"unrecognized_keys",keys:i,input:t,inst:o}),e.length?Promise.all(e).then(()=>n):n}const Kk=R("$ZodObject",(e,t)=>{if(ot.init(e,t),!Object.getOwnPropertyDescriptor(t,"shape")?.get){const r=t.shape;Object.defineProperty(t,"shape",{get:()=>{const c={...r};return Object.defineProperty(t,"shape",{value:c}),c}})}const s=Tl(()=>Nm(t));He(e._zod,"propValues",()=>{const r=t.shape,c={};for(const l in r){const u=r[l]._zod;if(u.values){c[l]??(c[l]=new Set);for(const p of u.values)c[l].add(p)}}return c});const a=Eo,o=t.catchall;let i;e._zod.parse=(r,c)=>{i??(i=s.value);const l=r.value;if(!a(l))return r.issues.push({expected:"object",code:"invalid_type",input:l,inst:e}),r;r.value={};const u=[],p=i.shape;for(const g of i.keys){const f=p[g],h=f._zod.optout==="optional",k=f._zod.run({value:l[g],issues:[]},c);k instanceof Promise?u.push(k.then(C=>qo(C,r,g,l,h))):qo(k,r,g,l,h)}return o?Om(u,l,r,c,s.value,e):u.length?Promise.all(u).then(()=>r):r}}),Qk=R("$ZodObjectJIT",(e,t)=>{Kk.init(e,t);const n=e._zod.parse,s=Tl(()=>Nm(t)),a=g=>{const f=new yk(["shape","payload","ctx"]),h=s.value,k=w=>{const y=Qd(w);return`shape[${y}]._zod.run({ value: input[${y}], issues: [] }, ctx)`};f.write("const input = payload.value;");const C=Object.create(null);let x=0;for(const w of h.keys)C[w]=`key_${x++}`;f.write("const newResult = {};");for(const w of h.keys){const y=C[w],S=Qd(w),j=g[w]?._zod?.optout==="optional";f.write(`const ${y} = ${k(w)};`),j?f.write(`
        if (${y}.issues.length) {
          if (${S} in input) {
            payload.issues = payload.issues.concat(${y}.issues.map(iss => ({
              ...iss,
              path: iss.path ? [${S}, ...iss.path] : [${S}]
            })));
          }
        }
        
        if (${y}.value === undefined) {
          if (${S} in input) {
            newResult[${S}] = undefined;
          }
        } else {
          newResult[${S}] = ${y}.value;
        }
        
      `):f.write(`
        if (${y}.issues.length) {
          payload.issues = payload.issues.concat(${y}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${S}, ...iss.path] : [${S}]
          })));
        }
        
        if (${y}.value === undefined) {
          if (${S} in input) {
            newResult[${S}] = undefined;
          }
        } else {
          newResult[${S}] = ${y}.value;
        }
        
      `)}f.write("payload.value = newResult;"),f.write("return payload;");const $=f.compile();return(w,y)=>$(g,w,y)};let o;const i=Eo,r=!Am.jitless,l=r&&b2.value,u=t.catchall;let p;e._zod.parse=(g,f)=>{p??(p=s.value);const h=g.value;return i(h)?r&&l&&f?.async===!1&&f.jitless!==!0?(o||(o=a(t.shape)),g=o(g,f),u?Om([],h,g,f,p,e):g):n(g,f):(g.issues.push({expected:"object",code:"invalid_type",input:h,inst:e}),g)}});function Xd(e,t,n,s){for(const o of e)if(o.issues.length===0)return t.value=o.value,t;const a=e.filter(o=>!oa(o));return a.length===1?(t.value=a[0].value,a[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(o=>o.issues.map(i=>Ws(i,s,Zs())))}),t)}const Jk=R("$ZodUnion",(e,t)=>{ot.init(e,t),He(e._zod,"optin",()=>t.options.some(a=>a._zod.optin==="optional")?"optional":void 0),He(e._zod,"optout",()=>t.options.some(a=>a._zod.optout==="optional")?"optional":void 0),He(e._zod,"values",()=>{if(t.options.every(a=>a._zod.values))return new Set(t.options.flatMap(a=>Array.from(a._zod.values)))}),He(e._zod,"pattern",()=>{if(t.options.every(a=>a._zod.pattern)){const a=t.options.map(o=>o._zod.pattern);return new RegExp(`^(${a.map(o=>Ml(o.source)).join("|")})$`)}});const n=t.options.length===1,s=t.options[0]._zod.run;e._zod.parse=(a,o)=>{if(n)return s(a,o);let i=!1;const r=[];for(const c of t.options){const l=c._zod.run({value:a.value,issues:[]},o);if(l instanceof Promise)r.push(l),i=!0;else{if(l.issues.length===0)return l;r.push(l)}}return i?Promise.all(r).then(c=>Xd(c,a,e,o)):Xd(r,a,e,o)}}),Yk=R("$ZodIntersection",(e,t)=>{ot.init(e,t),e._zod.parse=(n,s)=>{const a=n.value,o=t.left._zod.run({value:a,issues:[]},s),i=t.right._zod.run({value:a,issues:[]},s);return o instanceof Promise||i instanceof Promise?Promise.all([o,i]).then(([c,l])=>eu(n,c,l)):eu(n,o,i)}});function Ec(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(Oi(e)&&Oi(t)){const n=Object.keys(t),s=Object.keys(e).filter(o=>n.indexOf(o)!==-1),a={...e,...t};for(const o of s){const i=Ec(e[o],t[o]);if(!i.valid)return{valid:!1,mergeErrorPath:[o,...i.mergeErrorPath]};a[o]=i.data}return{valid:!0,data:a}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let s=0;s<e.length;s++){const a=e[s],o=t[s],i=Ec(a,o);if(!i.valid)return{valid:!1,mergeErrorPath:[s,...i.mergeErrorPath]};n.push(i.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function eu(e,t,n){const s=new Map;let a;for(const r of t.issues)if(r.code==="unrecognized_keys"){a??(a=r);for(const c of r.keys)s.has(c)||s.set(c,{}),s.get(c).l=!0}else e.issues.push(r);for(const r of n.issues)if(r.code==="unrecognized_keys")for(const c of r.keys)s.has(c)||s.set(c,{}),s.get(c).r=!0;else e.issues.push(r);const o=[...s].filter(([,r])=>r.l&&r.r).map(([r])=>r);if(o.length&&a&&e.issues.push({...a,keys:o}),oa(e))return e;const i=Ec(t.value,n.value);if(!i.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(i.mergeErrorPath)}`);return e.value=i.data,e}const Xk=R("$ZodEnum",(e,t)=>{ot.init(e,t);const n=Mm(t.entries),s=new Set(n);e._zod.values=s,e._zod.pattern=new RegExp(`^(${n.filter(a=>y2.has(typeof a)).map(a=>typeof a=="string"?gr(a):a.toString()).join("|")})$`),e._zod.parse=(a,o)=>{const i=a.value;return s.has(i)||a.issues.push({code:"invalid_value",values:n,input:i,inst:e}),a}}),ex=R("$ZodTransform",(e,t)=>{ot.init(e,t),e._zod.parse=(n,s)=>{if(s.direction==="backward")throw new Tm(e.constructor.name);const a=t.transform(n.value,n);if(s.async)return(a instanceof Promise?a:Promise.resolve(a)).then(i=>(n.value=i,n));if(a instanceof Promise)throw new va;return n.value=a,n}});function tu(e,t){return e.issues.length&&t===void 0?{issues:[],value:void 0}:e}const Fm=R("$ZodOptional",(e,t)=>{ot.init(e,t),e._zod.optin="optional",e._zod.optout="optional",He(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),He(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${Ml(n.source)})?$`):void 0}),e._zod.parse=(n,s)=>{if(t.innerType._zod.optin==="optional"){const a=t.innerType._zod.run(n,s);return a instanceof Promise?a.then(o=>tu(o,n.value)):tu(a,n.value)}return n.value===void 0?n:t.innerType._zod.run(n,s)}}),tx=R("$ZodExactOptional",(e,t)=>{Fm.init(e,t),He(e._zod,"values",()=>t.innerType._zod.values),He(e._zod,"pattern",()=>t.innerType._zod.pattern),e._zod.parse=(n,s)=>t.innerType._zod.run(n,s)}),nx=R("$ZodNullable",(e,t)=>{ot.init(e,t),He(e._zod,"optin",()=>t.innerType._zod.optin),He(e._zod,"optout",()=>t.innerType._zod.optout),He(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${Ml(n.source)}|null)$`):void 0}),He(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(n,s)=>n.value===null?n:t.innerType._zod.run(n,s)}),sx=R("$ZodDefault",(e,t)=>{ot.init(e,t),e._zod.optin="optional",He(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,s)=>{if(s.direction==="backward")return t.innerType._zod.run(n,s);if(n.value===void 0)return n.value=t.defaultValue,n;const a=t.innerType._zod.run(n,s);return a instanceof Promise?a.then(o=>nu(o,t)):nu(a,t)}});function nu(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}const ax=R("$ZodPrefault",(e,t)=>{ot.init(e,t),e._zod.optin="optional",He(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,s)=>(s.direction==="backward"||n.value===void 0&&(n.value=t.defaultValue),t.innerType._zod.run(n,s))}),ix=R("$ZodNonOptional",(e,t)=>{ot.init(e,t),He(e._zod,"values",()=>{const n=t.innerType._zod.values;return n?new Set([...n].filter(s=>s!==void 0)):void 0}),e._zod.parse=(n,s)=>{const a=t.innerType._zod.run(n,s);return a instanceof Promise?a.then(o=>su(o,e)):su(a,e)}});function su(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const ox=R("$ZodCatch",(e,t)=>{ot.init(e,t),He(e._zod,"optin",()=>t.innerType._zod.optin),He(e._zod,"optout",()=>t.innerType._zod.optout),He(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,s)=>{if(s.direction==="backward")return t.innerType._zod.run(n,s);const a=t.innerType._zod.run(n,s);return a instanceof Promise?a.then(o=>(n.value=o.value,o.issues.length&&(n.value=t.catchValue({...n,error:{issues:o.issues.map(i=>Ws(i,s,Zs()))},input:n.value}),n.issues=[]),n)):(n.value=a.value,a.issues.length&&(n.value=t.catchValue({...n,error:{issues:a.issues.map(o=>Ws(o,s,Zs()))},input:n.value}),n.issues=[]),n)}}),rx=R("$ZodPipe",(e,t)=>{ot.init(e,t),He(e._zod,"values",()=>t.in._zod.values),He(e._zod,"optin",()=>t.in._zod.optin),He(e._zod,"optout",()=>t.out._zod.optout),He(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(n,s)=>{if(s.direction==="backward"){const o=t.out._zod.run(n,s);return o instanceof Promise?o.then(i=>ao(i,t.in,s)):ao(o,t.in,s)}const a=t.in._zod.run(n,s);return a instanceof Promise?a.then(o=>ao(o,t.out,s)):ao(a,t.out,s)}});function ao(e,t,n){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},n)}const cx=R("$ZodReadonly",(e,t)=>{ot.init(e,t),He(e._zod,"propValues",()=>t.innerType._zod.propValues),He(e._zod,"values",()=>t.innerType._zod.values),He(e._zod,"optin",()=>t.innerType?._zod?.optin),He(e._zod,"optout",()=>t.innerType?._zod?.optout),e._zod.parse=(n,s)=>{if(s.direction==="backward")return t.innerType._zod.run(n,s);const a=t.innerType._zod.run(n,s);return a instanceof Promise?a.then(au):au(a)}});function au(e){return e.value=Object.freeze(e.value),e}const lx=R("$ZodCustom",(e,t)=>{Hn.init(e,t),ot.init(e,t),e._zod.parse=(n,s)=>n,e._zod.check=n=>{const s=n.value,a=t.fn(s);if(a instanceof Promise)return a.then(o=>iu(o,n,s,e));iu(a,n,s,e)}});function iu(e,t,n,s){if(!e){const a={code:"custom",input:n,inst:s,path:[...s._zod.def.path??[]],continue:!s._zod.def.abort};s._zod.def.params&&(a.params=s._zod.def.params),t.issues.push(Fi(a))}}var ou;class dx{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...n){const s=n[0];return this._map.set(t,s),s&&typeof s=="object"&&"id"in s&&this._idmap.set(s.id,t),this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const n=this._map.get(t);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(t),this}get(t){const n=t._zod.parent;if(n){const s={...this.get(n)??{}};delete s.id;const a={...s,...this._map.get(t)};return Object.keys(a).length?a:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function ux(){return new dx}(ou=globalThis).__zod_globalRegistry??(ou.__zod_globalRegistry=ux());const di=globalThis.__zod_globalRegistry;function px(e,t){return new e({type:"string",..._e(t)})}function mx(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,..._e(t)})}function ru(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,..._e(t)})}function gx(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,..._e(t)})}function vx(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",..._e(t)})}function fx(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",..._e(t)})}function hx(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",..._e(t)})}function bx(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,..._e(t)})}function yx(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,..._e(t)})}function wx(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,..._e(t)})}function kx(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,..._e(t)})}function xx(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,..._e(t)})}function $x(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,..._e(t)})}function Sx(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,..._e(t)})}function Cx(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,..._e(t)})}function _x(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,..._e(t)})}function Lx(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,..._e(t)})}function Tx(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,..._e(t)})}function Ax(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,..._e(t)})}function Mx(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,..._e(t)})}function Ex(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,..._e(t)})}function qx(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,..._e(t)})}function jx(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,..._e(t)})}function Px(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,..._e(t)})}function Dx(e,t){return new e({type:"string",format:"date",check:"string_format",..._e(t)})}function zx(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,..._e(t)})}function Ix(e,t){return new e({type:"string",format:"duration",check:"string_format",..._e(t)})}function Hx(e){return new e({type:"unknown"})}function Bx(e,t){return new e({type:"never",..._e(t)})}function Um(e,t){return new lk({check:"max_length",..._e(t),maximum:e})}function jo(e,t){return new dk({check:"min_length",..._e(t),minimum:e})}function Vm(e,t){return new uk({check:"length_equals",..._e(t),length:e})}function Rx(e,t){return new pk({check:"string_format",format:"regex",..._e(t),pattern:e})}function Nx(e){return new mk({check:"string_format",format:"lowercase",..._e(e)})}function Ox(e){return new gk({check:"string_format",format:"uppercase",..._e(e)})}function Fx(e,t){return new vk({check:"string_format",format:"includes",..._e(t),includes:e})}function Ux(e,t){return new fk({check:"string_format",format:"starts_with",..._e(t),prefix:e})}function Vx(e,t){return new hk({check:"string_format",format:"ends_with",..._e(t),suffix:e})}function Ha(e){return new bk({check:"overwrite",tx:e})}function Gx(e){return Ha(t=>t.normalize(e))}function Zx(){return Ha(e=>e.trim())}function Wx(){return Ha(e=>e.toLowerCase())}function Kx(){return Ha(e=>e.toUpperCase())}function Qx(){return Ha(e=>h2(e))}function Jx(e,t,n){return new e({type:"array",element:t,..._e(n)})}function Yx(e,t,n){return new e({type:"custom",check:"custom",fn:t,..._e(n)})}function Xx(e){const t=e$(n=>(n.addIssue=s=>{if(typeof s=="string")n.issues.push(Fi(s,n.value,t._zod.def));else{const a=s;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=n.value),a.inst??(a.inst=t),a.continue??(a.continue=!t._zod.def.abort),n.issues.push(Fi(a))}},e(n.value,n)));return t}function e$(e,t){const n=new Hn({check:"custom",..._e(t)});return n._zod.check=e,n}function Gm(e){let t=e?.target??"draft-2020-12";return t==="draft-4"&&(t="draft-04"),t==="draft-7"&&(t="draft-07"),{processors:e.processors??{},metadataRegistry:e?.metadata??di,target:t,unrepresentable:e?.unrepresentable??"throw",override:e?.override??(()=>{}),io:e?.io??"output",counter:0,seen:new Map,cycles:e?.cycles??"ref",reused:e?.reused??"inline",external:e?.external??void 0}}function kt(e,t,n={path:[],schemaPath:[]}){var s;const a=e._zod.def,o=t.seen.get(e);if(o)return o.count++,n.schemaPath.includes(e)&&(o.cycle=n.path),o.schema;const i={schema:{},count:1,cycle:void 0,path:n.path};t.seen.set(e,i);const r=e._zod.toJSONSchema?.();if(r)i.schema=r;else{const u={...n,schemaPath:[...n.schemaPath,e],path:n.path};if(e._zod.processJSONSchema)e._zod.processJSONSchema(t,i.schema,u);else{const g=i.schema,f=t.processors[a.type];if(!f)throw new Error(`[toJSONSchema]: Non-representable type encountered: ${a.type}`);f(e,t,g,u)}const p=e._zod.parent;p&&(i.ref||(i.ref=p),kt(p,t,u),t.seen.get(p).isParent=!0)}const c=t.metadataRegistry.get(e);return c&&Object.assign(i.schema,c),t.io==="input"&&qt(e)&&(delete i.schema.examples,delete i.schema.default),t.io==="input"&&i.schema._prefault&&((s=i.schema).default??(s.default=i.schema._prefault)),delete i.schema._prefault,t.seen.get(e).schema}function Zm(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const s=new Map;for(const i of e.seen.entries()){const r=e.metadataRegistry.get(i[0])?.id;if(r){const c=s.get(r);if(c&&c!==i[0])throw new Error(`Duplicate schema id "${r}" detected during JSON Schema conversion. Two different schemas cannot share the same id when converted together.`);s.set(r,i[0])}}const a=i=>{const r=e.target==="draft-2020-12"?"$defs":"definitions";if(e.external){const p=e.external.registry.get(i[0])?.id,g=e.external.uri??(h=>h);if(p)return{ref:g(p)};const f=i[1].defId??i[1].schema.id??`schema${e.counter++}`;return i[1].defId=f,{defId:f,ref:`${g("__shared")}#/${r}/${f}`}}if(i[1]===n)return{ref:"#"};const l=`#/${r}/`,u=i[1].schema.id??`__schema${e.counter++}`;return{defId:u,ref:l+u}},o=i=>{if(i[1].schema.$ref)return;const r=i[1],{ref:c,defId:l}=a(i);r.def={...r.schema},l&&(r.defId=l);const u=r.schema;for(const p in u)delete u[p];u.$ref=c};if(e.cycles==="throw")for(const i of e.seen.entries()){const r=i[1];if(r.cycle)throw new Error(`Cycle detected: #/${r.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const i of e.seen.entries()){const r=i[1];if(t===i[0]){o(i);continue}if(e.external){const l=e.external.registry.get(i[0])?.id;if(t!==i[0]&&l){o(i);continue}}if(e.metadataRegistry.get(i[0])?.id){o(i);continue}if(r.cycle){o(i);continue}if(r.count>1&&e.reused==="ref"){o(i);continue}}}function Wm(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const s=i=>{const r=e.seen.get(i);if(r.ref===null)return;const c=r.def??r.schema,l={...c},u=r.ref;if(r.ref=null,u){s(u);const g=e.seen.get(u),f=g.schema;if(f.$ref&&(e.target==="draft-07"||e.target==="draft-04"||e.target==="openapi-3.0")?(c.allOf=c.allOf??[],c.allOf.push(f)):Object.assign(c,f),Object.assign(c,l),i._zod.parent===u)for(const k in c)k==="$ref"||k==="allOf"||k in l||delete c[k];if(f.$ref&&g.def)for(const k in c)k==="$ref"||k==="allOf"||k in g.def&&JSON.stringify(c[k])===JSON.stringify(g.def[k])&&delete c[k]}const p=i._zod.parent;if(p&&p!==u){s(p);const g=e.seen.get(p);if(g?.schema.$ref&&(c.$ref=g.schema.$ref,g.def))for(const f in c)f==="$ref"||f==="allOf"||f in g.def&&JSON.stringify(c[f])===JSON.stringify(g.def[f])&&delete c[f]}e.override({zodSchema:i,jsonSchema:c,path:r.path??[]})};for(const i of[...e.seen.entries()].reverse())s(i[0]);const a={};if(e.target==="draft-2020-12"?a.$schema="https://json-schema.org/draft/2020-12/schema":e.target==="draft-07"?a.$schema="http://json-schema.org/draft-07/schema#":e.target==="draft-04"?a.$schema="http://json-schema.org/draft-04/schema#":e.target,e.external?.uri){const i=e.external.registry.get(t)?.id;if(!i)throw new Error("Schema is missing an `id` property");a.$id=e.external.uri(i)}Object.assign(a,n.def??n.schema);const o=e.external?.defs??{};for(const i of e.seen.entries()){const r=i[1];r.def&&r.defId&&(o[r.defId]=r.def)}e.external||Object.keys(o).length>0&&(e.target==="draft-2020-12"?a.$defs=o:a.definitions=o);try{const i=JSON.parse(JSON.stringify(a));return Object.defineProperty(i,"~standard",{value:{...t["~standard"],jsonSchema:{input:Po(t,"input",e.processors),output:Po(t,"output",e.processors)}},enumerable:!1,writable:!1}),i}catch{throw new Error("Error converting schema to JSON.")}}function qt(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const s=e._zod.def;if(s.type==="transform")return!0;if(s.type==="array")return qt(s.element,n);if(s.type==="set")return qt(s.valueType,n);if(s.type==="lazy")return qt(s.getter(),n);if(s.type==="promise"||s.type==="optional"||s.type==="nonoptional"||s.type==="nullable"||s.type==="readonly"||s.type==="default"||s.type==="prefault")return qt(s.innerType,n);if(s.type==="intersection")return qt(s.left,n)||qt(s.right,n);if(s.type==="record"||s.type==="map")return qt(s.keyType,n)||qt(s.valueType,n);if(s.type==="pipe")return qt(s.in,n)||qt(s.out,n);if(s.type==="object"){for(const a in s.shape)if(qt(s.shape[a],n))return!0;return!1}if(s.type==="union"){for(const a of s.options)if(qt(a,n))return!0;return!1}if(s.type==="tuple"){for(const a of s.items)if(qt(a,n))return!0;return!!(s.rest&&qt(s.rest,n))}return!1}const t$=(e,t={})=>n=>{const s=Gm({...n,processors:t});return kt(e,s),Zm(s,e),Wm(s,e)},Po=(e,t,n={})=>s=>{const{libraryOptions:a,target:o}=s??{},i=Gm({...a??{},target:o,io:t,processors:n});return kt(e,i),Zm(i,e),Wm(i,e)},n$={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},s$=(e,t,n,s)=>{const a=n;a.type="string";const{minimum:o,maximum:i,format:r,patterns:c,contentEncoding:l}=e._zod.bag;if(typeof o=="number"&&(a.minLength=o),typeof i=="number"&&(a.maxLength=i),r&&(a.format=n$[r]??r,a.format===""&&delete a.format,r==="time"&&delete a.format),l&&(a.contentEncoding=l),c&&c.size>0){const u=[...c];u.length===1?a.pattern=u[0].source:u.length>1&&(a.allOf=[...u.map(p=>({...t.target==="draft-07"||t.target==="draft-04"||t.target==="openapi-3.0"?{type:"string"}:{},pattern:p.source}))])}},a$=(e,t,n,s)=>{n.not={}},i$=(e,t,n,s)=>{},o$=(e,t,n,s)=>{const a=e._zod.def,o=Mm(a.entries);o.every(i=>typeof i=="number")&&(n.type="number"),o.every(i=>typeof i=="string")&&(n.type="string"),n.enum=o},r$=(e,t,n,s)=>{if(t.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema")},c$=(e,t,n,s)=>{if(t.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema")},l$=(e,t,n,s)=>{const a=n,o=e._zod.def,{minimum:i,maximum:r}=e._zod.bag;typeof i=="number"&&(a.minItems=i),typeof r=="number"&&(a.maxItems=r),a.type="array",a.items=kt(o.element,t,{...s,path:[...s.path,"items"]})},d$=(e,t,n,s)=>{const a=n,o=e._zod.def;a.type="object",a.properties={};const i=o.shape;for(const l in i)a.properties[l]=kt(i[l],t,{...s,path:[...s.path,"properties",l]});const r=new Set(Object.keys(i)),c=new Set([...r].filter(l=>{const u=o.shape[l]._zod;return t.io==="input"?u.optin===void 0:u.optout===void 0}));c.size>0&&(a.required=Array.from(c)),o.catchall?._zod.def.type==="never"?a.additionalProperties=!1:o.catchall?o.catchall&&(a.additionalProperties=kt(o.catchall,t,{...s,path:[...s.path,"additionalProperties"]})):t.io==="output"&&(a.additionalProperties=!1)},u$=(e,t,n,s)=>{const a=e._zod.def,o=a.inclusive===!1,i=a.options.map((r,c)=>kt(r,t,{...s,path:[...s.path,o?"oneOf":"anyOf",c]}));o?n.oneOf=i:n.anyOf=i},p$=(e,t,n,s)=>{const a=e._zod.def,o=kt(a.left,t,{...s,path:[...s.path,"allOf",0]}),i=kt(a.right,t,{...s,path:[...s.path,"allOf",1]}),r=l=>"allOf"in l&&Object.keys(l).length===1,c=[...r(o)?o.allOf:[o],...r(i)?i.allOf:[i]];n.allOf=c},m$=(e,t,n,s)=>{const a=e._zod.def,o=kt(a.innerType,t,s),i=t.seen.get(e);t.target==="openapi-3.0"?(i.ref=a.innerType,n.nullable=!0):n.anyOf=[o,{type:"null"}]},g$=(e,t,n,s)=>{const a=e._zod.def;kt(a.innerType,t,s);const o=t.seen.get(e);o.ref=a.innerType},v$=(e,t,n,s)=>{const a=e._zod.def;kt(a.innerType,t,s);const o=t.seen.get(e);o.ref=a.innerType,n.default=JSON.parse(JSON.stringify(a.defaultValue))},f$=(e,t,n,s)=>{const a=e._zod.def;kt(a.innerType,t,s);const o=t.seen.get(e);o.ref=a.innerType,t.io==="input"&&(n._prefault=JSON.parse(JSON.stringify(a.defaultValue)))},h$=(e,t,n,s)=>{const a=e._zod.def;kt(a.innerType,t,s);const o=t.seen.get(e);o.ref=a.innerType;let i;try{i=a.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}n.default=i},b$=(e,t,n,s)=>{const a=e._zod.def,o=t.io==="input"?a.in._zod.def.type==="transform"?a.out:a.in:a.out;kt(o,t,s);const i=t.seen.get(e);i.ref=o},y$=(e,t,n,s)=>{const a=e._zod.def;kt(a.innerType,t,s);const o=t.seen.get(e);o.ref=a.innerType,n.readOnly=!0},Km=(e,t,n,s)=>{const a=e._zod.def;kt(a.innerType,t,s);const o=t.seen.get(e);o.ref=a.innerType},w$=R("ZodISODateTime",(e,t)=>{qk.init(e,t),Je.init(e,t)});function k$(e){return Px(w$,e)}const x$=R("ZodISODate",(e,t)=>{jk.init(e,t),Je.init(e,t)});function $$(e){return Dx(x$,e)}const S$=R("ZodISOTime",(e,t)=>{Pk.init(e,t),Je.init(e,t)});function C$(e){return zx(S$,e)}const _$=R("ZodISODuration",(e,t)=>{Dk.init(e,t),Je.init(e,t)});function L$(e){return Ix(_$,e)}const T$=(e,t)=>{Dm.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:n=>A2(e,n)},flatten:{value:n=>T2(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,Mc,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,Mc,2)}},isEmpty:{get(){return e.issues.length===0}}})},sn=R("ZodError",T$,{Parent:Error}),A$=ql(sn),M$=jl(sn),E$=vr(sn),q$=fr(sn),j$=q2(sn),P$=j2(sn),D$=P2(sn),z$=D2(sn),I$=z2(sn),H$=I2(sn),B$=H2(sn),R$=B2(sn),rt=R("ZodType",(e,t)=>(ot.init(e,t),Object.assign(e["~standard"],{jsonSchema:{input:Po(e,"input"),output:Po(e,"output")}}),e.toJSONSchema=t$(e,{}),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone(_s(t,{checks:[...t.checks??[],...n.map(s=>typeof s=="function"?{_zod:{check:s,def:{check:"custom"},onattach:[]}}:s)]}),{parent:!0}),e.with=e.check,e.clone=(n,s)=>Ls(e,n,s),e.brand=()=>e,e.register=((n,s)=>(n.add(e,s),e)),e.parse=(n,s)=>A$(e,n,s,{callee:e.parse}),e.safeParse=(n,s)=>E$(e,n,s),e.parseAsync=async(n,s)=>M$(e,n,s,{callee:e.parseAsync}),e.safeParseAsync=async(n,s)=>q$(e,n,s),e.spa=e.safeParseAsync,e.encode=(n,s)=>j$(e,n,s),e.decode=(n,s)=>P$(e,n,s),e.encodeAsync=async(n,s)=>D$(e,n,s),e.decodeAsync=async(n,s)=>z$(e,n,s),e.safeEncode=(n,s)=>I$(e,n,s),e.safeDecode=(n,s)=>H$(e,n,s),e.safeEncodeAsync=async(n,s)=>B$(e,n,s),e.safeDecodeAsync=async(n,s)=>R$(e,n,s),e.refine=(n,s)=>e.check(qS(n,s)),e.superRefine=n=>e.check(jS(n)),e.overwrite=n=>e.check(Ha(n)),e.optional=()=>du(e),e.exactOptional=()=>yS(e),e.nullable=()=>uu(e),e.nullish=()=>du(uu(e)),e.nonoptional=n=>CS(e,n),e.array=()=>lS(e),e.or=n=>pS([e,n]),e.and=n=>gS(e,n),e.transform=n=>pu(e,hS(n)),e.default=n=>xS(e,n),e.prefault=n=>SS(e,n),e.catch=n=>LS(e,n),e.pipe=n=>pu(e,n),e.readonly=()=>MS(e),e.describe=n=>{const s=e.clone();return di.add(s,{description:n}),s},Object.defineProperty(e,"description",{get(){return di.get(e)?.description},configurable:!0}),e.meta=(...n)=>{if(n.length===0)return di.get(e);const s=e.clone();return di.add(s,n[0]),s},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e.apply=n=>n(e),e)),Qm=R("_ZodString",(e,t)=>{Pl.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(s,a,o)=>s$(e,s,a);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...s)=>e.check(Rx(...s)),e.includes=(...s)=>e.check(Fx(...s)),e.startsWith=(...s)=>e.check(Ux(...s)),e.endsWith=(...s)=>e.check(Vx(...s)),e.min=(...s)=>e.check(jo(...s)),e.max=(...s)=>e.check(Um(...s)),e.length=(...s)=>e.check(Vm(...s)),e.nonempty=(...s)=>e.check(jo(1,...s)),e.lowercase=s=>e.check(Nx(s)),e.uppercase=s=>e.check(Ox(s)),e.trim=()=>e.check(Zx()),e.normalize=(...s)=>e.check(Gx(...s)),e.toLowerCase=()=>e.check(Wx()),e.toUpperCase=()=>e.check(Kx()),e.slugify=()=>e.check(Qx())}),N$=R("ZodString",(e,t)=>{Pl.init(e,t),Qm.init(e,t),e.email=n=>e.check(mx(O$,n)),e.url=n=>e.check(bx(F$,n)),e.jwt=n=>e.check(jx(aS,n)),e.emoji=n=>e.check(yx(U$,n)),e.guid=n=>e.check(ru(cu,n)),e.uuid=n=>e.check(gx(io,n)),e.uuidv4=n=>e.check(vx(io,n)),e.uuidv6=n=>e.check(fx(io,n)),e.uuidv7=n=>e.check(hx(io,n)),e.nanoid=n=>e.check(wx(V$,n)),e.guid=n=>e.check(ru(cu,n)),e.cuid=n=>e.check(kx(G$,n)),e.cuid2=n=>e.check(xx(Z$,n)),e.ulid=n=>e.check($x(W$,n)),e.base64=n=>e.check(Mx(tS,n)),e.base64url=n=>e.check(Ex(nS,n)),e.xid=n=>e.check(Sx(K$,n)),e.ksuid=n=>e.check(Cx(Q$,n)),e.ipv4=n=>e.check(_x(J$,n)),e.ipv6=n=>e.check(Lx(Y$,n)),e.cidrv4=n=>e.check(Tx(X$,n)),e.cidrv6=n=>e.check(Ax(eS,n)),e.e164=n=>e.check(qx(sS,n)),e.datetime=n=>e.check(k$(n)),e.date=n=>e.check($$(n)),e.time=n=>e.check(C$(n)),e.duration=n=>e.check(L$(n))});function ra(e){return px(N$,e)}const Je=R("ZodStringFormat",(e,t)=>{We.init(e,t),Qm.init(e,t)}),O$=R("ZodEmail",(e,t)=>{$k.init(e,t),Je.init(e,t)}),cu=R("ZodGUID",(e,t)=>{kk.init(e,t),Je.init(e,t)}),io=R("ZodUUID",(e,t)=>{xk.init(e,t),Je.init(e,t)}),F$=R("ZodURL",(e,t)=>{Sk.init(e,t),Je.init(e,t)}),U$=R("ZodEmoji",(e,t)=>{Ck.init(e,t),Je.init(e,t)}),V$=R("ZodNanoID",(e,t)=>{_k.init(e,t),Je.init(e,t)}),G$=R("ZodCUID",(e,t)=>{Lk.init(e,t),Je.init(e,t)}),Z$=R("ZodCUID2",(e,t)=>{Tk.init(e,t),Je.init(e,t)}),W$=R("ZodULID",(e,t)=>{Ak.init(e,t),Je.init(e,t)}),K$=R("ZodXID",(e,t)=>{Mk.init(e,t),Je.init(e,t)}),Q$=R("ZodKSUID",(e,t)=>{Ek.init(e,t),Je.init(e,t)}),J$=R("ZodIPv4",(e,t)=>{zk.init(e,t),Je.init(e,t)}),Y$=R("ZodIPv6",(e,t)=>{Ik.init(e,t),Je.init(e,t)}),X$=R("ZodCIDRv4",(e,t)=>{Hk.init(e,t),Je.init(e,t)}),eS=R("ZodCIDRv6",(e,t)=>{Bk.init(e,t),Je.init(e,t)}),tS=R("ZodBase64",(e,t)=>{Rk.init(e,t),Je.init(e,t)}),nS=R("ZodBase64URL",(e,t)=>{Ok.init(e,t),Je.init(e,t)}),sS=R("ZodE164",(e,t)=>{Fk.init(e,t),Je.init(e,t)}),aS=R("ZodJWT",(e,t)=>{Vk.init(e,t),Je.init(e,t)}),iS=R("ZodUnknown",(e,t)=>{Gk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>i$()});function lu(){return Hx(iS)}const oS=R("ZodNever",(e,t)=>{Zk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>a$(e,n,s)});function rS(e){return Bx(oS,e)}const cS=R("ZodArray",(e,t)=>{Wk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>l$(e,n,s,a),e.element=t.element,e.min=(n,s)=>e.check(jo(n,s)),e.nonempty=n=>e.check(jo(1,n)),e.max=(n,s)=>e.check(Um(n,s)),e.length=(n,s)=>e.check(Vm(n,s)),e.unwrap=()=>e.element});function lS(e,t){return Jx(cS,e,t)}const dS=R("ZodObject",(e,t)=>{Qk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>d$(e,n,s,a),He(e,"shape",()=>t.shape),e.keyof=()=>vS(Object.keys(e._zod.def.shape)),e.catchall=n=>e.clone({...e._zod.def,catchall:n}),e.passthrough=()=>e.clone({...e._zod.def,catchall:lu()}),e.loose=()=>e.clone({...e._zod.def,catchall:lu()}),e.strict=()=>e.clone({...e._zod.def,catchall:rS()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=n=>$2(e,n),e.safeExtend=n=>S2(e,n),e.merge=n=>C2(e,n),e.pick=n=>k2(e,n),e.omit=n=>x2(e,n),e.partial=(...n)=>_2(Ym,e,n[0]),e.required=(...n)=>L2(Xm,e,n[0])});function Jm(e,t){const n={type:"object",shape:e??{},..._e(t)};return new dS(n)}const uS=R("ZodUnion",(e,t)=>{Jk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>u$(e,n,s,a),e.options=t.options});function pS(e,t){return new uS({type:"union",options:e,..._e(t)})}const mS=R("ZodIntersection",(e,t)=>{Yk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>p$(e,n,s,a)});function gS(e,t){return new mS({type:"intersection",left:e,right:t})}const qc=R("ZodEnum",(e,t)=>{Xk.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(s,a,o)=>o$(e,s,a),e.enum=t.entries,e.options=Object.values(t.entries);const n=new Set(Object.keys(t.entries));e.extract=(s,a)=>{const o={};for(const i of s)if(n.has(i))o[i]=t.entries[i];else throw new Error(`Key ${i} not found in enum`);return new qc({...t,checks:[],..._e(a),entries:o})},e.exclude=(s,a)=>{const o={...t.entries};for(const i of s)if(n.has(i))delete o[i];else throw new Error(`Key ${i} not found in enum`);return new qc({...t,checks:[],..._e(a),entries:o})}});function vS(e,t){const n=Array.isArray(e)?Object.fromEntries(e.map(s=>[s,s])):e;return new qc({type:"enum",entries:n,..._e(t)})}const fS=R("ZodTransform",(e,t)=>{ex.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>c$(e,n),e._zod.parse=(n,s)=>{if(s.direction==="backward")throw new Tm(e.constructor.name);n.addIssue=o=>{if(typeof o=="string")n.issues.push(Fi(o,n.value,t));else{const i=o;i.fatal&&(i.continue=!1),i.code??(i.code="custom"),i.input??(i.input=n.value),i.inst??(i.inst=e),n.issues.push(Fi(i))}};const a=t.transform(n.value,n);return a instanceof Promise?a.then(o=>(n.value=o,n)):(n.value=a,n)}});function hS(e){return new fS({type:"transform",transform:e})}const Ym=R("ZodOptional",(e,t)=>{Fm.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>Km(e,n,s,a),e.unwrap=()=>e._zod.def.innerType});function du(e){return new Ym({type:"optional",innerType:e})}const bS=R("ZodExactOptional",(e,t)=>{tx.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>Km(e,n,s,a),e.unwrap=()=>e._zod.def.innerType});function yS(e){return new bS({type:"optional",innerType:e})}const wS=R("ZodNullable",(e,t)=>{nx.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>m$(e,n,s,a),e.unwrap=()=>e._zod.def.innerType});function uu(e){return new wS({type:"nullable",innerType:e})}const kS=R("ZodDefault",(e,t)=>{sx.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>v$(e,n,s,a),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function xS(e,t){return new kS({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():qm(t)}})}const $S=R("ZodPrefault",(e,t)=>{ax.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>f$(e,n,s,a),e.unwrap=()=>e._zod.def.innerType});function SS(e,t){return new $S({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():qm(t)}})}const Xm=R("ZodNonOptional",(e,t)=>{ix.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>g$(e,n,s,a),e.unwrap=()=>e._zod.def.innerType});function CS(e,t){return new Xm({type:"nonoptional",innerType:e,..._e(t)})}const _S=R("ZodCatch",(e,t)=>{ox.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>h$(e,n,s,a),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function LS(e,t){return new _S({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const TS=R("ZodPipe",(e,t)=>{rx.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>b$(e,n,s,a),e.in=t.in,e.out=t.out});function pu(e,t){return new TS({type:"pipe",in:e,out:t})}const AS=R("ZodReadonly",(e,t)=>{cx.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>y$(e,n,s,a),e.unwrap=()=>e._zod.def.innerType});function MS(e){return new AS({type:"readonly",innerType:e})}const ES=R("ZodCustom",(e,t)=>{lx.init(e,t),rt.init(e,t),e._zod.processJSONSchema=(n,s,a)=>r$(e,n)});function qS(e,t={}){return Yx(ES,e,t)}function jS(e){return Xx(e)}const eg=Jm({name:ra().min(3,"Project name must be at least 3 characters").max(50,"Project name must be less than 50 characters").regex(/^[a-zA-Z0-9_\-\s]+$/,"Project name can only contain letters, numbers, spaces, underscores, and hyphens"),description:ra().optional(),owner_id:ra().optional(),company_id:ra().optional()});Jm({userRole:ra().optional(),userRolePrompt:ra().optional()});const jc="project-modal";let ht={mode:"create"},Tt=null,Ci=null,pt=[],Yn=[],Pc=null,Dc=[];function Ui(e){ht=e,Tt=e.project||null,Ci=e.inlineContainer?e.onCancel??(()=>{}):null;const t=PS(e.mode);if(e.inlineContainer){e.inlineContainer.innerHTML="",e.inlineContainer.appendChild(t),e.mode==="edit"&&e.project?.id?mu(t,e.project.id):gu(t);return}const n=Pe({id:jc,title:"",size:"lg",content:t}),s=n.querySelector(".modal-content");s&&s.classList.add("project-modal-content-bare");const a=n.querySelector(".modal-header");a&&a.classList.add("hidden"),document.body.appendChild(n),De(jc),e.mode==="edit"&&e.project?.id?mu(t,e.project.id):gu(t)}function fa(){Ci?(Ci(),Ci=null):K(jc)}function PS(e){const t=b("div",{className:"project-modal-sota"});return t.innerHTML=`
    <style>
      .project-modal-sota {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      .project-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
        overflow: hidden;
      }
      
      [data-theme="dark"] .project-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(15,23,42,0.95) 100%);
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      
      .project-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 32px;
        position: relative;
        overflow: hidden;
      }
      
      .project-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
      }
      
      .project-header-content {
        display: flex;
        align-items: center;
        gap: 20px;
        position: relative;
        z-index: 1;
      }
      
      .project-icon-large {
        width: 72px;
        height: 72px;
        border-radius: 18px;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid rgba(255,255,255,0.3);
        flex-shrink: 0;
      }
      
      .project-icon-large svg {
        width: 36px;
        height: 36px;
        color: white;
      }
      
      .project-title-info h2 {
        margin: 0 0 4px 0;
        font-size: 24px;
        font-weight: 700;
        color: white;
      }
      
      .project-title-info p {
        margin: 0;
        color: rgba(255,255,255,0.8);
        font-size: 14px;
      }
      
      .project-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
      }
      
      .project-close-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
      }
      
      .project-close-btn svg {
        width: 20px;
        height: 20px;
        color: white;
      }
      
      .project-tabs-nav {
        display: flex;
        gap: 0;
        padding: 0 24px;
        background: rgba(0,0,0,0.02);
        border-bottom: 1px solid rgba(0,0,0,0.06);
        overflow-x: auto;
      }
      
      [data-theme="dark"] .project-tabs-nav {
        background: rgba(255,255,255,0.02);
        border-bottom-color: rgba(255,255,255,0.06);
      }
      
      .project-tab-btn {
        padding: 16px 20px;
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .project-tab-btn:hover {
        color: #1e293b;
      }
      
      [data-theme="dark"] .project-tab-btn:hover {
        color: #e2e8f0;
      }
      
      .project-tab-btn.active {
        color: #e11d48;
      }
      
      .project-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 20px;
        right: 20px;
        height: 2px;
        background: #e11d48;
        border-radius: 2px 2px 0 0;
      }
      
      .project-tab-icon {
        width: 18px;
        height: 18px;
      }
      
      .project-body {
        padding: 32px;
        max-height: 60vh;
        overflow-y: auto;
      }
      
      .project-section {
        display: none;
      }
      
      .project-section.active {
        display: block;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
      
      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      [data-theme="dark"] .form-field label {
        color: #94a3b8;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s;
        outline: none;
      }
      
      [data-theme="dark"] .form-field input,
      [data-theme="dark"] .form-field select,
      [data-theme="dark"] .form-field textarea {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .form-field input:disabled {
        background: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
      }
      
      .form-field textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .form-hint {
        font-size: 12px;
        color: #94a3b8;
      }
      
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(0,0,0,0.06);
      }
      
      [data-theme="dark"] .form-actions {
        border-top-color: rgba(255,255,255,0.06);
      }
      
      .btn-sota {
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-sota.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .btn-sota.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-sota.secondary {
        background: #f1f5f9;
        color: #475569;
      }
      
      [data-theme="dark"] .btn-sota.secondary {
        background: rgba(255,255,255,0.1);
        color: #e2e8f0;
      }
      
      .btn-sota.secondary:hover {
        background: #e2e8f0;
      }
      
      .btn-sota.danger {
        background: transparent;
        color: #dc2626;
        border: 1px solid #fecaca;
      }
      
      .btn-sota.danger:hover {
        background: #fef2f2;
        border-color: #dc2626;
      }
      
      .btn-sota.small {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      /* Section Headers */
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      
      .section-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      [data-theme="dark"] .section-header h3 {
        color: #f1f5f9;
      }
      
      .section-header h3 svg {
        width: 20px;
        height: 20px;
        color: #e11d48;
      }
      
      /* Members List */
      .members-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .member-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid transparent;
        transition: all 0.2s;
      }
      
      [data-theme="dark"] .member-card {
        background: rgba(255,255,255,0.03);
      }
      
      .member-card:hover {
        border-color: #e2e8f0;
      }
      
      .member-card.owner {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
      }
      
      .member-info {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      
      .member-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }
      
      .member-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .member-details h4 {
        margin: 0 0 4px 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
      }
      
      [data-theme="dark"] .member-details h4 {
        color: #f1f5f9;
      }
      
      .member-details p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
      }
      
      .member-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .role-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .role-badge.owner {
        background: #e11d48;
        color: white;
      }
      
      .role-badge.admin {
        background: #8b5cf6;
        color: white;
      }
      
      .role-badge.write {
        background: #0ea5e9;
        color: white;
      }
      
      .role-badge.read {
        background: #64748b;
        color: white;
      }
      
      .role-select {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 13px;
        background: white;
        cursor: pointer;
      }
      
      [data-theme="dark"] .role-select {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      /* Role Templates List */
      .roles-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .role-card {
        padding: 20px;
        background: #f8fafc;
        border-radius: 16px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      [data-theme="dark"] .role-card {
        background: rgba(255,255,255,0.03);
      }
      
      .role-card:hover {
        border-color: #e2e8f0;
        transform: translateY(-2px);
      }
      
      .role-card.active {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
      }
      
      .role-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      
      .role-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .role-icon svg {
        width: 20px;
        height: 20px;
        color: white;
      }
      
      .role-card h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
      }
      
      [data-theme="dark"] .role-card h4 {
        color: #f1f5f9;
      }
      
      .role-card p {
        margin: 0;
        font-size: 13px;
        color: #64748b;
        line-height: 1.5;
      }
      
      .role-card .toggle-active {
        margin-top: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #64748b;
      }
      
      /* Config Section */
      .config-group {
        margin-bottom: 32px;
      }
      
      .config-group h4 {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      [data-theme="dark"] .config-group h4 {
        color: #f1f5f9;
      }
      
      .config-group h4 svg {
        width: 16px;
        height: 16px;
        color: #e11d48;
      }
      
      .api-key-field {
        display: flex;
        gap: 12px;
      }
      
      .api-key-field input {
        flex: 1;
      }
      
      .api-key-field .btn-sota {
        flex-shrink: 0;
      }
      
      /* Danger Zone */
      .danger-zone {
        background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
        border: 1px solid #fecaca;
        border-radius: 16px;
        padding: 24px;
        margin-top: 32px;
      }
      
      [data-theme="dark"] .danger-zone {
        background: linear-gradient(135deg, rgba(220,38,38,0.1) 0%, rgba(220,38,38,0.05) 100%);
        border-color: rgba(220,38,38,0.3);
      }
      
      .danger-zone h3 {
        color: #dc2626 !important;
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .danger-zone h3 svg {
        width: 18px;
        height: 18px;
      }
      
      .danger-zone p {
        color: #991b1b;
        font-size: 14px;
        margin: 0 0 16px 0;
      }
      
      [data-theme="dark"] .danger-zone p {
        color: #fca5a5;
      }
      
      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #94a3b8;
      }
      
      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      
      .empty-state p {
        margin: 0 0 16px 0;
      }
      
      /* Loading */
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 48px;
      }
      
      .loading-spinner::after {
        content: '';
        width: 32px;
        height: 32px;
        border: 3px solid #e2e8f0;
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Responsive */
      @media (max-width: 640px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
        
        .roles-grid {
          grid-template-columns: 1fr;
        }
        
        .project-tabs-nav {
          padding: 0 16px;
        }
        
        .project-tab-btn {
          padding: 14px 16px;
        }
      }
    </style>
    
    <div class="project-card">
      <div class="loading-spinner"></div>
    </div>
  `,t}async function mu(e,t){const n=e.querySelector(".project-card");if(n)try{const[s,a,o,i,r]=await Promise.all([v.get(`/api/projects/${t}`).catch(()=>null),v.get(`/api/projects/${t}/members`).catch(()=>({data:{members:[]}})),v.get("/api/role-templates").catch(()=>({data:{roles:[]}})),v.get(`/api/projects/${t}/config`).catch(()=>({data:{config:null}})),v.get("/api/contacts").catch(()=>({data:{contacts:[]}}))]);s?.data?.project&&(Tt=s.data.project),pt=a?.data?.members||[],Yn=o?.data?.roles||[],Pc=i?.data?.config||null;const c=r?.data;Dc=Array.isArray(c)?c:c?.contacts||[],vu(n)}catch{vu(n)}}function gu(e){const t=e.querySelector(".project-card");t&&(t.innerHTML=`
    <!-- Header -->
    <div class="project-header">
      <button class="project-close-btn" id="close-project-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="project-header-content">
        <div class="project-icon-large">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
        </div>
        <div class="project-title-info">
          <h2>New Project</h2>
          <p>Create a new project to organize your work</p>
        </div>
      </div>
    </div>
    
    <!-- Form -->
    <div class="project-body">
      <form id="project-form">
        <div class="form-grid">
          <div class="form-field full-width">
            <label>
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
              </svg>
              Project Name *
            </label>
            <input type="text" name="name" required placeholder="Enter project name">
          </div>
          
          <div class="form-field full-width">
            <label>
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
              </svg>
              Description
            </label>
            <textarea name="description" placeholder="Brief description of the project"></textarea>
          </div>
          <div class="form-field full-width">
            <label>
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              Company *
            </label>
            <select name="company_id" id="project-company-id">
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-sota secondary" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn-sota primary">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Create Project
          </button>
        </div>
      </form>
    </div>
  `,DS(t))}function vu(e){const t=Tt||ht.project;if(!t)return;const n=t.settings||{};e.innerHTML=`
    <!-- Header -->
    <div class="project-header">
      <button class="project-close-btn" id="close-project-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="project-header-content">
        <div class="project-icon-large">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
        </div>
        <div class="project-title-info">
          <h2>${qe(t.name)}</h2>
          <p>${t.description?qe(t.description):"No description"}</p>
        </div>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <nav class="project-tabs-nav">
      <button class="project-tab-btn active" data-tab="general">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        General
      </button>
      <button class="project-tab-btn" data-tab="members">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        Members
        <span class="badge">${pt.length}</span>
      </button>
      <button class="project-tab-btn" data-tab="roles">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        Roles
      </button>
      <button class="project-tab-btn" data-tab="config">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
        </svg>
        Config
      </button>
    </nav>
    
    <!-- Tab Content -->
    <div class="project-body">
      <!-- General Tab -->
      <div class="project-section active" id="section-general">
        <form id="project-form">
          <div class="form-grid">
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                Project Name *
              </label>
              <input type="text" name="name" required value="${qe(t.name)}" placeholder="Enter project name">
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                </svg>
                Description
              </label>
              <textarea name="description" placeholder="Brief description of the project">${qe(t.description||"")}</textarea>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Your Role
              </label>
              <input type="text" name="userRole" value="${qe(n.userRole||"")}" placeholder="e.g., Project Manager, Tech Lead">
              <span class="form-hint">Your role in this project (used for AI context)</span>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                Role Prompt
              </label>
              <input type="text" name="userRolePrompt" value="${qe(n.userRolePrompt||"")}" placeholder="e.g., I manage the project timeline">
              <span class="form-hint">Brief description of your responsibilities</span>
            </div>

            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Company
              </label>
              <select name="company_id" id="project-company-id">
                <option value="">Loading...</option>
              </select>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-sota primary">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save Changes
            </button>
          </div>
        </form>
        
        <!-- Danger Zone -->
        <div class="danger-zone">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Danger Zone
          </h3>
          <p>Deleting a project will permanently remove all associated data including questions, decisions, risks, and contacts.</p>
          <button type="button" class="btn-sota danger" id="delete-project-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Project
          </button>
        </div>
      </div>
      
      <!-- Members Tab -->
      <div class="project-section" id="section-members">
        <div class="section-header">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            Team Members
          </h3>
          <button class="btn-sota primary small" id="invite-member-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
            </svg>
            Invite
          </button>
        </div>
        
        <div class="members-list" id="members-list">
          ${Aa()}
        </div>
      </div>
      
      <!-- Roles Tab -->
      <div class="project-section" id="section-roles">
        <div class="section-header">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            Available Roles
          </h3>
          <button class="btn-sota primary small" id="add-role-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Role
          </button>
        </div>
        <p class="section-intro">
          Select which roles are available for team members in this project.
        </p>
        
        <div class="roles-grid" id="roles-grid">
          ${tg()}
        </div>
      </div>
      
      <!-- Config Tab -->
      <div class="project-section" id="section-config">
        <div class="section-header">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
            Project Configuration
          </h3>
        </div>
        <p class="section-intro-24">
          Override system defaults with project-specific API keys. Leave empty to use system defaults.
        </p>
        
        <form id="config-form">
          <!-- LLM Per-Task Configuration -->
          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
              </svg>
              LLM Model Selection
            </h4>
            <p class="section-intro-sm">
              Override system defaults for each task type. Uncheck to use platform defaults.
            </p>
            
            <!-- Text -->
            <div class="llm-task-override">
              <div class="task-header-inline">
                <label class="checkbox-inline">
                  <input type="checkbox" name="use_system_text" ${Kt("llm_pertask.useSystemDefaults.text")!=="false"?"checked":""}>
                  <span class="task-icon">üìù</span> Text / Chat
                </label>
                <span class="system-hint">(Use system default)</span>
              </div>
              <div class="task-override-fields ${Kt("llm_pertask.useSystemDefaults.text")!=="false"?"disabled":""}">
                <select name="text_provider" class="form-control" disabled>
                  <option value="">Loading...</option>
                </select>
                <select name="text_model" class="form-control" disabled>
                  <option value="">Select provider first</option>
                </select>
              </div>
            </div>
            
            <!-- Vision -->
            <div class="llm-task-override">
              <div class="task-header-inline">
                <label class="checkbox-inline">
                  <input type="checkbox" name="use_system_vision" ${Kt("llm_pertask.useSystemDefaults.vision")!=="false"?"checked":""}>
                  <span class="task-icon">üëÅÔ∏è</span> Vision
                </label>
                <span class="system-hint">(Use system default)</span>
              </div>
              <div class="task-override-fields ${Kt("llm_pertask.useSystemDefaults.vision")!=="false"?"disabled":""}">
                <select name="vision_provider" class="form-control" disabled>
                  <option value="">Loading...</option>
                </select>
                <select name="vision_model" class="form-control" disabled>
                  <option value="">Select provider first</option>
                </select>
              </div>
            </div>
            
            <!-- Embeddings -->
            <div class="llm-task-override">
              <div class="task-header-inline">
                <label class="checkbox-inline">
                  <input type="checkbox" name="use_system_embeddings" ${Kt("llm_pertask.useSystemDefaults.embeddings")!=="false"?"checked":""}>
                  <span class="task-icon">üîó</span> Embeddings
                </label>
                <span class="system-hint">(Use system default)</span>
              </div>
              <div class="task-override-fields ${Kt("llm_pertask.useSystemDefaults.embeddings")!=="false"?"disabled":""}">
                <select name="embeddings_provider" class="form-control" disabled>
                  <option value="">Loading...</option>
                </select>
                <select name="embeddings_model" class="form-control" disabled>
                  <option value="">Select provider first</option>
                </select>
              </div>
            </div>
          </div>

          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
              </svg>
              LLM API Keys
            </h4>
            <p class="section-intro-sm">
              Override system API keys for this project. Leave empty to use system defaults.
            </p>
            
            <div class="form-grid">
              <div class="form-field">
                <label>OpenAI API Key</label>
                <input type="password" name="openai_key" placeholder="sk-..." value="${qe(Kt("llm_config.openai_key"))}">
              </div>
              
              <div class="form-field">
                <label>Anthropic API Key</label>
                <input type="password" name="anthropic_key" placeholder="sk-ant-..." value="${qe(Kt("llm_config.anthropic_key"))}">
              </div>
              
              <div class="form-field">
                <label>Google AI API Key</label>
                <input type="password" name="google_key" placeholder="AI..." value="${qe(Kt("llm_config.google_key"))}">
              </div>
              
              <div class="form-field">
                <label>xAI (Grok) API Key</label>
                <input type="password" name="grok_key" placeholder="xai-..." value="${qe(Kt("llm_config.grok_key"))}">
              </div>
            </div>
          </div>
          
          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
              </svg>
              Ollama Configuration
            </h4>
            
            <div class="form-grid">
              <div class="form-field">
                <label>Ollama URL</label>
                <input type="url" name="ollama_url" placeholder="http://localhost:11434" value="${qe(Kt("ollama_config.url"))}">
              </div>
              
              <div class="form-field">
                <label>Default Model</label>
                <input type="text" name="ollama_model" placeholder="llama2, mistral, etc." value="${qe(Kt("ollama_config.model"))}">
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-sota primary">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save Configuration
            </button>
          </div>
        </form>
      </div>
    </div>
  `,zS(e)}function Aa(){return pt.length===0?`
      <div class="empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <p>No team members yet</p>
        <button class="btn-sota primary small" id="invite-first-btn">Invite Member</button>
      </div>
    `:pt.map(e=>{const t=NS(e.display_name||e.email||"U"),n=e.role==="owner";return`
      <div class="member-card ${n?"owner":""}" data-user-id="${e.user_id}">
        <div class="member-info">
          <div class="member-avatar">
            ${e.avatar_url?`<img src="${e.avatar_url}" alt="${qe(e.display_name||"")}">`:t}
          </div>
          <div class="member-details">
            <h4>${qe(e.display_name||e.email||"Unknown")}</h4>
            <p>
              ${qe(e.email||"")}
              ${e.user_role?` ‚Ä¢ <strong>${qe(e.user_role)}</strong>`:' ‚Ä¢ <em class="member-role-muted">No role defined</em>'}
              ${e.linked_contact?` ‚Ä¢ <span class="member-link" title="Linked to contact: ${qe(e.linked_contact.name)}">üîó ${qe(e.linked_contact.name)}</span>`:""}
            </p>
          </div>
        </div>
        <div class="member-actions">
          <button class="btn-sota secondary small edit-user-role-btn" data-user-id="${e.user_id}" title="Edit project role">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button class="btn-sota secondary small permissions-btn" data-user-id="${e.user_id}" title="Edit permissions">
            üîê
          </button>
          ${n?'<span class="role-badge owner">Owner</span>':`
              <select class="role-select member-role-select" data-user-id="${e.user_id}" title="Access level">
                <option value="admin" ${e.role==="admin"?"selected":""}>Admin</option>
                <option value="write" ${e.role==="write"?"selected":""}>Write</option>
                <option value="read" ${e.role==="read"?"selected":""}>Read</option>
              </select>
              <button class="btn-sota danger small remove-member-btn" data-user-id="${e.user_id}" title="Remove member">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            `}
        </div>
      </div>
    `}).join("")}function tg(){return Yn.length===0?`
      <div class="empty-state gm-grid-col-all">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        <p>No role templates available</p>
      </div>
    `:Yn.map(e=>`
    <div class="role-card ${e.is_active?"active":""}" data-role-id="${e.id}">
      <div class="role-card-header">
        <div class="role-icon">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
        <h4>${qe(e.display_name)}</h4>
      </div>
      <p>${qe(e.description||"No description")}</p>
      <div class="toggle-active">
        <input type="checkbox" id="role-${e.id}" ${e.is_active?"checked":""}>
        <label for="role-${e.id}">Active in this project</label>
      </div>
    </div>
  `).join("")}function Kt(e){if(!Pc)return"";const t=e.split(".");let n=Pc;for(const s of t)if(n&&typeof n=="object"&&s in n)n=n[s];else return"";return typeof n=="string"?n:""}function DS(e){const t=e.querySelector("#close-project-btn");t&&d(t,"click",()=>fa());const n=e.querySelector("#cancel-btn");n&&d(n,"click",()=>fa());const s=e.querySelector("#project-company-id");s&&mr().then(o=>{s.innerHTML='<option value="">Use default company</option>'+o.map(i=>`<option value="${i.id}">${qe(i.name)}</option>`).join("")}).catch(()=>{s.innerHTML='<option value="">Use default company</option>'});const a=e.querySelector("#project-form");a&&d(a,"submit",async o=>{o.preventDefault();const i=new FormData(a),r=i.get("company_id")?.trim()||void 0,c={name:i.get("name").trim(),description:i.get("description").trim()||void 0};r&&(c.company_id=r);const l=eg.safeParse(c);if(!l.success){m.error(l.error.issues[0].message);return}const u=a.querySelector('button[type="submit"]');u.disabled=!0,u.innerHTML='<span class="loading-spinner gm-size-4"></span> Creating...';try{const p=await v.post("/api/projects",c);c.id=p.data.id,m.success("Project created"),N.setCurrentProject({id:c.id,name:c.name,description:c.description}),ht.onSave?.(c),fa(),ng()}catch{m.error("Failed to create project")}finally{u.disabled=!1,u.innerHTML=`
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create Project
        `}})}function zS(e){const t=e.querySelector("#close-project-btn");t&&d(t,"click",()=>fa());const n=e.querySelectorAll(".project-tab-btn");n.forEach(u=>{d(u,"click",()=>{n.forEach(g=>g.classList.remove("active")),u.classList.add("active");const p=u.getAttribute("data-tab");e.querySelectorAll(".project-section").forEach(g=>{g.classList.toggle("active",g.id===`section-${p}`)})})});const s=e.querySelector("#project-company-id");if(s){const u=Tt||ht.project,p=u?.company_id??u?.company?.id;mr().then(g=>{s.innerHTML='<option value="">‚Äî</option>'+g.map(f=>`<option value="${f.id}" ${f.id===p?"selected":""}>${qe(f.name)}</option>`).join("")}).catch(()=>{s.innerHTML='<option value="">‚Äî</option>'})}const a=e.querySelector("#project-form");a&&d(a,"submit",async u=>{u.preventDefault();const p=new FormData(a),g=p.get("company_id")?.trim()||void 0,f={name:p.get("name").trim(),description:p.get("description").trim()||void 0,settings:{userRole:p.get("userRole").trim()||void 0,userRolePrompt:p.get("userRolePrompt").trim()||void 0}};g&&(f.company_id=g);const h=eg.safeParse(f);if(!h.success){m.error(h.error.issues[0].message);return}try{await v.put(`/api/projects/${Tt?.id||ht.project?.id}`,f),m.success("Project updated"),ht.onSave?.({...Tt,...f}),Ci&&fa();const k=e.querySelector(".project-title-info h2"),C=e.querySelector(".project-title-info p");k&&(k.textContent=String(f.name)),C&&(C.textContent=String(f.description||"No description"))}catch{m.error("Failed to update project")}});const o=e.querySelector("#delete-project-btn");o&&d(o,"click",async()=>{const u=Tt||ht.project;if(!u?.id)return;if(await xs(`Are you sure you want to delete "${u.name}"? This action cannot be undone.`,{title:"Delete Project",confirmText:"Delete",confirmClass:"btn-danger"}))try{await v.delete(`/api/projects/${u.id}`),m.success("Project deleted"),ht.onDelete?.(u.id),fa(),N.getState().currentProjectId===u.id&&N.setCurrentProject(null),ng()}catch{m.error("Failed to delete project")}});const i=e.querySelector("#invite-member-btn"),r=e.querySelector("#invite-first-btn");[i,r].forEach(u=>{u&&d(u,"click",()=>{BS()})});const c=e.querySelector("#add-role-btn");c&&d(c,"click",()=>{IS(e)}),e.querySelectorAll(".member-role-select").forEach(u=>{d(u,"change",async()=>{const p=u.getAttribute("data-user-id"),g=u.value,f=Tt?.id||ht.project?.id;if(!(!p||!f))try{await v.put(`/api/projects/${f}/members/${p}`,{role:g}),m.success("Member role updated")}catch{m.error("Failed to update role")}})}),e.querySelectorAll(".remove-member-btn").forEach(u=>{d(u,"click",async()=>{const p=u.getAttribute("data-user-id"),g=Tt?.id||ht.project?.id;if(!p||!g)return;if(await xs("Remove this member from the project?",{title:"Remove Member",confirmText:"Remove",confirmClass:"btn-danger"}))try{await v.delete(`/api/projects/${g}/members/${p}`),m.success("Member removed"),pt=pt.filter(k=>k.user_id!==p);const h=e.querySelector("#members-list");h&&(h.innerHTML=Aa(),Ma(e))}catch{m.error("Failed to remove member")}})});const l=e.querySelector("#config-form");l&&d(l,"submit",async u=>{u.preventDefault();const p=new FormData(l),g={llm_config:{openai_key:p.get("openai_key")||void 0,anthropic_key:p.get("anthropic_key")||void 0,google_key:p.get("google_key")||void 0,grok_key:p.get("grok_key")||void 0},ollama_config:{url:p.get("ollama_url")||void 0,model:p.get("ollama_model")||void 0}},f=Tt?.id||ht.project?.id;if(f)try{await v.put(`/api/projects/${f}/config`,g),m.success("Configuration saved")}catch{m.error("Failed to save configuration")}}),Ma(e)}function Ma(e){e.querySelectorAll(".edit-user-role-btn").forEach(t=>{d(t,"click",()=>{const n=t.getAttribute("data-user-id");if(!n)return;const s=pt.find(a=>a.user_id===n);s&&HS(e,s)})}),e.querySelectorAll(".permissions-btn").forEach(t=>{d(t,"click",()=>{const n=t.getAttribute("data-user-id");if(!n)return;const s=pt.find(o=>o.user_id===n),a=Tt?.id||ht.project?.id;!s||!a||Lm({projectId:a,userId:s.user_id,userName:s.display_name||"",userEmail:s.email||"",avatarUrl:s.avatar_url,currentRole:s.role,currentPermissions:s.permissions,onSave:async()=>{try{pt=(await v.get(`/api/projects/${a}/members`)).data.members||[];const i=e.querySelector("#members-list");i&&(i.innerHTML=Aa(),Ma(e))}catch{}}})})}),e.querySelectorAll(".member-role-select").forEach(t=>{d(t,"change",async()=>{const n=t.getAttribute("data-user-id"),s=t.value,a=Tt?.id||ht.project?.id;if(!(!n||!a))try{await v.put(`/api/projects/${a}/members/${n}`,{role:s}),m.success("Access level updated")}catch{m.error("Failed to update access level")}})}),e.querySelectorAll(".remove-member-btn").forEach(t=>{d(t,"click",async()=>{const n=t.getAttribute("data-user-id"),s=Tt?.id||ht.project?.id;if(!n||!s)return;if(await xs("Remove this member from the project?",{title:"Remove Member",confirmText:"Remove",confirmClass:"btn-danger"}))try{await v.delete(`/api/projects/${s}/members/${n}`),m.success("Member removed"),pt=pt.filter(i=>i.user_id!==n);const o=e.querySelector("#members-list");o&&(o.innerHTML=Aa(),Ma(e))}catch{m.error("Failed to remove member")}})})}function IS(e){const t=e.querySelector(".add-role-dialog");t&&t.remove();const n=Tt?.id||ht.project?.id;if(!n)return;const s=b("div",{className:"add-role-dialog"});s.innerHTML=`
    <style>
      .add-role-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        backdrop-filter: blur(4px);
      }
      
      .add-role-card {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        overflow: hidden;
      }
      
      [data-theme="dark"] .add-role-card {
        background: #1e293b;
      }
      
      .add-role-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 20px 24px;
        color: white;
      }
      
      .add-role-header h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
      }
      
      .add-role-body {
        padding: 24px;
      }
      
      .add-role-field {
        margin-bottom: 20px;
      }
      
      .add-role-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 8px;
      }
      
      .add-role-field input,
      .add-role-field textarea,
      .add-role-field select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        box-sizing: border-box;
        background: #f8fafc;
      }
      
      [data-theme="dark"] .add-role-field input,
      [data-theme="dark"] .add-role-field textarea,
      [data-theme="dark"] .add-role-field select {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .add-role-field input:focus,
      .add-role-field textarea:focus,
      .add-role-field select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
      }
      
      .add-role-field textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .add-role-ai-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: all 0.2s;
      }
      
      .add-role-ai-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139,92,246,0.3);
      }
      
      .add-role-ai-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      .add-role-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
      }
      
      [data-theme="dark"] .add-role-actions {
        border-color: rgba(255,255,255,0.1);
      }
    </style>
    
    <div class="add-role-card">
      <div class="add-role-header">
        <h4>Add New Role</h4>
      </div>
      <div class="add-role-body">
        <form id="add-role-form">
          <div class="add-role-field">
            <label>Role Name *</label>
            <input type="text" id="new-role-name" required placeholder="e.g., Senior Developer, Tech Lead">
          </div>
          
          <div class="add-role-field">
            <label>Category</label>
            <select id="new-role-category">
              <option value="project">üìã Project</option>
              <option value="technical">üíª Technical</option>
              <option value="management">üëî Management</option>
              <option value="stakeholder">ü§ù Stakeholder</option>
              <option value="custom">‚ú® Custom</option>
            </select>
          </div>
          
          <div class="add-role-field">
            <label>Description</label>
            <input type="text" id="new-role-description" placeholder="Brief description of this role">
          </div>
          
          <div class="add-role-field">
            <label>Role Context (for AI)</label>
            <textarea id="new-role-context" placeholder="Describe this role's responsibilities, priorities, and how the AI should adapt responses..."></textarea>
            <button type="button" class="add-role-ai-btn" id="enhance-role-btn">
              ‚ö° Enhance with AI
            </button>
          </div>
          
          <div class="add-role-actions">
            <button type="button" class="btn-sota secondary" id="cancel-add-role">Cancel</button>
            <button type="submit" class="btn-sota primary">Create Role</button>
          </div>
        </form>
      </div>
    </div>
  `,e.appendChild(s);const a=()=>s.remove(),o=s.querySelector("#cancel-add-role");o&&d(o,"click",a),d(s,"click",c=>{c.target===s&&a()});const i=s.querySelector("#enhance-role-btn");i&&d(i,"click",async()=>{const c=s.querySelector("#new-role-name"),l=s.querySelector("#new-role-context"),u=s.querySelector("#new-role-description"),p=c.value.trim();if(!p){m.error("Please enter a role name first");return}i.disabled=!0,i.textContent="‚è≥ Enhancing...";try{const g=await v.post("/api/roles/generate",{title:p,currentContext:l.value});g.data.prompt&&(l.value=g.data.prompt),g.data.description&&!u.value&&(u.value=g.data.description),m.success("Role context enhanced")}catch{m.error("Failed to enhance with AI")}finally{i.disabled=!1,i.textContent="‚ö° Enhance with AI"}});const r=s.querySelector("#add-role-form");r&&d(r,"submit",async c=>{c.preventDefault();const l=s.querySelector("#new-role-name").value.trim(),u=s.querySelector("#new-role-category").value,p=s.querySelector("#new-role-description").value.trim(),g=s.querySelector("#new-role-context").value.trim();if(!l){m.error("Role name is required");return}try{await v.post("/api/role-templates",{name:l.toLowerCase().replace(/\s+/g,"_"),display_name:l,description:p,role_context:g,category:u,color:"#e11d48",is_template:!0}),m.success("Role created"),a(),await RS(n);const f=e.querySelector("#roles-grid");f&&(f.innerHTML=tg())}catch{m.error("Failed to create role")}}),setTimeout(()=>{const c=s.querySelector("#new-role-name");c&&c.focus()},100)}function HS(e,t){const n=e.querySelector(".user-role-edit-dialog");n&&n.remove();const s=Tt?.id||ht.project?.id;if(!s)return;const a=b("div",{className:"user-role-edit-dialog"});a.innerHTML=`
    <style>
      .user-role-edit-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        padding: 24px;
        z-index: 10001;
        width: 400px;
        max-width: 90vw;
      }
      
      [data-theme="dark"] .user-role-edit-dialog {
        background: #1e293b;
      }
      
      .user-role-edit-dialog h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      [data-theme="dark"] .user-role-edit-dialog h3 {
        color: #f1f5f9;
      }
      
      .user-role-edit-dialog h3 svg {
        width: 20px;
        height: 20px;
        color: #e11d48;
      }
      
      .user-role-edit-dialog .form-field {
        margin-bottom: 16px;
      }
      
      .user-role-edit-dialog .form-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 6px;
      }
      
      [data-theme="dark"] .user-role-edit-dialog .form-field label {
        color: #94a3b8;
      }
      
      .user-role-edit-dialog .form-field input,
      .user-role-edit-dialog .form-field textarea,
      .user-role-edit-dialog .form-field select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        background: #f8fafc;
        color: #1e293b;
        box-sizing: border-box;
      }
      
      [data-theme="dark"] .user-role-edit-dialog .form-field input,
      [data-theme="dark"] .user-role-edit-dialog .form-field textarea,
      [data-theme="dark"] .user-role-edit-dialog .form-field select {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .user-role-edit-dialog .form-field input:focus,
      .user-role-edit-dialog .form-field textarea:focus,
      .user-role-edit-dialog .form-field select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .user-role-edit-dialog .form-field textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .user-role-edit-dialog .form-hint {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
      }
      
      .user-role-edit-dialog .linked-contact-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
        border: 1px solid rgba(225,29,72,0.2);
        border-radius: 10px;
        margin-top: 8px;
      }
      
      .user-role-edit-dialog .linked-contact-info svg {
        width: 16px;
        height: 16px;
        color: #e11d48;
        flex-shrink: 0;
      }
      
      .user-role-edit-dialog .linked-contact-info span {
        font-size: 13px;
        color: #1e293b;
      }
      
      [data-theme="dark"] .user-role-edit-dialog .linked-contact-info span {
        color: #f1f5f9;
      }
      
      .user-role-edit-dialog .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      
      .user-role-edit-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 10000;
      }
    </style>
    
    <h3>
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      Edit Project Role
    </h3>
    <p class="section-intro-last">
      Define <strong>${qe(t.display_name||t.email||"this member")}</strong>'s role in the project
    </p>
    
    <div class="form-field">
      <label>Role Title</label>
      <select id="edit-user-role">
        <option value="">-- Select a role --</option>
        ${Yn.filter(f=>f.is_active).map(f=>`
          <option value="${qe(f.display_name||f.name)}" 
                  data-prompt="${qe(f.prompt_template||"")}"
                  ${t.user_role===f.display_name||t.user_role===f.name?"selected":""}>
            ${qe(f.display_name||f.name)}
          </option>
        `).join("")}
        <option value="__custom__" ${t.user_role&&!Yn.some(f=>f.display_name===t.user_role||f.name===t.user_role)?"selected":""}>Custom role...</option>
      </select>
      <div class="form-hint">Select a predefined role or choose "Custom role" for a custom title</div>
      <input type="text" id="edit-user-role-custom" 
             value="${t.user_role&&!Yn.some(f=>f.display_name===t.user_role||f.name===t.user_role)?qe(t.user_role):""}" 
             placeholder="Enter custom role title"
             class="gm-mt-2 ${t.user_role&&!Yn.some(f=>f.display_name===t.user_role||f.name===t.user_role)?"":"hidden"}">
    </div>
    
    <div class="form-field">
      <label>Role Description</label>
      <textarea id="edit-user-role-prompt" placeholder="e.g., I manage the technical architecture and lead the development team">${qe(t.user_role_prompt||"")}</textarea>
      <div class="form-hint">Brief description of responsibilities (used for AI context)</div>
    </div>
    
    <div class="form-field">
      <label>
        <svg class="gm-inline-icon" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        Link to Contact
      </label>
      <select id="edit-linked-contact">
        <option value="">-- No linked contact --</option>
        ${Dc.map(f=>`
          <option value="${f.id}" ${t.linked_contact_id===f.id?"selected":""}>
            ${qe(f.name)}${f.organization?` (${qe(f.organization)})`:""}${f.email?` - ${qe(f.email)}`:""}
          </option>
        `).join("")}
      </select>
      <div class="form-hint">Associate this team member with a project contact</div>
      ${t.linked_contact?`
        <div class="linked-contact-info">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
          </svg>
          <span>Currently linked to: <strong>${qe(t.linked_contact.name)}</strong></span>
        </div>
      `:""}
    </div>
    
    <div class="dialog-actions">
      <button class="btn-sota secondary" id="cancel-role-edit">Cancel</button>
      <button class="btn-sota primary" id="save-role-edit">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Save Role
      </button>
    </div>
  `;const o=b("div",{className:"user-role-edit-overlay"});document.body.appendChild(o),document.body.appendChild(a);const i=a.querySelector("#edit-user-role"),r=a.querySelector("#edit-user-role-custom"),c=a.querySelector("#edit-user-role-prompt");setTimeout(()=>i?.focus(),100),d(i,"change",()=>{const f=i.options[i.selectedIndex],h=i.value==="__custom__";r.classList.toggle("hidden",!h),h&&r.focus(),!h&&f.dataset.prompt&&(c.value=f.dataset.prompt)});const l=a.querySelector("#cancel-role-edit"),u=()=>{o.remove(),a.remove()};d(l,"click",u),d(o,"click",u);const p=a.querySelector("#save-role-edit");d(p,"click",async()=>{const f=i.value,h=f==="__custom__"?r.value.trim():f,k=a.querySelector("#edit-user-role-prompt").value.trim(),C=a.querySelector("#edit-linked-contact").value||null;try{await v.put(`/api/projects/${s}/members/${t.user_id}`,{user_role:h,user_role_prompt:k,linked_contact_id:C});const x=pt.findIndex(w=>w.user_id===t.user_id);if(x!==-1)if(pt[x].user_role=h,pt[x].user_role_prompt=k,pt[x].linked_contact_id=C||void 0,C){const w=Dc.find(y=>y.id===C);w&&(pt[x].linked_contact={id:w.id,name:w.name,email:w.email,organization:w.organization,role:w.role})}else pt[x].linked_contact=void 0;const $=e.querySelector("#members-list");$&&($.innerHTML=Aa(),Ma(e)),m.success("Project role updated"),u()}catch{m.error("Failed to update role")}});const g=f=>{f.key==="Escape"&&(u(),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g)}async function BS(){const{showInviteModal:e}=await xe(async()=>{const{showInviteModal:n}=await Promise.resolve().then(()=>p5);return{showInviteModal:n}},void 0),t=Tt?.id||ht.project?.id;t&&e({projectId:t,onInvite:async()=>{try{pt=(await v.get(`/api/projects/${t}/members`)).data.members||[];const s=document.querySelector("#members-list");s&&(s.innerHTML=Aa(),Ma(s.closest(".project-card")))}catch{}}})}async function ng(){try{const e=await v.get("/api/projects");ce.setProjects(e.data)}catch{}}async function RS(e){try{Yn=(await v.get("/api/role-templates")).data.roles||[]}catch{Yn=[]}}function NS(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function qe(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const OS=Object.freeze(Object.defineProperty({__proto__:null,showProjectModal:Ui},Symbol.toStringTag,{value:"Module"}));function FS(e={}){const t=e.containerId?document.getElementById(e.containerId):document.getElementById("project-selector-container");if(!t)return;t.innerHTML=`
    <div class="project-selector-wrapper">
      <select id="project-selector" class="project-selector">
        <option value="">Select Project...</option>
      </select>
      <button id="new-project-btn" class="btn-icon" title="Create new project">+</button>
      <button id="edit-project-btn" class="btn-icon hidden" title="Edit project">‚úèÔ∏è</button>
    </div>
  `;const n=t.querySelector("#project-selector"),s=t.querySelector("#new-project-btn"),a=t.querySelector("#edit-project-btn");oo(n),d(n,"change",async()=>{const o=n.value;o?(await sg(o,e.onProjectChange),a.classList.remove("hidden")):a.classList.add("hidden")}),d(s,"click",()=>{Ui({mode:"create",onSave:async o=>{await oo(n),o.id&&(n.value=o.id,a.classList.remove("hidden"),e.onProjectChange?.(o.id))}})}),d(a,"click",()=>{const o=N.getState().currentProject;o&&Ui({mode:"edit",project:o,onSave:async()=>{await oo(n)},onDelete:async()=>{await oo(n),a.classList.add("hidden")}})}),ce.subscribe(o=>{Do(n,o.projects)}),N.subscribe(o=>{o.currentProjectId&&n.value!==o.currentProjectId&&(n.value=o.currentProjectId,a.classList.remove("hidden"))})}async function oo(e){const t=await ks.getAll();Do(e,t);const n=N.getState().currentProjectId;n&&(e.value=n)}function Do(e,t){const n=e.value;e.innerHTML='<option value="">Select Project...</option>',t.forEach(s=>{const a=document.createElement("option");a.value=s.id,a.textContent=s.name+(s.isDefault?" (default)":""),e.appendChild(a)}),n&&t.some(s=>s.id===n)&&(e.value=n)}async function sg(e,t){try{const n=await ks.activate(e);n&&(m.success(`Switched to: ${n.name}`),t?.(e))}catch{m.error("Failed to switch project")}}function US(e={}){const t=b("div",{className:"project-selector-wrapper"}),n=b("select",{className:"project-selector",id:"project-selector"}),s=b("option",{textContent:"Select Project..."});s.value="",n.appendChild(s);const a=b("button",{className:"btn-icon",textContent:"+",title:"Create new project"});return t.appendChild(n),t.appendChild(a),ks.getAll().then(o=>{Do(n,o);const i=N.getState().currentProjectId;i&&(n.value=i)}),d(n,"change",async()=>{const o=n.value;o&&await sg(o,e.onProjectChange)}),d(a,"click",()=>{Ui({mode:"create",onSave:async o=>{const i=await ks.getAll();Do(n,i),o.id&&(n.value=o.id,e.onProjectChange?.(o.id))}})}),t}function _i(e,t="en-US"){return new Intl.NumberFormat(t).format(e)}function Os(e,t){return(typeof e=="string"?new Date(e):e).toLocaleDateString(void 0,t)}function Ts(e){return(typeof e=="string"?new Date(e):e).toLocaleString()}function Ce(e){const t=typeof e=="string"?new Date(e):e,n=new Date,s=n.getTime()-t.getTime(),a=Math.floor(s/1e3),o=Math.floor(a/60),i=Math.floor(o/60),r=Math.floor(i/24);if(s<0){const p=Math.ceil(Math.abs(s)/864e5);return p===0?"today":p===1?"tomorrow":p<7?`in ${p} days`:Os(t,{month:"short",day:"numeric"})}if(a<60)return"just now";if(o<60)return`${o} min${o===1?"":"s"} ago`;if(i<24)return`${i} hour${i===1?"":"s"} ago`;const c=new Date(n);if(c.setDate(c.getDate()-1),VS(t,c))return"yesterday";const l=GS(n);if(t>=l)return"this week";const u=new Date(l);return u.setDate(u.getDate()-7),t>=u?"last week":r<30?`${r} days ago`:t.getFullYear()===n.getFullYear()?Os(t,{month:"short",day:"numeric"}):Os(t,{year:"numeric",month:"short",day:"numeric"})}function VS(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function GS(e){const t=new Date(e),n=t.getDay();return t.setDate(t.getDate()-n),t.setHours(0,0,0,0),t}function Ji(e){if(e===0)return"0 B";const t=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,n)).toFixed(n>0?1:0)} ${t[n]}`}function Ln(e,t="USD",n="en-US"){return new Intl.NumberFormat(n,{style:"currency",currency:t}).format(e)}const ZS={dashboard:'<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>',questions:'<circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line>',risks:'<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>',actions:'<polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>',decisions:'<circle cx="12" cy="12" r="10"></circle><path d="M22 12h-4"></path><path d="M6 12H2"></path><path d="M12 6V2"></path><path d="M12 22v-4"></path>',facts:'<path d="M12 2a6 6 0 0 1 6 6c0 7-6 9-6 9s-6-2-6-9a6 6 0 0 1 6-6z"></path><path d="M12 18v2"></path>',settings:'<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',user:'<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>',bell:'<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>',search:'<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',plus:'<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',check:'<polyline points="20 6 9 17 4 12"></polyline>',alert:'<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>',info:'<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>',close:'<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',"arrow-right":'<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>',"arrow-left":'<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>',"chevron-down":'<polyline points="6 9 12 15 18 9"></polyline>',"chevron-up":'<polyline points="18 15 12 9 6 15"></polyline>',timeline:'<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>',graph:'<circle cx="12" cy="12" r="3"></circle><path d="M19 5a2 2 0 0 0-2 2v0"></path><path d="M5 19a2 2 0 0 0 2 2v0"></path>',team:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>',documents:'<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>',email:'<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>'};function WS(e,t={}){const n=t.size||24,s=t.strokeWidth||2,a=t.color||"currentColor",o=b("div",{className:`sota-icon ${t.className||""}`,style:`display: inline-flex; align-items: center; justify-content: center; width: ${n}px; height: ${n}px;`});return o.innerHTML=`
    <svg 
      xmlns="http://www.w3.org/2000/svg" 
      width="${n}" 
      height="${n}" 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="${a}" 
      stroke-width="${s}" 
      stroke-linecap="round" 
      stroke-linejoin="round"
    >
      ${ZS[e]||""}
    </svg>
  `,o.firstElementChild}function zo(e={}){const t=b("div",{className:"dashboard"}),n=b("div",{className:"dashboard-row"}),s=b("div",{id:"dashboard-stats-grid",className:"stats-grid"});n.appendChild(s);const a=b("div",{id:"dashboard-insights",className:"dashboard-insights-row"}),o=b("div",{id:"dashboard-overdue",className:"dashboard-overdue-section"}),i=b("div",{id:"dashboard-alerts",className:"dashboard-alerts-section"}),r=b("div",{id:"dashboard-briefing",className:"dashboard-briefing-section"}),c=b("div",{id:"dashboard-golden-hours",className:"dashboard-golden-hours-section"}),l=b("div",{className:"dashboard-charts-row"}),u=b("div",{id:"questions-chart",className:"chart-container"}),p=b("div",{id:"facts-chart",className:"chart-container"}),g=b("div",{id:"trends-chart",className:"chart-container"});l.appendChild(u),l.appendChild(p),l.appendChild(g);const f=b("div",{className:"dashboard-bottom-row"}),h=b("div",{id:"dashboard-health",className:"dashboard-health-card"}),k=b("div",{id:"risk-summary-container",className:"dashboard-risk-summary-card"});return f.appendChild(h),f.appendChild(k),t.appendChild(n),t.appendChild(a),t.appendChild(o),t.appendChild(i),t.appendChild(r),t.appendChild(c),t.appendChild(l),t.appendChild(f),KS(t,e),t}async function KS(e,t){const n=e.querySelector("#dashboard-health"),s=e.querySelector("#dashboard-briefing"),a=e.querySelector("#dashboard-stats-grid"),o=e.querySelector("#dashboard-overdue"),i=e.querySelector("#dashboard-alerts"),r=e.querySelector("#dashboard-insights"),c=e.querySelector("#risk-summary-container"),l=e.querySelector("#dashboard-golden-hours"),u=N.getState().currentProject,p=N.getState().currentProjectId;if(!u&&!p){if(a){a.innerHTML=`
        <div class="no-project-state">
          <svg class="no-project-icon" width="80" height="80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <h2 class="no-project-title">No Project Selected</h2>
          <p class="no-project-desc">
            Select a project from the dropdown in the header to view your dashboard, or create a new project to get started.
          </p>
          <div class="no-project-actions">
            <button class="btn btn-primary create-project-btn no-project-btn">
              <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Create New Project
            </button>
          </div>
        </div>
      `;const g=a.querySelector(".create-project-btn");g&&g.addEventListener("click",async()=>{const{showProjectModal:f}=await xe(async()=>{const{showProjectModal:h}=await Promise.resolve().then(()=>OS);return{showProjectModal:h}},void 0);f({mode:"create",onSave:()=>{window.dispatchEvent(new CustomEvent("godmode:project-created"))}})})}n&&(n.innerHTML=""),s&&(s.innerHTML=""),o&&(o.innerHTML=""),i&&(i.innerHTML=""),r&&(r.innerHTML=""),c&&(c.innerHTML=""),l&&(l.innerHTML="");return}a&&(a.innerHTML='<div class="loading-placeholder">Loading dashboard...</div>'),s&&!s.hasChildNodes()&&xe(async()=>{const{createBriefingPanel:g}=await Promise.resolve().then(()=>wT);return{createBriefingPanel:g}},void 0).then(({createBriefingPanel:g})=>{const f=g();s.appendChild(f)}).catch(g=>console.error("Failed to load BriefingPanel:",g));try{const{dashboard:g,health:f,insights:h,alerts:k}=await xl.loadAll();if(!e.isConnected){console.log("[Dashboard] Component unmounted during load, aborting render.");return}if(n&&f&&QS(n,f),a&&g&&JS(a,g,t.onStatClick),o&&g&&g.overdueActions>0&&aC(o,g.overdueActions),i&&k.length>0&&YS(i,k,t.onAlertClick),r&&h.length>0&&XS(r,h,t.onInsightAction),g&&(nC(g),tC(g),sC(g).catch(C=>console.error("Failed to render trends chart:",C))),c&&!c.hasChildNodes()&&jt.getAll().then(C=>{eC(c,C)}).catch(C=>console.error("Failed to load Risk Summary:",C)),l&&!l.hasChildNodes()){const C=p||u?.id;C&&oC(l,C)}}catch(g){e.isConnected&&(console.error("Failed to load dashboard:",g),a&&(a.innerHTML='<div class="error-message">Failed to load dashboard data</div>'))}}function QS(e,t){if(e.innerHTML="",!t||typeof t.status!="string"){const h=b("div",{className:"health-indicator unknown"}),k=b("div",{className:"health-gauge"}),C=b("span",{className:"score-value"},["--"]),x=b("span",{className:"score-label"},["Health"]);k.appendChild(C),k.appendChild(x);const $=b("p",{className:"health-status"},["Health data unavailable"]);h.appendChild(k),h.appendChild($),e.appendChild(h);return}const n=t.status.toLowerCase().replace(/\s+/g,"-"),s=t.score??0,a=t.color||"#888",o=t.factors||[],i=b("div",{className:`health-indicator ${n}`}),r=b("div",{className:"health-gauge"}),c=b("div",{className:"health-score",style:`--score: ${s}%`});c.appendChild(b("span",{className:"score-value"},[String(s)])),c.appendChild(b("span",{className:"score-label"},["Health"]));const l=b("div",{className:"health-bar"}),u=b("div",{className:"health-fill",style:`--fill-width: ${s}%; --fill-color: ${a}`});l.appendChild(u),r.appendChild(c),r.appendChild(l);const p=b("div",{className:"health-status"}),g=b("span",{className:"status-text",style:`--status-color: ${a}`},[t.status]);p.appendChild(g);const f=b("div",{className:"health-factors"});o.slice(0,3).forEach(h=>{const k=b("div",{className:`factor ${h.type}`}),C=h.type==="positive"?"check":"alert",x=WS(C,{size:14,className:"factor-icon"}),$=b("span",{className:"factor-text"},[h.factor]);k.appendChild(x),k.appendChild($),f.appendChild(k)}),i.appendChild(r),i.appendChild(p),i.appendChild(f),e.appendChild(i)}function JS(e,t,n){t.documents;const s=t.questionsByPriority||{resolved:0},a=t.risksByImpact||{high:0},o=t.factsVerifiedCount??0,i=[{id:"facts",label:"Facts",value:t.totalFacts??0,sub:o>0?`${o} verified`:void 0,icon:"üí°"},{id:"questions",label:"Questions",value:t.totalQuestions??0,sub:`${s.resolved} resolved`,icon:"‚ùì"},{id:"decisions",label:"Decisions",value:t.totalDecisions??0,icon:"üéØ"},{id:"risks",label:"Risks",value:t.totalRisks??0,sub:`${a.high} high`,icon:"‚ö†Ô∏è"},{id:"actions",label:"Actions",value:t.totalActions??0,sub:`${t.overdueActions??0} overdue`,icon:"‚úÖ"}];e.innerHTML="",i.forEach(r=>{const c=b("div",{className:"stat-card","data-stat-id":r.id}),l=b("div",{className:"stat-value"},[String(r.value)]),u=b("div",{className:"stat-label"},[r.label]);if(c.appendChild(l),c.appendChild(u),r.sub){const p=b("div",{className:"stat-sub"},[r.sub]);c.appendChild(p)}n&&(c.classList.add("clickable"),c.addEventListener("click",()=>n(r.id))),e.appendChild(c)})}function YS(e,t,n){e.innerHTML="";const s=b("div",{className:"alerts-header"});s.appendChild(b("h3",{},["Alerts"])),s.appendChild(b("span",{className:"alerts-count"},[String(t.length)])),e.appendChild(s);const a=b("div",{className:"alerts-list"});t.slice(0,5).forEach((o,i)=>{const r=b("div",{className:`alert-item ${o.severity}`,"data-alert-index":String(i)}),c=b("span",{className:"alert-icon"},[iC(o.severity)]),l=b("div",{className:"alert-content"});l.appendChild(b("div",{className:"alert-title"},[o.title])),l.appendChild(b("div",{className:"alert-message"},[o.message])),r.appendChild(c),r.appendChild(l),n&&r.addEventListener("click",()=>n(o)),a.appendChild(r)}),e.appendChild(a)}function XS(e,t,n){e.innerHTML="",t.slice(0,4).forEach((s,a)=>{const o=b("div",{className:`insight-item ${s.type}`,"data-insight-index":String(a)}),i=b("span",{className:"insight-icon"},[s.icon]),r=b("div",{className:"insight-content"});r.appendChild(b("div",{className:"insight-title"},[s.title])),r.appendChild(b("div",{className:"insight-message"},[s.message])),o.appendChild(i),o.appendChild(r),e.appendChild(o)})}function eC(e,t){const n=(w,y)=>{const S=["low","medium","high","critical"].indexOf(w?.toLowerCase()||"low"),P=["low","medium","high"].indexOf(y?.toLowerCase()||"low"),j=S+P;return j>=4?"critical":j>=3?"high":j>=2?"medium":"low"},s=t.filter(w=>w.status!=="mitigated"&&w.status!=="closed"),a={critical:0,high:0,medium:0,low:0};s.forEach(w=>{const y=n(w.impact,w.likelihood);a[y]++});const o=s.length,i=t.length-s.length,r=w=>o>0?Math.round(w/o*100):0;let c="",l=0;const u={critical:"#ef4444",high:"#f97316",medium:"#eab308",low:"#22c55e"};["critical","high","medium","low"].forEach(w=>{const S=r(a[w])/100*360;S>0&&(c+=`${u[w]} ${l}deg ${l+S}deg, `,l+=S)}),c?c=c.slice(0,-2):c="var(--color-border) 0deg 360deg",e.innerHTML="";const p=b("div",{className:"risk-summary"}),g=b("div",{className:"risk-summary-header"});g.appendChild(b("h4",{},["Risk Overview"])),g.appendChild(b("span",{className:"risk-total"},[`${o} active`])),p.appendChild(g);const f=b("div",{className:"risk-summary-content"}),h=b("div",{className:"risk-donut-container"}),k=b("div",{className:"risk-donut",style:`--donut-conic: conic-gradient(${c})`}),C=b("div",{className:"risk-donut-center"});C.appendChild(b("span",{className:"donut-value"},[String(o)])),C.appendChild(b("span",{className:"donut-label"},["Risks"])),k.appendChild(C),h.appendChild(k),f.appendChild(h);const x=b("div",{className:"risk-bars"});if([{id:"critical",icon:"üî¥",label:"Critical"},{id:"high",icon:"üü†",label:"High"},{id:"medium",icon:"üü°",label:"Medium"},{id:"low",icon:"üü¢",label:"Low"}].forEach(w=>{const y=a[w.id],S=b("div",{className:`risk-bar-item ${w.id}`});S.appendChild(b("span",{className:"bar-icon"},[w.icon])),S.appendChild(b("span",{className:"bar-label"},[w.label]));const P=b("div",{className:"bar-track"});P.appendChild(b("div",{className:"bar-fill",style:`--bar-width: ${r(y)}%`})),S.appendChild(P),S.appendChild(b("span",{className:"bar-count"},[String(y)])),x.appendChild(S)}),f.appendChild(x),p.appendChild(f),i>0){const w=b("div",{className:"risk-mitigated"});w.appendChild(b("span",{className:"mitigated-icon"},["‚úì"])),w.appendChild(b("span",{},[`${i} risk${i!==1?"s":""} mitigated`])),p.appendChild(w)}e.appendChild(p)}function tC(e){const t=document.getElementById("facts-chart");if(!t)return;t.innerHTML="";const n=e.factsByCategory||{},s=["technical","process","policy","people","timeline","general"],a=s.reduce((i,r)=>i+(n[r]??0),0);if(a===0){t.appendChild(b("div",{className:"empty-chart"},["No facts yet"]));return}t.appendChild(b("div",{className:"facts-chart-title"},["Facts by category"]));const o=b("div",{className:"priority-bars"});s.forEach(i=>{const r=n[i]??0,c=a>0?r/a*100:0,l=b("div",{className:"priority-bar"});l.appendChild(b("div",{className:"bar-label"},[i]));const u=b("div",{className:"bar-track"}),p=b("div",{className:"bar-fill",style:`--bar-width: ${c}%`});u.appendChild(p),l.appendChild(u),l.appendChild(b("div",{className:"bar-value"},[String(r)])),o.appendChild(l)}),t.appendChild(o)}function nC(e){const t=document.getElementById("questions-chart");if(!t)return;t.innerHTML="";const{critical:n,high:s,medium:a,resolved:o}=e.questionsByPriority||{critical:0,high:0,medium:0,resolved:0},i=n+s+a+o;if(i===0){t.appendChild(b("div",{className:"empty-chart"},["No questions yet"]));return}const r=b("div",{className:"priority-bars"});[{label:"Critical",value:n,class:"critical"},{label:"High",value:s,class:"high"},{label:"Medium",value:a,class:"medium"},{label:"Resolved",value:o,class:"resolved"}].forEach(l=>{const u=b("div",{className:"priority-bar"});u.appendChild(b("div",{className:"bar-label"},[l.label]));const p=b("div",{className:"bar-track"}),g=b("div",{className:`bar-fill ${l.class}`,style:`--bar-width: ${i>0?l.value/i*100:0}%`});p.appendChild(g),u.appendChild(p),u.appendChild(b("div",{className:"bar-value"},[String(l.value)])),r.appendChild(u)}),t.appendChild(r)}async function sC(e){const t=document.getElementById("trends-chart");if(t){t.innerHTML="",t.appendChild(b("div",{className:"loading"},["Loading trends..."]));try{const n=await xl.getTrends(7);if(t.innerHTML="",!n||!n.history||n.history.length===0){t.appendChild(b("div",{className:"empty-chart"},["No trend data available yet"]));return}const s=n.history,a=[],o={facts:[],questions:[],risks:[],actions:[]};s.forEach(p=>{const g=new Date(p.date);a.push(g.toLocaleDateString(void 0,{weekday:"short"})),o.facts.push(p.facts||0),o.questions.push(p.questions||0),o.risks.push(p.risks||0),o.actions.push(p.actions||0)});const i=Math.max(...o.facts,...o.questions,...o.risks,...o.actions,1),r=b("div",{className:"trends-chart"}),c=b("div",{className:"trends-legend"});[{cls:"facts",label:"Facts"},{cls:"questions",label:"Questions"},{cls:"risks",label:"Risks"},{cls:"actions",label:"Actions"}].forEach(p=>{const g=b("span",{className:"legend-item"});g.appendChild(b("span",{className:`legend-dot ${p.cls}`})),g.appendChild(document.createTextNode(p.label)),c.appendChild(g)}),r.appendChild(c);const u=b("div",{className:"trends-bars"});a.forEach((p,g)=>{const f=b("div",{className:"trend-column"}),h=b("div",{className:"trend-bars-group"});[{cls:"facts",val:o.facts[g]},{cls:"questions",val:o.questions[g]},{cls:"risks",val:o.risks[g]},{cls:"actions",val:o.actions[g]}].forEach(C=>{const x=b("div",{className:`trend-bar ${C.cls}`,style:`--trend-height: ${C.val/i*100}%`,title:`${C.cls.charAt(0).toUpperCase()+C.cls.slice(1)}: ${C.val}`});h.appendChild(x)}),f.appendChild(h),f.appendChild(b("div",{className:"trend-label"},[p])),u.appendChild(f)}),r.appendChild(u),t.appendChild(r)}catch(n){console.error("Failed to load trends:",n),t.innerHTML="",t.appendChild(b("div",{className:"error"},["Failed to load trend data"]))}}}function aC(e,t){if(t===0){e.innerHTML="";return}e.innerHTML=`
    <div class="overdue-alert">
      <div class="overdue-icon">‚ö†Ô∏è</div>
      <div class="overdue-content">
        <strong>${t} Overdue Action${t!==1?"s":""}</strong>
        <span>Action items past their due date require immediate attention</span>
      </div>
      <button class="btn btn-sm btn-warning" id="view-overdue-btn">View Actions</button>
    </div>
  `;const n=e.querySelector("#view-overdue-btn");n&&n.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"sot",view:"actions",filter:"overdue"}}))})}function iC(e){switch(e){case"critical":return"üî¥";case"high":return"üü†";case"warning":return"üü°";default:return"‚ö™"}}function fu(e){try{const t=new Date,s=new Intl.DateTimeFormat("en-GB",{timeZone:e,hour:"2-digit",minute:"2-digit",hour12:!1}).format(t),a=parseInt(s.split(":")[0],10),o=a>=8&&a<18;return{localTime:s,localHour:a,isOnline:o}}catch{return{localTime:"--:--",localHour:12,isOnline:!1}}}function Or(e){if(e.length===0)return[];const t=[],n=new Date;for(let s=0;s<24;s++){let a=0,o=0;for(const i of e)try{const r=new Intl.DateTimeFormat("en-US",{timeZone:i.timezone,hour:"numeric",hour12:!1}),c=parseInt(r.format(n),10),l=n.getUTCHours();let u=c-l;u>12&&(u-=24),u<-12&&(u+=24);const p=(s+u+24)%24;p>=9&&p<=17?(a++,p>=10&&p<=12||p>=14&&p<=16?o+=10:o+=7):p>=8&&p<=18&&(a++,o+=4)}catch{}a>0&&t.push({time:`${s.toString().padStart(2,"0")}:00 UTC`,score:o,available:a})}return t.sort((s,a)=>a.available!==s.available?a.available-s.available:a.score-s.score),t.slice(0,3)}async function oC(e,t){try{const[n,s]=await Promise.all([v.get(`/api/projects/${t}/members`).catch(()=>({data:{members:[]}})),v.get("/api/contacts").catch(()=>({data:{contacts:[]}}))]),a=n.data?.members||[],o=s.data?.contacts||[],i=new Set,r=a.map(w=>{const y=w.linked_contact,S=w.timezone||y?.timezone;if(!S)return null;const P=fu(S),j=w.avatar_url||y?.avatar_url||y?.photo_url,H=w.user_role||y?.role||(w.role==="owner"?"Owner":w.role==="admin"?"Admin":void 0),J=w.linked_contact_id||y?.id;return J&&i.add(J),{name:w.display_name||w.username||w.email||"Unknown",timezone:S,type:"member",avatarUrl:j,role:H,linkedContactId:J,...P}}).filter(w=>w!==null),c=o.filter(w=>w.timezone).map(w=>{const y=fu(w.timezone||"UTC"),S=w.id;return{name:w.name,timezone:w.timezone||"UTC",type:"contact",avatarUrl:w.avatarUrl||w.photoUrl||w.photo_url||w.avatar_url,role:w.role,contactId:S,...y}});if(r.length===0&&c.length===0){e.innerHTML="";return}const l=Fr(r),u=Fr(c),p=c.filter(w=>!w.contactId||!i.has(w.contactId)),g=[...r,...p],f=Fr(g),h=Or(g),k=r.filter(w=>w.isOnline).length,C=c.filter(w=>w.isOnline).length,x=p.filter(w=>w.isOnline).length,$=k+x;e.innerHTML=`
      <style>
        .golden-hours-section {
          background: var(--bg-primary);
          border-radius: 16px;
          padding: 24px;
          border: 1px solid var(--border-color);
          margin-bottom: 24px;
        }
        
        .golden-hours-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 24px;
        }
        
        .golden-hours-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        .golden-hours-header h3 svg {
          color: #f59e0b;
        }
        
        .golden-hours-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 20px;
        }
        
        .golden-card {
          background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 20px;
        }
        
        [data-theme="dark"] .golden-card {
          background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(30,41,59,0.6) 100%);
        }
        
        .golden-card h4 {
          margin: 0 0 16px 0;
          font-size: 14px;
          font-weight: 600;
          color: var(--text-secondary);
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .golden-card h4 .count {
          background: var(--bg-secondary);
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 12px;
        }
        
        .timezone-bars {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 16px;
        }
        
        .timezone-row {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        .tz-name {
          width: 100px;
          font-size: 12px;
          color: var(--text-secondary);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .tz-bar-container {
          flex: 1;
          height: 24px;
          background: var(--bg-secondary);
          border-radius: 4px;
          position: relative;
          overflow: hidden;
        }
        
        .tz-bar {
          position: absolute;
          height: 100%;
          border-radius: 2px;
        }
        
        .tz-bar.work-hours {
          background: linear-gradient(90deg, #10b981, #34d399);
          opacity: 0.6;
        }
        
        .tz-bar.golden {
          background: linear-gradient(90deg, #f59e0b, #fbbf24);
          opacity: 0.9;
        }
        
        .hour-labels {
          display: flex;
          justify-content: space-between;
          padding: 0 110px 0 0;
          margin-bottom: 4px;
        }
        
        .hour-label {
          font-size: 10px;
          color: var(--text-muted);
          width: 20px;
          text-align: center;
        }
        
        .golden-summary {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(251,191,36,0.05) 100%);
          border-radius: 8px;
          border: 1px solid rgba(245,158,11,0.2);
        }
        
        .golden-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #f59e0b, #d97706);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 18px;
        }
        
        .golden-text {
          flex: 1;
        }
        
        .golden-text .label {
          font-size: 12px;
          color: var(--text-secondary);
        }
        
        .golden-text .hours {
          font-size: 16px;
          font-weight: 700;
          color: #d97706;
        }
        
        .no-overlap {
          color: var(--text-muted);
          font-size: 13px;
          font-style: italic;
        }
        
        .participants-row {
          display: flex;
          align-items: center;
          gap: 4px;
          margin-top: 12px;
        }
        
        .participant-avatar {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea, #764ba2);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 10px;
          font-weight: 600;
          border: 2px solid var(--bg-primary);
          margin-left: -8px;
        }
        
        .participant-avatar:first-child {
          margin-left: 0;
        }
        
        .participant-avatar img {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
        }
        
        .participant-avatar.more {
          background: var(--bg-secondary);
          color: var(--text-secondary);
        }
        
        .online-status-bar {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 16px;
          background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(52,211,153,0.05) 100%);
          border-radius: 12px;
          border: 1px solid rgba(16,185,129,0.2);
          margin-bottom: 20px;
        }
        
        .online-indicator {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .online-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background: #10b981;
          box-shadow: 0 0 8px rgba(16,185,129,0.6);
          animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.2); opacity: 0.7; }
        }
        
        .online-count {
          font-size: 14px;
          font-weight: 600;
          color: #059669;
        }
        
        .people-list {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          margin-top: 16px;
        }
        
        .person-chip {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          background: var(--bg-secondary);
          border-radius: 20px;
          border: 1px solid var(--border-color);
          transition: all 0.2s ease;
        }
        
        .person-chip.online {
          background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%);
          border-color: rgba(16,185,129,0.3);
        }
        
        .person-chip.offline {
          opacity: 0.6;
        }
        
        .person-avatar-small {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea, #764ba2);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 11px;
          font-weight: 600;
          position: relative;
        }
        
        .person-avatar-small img {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
        }
        
        .person-avatar-small .status-dot {
          position: absolute;
          bottom: -2px;
          right: -2px;
          width: 10px;
          height: 10px;
          border-radius: 50%;
          border: 2px solid var(--bg-primary);
        }
        
        .person-avatar-small .status-dot.online {
          background: #10b981;
        }
        
        .person-avatar-small .status-dot.offline {
          background: #9ca3af;
        }
        
        .person-info {
          display: flex;
          flex-direction: column;
        }
        
        .person-name {
          font-size: 13px;
          font-weight: 500;
          color: var(--text-primary);
        }
        
        .person-time {
          font-size: 11px;
          color: var(--text-secondary);
        }
        
        .person-role {
          font-size: 10px;
          color: #e11d48;
          font-weight: 500;
          margin-top: 2px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 120px;
        }
        
        .meeting-suggestions {
          margin-top: 20px;
          padding: 16px;
          background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.05) 100%);
          border-radius: 12px;
          border: 1px solid rgba(99,102,241,0.2);
        }
        
        .meeting-suggestions h5 {
          margin: 0 0 12px 0;
          font-size: 14px;
          font-weight: 600;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .meeting-suggestions h5 svg {
          color: #6366f1;
        }
        
        .suggestion-list {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
        }
        
        .suggestion-pill {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 14px;
          background: white;
          border-radius: 20px;
          border: 1px solid rgba(99,102,241,0.3);
          font-size: 13px;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        [data-theme="dark"] .suggestion-pill {
          background: rgba(30,41,59,0.8);
        }
        
        .suggestion-pill:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(99,102,241,0.2);
        }
        
        .suggestion-pill .time {
          font-weight: 600;
          color: #6366f1;
        }
        
        .suggestion-pill .availability {
          font-size: 11px;
          color: var(--text-secondary);
          padding: 2px 6px;
          background: rgba(16,185,129,0.1);
          border-radius: 8px;
          color: #059669;
        }
      </style>
      
      <div class="golden-hours-section">
        <div class="golden-hours-header">
          <h3>
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            Golden Hours
          </h3>
          <span class="golden-header-time">
            ${new Date().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})} your time
          </span>
        </div>
        
        <div class="golden-hours-grid">
          <!-- Team Members Section -->
          ${r.length>0?`
            <div class="golden-card">
              <h4>
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Team Members
                <span class="count">${r.length}</span>
                ${k>0?`<span class="online-badge">‚óè ${k} online</span>`:""}
              </h4>
              
              <!-- Team People List -->
              <div class="people-list">
                ${r.map(w=>{const y=w.name.split(" ").map(S=>S[0]).join("").substring(0,2).toUpperCase();return`
                    <div class="person-chip ${w.isOnline?"online":"offline"}">
                      <div class="person-avatar-small">
                        ${w.avatarUrl?`<img src="${dn(w.avatarUrl)}" alt="${dn(w.name)}">`:y}
                        <span class="status-dot ${w.isOnline?"online":"offline"}"></span>
                      </div>
                      <div class="person-info">
                        <span class="person-name">${dn(w.name)}</span>
                        ${w.role?`<span class="person-role">${dn(w.role)}</span>`:""}
                        <span class="person-time">${w.localTime||"--:--"} ${w.timezone.split("/").pop()?.replace(/_/g," ")||""}</span>
                      </div>
                    </div>
                  `}).join("")}
              </div>
              
              ${hu(r,l)}
              ${Ur(l,r)}
              
              <!-- Team Meeting Suggestions -->
              ${(()=>{const w=Or(r);return w.length>0?`
                  <div class="meeting-suggestions">
                    <h5>
                      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      Best Times for Team
                    </h5>
                    <div class="suggestion-list">
                      ${w.map((y,S)=>`
                        <div class="suggestion-pill">
                          <span class="suggestion-star" style="--suggestion-star-color: ${S===0?"#f59e0b":"var(--text-muted)"};">${S===0?"‚≠ê":"üïê"}</span>
                          <span class="time">${y.time}</span>
                          <span class="availability">${y.available}/${r.length}</span>
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""})()}
            </div>
          `:""}
          
          <!-- Contacts Section -->
          ${c.length>0?`
            <div class="golden-card">
              <h4>
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                </svg>
                Contacts
                <span class="count">${c.length}</span>
                ${C>0?`<span class="online-badge">‚óè ${C} online</span>`:""}
              </h4>
              
              <!-- Contacts People List -->
              <div class="people-list">
                ${c.map(w=>{const y=w.name.split(" ").map(S=>S[0]).join("").substring(0,2).toUpperCase();return`
                    <div class="person-chip ${w.isOnline?"online":"offline"}">
                      <div class="person-avatar-small">
                        ${w.avatarUrl?`<img src="${dn(w.avatarUrl)}" alt="${dn(w.name)}">`:y}
                        <span class="status-dot ${w.isOnline?"online":"offline"}"></span>
                      </div>
                      <div class="person-info">
                        <span class="person-name">${dn(w.name)}</span>
                        ${w.role?`<span class="person-role">${dn(w.role)}</span>`:""}
                        <span class="person-time">${w.localTime||"--:--"} ${w.timezone.split("/").pop()?.replace(/_/g," ")||""}</span>
                      </div>
                    </div>
                  `}).join("")}
              </div>
              
              ${hu(c,u)}
              ${Ur(u,c)}
              
              <!-- Contacts Meeting Suggestions -->
              ${(()=>{const w=Or(c);return w.length>0?`
                  <div class="meeting-suggestions">
                    <h5>
                      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      Best Times for Contacts
                    </h5>
                    <div class="suggestion-list">
                      ${w.map((y,S)=>`
                        <div class="suggestion-pill">
                          <span class="suggestion-star" style="--suggestion-star-color: ${S===0?"#f59e0b":"var(--text-muted)"};">${S===0?"‚≠ê":"üïê"}</span>
                          <span class="time">${y.time}</span>
                          <span class="availability">${y.available}/${c.length}</span>
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""})()}
            </div>
          `:""}
        </div>
        
        <!-- Combined Section (only if both exist) -->
        ${r.length>0&&c.length>0?`
          <div class="golden-card golden-card-mt">
            <h4>
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Combined: Team + Contacts
              <span class="count">${g.length}</span>
              <span class="online-badge">‚óè ${$} online</span>
            </h4>
            ${Ur(f,g)}
            
            <!-- Combined Meeting Suggestions -->
            ${h.length>0?`
              <div class="meeting-suggestions">
                <h5>
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  Best Times for Everyone
                </h5>
                <div class="suggestion-list">
                  ${h.map((w,y)=>`
                    <div class="suggestion-pill">
                      <span class="suggestion-star" style="--suggestion-star-color: ${y===0?"#f59e0b":"var(--text-muted)"};">${y===0?"‚≠ê":"üïê"}</span>
                      <span class="time">${w.time}</span>
                      <span class="availability">${w.available}/${g.length}</span>
                    </div>
                  `).join("")}
                </div>
              </div>
            `:""}
          </div>
        `:""}
      </div>
    `}catch(n){console.error("Failed to load golden hours:",n)}}function Fr(e){if(e.length===0)return null;const t=[...new Set(e.map(r=>r.timezone))];if(t.length===1)return{start:8,end:18};const n=new Date,s=[];for(const r of t)try{const c=new Intl.DateTimeFormat("en-US",{timeZone:r,hour:"numeric",hour12:!1}),l=parseInt(c.format(n),10),u=n.getUTCHours();let p=l-u;p>12&&(p-=24),p<-12&&(p+=24),s.push(p)}catch{s.push(0)}let a=0,o=24;for(const r of s){const c=(8-r+24)%24,l=(18-r+24)%24;c<l&&(a=Math.max(a,c),o=Math.min(o,l))}if(a>=o)return null;const i=s[0];return{start:(a+i+24)%24,end:(o+i+24)%24}}function hu(e,t){const n=new Map;for(const o of e)n.set(o.timezone,(n.get(o.timezone)||0)+1);const s=[...n.keys()].slice(0,5);if(s.length===0)return'<div class="no-overlap">No timezone data available</div>';const a=new Date;return`
    <div class="hour-labels">
      ${[0,6,12,18,24].map(o=>`<span class="hour-label">${o}</span>`).join("")}
    </div>
    <div class="timezone-bars">
      ${s.map(o=>{let i=0;try{const f=new Intl.DateTimeFormat("en-US",{timeZone:o,hour:"numeric",hour12:!1}),h=parseInt(f.format(a),10),k=a.getUTCHours();i=h-k,i>12&&(i-=24),i<-12&&(i+=24)}catch{}const r=9,c=18,l=r/24*100,u=(c-r)/24*100,p=o.split("/").pop()?.replace(/_/g," ")||o,g=n.get(o)||1;return`
          <div class="timezone-row">
            <span class="tz-name" title="${o}">${p} ${g>1?`(${g})`:""}</span>
            <div class="tz-bar-container">
              <div class="tz-bar work-hours" style="--tz-left: ${l}%; --tz-width: ${u}%;"></div>
              ${t?`<div class="tz-bar golden" style="--tz-left: ${t.start/24*100}%; --tz-width: ${(t.end-t.start)/24*100}%;"></div>`:""}
            </div>
          </div>
        `}).join("")}
    </div>
  `}function Ur(e,t){if(!e)return`
      <div class="golden-summary golden-summary-warning">
        <div class="golden-icon">‚ö†</div>
        <div class="golden-text">
          <div class="label">No overlap found</div>
          <div class="hours">Timezones too far apart</div>
        </div>
      </div>
    `;const n=r=>`${r.toString().padStart(2,"0")}:00`,s=e.end-e.start,a=5,o=t.slice(0,a),i=t.length-a;return`
    <div class="golden-summary">
      <div class="golden-icon">‚òÄÔ∏è</div>
      <div class="golden-text">
        <div class="label">Golden Hours</div>
        <div class="hours">${n(e.start)} - ${n(e.end)} (${s}h overlap)</div>
      </div>
    </div>
    <div class="participants-row">
      ${o.map(r=>{const c=r.name.split(" ").map(l=>l[0]).join("").substring(0,2).toUpperCase();return`
          <div class="participant-avatar" title="${dn(r.name)}">
            ${r.avatarUrl?`<img src="${dn(r.avatarUrl)}" alt="${dn(r.name)}">`:c}
          </div>
        `}).join("")}
      ${i>0?`<div class="participant-avatar more">+${i}</div>`:""}
    </div>
  `}function dn(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function ag(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Dashboard: Container not found: ${e}`),null;const s=zo(t);return n.appendChild(s),s}const rC=Object.freeze(Object.defineProperty({__proto__:null,createDashboard:zo,default:zo,mountDashboard:ag},Symbol.toStringTag,{value:"Module"}));function Dl(e={}){const t=e.showSessions!==!1,n=b("div",{className:"chat-layout"});let s=null,a=[],o=[];const i=b("div",{className:"chat-sidebar"}),r=b("button",{className:"chat-new-conversation",innerHTML:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova conversa'}),c=b("div",{className:"chat-new-context-wrap"}),l=b("span",{className:"chat-new-context-label",textContent:"Como quem?"}),u=b("select",{className:"chat-new-context-select"});c.appendChild(l),c.appendChild(u);const p=b("div",{className:"chat-sessions-list"});i.appendChild(r),i.appendChild(c),i.appendChild(p);const g=b("div",{className:"chat-main"}),f=b("div",{className:"chat-container"}),h=b("div",{className:"chat-header"}),k=b("label",{className:"chat-context-label",textContent:"Como quem?"}),C=b("select",{className:"chat-context-select"});h.appendChild(k),h.appendChild(C);async function x(){try{o=(await v.get("/api/contacts")).data?.contacts||[],$()}catch{o=[]}}function $(){const Le=a.find(le=>le.id===s)?.context_contact_id||null;C.innerHTML=`<option value="">Sem contexto</option>${o.map(le=>`<option value="${le.id}" ${le.id===Le?"selected":""}>${un(le.name)}${le.role?` - ${le.role}`:""}${le.organization?` (${le.organization})`:""}</option>`).join("")}`,C.disabled=!s}function w(){u.innerHTML=`<option value="">Sem contexto</option>${o.map(re=>`<option value="${re.id}">${un(re.name)}${re.role?` - ${re.role}`:""}${re.organization?` (${re.organization})`:""}</option>`).join("")}`}async function y(){if(!s)return;const re=C.value||null;try{await v.put(`/api/chat/sessions/${s}`,{contextContactId:re});const Le=a.findIndex(le=>le.id===s);Le!==-1&&(a[Le]={...a[Le],context_contact_id:re}),m.success("Contexto actualizado")}catch(Le){m.error("Falha ao actualizar contexto"),console.error("[Chat] Update context error:",Le),$()}}const S=b("div",{className:"chat-messages"}),P=b("div",{className:"chat-input-container"}),j=b("textarea",{className:"chat-input",placeholder:e.placeholder||"Ask a question about your project..."}),H=b("button",{className:"chat-send-btn",innerHTML:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
    </svg>`});d(j,"input",()=>{j.style.height="auto",j.style.height=Math.min(j.scrollHeight,120)+"px"}),d(j,"keydown",re=>{re.key==="Enter"&&!re.shiftKey&&(re.preventDefault(),ie())}),d(H,"click",ie);let J=!1;async function B(){try{a=(await v.get("/api/chat/sessions")).data?.sessions||[],Z()}catch{a=[]}}function Z(){p.innerHTML=a.map(re=>`
      <button class="chat-session-item ${re.id===s?"active":""}" data-session-id="${re.id}">
        <span class="session-title">${un(re.title.length>40?re.title.substring(0,37)+"...":re.title)}</span>
        <span class="session-date">${Ce(re.updated_at)}</span>
      </button>
    `).join(""),p.querySelectorAll(".chat-session-item").forEach(re=>{d(re,"click",()=>F(re.getAttribute("data-session-id")))})}async function O(re){try{const le=(await v.get(`/api/chat/sessions/${re}/messages`)).data?.messages||[];ce.setChatHistory(le.map(te=>({id:te.id,role:te.role,content:te.content,timestamp:te.created_at,sources:te.sources,queryType:te.metadata?.queryType,confidence:te.metadata?.confidence})))}catch{ce.setChatHistory([])}}async function F(re){s=re,Z(),ce.clearChatHistory(),await O(re),S.innerHTML="",ce.getState().chatHistory.forEach(Le=>ti(Le,S,e.showSources))}async function ee(re){try{const le=(await v.post("/api/chat/sessions",{title:"Nova conversa",contextContactId:re||null})).data?.session;le&&(a.unshift({id:le.id,title:le.title||"Nova conversa",context_contact_id:le.context_contact_id??null,created_at:le.created_at||new Date().toISOString(),updated_at:le.updated_at||new Date().toISOString()}),await F(le.id),Z())}catch(Le){m.error("Failed to create new conversation"),console.error("[Chat] Create session error:",Le)}}async function ie(){const re=j.value.trim();if(!re||J)return;j.value="",j.style.height="auto",J=!0,H.setAttribute("disabled","true");const Le={id:`msg-${Date.now()}`,role:"user",content:re,timestamp:new Date().toISOString()};ce.addChatMessage(Le),ti(Le,S);const le=b("div",{className:"chat-loading"});le.innerHTML=`
      <div class="chat-loading-dots">
        <span></span><span></span><span></span>
      </div>
      <span>Thinking...</span>
    `,S.appendChild(le),ig(S);try{if(e.onSend)await e.onSend(re);else{const te=await v.post("/api/chat",{message:re,history:ce.getState().chatHistory.slice(-10),sessionId:s}),ne={id:`msg-${Date.now()}`,role:"assistant",content:te.data.response,timestamp:new Date().toISOString(),sources:te.data.sources,queryType:te.data.queryType,confidence:te.data.confidence,contextQuality:te.data.contextQuality,rag:te.data.rag};ce.addChatMessage(ne),ti(ne,S,e.showSources),te.data.sessionId&&!s&&(s=te.data.sessionId,await B(),Z(),$())}}catch{const ne={role:"system",content:"Failed to get response. Please try again.",timestamp:new Date().toISOString()};ti(ne,S)}finally{le.remove(),J=!1,H.removeAttribute("disabled"),j.focus()}}P.appendChild(j),P.appendChild(H);const oe=b("div",{className:"quick-prompts"});return["Summarize key risks","List open questions","What actions are overdue?","Who are the key contacts?"].forEach(re=>{const Le=b("button",{className:"quick-prompt",textContent:re});d(Le,"click",()=>{j.value=re,ie()}),oe.appendChild(Le)}),d(C,"change",y),f.appendChild(h),f.appendChild(S),f.appendChild(oe),f.appendChild(P),g.appendChild(f),t?(n.appendChild(i),d(r,"click",()=>ee()),x().then(()=>w()),B()):h.classList.add("hidden"),n.appendChild(g),ce.getState().chatHistory.forEach(re=>ti(re,S,e.showSources)),n}function ti(e,t,n=!0){const s=b("div",{className:`chat-message ${e.role}`});let a=un(e.content);if(a=a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>"),s.innerHTML=`<div class="chat-message-content">${a}</div>`,e.role==="assistant"&&(e.confidence||e.rag)){const o=b("div",{className:"chat-meta"}),i=e.confidence==="high"?"confidence-high":e.confidence==="medium"?"confidence-medium":"confidence-low";let r="";if(e.confidence&&(r+=`<span class="chat-badge ${i}" title="Confidence level">${e.confidence}</span>`),e.queryType&&(r+=`<span class="chat-badge query-type" title="Query classification">${e.queryType}</span>`),e.rag){const c=e.rag.usedHyDE?"HyDE+RRF":e.rag.graphResults>0?"Graph+Vector":"Hybrid";r+=`<span class="chat-badge rag-method" title="RAG method: ${e.rag.method}">${c}</span>`;const l=e.rag.fusedResults||e.rag.vectorResults+e.rag.graphResults;l>0&&(r+=`<span class="chat-badge sources-count" title="Sources found">${l} sources</span>`)}o.innerHTML=r,s.appendChild(o)}if(n&&e.sources&&e.sources.length>0){const o=b("div",{className:"chat-sources"});if(typeof e.sources[0]=="string")o.innerHTML=`
        <span class="sources-label">Sources:</span>
        ${e.sources.map(i=>`<span class="source-link">${un(i)}</span>`).join("")}
      `;else{const i=e.sources,r=i.filter(u=>u.contactName),l=i.filter(u=>!u.contactName).slice(0,5);if(r.length>0){const u=b("div",{className:"chat-contact-pills"});u.innerHTML=r.map(p=>`
          <div class="contact-pill">
            ${p.avatarUrl?`<img class="contact-pill-avatar" src="${un(p.avatarUrl)}" alt="" onerror="this.classList.add('hidden')"/>`:`<div class="contact-pill-avatar-placeholder">${un((p.contactName||p.type||"?")[0])}</div>`}
            <div class="contact-pill-info">
              <span class="contact-pill-name">${un(p.contactName||p.type||"Contact")}</span>
              ${p.contactRole?`<span class="contact-pill-role">${un(p.contactRole)}</span>`:""}
            </div>
          </div>
        `).join(""),s.appendChild(u)}o.innerHTML=`
        <details class="sources-details">
          <summary class="sources-label">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            ${i.length} sources used
          </summary>
          <div class="sources-list">
            ${l.map(u=>`
              <div class="source-item">
                <span class="source-type">${un(u.type||"unknown")}</span>
                <span class="source-score" title="Relevance score">${Math.round((u.rrfScore||u.score||0)*100)}%</span>
                ${u.sourceCount&&u.sourceCount>1?`<span class="source-multi" title="Found in multiple searches">x${u.sourceCount}</span>`:""}
                ${u.source?`<span class="source-from">${un(u.source)}</span>`:""}
              </div>
            `).join("")}
            ${i.length>5?`<div class="sources-more">+${i.length-5} more</div>`:""}
          </div>
        </details>
      `}s.appendChild(o)}return t.appendChild(s),ig(t),s}function ig(e){e.scrollTop=e.scrollHeight}function un(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function og(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Chat: Container not found: ${e}`),null;const s=Dl(t);return n.appendChild(s),s}const cC=Object.freeze(Object.defineProperty({__proto__:null,createChat:Dl,mountChat:og},Symbol.toStringTag,{value:"Module"}));class rg{props;question;contacts=[];container;constructor(t){this.props=t,this.question=t.question,this.container=b("div",{className:"question-detail-view"})}render(){const{question:t}=this;return this.container.innerHTML=`
      <div class="question-detail-header">
        <div class="breadcrumb">
          <a href="#" class="breadcrumb-link" id="back-to-list">Questions</a>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <span class="breadcrumb-current">Question #${String(t.id).substring(0,8)}</span>
        </div>
        <div class="header-actions">
          ${t.sla_breached?'<span class="sla-badge breached">SLA Breached</span>':""}
          <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
        </div>
      </div>

      <div class="question-detail-content">
        <!-- Main Question Card -->
        <section class="detail-section question-main">
          <div class="question-badges">
            <span class="priority-badge priority-${t.priority}">${t.priority}</span>
            <span class="status-badge status-${t.status}">${t.status}</span>
            ${t.requester_role?`
              <div class="requester-badge-full" title="Question from the perspective of this role">
                <div class="requester-avatar-sm">${this.getInitials(t.requester_name||t.requester_role)}</div>
                <div class="requester-text">
                  ${t.requester_name?`<span class="requester-name-sm">${this.escapeHtml(t.requester_name)}</span>`:""}
                  <span class="requester-role-sm">${this.escapeHtml(t.requester_role)}</span>
                </div>
              </div>
            `:""}
            <span class="question-date">Created ${Ce(t.created_at)}</span>
          </div>
          <h2 class="question-text">${this.escapeHtml(t.content)}</h2>
          ${t.context?`<p class="question-context">${this.escapeHtml(t.context)}</p>`:""}
          ${this.renderEntities(t)}
        </section>

        <!-- Two-column layout -->
        <div class="detail-columns">
          <div class="detail-column-left">
            <!-- Assignment Section - SOTA Design -->
            <section class="detail-section" id="assignment-section">
              <div class="section-header-sota">
                <h3>
                  <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Assignment
                  <span class="section-subtitle">Who should answer this question?</span>
                </h3>
                <button type="button" class="btn-ai-suggest" id="ai-suggest-btn">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                  AI Suggest
                </button>
              </div>
              
              <!-- Current Assignment Display -->
              <div id="current-assignment" class="current-assignment-card">
                ${this.renderAssignmentState()}
              </div>
              
              <!-- Contact Picker (hidden by default) -->
              <div id="contact-picker" class="contact-picker-sota hidden">
                <div class="picker-search">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                  </svg>
                  <input type="text" id="contact-search" placeholder="Search contacts..." autocomplete="off">
                </div>
                <div id="contact-list" class="contact-list-grid">
                  <div class="loading">Loading contacts...</div>
                </div>
              </div>
              
              <!-- Hidden select for form submission -->
              <select id="assignee-select" class="form-select hidden">
                <option value="">Select contact...</option>
              </select>
              
              <!-- AI Suggestions Panel -->
              <div id="suggestions-panel" class="suggestions-panel-sota hidden"></div>
            </section>

            <!-- Potential Answers Section -->
            <section class="detail-section" id="answers-section">
              <div class="section-header">
                <h3>Potential Answers</h3>
                <button class="btn btn-secondary btn-sm" id="check-answers-btn">
                  Check Knowledge Base
                </button>
              </div>
              <div id="potential-answers" class="potential-answers">
                <p class="empty-state">Click "Check Knowledge Base" to find potential answers</p>
              </div>
            </section>

            <!-- Answer Form Section -->
            <section class="detail-section" id="answer-section">
              <h3>${t.answer?"Current Answer":"Your Answer"}</h3>
              ${t.answer?this.renderExistingAnswer(t):""}
              <div class="answer-form ${t.status==="resolved"?"hidden":""}">
                <div class="form-group">
                  <textarea id="answer-input" rows="4" 
                    placeholder="Type your answer here...">${t.answer||""}</textarea>
                </div>
                <div class="form-row answer-form-row">
                  <div class="form-group source-group">
                    <label>Source</label>
                    <div class="source-options">
                      <label class="source-option ${t.answer_source==="manual"||!t.answer_source?"active":""}">
                        <input type="radio" name="answer-source" value="manual" ${t.answer_source==="manual"||!t.answer_source?"checked":""}>
                        <span class="source-icon">‚úèÔ∏è</span>
                        <span class="source-label">Manual</span>
                      </label>
                      <label class="source-option ${t.answer_source==="document"?"active":""}">
                        <input type="radio" name="answer-source" value="document" ${t.answer_source==="document"?"checked":""}>
                        <span class="source-icon">üìÑ</span>
                        <span class="source-label">Document</span>
                      </label>
                      <label class="source-option ${t.answer_source==="ai"?"active":""}">
                        <input type="radio" name="answer-source" value="ai" ${t.answer_source==="ai"?"checked":""}>
                        <span class="source-icon">ü§ñ</span>
                        <span class="source-label">AI</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group answered-by-group">
                    <label>Answered By</label>
                    <div class="answered-by-picker">
                      <div id="answered-by-display" class="answered-by-display">
                        ${t.answered_by_contact_id||t.answered_by_name?`
                          <div class="answered-by-card" id="current-answerer">
                            <div class="answerer-avatar" id="answerer-avatar">${this.getInitials(t.answered_by_name||"")}</div>
                            <span class="answerer-name">${this.escapeHtml(t.answered_by_name||"Contact")}</span>
                            <button type="button" class="btn-clear-answerer" id="clear-answerer">√ó</button>
                          </div>
                        `:`
                          <button type="button" class="btn-select-answerer" id="show-answerer-picker">
                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Select who answered...
                          </button>
                        `}
                      </div>
                      <!-- Hidden select for form -->
                      <select id="answered-by-contact" class="form-select hidden">
                        <option value="">Select who answered...</option>
                      </select>
                      <!-- Contact picker dropdown -->
                      <div id="answerer-picker-dropdown" class="answerer-picker-dropdown hidden">
                        <div class="picker-search-sm">
                          <input type="text" id="answerer-search" placeholder="Search contacts...">
                        </div>
                        <div id="answerer-list" class="answerer-list"></div>
                        <div class="answerer-other">
                          <input type="text" id="answerer-other-name" placeholder="Or type a name...">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label>Follow-up Questions (one per line)</label>
                  <textarea id="followup-input" rows="2" 
                    placeholder="Add any follow-up questions..."></textarea>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" id="save-answer-btn">
                    ${t.answer?"Update Answer":"Save Answer"}
                  </button>
                </div>
              </div>
            </section>
          </div>

          <div class="detail-column-right">
            <!-- Follow-up Chain Section -->
            <section class="detail-section" id="chain-section">
              <h3>Follow-up Chain</h3>
              <div id="chain-content" class="chain-content">
                <div class="skeleton-card">
                  <div class="skeleton-text w-75"></div>
                  <div class="skeleton-text w-25"></div>
                </div>
              </div>
            </section>

            <!-- Similar Questions Section -->
            <section class="detail-section" id="similar-section">
              <h3>Similar Questions</h3>
              <div id="similar-content" class="similar-content">
                 <div class="skeleton-card">
                  <div class="skeleton-text w-100"></div>
                  <div class="skeleton-row">
                    <div class="skeleton-text w-25"></div>
                    <div class="skeleton-text w-25"></div>
                  </div>
                </div>
                <div class="skeleton-card" style="margin-top: 8px;">
                  <div class="skeleton-text w-100"></div>
                  <div class="skeleton-row">
                    <div class="skeleton-text w-25"></div>
                    <div class="skeleton-text w-25"></div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Timeline Section -->
            <section class="detail-section" id="timeline-section">
              <h3>Timeline</h3>
              <div id="timeline-content" class="timeline-content">
                <div class="skeleton-card">
                    <div class="skeleton-row">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-text w-50" style="margin-bottom:0"></div>
                    </div>
                    <div class="skeleton-text w-75" style="margin-top: 8px;"></div>
                </div>
                 <div class="skeleton-card" style="margin-top: 12px;">
                    <div class="skeleton-row">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-text w-50" style="margin-bottom:0"></div>
                    </div>
                    <div class="skeleton-text w-75" style="margin-top: 8px;"></div>
                </div>
              </div>
            </section>
          </div>
        </div>

      </div>

      <!-- Actions Bar - Outside scrollable content for proper click handling -->
      <div class="detail-actions">
        ${t.status==="resolved"||t.status==="dismissed"?`
          <button class="btn btn-warning" id="reopen-btn">Reopen</button>
        `:""}
        ${t.status==="deferred"?`
          <button class="btn btn-info" id="undefer-btn">Resume Now</button>
        `:`
          <button class="btn btn-secondary" id="defer-btn">Defer</button>
        `}
        ${t.was_useful===void 0&&t.answer?`
          <div class="feedback-buttons">
            <span class="feedback-label">Was this helpful?</span>
            <button class="btn btn-sm btn-success" id="feedback-yes">Yes</button>
            <button class="btn btn-sm btn-secondary" id="feedback-no">No</button>
          </div>
        `:""}
        <button class="btn btn-secondary" id="edit-btn">Edit</button>
        <div class="dropdown dismiss-dropdown">
          <button class="btn btn-danger" id="dismiss-btn">Dismiss ‚ñº</button>
          <div class="dropdown-menu" id="dismiss-menu">
            <a href="#" data-reason="duplicate">Duplicate</a>
            <a href="#" data-reason="not_relevant">Not Relevant</a>
            <a href="#" data-reason="out_of_scope">Out of Scope</a>
            <a href="#" data-reason="answered_elsewhere">Answered Elsewhere</a>
            <a href="#" data-reason="no_longer_needed">No Longer Needed</a>
            <a href="#" data-reason="other">Other...</a>
          </div>
        </div>
      </div>
    `,this.bindEvents(),this.loadContacts(),this.loadChain(t.id),this.loadSimilar(t.id),this.loadTimeline(t.id),this.container}renderAssignmentState(){const{question:t}=this;return t.assigned_to?`
        <div class="assigned-contact-display">
          <div class="contact-avatar-lg" id="assigned-avatar">
            ${this.getInitials(t.assigned_to)}
          </div>
          <div class="contact-details">
            <div class="contact-name-lg">${this.escapeHtml(t.assigned_to)}</div>
            <div class="contact-role-sm" id="assigned-role">Loading...</div>
          </div>
          <button class="btn-change-assignment" id="change-assignee-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
            </svg>
            Change
          </button>
        </div>
      `:`
      <div class="no-assignment">
        <div class="no-assignment-icon">
          <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
        </div>
        <span>No one assigned to answer</span>
        <p class="no-assignment-hint">Use AI Suggest to find the best person</p>
        <button class="btn-assign-now" id="show-picker-btn">Choose Manually</button>
      </div>
    `}renderEntities(t){const n=t.extracted_entities||[],s=t.extracted_topics||[];return n.length===0&&s.length===0?"":`<div class="question-entities">${[...n.map(o=>`<span class="entity-tag entity-${o.type}">@${o.name}</span>`),...s.map(o=>`<span class="entity-tag entity-topic">#${o.name}</span>`)].join("")}</div>`}renderExistingAnswer(t){return t.answer?`
      <div class="existing-answer">
        <div class="answer-text">${this.escapeHtml(t.answer)}</div>
        <div class="answer-meta">
          <span class="answer-source-badge">${t.answer_source||"manual"}</span>
          ${t.answered_by_name?`<span class="answered-by">by ${this.escapeHtml(t.answered_by_name)}</span>`:""}
          ${t.answered_at?`<span class="answered-date">${Ce(t.answered_at)}</span>`:""}
        </div>
        ${t.answer_provenance?this.renderProvenance(t.answer_provenance):""}
      </div>
    `:""}renderProvenance(t){return!t.sources||t.sources.length===0?"":`
      <div class="answer-provenance">
        <div class="provenance-label">Sources:</div>
        ${t.sources.map(s=>`
      <div class="provenance-source">
        <span class="source-type">${s.type}</span>
        <span class="source-content">${this.escapeHtml(s.content.substring(0,100))}...</span>
        <span class="source-confidence">${Math.round(s.confidence*100)}%</span>
      </div>
    `).join("")}
      </div>
    `}bindEvents(){const{onClose:t,onUpdate:n}=this.props,s=this.container,a=s.querySelector("#close-detail");a&&d(a,"click",t);const o=s.querySelector("#back-to-list");o&&d(o,"click",S=>{S.preventDefault(),t()});const i=s.querySelector("#ai-suggest-btn");i&&d(i,"click",()=>this.loadAISuggestions());const r=s.querySelector("#check-answers-btn");r&&d(r,"click",()=>this.checkPotentialAnswers());const c=s.querySelector("#save-answer-btn");c&&d(c,"click",()=>this.saveAnswer());const l=s.querySelector("#reopen-btn");l&&d(l,"click",()=>this.reopenQuestion());const u=s.querySelector("#dismiss-btn"),p=s.querySelector("#dismiss-menu");if(u&&p){d(u,"click",j=>{j.stopPropagation(),p.classList.toggle("show")}),p.querySelectorAll("a[data-reason]").forEach(j=>{d(j,"click",async H=>{H.preventDefault(),H.stopPropagation();const J=j.getAttribute("data-reason");p.classList.remove("show");let B;J==="other"&&(B=prompt("Please provide a reason for dismissing this question:")||void 0,!B)||await this.dismissQuestionWithReason(J,B)})});const P=j=>{if(!j.target.closest(".dismiss-dropdown")&&this.container.contains(p))try{p.classList.remove("show")}catch{}};document.addEventListener("click",P)}const g=s.querySelector("#defer-btn");g&&d(g,"click",()=>this.showDeferDialog());const f=s.querySelector("#undefer-btn");f&&d(f,"click",()=>this.reopenQuestion());const h=s.querySelector("#feedback-yes"),k=s.querySelector("#feedback-no");h&&d(h,"click",()=>this.submitFeedback(!0)),k&&d(k,"click",()=>{const S=prompt("How can we improve this answer?");this.submitFeedback(!1,S||void 0)});const C=s.querySelector("#edit-btn");C&&d(C,"click",()=>{const S=s.querySelector(".answer-form");S&&(S.classList.remove("hidden"),S.querySelector("#answer-input")?.focus())}),s.querySelectorAll('input[name="answer-source"]').forEach(S=>{d(S,"change",P=>{P.target.value;const j=s.querySelector(".answer-form");j&&(j.querySelectorAll(".source-option").forEach(H=>H.classList.remove("active")),P.target.closest(".source-option")?.classList.add("active"))})});const $=s.querySelector("#show-answerer-picker"),w=s.querySelector("#clear-answerer"),y=s.querySelector("#answerer-picker-dropdown");if($&&y){d($,"click",j=>{j.stopPropagation(),y.classList.toggle("hidden");const H=y.querySelector("#answerer-search");H&&H.focus();const J=y.querySelector("#answerer-list");J&&!J.hasChildNodes()&&(J.innerHTML=this.contacts.map(B=>`
             <div class="picker-item" data-id="${B.id}" data-name="${this.escapeHtml(B.name)}">
               <div class="picker-avatar">${this.getInitials(B.name)}</div>
               <div class="picker-name">${this.escapeHtml(B.name)}</div>
             </div>
           `).join(""),J.querySelectorAll(".picker-item").forEach(B=>{d(B,"click",()=>{const Z=B.getAttribute("data-id"),O=B.getAttribute("data-name");this.setAnsweredBy(Z||void 0,O||void 0),y.classList.add("hidden")})}))});const S=y.querySelector("#answerer-search");S&&d(S,"input",j=>{const H=j.target.value.toLowerCase(),J=y.querySelector("#answerer-list");J&&J.querySelectorAll(".picker-item").forEach(B=>{const Z=B.getAttribute("data-name")?.toLowerCase()||"";B.style.display=Z.includes(H)?"flex":"none"})});const P=y.querySelector("#answerer-other-name");P&&d(P,"keydown",j=>{if(j.key==="Enter"){j.preventDefault();const H=j.target.value.trim();H&&(this.setAnsweredBy(void 0,H),y.classList.add("hidden"))}}),document.addEventListener("click",j=>{y&&!y.classList.contains("hidden")&&!j.target.closest(".answered-by-picker")&&y.classList.add("hidden")})}w&&d(w,"click",()=>{this.setAnsweredBy(void 0,void 0)})}setAnsweredBy(t,n){const s=this.container.querySelector("#answered-by-display"),a=this.container.querySelector("#answered-by-contact");if(a&&(a.value=t||"",a.setAttribute("data-name",n||"")),s)if(t||n){s.innerHTML=`
          <div class="answered-by-card" id="current-answerer">
            <div class="answerer-avatar" id="answerer-avatar">${this.getInitials(n||"")}</div>
            <span class="answerer-name">${this.escapeHtml(n||"Contact")}</span>
            <button type="button" class="btn-clear-answerer" id="clear-answerer">√ó</button>
          </div>
        `;const o=s.querySelector("#clear-answerer");o&&d(o,"click",()=>this.setAnsweredBy(void 0,void 0))}else{s.innerHTML=`
          <button type="button" class="btn-select-answerer" id="show-answerer-picker">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            Select who answered...
          </button>
        `;const o=s.querySelector("#show-answerer-picker"),i=this.container.querySelector("#answerer-picker-dropdown");o&&i&&d(o,"click",r=>{r.stopPropagation(),i.classList.toggle("hidden");const c=i.querySelector("#answerer-search");c&&c.focus()})}}async submitFeedback(t,n){try{await Qe.submitAnswerFeedback(this.question.id,t,n),m.success("Feedback submitted");const s=this.container.querySelector(".feedback-buttons");s&&(s.innerHTML='<span class="feedback-submitted">Thank you for your feedback!</span>')}catch{m.error("Failed to submit feedback")}}async loadContacts(){try{const t=await Ne.getAll();this.contacts=t?.contacts||[],this.renderAssignmentState()}catch(t){console.error("Error loading contacts",t)}}getInitials(t){if(!t)return"?";const n=t.trim().split(/\s+/);return n.length===1?n[0].substring(0,2).toUpperCase():(n[0][0]+n[n.length-1][0]).toUpperCase()}escapeHtml(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}async loadChain(t){const n=this.container.querySelector("#chain-content");if(n)try{const s=await v.get(`/api/questions/${t}/chain`);if(!this.container.isConnected)return;const{parent:a,children:o}=s.data;if(!a&&o.length===0){n.innerHTML='<p class="empty-state">No follow-up chain</p>';return}let i="";a&&(i+=`
          <div class="chain-item chain-parent" data-id="${a.id}">
            <span class="chain-arrow">‚Üê</span>
            <span class="chain-label">Parent:</span>
            <span class="chain-content">${this.escapeHtml(a.content.substring(0,50))}...</span>
            <span class="status-badge status-${a.status}">${a.status}</span>
          </div>
        `),i+='<div class="chain-item chain-current">This question</div>';for(const r of o)i+=`
          <div class="chain-item chain-child" data-id="${r.id}">
            <span class="chain-arrow">‚Üí</span>
            <span class="chain-content">${this.escapeHtml(r.content.substring(0,50))}...</span>
            <span class="status-badge status-${r.status}">${r.status}</span>
          </div>
        `;n.innerHTML=i,n.querySelectorAll(".chain-item[data-id]").forEach(r=>{d(r,"click",()=>{const c=r.getAttribute("data-id");c&&this.props.onNavigateToQuestion&&this.props.onNavigateToQuestion(c)})})}catch{n.innerHTML='<p class="error">Failed to load chain</p>'}}async loadSimilar(t){const n=this.container.querySelector("#similar-content");if(n)try{const s=await v.get(`/api/questions/${t}/similar?limit=5`);if(!this.container.isConnected)return;const{similar:a}=s.data;if(!a||a.length===0){n.innerHTML='<p class="empty-state">No similar questions found</p>';return}const o=a.map(i=>`
        <div class="similar-item" data-id="${i.id}">
          <div class="similar-content">${this.escapeHtml(i.content.substring(0,60))}...</div>
          <div class="similar-meta">
            <span class="status-badge status-${i.status}">${i.status}</span>
            <span class="similarity-score">${Math.round(i.similarityScore*100)}%</span>
          </div>
        </div>
      `).join("");n.innerHTML=o,n.querySelectorAll(".similar-item").forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-id");r&&this.props.onNavigateToQuestion&&this.props.onNavigateToQuestion(r)})})}catch{n.innerHTML='<p class="error">Failed to load similar questions</p>'}}async loadTimeline(t){const n=this.container.querySelector("#timeline-content");if(n)try{const s=await v.get(`/api/questions/${t}/timeline`);if(!this.container.isConnected)return;const{events:a}=s.data;if(!a||a.length===0){n.innerHTML='<p class="empty-state">No events recorded</p>';return}const o=a.map(i=>{const r=this.getEventIcon(i.event_type),c=this.getEventDescription(i);return`
          <div class="timeline-item">
            <div class="timeline-icon">${r}</div>
            <div class="timeline-content">
              <div class="timeline-title">${c}</div>
              <div class="timeline-date">${Ts(i.created_at)}</div>
            </div>
          </div>
        `}).join("");n.innerHTML=`<div class="timeline-list">${o}</div>`}catch{n.innerHTML='<p class="error">Failed to load timeline</p>'}}getEventIcon(t){return{created:"üìù",assigned:"üë§",answered:"‚úÖ",priority_changed:"üî∫",status_changed:"üîÑ",reopened:"üîì",dismissed:"‚ùå",sla_breached:"‚è∞",entity_extracted:"üè∑Ô∏è",similar_linked:"üîó"}[t]||"‚Ä¢"}getEventDescription(t){const n=t.event_data||{};switch(t.event_type){case"created":return`Created${t.actor_name?` by ${t.actor_name}`:""}`;case"assigned":return`Assigned to ${n.to||"someone"}${t.actor_name?` by ${t.actor_name}`:""}`;case"answered":return`Answered${t.actor_name?` by ${t.actor_name}`:""} (${n.source||"manual"})`;case"priority_changed":return`Priority changed: ${n.from} ‚Üí ${n.to}`;case"status_changed":return`Status changed: ${n.from} ‚Üí ${n.to}`;case"reopened":return`Reopened${t.actor_name?` by ${t.actor_name}`:""}`;case"dismissed":return`Dismissed${t.actor_name?` by ${t.actor_name}`:""}`;case"sla_breached":return"SLA breached";case"entity_extracted":return`Entities extracted: ${n.entities?.length||0}`;default:return t.event_type}}async loadAISuggestions(){const t=this.container.querySelector("#suggestions-panel"),n=this.container.querySelector("#ai-suggest-btn");if(!(!t||!this.question)){n.disabled=!0,n.innerHTML=`
      <svg class="spin" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      Analyzing...
    `,t.classList.remove("hidden"),t.innerHTML=`
      <div class="suggestions-loading">
        <div class="ai-thinking-animation">
          <span></span><span></span><span></span>
        </div>
        <div class="loading-text">AI is analyzing question context and team expertise...</div>
      </div>
    `;try{const s=await Qe.suggestAssignee({id:this.question.id,useAI:!0});if(!this.container.isConnected)return;if(s.suggestions.length===0){t.innerHTML=`
          <div class="no-suggestions">
            <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="no-suggestions-text">No matching experts found</div>
            <button class="btn-show-all-contacts" id="show-all-btn">Browse all contacts</button>
          </div>
        `;const a=t.querySelector("#show-all-btn");a&&d(a,"click",()=>{t.classList.add("hidden");const o=this.container.querySelector("#contact-picker");o&&o.classList.remove("hidden")})}else{t.innerHTML=`
          <div class="suggestions-header-sota">
            <div class="ai-badge">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              AI Recommended
            </div>
            ${s.cached?'<span class="cached-tag">Cached</span>':'<span class="fresh-tag">Fresh</span>'}
          </div>
          <div class="suggestions-list-sota">
            ${s.suggestions.map((o,i)=>{const r=this.contacts.find(p=>(p.name||"").trim().toLowerCase()===(o.person||"").trim().toLowerCase())||this.contacts.find(p=>(p.aliases||[]).some(g=>String(g).trim().toLowerCase()===(o.person||"").trim().toLowerCase())),c=r?.photoUrl||r?.avatarUrl||r?.photo_url||r?.avatar_url,l=r?.role??o.role??"",u=this.getScoreColor(o.score);return`
                <div class="suggestion-card-sota" data-index="${i}">
                  <div class="suggestion-rank">#${i+1}</div>
                  <div class="suggestion-avatar-sota">
                    ${c?`<img src="${c}" alt="${this.escapeHtml(o.person)}" onerror="this.parentElement.innerHTML='${this.getInitials(o.person)}'">`:this.getInitials(o.person)}
                  </div>
                  <div class="suggestion-info-sota">
                    <div class="suggestion-name-sota">${this.escapeHtml(o.person)}</div>
                    ${l?`<div class="suggestion-role-sota">${this.escapeHtml(l)}</div>`:""}
                    <div class="suggestion-reason-sota">${this.escapeHtml(o.reason)}</div>
                  </div>
                  <div class="suggestion-score-sota" style="--score-color: ${u}">
                    <div class="score-ring">
                      <svg viewBox="0 0 36 36">
                        <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path class="score-fill" stroke-dasharray="${o.score}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                      </svg>
                      <div class="score-value">${o.score}%</div>
                    </div>
                    <div class="score-label">Match</div>
                  </div>
                  <button class="btn-select-suggestion">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Assign
                  </button>
                </div>
              `}).join("")}
          </div>
          <div class="suggestions-footer">
            <button class="btn-link" id="hide-suggestions-btn">Close suggestions</button>
          </div>
        `,t.querySelectorAll(".suggestion-card-sota").forEach(o=>{const i=o.querySelector(".btn-select-suggestion");i&&d(i,"click",async r=>{r.stopPropagation();const c=parseInt(o.getAttribute("data-index")||"0"),l=s.suggestions[c];if(l&&this.question){const u=this.container.querySelector("#assignee-select"),p=this.contacts.find(k=>k.name===l.person),g=this.question.assigned_to,f=this.question.status;this.question.assigned_to=l.person,this.question.status="assigned",p&&u&&(u.value=p.id);const h=this.container.querySelector("#current-assignment");h&&(h.innerHTML=this.renderAssignmentState()),this.bindPickerButtons(),t.classList.add("hidden");try{await Qe.update(this.question.id,{assigned_to:l.person,status:"assigned"}),m.success(`Assigned to ${l.person}`)}catch(k){if(console.error("[QuestionDetail] Failed to save AI suggestion assignment:",k),this.question.assigned_to=g,this.question.status=f,u&&g){const C=this.contacts.find(x=>x.name===g);C&&(u.value=C.id)}h&&(h.innerHTML=this.renderAssignmentState()),this.bindPickerButtons(),m.error("Failed to save assignment. Reverted changes.")}}})});const a=t.querySelector("#hide-suggestions-btn");a&&d(a,"click",()=>{t.classList.add("hidden")})}}catch(s){const o=(r=>r.message==="Request timed out"||r.status===0)(s);t.innerHTML=`
        <div class="suggestions-error">
          <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>${o?"This took longer than expected.":"Failed to get AI suggestions."}</div>
          ${o?'<p class="suggestions-error-hint">You can try again (suggestions may be ready) or choose someone manually.</p>':""}
          <button class="btn-retry" id="retry-suggestions-btn">Try Again</button>
        </div>
      `;const i=t.querySelector("#retry-suggestions-btn");i&&d(i,"click",()=>this.loadAISuggestions())}finally{n&&(n.disabled=!1,n.innerHTML=`
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          AI Suggest
        `)}}}getScoreColor(t){return t>=75?"#10b981":t>=50?"#f59e0b":"#6b7280"}bindPickerButtons(){const t=this.container,n=t.querySelector("#show-picker-btn"),s=t.querySelector("#change-assignee-btn"),a=t.querySelector("#contact-picker");n&&a&&d(n,"click",()=>{a.classList.toggle("hidden");const o=a.querySelector("#contact-search");o&&o.focus()}),s&&a&&d(s,"click",()=>{a.classList.toggle("hidden");const o=a.querySelector("#contact-search");o&&o.focus()})}async checkPotentialAnswers(){const t=this.container.querySelector("#potential-answers");if(t){t.innerHTML='<div class="loading">Searching knowledge base...</div>';try{const n=`${this.question.content} ${this.question.context||""}`.trim().substring(0,100),s=await xe(()=>Promise.resolve().then(()=>bw),void 0).then(i=>i.factsService.getAll());if(!this.container.isConnected)return;const o=(s.facts||[]).filter(i=>i.content.toLowerCase().includes(this.question.content.toLowerCase())||this.question.content.toLowerCase().includes(i.content.toLowerCase())).slice(0,3);if(o.length===0){t.innerHTML='<p class="empty-state">No direct matches found in knowledge base.</p>';return}t.innerHTML=o.map(i=>`
         <div class="potential-answer-card">
           <div class="answer-content">${this.escapeHtml(i.content)}</div>
           <div class="answer-meta">
             <span class="badg badge-fact">Fact</span>
             <span class="confidence">Confidence: ${Math.round((i.confidence||.8)*100)}%</span>
             <button class="btn-use-answer" data-content="${this.escapeHtml(i.content)}">Use this</button>
           </div>
         </div>
       `).join(""),t.querySelectorAll(".btn-use-answer").forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-content"),c=this.container.querySelector("#answer-input");c&&r&&(c.value=r,c.focus())})})}catch{t.innerHTML='<p class="error">Failed to check answers</p>'}}}async saveAnswer(){const n=this.container.querySelector("#answer-input")?.value.trim();if(!n){m.error("Please enter an answer");return}const s=this.container.querySelector("#save-answer-btn");s&&(s.disabled=!0,s.textContent="Saving...");const o=this.container.querySelector('input[name="answer-source"]:checked')?.value||"manual",i=this.container.querySelector("#answered-by-contact"),r=i?.value,c=i?.getAttribute("data-name"),u=this.container.querySelector("#followup-input")?.value.trim(),p={...this.question};this.question.answer=n,this.render();try{const g=await Qe.answer(this.question.id,{answer:n,source:o,answeredByContactId:r||void 0,answeredByName:c||void 0,followupQuestions:u});if(!this.container.isConnected)return;if(g.success)m.success("Answer saved successfully"),this.question=g.question,this.props.onUpdate&&this.props.onUpdate(g.question),this.render();else throw new Error(g.message||"Failed to save answer")}catch(g){console.error("Save answer error:",g),m.error("Error saving answer. restoring..."),this.question=p,this.render(),setTimeout(()=>{const f=this.container.querySelector("#answer-input");f&&(f.value=n)},0)}}async reopenQuestion(){if(confirm("Are you sure you want to reopen this question?"))try{const t=await Qe.reopen(this.question.id,"Manually reopened");if(!this.container.isConnected)return;m.success("Question reopened"),this.question=t,this.props.onUpdate&&this.props.onUpdate(t),this.render()}catch{m.error("Failed to reopen question")}}async dismissQuestionWithReason(t,n){try{const s=await Qe.dismissQuestion(this.question.id,t,n);if(!this.container.isConnected)return;m.success("Question dismissed"),this.question=s,this.props.onUpdate&&this.props.onUpdate(s),this.props.onClose()}catch{m.error("Failed to dismiss")}}async showDeferDialog(){const t=prompt("Defer until (YYYY-MM-DD):",new Date(Date.now()+864e5).toISOString().split("T")[0]);if(!t)return;const n=prompt("Reason for deferring (optional):")||void 0;try{const s=await Qe.deferQuestion(this.question.id,t,n);if(!this.container.isConnected)return;m.success("Question deferred"),this.question=s,this.props.onUpdate&&this.props.onUpdate(s),this.props.onClose()}catch{m.error("Failed to defer question")}}}function br(e){return new rg(e).render()}const lC=Object.freeze(Object.defineProperty({__proto__:null,QuestionDetailView:rg,createQuestionDetailView:br},Symbol.toStringTag,{value:"Module"})),Xt="question-modal";let ui=[];function Yi(e){const{mode:t,question:n,onSave:s,onDismiss:a}=e;ui=[];const o=document.querySelector(`[data-modal-id="${Xt}"]`);o&&o.remove();const i=b("div",{className:"question-modal-content"});t==="create"?pC(i):t==="edit"&&n?mC(i,n):n&&gC(i,n,t==="answer");const r=b("div",{className:"modal-footer"});uC(r,t,n,i,e);const c=Pe({id:Xt,title:dC(t),content:i,size:"lg",footer:r});document.body.appendChild(c),De(Xt)}function dC(e){switch(e){case"create":return"New Question";case"edit":return"Edit Question";case"answer":return"Answer Question";default:return"Question Details"}}function uC(e,t,n,s,a){const{onSave:o,onDismiss:i,onDelete:r}=a;if(t==="create"){const c=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=b("button",{className:"btn btn-primary",textContent:"Create Question"});d(c,"click",()=>K(Xt)),d(l,"click",()=>fC(s,o)),e.appendChild(c),e.appendChild(l)}else if(t==="edit"&&n){const c=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=b("button",{className:"btn btn-primary",textContent:"Save Changes"});d(c,"click",()=>K(Xt)),d(l,"click",()=>hC(s,n,o)),e.appendChild(c),e.appendChild(l)}else if(n){const c=n.status;if(c!=="resolved"&&c!=="dismissed"){const u=b("button",{className:"btn btn-secondary",textContent:"Dismiss"});if(d(u,"click",()=>yC(n.id,i)),e.appendChild(u),t==="answer"){const p=b("button",{className:"btn btn-primary",textContent:"Save Answer"});d(p,"click",()=>bC(s,n,o)),e.appendChild(p)}else{const p=b("button",{className:"btn btn-primary",textContent:"Answer"});d(p,"click",()=>{K(Xt),Yi({...a,mode:"answer"})}),e.appendChild(p)}}else if(c==="resolved"){const u=b("button",{className:"btn btn-warning",textContent:"Reopen"});d(u,"click",()=>wC(n,o)),e.appendChild(u)}const l=b("button",{className:"btn btn-secondary",textContent:"Close"});d(l,"click",()=>K(Xt)),e.appendChild(l)}}function pC(e){e.innerHTML=`
    <form id="question-form" class="question-form">
      <div class="form-group">
        <label for="question-content">Question <span class="required">*</span></label>
        <textarea id="question-content" rows="3" required minlength="5"
                  placeholder="What needs to be clarified? (min 5 characters)"></textarea>
        <div id="duplicate-warning" class="form-warning hidden"></div>
      </div>
      
      <div class="form-group">
        <label for="question-context">Context</label>
        <textarea id="question-context" rows="2"
                  placeholder="Why is this question important?"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="question-priority">Priority</label>
          <select id="question-priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="question-assignee">Assign To</label>
          <input type="text" id="question-assignee" placeholder="Person name">
          <button type="button" id="suggest-assignee-btn" class="btn btn-sm btn-secondary">
            AI Suggest
          </button>
        </div>
      </div>
      
      <div id="suggestions-container" class="suggestions-container hidden"></div>
    </form>
  `;const t=e.querySelector("#suggest-assignee-btn");t&&d(t,"click",()=>vC(e))}function mC(e,t){e.innerHTML=`
    <form id="question-form" class="question-form">
      <div class="form-group">
        <label for="question-content">Question <span class="required">*</span></label>
        <textarea id="question-content" rows="3" required minlength="5">${Ht(t.content)}</textarea>
      </div>
      
      <div class="form-group">
        <label for="question-context">Context</label>
        <textarea id="question-context" rows="2">${Ht(t.context||"")}</textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="question-priority">Priority</label>
          <select id="question-priority">
            <option value="low" ${t.priority==="low"?"selected":""}>Low</option>
            <option value="medium" ${t.priority==="medium"?"selected":""}>Medium</option>
            <option value="high" ${t.priority==="high"?"selected":""}>High</option>
            <option value="critical" ${t.priority==="critical"?"selected":""}>Critical</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="question-status">Status</label>
          <select id="question-status">
            <option value="pending" ${t.status==="pending"?"selected":""}>Pending</option>
            <option value="assigned" ${t.status==="assigned"?"selected":""}>Assigned</option>
            <option value="resolved" ${t.status==="resolved"?"selected":""}>Resolved</option>
            <option value="dismissed" ${t.status==="dismissed"?"selected":""}>Dismissed</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="question-assignee">Assigned To</label>
        <input type="text" id="question-assignee" value="${Ht(t.assigned_to||"")}">
      </div>
      
      <div class="form-group">
        <label for="question-category">Category</label>
        <input type="text" id="question-category" value="${Ht(t.category||"")}">
      </div>
    </form>
  `}function gC(e,t,n){e.innerHTML=`
    <div class="question-view">
      <div class="question-meta">
        <span class="priority-badge priority-${t.priority}">${t.priority}</span>
        <span class="status-badge status-${t.status}">${t.status}</span>
        <span class="question-date">${Ce(t.created_at)}</span>
        ${t.assigned_to?`<span class="question-assignee">‚Üí ${Ht(t.assigned_to)}</span>`:""}
      </div>
      
      <div class="question-content-large">
        ${Ht(t.content)}
      </div>
      
      ${t.context?`<div class="question-context"><strong>Context:</strong> ${Ht(t.context)}</div>`:""}
      ${t.category?`<div class="question-category"><strong>Category:</strong> ${Ht(t.category)}</div>`:""}
      ${t.source_file?`<div class="question-source"><strong>Source:</strong> ${Ht(t.source_file)}</div>`:""}
      
      ${t.answer?`
        <div class="question-answer-section">
          <h4>Answer ${t.answer_source?`<span class="answer-source">(${t.answer_source})</span>`:""}</h4>
          <div class="answer-text">${Ht(t.answer)}</div>
          ${t.resolved_at?`<div class="answer-date">Resolved ${Ce(t.resolved_at)}</div>`:""}
        </div>
      `:""}
      
      ${n&&t.status!=="resolved"?`
        <div class="answer-form">
          <div class="form-group">
            <label for="question-answer">Your Answer <span class="required">*</span></label>
            <textarea id="question-answer" rows="4" required minlength="3"
                      placeholder="Provide an answer (min 3 characters)..."></textarea>
          </div>
          <div class="form-group">
            <label for="answer-source">Source</label>
            <select id="answer-source">
              <option value="manual" selected>Manual</option>
              <option value="document">From Document</option>
              <option value="ai">AI Assisted</option>
            </select>
          </div>
          <div class="form-group">
            <label for="followup-questions">Follow-up Questions (one per line)</label>
            <textarea id="followup-questions" rows="2"
                      placeholder="Add any follow-up questions..."></textarea>
          </div>
        </div>
      `:""}
      
      ${t.reopened_reason?`
        <div class="reopen-reason">
          <strong>Reopen Reason:</strong> ${Ht(t.reopened_reason)}
        </div>
      `:""}
    </div>
  `}async function vC(e){const n=e.querySelector("#question-content")?.value.trim();if(!n||n.length<5){m.warning("Please enter at least 5 characters for the question");return}const s=e.querySelector("#suggestions-container"),a=e.querySelector("#suggest-assignee-btn");a.disabled=!0,a.textContent="Loading...",s.classList.remove("hidden"),s.innerHTML='<div class="loading">Getting AI suggestions...</div>';try{const o=await Qe.suggestAssignee({content:n,useAI:!0});ui=o.suggestions,ui.length===0?s.innerHTML='<div class="no-suggestions">No suggestions available</div>':(s.innerHTML=`
        <h4>AI Suggestions ${o.cached?'<span class="cached">(cached)</span>':""}</h4>
        <div class="suggestions-list">
          ${ui.map((i,r)=>`
            <div class="suggestion-item" data-index="${r}">
              <div class="suggestion-person">${Ht(i.person)}</div>
              <div class="suggestion-score">${i.score}%</div>
              <div class="suggestion-reason">${Ht(i.reason)}</div>
              ${i.role?`<div class="suggestion-role">${Ht(i.role)}</div>`:""}
            </div>
          `).join("")}
        </div>
      `,s.querySelectorAll(".suggestion-item").forEach(i=>{d(i,"click",()=>{const r=parseInt(i.getAttribute("data-index")||"0",10),c=ui[r];if(c){const l=e.querySelector("#question-assignee");l&&(l.value=c.person),s.classList.add("hidden"),m.success(`Selected: ${c.person}`)}})}))}catch{s.innerHTML='<div class="error">Failed to get suggestions</div>'}finally{a.disabled=!1,a.textContent="AI Suggest"}}async function fC(e,t){const n=e.querySelector("#question-form");if(!n.checkValidity()){n.reportValidity();return}const s=o=>e.querySelector(`#${o}`)?.value.trim()||"",a={content:s("question-content"),priority:s("question-priority"),assigned_to:s("question-assignee")||void 0,context:s("question-context")||void 0};try{const o=await Qe.create(a);if(o.duplicate){const r=e.querySelector("#duplicate-warning");r&&(r.classList.remove("hidden"),r.innerHTML=`‚ö†Ô∏è Similar question exists (${o.similarity}% match). <a href="#" id="view-duplicate">View existing</a>`);return}m.success("Question created");const i={id:o.id||Date.now(),content:a.content,priority:a.priority||"medium",status:a.assigned_to?"assigned":"pending",assigned_to:a.assigned_to,context:a.context,created_at:new Date().toISOString()};t?.(i),K(Xt)}catch{}}async function hC(e,t,n){const s=a=>e.querySelector(`#${a}`)?.value.trim()||"";try{const a=await Qe.update(t.id,{content:s("question-content"),context:s("question-context")||void 0,priority:s("question-priority"),status:s("question-status"),assigned_to:s("question-assignee")||void 0,category:s("question-category")||void 0});m.success("Question updated"),n?.(a),K(Xt)}catch{}}async function bC(e,t,n){const s=e.querySelector("#question-answer"),a=e.querySelector("#answer-source"),o=e.querySelector("#followup-questions"),i=s?.value.trim(),r=a?.value||"manual",c=o?.value.trim();if(!i||i.length<3){m.warning("Please provide an answer (at least 3 characters)");return}try{const l=await Qe.answer(t.id,{answer:i,source:r,followupQuestions:c});m.success(l.message),n?.(l.question),K(Xt)}catch{}}async function yC(e,t){const{confirm:n}=await xe(async()=>{const{confirm:a}=await Promise.resolve().then(()=>In);return{confirm:a}},void 0);if(await n("Are you sure you want to dismiss this question?",{title:"Dismiss Question",confirmText:"Dismiss"}))try{await Qe.delete(e,"dismissed"),m.success("Question dismissed"),t?.(e),K(Xt)}catch{}}async function wC(e,t){const{prompt:n}=await xe(async()=>{const{prompt:a}=await Promise.resolve().then(()=>In);return{prompt:a}},void 0),s=await n("Why are you reopening this question?",{title:"Reopen Question",placeholder:"Enter reason..."});if(s)try{const a=await Qe.reopen(e.id,s);m.success("Question reopened"),t?.(a),K(Xt)}catch{}}function Ht(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let Bs="all",pi="status";function zl(e={}){const t=b("div",{className:"sot-panel questions-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Questions</h2>
        <span class="panel-count" id="questions-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="questions-filter" class="filter-select">
          <option value="all">All Active</option>
          <option value="pending">Pending</option>
          <option value="assigned">Assigned</option>
          <option value="critical">Critical Priority</option>
          <option value="overdue">Overdue (SLA)</option>
          <option value="resolved">‚úì Resolved</option>
          <option value="dismissed">‚úó Dismissed</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="status">By Status</button>
          <button class="view-tab" data-view="person">By Person</button>
          <button class="view-tab" data-view="team">By Team</button>
        </div>
        <button class="btn btn-secondary btn-sm" id="generate-team-btn" title="Generate questions for team based on roles">‚ö° Generate</button>
        <button class="btn btn-primary btn-sm" id="add-question-btn">+ Add</button>
      </div>
    </div>
    <div class="panel-content" id="questions-content">
      <div class="loading">Loading questions...</div>
    </div>
  `;const n=t.querySelector("#questions-filter");d(n,"change",()=>{Bs=n.value,vs(t,e)});const s=t.querySelectorAll(".view-tab");s.forEach(i=>{d(i,"click",()=>{s.forEach(r=>r.classList.remove("active")),i.classList.add("active"),pi=i.getAttribute("data-view"),vs(t,e)})});const a=t.querySelector("#add-question-btn");a&&d(a,"click",()=>{Yi({mode:"create",onSave:()=>vs(t,e)})});const o=t.querySelector("#generate-team-btn");return o&&d(o,"click",()=>$C(t,e)),vs(t,e),ce.subscribe(()=>{ug(t)}),t}async function vs(e,t){const n=e.querySelector("#questions-content");n.innerHTML='<div class="loading">Loading...</div>';try{let s=[];if(pi==="status")Bs==="overdue"?(s=await Qe.getAll(),s=s.filter(a=>a.sla_breached===!0||a.status!=="resolved"&&a.status!=="dismissed"&&kC(a))):Bs==="critical"?(s=await Qe.getAll(),s=s.filter(a=>a.priority==="critical"&&a.status!=="resolved"&&a.status!=="dismissed")):Bs==="all"?(s=await Qe.getAll(),s=s.filter(a=>a.status!=="dismissed"&&a.status!=="resolved"&&a.status!=="closed")):Bs==="dismissed"?(s=await Qe.getAll(),s=s.filter(a=>a.status==="dismissed")):Bs==="resolved"?(s=await Qe.getAll(),s=s.filter(a=>a.status==="resolved"||a.status==="answered")):(s=await Qe.getAll(),s=s.filter(a=>a.status===Bs)),xC(n,s,t);else if(pi==="person"){const a=await Qe.getByPerson();bu(n,a,t)}else if(pi==="team"){const a=await Qe.getByTeam();bu(n,a,t)}pi==="status"&&ce.setQuestions(s),ug(e)}catch{n.innerHTML='<div class="error">Failed to load questions</div>'}}function kC(e){if(!e.created_at)return!1;const t=e.sla_hours||168,n=new Date(e.created_at),s=new Date(n.getTime()+t*60*60*1e3);return new Date>s}function xC(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No questions found</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Question</button>
      </div>
    `;const s=e.querySelector("#empty-add-btn");s&&d(s,"click",()=>{Yi({mode:"create"})});return}e.innerHTML=t.map(s=>cg(s)).join(""),lg(e,t,n)}function bu(e,t,n){const s=Object.entries(t);if(s.length===0){e.innerHTML='<div class="empty-state"><p>No questions found</p></div>';return}e.innerHTML=s.map(([o,i])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${qn(o)}</h3>
        <span class="group-count">${i.length}</span>
      </div>
      <div class="group-items">
        ${i.map(r=>cg(r)).join("")}
      </div>
    </div>
  `).join("");const a=s.flatMap(([,o])=>o);lg(e,a,n)}function cg(e){const t=`priority-${e.priority}`,n=`status-${e.status}`,s=e.sla_breached,a=e.answer_source==="auto-detected",o=!!e.answer,i=!!e.requester_role,r=g=>{if(!g)return"?";const f=g.trim().split(/\s+/);return f.length===1?f[0].substring(0,2).toUpperCase():(f[0][0]+f[f.length-1][0]).toUpperCase()};let c=`<div class="question-card-sota${s?" sla-breached":""}${o?" has-answer":""}" data-id="${e.id}">`;c+=`<div class="card-priority-bar ${t}"></div>`,c+='<div class="card-body">',c+='<div class="card-top-row">',c+='<div class="card-badges">',c+=`<span class="priority-pill ${t}">${e.priority}</span>`,c+=`<span class="status-pill ${n}">${e.status}</span>`,s&&(c+='<span class="sla-pill">SLA</span>'),a&&(c+='<span class="auto-pill">Answer Found</span>'),e.follow_up_to&&(c+='<span class="followup-pill">Follow-up</span>'),c+="</div>",c+=`<span class="card-timestamp">${Ce(e.created_at)}</span>`,c+="</div>",c+=`<div class="card-question-text">${qn(e.content)}</div>`,c+='<div class="card-bottom-row">';const l=ce.getState().contacts||[],u=(g,f)=>{const h=f?l.find(k=>k.id===f):l.find(k=>k.name===g);return h?.photoUrl||h?.avatarUrl||h?.photo_url||h?.avatar_url||null},p=(g,f,h)=>f?`<div class="${h}"><img src="${f}" alt="${qn(g)}" onerror="this.parentElement.innerHTML='${r(g)}'"></div>`:`<div class="${h}">${r(g)}</div>`;if(c+='<div class="card-requester">',i){const g=e.requester_name||"",f=e.requester_role||"",h=e.requester_contact_id,k=u(g,h);c+='<div class="requester-chip">',c+=p(g||f,k,"requester-avatar"),c+='<div class="requester-info">',g&&(c+=`<span class="requester-name">${qn(g)}</span>`),c+=`<span class="requester-role">${qn(f)}</span>`,c+="</div>",c+="</div>"}if(c+="</div>",c+='<div class="card-assignment">',e.assigned_to){const g=u(e.assigned_to);c+='<div class="assignee-chip">',c+=p(e.assigned_to,g,"assignee-avatar"),c+='<div class="assignee-info">',c+=`<span class="assignee-name">${qn(e.assigned_to)}</span>`,o&&(c+='<span class="answered-badge">Answered</span>'),c+="</div>",c+="</div>"}else c+='<div class="unassigned-chip">',c+="<span>Unassigned</span>",c+="</div>";return c+="</div>",c+="</div>",c+="</div>",c+="</div>",c}function lg(e,t,n){e.querySelectorAll(".question-card-sota").forEach(s=>{d(s,"click",()=>{const a=s.getAttribute("data-id"),o=t.find(i=>String(i.id)===a);o&&(n.onQuestionClick?n.onQuestionClick(o):n.useDetailView&&n.containerElement?dg(o,n):Yi({mode:"view",question:o,onSave:()=>vs(e.closest(".questions-panel"),n)}))})})}function dg(e,t){const n=t.containerElement;if(!n)return;const s=n.innerHTML,a=br({question:e,onClose:()=>{n.innerHTML=s;const o=n.querySelector(".questions-panel");o&&vs(o,t)},onUpdate:o=>{if(o.status==="dismissed"||o.status==="resolved"||o.status==="closed"){n.innerHTML=s;const i=n.querySelector(".questions-panel");i&&vs(i,t),m.info("Question updated - returning to list")}},onNavigateToQuestion:async o=>{try{const r=(await Qe.getAll()).find(c=>String(c.id)===o);r&&dg(r,t)}catch{m.error("Failed to load question")}}});n.innerHTML="",n.appendChild(a)}async function $C(e,t){const n=document.createElement("div");n.className="modal open",n.id="generate-ai-modal",n.innerHTML=`
    <div class="modal-backdrop"></div>
    <div class="modal-container modal-sota modal-sota-relative">
      <!-- Header -->
      <div class="sota-header header-primary">
        <div class="header-row">
          <div class="header-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
              <circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/>
            </svg>
          </div>
          <div class="header-text">
            <h2>AI Question Generator</h2>
            <p>Generate contextual questions for your project team</p>
          </div>
        </div>
        <button class="header-close" id="close-modal">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- Tabs -->
      <div class="sota-tabs">
        <button class="sota-tab active" data-source="team">
          <span class="tab-icon">üë•</span>
          <span>Team Members</span>
        </button>
        <button class="sota-tab" data-source="contacts">
          <span class="tab-icon">üìá</span>
          <span>Project Contacts</span>
        </button>
      </div>

      <!-- Body -->
      <div class="sota-body">
        <!-- Section: Roles -->
        <div class="sota-section">
          <div class="section-title">
            <span class="title-icon">üé≠</span>
            <span>Select a Role</span>
          </div>
          <div id="roles-grid" class="sota-grid">
            <div class="sota-loading">
              <div class="spinner-ring"></div>
              <p>Loading roles...</p>
            </div>
          </div>
        </div>

        <!-- Section: Configuration (hidden until role selected) -->
        <div class="sota-section hidden" id="config-section">
          <div id="selected-badge"></div>
          
          <div class="config-row">
            <label>Questions to generate</label>
            <div class="config-buttons">
              <button class="config-btn active" data-count="auto" title="AI determines optimal count">‚ú® Auto</button>
              <button class="config-btn" data-count="3">3</button>
              <button class="config-btn" data-count="5">5</button>
              <button class="config-btn" data-count="8">8</button>
            </div>
          </div>

          <label class="toggle-row">
            <input type="checkbox" id="use-context" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span>Use project context (facts, documents)</span>
          </label>
          
          <label class="toggle-row">
            <input type="checkbox" id="skip-dupes" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span>Skip duplicate questions</span>
          </label>

          <button class="sota-btn-primary sota-btn-mt" id="btn-generate">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
            Generate Questions
          </button>
        </div>
      </div>

      <!-- Overlay for generation -->
      <div class="sota-overlay hidden" id="gen-overlay">
        <div id="gen-content">
          <div class="overlay-spinner"></div>
          <h4 class="overlay-title">Generating questions...</h4>
          <p class="overlay-subtitle">AI is analyzing your project context</p>
        </div>
      </div>
    </div>
  `,document.body.appendChild(n);let s="team",a=null,o=[],i="auto";const r=n.querySelector("#roles-grid"),c=n.querySelector("#config-section"),l=n.querySelector("#selected-badge"),u=n.querySelector("#gen-overlay"),p=n.querySelector("#gen-content"),g=x=>x?x.split(" ").map($=>$[0]).join("").substring(0,2).toUpperCase():"?",f=x=>{const $=x.toLowerCase();return $.includes("analyst")||$.includes("data")?"üìä":$.includes("manager")||$.includes("lead")?"üëî":$.includes("developer")||$.includes("engineer")?"üíª":$.includes("design")||$.includes("ux")?"üé®":$.includes("product")||$.includes("owner")?"üì¶":$.includes("qa")||$.includes("test")?"üß™":$.includes("support")||$.includes("success")?"ü§ù":$.includes("sales")||$.includes("commercial")?"üí∞":$.includes("marketing")?"üì£":$.includes("security")?"üîí":$.includes("devops")||$.includes("infra")?"üöÄ":$.includes("legal")?"‚öñÔ∏è":"üë§"},h=async x=>{r.innerHTML='<div class="sota-loading"><div class="spinner-ring"></div><p>Loading roles...</p></div>',c.classList.add("hidden"),a=null;try{let $=[];if(x==="team")$=(await v.get("/api/questions/team-roles")).data.roles||[];else{const y=(await v.get("/api/contacts")).data.contacts||[],S={};for(const P of y)P.role&&(S[P.role]||(S[P.role]={role:P.role,members:[]}),S[P.role].members.push({id:P.id,name:P.name,photoUrl:P.photo_url,email:P.email}));$=Object.values(S)}if(o=$,$.length===0){r.innerHTML=`
          <div class="sota-empty sota-empty-full">
            <div class="empty-icon">${x==="team"?"üë•":"üìá"}</div>
            <h4>No ${x==="team"?"Team Members":"Contacts"} with Roles</h4>
            <p>${x==="team"?"Add team members with roles in Project Settings":"Add contacts with roles to this project"}</p>
          </div>
        `;return}r.innerHTML=$.map((w,y)=>`
        <div class="sota-card" data-idx="${y}">
          <div class="card-icon">${f(w.role)}</div>
          <div class="card-title">${qn(w.role)}</div>
          <div class="card-avatars">
            ${w.members.slice(0,3).map(S=>`
              <div class="mini-avatar" title="${qn(S.name)}">
                ${S.photoUrl?`<img src="${S.photoUrl}" alt="" class="mini-avatar-img" onerror="this.classList.add('hidden');this.nextElementSibling.classList.remove('hidden')">`:""}
                <span class="avatar-fallback${S.photoUrl?" hidden":""}">${g(S.name)}</span>
              </div>
            `).join("")}
            ${w.members.length>3?`<div class="mini-avatar more">+${w.members.length-3}</div>`:""}
          </div>
          <div class="card-subtitle">${w.members.map(S=>S.name).slice(0,2).join(", ")}${w.members.length>2?"...":""}</div>
          <div class="card-badge">${w.members.length}</div>
        </div>
      `).join(""),r.querySelectorAll(".sota-card").forEach(w=>{w.addEventListener("click",()=>{r.querySelectorAll(".sota-card").forEach(S=>S.classList.remove("selected")),w.classList.add("selected");const y=parseInt(w.getAttribute("data-idx")||"0",10);a=o[y],k()})})}catch{r.innerHTML=`
        <div class="sota-empty sota-empty-full">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <h4>Failed to Load</h4>
          <p>Could not fetch roles. Please try again.</p>
          <button class="sota-btn-primary sota-btn-retry" id="retry-load">Retry</button>
        </div>
      `,n.querySelector("#retry-load")?.addEventListener("click",()=>h(x))}},k=()=>{a&&(c.classList.remove("hidden"),l.innerHTML=`
      <div class="selected-badge">
        <span class="badge-icon">${f(a.role)}</span>
        <div class="badge-info">
          <strong>${qn(a.role)}</strong>
          <span>${a.members.map(x=>x.name).join(", ")}</span>
        </div>
        <button class="badge-clear" id="clear-selection">√ó</button>
      </div>
    `,n.querySelector("#clear-selection")?.addEventListener("click",()=>{a=null,c.classList.add("hidden"),r.querySelectorAll(".sota-card").forEach(x=>x.classList.remove("selected"))}))},C=async()=>{if(a){u.classList.remove("hidden");try{const x=await v.post("/api/questions/generate-ai",{role:a.role,memberIds:a.members.map(w=>w.id),count:i,includeContext:n.querySelector("#use-context")?.checked??!0,skipDuplicates:n.querySelector("#skip-dupes")?.checked??!0}),$=x.data.questions||[];p.innerHTML=`
        <div class="sota-success">
          <div class="success-icon">‚úì</div>
          <h4>${x.data.generated} Questions Generated</h4>
          <p>${x.data.skipped>0?`${x.data.skipped} duplicates skipped`:"All questions created successfully"}</p>
        </div>
        <div class="results-list">
          ${$.slice(0,5).map(w=>`
            <div class="result-row">
              <span class="result-badge ${w.priority}">${w.priority}</span>
              <span class="result-text">${qn(w.content.length>70?w.content.substring(0,70)+"...":w.content)}</span>
            </div>
          `).join("")}
          ${$.length>5?`<p class="sota-more-hint">+ ${$.length-5} more questions</p>`:""}
        </div>
        <p class="sota-questions-footer">
          üìã Questions from <strong>${a?.role}</strong> perspective<br>
          <span class="sota-questions-footer-muted">Use AI Suggest on each question to find who should answer</span>
        </p>
        <button class="sota-btn-primary" id="btn-done">Done</button>
      `,n.querySelector("#btn-done")?.addEventListener("click",()=>{n.remove(),vs(e,t)})}catch{p.innerHTML=`
        <div class="sota-error">
          <div class="error-icon">‚úó</div>
          <h4>Generation Failed</h4>
          <p>Something went wrong. Please try again.</p>
          <button class="sota-btn-primary sota-btn-retry sota-btn-retry-mt" id="retry-gen">Retry</button>
        </div>
      `,n.querySelector("#retry-gen")?.addEventListener("click",C)}}};n.querySelector("#close-modal")?.addEventListener("click",()=>n.remove()),n.querySelector(".modal-backdrop")?.addEventListener("click",()=>n.remove()),n.querySelectorAll(".sota-tab").forEach(x=>{x.addEventListener("click",()=>{n.querySelectorAll(".sota-tab").forEach($=>$.classList.remove("active")),x.classList.add("active"),s=x.getAttribute("data-source")||"team",h(s)})}),n.querySelectorAll(".config-btn").forEach(x=>{x.addEventListener("click",()=>{n.querySelectorAll(".config-btn").forEach(w=>w.classList.remove("active")),x.classList.add("active");const $=x.getAttribute("data-count")||"auto";i=$==="auto"?"auto":parseInt($,10)})}),n.querySelector("#btn-generate")?.addEventListener("click",C),h("team")}function ug(e){const t=e.querySelector("#questions-count");if(t){const n=ce.getState().questions;t.textContent=String(n.length)}}function qn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function pg(e={}){const t=b("div",{className:"source-of-truth"}),n=b("div",{className:"tabs"});[{id:"questions",label:"Questions",icon:"‚ùì"},{id:"risks",label:"Risks",icon:"‚ö†Ô∏è"},{id:"actions",label:"Actions",icon:"‚úÖ"},{id:"decisions",label:"Decisions",icon:"üéØ"}].forEach(g=>{const f=b("button",{className:"tab"});f.setAttribute("data-tab",g.id),f.innerHTML=`${g.icon} ${g.label} <span class="badge" data-count="0">0</span>`,d(f,"click",()=>{Ie.setSotView(g.id)}),n.appendChild(f)}),t.appendChild(n);const a=b("div",{className:"tab-panels"}),o=zl({onQuestionClick:e.onQuestionClick,useDetailView:!0,containerElement:t});o.classList.add("tab-panel");const i=SC(e.onRiskClick),r=_C(e.onActionClick),c=TC({onDecisionClick:e.onDecisionClick});o.setAttribute("data-panel","questions"),i.setAttribute("data-panel","risks"),r.setAttribute("data-panel","actions"),c.setAttribute("data-panel","decisions"),a.appendChild(o),a.appendChild(i),a.appendChild(r),a.appendChild(c),t.appendChild(a),Ie.subscribe(g=>{n.querySelectorAll(".tab").forEach(f=>{f.getAttribute("data-tab")===g.sotCurrentView?bn(f,"active"):ss(f,"active")}),a.querySelectorAll("[data-panel]").forEach(f=>{f.getAttribute("data-panel")===g.sotCurrentView?bn(f,"active"):ss(f,"active")})}),ce.subscribe(g=>{const f=n.querySelector('[data-tab="questions"] .badge'),h=n.querySelector('[data-tab="risks"] .badge'),k=n.querySelector('[data-tab="actions"] .badge'),C=n.querySelector('[data-tab="decisions"] .badge');f&&(f.textContent=String(g.questions.length)),h&&(h.textContent=String(g.risks.length)),k&&(k.textContent=String(g.actions.length)),C&&(C.textContent=String(g.decisions.length)),mg(o,g.questions,e.onQuestionClick),CC(i,g.risks,e.onRiskClick),LC(r,g.actions,e.onActionClick),AC(c,g.decisions,e.onDecisionClick)});const l=Ie.getState().sotCurrentView,u=n.querySelector(`[data-tab="${l}"]`),p=a.querySelector(`[data-panel="${l}"]`);return u&&bn(u,"active"),p&&bn(p,"active"),t}function mg(e,t,n){const s=e.querySelector(".questions-list");if(s){if(t.length===0){s.innerHTML='<div class="empty-state">No questions yet</div>';return}s.innerHTML=t.map(a=>`
    <div class="question-card ${a.status}" data-id="${a.id}">
      <div class="question-header">
        <span class="priority-badge priority-${a.priority}">${a.priority}</span>
        <span class="status-badge ${a.status}">${a.status}</span>
      </div>
      <div class="question-text">${ts(a.content||a.question||"")}</div>
      ${a.answer?`<div class="question-answer">${ts(a.answer)}</div>`:""}
      <div class="question-meta">${Ce(a.created_at||a.createdAt||new Date().toISOString())}</div>
    </div>
  `).join(""),s.querySelectorAll(".question-card").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-id"),i=t.find(r=>r.id===o||String(r.id)===o);i&&(n&&n(i),gg(e,i,t))})})}}function gg(e,t,n){const s=e.innerHTML,a=br({question:t,onClose:()=>{e.innerHTML=s;const o=ce.getState().questions;mg(e,o)},onUpdate:o=>{const i=ce.getState().questions,r=i.findIndex(c=>c.id===o.id||String(c.id)===String(o.id));r>=0&&(i[r]=o,ce.setQuestions(i))},onNavigateToQuestion:o=>{const i=n.find(r=>String(r.id)===o);i&&gg(e,i,n)}});e.innerHTML="",e.appendChild(a)}function SC(e){const t=b("div",{className:"tab-panel risks-panel"});return t.innerHTML='<div class="risks-list"></div>',t}function CC(e,t,n){const s=e.querySelector(".risks-list");if(s){if(t.length===0){s.innerHTML='<div class="empty-state">No risks identified</div>';return}s.innerHTML=t.map(a=>`
    <div class="risk-card ${a.impact}-impact" data-id="${a.id}">
      <div class="risk-header">
        <span class="impact-badge impact-${a.impact}">${a.impact} impact</span>
        <span class="probability-badge">${a.probability} probability</span>
      </div>
      <div class="risk-description">${ts(a.description||a.content||"")}</div>
      ${a.mitigation?`<div class="risk-mitigation">Mitigation: ${ts(a.mitigation)}</div>`:""}
    </div>
  `).join(""),n&&s.querySelectorAll(".risk-card").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-id"),i=t.find(r=>r.id===o);i&&n(i)})})}}function _C(e){const t=b("div",{className:"tab-panel actions-panel"});return t.innerHTML='<div class="actions-list"></div>',t}function LC(e,t,n){const s=e.querySelector(".actions-list");if(s){if(t.length===0){s.innerHTML='<div class="empty-state">No actions defined</div>';return}s.innerHTML=t.map(a=>`
    <div class="action-card ${a.status}" data-id="${a.id}">
      <div class="action-header">
        <span class="priority-badge priority-${a.priority}">${a.priority}</span>
        <span class="status-badge ${a.status}">${a.status.replace("_"," ")}</span>
      </div>
      <div class="action-task">${ts(a.task)}</div>
      <div class="action-meta">
        ${a.assignee?`<span>Assigned to: ${ts(a.assignee)}</span>`:""}
        ${a.dueDate?`<span>Due: ${a.dueDate}</span>`:""}
      </div>
    </div>
  `).join(""),n&&s.querySelectorAll(".action-card").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-id"),i=t.find(r=>r.id===o);i&&n(i)})})}}function TC(e){const t=b("div",{className:"tab-panel decisions-panel"});return t.innerHTML='<div class="decisions-list"></div>',t}function AC(e,t,n){const s=e.querySelector(".decisions-list");if(s){if(t.length===0){s.innerHTML='<div class="empty-state">No decisions recorded</div>';return}s.innerHTML=t.map(a=>`
    <div class="decision-card" data-id="${a.id}">
      <div class="decision-header">
        <span class="status-badge ${a.status}">${a.status}</span>
      </div>
      <div class="decision-text">${ts(a.content??a.decision??"")}</div>
      ${a.rationale?`<div class="decision-rationale">Rationale: ${ts(a.rationale)}</div>`:""}
      <div class="decision-meta">
        ${a.made_by??a.madeBy?`<span>By: ${ts(a.made_by??a.madeBy??"")}</span>`:""}
        <span>${Ce(a.decided_at??a.created_at??a.madeAt??"")}</span>
      </div>
    </div>
  `).join(""),n&&s.querySelectorAll(".decision-card").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-id"),i=t.find(r=>r.id===o);i&&n(i)})})}}function ts(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function MC(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`SourceOfTruth: Container not found: ${e}`),null;const s=pg(t);return n.appendChild(s),s}const rs="risk-modal";function Ba(e){const{mode:t,risk:n,onSave:s,onDelete:a}=e,o=t==="edit"&&n?.id,i=t==="view",r=document.querySelector(`[data-modal-id="${rs}"]`);r&&r.remove();const c=b("div",{className:"risk-modal-content"}),l=n?.description??n?.content??"",u=n?.probability??n?.likelihood??"medium",p=n?.createdAt??n?.created_at??"";if(i&&n)c.innerHTML=`
      <div class="risk-view">
        <div class="risk-meta">
          <span class="impact-badge impact-${n.impact}">${n.impact} impact</span>
          <span class="probability-badge">${u} probability</span>
          <span class="status-badge ${n.status}">${n.status}</span>
        </div>
        
        <div class="risk-description-large">
          ${Vr(l)}
        </div>
        
        ${n.mitigation?`
          <div class="risk-mitigation-section">
            <h4>Mitigation Strategy</h4>
            <p>${Vr(n.mitigation)}</p>
          </div>
        `:""}
        
        <div class="risk-date">Created ${Ce(p)}</div>
      </div>
    `;else{const h=n?.owner??"";c.innerHTML=`
      <form id="risk-form" class="risk-form">
        <div class="form-group gm-flex gm-flex-center gm-gap-3 gm-flex-wrap">
          <label for="risk-description" class="gm-mb-0">Risk Description *</label>
          <button type="button" class="btn btn-secondary btn-sm" id="risk-ai-suggest-btn" title="Suggest owner and mitigation from description">‚ú® AI suggest</button>
        </div>
        <div class="form-group">
          <textarea id="risk-description" rows="3" required 
                    placeholder="Describe the risk...">${l}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="risk-impact">Impact</label>
            <select id="risk-impact">
              <option value="low" ${n?.impact==="low"?"selected":""}>Low</option>
              <option value="medium" ${n?.impact==="medium"||!n?"selected":""}>Medium</option>
              <option value="high" ${n?.impact==="high"?"selected":""}>High</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="risk-probability">Probability</label>
            <select id="risk-probability">
              <option value="low" ${u==="low"?"selected":""}>Low</option>
              <option value="medium" ${u==="medium"?"selected":""}>Medium</option>
              <option value="high" ${u==="high"?"selected":""}>High</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="risk-status">Status</label>
          <select id="risk-status">
            <option value="open" ${n?.status==="open"||!n?"selected":""}>Open</option>
            <option value="mitigating" ${n?.status==="mitigating"?"selected":""}>Mitigating</option>
            <option value="mitigated" ${n?.status==="mitigated"?"selected":""}>Mitigated</option>
            <option value="accepted" ${n?.status==="accepted"?"selected":""}>Accepted</option>
            <option value="closed" ${n?.status==="closed"?"selected":""}>Closed</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="risk-owner">Owner</label>
          <input type="text" id="risk-owner" class="form-input" placeholder="Who owns this risk?" value="${Vr(h)}">
        </div>
        
        <div class="form-group">
          <label for="risk-mitigation">Mitigation Strategy</label>
          <textarea id="risk-mitigation" rows="3" 
                    placeholder="How will this risk be mitigated?">${n?.mitigation||""}</textarea>
        </div>
      </form>
    `;const k=c.querySelector("#risk-ai-suggest-btn");k&&d(k,"click",async()=>{const C=c.querySelector("#risk-description"),x=c.querySelector("#risk-impact"),$=c.querySelector("#risk-probability"),w=C?.value?.trim()||"";if(!w){m.error("Enter a risk description first");return}k.disabled=!0,k.textContent="‚Ä¶";try{const y=await jt.suggest({content:w,impact:x?.value||"medium",likelihood:$?.value||"medium"}),S=c.querySelector("#risk-owner"),P=c.querySelector("#risk-mitigation");S&&y.suggested_owner&&(S.value=y.suggested_owner),P&&y.suggested_mitigation&&(P.value=y.suggested_mitigation),m.success("Owner and mitigation suggested")}catch(y){m.error(y.message||"AI suggest failed")}finally{k.disabled=!1,k.textContent="‚ú® AI suggest"}})}const g=b("div",{className:"modal-footer"});if(i){const h=b("button",{className:"btn btn-primary",textContent:"Edit"}),k=b("button",{className:"btn btn-secondary",textContent:"Close"});d(k,"click",()=>K(rs)),d(h,"click",()=>{K(rs),Ba({...e,mode:"edit"})}),g.appendChild(k),g.appendChild(h)}else{const h=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),k=b("button",{className:"btn btn-primary",textContent:o?"Save Changes":"Create Risk"});if(d(h,"click",()=>K(rs)),d(k,"click",async()=>{const C=c.querySelector("#risk-form");if(!C.checkValidity()){C.reportValidity();return}const x=S=>c.querySelector(`#${S}`)?.value.trim()||"",$=x("risk-description"),w=x("risk-owner")||void 0,y={id:n?.id||`risk-${Date.now()}`,description:$,content:$,impact:x("risk-impact"),probability:x("risk-probability"),likelihood:x("risk-probability"),status:x("risk-status"),mitigation:x("risk-mitigation")||void 0,owner:w,createdAt:n?.createdAt??n?.created_at??new Date().toISOString()};k.disabled=!0,k.textContent="Saving...";try{if(o)await v.put(`/api/risks/${n.id}`,{content:y.content??y.description,impact:y.impact,likelihood:y.likelihood??y.probability,mitigation:y.mitigation,status:y.status,owner:y.owner}),m.success("Risk updated");else{const S=await v.post("/api/risks",{content:y.content??y.description,impact:y.impact,likelihood:y.likelihood??y.probability,mitigation:y.mitigation,status:y.status,owner:y.owner}),P=S.data.risk;P?y.id=P.id:y.id=S.data.id,m.success("Risk created")}s?.({...y,description:y.description??y.content,content:y.content??y.description}),K(rs)}catch{}finally{k.disabled=!1,k.textContent=o?"Save Changes":"Create Risk"}}),o){const C=b("button",{className:"btn btn-danger",textContent:"Delete"});d(C,"click",async()=>{const{confirm:x}=await xe(async()=>{const{confirm:w}=await Promise.resolve().then(()=>In);return{confirm:w}},void 0);if(await x("Are you sure you want to delete this risk?",{title:"Delete Risk",confirmText:"Delete",confirmClass:"btn-danger"}))try{await v.delete(`/api/risks/${n.id}`),m.success("Risk deleted"),a?.(String(n.id)),K(rs)}catch{}}),g.appendChild(k),g.appendChild(h),g.appendChild(C)}else g.appendChild(k),g.appendChild(h)}const f=Pe({id:rs,title:i?"Risk Details":o?"Edit Risk":"New Risk",content:c,size:"md",footer:g});document.body.appendChild(f),De(rs)}function Vr(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Me(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function yu(e){if(!e)return"‚Äî";try{return Ts(e)}catch{return e}}function wu(e){return e>=70?"var(--success, #4ecdc4)":e>=50?"var(--warning, #ffe66d)":"var(--text-muted, #6a6a8a)"}function Sn(e){return e.trim().split(/\s+/).map(t=>t[0]).join("").toUpperCase().substring(0,2)}function EC(e){return{created:"üìù",updated:"‚úèÔ∏è",deleted:"üóëÔ∏è",restored:"‚Ü©Ô∏è"}[e]||"‚Ä¢"}function qC(e){const t=e.event_data||{},n=e.actor_name?` by ${e.actor_name}`:"";switch(e.event_type){case"created":return`Created${n}`;case"updated":{const s=t.changes||[];if(s.length===0)return`Updated${n}`;if(s.length===1){const a=s[0],o=String(a.to).trim()?a.to:"‚Äî",i=String(a.from).trim()?a.from:"‚Äî";return`${a.field} changed: ${i} ‚Üí ${o}${n}`}return`${s.map(a=>`${a.field}: ${a.from||"‚Äî"} ‚Üí ${a.to||"‚Äî"}`).join("; ")}${n}`}case"deleted":return`Deleted${t.reason?` (${t.reason})`:""}${n}`;case"restored":return`Restored${n}`;default:return e.event_type}}function Il(e){const{risk:t,onClose:n,onUpdate:s}=e,a=b("div",{className:"risk-detail-view question-detail-view"});a.innerHTML=`
    <div class="question-detail-header risk-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Risks</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Risk #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        <span class="status-badge status-${(t.status||"open").toLowerCase()}">${Me(String(t.status))}</span>
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content risk-detail-content">
      <div id="risk-view-content">
      <section class="detail-section risk-main">
        <div class="question-badges risk-badges">
          ${t.impact?`<span class="priority-pill impact-${t.impact}">${Me(t.impact)} impact</span>`:""}
          ${t.likelihood?`<span class="priority-pill likelihood-${t.likelihood}">${Me(t.likelihood)} likelihood</span>`:""}
          ${t.generation_source?`<span class="status-pill">${Me(t.generation_source)}</span>`:""}
          <span class="question-date risk-date">Created ${Ce(t.created_at)}</span>
        </div>
        <h2 class="question-text risk-content-text">${Me(t.content)}</h2>
      </section>

      <div class="detail-columns">
        <div class="detail-column-left">
          <!-- Assignment (Owner) Section - SOTA (aligned with Questions) -->
          <section class="detail-section" id="risk-assignment-section">
            <div class="section-header-sota">
              <h3>
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Assignment
                <span class="section-subtitle">Who should own this risk?</span>
              </h3>
              <button type="button" class="btn-ai-suggest" id="risk-ai-suggest-btn" title="Suggest owner and mitigation from risk content">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Suggest
              </button>
            </div>

            <!-- Current Assignment (Owner) Display -->
            <div id="risk-current-assignment" class="current-assignment-card">
              ${t.owner?`
                <div class="assigned-contact-display">
                  <div class="contact-avatar-lg" id="risk-assigned-avatar">${Sn(t.owner)}</div>
                  <div class="contact-details">
                    <div class="contact-name-lg">${Me(t.owner)}</div>
                    <div class="contact-role-sm" id="risk-assigned-role">‚Äî</div>
                  </div>
                  <button class="btn-change-assignment" id="risk-change-owner-btn" type="button">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    Change
                  </button>
                </div>
              `:`
                <div class="no-assignment">
                  <div class="no-assignment-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  </div>
                  <span>No one assigned</span>
                  <p class="no-assignment-hint">Use AI Suggest or choose manually</p>
                  <button class="btn-assign-now" id="risk-show-picker-btn" type="button">Choose Manually</button>
                </div>
              `}
            </div>

            <!-- Contact Picker (hidden by default) -->
            <div id="risk-contact-picker" class="contact-picker-sota hidden">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="risk-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="risk-contact-list" class="contact-list-grid">Loading...</div>
            </div>

            <!-- AI Suggestions Panel -->
            <div id="risk-suggestions-panel" class="suggestions-panel-sota risk-suggestions-panel hidden"></div>

            <!-- Mitigation (below assignment) -->
            <div class="risk-mitigation-block">
              <strong>Mitigation</strong>
              <p id="risk-detail-mitigation" class="risk-mitigation">${t.mitigation?Me(t.mitigation):'<span class="text-muted">No mitigation recorded</span>'}</p>
            </div>
          </section>

          <section class="detail-section">
            <div class="section-header">
              <h3>Source</h3>
            </div>
            ${t.source_file?`<p class="source-file">${Me(t.source_file)}</p>`:""}
            ${t.source_document_id?`
              <p class="source-doc">
                <a href="#" class="doc-link" data-document-id="${Me(String(t.source_document_id))}">View source document</a>
              </p>
            `:""}
            ${!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
          </section>
        </div>

        <div class="detail-column-right">
          <section class="detail-section metadata-section">
            <h3>Metadata</h3>
            <dl class="metadata-list">
              <dt>Created</dt>
              <dd>${yu(t.created_at)}</dd>
              ${t.updated_at?`<dt>Updated</dt><dd>${yu(t.updated_at)}</dd>`:""}
            </dl>
          </section>

          <section class="detail-section" id="risk-timeline-section">
            <h3>Timeline</h3>
            <div id="timeline-content" class="timeline-content">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>
        </div>
      </div>

      <div class="detail-actions">
        <button type="button" class="btn btn-secondary" id="edit-risk-btn">Edit</button>
        <button type="button" class="btn btn-danger" id="delete-risk-btn">Delete</button>
      </div>
      </div>

      <div id="risk-edit-form" class="risk-detail-edit-form hidden">
        <form id="risk-inline-form" class="risk-form">
          <div class="form-group">
            <div class="gm-flex gm-flex-center gm-justify-between gm-flex-wrap gm-gap-2 gm-mb-2">
              <label for="risk-edit-content" class="gm-mb-0">Risk description *</label>
              <button type="button" class="btn-ai-suggest btn-sm" id="risk-edit-ai-suggest-btn" title="Suggest owner and mitigation from description">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI suggest
              </button>
            </div>
            <textarea id="risk-edit-content" rows="3" required placeholder="Describe the risk...">${Me(t.content||"")}</textarea>
          </div>
          <div id="risk-edit-suggestions-panel" class="suggestions-panel-sota risk-suggestions-panel hidden gm-mb-4"></div>
          <div class="form-row">
            <div class="form-group">
              <label for="risk-edit-impact">Impact</label>
              <select id="risk-edit-impact">
                <option value="low" ${t.impact==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.impact==="medium"||!t.impact?"selected":""}>Medium</option>
                <option value="high" ${t.impact==="high"?"selected":""}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="risk-edit-likelihood">Likelihood</label>
              <select id="risk-edit-likelihood">
                <option value="low" ${t.likelihood==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.likelihood==="medium"||!t.likelihood?"selected":""}>Medium</option>
                <option value="high" ${t.likelihood==="high"?"selected":""}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="risk-edit-status">Status</label>
              <select id="risk-edit-status">
                <option value="open" ${t.status==="open"||!t.status?"selected":""}>Open</option>
                <option value="mitigating" ${t.status==="mitigating"?"selected":""}>Mitigating</option>
                <option value="mitigated" ${t.status==="mitigated"?"selected":""}>Mitigated</option>
                <option value="accepted" ${t.status==="accepted"?"selected":""}>Accepted</option>
                <option value="closed" ${t.status==="closed"?"selected":""}>Closed</option>
              </select>
            </div>
          </div>
          <div class="form-group risk-owner-picker-wrap">
            <label>Owner</label>
            <input type="hidden" id="risk-edit-owner" value="${Me(t.owner||"")}">
            <div class="risk-owner-picker-trigger" id="risk-owner-picker-trigger" title="Click to select from project contacts">
              <span class="risk-owner-picker-value" id="risk-owner-picker-value">${t.owner?Me(t.owner):'<span class="text-muted">Select owner...</span>'}</span>
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
            <div id="risk-owner-picker-dropdown" class="risk-owner-picker-dropdown hidden">
              <div class="risk-owner-picker-search">
                <input type="text" id="risk-owner-picker-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="risk-owner-picker-list" class="risk-owner-picker-list">Loading...</div>
            </div>
          </div>
          <div class="form-group">
            <label for="risk-edit-mitigation">Mitigation strategy</label>
            <textarea id="risk-edit-mitigation" rows="3" placeholder="How will this risk be mitigated?">${Me(t.mitigation||"")}</textarea>
          </div>
        </form>
        <div class="detail-actions">
          <button type="button" class="btn btn-primary" id="risk-save-btn">Save</button>
          <button type="button" class="btn btn-secondary" id="risk-cancel-edit-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="risk-delete-in-edit-btn">Delete</button>
        </div>
      </div>
    </div>
  `;const o=a.querySelector("#back-to-list");o&&d(o,"click",te=>{te.preventDefault(),n()});const i=a.querySelector("#close-detail");i&&d(i,"click",n);const r=a.querySelector("#risk-view-content"),c=a.querySelector("#risk-edit-form"),l=a.querySelector("#edit-risk-btn");l&&r&&c&&d(l,"click",()=>{r.classList.add("hidden"),c.classList.remove("hidden")});const u=a.querySelector("#risk-cancel-edit-btn");u&&r&&c&&d(u,"click",()=>{c.classList.add("hidden"),r.classList.remove("hidden")});const p=a.querySelector("#risk-save-btn");p&&c&&s&&d(p,"click",async()=>{const te=a.querySelector("#risk-inline-form");if(!te?.checkValidity()){te.reportValidity();return}const ne=a.querySelector("#risk-edit-content"),T=a.querySelector("#risk-edit-impact"),_=a.querySelector("#risk-edit-likelihood"),A=a.querySelector("#risk-edit-status"),E=a.querySelector("#risk-edit-owner"),U=a.querySelector("#risk-edit-mitigation"),M=ne?.value?.trim()||"";if(!M){m.error("Risk description is required");return}p.disabled=!0,p.textContent="Saving...";try{const z=await jt.update(t.id,{content:M,impact:T?.value||"medium",likelihood:_?.value||"medium",status:A?.value||"open",owner:E?.value?.trim()||void 0,mitigation:U?.value?.trim()||void 0});m.success("Risk updated"),s(z)}catch{m.error("Failed to save")}finally{p.disabled=!1,p.textContent="Save"}});const g=a.querySelector("#risk-delete-in-edit-btn");g&&d(g,"click",async()=>{if(confirm("Are you sure you want to delete this risk?"))try{await jt.delete(t.id),m.success("Risk deleted"),n()}catch{m.error("Failed to delete")}});const f=a.querySelector("#risk-owner-picker-trigger"),h=a.querySelector("#risk-owner-picker-dropdown"),k=a.querySelector("#risk-owner-picker-value"),C=a.querySelector("#risk-edit-owner"),x=a.querySelector("#risk-owner-picker-list"),$=a.querySelector("#risk-owner-picker-search");if(f&&h&&x&&C){let te=[];const ne=(T="")=>{const _=T?te.filter(A=>(A.name||"").toLowerCase().includes(T.toLowerCase())||(A.role||"").toLowerCase().includes(T.toLowerCase())):te;if(te.length===0){x.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(_.length===0){x.innerHTML='<div class="empty-state">No contacts match</div>';return}x.innerHTML=_.map(A=>{const E=A.photoUrl||A.avatarUrl;return`
            <div class="risk-owner-card-picker ${(C?.value||"").trim()===(A.name||"").trim()?"selected":""}" data-contact-name="${Me(A.name||"")}">
              <div class="risk-owner-card-avatar">${E?`<img src="${Me(E)}" alt="" onerror="this.parentElement.innerHTML='${Sn(A.name||"")}'">`:Sn(A.name||"")}</div>
              <div class="risk-owner-card-info">
                <div class="risk-owner-card-name">${Me(A.name||"")}</div>
                ${A.role?`<div class="risk-owner-card-role">${Me(A.role)}</div>`:""}
              </div>
            </div>
          `}).join(""),x.querySelectorAll(".risk-owner-card-picker").forEach(A=>{d(A,"click",()=>{const E=A.getAttribute("data-contact-name")||"";C.value=E,k&&(k.innerHTML=E?Me(E):'<span class="text-muted">Select owner...</span>'),h.classList.add("hidden")})})};d(f,"click",async T=>{T.stopPropagation();const _=!h.classList.contains("hidden");if(h.classList.toggle("hidden",_),!_&&te.length===0){x.innerHTML='<div class="empty-state">Loading...</div>';try{te=(await Ne.getAll())?.contacts||[],ne($?.value||"")}catch{x.innerHTML='<div class="empty-state">Failed to load contacts</div>'}}else _||ne($?.value||"")}),$&&$.addEventListener("input",()=>ne($.value)),document.addEventListener("click",T=>{!T.target.closest(".risk-owner-picker-wrap")&&!h?.classList.contains("hidden")&&h.classList.add("hidden")})}const w=a.querySelector("#risk-edit-ai-suggest-btn"),y=a.querySelector("#risk-edit-suggestions-panel");w&&y&&d(w,"click",async()=>{const ne=a.querySelector("#risk-edit-content")?.value?.trim()||"";if(!ne){m.error("Enter a risk description first");return}const T=w;T.disabled=!0,T.innerHTML='<span class="spin">‚ãØ</span> Analyzing...',y.classList.remove("hidden"),y.innerHTML='<div class="suggestions-loading"><div class="loading-text">AI is suggesting owners and mitigation...</div></div>';try{const[_,A]=await Promise.all([jt.suggest({content:ne,impact:a.querySelector("#risk-edit-impact")?.value||"medium",likelihood:a.querySelector("#risk-edit-likelihood")?.value||"medium"}),Ne.getAll()]),E=A?.contacts||[],U=_.suggested_owners?.length?_.suggested_owners:_.suggested_owner?[{name:_.suggested_owner,reason:"",score:0}]:[],M=_.suggested_mitigation||"";if(U.length===0&&!M)y.innerHTML='<div class="no-suggestions"><div class="no-suggestions-text">No suggestions</div><button type="button" class="btn-link" id="risk-edit-hide-suggest-btn">Close</button></div>';else{y.innerHTML=`
            <div class="suggestions-header-sota"><div class="ai-badge">‚ú® AI Recommended</div></div>
            ${U.length>0?`<div class="suggestions-list-sota">${U.map((I,X)=>{const se=E.find(Oe=>(Oe.name||"").trim().toLowerCase()===(I.name||"").trim().toLowerCase()),Se=se?.photoUrl||se?.avatarUrl||se?.photo_url||se?.avatar_url,fe=se?.role??I.reason??"",we=I.score??0,Te=wu(we);return`<div class="suggestion-card-sota risk-owner-card" data-owner-name="${Me(I.name||"")}">
                <div class="suggestion-rank">#${X+1}</div>
                <div class="suggestion-avatar-sota">${Se?`<img src="${Me(Se)}" alt="" onerror="this.parentElement.innerHTML='${Sn(I.name)}'">`:Sn(I.name)}</div>
                <div class="suggestion-info-sota"><div class="suggestion-name-sota">${Me(I.name||"")}</div>${fe?`<div class="suggestion-reason-sota">${Me(fe)}</div>`:""}</div>
                ${we>0?`<div class="suggestion-score-sota" style="--score-color: ${Te}"><div class="score-value">${we}%</div></div>`:""}
                <button type="button" class="btn-select-suggestion">Assign</button>
              </div>`}).join("")}</div>`:""}
            ${M?`<div class="risk-suggestion-card risk-mitigation-suggestion"><strong>Suggested mitigation</strong><p class="risk-suggestion-mitigation">${Me(M)}</p><button type="button" class="btn btn-secondary btn-sm" id="risk-edit-apply-mitigation-btn">Apply mitigation</button></div>`:""}
            <div class="suggestions-footer"><button type="button" class="btn-link" id="risk-edit-hide-suggest-btn">Close suggestions</button></div>
          `,y.querySelectorAll(".risk-owner-card .btn-select-suggestion").forEach(I=>{const se=I.closest(".risk-owner-card")?.getAttribute("data-owner-name")||"";se&&d(I,"click",()=>{C&&(C.value=se),k&&(k.innerHTML=Me(se)),y.classList.add("hidden"),m.success(`Owner set to ${se}`)})});const q=y.querySelector("#risk-edit-apply-mitigation-btn");q&&M&&d(q,"click",()=>{const I=a.querySelector("#risk-edit-mitigation");I&&(I.value=M),m.success("Mitigation applied")})}const z=y.querySelector("#risk-edit-hide-suggest-btn");z&&d(z,"click",()=>{y.classList.add("hidden")})}catch{y.innerHTML='<div class="suggestions-error">Failed to get suggestions. <button type="button" class="btn-link" id="risk-edit-hide-suggest-btn">Close</button></div>';const _=y.querySelector("#risk-edit-hide-suggest-btn");_&&d(_,"click",()=>{y.classList.add("hidden")})}finally{T.disabled=!1,T.innerHTML='<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> AI suggest'}});const S=a.querySelector("#delete-risk-btn");S&&d(S,"click",async()=>{if(confirm("Are you sure you want to delete this risk?"))try{await jt.delete(t.id),m.success("Risk deleted"),n()}catch{m.error("Failed to delete risk")}});let P="";const j=a.querySelector("#risk-ai-suggest-btn"),H=a.querySelector("#risk-suggestions-panel");j&&H&&d(j,"click",async()=>{const te=j;te.disabled=!0,te.innerHTML=`
        <svg class="spin" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Analyzing...
      `,H.classList.remove("hidden"),H.innerHTML=`
        <div class="suggestions-loading">
          <div class="ai-thinking-animation"><span></span><span></span><span></span></div>
          <div class="loading-text">AI is suggesting owners and mitigation...</div>
        </div>
      `;try{const[ne,T]=await Promise.all([jt.suggest({content:t.content||"",impact:t.impact||"medium",likelihood:t.likelihood||"medium"}),Ne.getAll()]),_=T?.contacts||[];P=ne.suggested_mitigation||"";const A=ne.suggested_owners?.length?ne.suggested_owners:ne.suggested_owner?[{name:ne.suggested_owner,reason:"",score:0}]:[];if(A.length===0&&!P)H.innerHTML=`
            <div class="no-suggestions">
              <div class="no-suggestions-text">No owner or mitigation suggestions</div>
              <button type="button" class="btn-link" id="risk-hide-suggestions-btn">Close</button>
            </div>
          `;else{H.innerHTML=`
            <div class="suggestions-header-sota">
              <div class="ai-badge">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                AI Recommended
              </div>
            </div>
            ${A.length>0?`
            <div class="suggestions-list-sota">
              ${A.map((M,z)=>{const q=M.score??0,I=wu(q),X=_.find(fe=>(fe.name||"").trim().toLowerCase()===(M.name||"").trim().toLowerCase()),se=X?.photoUrl||X?.avatarUrl||X?.photo_url||X?.avatar_url,Se=X?.role??M.reason??"";return`
                  <div class="suggestion-card-sota risk-owner-card" data-index="${z}">
                    <div class="suggestion-rank">#${z+1}</div>
                    <div class="suggestion-avatar-sota">${se?`<img src="${Me(se)}" alt="${Me(M.name)}" onerror="this.parentElement.innerHTML='${Sn(M.name)}'">`:Sn(M.name)}</div>
                    <div class="suggestion-info-sota">
                      <div class="suggestion-name-sota">${Me(M.name)}</div>
                      ${Se?`<div class="suggestion-reason-sota">${Me(Se)}</div>`:""}
                    </div>
                    ${q>0?`
                    <div class="suggestion-score-sota" style="--score-color: ${I}">
                      <div class="score-ring">
                        <svg viewBox="0 0 36 36">
                          <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                          <path class="score-fill" stroke-dasharray="${q}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <div class="score-value">${q}%</div>
                      </div>
                      <div class="score-label">Match</div>
                    </div>
                    `:""}
                    <button type="button" class="btn-select-suggestion">
                      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      Assign
                    </button>
                  </div>
                `}).join("")}
            </div>
            `:""}
            ${P?`
            <div class="risk-suggestion-card risk-mitigation-suggestion">
              <strong>Suggested mitigation</strong>
              <p class="risk-suggestion-mitigation">${Me(P)}</p>
              <button type="button" class="btn btn-secondary btn-sm" id="risk-apply-mitigation-btn">Apply mitigation</button>
            </div>
            `:""}
            <div class="suggestions-footer">
              <button type="button" class="btn-link" id="risk-hide-suggestions-btn">Close suggestions</button>
            </div>
          `,H.querySelectorAll(".risk-owner-card").forEach(M=>{const z=M.querySelector(".btn-select-suggestion");if(!z)return;const q=parseInt(M.getAttribute("data-index")||"0"),I=A[q];!I||!s||d(z,"click",async X=>{X.stopPropagation();try{const se=await jt.update(t.id,{owner:I.name});H.classList.add("hidden"),s(se),m.success(`Assigned to ${I.name}`)}catch{m.error("Failed to save")}})});const U=H.querySelector("#risk-apply-mitigation-btn");U&&P&&s&&d(U,"click",async()=>{try{const M=await jt.update(t.id,{mitigation:P}),z=a.querySelector("#risk-detail-mitigation");z&&(z.innerHTML=Me(P)),s(M),m.success("Mitigation updated")}catch{m.error("Failed to save")}})}const E=H.querySelector("#risk-hide-suggestions-btn");E&&d(E,"click",()=>{H.classList.add("hidden")})}catch{H.innerHTML=`
          <div class="suggestions-error">
            <div>Failed to get AI suggestions</div>
            <button type="button" class="btn-retry" id="risk-retry-suggest-btn">Try again</button>
          </div>
        `;const ne=H.querySelector("#risk-retry-suggest-btn");ne&&d(ne,"click",()=>j.click())}finally{te.disabled=!1,te.innerHTML=`
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          AI suggest
        `}});const J=a.querySelector(".doc-link");J&&t.source_document_id&&d(J,"click",te=>{te.preventDefault(),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:t.source_document_id}}))});const B=a.querySelector("#timeline-content");B&&jt.getEvents(t.id).then(te=>{if(te.length===0){B.innerHTML='<p class="empty-state">No events recorded</p>';return}const ne=te.map(T=>{const _=EC(T.event_type),A=qC(T);return`
          <div class="timeline-item risk-event-${Me(T.event_type)}">
            <div class="timeline-icon">${_}</div>
            <div class="timeline-content">
              <div class="timeline-title">${Me(A)}</div>
              <div class="timeline-date">${Ts(T.created_at)}</div>
            </div>
          </div>`}).join("");B.innerHTML=`<div class="timeline-list">${ne}</div>`}).catch(()=>{B.innerHTML='<p class="error">Failed to load timeline</p>'});let Z=[];const O=t.owner||"",F=a.querySelector("#risk-contact-picker"),ee=a.querySelector("#risk-contact-list"),ie=a.querySelector("#risk-contact-search"),oe=(te="")=>{if(!ee)return;const ne=te?Z.filter(T=>(T.name||"").toLowerCase().includes(te.toLowerCase())||(T.role||"").toLowerCase().includes(te.toLowerCase())||(T.organization||"").toLowerCase().includes(te.toLowerCase())):Z;if(Z.length===0){ee.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(ne.length===0){ee.innerHTML='<div class="empty-state">No contacts match</div>';return}ee.innerHTML=ne.map(T=>{const _=le(T);return`
          <div class="contact-card-picker ${(O||"").trim()===(T.name||"").trim()?"selected":""}" data-contact-name="${Me(T.name||"")}">
            <div class="contact-avatar-picker">${_?`<img src="${Me(_)}" alt="" onerror="this.parentElement.innerHTML='${Sn(T.name||"")}'">`:Sn(T.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${Me(T.name||"")}</div>
              ${T.role?`<div class="contact-role-picker">${Me(T.role)}</div>`:""}
            </div>
          </div>`}).join(""),ee.querySelectorAll(".contact-card-picker").forEach(T=>{d(T,"click",async()=>{const _=T.getAttribute("data-contact-name")||"";if(_)try{const A=await jt.update(t.id,{owner:_});m.success(`Owner set to ${_}`),F&&F.classList.add("hidden"),s?.(A)}catch{m.error("Failed to save")}})})},me=()=>{if(!F)return;const te=F.classList.contains("hidden");F.classList.toggle("hidden",te),te&&Z.length===0?Ne.getAll().then(ne=>{Z=ne?.contacts||[],oe(ie?.value||"")}).catch(()=>{ee&&(ee.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):te&&oe(ie?.value||""),ie&&ie.focus()},ze=a.querySelector("#risk-change-owner-btn"),re=a.querySelector("#risk-show-picker-btn");ze&&F&&d(ze,"click",me),re&&F&&d(re,"click",me),ie&&ie.addEventListener("input",()=>oe(ie.value));function Le(te){if(!te||!Z.length)return;const ne=te.trim().toLowerCase();if(!ne)return;const T=Z.find(E=>(E.name||"").trim().toLowerCase()===ne);if(T)return T;const _=Z.find(E=>(E.name||"").trim().toLowerCase().includes(ne)||ne.includes((E.name||"").trim().toLowerCase()));if(_)return _;const A=Z.find(E=>(E.aliases||[]).some(U=>String(U).trim().toLowerCase()===ne));return A||Z.find(E=>(E.aliases||[]).some(U=>{const M=String(U).trim().toLowerCase();return M.includes(ne)||ne.includes(M)}))}function le(te){if(!te)return null;const ne=te;return ne.photoUrl||ne.avatarUrl||ne.photo_url||ne.avatar_url||null}return Ne.getAll().then(te=>{Z=te?.contacts||[];const ne=Le(O),T=a.querySelector("#risk-assigned-role");T&&(T.textContent=ne?.role??"‚Äî");const _=a.querySelector("#risk-assigned-avatar");if(_&&O){const A=le(ne);if(A){_.innerHTML="";const E=document.createElement("img");E.src=A,E.alt="",E.onerror=()=>{_.textContent=Sn(O)},_.appendChild(E)}}}).catch(()=>{}),a}const jC=Object.freeze(Object.defineProperty({__proto__:null,createRiskDetailView:Il},Symbol.toStringTag,{value:"Module"}));function vg(e,t,n){return{risk:n,onClose:()=>{e.innerHTML="",e.appendChild(Io(t))},onUpdate:s=>{e.innerHTML="",s?e.appendChild(Il(vg(e,t,s))):e.appendChild(Io(t))}}}let mi="all",yr="",fg="status",na=!1,zc=[];function Io(e={}){const t=b("div",{className:"sot-panel risks-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Risks</h2>
        <span class="panel-count" id="risks-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="risks-filter" class="filter-select">
          <option value="all">All</option>
          <option value="open">Open</option>
          <option value="mitigating">Mitigating</option>
          <option value="mitigated">Mitigated</option>
          <option value="high">High Impact</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="status">By Status</button>
          <button class="view-tab" data-view="source">By Source</button>
        </div>
        <input type="search" id="risks-search" class="search-input" placeholder="Search risks..." title="Search">
        <button class="btn btn-secondary btn-sm" id="toggle-matrix-btn">Show Matrix</button>
        <button class="btn btn-primary btn-sm" id="add-risk-btn">+ Add</button>
      </div>
    </div>
    <div id="risk-matrix-container" class="risk-matrix-container hidden"></div>
    <div class="panel-content" id="risks-content">
      <div class="loading">Loading risks...</div>
    </div>
    <div id="removed-risks-container" class="removed-risks-container hidden"></div>
  `;const n=t.querySelector("#risks-filter");d(n,"change",()=>{mi=n.value,Qn(t,e)});const s=t.querySelectorAll(".view-tab");s.forEach(c=>{d(c,"click",()=>{s.forEach(l=>l.classList.remove("active")),c.classList.add("active"),fg=c.getAttribute("data-view"),Qn(t,e)})});const a=t.querySelector("#risks-search");let o;d(a,"input",()=>{clearTimeout(o),o=window.setTimeout(()=>{yr=a.value.trim(),Qn(t,e)},300)});const i=t.querySelector("#toggle-matrix-btn");d(i,"click",()=>{na=!na,i.textContent=na?"Hide Matrix":"Show Matrix";const c=t.querySelector("#risk-matrix-container");if(c.classList.toggle("hidden",!na),na){const l=zc.length>0?zc:ce.getState().risks||[];bg(c,Array.isArray(l)?l:[])}});const r=t.querySelector("#add-risk-btn");return r&&d(r,"click",()=>{Ba({mode:"create",onSave:()=>{Qn(t,e),Ic(t,e)}})}),Qn(t,e),Ic(t,e),t}async function Ic(e,t){const n=e.querySelector("#removed-risks-container");if(n)try{const s=await jt.getDeleted();if(s.length===0){n.classList.add("hidden"),n.innerHTML="";return}n.classList.remove("hidden"),n.innerHTML=`
      <div class="removed-risks-section">
        <div class="removed-risks-header section-header-sota">
          <h3>Removed risks</h3>
          <span class="panel-count removed-count">${s.length}</span>
        </div>
        <p class="removed-risks-hint">Restore to bring the risk back; it will be synced to the graph.</p>
        <div class="removed-risks-list">
          ${s.map(a=>`
            <div class="removed-risk-item" data-risk-id="${a.id}">
              <div class="removed-risk-content">${Gt(Hc(a.content??"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(a=>{d(a,"click",async()=>{const o=a.closest(".removed-risk-item")?.getAttribute("data-risk-id");if(o)try{await jt.restore(o),m.success("Risk restored"),Qn(e,t),Ic(e,t)}catch{m.error("Failed to restore risk")}})})}catch{n.classList.add("hidden"),n.innerHTML=""}}function Hc(e,t){return e.length<=t?e:e.substring(0,t)+"‚Ä¶"}function PC(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(s=>(s.content||"").toLowerCase().includes(n)||(s.mitigation||"").toLowerCase().includes(n)||(s.owner||"").toLowerCase().includes(n)||(s.source_file||"").toLowerCase().includes(n))}async function Qn(e,t){const n=e.querySelector("#risks-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=mi==="all"||mi==="high"?void 0:mi;let a=await jt.getAll(s);if(mi==="high"&&(a=a.filter(o=>o.impact==="high"||o.impact==="critical")),a=PC(a,yr),fg==="source"?zC(n,a,t):DC(n,a,t),zc=a,ce.setRisks(a),BC(e,a.length),na){const o=e.querySelector("#risk-matrix-container");bg(o,a)}}catch{n.innerHTML='<div class="error">Failed to load risks</div>'}}function DC(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${yr?"No risks match your search":"No risks found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Risk</button>
      </div>
    `;const i=e.querySelector("#empty-add-btn");i&&d(i,"click",()=>{Ba({mode:"create",onSave:()=>Qn(e.closest(".risks-panel"),n)})});return}const s=ce.getState().contacts||[],a={};t.forEach(i=>{const r=(i.status||"open").toLowerCase();a[r]||(a[r]=[]),a[r].push(i)});const o=Object.keys(a);o.length>1?e.innerHTML=o.map(i=>`
      <div class="question-group">
        <div class="group-header">
          <h3>${Gt(i)}</h3>
          <span class="group-count">${a[i].length}</span>
        </div>
        <div class="group-items">
          ${a[i].map(r=>Bc(r,s)).join("")}
        </div>
      </div>
    `).join(""):e.innerHTML=t.map(i=>Bc(i,s)).join(""),hg(e,t,n)}function zC(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${yr?"No risks match your search":"No risks found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Risk</button>
      </div>
    `;const o=e.querySelector("#empty-add-btn");o&&d(o,"click",()=>{Ba({mode:"create",onSave:()=>Qn(e.closest(".risks-panel"),n)})});return}const s=ce.getState().contacts||[],a={};t.forEach(o=>{const i=o.source_file||"Unknown source";a[i]||(a[i]=[]),a[i].push(o)}),e.innerHTML=Object.entries(a).map(([o,i])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${Gt(o)}</h3>
        <span class="group-count">${i.length}</span>
      </div>
      <div class="group-items">
        ${i.map(r=>Bc(r,s)).join("")}
      </div>
    </div>
  `).join(""),hg(e,t,n)}const ku={critical:"#dc2626",high:"#ea580c",medium:"#ca8a04",low:"#16a34a"};function IC(e,t){if(!t||!e.length)return;const n=t.trim().toLowerCase();if(!n)return;const s=e.find(i=>(i.name||"").trim().toLowerCase()===n);if(s)return s;const a=e.find(i=>(i.name||"").trim().toLowerCase().includes(n)||n.includes((i.name||"").trim().toLowerCase()));return a||e.find(i=>(i.aliases||[]).some(r=>String(r).trim().toLowerCase()===n))||e.find(i=>(i.aliases||[]).some(r=>{const c=String(r).trim().toLowerCase();return c.includes(n)||n.includes(c)}))}function HC(e){return e&&(e.photoUrl||e.avatarUrl||e.photo_url||e.avatar_url)||null}function xu(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Bc(e,t){const n=(e.impact||"medium").toLowerCase(),s=ku[n]??ku.medium,a=e.content||"",o=e.source_file||"",i=e.owner||"",r=i?IC(t,i):void 0,c=HC(r),l=i?`
        <div class="assignee-chip">
          <div class="assignee-avatar">${c?`<img src="${Gt(c)}" alt="${Gt(i)}" onerror="this.parentElement.innerHTML='${xu(i)}'">`:xu(i)}</div>
          <div class="assignee-info">
            <span class="assignee-name">${Gt(i)}</span>
            ${r?.role?`<span class="assignee-role">${Gt(r.role)}</span>`:""}
          </div>
        </div>
      `:'<span class="card-owner-placeholder text-muted">No owner</span>',u=o?`<span class="card-source-chip">${Gt(Hc(o,40))}</span>`:'<span class="card-source-chip text-muted">No source</span>';return`
    <div class="risk-card-sota question-card-sota" data-id="${e.id}" style="--risk-impact-bar: ${s}">
      <div class="card-priority-bar risk-impact-bar"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="priority-pill impact-${n}">${Gt(e.impact||"medium")}</span>
            <span class="status-pill">L: ${Gt(e.likelihood||"medium")}</span>
            <span class="status-pill status-${(e.status||"open").toLowerCase()}">${Gt(e.status||"open")}</span>
          </div>
          <span class="card-timestamp">${Ce(e.created_at)}</span>
        </div>
        <div class="card-question-text">${Gt(a)}</div>
        ${e.mitigation?`<div class="card-mitigation text-muted">${Gt(Hc(e.mitigation,120))}</div>`:""}
        <div class="card-bottom-row">
          <div class="card-requester">
            ${u}
            ${l}
          </div>
          <div class="card-assignment">
            <button type="button" class="btn-link risk-view-link">View</button>
          </div>
        </div>
      </div>
    </div>
  `}function hg(e,t,n){e.querySelectorAll(".risk-card-sota").forEach(s=>{d(s,"click",a=>{if(a.target.closest(".card-actions"))return;const o=s.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);if(i)if(n.useDetailView&&n.containerElement){const r=n.containerElement;r.innerHTML="",r.appendChild(Il(vg(r,n,i)))}else n.onRiskClick?n.onRiskClick(i):Ba({mode:"edit",risk:{...i},onSave:()=>Qn(e.closest(".risks-panel"),n)})})})}function bg(e,t){const n=t.filter(p=>p.status!=="mitigated"&&p.status!=="closed"),s=(p,g)=>{const f=["low","medium","high","critical"].indexOf((p||"").toString().toLowerCase()||"low"),h=["low","medium","high"].indexOf((g||"").toString().toLowerCase()||"low"),k=f+h;return k>=4?"critical":k>=3?"high":k>=2?"medium":"low"},a={critical:0,high:0,medium:0,low:0};n.forEach(p=>{const g=s(p.impact,p.likelihood);a[g]++});const o=n.length,i=t.length-n.length,r=p=>o>0?Math.round(p/o*100):0;let c="",l=0;const u={critical:"#ef4444",high:"#f97316",medium:"#eab308",low:"#22c55e"};["critical","high","medium","low"].forEach(p=>{const f=r(a[p])/100*360;f>0&&(c+=`${u[p]} ${l}deg ${l+f}deg, `,l+=f)}),c?c=c.slice(0,-2):c="var(--color-border) 0deg 360deg",e.innerHTML=`
    <div class="risk-summary">
      <div class="risk-summary-header">
        <h4>Risk Overview</h4>
        <span class="risk-total">${o} active</span>
      </div>
      <div class="risk-summary-content">
        <div class="risk-donut-container">
          <div class="risk-donut" style="background: conic-gradient(${c})">
            <div class="risk-donut-center">
              <span class="donut-value">${o}</span>
              <span class="donut-label">Risks</span>
            </div>
          </div>
        </div>
        <div class="risk-bars">
          <div class="risk-bar-item critical">
            <span class="bar-icon">üî¥</span>
            <span class="bar-label">Critical</span>
            <div class="bar-track"><div class="bar-fill" style="--bar-width: ${r(a.critical)}"></div></div>
            <span class="bar-count">${a.critical}</span>
          </div>
          <div class="risk-bar-item high">
            <span class="bar-icon">üü†</span>
            <span class="bar-label">High</span>
            <div class="bar-track"><div class="bar-fill" style="--bar-width: ${r(a.high)}"></div></div>
            <span class="bar-count">${a.high}</span>
          </div>
          <div class="risk-bar-item medium">
            <span class="bar-icon">üü°</span>
            <span class="bar-label">Medium</span>
            <div class="bar-track"><div class="bar-fill" style="--bar-width: ${r(a.medium)}"></div></div>
            <span class="bar-count">${a.medium}</span>
          </div>
          <div class="risk-bar-item low">
            <span class="bar-icon">üü¢</span>
            <span class="bar-label">Low</span>
            <div class="bar-track"><div class="bar-fill" style="--bar-width: ${r(a.low)}"></div></div>
            <span class="bar-count">${a.low}</span>
          </div>
        </div>
      </div>
      ${i>0?`<div class="risk-mitigated"><span class="mitigated-icon">‚úì</span><span>${i} risk${i>1?"s":""} mitigated</span></div>`:""}
    </div>
  `}function BC(e,t){const n=e.querySelector("#risks-count");n&&(n.textContent=String(t))}function Gt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function Xi(){try{return(await v.get("/api/sprints")).data.sprints||[]}catch{return[]}}async function RC(e){try{return(await v.get(`/api/sprints/${e}`)).data.sprint||null}catch{return null}}async function NC(e){return(await v.post("/api/sprints",e)).data.sprint}async function OC(e,t){return(await v.post(`/api/sprints/${e}/generate`,t||{})).data}async function FC(e,t){return(await v.post(`/api/sprints/${e}/apply`,t)).data}async function UC(e){try{return(await v.get(`/api/sprints/${e}/report`)).data??null}catch{return null}}async function VC(e){return(await v.post(`/api/sprints/${e}/report/analyze`,{})).data}async function GC(e){return(await v.post(`/api/sprints/${e}/report/business`,{})).data}async function ZC(e,t){return(await v.post(`/api/sprints/${e}/report/document`,{include_analysis:t?.include_analysis??!1,include_business:t?.include_business??!1,style:t?.style??""})).data}async function WC(e,t){return(await v.post(`/api/sprints/${e}/report/presentation`,{include_analysis:t?.include_analysis??!1,include_business:t?.include_business??!1})).data}const on="action-modal";function Gr(e){return e?.content??e?.task??""}function $u(e){return e?.due_date??e?.dueDate??""}function KC(e){return e?.created_at??e?.createdAt??""}function QC(e){return e?.parent_story_ref??""}function Su(e){return e?.size_estimate??""}function Zr(e){return e?.description??""}function Cu(e){return e?.definition_of_done?e.definition_of_done.map(t=>typeof t=="string"?t:t.text):[]}function _u(e){return Array.isArray(e?.acceptance_criteria)?e.acceptance_criteria:[]}function Ea(e){const{mode:t,action:n,onSave:s,onDelete:a}=e,o=t==="edit"&&n?.id,i=t==="view",r=document.querySelector(`[data-modal-id="${on}"]`);r&&r.remove();const c=b("div",{className:"action-modal-content"});if(i&&n){const p=$u(n),g=p&&new Date(p)<new Date&&n.status!=="completed",f=QC(n),h=Su(n),k=Zr(n),C=Cu(n),x=_u(n);c.innerHTML=`
      <div class="action-view">
        <div class="action-meta">
          <span class="priority-badge priority-${n.priority||"medium"}">${n.priority||"medium"}</span>
          <span class="status-badge ${n.status}">${n.status.replace("_"," ")}</span>
          ${g?'<span class="status-badge overdue">Overdue</span>':""}
        </div>
        
        <div class="action-task-large ${n.status==="completed"?"completed":""}">
          ${Ze(Gr(n))}
        </div>
        
        <div class="action-details">
          ${n.assignee?`<div class="detail-item"><strong>Assignee:</strong> ${Ze(n.assignee)}</div>`:""}
          ${p?`<div class="detail-item"><strong>Due Date:</strong> ${p}</div>`:""}
          ${h?`<div class="detail-item"><strong>Effort:</strong> ${Ze(h)}</div>`:""}
          ${f?`<div class="detail-item"><strong>Parent Story:</strong> ${Ze(f)}</div>`:""}
          ${n.generation_source?`<div class="detail-item"><strong>Source:</strong> ${Ze(n.generation_source)}</div>`:""}
          ${n.sprint_id||n.sprint_name?`<div class="detail-item"><strong>Sprint:</strong> ${Ze(n.sprint_name||n.sprint_id||"")}</div>`:""}
          ${n.task_points!=null?`<div class="detail-item"><strong>Task points:</strong> ${n.task_points}</div>`:""}
          ${n.requested_by||n.requested_by_contact_id?`<div class="detail-item" id="action-view-requester-wrap"><strong>Requested by:</strong> <span id="action-view-requester-card">${Ze(n.requested_by||"")}</span></div>`:""}
          <div class="detail-item"><strong>Created:</strong> ${Ce(KC(n))}</div>
        </div>
        ${k?`<div class="action-description"><strong>Description</strong><p>${Ze(k)}</p></div>`:""}
        ${C.length?`<div class="action-dod"><strong>Definition of Done</strong><ul>${C.map($=>`<li>${Ze($)}</li>`).join("")}</ul></div>`:""}
        ${x.length?`<div class="action-ac"><strong>Acceptance Criteria</strong><ul>${x.map($=>`<li>${Ze($)}</li>`).join("")}</ul></div>`:""}
      </div>
    `}else{const p=Cu(n).join(`
`),g=_u(n).join(`
`);c.innerHTML=`
      <form id="action-form" class="action-form">
        <div class="form-group action-generate-block">
          <label>Generate from description (AI, uses Sprint Board rules)</label>
          <textarea id="action-description-draft" rows="2" placeholder="e.g. Add JWT validation to the API">${o&&n?Ze([Gr(n),Zr(n)].filter(Boolean).join(`

`)):""}</textarea>
          <div class="action-generate-buttons mt-1">
            <button type="button" class="btn btn-secondary btn-sm" id="action-generate-btn">Generate from description</button>
            ${o&&n?'<button type="button" class="btn btn-outline-secondary btn-sm" id="action-regenerate-ai-btn">Regenerate with AI</button>':""}
          </div>
        </div>
        <div class="form-group">
          <label for="action-task">Task (title) *</label>
          <textarea id="action-task" rows="2" required 
                    placeholder="Concrete action e.g. Implementar valida√ß√£o JWT no backend">${Ze(Gr(n))}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="action-parent-story-id">Parent User Story</label>
            <div class="form-row-inline">
              <select id="action-parent-story-id">
                <option value="">‚Äî None ‚Äî</option>
              </select>
              <button type="button" class="btn btn-secondary btn-sm" id="action-new-story-btn">New story</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="action-edit-story-btn" title="Edit selected story (title, story points)">Edit story</button>
            </div>
          </div>
          <div class="form-group">
            <label for="action-size">Size (estimate)</label>
            <input type="text" id="action-size" 
                   value="${Ze(Su(n))}" 
                   placeholder="e.g. 1 day, 8h (max 8h)">
          </div>
        </div>
        <div class="form-group">
          <label for="action-sprint-id">Sprint</label>
          <select id="action-sprint-id">
            <option value="">‚Äî None ‚Äî</option>
          </select>
        </div>
        <div class="form-group">
          <label for="action-task-points">Task points (optional)</label>
          <input type="number" id="action-task-points" min="0" step="1" 
                 value="${n?.task_points!=null?String(n.task_points):""}" 
                 placeholder="e.g. 2">
        </div>
        <div class="form-group">
          <label for="action-depends-on">Depends on (other tasks)</label>
          <select id="action-depends-on" multiple class="form-select-multi">
            <option value="" disabled>Loading...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="action-description">Description (technical)</label>
          <textarea id="action-description" rows="3" 
                    placeholder="Implementation notes">${Ze(Zr(n))}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="action-priority">Priority</label>
            <select id="action-priority">
              <option value="low" ${n?.priority==="low"?"selected":""}>Low</option>
              <option value="medium" ${n?.priority==="medium"||!n?"selected":""}>Medium</option>
              <option value="high" ${n?.priority==="high"?"selected":""}>High</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="action-status">Status</label>
            <select id="action-status">
              <option value="pending" ${n?.status==="pending"||!n?"selected":""}>Pending</option>
              <option value="in_progress" ${n?.status==="in_progress"?"selected":""}>Active (In Progress)</option>
              <option value="completed" ${n?.status==="completed"?"selected":""}>Completed</option>
              <option value="cancelled" ${n?.status==="cancelled"?"selected":""}>Cancelled</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="action-assignee">Assignee</label>
            <input type="text" id="action-assignee" 
                   value="${Ze(n?.assignee??n?.owner??"")}" 
                   placeholder="Who is responsible?">
          </div>
          
          <div class="form-group">
            <label for="action-due">Due Date</label>
            <input type="date" id="action-due" 
                   value="${$u(n)}">
          </div>
        </div>
        
        <div class="form-group action-requester-picker-wrap">
          <label>Requested by (optional)</label>
          <input type="hidden" id="action-requested-by-contact-id" value="${Ze(n?.requested_by_contact_id??"")}">
          <input type="hidden" id="action-requested-by" value="${Ze(n?.requested_by??"")}">
          <div class="action-assignee-picker-trigger" id="action-modal-requester-trigger" title="Select who requested this task">
            <span class="action-assignee-picker-value" id="action-modal-requester-value">${n?.requested_by?Ze(n.requested_by):'<span class="text-muted">Select requester...</span>'}</span>
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </div>
          <div id="action-modal-requester-dropdown" class="action-assignee-picker-dropdown hidden">
            <div class="action-assignee-picker-search">
              <input type="text" id="action-modal-requester-search" placeholder="Search contacts..." autocomplete="off">
            </div>
            <div id="action-modal-requester-list" class="action-assignee-picker-list">Loading...</div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="action-dod">Definition of Done (one per line)</label>
          <textarea id="action-dod" rows="3" 
                    placeholder="e.g. C√≥digo testado localmente&#10;PR criado e revisto">${Ze(p)}</textarea>
        </div>
        
        <div class="form-group">
          <label for="action-ac">Acceptance Criteria (one per line)</label>
          <textarea id="action-ac" rows="3" 
                    placeholder="e.g. Middleware rejeita tokens inv√°lidos com 401&#10;Testes unit√°rios passam">${Ze(g)}</textarea>
        </div>
      </form>
    `}const l=b("div",{className:"modal-footer"});if(i&&n){const p=b("button",{className:"btn btn-primary",textContent:"Edit"}),g=b("button",{className:"btn btn-secondary",textContent:"Close"});if(n.status!=="completed"){const f=b("button",{className:"btn btn-success",textContent:"Mark Complete"});d(f,"click",async()=>{try{const h=await Ee.update(n.id,{status:"completed"});m.success("Action completed"),s?.(h),K(on)}catch{}}),l.appendChild(f)}d(g,"click",()=>K(on)),d(p,"click",()=>{K(on),Ea({...e,mode:"edit"})}),l.appendChild(g),l.appendChild(p)}else{const p=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),g=b("button",{className:"btn btn-primary",textContent:o?"Save Changes":"Create Action"});if(d(p,"click",()=>K(on)),d(g,"click",async()=>{const f=c.querySelector("#action-form");if(!f.checkValidity()){f.reportValidity();return}const h=H=>c.querySelector(`#${H}`)?.value.trim()||"",k=H=>h(H).split(/\n/).map(J=>J.trim()).filter(Boolean),C=h("action-task"),x=c.querySelector("#action-parent-story-id"),$=c.querySelector("#action-depends-on"),w=x?.value?.trim()||void 0,y=$?Array.from($.selectedOptions).map(H=>H.value).filter(Boolean):[],P=c.querySelector("#action-sprint-id")?.value?.trim()||void 0,j={content:C,status:h("action-status"),priority:h("action-priority"),assignee:h("action-assignee")||void 0,due_date:h("action-due")||void 0,parent_story_id:w,size_estimate:h("action-size")||void 0,description:h("action-description")||void 0,definition_of_done:k("action-dod"),acceptance_criteria:k("action-ac"),depends_on:y.length?y:void 0,requested_by:h("action-requested-by")||void 0,requested_by_contact_id:h("action-requested-by-contact-id")||void 0,sprint_id:P,task_points:(()=>{const H=h("action-task-points");if(H===""||H==null)return;const J=Number(H);return Number.isFinite(J)&&J>=0?J:void 0})()};g.disabled=!0,g.textContent="Saving...";try{if(o){const H=await Ee.update(n.id,j);m.success("Action updated"),s?.(H)}else{const H=await Ee.create(j);m.success("Action created"),s?.(H)}K(on)}catch{}finally{g.disabled=!1,g.textContent=o?"Save Changes":"Create Action"}}),o){const f=b("button",{className:"btn btn-danger",textContent:"Delete"});d(f,"click",async()=>{const{confirm:h}=await xe(async()=>{const{confirm:C}=await Promise.resolve().then(()=>In);return{confirm:C}},void 0);if(await h("Are you sure you want to delete this action?",{title:"Delete Action",confirmText:"Delete",confirmClass:"btn-danger"}))try{await Ee.delete(n.id),m.success("Action deleted"),a?.(String(n.id)),K(on)}catch{}}),l.appendChild(f)}l.appendChild(p),l.appendChild(g)}const u=Pe({id:on,title:i?"Action Details":o?"Edit Action":"New Action",content:c,size:"md",footer:l});if(document.body.appendChild(u),De(on),i&&n&&(n.requested_by||n.requested_by_contact_id)){const p=c.querySelector("#action-view-requester-card");p&&(async()=>{try{const f=(await Ne.getAll())?.contacts||[],h=n.requested_by_contact_id,k=h?f.find(y=>y.id&&String(y.id)===String(h)):f.find(y=>(y.name||"").trim().toLowerCase()===n.requested_by?.trim().toLowerCase()||(y.name||"").toLowerCase().includes(n.requested_by?.toLowerCase()||"")),C=k?.name??n.requested_by??"",x=k?.role??"",$=k?.photoUrl||k?.avatarUrl||null,w=C?C.trim().split(/\s+/).map(y=>y[0]).join("").toUpperCase().substring(0,2):"?";k&&(p.innerHTML=`
              <div class="action-view-requester-card-inner assignee-chip">
                <div class="assignee-avatar">${$?`<img src="${Ze($)}" alt="${Ze(C)}" onerror="this.parentElement.innerHTML='${w}'">`:w}</div>
                <div class="action-assignee-card-info">
                  <div class="action-assignee-card-name">${Ze(C)}</div>
                  ${x?`<div class="action-assignee-card-role">${Ze(x)}</div>`:""}
                </div>
              </div>
            `)}catch{}})()}if(!i&&c){(async()=>{const j=await Ee.getUserStories(),H=c.querySelector("#action-parent-story-id");H&&(H.innerHTML='<option value="">‚Äî None ‚Äî</option>',j.forEach(F=>{const ee=document.createElement("option");ee.value=F.id,ee.textContent=F.story_points!=null?`${F.title} (${F.story_points} pt)`:F.title,n?.parent_story_id&&String(F.id)===String(n.parent_story_id)&&(ee.selected=!0),H.appendChild(ee)}));const J=await Xi(),B=c.querySelector("#action-sprint-id");B&&(B.innerHTML='<option value="">‚Äî None ‚Äî</option>',J.forEach(F=>{const ee=document.createElement("option");ee.value=F.id,ee.textContent=F.name,n?.sprint_id&&String(F.id)===String(n.sprint_id)&&(ee.selected=!0),B.appendChild(ee)}));const Z=await Ee.getAll(),O=c.querySelector("#action-depends-on");if(O){O.innerHTML="";const F=n?.id?String(n.id):"";Z.filter(ee=>String(ee.id)!==F).forEach(ee=>{const ie=document.createElement("option");ie.value=String(ee.id),ie.textContent=(ee.content||ee.task||"").substring(0,60)+((ee.content||ee.task||"").length>60?"...":""),Array.isArray(n?.depends_on)&&n.depends_on.includes(String(ee.id))&&(ie.selected=!0),O.appendChild(ie)})}})();const p=c.querySelector("#action-new-story-btn");p&&d(p,"click",async()=>{const j=window.prompt("User story title");if(!j?.trim())return;const H=window.prompt("Story points (optional, number). Leave empty to skip.");let J;if(H!=null&&H.trim()!==""){const B=Number(H.trim());Number.isFinite(B)&&B>=0&&(J=B)}try{const B=await Ee.addUserStory({title:j.trim(),story_points:J}),Z=c.querySelector("#action-parent-story-id");if(Z){const O=document.createElement("option");O.value=B.id,O.textContent=B.story_points!=null?`${B.title} (${B.story_points} pt)`:B.title,O.selected=!0,Z.appendChild(O)}m.success("User story created")}catch(B){m.error(B.message||"Failed to create story")}});const g=c.querySelector("#action-edit-story-btn");g&&d(g,"click",async()=>{const j=c.querySelector("#action-parent-story-id"),H=j?.value?.trim();if(!H){m.error("Select a user story first");return}try{const J=await Ee.getUserStory(H);if(!J){m.error("Story not found");return}const B=window.prompt("User story title",J.title);if(B==null)return;const Z=B.trim();if(!Z){m.error("Title is required");return}const O=window.prompt("Story points (optional, number). Leave empty to clear.",J.story_points!=null?String(J.story_points):"");let F;if(O!=null)if(O.trim()==="")F=null;else{const ee=Number(O.trim());Number.isFinite(ee)&&ee>=0&&(F=ee)}if(await Ee.updateUserStory(H,{title:Z,...F!==void 0?{story_points:F}:{}}),j){const ee=j.selectedOptions?.[0];ee&&(ee.textContent=F!=null?`${Z} (${F} pt)`:Z)}m.success("User story updated")}catch(J){m.error(J.message||"Failed to update story")}});const f=async(j,H)=>{const B=c.querySelector("#action-description-draft")?.value?.trim()||"";if(!B){m.error("Enter a short description first");return}j.textContent="Generating...",j.disabled=!0;try{const O=c.querySelector("#action-parent-story-id")?.selectedOptions?.[0]?.textContent||"",F=await Ee.suggestTaskFromDescription({user_input:B,parent_story_ref:O||void 0});c.querySelector("#action-task").value=F.task,c.querySelector("#action-description").value=F.description,c.querySelector("#action-size").value=F.size_estimate,c.querySelector("#action-dod").value=F.definition_of_done.join(`
`),c.querySelector("#action-ac").value=F.acceptance_criteria.join(`
`),m.success(j.id==="action-regenerate-ai-btn"?"Task regenerated with AI":"Task generated from description")}catch(Z){m.error(Z.message||"Failed to generate")}finally{j.disabled=!1,j.textContent=H}},h=c.querySelector("#action-generate-btn");h&&d(h,"click",()=>f(h,"Generate from description"));const k=c.querySelector("#action-regenerate-ai-btn");k&&d(k,"click",()=>f(k,"Regenerate with AI"));const C=c.querySelector("#action-modal-requester-trigger"),x=c.querySelector("#action-modal-requester-dropdown"),$=c.querySelector("#action-modal-requester-value"),w=c.querySelector("#action-modal-requester-list"),y=c.querySelector("#action-modal-requester-search"),S=c.querySelector("#action-requested-by-contact-id"),P=c.querySelector("#action-requested-by");if(C&&x&&w&&S&&P){let j=[];const H=ie=>{const oe=document.createElement("div");return oe.textContent=ie,oe.innerHTML},J=(ie="")=>{const oe=ie?j.filter(me=>(me.name||"").toLowerCase().includes(ie.toLowerCase())||(me.role||"").toLowerCase().includes(ie.toLowerCase())):j;if(j.length===0){w.innerHTML='<div class="empty-state">Loading...</div>';return}w.innerHTML='<div class="action-assignee-card-picker" data-contact-id="" data-contact-name=""><div class="action-assignee-card-info"><div class="action-assignee-card-name text-muted">No requester</div></div></div>'+oe.map(me=>`
            <div class="action-assignee-card-picker" data-contact-id="${H(me.id)}" data-contact-name="${H(me.name||"")}">
              <div class="action-assignee-card-info">
                <div class="action-assignee-card-name">${H(me.name||"")}</div>
                ${me.role?`<div class="action-assignee-card-role">${H(me.role)}</div>`:""}
              </div>
            </div>
          `).join(""),w.querySelectorAll(".action-assignee-card-picker").forEach(me=>{d(me,"click",()=>{const ze=me.getAttribute("data-contact-id")||"",re=me.getAttribute("data-contact-name")||"";S.value=ze,P.value=re,$&&($.innerHTML=re?H(re):'<span class="text-muted">Select requester...</span>'),x.classList.add("hidden")})})};d(C,"click",async ie=>{ie.stopPropagation();const oe=!x.classList.contains("hidden");if(x.classList.toggle("hidden",oe),!oe&&j.length===0){w.innerHTML='<div class="empty-state">Loading...</div>';try{j=((await Ne.getAll())?.contacts||[]).map(ze=>({id:ze.id,name:ze.name||"",role:ze.role})),J(y?.value||"")}catch{w.innerHTML='<div class="empty-state">Failed to load contacts</div>'}}else oe||J(y?.value||"")}),y&&y.addEventListener("input",()=>J(y.value));const B=()=>{x&&!x.classList.contains("hidden")&&x.classList.add("hidden")};let Z=!1;const O=()=>{Z||(Z=!0,document.removeEventListener("click",F),document.removeEventListener("keydown",ee))},F=ie=>{if(!document.querySelector(`[data-modal-id="${on}"]`)?.classList.contains("open")){O();return}ie.target.closest(".action-requester-picker-wrap")||B()},ee=ie=>{if(!document.querySelector(`[data-modal-id="${on}"]`)?.classList.contains("open")){O();return}ie.key==="Escape"&&B()};document.addEventListener("click",F),document.addEventListener("keydown",ee)}}}function Ze(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const ni="create-sprint-modal";function ro(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function JC(e={}){const{onSuccess:t}=e,n=document.querySelector(`[data-modal-id="${ni}"]`);n&&n.remove();const s=b("div",{className:"create-sprint-modal-content"});s.innerHTML=`
    <form id="create-sprint-form" class="create-sprint-form">
      <div class="form-group">
        <label for="sprint-name">Sprint name *</label>
        <input type="text" id="sprint-name" required placeholder="e.g. Sprint 12">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="sprint-start">Start date *</label>
          <input type="date" id="sprint-start" required>
        </div>
        <div class="form-group">
          <label for="sprint-end">End date *</label>
          <input type="date" id="sprint-end" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="sprint-analysis-start">Analysis period start</label>
          <input type="date" id="sprint-analysis-start" title="From when to consider emails/transcripts">
        </div>
        <div class="form-group">
          <label for="sprint-analysis-end">Analysis period end</label>
          <input type="date" id="sprint-analysis-end" title="Until when to consider emails/transcripts">
        </div>
      </div>
      <div class="form-group">
        <label for="sprint-context">Sprint context / goals</label>
        <textarea id="sprint-context" rows="3" placeholder="What is the focus of this sprint? Goals, priorities..."></textarea>
      </div>
    </form>
    <div id="create-sprint-step2" class="create-sprint-preview hidden">
      <p class="create-sprint-preview-intro">Review proposed tasks and existing actions to link. Then click Apply.</p>
      <div class="form-group">
        <label>New tasks to create</label>
        <div id="create-sprint-new-tasks-list" class="create-sprint-tasks-list"></div>
      </div>
      <div class="form-group">
        <label>Existing actions to add to this sprint</label>
        <div id="create-sprint-existing-list" class="create-sprint-existing-list"></div>
      </div>
    </div>
  `;const a=b("div",{className:"modal-footer"});a.innerHTML=`
    <button type="button" class="btn btn-secondary" id="create-sprint-cancel-btn">Cancel</button>
    <button type="button" class="btn btn-primary" id="create-sprint-generate-btn">Create Sprint & Generate Tasks</button>
    <button type="button" class="btn btn-primary hidden" id="create-sprint-apply-btn">Apply</button>
  `;const o=Pe({id:ni,title:"Create Sprint",content:s,size:"lg",closable:!0,footer:a,onClose:()=>{}});document.body.appendChild(o),De(ni);let i=null,r=[],c=[];const l=new Map,u=C=>s.querySelector(`#${C}`)?.value?.trim()||"",p=s.querySelector("#create-sprint-form"),g=s.querySelector("#create-sprint-step2"),f=s.querySelector("#create-sprint-generate-btn"),h=s.querySelector("#create-sprint-apply-btn"),k=s.querySelector("#create-sprint-cancel-btn");d(k,"click",()=>K(ni)),d(f,"click",async()=>{if(!p.checkValidity()){p.reportValidity();return}const C=u("sprint-name"),x=u("sprint-start"),$=u("sprint-end");if(new Date($)<new Date(x)){m.error("End date must be after start date");return}f.disabled=!0,f.textContent="Creating...";try{i=await NC({name:C,start_date:x,end_date:$,context:u("sprint-context")||void 0,analysis_start_date:u("sprint-analysis-start")||void 0,analysis_end_date:u("sprint-analysis-end")||void 0}),f.textContent="Generating tasks...";const w=await OC(i.id,{analysis_start_date:u("sprint-analysis-start")||void 0,analysis_end_date:u("sprint-analysis-end")||void 0});r=w.proposed_new_tasks||[],c=w.existing_action_ids||[];const y=w.existing_details||[];p.classList.add("hidden"),g.classList.remove("hidden"),f.classList.add("hidden"),h.classList.remove("hidden");const S=s.querySelector("#create-sprint-new-tasks-list");S.innerHTML=r.length?r.map((j,H)=>`
          <div class="create-sprint-task-item" data-index="${H}">
            <div class="create-sprint-task-title">${ro((j.task||"").slice(0,120))}${(j.task||"").length>120?"‚Ä¶":""}</div>
            ${j.size_estimate?`<span class="create-sprint-task-size">${ro(j.size_estimate)}</span>`:""}
          </div>
        `).join(""):'<p class="text-muted">No new tasks suggested.</p>';const P=s.querySelector("#create-sprint-existing-list");l.clear(),y.length?(P.innerHTML=y.map(j=>{const H=c.includes(j.id);return`
            <label class="create-sprint-existing-item">
              <input type="checkbox" data-action-id="${j.id}" ${H?"checked":""}>
              <span>${ro((j.task||"").slice(0,80))}${(j.task||"").length>80?"‚Ä¶":""}</span>
              <span class="create-sprint-existing-status">${ro(j.status||"")}</span>
            </label>
          `}).join(""),P.querySelectorAll("input[type=checkbox]").forEach(j=>{l.set(j.dataset.actionId,j)})):P.innerHTML='<p class="text-muted">No existing actions suggested.</p>',m.success("Sprint created. Review and click Apply to add tasks.")}catch(w){m.error(w.message||"Failed")}finally{f.disabled=!1,f.textContent="Create Sprint & Generate Tasks"}}),d(h,"click",async()=>{if(!i)return;const C=Array.from(l.entries()).filter(([,x])=>x.checked).map(([x])=>x);h.disabled=!0,h.textContent="Applying...";try{await FC(i.id,{new_tasks:r,existing_action_ids:C}),m.success("Sprint applied. New tasks created and existing actions linked."),K(ni),t?.(i)}catch(x){m.error(x.message||"Apply failed")}finally{h.disabled=!1,h.textContent="Apply"}})}const YC={pending:"var(--color-neutral-400)",in_progress:"var(--color-info-500)",completed:"var(--color-success-500)",cancelled:"var(--color-neutral-500)",overdue:"var(--color-danger-500)"};function XC(e){return e.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())}function yg(e){const{byStatus:t,byAssignee:n={},height:s=220,showAssignee:a=!0}=e,o=b("div",{className:"breakdown-chart-container"});o.style.height=`${s}px`;const i=Object.entries(t).filter(([,u])=>u>0),r=Object.entries(n).filter(([,u])=>u>0);if(i.length===0&&r.length===0)return o.innerHTML='<div class="empty-chart">No data for breakdown</div>',o;const c=`breakdown-chart-${Date.now()}`;o.innerHTML=`
    <div class="breakdown-chart-wrapper">
      <div class="breakdown-chart-section">
        <div class="breakdown-chart-title">By status</div>
        <canvas id="${c}-status" width="280" height="${Math.min(180,s-40)}"></canvas>
      </div>
      ${a&&r.length>0?`
      <div class="breakdown-chart-section">
        <div class="breakdown-chart-title">By assignee</div>
        <canvas id="${c}-assignee" width="280" height="${Math.min(180,s-40)}"></canvas>
      </div>
      `:""}
    </div>
  `;const l=o.querySelector(`#${c}-status`);if(l&&i.length>0){const u=i.map(([f])=>XC(f)),p=i.map(([,f])=>f),g=i.map(([f])=>f);Lu(l,u,p,(f,h)=>YC[g[h]]||"#6366f1")}if(a&&r.length>0){const u=o.querySelector(`#${c}-assignee`);if(u){const p=["var(--color-info-500)","var(--color-success-500)","var(--color-warning-500)","var(--color-danger-500)","var(--color-accent-500)"];Lu(u,r.map(([g])=>g||"(unassigned)"),r.map(([,g])=>g),(g,f)=>p[f%p.length])}}return o}function Lu(e,t,n,s){if(typeof window.Chart>"u"){e4(e.parentElement,t,n,(i,r)=>s(i,r));return}const a=window.Chart,o=t.map((i,r)=>s(i,r));new a(e,{type:"bar",data:{labels:t,datasets:[{label:"Count",data:n,backgroundColor:o,borderColor:o.map(i=>i),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}})}function e4(e,t,n,s){const a=Math.max(...n,1),o=t.map((r,c)=>{const l=n[c],u=l/a*100,p=s(r,c);return`<div class="breakdown-fallback-bar"><span class="bar-label">${t4(r)}</span><div class="bar-track"><div class="bar-fill" style="width:${u}%;background:${p}"></div></div><span class="bar-value">${l}</span></div>`}).join(""),i=document.createElement("div");i.className="breakdown-fallback",i.innerHTML=o,e.appendChild(i)}function t4(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const co="sprint-report-modal";function vt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function n4(e){const{sprintId:t,sprintName:n="Sprint"}=e,s=document.querySelector(`[data-modal-id="${co}"]`);s&&s.remove();const a=b("div",{className:"sprint-report-modal-content"});a.innerHTML=`
    <div class="sprint-report-loading">Loading report...</div>
    <div id="sprint-report-body" class="sprint-report-body hidden">
      <div class="sprint-report-export-section">
        <h4>Export as</h4>
        <div class="sprint-report-format-row">
          <label class="sprint-report-format-option">
            <input type="radio" name="sprint-report-format" value="document" checked> Document (A4)
          </label>
          <label class="sprint-report-format-option">
            <input type="radio" name="sprint-report-format" value="presentation"> Presentation (PPT)
          </label>
        </div>
        <div id="sprint-report-document-options" class="sprint-report-format-options">
          <label class="sprint-report-style-row">
            <span>Style:</span>
            <select id="sprint-report-document-style">
              <option value="">Default</option>
              <option value="sprint_report_style_corporate_classic">Corporativo cl√°ssico</option>
              <option value="sprint_report_style_modern_minimal">Moderno minimalista</option>
              <option value="sprint_report_style_startup_tech">Startup / Tech</option>
              <option value="sprint_report_style_consultancy">Consultoria / Enterprise</option>
            </select>
          </label>
          <label class="sprint-report-check"><input type="checkbox" id="sprint-report-include-analysis"> Include AI analysis</label>
          <label class="sprint-report-check"><input type="checkbox" id="sprint-report-include-business"> Include business report</label>
        </div>
        <div id="sprint-report-presentation-options" class="sprint-report-format-options hidden">
          <label class="sprint-report-check"><input type="checkbox" id="sprint-report-ppt-include-analysis"> Include AI analysis</label>
          <label class="sprint-report-check"><input type="checkbox" id="sprint-report-ppt-include-business"> Include business report</label>
        </div>
        <div class="sprint-report-generate-row">
          <button type="button" class="btn btn-primary" id="sprint-report-generate-doc-btn">Generate document (A4)</button>
          <button type="button" class="btn btn-primary hidden" id="sprint-report-generate-ppt-btn">Generate presentation (PPT)</button>
          <label class="sprint-report-check sprint-report-pdf-option"><input type="checkbox" id="sprint-report-open-for-pdf"> Open for PDF (print dialog)</label>
        </div>
        <div id="sprint-report-generate-status" class="sprint-report-generate-status hidden"></div>
      </div>
      <div class="sprint-report-summary" id="sprint-report-summary"></div>
      <div class="sprint-report-chart" id="sprint-report-chart"></div>
      <div class="sprint-report-actions-list" id="sprint-report-actions"></div>
      <div class="sprint-report-ai-section">
        <h4>AI analysis</h4>
        <div id="sprint-report-ai-placeholder" class="sprint-report-ai-placeholder">Click "Analyze with AI" to generate.</div>
        <div id="sprint-report-ai-content" class="sprint-report-ai-content hidden"></div>
      </div>
      <div class="sprint-report-business-section">
        <h4>Business report</h4>
        <div id="sprint-report-business-placeholder" class="sprint-report-business-placeholder">Click "Business report" to generate.</div>
        <div id="sprint-report-business-content" class="sprint-report-business-content hidden"></div>
      </div>
    </div>
    <div id="sprint-report-error" class="sprint-report-error hidden"></div>
  `;const o=b("div",{className:"modal-footer"});o.innerHTML=`
    <button type="button" class="btn btn-outline-secondary" id="sprint-report-export-pdf-btn">Export report as PDF</button>
    <button type="button" class="btn btn-secondary" id="sprint-report-analyze-btn">Analyze with AI</button>
    <button type="button" class="btn btn-outline-primary" id="sprint-report-business-btn">Business report</button>
    <button type="button" class="btn btn-primary" id="sprint-report-close-btn">Close</button>
  `;const i=Pe({id:co,title:`Sprint report: ${vt(n)}`,content:a,size:"xl",closable:!0,footer:o,onClose:()=>{}});document.body.appendChild(i),De(co);let r=null;async function c(){const x=a.querySelector(".sprint-report-loading"),$=a.querySelector("#sprint-report-body"),w=a.querySelector("#sprint-report-error");if(!(!x||!$||!w))try{const y=await UC(t);if(!y){w.textContent="Failed to load report",w.classList.remove("hidden"),x.classList.add("hidden");return}r=y,x.classList.add("hidden"),w.classList.add("hidden"),$.classList.remove("hidden");const S=a.querySelector("#sprint-report-summary");if(S){const H=y.total_tasks?Math.round(y.completed_tasks/y.total_tasks*100):0,J=y.total_task_points>0?` ¬∑ ${y.completed_task_points}/${y.total_task_points} points`:"";S.innerHTML=`
          <p><strong>${y.completed_tasks}</strong> / <strong>${y.total_tasks}</strong> tasks completed (${H}%)${J}</p>
          <p class="sprint-report-dates">${y.sprint.start_date} ‚Äì ${y.sprint.end_date}</p>
          ${y.sprint.context?`<p class="sprint-report-context">${vt(y.sprint.context)}</p>`:""}
        `}const P=a.querySelector("#sprint-report-chart");P&&(P.innerHTML="",P.appendChild(yg({byStatus:y.breakdown.by_status,byAssignee:y.breakdown.by_assignee,height:200,showAssignee:!0})));const j=a.querySelector("#sprint-report-actions");j&&y.actions.length>0?j.innerHTML=`
          <h4>Tasks (${y.actions.length})</h4>
          <ul class="sprint-report-task-list">
            ${y.actions.map(H=>`<li class="sprint-report-task-item" data-status="${vt((H.status||"pending").toLowerCase())}">
                    <span class="task-status-dot"></span>
                    ${vt(H.task||H.content||"‚Äî")}
                    ${H.task_points!=null?`<span class="task-points">${H.task_points} pt</span>`:""}
                  </li>`).join("")}
          </ul>
        `:j&&(j.innerHTML='<p class="sprint-report-no-tasks">No tasks in this sprint.</p>')}catch(y){x.classList.add("hidden"),$.classList.add("hidden"),w.textContent=y instanceof Error?y.message:"Failed to load report",w.classList.remove("hidden")}}d(o.querySelector("#sprint-report-close-btn"),"click",()=>K(co));function l(){if(!r){m.error("Report not loaded yet");return}const x=r.sprint,$=a.querySelector("#sprint-report-ai-content"),w=a.querySelector("#sprint-report-business-content"),y=$&&!$.classList.contains("hidden")?$.innerHTML:"",S=w&&!w.classList.contains("hidden")?w.innerHTML:"",P=r.breakdown.by_status||{},j=r.breakdown.by_assignee||{},H=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Sprint Report ‚Äì ${vt(x.name)}</title>
<style>
  body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; color: #333; line-height: 1.5; }
  h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
  h2 { font-size: 1.15rem; margin-top: 1.5rem; margin-bottom: 0.5rem; }
  p, ul { margin: 0.5rem 0; }
  ul { padding-left: 1.5rem; }
  .meta { color: #666; font-size: 0.9rem; }
  .section { margin-top: 1rem; }
  @media print { body { margin: 1rem; } }
</style></head><body>
  <h1>${vt(x.name)}</h1>
  <p class="meta">${vt(x.start_date)} ‚Äì ${vt(x.end_date)}</p>
  ${x.context?`<p>${vt(x.context)}</p>`:""}
  <div class="section">
    <h2>Summary</h2>
    <p><strong>${r.completed_tasks}</strong> / <strong>${r.total_tasks}</strong> tasks completed${r.total_task_points>0?` ¬∑ ${r.completed_task_points}/${r.total_task_points} points`:""}.</p>
  </div>
  <div class="section">
    <h2>By status</h2>
    <ul>${Object.entries(P).map(([O,F])=>`<li>${vt(O)}: ${F}</li>`).join("")}</ul>
  </div>
  <div class="section">
    <h2>By assignee</h2>
    <ul>${Object.entries(j).map(([O,F])=>`<li>${vt(O)}: ${F}</li>`).join("")}</ul>
  </div>
  <div class="section">
    <h2>Tasks</h2>
    <ul>${r.actions.slice(0,100).map(O=>`<li>${vt(O.status||"pending")}: ${vt((O.task||O.content||"‚Äî").substring(0,200))}${O.task_points!=null?` (${O.task_points} pt)`:""}</li>`).join("")}</ul>
    ${r.actions.length>100?`<p class="meta">‚Ä¶ and ${r.actions.length-100} more tasks</p>`:""}
  </div>
  ${y?`<div class="section"><h2>AI analysis</h2><div>${y}</div></div>`:""}
  ${S?`<div class="section"><h2>Business report</h2><div>${S}</div></div>`:""}
<script>window.onload=function(){window.print();}<\/script>
</body></html>`,J=new Blob([H],{type:"text/html;charset=utf-8"}),B=URL.createObjectURL(J),Z=window.open(B,"_blank","noopener");Z?Z.addEventListener("load",()=>URL.revokeObjectURL(B),{once:!0}):(m.error("Allow pop-ups to export PDF"),URL.revokeObjectURL(B))}const u=o.querySelector("#sprint-report-export-pdf-btn");u&&d(u,"click",()=>l());const p=a.querySelector("#sprint-report-document-options"),g=a.querySelector("#sprint-report-presentation-options"),f=a.querySelector("#sprint-report-generate-doc-btn"),h=a.querySelector("#sprint-report-generate-ppt-btn");a.querySelectorAll('input[name="sprint-report-format"]').forEach(x=>{d(x,"change",()=>{const $=a.querySelector('input[name="sprint-report-format"]:checked')?.value==="document";p&&p.classList.toggle("hidden",!$),g&&g.classList.toggle("hidden",$),f&&f.classList.toggle("hidden",!$),h&&h.classList.toggle("hidden",$)})});function k(x,$=!1){let w=x;if($){const P="<script>window.onload=function(){window.print();}<\/script>";w.includes("</body>")?w=w.replace("</body>",P+"</body>"):w.includes("</html>")?w=w.replace("</html>",P+"</html>"):w=w+P}const y=new Blob([w],{type:"text/html;charset=utf-8"}),S=URL.createObjectURL(y);window.open(S,"_blank","noopener"),URL.revokeObjectURL(S)}const C=a.querySelector("#sprint-report-generate-status");f&&d(f,"click",async()=>{if(C){f.disabled=!0,C.classList.remove("hidden"),C.textContent="Generating document‚Ä¶";try{const x=a.querySelector("#sprint-report-document-style")?.value||"",$=a.querySelector("#sprint-report-include-analysis")?.checked??!1,w=a.querySelector("#sprint-report-include-business")?.checked??!1,y=await ZC(t,{include_analysis:$,include_business:w,style:x||void 0}),S=a.querySelector("#sprint-report-open-for-pdf")?.checked??!1;C.textContent=S?"Done. Opening for PDF‚Ä¶":"Done. Opening in new tab‚Ä¶",k(y.html,S)}catch(x){m.error(x instanceof Error?x.message:"Failed to generate document"),C.textContent=""}finally{f.disabled=!1}}}),h&&d(h,"click",async()=>{if(C){h.disabled=!0,C.classList.remove("hidden"),C.textContent="Generating presentation‚Ä¶";try{const x=a.querySelector("#sprint-report-ppt-include-analysis")?.checked??!1,$=a.querySelector("#sprint-report-ppt-include-business")?.checked??!1,w=await WC(t,{include_analysis:x,include_business:$}),y=a.querySelector("#sprint-report-open-for-pdf")?.checked??!1;C.textContent=y?"Done. Opening for PDF‚Ä¶":"Done. Opening in new tab‚Ä¶",k(w.html,y)}catch(x){m.error(x instanceof Error?x.message:"Failed to generate presentation"),C.textContent=""}finally{h.disabled=!1}}}),d(o.querySelector("#sprint-report-analyze-btn"),"click",async()=>{const x=o.querySelector("#sprint-report-analyze-btn"),$=a.querySelector("#sprint-report-ai-placeholder"),w=a.querySelector("#sprint-report-ai-content");if(!(!x||!$||!w)){x.disabled=!0,$.textContent="Analyzing...";try{const y=await VC(t);$.classList.add("hidden"),w.classList.remove("hidden"),w.innerHTML=y.ai_analysis?`<div class="sprint-report-ai-text">${vt(y.ai_analysis).replace(/\n/g,"<br>")}</div>`:`<div class="sprint-report-ai-text">${vt(y.error||"No analysis available.")}</div>`}catch(y){m.error(y instanceof Error?y.message:"Analysis failed"),$.textContent='Click "Analyze with AI" to generate.'}finally{x.disabled=!1}}}),d(o.querySelector("#sprint-report-business-btn"),"click",async()=>{const x=o.querySelector("#sprint-report-business-btn"),$=a.querySelector("#sprint-report-business-placeholder"),w=a.querySelector("#sprint-report-business-content");if(!(!x||!$||!w)){x.disabled=!0,$.textContent="Generating...";try{const y=await GC(t);$.classList.add("hidden"),w.classList.remove("hidden"),w.innerHTML=y.business_report?`<div class="sprint-report-business-text">${vt(y.business_report).replace(/\n/g,"<br>")}</div>`:`<div class="sprint-report-business-text">${vt(y.error||"No business report available.")}</div>`}catch(y){m.error(y instanceof Error?y.message:"Business report failed"),$.textContent='Click "Business report" to generate.'}finally{x.disabled=!1}}}),c()}function wg(e){const t=b("div",{className:"comments-thread"});t.innerHTML=`
    <div class="comments-header">
      <h4>Comments</h4>
      <span class="comments-count" id="comments-count">0</span>
    </div>
    <div class="comments-list" id="comments-list">
      <div class="loading">Loading comments...</div>
    </div>
    <div class="comment-form">
      <textarea id="comment-input" placeholder="Add a comment..." rows="2"></textarea>
      <div class="comment-form-actions">
        <button class="btn btn-primary btn-sm" id="submit-comment-btn" disabled>Comment</button>
      </div>
    </div>
  `;const n=t.querySelector("#comment-input"),s=t.querySelector("#submit-comment-btn");return d(n,"input",()=>{s.disabled=!n.value.trim()}),d(s,"click",()=>Tu(t,e,n)),d(n,"keydown",a=>{a.key==="Enter"&&(a.ctrlKey||a.metaKey)&&(a.preventDefault(),n.value.trim()&&Tu(t,e,n))}),Li(t,e),t}async function Li(e,t){const n=e.querySelector("#comments-list");n.innerHTML='<div class="loading">Loading...</div>';try{const s=await ga.getAll(t.targetType,t.targetId);s4(n,s,e,t),o4(e,s.length)}catch{n.innerHTML='<div class="error">Failed to load comments</div>'}}function s4(e,t,n,s){if(t.length===0){e.innerHTML='<div class="empty">No comments yet</div>';return}const a=t.filter(r=>!r.parent_id),o=t.filter(r=>r.parent_id),i={};o.forEach(r=>{i[r.parent_id]||(i[r.parent_id]=[]),i[r.parent_id].push(r)}),e.innerHTML=a.map(r=>a4(r,i[r.id]||[])).join(""),i4(e,t,n,s)}function a4(e,t,n,s){const a=N.getState().currentUser,o=a?.id===e.user_id;return`
    <div class="comment ${e.resolved?"resolved":""}" data-id="${e.id}">
      <div class="comment-avatar">${Au(e.user_name||"U")}</div>
      <div class="comment-body">
        <div class="comment-header">
          <span class="comment-author">${lo(e.user_name||"Unknown")}</span>
          <span class="comment-time">${Ce(e.created_at)}</span>
          ${e.resolved?'<span class="resolved-badge">Resolved</span>':""}
        </div>
        <div class="comment-content">${lo(e.content)}</div>
        <div class="comment-actions">
          <button class="btn-link reply-btn">Reply</button>
          ${e.resolved?"":'<button class="btn-link resolve-btn">Resolve</button>'}
          ${o?'<button class="btn-link delete-btn">Delete</button>':""}
        </div>
        <div class="reply-form hidden">
          <textarea class="reply-input" placeholder="Reply..." rows="2"></textarea>
          <div class="reply-actions">
            <button class="btn btn-sm cancel-reply-btn">Cancel</button>
            <button class="btn btn-primary btn-sm submit-reply-btn">Reply</button>
          </div>
        </div>
      </div>
    </div>
    ${t.length>0?`
      <div class="comment-replies">
        ${t.map(i=>`
          <div class="comment reply" data-id="${i.id}">
            <div class="comment-avatar small">${Au(i.user_name||"U")}</div>
            <div class="comment-body">
              <div class="comment-header">
                <span class="comment-author">${lo(i.user_name||"Unknown")}</span>
                <span class="comment-time">${Ce(i.created_at)}</span>
              </div>
              <div class="comment-content">${lo(i.content)}</div>
              ${a?.id===i.user_id?`
                <div class="comment-actions">
                  <button class="btn-link delete-btn">Delete</button>
                </div>
              `:""}
            </div>
          </div>
        `).join("")}
      </div>
    `:""}
  `}function i4(e,t,n,s){e.querySelectorAll(".reply-btn").forEach(a=>{d(a,"click",()=>{const i=a.closest(".comment")?.querySelector(".reply-form");i&&(i.classList.toggle("hidden"),i.querySelector(".reply-input")?.focus())})}),e.querySelectorAll(".cancel-reply-btn").forEach(a=>{d(a,"click",()=>{const o=a.closest(".reply-form");o&&(o.classList.add("hidden"),o.querySelector(".reply-input").value="")})}),e.querySelectorAll(".submit-reply-btn").forEach(a=>{d(a,"click",async()=>{const o=a.closest(".comment"),i=o?.getAttribute("data-id"),r=o?.querySelector(".reply-input");if(!(!i||!r?.value.trim()))try{await ga.create(s.targetType,s.targetId,r.value.trim(),i),m.success("Reply added"),Li(n,s)}catch{m.error("Failed to add reply")}})}),e.querySelectorAll(".resolve-btn").forEach(a=>{d(a,"click",async()=>{const i=a.closest(".comment")?.getAttribute("data-id");if(i)try{await ga.resolve(i),m.success("Comment resolved"),Li(n,s)}catch{m.error("Failed to resolve comment")}})}),e.querySelectorAll(".delete-btn").forEach(a=>{d(a,"click",async()=>{const i=a.closest(".comment")?.getAttribute("data-id");if(!(!i||!confirm("Delete this comment?")))try{await ga.delete(i),m.success("Comment deleted"),Li(n,s)}catch{m.error("Failed to delete comment")}})})}async function Tu(e,t,n){const s=n.value.trim();if(!s)return;const a=e.querySelector("#submit-comment-btn");a.disabled=!0;try{const o=await ga.create(t.targetType,t.targetId,s);n.value="",m.success("Comment added"),Li(e,t),t.onCommentAdded?.(o)}catch{m.error("Failed to add comment"),a.disabled=!1}}function o4(e,t){const n=e.querySelector("#comments-count");n&&(n.textContent=String(t))}function Au(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function lo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const r4=()=>N.getState(),Mu=()=>r4().currentProject;function lt(e){return e.trim().split(/\s+/).map(t=>t[0]).join("").toUpperCase().substring(0,2)}function de(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Wr(e){if(!e)return"‚Äî";try{return Ts(e)}catch{return e}}function uo(e){return e.content??e.task??""}function c4(e){return{created:"üìù",updated:"‚úèÔ∏è",deleted:"üóëÔ∏è",restored:"‚Ü©Ô∏è",refined_with_ai:"‚ú®",rollback:"‚Ü©Ô∏è"}[e]||"‚Ä¢"}function l4(e){const t=e.event_data||{},n=e.actor_name?` by ${e.actor_name}`:"";switch(e.event_type){case"created":return`Created${n}`;case"refined_with_ai":return`Refined with AI${n}`;case"rollback":return`Restored previous version${n}`;case"updated":{const s=t.changes||[];if(s.length===0)return`Updated${n}`;const a=["Description","Task","DoD","Acceptance criteria"];if(s.some(i=>a.includes(i.field))&&s.length>=2)return`Fields updated${n}`;if(s.length===1){const i=s[0],r=String(i.to).trim()?i.to:"‚Äî",c=String(i.from).trim()?i.from:"‚Äî";return`${i.field} changed: ${c} ‚Üí ${r}${n}`}return`${s.map(i=>`${i.field}: ${i.from||"‚Äî"} ‚Üí ${i.to||"‚Äî"}`).join("; ")}${n}`}case"deleted":return`Deleted${t.reason?` (${t.reason})`:""}${n}`;case"restored":return`Restored${n}`;default:return e.event_type}}function kg(e){return!Array.isArray(e)||e.length===0?[]:e.map(t=>typeof t=="string"?{text:t,done:!1}:{text:(t.text??"").toString(),done:!!t.done})}function Eu(e,t){const n=kg(e.definition_of_done||[]),s=(e.acceptance_criteria||[]).map(l=>typeof l=="string"?l:String(l)),a=[];(e.parent_story_ref||e.parent_story_id)&&a.push(`<dt>Parent</dt><dd>${de(String(e.parent_story_ref||e.parent_story_id))}</dd>`),e.size_estimate&&a.push(`<dt>Size</dt><dd>${de(e.size_estimate)}</dd>`);const o=a.length?`<dl class="action-description-dl">${a.join("")}</dl>`:"",i=e.description?`<div class="action-description-text"><strong>Description</strong><p>${de(e.description).replace(/\n/g,"<br>")}</p></div>`:"",r=n.length?`<div class="action-dod"><strong>Definition of Done</strong><ul class="action-checklist action-dod-list">${n.map((l,u)=>`<li class="dod-item ${l.done?"dod-done":""}" data-dod-index="${u}"><button type="button" class="dod-item-toggle" data-dod-index="${u}" aria-label="${l.done?"Mark undone":"Mark done"}">${l.done?"‚úî":"‚òê"}</button><span class="dod-item-text">${de(l.text)}</span></li>`).join("")}</ul></div>`:"",c=s.length?`<div class="action-ac"><strong>Acceptance criteria</strong><ul class="action-checklist">${s.map(l=>`<li>${de(l)}</li>`).join("")}</ul></div>`:"";return`${o}${i}${r}${c}`}function Ho(e){const{action:t,onClose:n,onUpdate:s,onDecisionClick:a}=e;let o=t;const i=b("div",{className:"action-detail-view question-detail-view"}),r=uo(t),c=t.due_date??t.deadline??"",l=t.assignee??t.owner??"",u=Mu()?.name??null;i.innerHTML=`
    <div class="question-detail-header action-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Actions</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        ${u?`<span class="breadcrumb-project" title="Project">${de(u)}</span><span class="breadcrumb-separator">‚Ä∫</span>`:""}
        <span class="breadcrumb-current">Action #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        <button type="button" class="btn btn-secondary btn-sm" id="action-refine-ai-btn" title="Refine task description, DoD and acceptance criteria with AI">
          <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Refine with AI
        </button>
        <span class="status-badge status-${(t.status||"pending").toLowerCase()}">${de(String(t.status).replace("_"," "))}</span>
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content action-detail-content">
      <div id="action-view-content">
        <section class="detail-section action-main">
          <div class="question-badges action-badges">
            ${u?`<span class="project-badge" title="Project">${de(u)}</span>`:""}
            ${t.priority?`<span class="priority-pill priority-${t.priority}">${de(t.priority)}</span>`:""}
            <span class="question-date action-date">Created ${Ce(t.created_at)}</span>
          </div>
          <h2 class="question-text action-task-text">${de(r)}</h2>
        </section>

        <section class="detail-section action-description-structured" id="action-description-section">
          <h3 class="section-header-sota">Description</h3>
          <div class="action-description-body">${Eu(t)}</div>
        </section>

        <div class="detail-columns">
          <div class="detail-column-left">
            <!-- Assignment Section - SOTA (aligned with Questions) -->
            <section class="detail-section" id="action-assignment-section">
              <div class="section-header-sota">
                <h3>
                  <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Assignment
                  <span class="section-subtitle">Who should do this?</span>
                </h3>
                <button type="button" class="btn-ai-suggest" id="action-ai-suggest-btn" title="Suggest who should do this task (assignee) from task content">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                  AI Suggest
                </button>
              </div>

              <!-- Current Assignment Display -->
              <div id="action-current-assignment" class="current-assignment-card">
                ${l?`
                  <div class="assigned-contact-display">
                    <div class="contact-avatar-lg" id="action-assigned-avatar">${lt(l)}</div>
                    <div class="contact-details">
                      <div class="contact-name-lg">${de(l)}</div>
                      <div class="contact-role-sm" id="action-assigned-role">‚Äî</div>
                    </div>
                    <button class="btn-change-assignment" id="action-change-assignee-btn" type="button">
                      <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                      Change
                    </button>
                  </div>
                `:`
                  <div class="no-assignment">
                    <div class="no-assignment-icon">
                      <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                    </div>
                    <span>No one assigned</span>
                    <p class="no-assignment-hint">Use AI Suggest or choose manually</p>
                    <button class="btn-assign-now" id="action-show-picker-btn" type="button">Choose Manually</button>
                  </div>
                `}
              </div>

              <!-- Contact Picker (hidden by default) -->
              <div id="action-contact-picker" class="contact-picker-sota hidden">
                <div class="picker-search">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                  <input type="text" id="action-contact-search" placeholder="Search contacts..." autocomplete="off">
                </div>
                <div id="action-contact-list" class="contact-list-grid">Loading...</div>
              </div>

              <!-- AI Suggestions Panel -->
              <div id="action-suggestions-panel" class="suggestions-panel-sota action-suggestions-panel hidden gm-mb-3"></div>

              <!-- Due date, Sprint (Status is only in header badge) -->
              <dl class="metadata-list action-meta-inline">
                <dt>Due date</dt>
                <dd>${c?Wr(c):"‚Äî"}</dd>
                ${t.sprint_id||t.sprint_name?`
                <dt>Sprint</dt>
                <dd>${de(t.sprint_name||String(t.sprint_id))}</dd>
                `:""}
              </dl>
            </section>

            <section class="detail-section" id="action-decision-section">
              <div class="section-header"><h3>Implementing decision</h3></div>
              <div id="action-decision-display" class="action-decision-display">
                ${t.decision_id?'<p class="text-muted">Loading‚Ä¶</p>':'<p class="text-muted">No decision linked</p>'}
              </div>
              <div class="action-decision-actions">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="action-link-decision-btn">${t.decision_id?"Change":"Link decision"}</button>
                <button type="button" class="btn btn-sm btn-link ${t.decision_id?"":"hidden"}" id="action-unlink-decision-btn">Unlink</button>
              </div>
              <div id="action-decision-picker" class="action-decision-picker hidden">
                <div class="picker-search"><input type="text" id="action-decision-search" placeholder="Search decisions..." autocomplete="off"></div>
                <div id="action-decision-list" class="action-decision-list">Loading‚Ä¶</div>
              </div>
            </section>

            <section class="detail-section" id="action-source-section">
              <div class="section-header"><h3>Source</h3></div>
              <div class="source-content">
              ${[t.source_file?`<p class="source-file"><strong>File:</strong> ${de(t.source_file)}</p>`:"",t.source_document_id?`<p class="source-doc"><a href="#" class="doc-link" data-document-id="${de(String(t.source_document_id))}">View source document</a></p>`:"",t.source_type?`<p class="source-type"><strong>Origin:</strong> ${de(t.source_type)}</p>`:"",t.generation_source?`<p class="source-meta"><strong>Generation:</strong> <span class="status-pill">${de(t.generation_source)}</span></p>`:"",t.requested_by?`<div id="action-requester-display" class="requester-display"><p><strong>Requested by:</strong> ${de(t.requested_by)}</p></div>`:""].filter(Boolean).join("")||'<p class="text-muted">No source recorded</p>'}
              </div>
            </section>
          </div>

          <div class="detail-column-right">
            <section class="detail-section metadata-section">
              <h3>Metadata</h3>
              <dl class="metadata-list">
                <dt>Created</dt>
                <dd>${Wr(t.created_at)}</dd>
                ${t.updated_at?`<dt>Updated</dt><dd>${Wr(t.updated_at)}</dd>`:""}
              </dl>
            </section>

            <section class="detail-section" id="action-timeline-section">
              <h3>Timeline</h3>
              <div id="timeline-content" class="timeline-content">
                <span class="text-muted">Loading‚Ä¶</span>
              </div>
            </section>

            <section class="detail-section" id="action-comments-section">
              <div id="action-comments-mount"></div>
            </section>

            <section class="detail-section" id="action-similar-section">
              <h3 class="section-header-sota">Similar actions</h3>
              <div id="action-similar-mount" class="action-similar-list">
                <div class="skeleton-card">
                  <div class="skeleton-text w-100"></div>
                  <div class="skeleton-row">
                    <div class="skeleton-text w-25"></div>
                    <div class="skeleton-text w-25"></div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

        <div class="detail-actions">
          <button type="button" class="btn btn-secondary" id="edit-action-btn">Edit</button>
          <button type="button" class="btn btn-danger" id="delete-action-btn">Delete</button>
        </div>
      </div>

      <div id="action-edit-form" class="action-detail-edit-form hidden">
        <form id="action-inline-form" class="action-form">
          <div class="form-group">
            <div class="gm-flex gm-flex-center gm-justify-between gm-flex-wrap gm-gap-2 gm-mb-2">
              <label for="action-edit-task" class="gm-mb-0">Task *</label>
              <button type="button" class="btn-ai-suggest btn-sm" id="action-edit-ai-suggest-btn" title="Suggest assignee from task content">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI suggest
              </button>
            </div>
            <textarea id="action-edit-task" rows="3" required placeholder="What needs to be done?">${de(r)}</textarea>
          </div>
          <div id="action-edit-suggestions-panel" class="suggestions-panel-sota action-suggestions-panel hidden gm-mb-4"></div>
          <div class="form-row">
            <div class="form-group">
              <label for="action-edit-status">Status</label>
              <select id="action-edit-status">
                <option value="pending" ${t.status==="pending"?"selected":""}>Pending</option>
                <option value="in_progress" ${t.status==="in_progress"?"selected":""}>In Progress</option>
                <option value="completed" ${t.status==="completed"?"selected":""}>Completed</option>
                <option value="cancelled" ${t.status==="cancelled"?"selected":""}>Cancelled</option>
              </select>
            </div>
            <div class="form-group">
              <label for="action-edit-priority">Priority</label>
              <select id="action-edit-priority">
                <option value="low" ${t.priority==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.priority==="medium"||!t.priority?"selected":""}>Medium</option>
                <option value="high" ${t.priority==="high"?"selected":""}>High</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group action-assignee-picker-wrap">
              <label>Assignee</label>
              <input type="hidden" id="action-edit-assignee" value="${de(l)}">
              <div class="action-assignee-picker-trigger" id="action-assignee-picker-trigger" title="Click to select from project contacts">
                <span class="action-assignee-picker-value" id="action-assignee-picker-value">${l?de(l):'<span class="text-muted">Select assignee...</span>'}</span>
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </div>
              <div id="action-assignee-picker-dropdown" class="action-assignee-picker-dropdown hidden">
                <div class="action-assignee-picker-search">
                  <input type="text" id="action-assignee-picker-search" placeholder="Search contacts..." autocomplete="off">
                </div>
                <div id="action-assignee-picker-list" class="action-assignee-picker-list">Loading...</div>
              </div>
            </div>
            <div class="form-group">
              <label for="action-edit-due">Due date</label>
              <input type="date" id="action-edit-due" value="${c?c.split("T")[0]:""}">
            </div>
          </div>
          <div class="form-group action-requester-picker-wrap">
            <label>Requested by</label>
            <input type="hidden" id="action-edit-requester-contact-id" value="${de(t.requested_by_contact_id||"")}">
            <input type="hidden" id="action-edit-requester-name" value="${de(t.requested_by||"")}">
            <div class="action-assignee-picker-trigger" id="action-requester-picker-trigger" title="Click to select who requested this task">
              <span class="action-assignee-picker-value" id="action-requester-picker-value">${t.requested_by?de(t.requested_by):'<span class="text-muted">Select requester...</span>'}</span>
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
            <div id="action-requester-picker-dropdown" class="action-assignee-picker-dropdown hidden">
              <div class="action-assignee-picker-search">
                <input type="text" id="action-requester-picker-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="action-requester-picker-list" class="action-assignee-picker-list">Loading...</div>
            </div>
          </div>
        </form>
        <div class="detail-actions">
          <button type="button" class="btn btn-primary" id="action-save-btn">Save</button>
          <button type="button" class="btn btn-secondary" id="action-cancel-edit-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="action-delete-in-edit-btn">Delete</button>
        </div>
      </div>
    </div>
  `;const p=i.querySelector("#back-to-list");p&&d(p,"click",Y=>{Y.preventDefault(),n()});const g=i.querySelector("#close-detail");g&&d(g,"click",n);const f=i.querySelector("#action-refine-ai-btn");f&&d(f,"click",async()=>{const Y=uo(t),W=t.description??"",V=[Y,W].filter(Boolean).join(`

`);if(!V.trim()){m.error("Task has no content to refine");return}f.disabled=!0,f.textContent="Refining...";try{const D=await Ee.suggestTaskFromDescription({user_input:V,parent_story_ref:t.parent_story_ref||void 0});if(!i.isConnected)return;const G=await Ee.update(t.id,{content:D.task,description:D.description,definition_of_done:D.definition_of_done,acceptance_criteria:D.acceptance_criteria,size_estimate:D.size_estimate,refined_with_ai:!0});if(!i.isConnected)return;m.success("Task refined with AI"),o=G,C(),s?.(G)}catch(D){m.error(D.message||"Failed to refine")}finally{f.disabled=!1,f.innerHTML=`
          <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Refine with AI
        `}});function h(){const Y=i.querySelector("#action-description-section .action-description-body");Y&&Y.querySelectorAll(".dod-item-toggle").forEach(W=>{d(W,"click",async()=>{const V=parseInt(W.getAttribute("data-dod-index")??"-1",10);if(V<0)return;const D=kg(o.definition_of_done||[]);if(V>=D.length)return;const G=W.closest(".dod-item"),ae=D[V].done;D[V].done=!D[V].done;const ue=D.map($e=>({text:$e.text,done:$e.done}));G&&G.classList.toggle("dod-done",D[V].done),W.textContent=D[V].done?"‚úî":"‚òê",W.setAttribute("aria-label",D[V].done?"Mark undone":"Mark done");try{const $e=await Ee.update(o.id,{definition_of_done:ue});if(!i.isConnected)return;o=$e,m.success(D[V].done?"Marked done":"Marked undone")}catch($e){D[V].done=ae,G&&G.classList.toggle("dod-done",ae),W.textContent=ae?"‚úî":"‚òê",W.setAttribute("aria-label",ae?"Mark undone":"Mark done"),m.error($e.message||"Failed to update")}})})}function k(Y){Y&&Ee.getEvents(o.id).then(W=>{if(!i.isConnected)return;if(W.length===0){Y.innerHTML='<p class="empty-state">No events recorded</p>',h();return}const V=W.map(D=>{const G=c4(D.event_type),ae=l4(D),$e=(D.event_data||{}).snapshot,Re=D.event_type==="refined_with_ai"&&$e&&typeof $e=="object",Mt=Re?` data-snapshot="${de(JSON.stringify($e))}"`:"",et=Re?`<button type="button" class="btn btn-sm btn-outline-secondary action-restore-btn"${Mt} title="Restore this version">Restore</button>`:"";return`
          <div class="timeline-item action-event-${de(D.event_type)}">
            <div class="timeline-icon">${G}</div>
            <div class="timeline-content">
              <div class="timeline-title-row">
                <span class="timeline-title">${de(ae)}</span>
                ${et}
              </div>
              <div class="timeline-date">${Ts(D.created_at)}</div>
            </div>
          </div>`}).join("");Y.innerHTML=`<div class="timeline-list">${V}</div>`,Y.querySelectorAll(".action-restore-btn").forEach(D=>{d(D,"click",async()=>{const G=D.getAttribute("data-snapshot");if(!G)return;const ae=D;ae.disabled=!0;const ue=ae.textContent||"Restore";ae.textContent="Restoring‚Ä¶";try{const $e=JSON.parse(G),Re=await Ee.update(o.id,{restore_snapshot:$e});if(!i.isConnected)return;m.success("Previous version restored"),o=Re,C(),s?.(Re)}catch($e){m.error($e.message||"Failed to restore"),ae.disabled=!1,ae.textContent=ue}})}),h()}).catch(()=>{Y.innerHTML='<p class="error">Failed to load timeline</p>'})}function C(){const Y=i.querySelector(".action-task-text");Y&&(Y.textContent=uo(o));const W=i.querySelector("#action-description-section .action-description-body");W&&(W.innerHTML=Eu(o,o.assignee??o.owner??""),h());const V=i.querySelector("#timeline-content");V&&(V.innerHTML=`
      <div class="skeleton-card">
          <div class="skeleton-row">
              <div class="skeleton-avatar"></div>
              <div class="skeleton-text w-50" style="margin-bottom:0"></div>
          </div>
          <div class="skeleton-text w-75" style="margin-top: 8px;"></div>
      </div>
    `),k(V)}function x(){const Y=i.querySelector("#action-decision-display"),W=i.querySelector("#action-link-decision-btn"),V=i.querySelector("#action-unlink-decision-btn"),D=o.decision_id;Y&&(D?(Y.innerHTML='<div class="skeleton-text w-75"></div>',Ue.get(D).then(G=>{if(!i.isConnected||!Y)return;const ae=(G?.summary||G?.content||"").toString().trim().substring(0,80)+((G?.content||"").toString().length>80?"‚Ä¶":"");Y.innerHTML=`<p><a href="#" class="decision-link" data-decision-id="${de(String(D))}">${de(ae||`Decision #${String(D).substring(0,8)}`)}</a></p>`,Y.querySelector(".decision-link")&&d(Y.querySelector(".decision-link"),"click",ue=>{ue.preventDefault(),D&&a?.(D)})}).catch(()=>{Y.innerHTML=`<p><a href="#" class="decision-link" data-decision-id="${de(String(D))}">Decision #${String(D).substring(0,8)}</a></p>`}),W&&(W.textContent="Change"),V&&V.classList.remove("hidden")):(Y.innerHTML='<p class="text-muted">No decision linked</p>',W&&(W.textContent="Link decision"),V&&V.classList.add("hidden")))}const $=i.querySelector("#action-view-content"),w=i.querySelector("#action-edit-form"),y=i.querySelector("#action-comments-mount");if(y){const Y=Mu()?.id,W=wg({targetType:"action",targetId:String(t.id),projectId:Y||void 0});y.appendChild(W)}const S=i.querySelector("#action-similar-mount");S&&(async()=>{try{const Y=await Ee.getSimilar(t.id);if(!i.isConnected)return;if(Y.length===0){S.innerHTML='<span class="text-muted">No similar actions found. Rebuild RAG embeddings to enable.</span>';return}S.innerHTML=Y.map(W=>`
          <div class="action-similar-card" data-action-id="${de(String(W.id))}" role="button" tabindex="0">
            <span class="action-similar-status status-pill status-${(W.status||"pending").toLowerCase()}">${de(String(W.status||"pending").replace("_"," "))}</span>
            <span class="action-similar-task">${de((W.content||W.task||"").toString().trim().substring(0,80))}${(W.content||W.task||"").toString().length>80?"‚Ä¶":""}</span>
          </div>
        `).join(""),S.querySelectorAll(".action-similar-card").forEach(W=>{d(W,"click",()=>{const V=W.getAttribute("data-action-id"),D=Y.find(G=>String(G.id)===V);D&&s?.(D)})})}catch{S.innerHTML='<span class="text-muted">Could not load similar actions.</span>'}})(),(()=>{x();const Y=i.querySelector("#action-link-decision-btn"),W=i.querySelector("#action-unlink-decision-btn"),V=i.querySelector("#action-decision-picker"),D=i.querySelector("#action-decision-list"),G=i.querySelector("#action-decision-search"),ae=(ue,$e="")=>{if(!D)return;const Re=$e.trim().toLowerCase(),Mt=Re?ue.filter(et=>(et.content||"").toLowerCase().includes(Re)||(et.summary||"").toLowerCase().includes(Re)):ue;if(Mt.length===0){D.innerHTML='<div class="empty-state">No decisions match</div>';return}D.innerHTML=Mt.map(et=>{const ct=(et.summary||et.content||"").toString().trim().substring(0,60)+((et.content||"").toString().length>60?"‚Ä¶":"");return`<div class="action-decision-item" data-decision-id="${de(String(et.id))}" role="button" tabindex="0">${de(ct)}</div>`}).join(""),D.querySelectorAll(".action-decision-item").forEach(et=>{d(et,"click",async()=>{const ct=et.getAttribute("data-decision-id");if(!ct)return;const os={...o},Ua=et.textContent||`Decision #${ct}`;o.decision_id=ct;const qs=i.querySelector("#action-decision-display"),eo=i.querySelector("#action-link-decision-btn"),js=i.querySelector("#action-unlink-decision-btn");if(qs){qs.innerHTML=`<p><a href="#" class="decision-link" data-decision-id="${de(ct)}">${de(Ua)}</a></p>`;const Ft=qs.querySelector(".decision-link");Ft&&d(Ft,"click",Mr=>{Mr.preventDefault(),a?.(ct)})}eo&&(eo.textContent="Change"),js&&js.classList.remove("hidden"),V&&V.classList.add("hidden");try{const Ft=await Ee.update(o.id,{decision_id:ct});if(!i.isConnected)return;o=Ft,s?.(Ft),x(),m.success("Decision linked")}catch(Ft){console.error("Failed to link decision",Ft),o=os,x(),m.error(Ft.message||"Failed to link decision")}})})};Y&&d(Y,"click",async()=>{if(!V||!D)return;const ue=!V.classList.contains("hidden");if(V.classList.toggle("hidden",ue),!ue){D.innerHTML="Loading‚Ä¶";try{const $e=await Ue.getAll();ae($e,G?.value||"")}catch{D.innerHTML='<div class="empty-state">Failed to load decisions</div>'}}}),W&&d(W,"click",async()=>{try{const ue=await Ee.update(o.id,{decision_id:null});if(!i.isConnected)return;o=ue,s?.(ue),x(),m.success("Decision unlinked")}catch(ue){m.error(ue.message||"Failed to unlink")}}),G&&D&&G.addEventListener("input",()=>{Ue.getAll().then(ue=>ae(ue,G.value))}),document.addEventListener("click",ue=>{V&&!ue.target.closest("#action-decision-section")&&!V.classList.contains("hidden")&&V.classList.add("hidden")})})();const P=i.querySelector("#edit-action-btn");P&&d(P,"click",()=>{$.classList.add("hidden"),w.classList.remove("hidden")});const j=i.querySelector("#action-cancel-edit-btn");j&&d(j,"click",()=>{w.classList.add("hidden"),$.classList.remove("hidden")});const H=i.querySelector("#action-assignee-picker-trigger"),J=i.querySelector("#action-assignee-picker-dropdown"),B=i.querySelector("#action-assignee-picker-value"),Z=i.querySelector("#action-edit-assignee"),O=i.querySelector("#action-assignee-picker-list"),F=i.querySelector("#action-assignee-picker-search");if(H&&J&&O&&Z){let Y=[];const W=(V="")=>{const D=V?Y.filter(G=>(G.name||"").toLowerCase().includes(V.toLowerCase())||(G.role||"").toLowerCase().includes(V.toLowerCase())):Y;if(Y.length===0){O.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(D.length===0){O.innerHTML='<div class="empty-state">No contacts match</div>';return}O.innerHTML=D.map(G=>{const ae=G.photoUrl||G.avatarUrl;return`
            <div class="action-assignee-card-picker ${(Z?.value||"").trim()===(G.name||"").trim()?"selected":""}" data-contact-name="${de(G.name||"")}">
              <div class="action-assignee-card-avatar">${ae?`<img src="${de(ae)}" alt="" onerror="this.parentElement.innerHTML='${lt(G.name||"")}'">`:lt(G.name||"")}</div>
              <div class="action-assignee-card-info">
                <div class="action-assignee-card-name">${de(G.name||"")}</div>
                ${G.role?`<div class="action-assignee-card-role">${de(G.role)}</div>`:""}
              </div>
            </div>
          `}).join(""),O.querySelectorAll(".action-assignee-card-picker").forEach(G=>{d(G,"click",()=>{const ae=G.getAttribute("data-contact-name")||"";Z.value=ae,B&&(B.innerHTML=ae?de(ae):'<span class="text-muted">Select assignee...</span>'),J.classList.add("hidden")})})};d(H,"click",async V=>{V.stopPropagation();const D=!J.classList.contains("hidden");if(J.classList.toggle("hidden",D),!D&&Y.length===0){O.innerHTML='<div class="empty-state">Loading...</div>';try{const G=await Ne.getAll();if(!i.isConnected)return;Y=G?.contacts||[],W(F?.value||"")}catch{O.innerHTML='<div class="empty-state">Failed to load contacts</div>'}}else D||W(F?.value||"")}),F&&F.addEventListener("input",()=>W(F.value)),document.addEventListener("click",V=>{!V.target.closest(".action-assignee-picker-wrap")&&!J?.classList.contains("hidden")&&J.classList.add("hidden")})}const ee=i.querySelector("#action-requester-picker-trigger"),ie=i.querySelector("#action-requester-picker-dropdown"),oe=i.querySelector("#action-requester-picker-value"),me=i.querySelector("#action-edit-requester-contact-id"),ze=i.querySelector("#action-edit-requester-name"),re=i.querySelector("#action-requester-picker-list"),Le=i.querySelector("#action-requester-picker-search");if(ee&&ie&&re&&me&&ze){let Y=[];const W=(V="")=>{const D=V?Y.filter(G=>(G.name||"").toLowerCase().includes(V.toLowerCase())||(G.role||"").toLowerCase().includes(V.toLowerCase())):Y;if(Y.length===0){re.innerHTML='<div class="empty-state">Loading contacts...</div>';return}re.innerHTML='<div class="action-assignee-card-picker" data-contact-id="" data-contact-name=""><div class="action-assignee-card-info"><div class="action-assignee-card-name text-muted">No requester</div></div></div>'+D.map(G=>{const ae=G.photoUrl||G.avatarUrl;return`
            <div class="action-assignee-card-picker" data-contact-id="${de(G.id)}" data-contact-name="${de(G.name||"")}">
              <div class="action-assignee-card-avatar">${ae?`<img src="${de(ae)}" alt="" onerror="this.parentElement.innerHTML='${lt(G.name||"")}'">`:lt(G.name||"")}</div>
              <div class="action-assignee-card-info">
                <div class="action-assignee-card-name">${de(G.name||"")}</div>
                ${G.role?`<div class="action-assignee-card-role">${de(G.role)}</div>`:""}
              </div>
            </div>
          `}).join(""),re.querySelectorAll(".action-assignee-card-picker").forEach(G=>{d(G,"click",()=>{const ae=G.getAttribute("data-contact-id")||"",ue=G.getAttribute("data-contact-name")||"";me.value=ae,ze.value=ue,oe&&(oe.innerHTML=ue?de(ue):'<span class="text-muted">Select requester...</span>'),ie.classList.add("hidden")})})};d(ee,"click",async V=>{V.stopPropagation();const D=!ie.classList.contains("hidden");if(ie.classList.toggle("hidden",D),!D&&Y.length===0){re.innerHTML='<div class="empty-state">Loading...</div>';try{const G=await Ne.getAll();if(!i.isConnected)return;Y=G?.contacts||[],W(Le?.value||"")}catch{re.innerHTML='<div class="empty-state">Failed to load contacts</div>'}}else D||W(Le?.value||"")}),Le&&Le.addEventListener("input",()=>W(Le.value)),document.addEventListener("click",V=>{!V.target.closest(".action-requester-picker-wrap")&&!ie?.classList.contains("hidden")&&ie.classList.add("hidden")})}const le=i.querySelector("#action-edit-ai-suggest-btn"),te=i.querySelector("#action-edit-suggestions-panel"),ne=i.querySelector("#action-edit-assignee"),T=i.querySelector("#action-assignee-picker-value");le&&te&&d(le,"click",async()=>{const W=i.querySelector("#action-edit-task")?.value?.trim()||"";if(!W){m.warning("Enter task content first");return}const V=le;V.disabled=!0,V.innerHTML='<span class="spin">‚ãØ</span> Analyzing...',te.classList.remove("hidden"),te.innerHTML='<div class="suggestions-loading"><div class="loading-text">AI is suggesting assignees...</div></div>';try{if(X.length===0){const ae=await Ne.getAll();if(!i.isConnected)return;X=ae?.contacts||[]}const{suggested_assignees:D}=await Ee.suggest({content:W});if(!i.isConnected)return;D?.length?(te.innerHTML=`
            <div class="suggestions-header-sota"><div class="ai-badge">‚ú® AI Recommended</div></div>
            <div class="suggestions-list-sota">
              ${D.map(ae=>{const ue=At(ae.name),$e=we(ue),Re=ue?.role??ae.reason??"";return`
                <div class="action-suggestion-card suggestion-card-sota">
                  <div class="suggestion-card-left">
                    <div class="suggestion-avatar-sota">${$e?`<img src="${de($e)}" alt="" onerror="this.parentElement.innerHTML='${lt(ae.name)}'">`:lt(ae.name)}</div>
                    <div class="suggestion-score-ring" style="--score-color: ${(ae.score??0)>=70?"var(--success)":(ae.score??0)>=50?"var(--warning)":"var(--text-muted)"}">${ae.score??0}</div>
                    <div>
                      <div class="suggestion-name">${de(ae.name)}</div>
                      ${Re?`<div class="suggestion-reason">${de(Re)}</div>`:""}
                    </div>
                  </div>
                  <button type="button" class="btn-select-suggestion" data-assignee-name="${de(ae.name)}">Assign</button>
                </div>
              `}).join("")}
            </div>
            <div class="suggestions-footer"><button type="button" class="btn-link" id="action-edit-hide-suggest-btn">Close suggestions</button></div>
          `,te.querySelectorAll(".btn-select-suggestion").forEach(ae=>{const ue=ae.getAttribute("data-assignee-name")||"";ue&&d(ae,"click",()=>{ne&&(ne.value=ue),T&&(T.innerHTML=de(ue)),te.classList.add("hidden"),m.success(`Assignee set to ${ue}`)})})):te.innerHTML='<div class="no-suggestions"><div class="no-suggestions-text">No suggestions</div><button type="button" class="btn-link" id="action-edit-hide-suggest-btn">Close</button></div>';const G=te.querySelector("#action-edit-hide-suggest-btn");G&&d(G,"click",()=>{te.classList.add("hidden")})}catch{te.innerHTML='<div class="suggestions-error">Failed to get suggestions. <button type="button" class="btn-link" id="action-edit-hide-suggest-btn">Close</button></div>';const D=te.querySelector("#action-edit-hide-suggest-btn");D&&d(D,"click",()=>{te.classList.add("hidden")})}finally{V.disabled=!1,V.innerHTML='<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> AI suggest'}});const _=i.querySelector("#action-save-btn");_&&d(_,"click",async()=>{const Y=i.querySelector("#action-edit-task"),W=i.querySelector("#action-edit-status"),V=i.querySelector("#action-edit-priority"),D=i.querySelector("#action-edit-assignee"),G=i.querySelector("#action-edit-due"),ae=i.querySelector("#action-edit-requester-contact-id"),ue=i.querySelector("#action-edit-requester-name");if(!Y?.value.trim()){m.warning("Task is required");return}try{const $e=await Ee.update(t.id,{content:Y.value.trim(),status:W?.value,priority:V?.value,assignee:D?.value.trim()||void 0,due_date:G?.value||void 0,requested_by_contact_id:ae?.value?.trim()||void 0,requested_by:ue?.value?.trim()||void 0});if(!i.isConnected)return;m.success("Action updated"),s?.($e)}catch{m.error("Failed to update action")}});const A=i.querySelector("#delete-action-btn"),E=i.querySelector("#action-delete-in-edit-btn"),U=async()=>{const{confirm:Y}=await xe(async()=>{const{confirm:V}=await Promise.resolve().then(()=>In);return{confirm:V}},void 0);if(await Y("Are you sure you want to delete this action?",{title:"Delete Action",confirmText:"Delete",confirmClass:"btn-danger"}))try{if(await Ee.delete(t.id),!i.isConnected)return;m.success("Action deleted"),n()}catch{m.error("Failed to delete action")}};A&&d(A,"click",U),E&&d(E,"click",U);const M=i.querySelector(".doc-link[data-document-id]");M&&d(M,"click",Y=>{Y.preventDefault();const W=M.getAttribute("data-document-id");W&&window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:W}}))});const z=i.querySelector("#action-ai-suggest-btn"),q=i.querySelector("#action-suggestions-panel");z&&q&&d(z,"click",async()=>{z.disabled=!0,q.classList.remove("hidden"),q.innerHTML='<div class="suggestions-loading">Loading suggestions...</div>';try{const Y=uo(t);if(X.length===0){const D=await Ne.getAll();if(!i.isConnected)return;X=D?.contacts||[]}const{suggested_assignees:W}=await Ee.suggest({content:Y});if(!i.isConnected)return;W?.length?(q.innerHTML=`
            <div class="suggestions-header-sota">
              <div class="ai-badge">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Recommended
              </div>
            </div>
            <div class="suggestions-list-sota">
              ${W.map((D,G)=>{const ae=At(D.name),ue=we(ae),$e=ae?.role??D.reason??"";return`
                <div class="suggestion-card-sota" data-index="${G}">
                  <div class="suggestion-rank">#${G+1}</div>
                  <div class="suggestion-avatar-sota">${ue?`<img src="${de(ue)}" alt="" onerror="this.parentElement.innerHTML='${lt(D.name)}'">`:lt(D.name)}</div>
                  <div class="suggestion-info-sota">
                    <div class="suggestion-name-sota">${de(D.name)}</div>
                    ${$e?`<div class="suggestion-reason-sota">${de($e)}</div>`:""}
                  </div>
                  <div class="suggestion-score-sota" style="--score-color: ${(D.score??0)>=70?"var(--success)":(D.score??0)>=50?"var(--warning)":"var(--text-muted)"}">
                    <div class="score-ring">
                      <svg viewBox="0 0 36 36">
                        <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path class="score-fill" stroke-dasharray="${D.score??0}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                      </svg>
                      <div class="score-value">${D.score??0}%</div>
                    </div>
                    <div class="score-label">Match</div>
                  </div>
                  <button type="button" class="btn-select-suggestion" data-assignee-name="${de(D.name)}">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Assign
                  </button>
                </div>
              `}).join("")}
            </div>
            <div class="suggestions-footer"><button type="button" class="btn-link" id="action-hide-suggest-btn">Close suggestions</button></div>
          `,q.querySelectorAll(".btn-select-suggestion").forEach(D=>{d(D,"click",async()=>{const G=D.getAttribute("data-assignee-name")||"";if(G)try{const ae=await Ee.update(t.id,{assignee:G});if(!i.isConnected)return;m.success(`Assigned to ${G}`),s?.(ae),q.classList.add("hidden")}catch{m.error("Failed to assign")}})})):q.innerHTML='<div class="no-suggestions">No suggestions. <button type="button" class="btn-link" id="action-hide-suggest-btn">Close suggestions</button></div>';const V=q.querySelector("#action-hide-suggest-btn");V&&d(V,"click",()=>{q.classList.add("hidden")})}catch{q.innerHTML='<div class="suggestions-error">Failed to get suggestions. <button type="button" class="btn-link" id="action-hide-suggest-btn">Close</button></div>';const Y=q.querySelector("#action-hide-suggest-btn");Y&&d(Y,"click",()=>{q.classList.add("hidden")})}finally{z.disabled=!1}});const I=i.querySelector("#timeline-content");I&&k(I),h();let X=[];const se=i.querySelector("#action-contact-picker"),Se=i.querySelector("#action-contact-list"),fe=i.querySelector("#action-contact-search");function we(Y){if(!Y)return null;const W=Y;return W.photoUrl||W.avatarUrl||W.photo_url||W.avatar_url||null}const Te=(Y="")=>{if(!Se)return;const W=Y?X.filter(V=>(V.name||"").toLowerCase().includes(Y.toLowerCase())||(V.role||"").toLowerCase().includes(Y.toLowerCase())||(V.organization||"").toLowerCase().includes(Y.toLowerCase())):X;if(X.length===0){Se.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(W.length===0){Se.innerHTML='<div class="empty-state">No contacts match</div>';return}Se.innerHTML=W.map(V=>{const D=we(V);return`
          <div class="contact-card-picker ${(l||"").trim()===(V.name||"").trim()?"selected":""}" data-contact-name="${de(V.name||"")}">
            <div class="contact-avatar-picker">${D?`<img src="${de(D)}" alt="" onerror="this.parentElement.innerHTML='${lt(V.name||"")}'">`:lt(V.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${de(V.name||"")}</div>
              ${V.role?`<div class="contact-role-picker">${de(V.role)}</div>`:""}
            </div>
          </div>`}).join(""),Se.querySelectorAll(".contact-card-picker").forEach(V=>{d(V,"click",async()=>{const D=V.getAttribute("data-contact-name")||"";if(!D)return;const G=o.assignee,ae={...o};o.assignee=D;const ue=At(D);i.querySelector("#action-assigned-role"),i.querySelector("#action-assigned-avatar"),i.querySelector(".contact-name-lg"),i.querySelector("#action-current-assignment .assigned-contact-display");const $e=i.querySelector("#action-current-assignment");if($e){const Re=we(ue);$e.innerHTML=`
                  <div class="assigned-contact-display">
                    <div class="contact-avatar-lg" id="action-assigned-avatar">${Re?`<img src="${de(Re)}" alt="" onerror="this.parentElement.innerHTML='${lt(D)}'">`:lt(D)}</div>
                    <div class="contact-details">
                      <div class="contact-name-lg">${de(D)}</div>
                      <div class="contact-role-sm" id="action-assigned-role">${de(ue?.role||"‚Äî")}</div>
                    </div>
                    <button class="btn-change-assignment" id="action-change-assignee-btn" type="button">
                      <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                      Change
                    </button>
                  </div>
            `;const Mt=$e.querySelector("#action-change-assignee-btn");Mt&&d(Mt,"click",Oe)}se&&se.classList.add("hidden");try{const Re=await Ee.update(t.id,{assignee:D});if(!i.isConnected)return;m.success(`Assigned to ${D}`),o=Re,s?.(Re)}catch{if(console.error("Failed to save assignment"),m.error("Failed to save assignment. Reverting..."),o=ae,$e)if(G){const Re=At(G),Mt=we(Re);$e.innerHTML=`
                      <div class="assigned-contact-display">
                        <div class="contact-avatar-lg" id="action-assigned-avatar">${Mt?`<img src="${de(Mt)}" alt="" onerror="this.parentElement.innerHTML='${lt(G)}'">`:lt(G)}</div>
                        <div class="contact-details">
                          <div class="contact-name-lg">${de(G)}</div>
                          <div class="contact-role-sm" id="action-assigned-role">${de(Re?.role||"‚Äî")}</div>
                        </div>
                        <button class="btn-change-assignment" id="action-change-assignee-btn" type="button">
                          <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                          Change
                        </button>
                      </div>
                   `;const et=$e.querySelector("#action-change-assignee-btn");et&&d(et,"click",Oe)}else{$e.innerHTML=`
                      <div class="no-assignment">
                        <div class="no-assignment-icon">
                          <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                        </div>
                        <span>No one assigned</span>
                        <p class="no-assignment-hint">Use AI Suggest or choose manually</p>
                        <button class="btn-assign-now" id="action-show-picker-btn" type="button">Choose Manually</button>
                      </div>
                   `;const Re=$e.querySelector("#action-show-picker-btn");Re&&d(Re,"click",Oe)}}})})},Oe=()=>{se&&(se.classList.toggle("hidden"),!se.classList.contains("hidden")&&X.length===0?Ne.getAll().then(Y=>{i.isConnected&&(X=Y?.contacts||[],Te(fe?.value||""))}).catch(()=>{Se&&(Se.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):se.classList.contains("hidden")||Te(fe?.value||""),fe&&fe.focus())},an=i.querySelector("#action-change-assignee-btn"),xn=i.querySelector("#action-show-picker-btn");an&&se&&d(an,"click",Oe),xn&&se&&d(xn,"click",Oe),fe&&fe.addEventListener("input",()=>Te(fe.value));function At(Y){if(!Y||!X.length)return;const W=Y.trim().toLowerCase();if(!W)return;const V=X.find(ae=>(ae.name||"").trim().toLowerCase()===W);if(V)return V;const D=X.find(ae=>(ae.name||"").trim().toLowerCase().includes(W)||W.includes((ae.name||"").trim().toLowerCase()));if(D)return D;const G=X.find(ae=>(ae.aliases||[]).some(ue=>String(ue).trim().toLowerCase()===W));return G||X.find(ae=>(ae.aliases||[]).some(ue=>{const $e=String(ue).trim().toLowerCase();return $e.includes(W)||W.includes($e)}))}function zt(Y,W){if(!Y.length)return;if(W.requested_by_contact_id){const ue=Y.find($e=>String($e.id)===String(W.requested_by_contact_id));if(ue)return ue}const V=(W.requested_by||"").trim();if(!V)return;const D=V.toLowerCase(),G=Y.find(ue=>(ue.name||"").trim().toLowerCase()===D);return G||Y.find(ue=>(ue.name||"").trim().toLowerCase().includes(D)||D.includes((ue.name||"").trim().toLowerCase()))}return Ne.getAll().then(Y=>{if(!i.isConnected)return;X=Y?.contacts||[];const W=At(l),V=i.querySelector("#action-assigned-role");V&&(V.textContent=W?.role??"‚Äî");const D=i.querySelector("#action-assigned-avatar");if(D&&l){const ae=we(W);if(ae){D.innerHTML="";const ue=document.createElement("img");ue.src=ae,ue.alt="",ue.onerror=()=>{D.textContent=lt(l)},D.appendChild(ue)}}const G=i.querySelector("#action-requester-display");if(G&&(t.requested_by||t.requested_by_contact_id)){const ae=zt(X,t);if(ae){const ue=we(ae),$e=ae.name||t.requested_by||"‚Äî";G.innerHTML=`
          <p class="requested-by-label">Requested by</p>
          <div class="assigned-contact-display requester-contact-card">
            <div class="contact-avatar-lg">${ue?`<img src="${de(ue)}" alt="" onerror="this.parentElement.textContent='${lt($e)}'">`:lt($e)}</div>
            <div class="contact-details">
              <div class="contact-name-lg">${de($e)}</div>
              ${ae.role?`<div class="contact-role-sm">${de(ae.role)}</div>`:""}
            </div>
          </div>
        `}}}).catch(()=>{}),i}const d4=Object.freeze(Object.defineProperty({__proto__:null,createActionDetailView:Ho},Symbol.toStringTag,{value:"Module"}));function Rc(e,t,n){return{action:n,onClose:()=>{e.innerHTML="",e.appendChild(Bo(t))},onUpdate:s=>{e.innerHTML="",s?e.appendChild(Ho(Rc(e,t,s))):e.appendChild(Bo(t))}}}let gi="all",qa="",Ti="by_sprint";function Bo(e={}){const t=b("div",{className:"sot-panel actions-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Actions</h2>
        <span class="panel-count" id="actions-count">0</span>
      </div>
      <div class="panel-actions">
        <div class="view-mode-tabs" role="tablist">
          <button type="button" class="view-mode-tab" data-view="list" title="Flat list">List</button>
          <button type="button" class="view-mode-tab active" data-view="by_sprint" title="Group by sprint">Sprints</button>
          <button type="button" class="view-mode-tab" data-view="by_story" title="Group by user story">Stories</button>
        </div>
        <select id="actions-sprint-filter" class="filter-select" title="Sprint (List view)">
          <option value="">All sprints</option>
        </select>
        <select id="actions-filter" class="filter-select">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
          <option value="overdue">Overdue</option>
        </select>
        <button class="btn btn-outline-primary btn-sm" id="create-sprint-btn" title="Create sprint and generate tasks from emails/transcripts">Sprint</button>
        <button class="btn btn-primary btn-sm" id="add-action-btn">+ Add</button>
      </div>
    </div>
    <div id="actions-report-strip" class="actions-report-strip hidden"></div>
    <div id="actions-sprint-detail" class="actions-sprint-detail hidden"></div>
    <div class="panel-content" id="actions-content">
      <div class="loading">Loading actions...</div>
    </div>
    <div id="removed-actions-container" class="removed-actions-container hidden"></div>
  `,(async()=>{const o=t.querySelector("#actions-sprint-filter");if(o)try{(await Xi()).forEach(r=>{const c=document.createElement("option");c.value=r.id,c.textContent=r.name,r.id===qa&&(c.selected=!0),o.appendChild(c)}),d(o,"change",()=>{qa=o.value||"",us(t,e)})}catch{}})(),t.querySelectorAll(".view-mode-tab").forEach(o=>{d(o,"click",()=>{const i=o.getAttribute("data-view");!i||i===Ti||(Ti=i,t.querySelectorAll(".view-mode-tab").forEach(r=>r.classList.remove("active")),o.classList.add("active"),us(t,e))})});const n=t.querySelector("#actions-filter");d(n,"change",()=>{gi=n.value,us(t,e)});const s=t.querySelector("#create-sprint-btn");s&&d(s,"click",()=>{JC({onSuccess:()=>us(t,e)})});const a=t.querySelector("#add-action-btn");return a&&d(a,"click",()=>{Ea({mode:"create",onSave:()=>us(t,e)})}),us(t,e),Hl(t,e),$g(t),t}async function xg(e){const t=e.querySelector("#actions-sprint-detail");if(t){if(!qa){t.classList.add("hidden"),t.innerHTML="";return}try{const n=await RC(qa);if(!n){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden");const s=n.start_date?new Date(n.start_date).toLocaleDateString():"‚Äî",a=n.end_date?new Date(n.end_date).toLocaleDateString():"‚Äî";t.innerHTML=`
      <div class="sprint-detail-header">
        <div class="sprint-detail-title">${_t(n.name)}</div>
        <div class="sprint-detail-meta">${s} ‚Äì ${a}</div>
        ${n.context?`<div class="sprint-detail-context">${_t(n.context)}</div>`:""}
        <button type="button" class="btn btn-outline-primary btn-sm sprint-report-btn" id="sprint-report-open-btn" data-sprint-id="${_t(n.id)}" data-sprint-name="${_t(n.name)}">Sprint report</button>
      </div>
    `;const o=t.querySelector("#sprint-report-open-btn");o&&d(o,"click",()=>{const i=o.getAttribute("data-sprint-id"),r=o.getAttribute("data-sprint-name")||void 0;i&&n4({sprintId:i,sprintName:r||void 0,onClose:()=>{}})})}catch{t.classList.add("hidden"),t.innerHTML=""}}}async function $g(e){const t=e.querySelector("#actions-report-strip");if(t)try{const n=await Ee.getReport(),s=n.by_status||{},a=n.by_sprint||{},o=[];["pending","in_progress","completed","cancelled"].forEach(r=>{const c=s[r]??0;c>0&&o.push(`${r.replace("_"," ")}: ${c}`)});const i=Object.entries(a).filter(([r])=>r!=="(no sprint)").map(([,r])=>`${r.name}: ${r.count}`);if(i.length>0&&o.push(`Sprints: ${i.join(" ¬∑ ")}`),o.length===0){t.classList.add("hidden"),t.innerHTML="";return}t.classList.remove("hidden"),t.innerHTML=`<span class="actions-report-label">By status:</span> ${o.join(" ¬∑ ")}`}catch{t.classList.add("hidden"),t.innerHTML=""}}async function Hl(e,t){const n=e.querySelector("#removed-actions-container");if(n)try{const s=await Ee.getDeletedActions();if(s.length===0){n.classList.add("hidden"),n.innerHTML="";return}n.classList.remove("hidden");const a=(o,i)=>o.length>i?o.slice(0,i)+"‚Ä¶":o;n.innerHTML=`
      <div class="removed-actions-section">
        <div class="removed-actions-header section-header-sota">
          <h3>Removed actions</h3>
          <span class="panel-count removed-count">${s.length}</span>
        </div>
        <p class="removed-actions-hint">Restore to undo; action will be synced back to the graph.</p>
        <div class="removed-actions-list">
          ${s.map(o=>`
            <div class="removed-action-item" data-action-id="${o.id}">
              <div class="removed-action-content">${_t(a(o.task||o.content||"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(o=>{const r=o.closest(".removed-action-item")?.getAttribute("data-action-id");r&&d(o,"click",async()=>{try{await Ee.restoreAction(r),m.success("Action restored"),await us(e,t),Hl(e,t)}catch{m.error("Failed to restore action")}})})}catch{n.classList.add("hidden"),n.innerHTML=""}}async function us(e,t){const n=e.querySelector("#actions-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=gi==="all"||gi==="overdue"?void 0:gi,a=Ti==="list"&&qa||void 0;let o=await Ee.getAll(s,a);gi==="overdue"&&(o=o.filter(i=>Ee.isOverdue(i))),ce.setActions(o),Ti==="by_sprint"?await u4(n,o,e,t):Ti==="by_story"?await p4(n,o,e,t):f4(n,o,t),h4(e,o.length),Hl(e,t),$g(e),xg(e)}catch{n.innerHTML='<div class="error">Failed to load actions</div>'}}async function u4(e,t,n,s){const a=await Xi(),o=new Map,i=[];for(const l of t){const u=l.sprint_id;u?(o.has(u)||o.set(u,[]),o.get(u).push(l)):i.push(l)}const r=a.filter(l=>o.has(l.id));e.innerHTML="";for(const l of r){const u=o.get(l.id)||[],p=Ro(`${l.name} (${u.length})`,u,n,s,()=>{qa=l.id,xg(n)});e.appendChild(p)}const c=Ro("Tasks without sprint",i,n,s);e.appendChild(c)}async function p4(e,t,n,s){const a=await Ee.getUserStories(),o=new Map,i=[];for(const c of t){const l=c.parent_story_id;l?(o.has(l)||o.set(l,[]),o.get(l).push(c)):i.push(c)}e.innerHTML="";for(const c of a){const l=o.get(c.id)||[];if(l.length===0&&!o.has(c.id))continue;const u=c.story_points!=null?`${c.title} (${c.story_points} pt)`:c.title,p=Ro(`${u} ‚Äî ${l.length} tasks`,l,n,s);e.appendChild(p)}const r=Ro("Tasks without story",i,n,s);e.appendChild(r)}function Ro(e,t,n,s,a){const o=b("div",{className:"actions-group"}),i=b("div",{className:"actions-group-header"});i.innerHTML=`<h3 class="actions-group-title">${_t(e)}</h3><span class="actions-group-count">${t.length}</span>`,a&&(i.style.cursor="pointer"),a&&d(i,"click",a),o.appendChild(i);const r=b("div",{className:"actions-group-list"});return o.appendChild(r),t.length===0?r.innerHTML='<p class="actions-group-empty">No tasks</p>':Sg(r,t,s),o}function m4(e,t){if(!(!t||!e.length))return e.find(n=>n.id&&String(n.id)===String(t))}function qu(e,t){if(!t||!e.length)return;const n=t.trim().toLowerCase();if(!n)return;const s=e.find(i=>(i.name||"").trim().toLowerCase()===n);if(s)return s;const a=e.find(i=>(i.name||"").trim().toLowerCase().includes(n)||n.includes((i.name||"").trim().toLowerCase()));return a||e.find(i=>(i.aliases||[]).some(r=>String(r).trim().toLowerCase()===n))||e.find(i=>(i.aliases||[]).some(r=>{const c=String(r).trim().toLowerCase();return c.includes(n)||n.includes(c)}))}function ju(e){return e&&(e.photoUrl||e.avatarUrl||e.photo_url||e.avatar_url)||null}function po(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Sg(e,t,n){if(t.length===0)return;const s=e.closest&&e.closest(".actions-panel"),a=ce.getState().contacts||[],o={high:"#ea580c",medium:"#ca8a04",low:"#16a34a"};e.innerHTML=t.map(i=>g4(i,a,o)).join(""),v4(e,t,n,s||void 0)}function g4(e,t,n){const s=Ee.isOverdue(e),a=(e.priority||"medium").toLowerCase(),o=n[a]??n.medium,i=(e.content??e.task??"").trim(),r=e.assignee??e.owner??"",c=r?qu(t,r):void 0,l=ju(c),u=r?`
    <div class="assignee-chip">
      <div class="assignee-avatar">${l?`<img src="${_t(l)}" alt="${_t(r)}" onerror="this.parentElement.innerHTML='${po(r)}'">`:po(r)}</div>
      <div class="assignee-info">
        <span class="assignee-name">${_t(r)}</span>
        ${c?.role?`<span class="assignee-role">${_t(c.role)}</span>`:""}
      </div>
    </div>
  `:"",p=e.requested_by??"",g=e.requested_by_contact_id??"",f=g?m4(t,g):p?qu(t,p):void 0,h=f?.name??p,k=ju(f),C=h||g?`
    <div class="requester-chip card-source-chip">
      <span class="requester-label">Requested by</span>
      <div class="assignee-chip requester-chip-inner">
        <div class="assignee-avatar">${k?`<img src="${_t(k)}" alt="${_t(h||"")}" onerror="this.parentElement.innerHTML='${po(h||"?")}'">`:po(h||"?")}</div>
        <span class="assignee-name">${_t(h||"Unknown")}</span>
      </div>
    </div>
  `:"",x=e.due_date?`<span class="card-source-chip">Due: ${Os(e.due_date)}</span>`:'<span class="card-source-chip text-muted">No due date</span>';return`
    <div class="action-card-sota question-card-sota ${s?"overdue":""}" data-id="${e.id}" style="--action-priority-bar: ${o}">
      <div class="card-priority-bar action-priority-bar"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="status-pill status-${(e.status||"pending").toLowerCase()}">${_t(String(e.status).replace("_"," "))}</span>
            ${e.priority?`<span class="priority-pill priority-${e.priority}">${_t(e.priority)}</span>`:""}
            ${s?'<span class="status-pill overdue">OVERDUE</span>':""}
          </div>
          <span class="card-timestamp">${Ce(e.created_at)}</span>
        </div>
        <div class="card-question-text">${_t(i)}</div>
        <div class="card-bottom-row">
          <div class="card-requester">
            ${u}
            ${C}
            ${x}
          </div>
          <div class="card-assignment">
            <button type="button" class="btn-link action-view-link">View</button>
          </div>
        </div>
      </div>
    </div>
  `}function v4(e,t,n,s){const a=()=>s?us(s,n):void 0;e.querySelectorAll(".action-card-sota").forEach(o=>{d(o,"click",r=>{if(r.target.closest(".card-assignment"))return;const c=o.getAttribute("data-id"),l=t.find(u=>String(u.id)===c);if(l)if(n.useDetailView&&n.containerElement){const u=n.containerElement;u.innerHTML="",u.appendChild(Ho(Rc(u,n,l)))}else n.onActionClick?n.onActionClick(l):Ea({mode:"edit",action:l,onSave:a})});const i=o.querySelector(".action-view-link");i&&d(i,"click",r=>{r.stopPropagation();const c=o.getAttribute("data-id"),l=t.find(u=>String(u.id)===c);if(l)if(n.useDetailView&&n.containerElement){const u=n.containerElement;u.innerHTML="",u.appendChild(Ho(Rc(u,n,l)))}else n.onActionClick?n.onActionClick(l):Ea({mode:"edit",action:l,onSave:a})})})}function f4(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No actions found</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Action</button>
      </div>
    `;const s=e.querySelector("#empty-add-btn");s&&d(s,"click",()=>{Ea({mode:"create"})});return}Sg(e,t,n)}function h4(e,t){const n=e.querySelector("#actions-count");n&&(n.textContent=String(t))}function _t(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function mo(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Pu(e){if(!e)return null;const t=e;return t.photoUrl||t.avatarUrl||t.photo_url||t.avatar_url||null}const Un="decision-modal";function Ra(e){const{mode:t,decision:n,onSave:s,onDelete:a}=e,o=t==="edit"&&n?.id,i=t==="view",r=document.querySelector(`[data-modal-id="${Un}"]`);r&&r.remove();const c=b("div",{className:"decision-modal-content"});if(i&&n){const p=n.content??n.decision,g=n.impact,f=n.summary;c.innerHTML=`
      <div class="decision-view">
        <div class="decision-meta">
          <span class="status-badge ${n.status}">${n.status}</span>
          ${g?`<span class="impact-badge impact-${g}">${$t(g)} impact</span>`:""}
          <span class="decision-date">${Ce(n.madeAt)}</span>
        </div>
        
        <div class="decision-text-large">
          ${$t(p)}
        </div>
        
        ${f?`
          <div class="decision-section decision-summary">
            <h4>Summary</h4>
            <p>${$t(f)}</p>
          </div>
        `:""}
        
        ${n.rationale?`
          <div class="decision-section">
            <h4>Rationale</h4>
            <p>${$t(n.rationale)}</p>
          </div>
        `:""}
        
        ${n.madeBy?`
          <div class="decision-made-by">
            <strong>Decision made by:</strong> ${$t(n.madeBy)}
          </div>
        `:""}
      </div>
    `}else{let p=function(B){if(!B||!y.length)return;const Z=B.trim().toLowerCase();if(!Z)return;const O=y.find(ee=>(ee.name||"").trim().toLowerCase()===Z);return O||y.find(ee=>(ee.aliases||[]).some(ie=>String(ie).trim().toLowerCase()===Z))},g=function(B){if(!S||!P)return;if(P.value=B,B){const F=p(B),ee=Pu(F);S.innerHTML=`
          <div class="assigned-contact-display">
            <div class="contact-avatar-lg">${ee?`<img src="${$t(ee)}" alt="" onerror="this.parentElement.innerHTML='${mo(B)}'">`:mo(B)}</div>
            <div class="contact-details">
              <div class="contact-name-lg">${$t(B)}</div>
              ${F?.role?`<div class="contact-role-sm">${$t(F.role)}</div>`:""}
            </div>
            <button type="button" class="btn-change-assignment" id="decision-modal-change-owner-btn">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
              Change
            </button>
          </div>`}else S.innerHTML=`
          <div class="no-assignment">
            <span>No owner</span>
            <button type="button" class="btn-assign-now" id="decision-modal-choose-owner-btn">Choose</button>
          </div>`;const Z=S.querySelector("#decision-modal-change-owner-btn"),O=S.querySelector("#decision-modal-choose-owner-btn");Z&&d(Z,"click",f),O&&d(O,"click",f)},f=function(){if(!j)return;const B=j.classList.contains("hidden");j.classList.toggle("hidden",!B),B&&y.length===0?Ne.getAll().then(Z=>{y=Z?.contacts||[],h(J?.value||"")}).catch(()=>{H&&(H.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):B&&h(J?.value||""),J&&J.focus()},h=function(B){if(!H)return;const Z=B?y.filter(F=>(F.name||"").toLowerCase().includes(B.toLowerCase())||(F.role||"").toLowerCase().includes(B.toLowerCase())):y;if(y.length===0){H.innerHTML='<div class="empty-state">Loading...</div>';return}if(Z.length===0){H.innerHTML='<div class="empty-state">No contacts match</div>';return}const O=(P?.value||"").trim();H.innerHTML=Z.map(F=>{const ee=Pu(F);return`
            <div class="contact-card-picker ${O===(F.name||"").trim()?"selected":""}" data-contact-name="${$t(F.name||"")}">
              <div class="contact-avatar-picker">${ee?`<img src="${$t(ee)}" alt="" onerror="this.parentElement.innerHTML='${mo(F.name||"")}'">`:mo(F.name||"")}</div>
              <div class="contact-info-picker">
                <div class="contact-name-picker">${$t(F.name||"")}</div>
                ${F.role?`<div class="contact-role-picker">${$t(F.role)}</div>`:""}
              </div>
            </div>`}).join(""),H.querySelectorAll(".contact-card-picker").forEach(F=>{d(F,"click",()=>{const ee=F.getAttribute("data-contact-name")||"";ee&&(g(ee),j&&j.classList.add("hidden"))})})};const k=n?.content??n?.decision??"",C=n?.impact??"",x=n?.summary??"";c.innerHTML=`
      <form id="decision-form" class="decision-form">
        <div class="form-group">
          <label for="decision-text">Decision *</label>
          <textarea id="decision-text" rows="3" required 
                    placeholder="What was decided?">${$t(k)}</textarea>
        </div>
        
        <div class="form-group">
          <label for="decision-rationale">Rationale</label>
          <div class="form-group-with-action">
            <textarea id="decision-rationale" rows="2" 
                      placeholder="Why was this decision made?">${$t(n?.rationale||"")}</textarea>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="decision-impact">Impact</label>
            <select id="decision-impact">
              <option value="">‚Äî</option>
              <option value="low" ${C==="low"?"selected":""}>Low</option>
              <option value="medium" ${C==="medium"||!C?"selected":""}>Medium</option>
              <option value="high" ${C==="high"?"selected":""}>High</option>
            </select>
          </div>
          <div class="form-group">
            <label for="decision-summary">Summary (one line)</label>
            <input type="text" id="decision-summary" 
                   value="${$t(x)}" 
                   placeholder="One-line summary for lists/reports">
          </div>
        </div>
        
        <div class="form-row form-row-actions">
          <button type="button" class="btn-ai-suggest btn-sm" id="decision-ai-suggest-btn" title="Suggest rationale, impact and summary from decision text">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            AI suggest
          </button>
          <span class="form-hint" id="decision-suggest-hint"></span>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="decision-status">Status</label>
            <select id="decision-status">
              <option value="proposed" ${n?.status==="proposed"||!n?"selected":""}>Proposed</option>
              <option value="approved" ${n?.status==="approved"?"selected":""}>Approved</option>
              <option value="rejected" ${n?.status==="rejected"?"selected":""}>Rejected</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Made By</label>
            <input type="hidden" id="decision-by" value="${$t(n?.madeBy||"")}">
            <div id="decision-made-by-display" class="current-assignment-card decision-modal-owner-card"></div>
            <div id="decision-modal-contact-picker" class="contact-picker-sota contact-picker-mt hidden">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="decision-modal-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="decision-modal-contact-list" class="contact-list-grid">Loading...</div>
            </div>
          </div>
        </div>
      </form>
    `;const $=c.querySelector("#decision-ai-suggest-btn"),w=c.querySelector("#decision-suggest-hint");$&&d($,"click",async()=>{const B=O=>c.querySelector(`#${O}`)?.value?.trim()||"",Z=B("decision-text");if(!Z){m.warning("Enter decision text first");return}$.disabled=!0,w&&(w.textContent="Asking AI‚Ä¶");try{const O=await Ue.suggest(Z,B("decision-rationale"));c.querySelector("#decision-rationale").value=O.rationale||"",c.querySelector("#decision-impact").value=O.impact||"medium",c.querySelector("#decision-summary").value=O.summary||"",w&&(w.textContent=O.impact_summary?`Impact: ${O.impact_summary}`:"Done")}catch{w&&(w.textContent=""),m.error("AI suggest failed")}finally{$.disabled=!1}});let y=[];const S=c.querySelector("#decision-made-by-display"),P=c.querySelector("#decision-by"),j=c.querySelector("#decision-modal-contact-picker"),H=c.querySelector("#decision-modal-contact-list"),J=c.querySelector("#decision-modal-contact-search");Ne.getAll().then(B=>{y=B?.contacts||[],g(n?.madeBy||"")}).catch(()=>{g(n?.madeBy||"")}),J&&J.addEventListener("input",()=>h(J.value))}const l=b("div",{className:"modal-footer"});if(i&&n){if(n.status==="proposed"){const f=b("button",{className:"btn btn-success",textContent:"Approve"}),h=b("button",{className:"btn btn-danger",textContent:"Reject"});d(f,"click",()=>Du(String(n.id),"approved")),d(h,"click",()=>Du(String(n.id),"rejected")),l.appendChild(h),l.appendChild(f)}const p=b("button",{className:"btn btn-primary",textContent:"Edit"}),g=b("button",{className:"btn btn-secondary",textContent:"Close"});d(g,"click",()=>K(Un)),d(p,"click",()=>{K(Un),Ra({...e,mode:"edit"})}),l.appendChild(g),l.appendChild(p)}else{const p=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),g=b("button",{className:"btn btn-primary",textContent:o?"Save Changes":"Create Decision"});if(d(p,"click",()=>K(Un)),d(g,"click",async()=>{const f=c.querySelector("#decision-form");if(!f.checkValidity()){f.reportValidity();return}const h=x=>c.querySelector(`#${x}`)?.value.trim()||"",k={id:n?.id||`dec-${Date.now()}`,decision:h("decision-text"),rationale:h("decision-rationale")||void 0,status:h("decision-status"),madeBy:h("decision-by")||void 0,madeAt:n?.madeAt||new Date().toISOString(),impact:h("decision-impact")||void 0,summary:h("decision-summary")||void 0};g.disabled=!0,g.textContent="Saving...";const C={content:k.decision,decision:k.decision,rationale:k.rationale,status:k.status,made_by:k.madeBy,impact:k.impact,summary:k.summary};try{if(o)await v.put(`/api/decisions/${n.id}`,C),m.success("Decision updated");else{const x=await v.post("/api/decisions",C);k.id=x.data.id,m.success("Decision recorded")}s?.(k),K(Un)}catch{}finally{g.disabled=!1,g.textContent=o?"Save Changes":"Create Decision"}}),o){const f=b("button",{className:"btn btn-danger",textContent:"Delete"});d(f,"click",async()=>{const{confirm:h}=await xe(async()=>{const{confirm:C}=await Promise.resolve().then(()=>In);return{confirm:C}},void 0);if(await h("Are you sure you want to delete this decision?",{title:"Delete Decision",confirmText:"Delete",confirmClass:"btn-danger"}))try{await v.delete(`/api/decisions/${n.id}`),m.success("Decision deleted"),a?.(String(n.id)),K(Un)}catch{}}),l.appendChild(f)}l.appendChild(p),l.appendChild(g)}const u=Pe({id:Un,title:i?"Decision Details":o?"Edit Decision":"Record Decision",content:c,size:"md",footer:l});document.body.appendChild(u),De(Un)}async function Du(e,t,n){try{await v.patch(`/api/decisions/${e}`,{status:t}),m.success(`Decision ${t}`),K(Un)}catch{}}function $t(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function St(e){return e.trim().split(/\s+/).map(t=>t[0]).join("").toUpperCase().substring(0,2)}function ye(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Kr(e){if(!e)return"‚Äî";try{return Ts(e)}catch{return e}}function Bl(e){const{decision:t,onClose:n,onUpdate:s,onDecisionClick:a,onActionClick:o}=e,i=b("div",{className:"decision-detail-view question-detail-view"});i.innerHTML=`
    <div class="question-detail-header decision-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Decisions</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Decision #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        <span class="status-badge status-${(t.status||"active").toLowerCase()}">${ye(String(t.status))}</span>
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content decision-detail-content">
      <div id="decision-view-content">
      <section class="detail-section decision-main">
        <div class="question-badges decision-badges">
          ${t.impact?`<span class="priority-pill impact-${t.impact}">${ye(t.impact)} impact</span>`:""}
          ${t.generation_source?`<span class="status-pill">${ye(t.generation_source)}</span>`:""}
          <span class="question-date decision-date">Created ${Ce(t.created_at)}</span>
        </div>
        <h2 class="question-text decision-content-text" id="decision-view-content-text">${ye(t.content)}</h2>
      </section>

      <div class="detail-columns">
        <div class="detail-column-left">
          <section class="detail-section">
            <div class="section-header-sota">
              <h3>Rationale / Context</h3>
              <span class="section-subtitle">Why was this decision made?</span>
              <button type="button" class="btn-ai-suggest" id="decision-rationale-ai-suggest-btn" title="Suggest rationale, impact and summary from decision text">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Suggest
              </button>
            </div>
            <div id="decision-view-rationale">${t.rationale||t.context?`<p class="decision-rationale">${ye(t.rationale||t.context||"")}</p>`:'<p class="text-muted">No rationale recorded</p>'}</div>
            <div id="decision-suggestions-panel" class="suggestions-panel-sota decision-suggestions-panel hidden gm-mt-2"></div>
          </section>

          <section class="detail-section" id="decision-owner-section">
            <div class="section-header-sota">
              <h3>
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Owner / Made by
                <span class="section-subtitle">Who made this decision?</span>
              </h3>
              <button type="button" class="btn-ai-suggest" id="decision-owner-ai-suggest-btn" title="Suggest owner from decision content">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Suggest
              </button>
            </div>

            <div id="decision-current-owner" class="current-assignment-card">
              ${t.made_by||t.owner?`
                <div class="assigned-contact-display">
                  <div class="contact-avatar-lg" id="decision-owner-avatar">${St(t.made_by||t.owner||"")}</div>
                  <div class="contact-details">
                    <div class="contact-name-lg">${ye(t.made_by||t.owner||"")}</div>
                    <div class="contact-role-sm" id="decision-owner-role">‚Äî</div>
                  </div>
                  <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    Change
                  </button>
                </div>
              `:`
                <div class="no-assignment">
                  <div class="no-assignment-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  </div>
                  <span>No owner</span>
                  <p class="no-assignment-hint">Choose from contacts</p>
                  <button class="btn-assign-now" id="decision-show-owner-picker-btn" type="button">Choose</button>
                </div>
              `}
            </div>

            <div id="decision-contact-picker" class="contact-picker-sota hidden">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="decision-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="decision-contact-list" class="contact-list-grid">Loading...</div>
            </div>

            <div id="decision-owner-suggestions-panel" class="suggestions-panel-sota decision-owner-suggestions-panel hidden gm-mt-2"></div>

            ${t.approved_by?`<p class="text-muted gm-mt-2">Approved by: ${ye(t.approved_by)}</p>`:""}
            ${t.decided_at?`<p class="text-muted">Decided: ${Kr(t.decided_at)}</p>`:""}
          </section>

          <section class="detail-section">
            <div class="section-header">
              <h3>Source</h3>
            </div>
            ${t.source_file?`<p class="source-file">${ye(t.source_file)}</p>`:""}
            ${t.source_document_id?`
              <p class="source-doc">
                <a href="#" class="doc-link" data-document-id="${ye(String(t.source_document_id))}">View source document</a>
              </p>
            `:""}
            ${!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
          </section>
        </div>

        <div class="detail-column-right">
          <section class="detail-section metadata-section">
            <div class="section-header">
              <h3>Metadata</h3>
            </div>
            <dl class="metadata-list">
              <dt>Created</dt>
              <dd>${Kr(t.created_at)}</dd>
              ${t.updated_at?`<dt>Updated</dt><dd>${Kr(t.updated_at)}</dd>`:""}
            </dl>
          </section>

          <section class="detail-section" id="decision-implementing-tasks-section">
            <div class="section-header">
              <h3>Implementing tasks</h3>
            </div>
            <div id="decision-implementing-tasks-list" class="decision-implementing-tasks-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>

          <section class="detail-section decision-timeline-section">
            <div class="section-header">
              <h3>Timeline</h3>
            </div>
            <div id="decision-timeline-list" class="decision-timeline-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>

          <section class="detail-section decision-similar-section">
            <div class="section-header">
              <h3>Similar decisions</h3>
            </div>
            <div id="decision-similar-list" class="decision-similar-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>
        </div>
      </div>

      <div class="detail-actions">
        <button type="button" class="btn btn-secondary" id="edit-decision-btn">Edit</button>
        <button type="button" class="btn btn-danger" id="delete-decision-btn">Delete</button>
      </div>
      </div>

      <div id="decision-edit-form" class="decision-detail-edit-form hidden">
        <form id="decision-inline-form" class="decision-form">
          <div class="form-group">
            <label for="decision-edit-content">Decision *</label>
            <textarea id="decision-edit-content" rows="3" required placeholder="What was decided?">${ye(t.content||"")}</textarea>
          </div>
          <div class="form-group">
            <div class="gm-flex gm-flex-center gm-justify-between gm-flex-wrap gm-gap-2 gm-mb-2">
              <label for="decision-edit-rationale" class="gm-mb-0">Rationale</label>
              <button type="button" class="btn-ai-suggest btn-sm" id="decision-edit-ai-suggest-btn" title="Suggest rationale, impact and summary from decision text">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI suggest
              </button>
            </div>
            <textarea id="decision-edit-rationale" rows="2" placeholder="Why was this decision made?">${ye(t.rationale||t.context||"")}</textarea>
          </div>
          <div id="decision-edit-suggestions-panel" class="suggestions-panel-sota hidden gm-mb-3"></div>
          <div class="form-row">
            <div class="form-group">
              <label for="decision-edit-impact">Impact</label>
              <select id="decision-edit-impact">
                <option value="low" ${t.impact==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.impact==="medium"||!t.impact?"selected":""}>Medium</option>
                <option value="high" ${t.impact==="high"?"selected":""}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="decision-edit-summary">Summary (one line)</label>
              <input type="text" id="decision-edit-summary" value="${ye(t.summary||"")}" placeholder="One-line summary for lists/reports">
            </div>
            <div class="form-group">
              <label for="decision-edit-status">Status</label>
              <select id="decision-edit-status">
                <option value="proposed" ${t.status==="proposed"||!t.status?"selected":""}>Proposed</option>
                <option value="approved" ${t.status==="approved"?"selected":""}>Approved</option>
                <option value="rejected" ${t.status==="rejected"?"selected":""}>Rejected</option>
                <option value="deferred" ${t.status==="deferred"?"selected":""}>Deferred</option>
                <option value="active" ${t.status==="active"?"selected":""}>Active</option>
                <option value="superseded" ${t.status==="superseded"?"selected":""}>Superseded</option>
                <option value="revoked" ${t.status==="revoked"?"selected":""}>Revoked</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Made by</label>
            <input type="hidden" id="decision-edit-made-by" value="${ye(t.made_by||t.owner||"")}">
            <div id="decision-edit-owner-display" class="current-assignment-card decision-edit-owner-card"></div>
            <div id="decision-edit-contact-picker" class="contact-picker-sota hidden gm-mt-2">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="decision-edit-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="decision-edit-contact-list" class="contact-list-grid">Loading...</div>
            </div>
          </div>
        </form>
        <div class="detail-actions">
          <button type="button" class="btn btn-primary" id="decision-save-btn">Save</button>
          <button type="button" class="btn btn-secondary" id="decision-cancel-edit-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="decision-delete-in-edit-btn">Delete</button>
        </div>
      </div>
    </div>
  `;const r=i.querySelector("#back-to-list");r&&d(r,"click",M=>{M.preventDefault(),n()});const c=i.querySelector("#close-detail");c&&d(c,"click",n);const l=i.querySelector("#decision-view-content"),u=i.querySelector("#decision-edit-form"),p=i.querySelector("#edit-decision-btn");p&&l&&u&&d(p,"click",()=>{l.classList.add("hidden"),u.classList.remove("hidden"),me($)});const g=i.querySelector("#decision-cancel-edit-btn");g&&l&&u&&d(g,"click",()=>{u.classList.add("hidden"),l.classList.remove("hidden")});const f=i.querySelector("#decision-save-btn");f&&u&&s&&d(f,"click",async()=>{const M=i.querySelector("#decision-inline-form");if(!M?.checkValidity()){M.reportValidity();return}const z=i.querySelector("#decision-edit-content"),q=i.querySelector("#decision-edit-rationale"),I=i.querySelector("#decision-edit-impact"),X=i.querySelector("#decision-edit-summary"),se=i.querySelector("#decision-edit-status"),Se=i.querySelector("#decision-edit-made-by"),fe=z?.value?.trim()||"";if(!fe){m.error("Decision text is required");return}f.disabled=!0,f.textContent="Saving...";try{const we=await Ue.update(t.id,{content:fe,rationale:q?.value?.trim()||void 0,impact:I?.value||void 0,summary:X?.value?.trim()||void 0,status:se?.value||"active",made_by:Se?.value?.trim()||void 0});m.success("Decision updated");const Te=i.querySelector("#decision-view-content-text");Te&&(Te.textContent=we.content||fe);const Oe=i.querySelector("#decision-view-rationale");Oe&&(Oe.innerHTML=we.rationale||we.context?`<p class="decision-rationale">${ye(we.rationale||we.context||"")}</p>`:'<p class="text-muted">No rationale recorded</p>');const an=i.querySelector(".decision-detail-header .status-badge");an&&(an.textContent=String(we.status||"active"),an.className=`status-badge status-${(we.status||"active").toLowerCase()}`);const xn=i.querySelector(".decision-badges");if(xn){const zt=we.impact?`<span class="priority-pill impact-${we.impact}">${ye(we.impact||"")} impact</span>`:"",Y=xn.innerHTML;if(zt&&!Y.includes("impact-"))xn.insertAdjacentHTML("afterbegin",zt+" ");else if(zt){const W=xn.querySelector(".priority-pill.impact-");W&&(W.outerHTML=zt)}}$=we.made_by||we.owner||"";const At=i.querySelector("#decision-current-owner");if(At&&$){const zt=j($),Y=P(zt);At.innerHTML=`
            <div class="assigned-contact-display">
              <div class="contact-avatar-lg" id="decision-owner-avatar">${Y?`<img src="${ye(Y)}" alt="" onerror="this.parentElement.innerHTML='${St($)}'">`:St($)}</div>
              <div class="contact-details">
                <div class="contact-name-lg">${ye($)}</div>
                <div class="contact-role-sm" id="decision-owner-role">${ye(zt?.role??"‚Äî")}</div>
              </div>
              <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                Change
              </button>
            </div>`;const W=At.querySelector("#decision-change-owner-btn");W&&d(W,"click",J)}else if(At&&!$){At.innerHTML=`
            <div class="no-assignment">
              <div class="no-assignment-icon">
                <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
              </div>
              <span>No owner</span>
              <p class="no-assignment-hint">Choose from contacts</p>
              <button class="btn-assign-now" id="decision-show-owner-picker-btn" type="button">Choose</button>
            </div>`;const zt=At.querySelector("#decision-show-owner-picker-btn");zt&&d(zt,"click",J)}s(we),u.classList.add("hidden"),l.classList.remove("hidden")}catch{m.error("Failed to save decision")}finally{f.disabled=!1,f.textContent="Save"}});const h=i.querySelector("#decision-delete-in-edit-btn");h&&d(h,"click",async()=>{if(confirm("Are you sure you want to delete this decision?"))try{await Ue.delete(t.id),m.success("Decision deleted"),n()}catch{m.error("Failed to delete decision")}});const k=i.querySelector("#delete-decision-btn");k&&d(k,"click",async()=>{if(confirm("Are you sure you want to delete this decision?"))try{await Ue.delete(t.id),m.success("Decision deleted"),n()}catch{m.error("Failed to delete decision")}});const C=i.querySelector(".doc-link");C&&t.source_document_id&&d(C,"click",M=>{M.preventDefault(),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:t.source_document_id}}))});let x=[],$=t.made_by||t.owner||"";const w=i.querySelector("#decision-contact-picker"),y=i.querySelector("#decision-contact-list"),S=i.querySelector("#decision-contact-search");function P(M){if(!M)return null;const z=M;return z.photoUrl||z.avatarUrl||z.photo_url||z.avatar_url||null}function j(M){if(!M||!x.length)return;const z=M.trim().toLowerCase();if(!z)return;const q=x.find(se=>(se.name||"").trim().toLowerCase()===z);if(q)return q;const I=x.find(se=>(se.name||"").trim().toLowerCase().includes(z)||z.includes((se.name||"").trim().toLowerCase()));return I||x.find(se=>(se.aliases||[]).some(Se=>String(Se).trim().toLowerCase()===z))||x.find(se=>(se.aliases||[]).some(Se=>{const fe=String(Se).trim().toLowerCase();return fe.includes(z)||z.includes(fe)}))}const H=(M="")=>{if(!y)return;const z=M?x.filter(q=>(q.name||"").toLowerCase().includes(M.toLowerCase())||(q.role||"").toLowerCase().includes(M.toLowerCase())||(q.organization||"").toLowerCase().includes(M.toLowerCase())):x;if(x.length===0){y.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(z.length===0){y.innerHTML='<div class="empty-state">No contacts match</div>';return}y.innerHTML=z.map(q=>{const I=P(q);return`
          <div class="contact-card-picker ${($||"").trim()===(q.name||"").trim()?"selected":""}" data-contact-name="${ye(q.name||"")}">
            <div class="contact-avatar-picker">${I?`<img src="${ye(I)}" alt="" onerror="this.parentElement.innerHTML='${St(q.name||"")}'">`:St(q.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${ye(q.name||"")}</div>
              ${q.role?`<div class="contact-role-picker">${ye(q.role)}</div>`:""}
            </div>
          </div>`}).join(""),y.querySelectorAll(".contact-card-picker").forEach(q=>{d(q,"click",async()=>{const I=q.getAttribute("data-contact-name")||"";if(I)try{const X=await Ue.update(t.id,{made_by:I});$=I,m.success(`Owner set to ${I}`),w&&w.classList.add("hidden"),s&&s({...t,made_by:I,...X});const se=i.querySelector("#decision-current-owner");if(se){const Se=j(I),fe=P(Se);se.innerHTML=`
              <div class="assigned-contact-display">
                <div class="contact-avatar-lg" id="decision-owner-avatar">${fe?`<img src="${ye(fe)}" alt="" onerror="this.parentElement.innerHTML='${St(I)}'">`:St(I)}</div>
                <div class="contact-details">
                  <div class="contact-name-lg">${ye(I)}</div>
                  <div class="contact-role-sm" id="decision-owner-role">${ye(Se?.role??"‚Äî")}</div>
                </div>
                <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                  <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                  Change
                </button>
              </div>`;const we=se.querySelector("#decision-change-owner-btn");we&&d(we,"click",J)}}catch{m.error("Failed to save owner")}})})},J=()=>{w&&(w.classList.toggle("hidden"),!w.classList.contains("hidden")&&x.length===0?Ne.getAll().then(M=>{x=M?.contacts||[],H(S?.value||"")}).catch(()=>{y&&(y.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):w.classList.contains("hidden")||H(S?.value||""),S&&S.focus())},B=i.querySelector("#decision-change-owner-btn"),Z=i.querySelector("#decision-show-owner-picker-btn");B&&w&&d(B,"click",J),Z&&w&&d(Z,"click",J),S&&S.addEventListener("input",()=>H(S.value)),Ne.getAll().then(M=>{x=M?.contacts||[];const z=j($),q=i.querySelector("#decision-owner-role");q&&(q.textContent=z?.role??"‚Äî");const I=i.querySelector("#decision-owner-avatar");if(I&&$){const X=P(z);if(X){I.innerHTML="";const se=document.createElement("img");se.src=X,se.alt="",se.onerror=()=>{I.textContent=St($)},I.appendChild(se)}}}).catch(()=>{});const O=i.querySelector("#decision-edit-owner-display"),F=i.querySelector("#decision-edit-made-by"),ee=i.querySelector("#decision-edit-contact-picker"),ie=i.querySelector("#decision-edit-contact-list"),oe=i.querySelector("#decision-edit-contact-search");function me(M){if(!O||!F)return;if(F.value=M,M){const I=j(M),X=P(I);O.innerHTML=`
        <div class="assigned-contact-display">
          <div class="contact-avatar-lg">${X?`<img src="${ye(X)}" alt="" onerror="this.parentElement.innerHTML='${St(M)}'">`:St(M)}</div>
          <div class="contact-details">
            <div class="contact-name-lg">${ye(M)}</div>
            ${I?.role?`<div class="contact-role-sm">${ye(I.role)}</div>`:""}
          </div>
          <button type="button" class="btn-change-assignment" id="decision-edit-change-owner-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            Change
          </button>
        </div>`}else O.innerHTML=`
        <div class="no-assignment">
          <span>No owner</span>
          <button type="button" class="btn-assign-now" id="decision-edit-choose-owner-btn">Choose</button>
        </div>`;const z=O.querySelector("#decision-edit-change-owner-btn"),q=O.querySelector("#decision-edit-choose-owner-btn");z&&d(z,"click",re),q&&d(q,"click",re)}function ze(M=""){if(!ie)return;const z=M?x.filter(I=>(I.name||"").toLowerCase().includes(M.toLowerCase())||(I.role||"").toLowerCase().includes(M.toLowerCase())):x;if(x.length===0){ie.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(z.length===0){ie.innerHTML='<div class="empty-state">No contacts match</div>';return}const q=(F?.value||"").trim();ie.innerHTML=z.map(I=>{const X=P(I);return`
          <div class="contact-card-picker ${q===(I.name||"").trim()?"selected":""}" data-contact-name="${ye(I.name||"")}">
            <div class="contact-avatar-picker">${X?`<img src="${ye(X)}" alt="" onerror="this.parentElement.innerHTML='${St(I.name||"")}'">`:St(I.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${ye(I.name||"")}</div>
              ${I.role?`<div class="contact-role-picker">${ye(I.role)}</div>`:""}
            </div>
          </div>`}).join(""),ie.querySelectorAll(".contact-card-picker").forEach(I=>{d(I,"click",()=>{const X=I.getAttribute("data-contact-name")||"";X&&(me(X),ee&&ee.classList.add("hidden"))})})}function re(){ee&&(ee.classList.toggle("hidden"),ee.classList.contains("hidden")||(x.length===0?Ne.getAll().then(M=>{x=M?.contacts||[],ze(oe?.value||"")}).catch(()=>{ie&&(ie.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):ze(oe?.value||"")),oe&&oe.focus())}oe&&oe.addEventListener("input",()=>ze(oe.value)),me(t.made_by||t.owner||"");const Le=i.querySelector("#decision-owner-ai-suggest-btn"),le=i.querySelector("#decision-owner-suggestions-panel");Le&&le&&d(Le,"click",async()=>{Le.disabled=!0,le.classList.remove("hidden"),le.innerHTML='<div class="loading">Asking AI‚Ä¶</div>';try{x.length===0&&(x=(await Ne.getAll())?.contacts||[]);const{suggested_owners:M}=await Ue.suggestOwner(t.content||"",t.rationale||t.context||"");M?.length?(le.innerHTML=`
            <div class="suggestions-header-sota">
              <div class="ai-badge">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Recommended
              </div>
            </div>
            <div class="suggestions-list-sota">
              ${M.map((q,I)=>{const X=j(q.name),se=P(X),Se=X?.role??q.reason??"",fe=q.score??0,we=fe>=70?"var(--success)":fe>=50?"var(--warning)":"var(--text-muted)";return`
                <div class="suggestion-card-sota decision-owner-card" data-owner-name="${ye(q.name)}">
                  <div class="suggestion-rank">#${I+1}</div>
                  <div class="suggestion-avatar-sota">${se?`<img src="${ye(se)}" alt="" onerror="this.parentElement.innerHTML='${St(q.name)}'">`:St(q.name)}</div>
                  <div class="suggestion-info-sota">
                    <div class="suggestion-name-sota">${ye(q.name)}</div>
                    ${Se?`<div class="suggestion-reason-sota">${ye(Se)}</div>`:""}
                  </div>
                  ${fe>0?`<div class="suggestion-score-sota" style="--score-color: ${we}"><div class="score-value">${fe}%</div><div class="score-label">Match</div></div>`:""}
                  <button type="button" class="btn-select-suggestion">Assign</button>
                </div>`}).join("")}
            </div>
            <div class="suggestions-footer"><button type="button" class="btn-link" id="decision-owner-hide-suggest-btn">Close</button></div>
          `,le.querySelectorAll(".decision-owner-card .btn-select-suggestion").forEach(q=>{const X=q.closest(".decision-owner-card")?.getAttribute("data-owner-name")||"";X&&d(q,"click",async()=>{try{const se=await Ue.update(t.id,{made_by:X});$=X,m.success(`Owner set to ${X}`),le.classList.add("hidden");const Se=i.querySelector("#decision-current-owner");if(Se){const fe=j(X),we=P(fe);Se.innerHTML=`
                    <div class="assigned-contact-display">
                      <div class="contact-avatar-lg" id="decision-owner-avatar">${we?`<img src="${ye(we)}" alt="" onerror="this.parentElement.innerHTML='${St(X)}'">`:St(X)}</div>
                      <div class="contact-details">
                        <div class="contact-name-lg">${ye(X)}</div>
                        <div class="contact-role-sm" id="decision-owner-role">${ye(fe?.role??"‚Äî")}</div>
                      </div>
                      <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        Change
                      </button>
                    </div>`;const Te=Se.querySelector("#decision-change-owner-btn");Te&&d(Te,"click",J)}s&&s(se)}catch{m.error("Failed to save owner")}})})):le.innerHTML='<div class="no-suggestions">No owner suggestions. <button type="button" class="btn-link" id="decision-owner-hide-suggest-btn">Close</button></div>';const z=le.querySelector("#decision-owner-hide-suggest-btn");z&&d(z,"click",()=>{le.classList.add("hidden")})}catch{le.innerHTML='<div class="error">AI suggest failed. <button type="button" class="btn-link" id="decision-owner-hide-suggest-btn">Close</button></div>';const M=le.querySelector("#decision-owner-hide-suggest-btn");M&&d(M,"click",()=>{le.classList.add("hidden")}),m.error("AI suggest failed")}finally{Le.disabled=!1}});const te=i.querySelector("#decision-rationale-ai-suggest-btn"),ne=i.querySelector("#decision-suggestions-panel");te&&ne&&d(te,"click",async()=>{te.disabled=!0,ne.classList.remove("hidden"),ne.innerHTML='<div class="loading">Asking AI‚Ä¶</div>';try{const M=await Ue.suggest(t.content||"",t.rationale||t.context||"");ne.innerHTML=`
          <div class="suggestion-card">
            <p><strong>Rationale:</strong> ${ye((M.rationale||"").substring(0,300))}${(M.rationale||"").length>300?"‚Ä¶":""}</p>
            <p><strong>Impact:</strong> ${ye(M.impact||"")} ${M.impact_summary?`‚Äì ${ye(M.impact_summary)}`:""}</p>
            <p><strong>Summary:</strong> ${ye(M.summary||"")}</p>
            <button type="button" class="btn btn-primary btn-sm" id="decision-apply-suggestion-btn">Apply</button>
          </div>`;const z=ne.querySelector("#decision-apply-suggestion-btn");z&&d(z,"click",async()=>{try{const q=await Ue.update(t.id,{rationale:M.rationale,impact:M.impact,summary:M.summary});m.success("Suggestion applied");const I=i.querySelector("#decision-view-rationale");I&&(I.innerHTML=q.rationale||q.context?`<p class="decision-rationale">${ye(q.rationale||q.context||"")}</p>`:'<p class="text-muted">No rationale recorded</p>');const X=i.querySelector(".decision-badges");if(X&&q.impact){const se=X.querySelector(".priority-pill.impact-low, .priority-pill.impact-medium, .priority-pill.impact-high");se?se.outerHTML=`<span class="priority-pill impact-${q.impact}">${ye(q.impact||"")} impact</span>`:X.insertAdjacentHTML("afterbegin",`<span class="priority-pill impact-${q.impact}">${ye(q.impact||"")} impact</span> `)}s&&s(q),ne.classList.add("hidden")}catch{m.error("Failed to apply")}})}catch{ne.innerHTML='<div class="error">AI suggest failed</div>',m.error("AI suggest failed")}finally{te.disabled=!1}});const T=i.querySelector("#decision-edit-ai-suggest-btn"),_=i.querySelector("#decision-edit-suggestions-panel");T&&d(T,"click",async()=>{const M=i.querySelector("#decision-edit-content"),z=i.querySelector("#decision-edit-rationale"),q=i.querySelector("#decision-edit-impact"),I=i.querySelector("#decision-edit-summary"),X=M?.value?.trim()||"";if(!X){m.warning("Enter decision text first");return}T.disabled=!0,_&&(_.classList.remove("hidden"),_.innerHTML='<span class="text-muted">Asking AI‚Ä¶</span>');try{const se=await Ue.suggest(X,z?.value?.trim()||"");z&&(z.value=se.rationale||""),q&&(q.value=se.impact||"medium"),I&&(I.value=se.summary||""),_&&(_.classList.add("hidden"),_.innerHTML=""),m.success("Suggestion applied")}catch{_&&(_.innerHTML='<span class="error">AI suggest failed</span>'),m.error("AI suggest failed")}finally{T.disabled=!1}});const A=i.querySelector("#decision-timeline-list");A&&Ue.getEvents(t.id).then(M=>{const z={created:"Created",updated:"Updated",conflict_detected:"Conflict detected",deleted:"Deleted",restored:"Restored"},q=I=>I.actor_name||(I.event_data?.trigger==="decision_check_flow"?"System":null);if(M.length===0){A.innerHTML='<span class="text-muted">No events yet</span>';return}A.innerHTML=M.map(I=>{const X=q(I);return`<div class="decision-timeline-item decision-event-${ye(I.event_type)}">
            <span class="decision-event-type">${ye(z[I.event_type]||I.event_type)}</span>
            ${X?`<span class="decision-event-actor">${ye(X)}</span>`:""}
            <span class="decision-event-date">${Ce(I.created_at)}</span>
          </div>`}).join("")}).catch(()=>{A.innerHTML='<span class="text-muted">Could not load timeline</span>'});const E=i.querySelector("#decision-similar-list");E&&Ue.getSimilarDecisions(t.id,10).then(M=>{if(M.length===0){E.innerHTML='<span class="text-muted">No similar decisions</span>';return}E.innerHTML=M.map(z=>`
          <div class="decision-similar-item" data-decision-id="${z.decision.id}" role="${a?"button":"none"}">
            <span class="decision-similar-score">${Math.round(z.similarityScore*100)}%</span>
            <span class="decision-similar-content">${ye((z.decision.content||"").substring(0,80))}${(z.decision.content||"").length>80?"‚Ä¶":""}</span>
          </div>
        `).join(""),a&&E.querySelectorAll(".decision-similar-item").forEach(z=>{d(z,"click",()=>{const q=M.find(I=>String(I.decision.id)===z.getAttribute("data-decision-id"));q&&a(q.decision)})})}).catch(()=>{E.innerHTML='<span class="text-muted">Could not load similar decisions</span>'});const U=i.querySelector("#decision-implementing-tasks-list");return U&&Ee.getAll(void 0,void 0,String(t.id)).then(M=>{if(M.length===0){U.innerHTML='<span class="text-muted">No tasks linked to this decision</span>';return}U.innerHTML=M.map(z=>{const q=(z.content||z.task||"").toString().trim().substring(0,60)+((z.content||z.task||"").toString().length>60?"‚Ä¶":""),I=(z.status||"pending").toLowerCase();return`<div class="decision-implementing-task-item" data-action-id="${ye(String(z.id))}" role="${o?"button":"none"}">
            <span class="status-pill status-${I}">${ye(String(z.status||"pending").replace("_"," "))}</span>
            <span class="decision-implementing-task-title">${ye(q)}</span>
          </div>`}).join(""),o&&U.querySelectorAll(".decision-implementing-task-item").forEach(z=>{d(z,"click",()=>{const q=z.getAttribute("data-action-id"),I=M.find(X=>String(X.id)===q);I&&o(I)})})}).catch(()=>{U.innerHTML='<span class="text-muted">Could not load tasks</span>'}),i}const b4=Object.freeze(Object.defineProperty({__proto__:null,createDecisionDetailView:Bl},Symbol.toStringTag,{value:"Module"}));function Cg(e,t,n){return{decision:n,onClose:()=>{e.innerHTML="",e.appendChild(No(t))},onUpdate:()=>{e.innerHTML="",e.appendChild(No(t))},onDecisionClick:s=>{e.innerHTML="",e.appendChild(Bl(Cg(e,t,s)))}}}let Nc="all",wr="",_g="status";function No(e={}){const t=b("div",{className:"sot-panel decisions-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Decisions</h2>
        <span class="panel-count" id="decisions-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="decisions-filter" class="filter-select">
          <option value="all">All</option>
          <option value="proposed">Proposed</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="deferred">Deferred</option>
          <option value="active">Active</option>
          <option value="superseded">Superseded</option>
          <option value="revoked">Revoked</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="status">By Status</button>
          <button class="view-tab" data-view="source">By Source</button>
        </div>
        <input type="search" id="decisions-search" class="search-input" placeholder="Search decisions..." title="Search">
        <button class="btn btn-secondary btn-sm" id="check-conflicts-btn" title="Check for conflicting decisions">Check Conflicts</button>
        <button class="btn btn-primary btn-sm" id="add-decision-btn">+ Add</button>
      </div>
    </div>
    <div id="conflicts-container" class="conflicts-container hidden"></div>
    <div class="panel-content" id="decisions-content">
      <div class="loading">Loading decisions...</div>
    </div>
    <div id="removed-decisions-container" class="removed-decisions-container hidden"></div>
  `;const n=t.querySelector("#decisions-filter");d(n,"change",()=>{Nc=n.value,Jt(t,e)});const s=t.querySelectorAll(".view-tab");s.forEach(c=>{d(c,"click",()=>{s.forEach(l=>l.classList.remove("active")),c.classList.add("active"),_g=c.getAttribute("data-view"),Jt(t,e)})});const a=t.querySelector("#decisions-search");let o;d(a,"input",()=>{clearTimeout(o),o=window.setTimeout(()=>{wr=a.value.trim(),Jt(t,e)},300)});const i=t.querySelector("#check-conflicts-btn");i&&d(i,"click",async()=>{const c=t.querySelector("#conflicts-container");await Lg(c,t,e)});const r=t.querySelector("#add-decision-btn");return r&&d(r,"click",()=>{Ra({mode:"create",onSave:()=>{Jt(t,e),Oo(t,e)}})}),Jt(t,e),Oo(t,e),t}async function Lg(e,t,n){e.classList.remove("hidden"),e.innerHTML='<div class="loading">Checking for conflicts...</div>';try{const a=(await Ue.runDecisionCheck()).conflicts||[];if(a.length===0){e.innerHTML=`
        <div class="no-conflicts">
          <span class="success-icon">‚úì</span>
          <p>No conflicts detected</p>
        </div>
      `;return}e.innerHTML=a.map(o=>y4(o,t,n)).join(""),w4(e,t,n)}catch{e.innerHTML='<div class="error">Failed to check conflicts</div>'}}function y4(e,t,n){const s=e.decision1,a=e.decision2,o=(e.description||e.reason||"Conflict").substring(0,200);return`
    <div class="conflict-card-sota" data-decision-id1="${s.id}" data-decision-id2="${a.id}">
      <div class="conflict-card-priority-bar conflict-card-priority-bar-warning"></div>
      <div class="conflict-card-body">
        <div class="conflict-card-header">
          <span class="conflict-type-badge">Conflict</span>
          <p class="conflict-description">${Lt(o)}</p>
        </div>
        <div class="conflict-pair">
          <div class="conflict-item">
            <div class="conflict-item-content">${Lt((s.content||"").substring(0,120))}${(s.content||"").length>120?"‚Ä¶":""}</div>
            <button type="button" class="btn btn-sm conflict-keep-btn" data-keep-id="${s.id}" data-discard-id="${a.id}">Keep this</button>
          </div>
          <div class="conflict-vs">vs</div>
          <div class="conflict-item">
            <div class="conflict-item-content">${Lt((a.content||"").substring(0,120))}${(a.content||"").length>120?"‚Ä¶":""}</div>
            <button type="button" class="btn btn-sm conflict-keep-btn" data-keep-id="${a.id}" data-discard-id="${s.id}">Keep this</button>
          </div>
        </div>
      </div>
    </div>
  `}function w4(e,t,n){e.querySelectorAll(".conflict-keep-btn").forEach(s=>{d(s,"click",async a=>{a.stopPropagation();const o=s.getAttribute("data-keep-id"),i=s.getAttribute("data-discard-id");if(!(!o||!i))try{await Ue.delete(i),await Ue.runDecisionCheck(),await Ue.update(o,{status:"approved"}),m.success("Conflict resolved"),Jt(t,n),await Lg(e,t,n),Oo(t,n)}catch{m.error("Failed to resolve conflict")}})})}async function Oo(e,t){const n=e.querySelector("#removed-decisions-container");if(n)try{const s=await Ue.getDeletedDecisions();if(s.length===0){n.classList.add("hidden"),n.innerHTML="";return}n.classList.remove("hidden"),n.innerHTML=`
      <div class="removed-decisions-section">
        <div class="removed-decisions-header section-header-sota">
          <h3>Removed decisions</h3>
          <span class="panel-count removed-count">${s.length}</span>
        </div>
        <p class="removed-decisions-hint">Restore to undo a conflict resolution; decision will be synced back to the graph.</p>
        <div class="removed-decisions-list">
          ${s.map(a=>`
            <div class="removed-decision-item" data-decision-id="${a.id}">
              <div class="removed-decision-content">${Lt(k4(a.content??"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(a=>{d(a,"click",async()=>{const o=a.closest(".removed-decision-item")?.getAttribute("data-decision-id");if(o)try{await Ue.restore(o),m.success("Decision restored"),Jt(e,t),Oo(e,t)}catch{m.error("Failed to restore decision")}})})}catch{n.classList.add("hidden"),n.innerHTML=""}}function k4(e,t){return e.length<=t?e:e.substring(0,t)+"‚Ä¶"}function x4(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(s=>(s.content||"").toLowerCase().includes(n)||(s.rationale||"").toLowerCase().includes(n)||(s.made_by||"").toLowerCase().includes(n)||(s.source_file||"").toLowerCase().includes(n))}async function Jt(e,t){const n=e.querySelector("#decisions-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=Nc==="all"?void 0:Nc,a=await Ue.getAll(s),o=x4(a,wr);_g==="source"?S4(n,o,t):$4(n,o,t),ce.setDecisions(a),L4(e,o.length)}catch{n.innerHTML='<div class="error">Failed to load decisions</div>'}}function $4(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${wr?"No decisions match your search":"No decisions found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Decision</button>
      </div>
    `;const i=e.querySelector("#empty-add-btn");i&&d(i,"click",()=>{Ra({mode:"create",onSave:()=>Jt(e.closest(".decisions-panel"),n)})});return}const s=ce.getState().contacts||[],a={};t.forEach(i=>{const r=(i.status||"active").toLowerCase();a[r]||(a[r]=[]),a[r].push(i)});const o=Object.keys(a);o.length>1?e.innerHTML=o.map(i=>`
      <div class="question-group">
        <div class="group-header">
          <h3>${Lt(i)}</h3>
          <span class="group-count">${a[i].length}</span>
        </div>
        <div class="group-items">
          ${a[i].map(r=>Oc(r,s)).join("")}
        </div>
      </div>
    `).join(""):e.innerHTML=t.map(i=>Oc(i,s)).join(""),Tg(e,t,n)}function S4(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${wr?"No decisions match your search":"No decisions found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Decision</button>
      </div>
    `;const o=e.querySelector("#empty-add-btn");o&&d(o,"click",()=>{Ra({mode:"create",onSave:()=>Jt(e.closest(".decisions-panel"),n)})});return}const s=ce.getState().contacts||[],a={};t.forEach(o=>{const i=o.source_file||o.source||"Unknown source";a[i]||(a[i]=[]),a[i].push(o)}),e.innerHTML=Object.entries(a).map(([o,i])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${Lt(o)}</h3>
        <span class="group-count">${i.length}</span>
      </div>
      <div class="group-items">
        ${i.map(r=>Oc(r,s)).join("")}
      </div>
    </div>
  `).join(""),Tg(e,t,n)}function Tg(e,t,n){e.querySelectorAll(".decision-card-sota").forEach(s=>{d(s,"click",r=>{if(r.target.closest(".card-actions"))return;const c=s.getAttribute("data-id"),l=t.find(u=>String(u.id)===c);if(l)if(n.useDetailView&&n.containerElement){const u=n.containerElement;u.innerHTML="",u.appendChild(Bl(Cg(u,n,l)))}else n.onDecisionClick?n.onDecisionClick(l):Ra({mode:"edit",decision:{...l,decision:l.content,madeBy:l.made_by,madeAt:l.created_at},onSave:()=>Jt(e.closest(".decisions-panel"),n)})});const a=s.querySelector(".approve-btn"),o=s.querySelector(".reject-btn"),i=s.getAttribute("data-id");a&&i&&d(a,"click",async r=>{r.stopPropagation();try{await Ue.approve(i,"Current User"),Jt(e.closest(".decisions-panel"),n)}catch{}}),o&&i&&d(o,"click",async r=>{r.stopPropagation();try{await Ue.reject(i),Jt(e.closest(".decisions-panel"),n)}catch{}})})}const zu={proposed:"#f59e0b",approved:"#10b981",rejected:"#ef4444",deferred:"#6b7280",active:"#3b82f6",superseded:"#8b5cf6",revoked:"#6b7280"};function C4(e,t){if(!t||!e.length)return;const n=t.trim().toLowerCase();if(!n)return;const s=e.find(i=>(i.name||"").trim().toLowerCase()===n);if(s)return s;const a=e.find(i=>(i.name||"").trim().toLowerCase().includes(n)||n.includes((i.name||"").trim().toLowerCase()));return a||e.find(i=>(i.aliases||[]).some(r=>String(r).trim().toLowerCase()===n))||e.find(i=>(i.aliases||[]).some(r=>{const c=String(r).trim().toLowerCase();return c.includes(n)||n.includes(c)}))}function _4(e){return e&&(e.photoUrl||e.avatarUrl||e.photo_url||e.avatar_url)||null}function Iu(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Oc(e,t){const n=(e.status||"active").toLowerCase(),s=n.replace(/\s+/g,"-"),a=zu[n]??zu.active,o=e.content||"",i=e.source_file||e.source||"",r=e.made_by||e.owner||"",c=r?C4(t,r):void 0,l=_4(c),u=r?`
        <div class="assignee-chip">
          <div class="assignee-avatar">${l?`<img src="${Lt(l)}" alt="${Lt(r)}" onerror="this.parentElement.innerHTML='${Iu(r)}'">`:Iu(r)}</div>
          <div class="assignee-info">
            <span class="assignee-name">${Lt(r)}</span>
            ${c?.role?`<span class="assignee-role">${Lt(c.role)}</span>`:""}
          </div>
        </div>
      `:'<span class="card-owner-placeholder text-muted">No owner</span>',p=i?`<span class="card-source-chip">${Lt(i.substring(0,40))}${i.length>40?"‚Ä¶":""}</span>`:'<span class="card-source-chip text-muted">No source</span>';return`
    <div class="decision-card-sota question-card-sota" data-id="${e.id}" style="--decision-status-bar: ${a}">
      <div class="card-priority-bar decision-status-bar"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="priority-pill status-${s}">${Lt(String(e.status))}</span>
            ${e.impact?`<span class="status-pill">${Lt(e.impact)} impact</span>`:""}
          </div>
          <span class="card-timestamp">${Ce(e.decided_at||e.created_at)}</span>
        </div>
        <div class="card-question-text">${Lt(o)}</div>
        ${e.summary?`<div class="card-summary text-muted">${Lt(e.summary)}</div>`:""}
        ${e.rationale?`<div class="card-rationale text-muted">${Lt((e.rationale||"").substring(0,100))}${(e.rationale||"").length>100?"‚Ä¶":""}</div>`:""}
        <div class="card-bottom-row">
          <div class="card-requester">
            ${p}
            ${u}
          </div>
          <div class="card-assignment">
            ${e.status==="proposed"||e.status==="active"?'<span class="card-actions"><button type="button" class="btn btn-sm btn-success approve-btn">Approve</button><button type="button" class="btn btn-sm btn-danger reject-btn">Reject</button></span>':'<button type="button" class="btn-link decision-view-link">View</button>'}
          </div>
        </div>
      </div>
    </div>
  `}function L4(e,t){const n=e.querySelector("#decisions-count");n&&(n.textContent=String(t))}function Lt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Fn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Qr(e){if(!e)return"‚Äî";try{return Ts(e)}catch{return e}}function kr(e){const{fact:t,onClose:n,onUpdate:s,onFactClick:a}=e,o=b("div",{className:"fact-detail-view question-detail-view"});o.innerHTML=`
    <div class="question-detail-header fact-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Facts</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Fact #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        ${t.verified?'<span class="verified-badge detail sla-badge">‚úì Verified</span>':""}
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content fact-detail-content">
      <section class="detail-section question-main fact-main">
        <div class="question-badges fact-badges">
          ${t.category?`<span class="priority-pill category-${(t.category||"general").toLowerCase().replace(/\s+/g,"-")}">${Fn(t.category)}</span>`:""}
          ${t.confidence!=null?`<span class="status-pill status-pending">${Math.round((t.confidence??0)*100)}%</span>`:""}
          ${t.verified?'<span class="auto-pill">‚úì Verified</span>':""}
          <span class="question-date fact-date">Created ${Ce(t.created_at)}</span>
        </div>
        <h2 class="question-text fact-content-text">${Fn(t.content)}</h2>
      </section>

      <div class="detail-columns">
        <div class="detail-column-left">
          <section class="detail-section">
            <div class="section-header">
              <h3>Source</h3>
            </div>
            ${t.source_file?`<p class="source-file">${Fn(t.source_file)}</p>`:""}
            ${t.source?`<p class="source-ref">${Fn(t.source)}</p>`:""}
            ${t.source_document_id?`
              <p class="source-doc">
                <a href="#" class="doc-link" data-document-id="${Fn(String(t.source_document_id))}">View source document</a>
              </p>
            `:""}
            ${!t.source&&!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
          </section>

          <section class="detail-section verification-section">
            <div class="section-header">
              <h3>Verification</h3>
            </div>
            ${t.verified?`
              <div class="verified-info">
                <span class="verified-badge auto-pill">‚úì Verified</span>
                ${t.verified_at?`<span class="text-muted">on ${Qr(t.verified_at)}</span>`:""}
              </div>
            `:`
              <div class="unverified-info">
                <p class="text-muted">This fact has not been verified.</p>
                <button type="button" class="btn btn-success btn-sm" id="verify-fact-btn">Verify</button>
              </div>
            `}
          </section>
        </div>

        <div class="detail-column-right">
          <section class="detail-section metadata-section">
            <div class="section-header">
              <h3>Metadata</h3>
            </div>
            <dl class="metadata-list">
              <dt>Created</dt>
              <dd>${Qr(t.created_at)}</dd>
              ${t.updated_at?`<dt>Updated</dt><dd>${Qr(t.updated_at)}</dd>`:""}
            </dl>
          </section>

          <section class="detail-section fact-timeline-section">
            <div class="section-header">
              <h3>Timeline</h3>
            </div>
            <div id="fact-timeline-list" class="fact-timeline-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>

          <section class="detail-section fact-similar-section">
            <div class="section-header">
              <h3>Similar facts</h3>
            </div>
            <div id="fact-similar-list" class="fact-similar-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>
        </div>
      </div>

      <div class="detail-actions">
        <button type="button" class="btn btn-secondary" id="edit-fact-btn">Edit</button>
        ${t.verified?"":'<button type="button" class="btn btn-success" id="verify-btn">Verify</button>'}
        <button type="button" class="btn btn-danger" id="delete-fact-btn">Delete</button>
      </div>
    </div>
  `;const i=o.querySelector("#back-to-list");i&&d(i,"click",k=>{k.preventDefault(),n()});const r=o.querySelector("#close-detail");r&&d(r,"click",n);const c=o.querySelector("#verify-fact-btn");c&&d(c,"click",async()=>{try{const k=await nt.verify(t.id);m.success("Fact verified"),s&&s(k),n()}catch{m.error("Failed to verify fact")}});const l=o.querySelector("#verify-btn");l&&d(l,"click",async()=>{try{const k=await nt.verify(t.id);m.success("Fact verified"),s&&s(k),n()}catch{m.error("Failed to verify fact")}});const u=o.querySelector("#edit-fact-btn");u&&d(u,"click",()=>{xe(async()=>{const{showFactModal:k}=await Promise.resolve().then(()=>_r);return{showFactModal:k}},void 0).then(({showFactModal:k})=>{k({mode:"edit",fact:t,onSave:C=>{s&&s(C),n()}})})});const p=o.querySelector("#delete-fact-btn");p&&d(p,"click",async()=>{if(confirm("Are you sure you want to delete this fact?"))try{await nt.delete(t.id),m.success("Fact deleted"),n()}catch{m.error("Failed to delete fact")}});const g=o.querySelector(".doc-link");g&&t.source_document_id&&d(g,"click",k=>{k.preventDefault(),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:t.source_document_id}}))});const f=o.querySelector("#fact-timeline-list");f&&nt.getEvents(t.id).then(k=>{const C={created:"Created",verified:"Verified",updated:"Updated",conflict_detected:"Conflict detected",deleted:"Deleted",restored:"Restored"},x=$=>$.actor_name||($.event_data?.trigger==="fact_check_flow"?"System":null);if(k.length===0){f.innerHTML='<span class="text-muted">No events yet</span>';return}f.innerHTML=k.map($=>{const w=x($);return`<div class="fact-timeline-item fact-event-${Fn($.event_type)}">
              <span class="fact-event-type">${Fn(C[$.event_type]||$.event_type)}</span>
              ${w?`<span class="fact-event-actor">${Fn(w)}</span>`:""}
              <span class="fact-event-date">${Ce($.created_at)}</span>
            </div>`}).join("")}).catch(()=>{f.innerHTML='<span class="text-muted">Could not load timeline</span>'});const h=o.querySelector("#fact-similar-list");return h&&nt.getSimilarFacts(t.id,10).then(k=>{if(k.length===0){h.innerHTML='<span class="text-muted">No similar facts</span>';return}h.innerHTML=k.map(C=>`
            <div class="fact-similar-item" data-fact-id="${C.fact.id}" role="${a?"button":"none"}">
              <span class="fact-similar-score">${Math.round(C.similarityScore*100)}%</span>
              <span class="fact-similar-content">${Fn((C.fact.content||"").substring(0,80))}${(C.fact.content||"").length>80?"‚Ä¶":""}</span>
            </div>
          `).join(""),a&&h.querySelectorAll(".fact-similar-item").forEach(C=>{d(C,"click",()=>{const x=k.find($=>String($.fact.id)===C.getAttribute("data-fact-id"));x&&a(x.fact)})})}).catch(()=>{h.innerHTML='<span class="text-muted">Could not load similar facts</span>'}),o}const T4=Object.freeze(Object.defineProperty({__proto__:null,createFactDetailView:kr},Symbol.toStringTag,{value:"Module"})),A4=["technical","process","policy","people","timeline","general"];function Ag(e,t,n){return{fact:n,onClose:()=>{e.innerHTML="",e.appendChild(ja(t))},onUpdate:()=>{e.innerHTML="",e.appendChild(ja(t))},onFactClick:s=>{e.innerHTML="",e.appendChild(kr(Ag(e,t,s)))}}}let xr="",vi="all",Mg="category";function ja(e={}){const t=b("div",{className:"sot-panel facts-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Facts</h2>
        <span class="panel-count" id="facts-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="facts-filter" class="filter-select">
          <option value="all">All</option>
          <option value="verified">‚úì Verified</option>
          <option value="unverified">Unverified</option>
          <option value="technical">Technical</option>
          <option value="process">Process</option>
          <option value="policy">Policy</option>
          <option value="people">People</option>
          <option value="timeline">Timeline</option>
          <option value="general">General</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="category">By Category</button>
          <button class="view-tab" data-view="source">By Source</button>
        </div>
        <input type="search" id="facts-search" class="search-input" placeholder="Search facts..." title="Search">
        <button class="btn btn-secondary btn-sm" id="check-conflicts-btn" title="Check for conflicting facts">Check Conflicts</button>
        <button class="btn btn-primary btn-sm" id="add-fact-btn">+ Add</button>
      </div>
    </div>
    <div id="conflicts-container" class="conflicts-container hidden"></div>
    <div class="panel-content" id="facts-content">
      <div class="loading">Loading facts...</div>
    </div>
    <div id="removed-facts-container" class="removed-facts-container hidden"></div>
  `;const n=t.querySelector("#facts-filter");n&&d(n,"change",()=>{vi=n.value,Xn(t,e)});const s=t.querySelectorAll(".view-tab");s.forEach(c=>{d(c,"click",()=>{s.forEach(l=>l.classList.remove("active")),c.classList.add("active"),Mg=c.getAttribute("data-view"),Xn(t,e)})});const a=t.querySelector("#facts-search");let o;d(a,"input",()=>{clearTimeout(o),o=window.setTimeout(()=>{xr=a.value,Xn(t,e)},300)});const i=t.querySelector("#check-conflicts-btn");i&&d(i,"click",async()=>{const c=t.querySelector("#conflicts-container");await Nl(c,t,e)});const r=t.querySelector("#add-fact-btn");return r&&d(r,"click",()=>{Ol(t,e)}),Xn(t,e),t}async function Xn(e,t){const n=e.querySelector("#facts-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=A4.includes(vi)?vi:void 0,{facts:a,total:o}=await nt.getAll({search:xr||void 0,limit:500,category:s}),i=vi==="verified"?a.filter(r=>r.verified):vi==="unverified"?a.filter(r=>!r.verified):a;Mg==="source"?E4(n,i,t):M4(n,i,t),j4(e,i.length)}catch{n.innerHTML='<div class="error">Failed to load facts</div>'}await Rl(e,t)}async function Rl(e,t){const n=e.querySelector("#removed-facts-container");if(n)try{const s=await nt.getDeletedFacts();if(s.length===0){n.classList.add("hidden"),n.innerHTML="";return}n.classList.remove("hidden"),n.innerHTML=`
      <div class="removed-facts-section">
        <div class="removed-facts-header section-header-sota">
          <h3>Removed facts</h3>
          <span class="panel-count removed-count">${s.length}</span>
        </div>
        <p class="removed-facts-hint">Restore to undo a conflict resolution; fact will be synced back to the graph.</p>
        <div class="removed-facts-list">
          ${s.map(a=>`
            <div class="removed-fact-item" data-fact-id="${a.id}">
              <div class="removed-fact-content">${Pn(Fo(a.content??"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(a=>{const i=a.closest(".removed-fact-item")?.getAttribute("data-fact-id");i&&d(a,"click",async()=>{try{await nt.restoreFact(i),m.success("Fact restored"),await Xn(e,t),Rl(e,t);const r=e.querySelector("#conflicts-container");r&&!r.classList.contains("hidden")&&await Nl(r,e,t)}catch{m.error("Failed to restore fact")}})})}catch{n.classList.add("hidden"),n.innerHTML=""}}function M4(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${xr?"No facts match your search":"No facts found"}</p>
        <button class="btn btn-primary" id="empty-add-fact-btn">Add Fact</button>
      </div>
    `;const o=e.querySelector("#empty-add-fact-btn");o&&d(o,"click",()=>{const i=e.closest(".facts-panel");i&&Ol(i,n)});return}const s={};t.forEach(o=>{const i=o.category||"Uncategorized";s[i]||(s[i]=[]),s[i].push(o)}),Object.keys(s).length>1?e.innerHTML=Object.entries(s).map(([o,i])=>`
      <div class="question-group">
        <div class="group-header">
          <h3>${Pn(o)}</h3>
          <span class="group-count">${i.length}</span>
        </div>
        <div class="group-items">
          ${i.map(r=>Fc(r)).join("")}
        </div>
      </div>
    `).join(""):e.innerHTML=t.map(o=>Fc(o)).join(""),e.querySelectorAll(".fact-card-sota").forEach(o=>{d(o,"click",()=>{const r=o.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);if(c)if(n.useDetailView&&n.containerElement){const l=n.containerElement;l.innerHTML="",l.appendChild(kr(Ag(l,n,c)))}else n.onFactClick?n.onFactClick(c):xe(async()=>{const{showFactModal:l}=await Promise.resolve().then(()=>_r);return{showFactModal:l}},void 0).then(({showFactModal:l})=>{l({mode:"view",fact:c})})});const i=o.querySelector(".fact-verify-btn");i&&d(i,"click",async r=>{r.stopPropagation();const c=o.getAttribute("data-id");if(c)try{await nt.verify(c),m.success("Fact verified"),Xn(e.closest(".facts-panel"),n)}catch{}})})}function E4(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${xr?"No facts match your search":"No facts found"}</p>
        <button class="btn btn-primary" id="empty-add-fact-btn">Add Fact</button>
      </div>
    `;const a=e.querySelector("#empty-add-fact-btn");a&&d(a,"click",()=>{const o=e.closest(".facts-panel");o&&Ol(o,n)});return}const s={};t.forEach(a=>{const o=a.source_file||a.source||"Unknown source";s[o]||(s[o]=[]),s[o].push(a)}),e.innerHTML=Object.entries(s).map(([a,o])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${Pn(a)}</h3>
        <span class="group-count">${o.length}</span>
      </div>
      <div class="group-items">
        ${o.map(i=>Fc(i)).join("")}
      </div>
    </div>
  `).join(""),e.querySelectorAll(".fact-card-sota").forEach(a=>{d(a,"click",()=>{const i=a.getAttribute("data-id"),r=t.find(c=>String(c.id)===i);if(r)if(n.useDetailView&&n.containerElement){const c=n.containerElement,l=kr({fact:r,onClose:()=>{c.innerHTML="";const u=ja(n);c.appendChild(u)},onUpdate:()=>{c.innerHTML="";const u=ja(n);c.appendChild(u)}});c.innerHTML="",c.appendChild(l)}else n.onFactClick?n.onFactClick(r):xe(async()=>{const{showFactModal:c}=await Promise.resolve().then(()=>_r);return{showFactModal:c}},void 0).then(({showFactModal:c})=>{c({mode:"view",fact:r})})});const o=a.querySelector(".fact-verify-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=a.getAttribute("data-id");if(r)try{await nt.verify(r),m.success("Fact verified"),Xn(e.closest(".facts-panel"),n)}catch{}})})}const Hu={technical:"#3b82f6",process:"#8b5cf6",policy:"#ec4899",people:"#10b981",timeline:"#f59e0b",general:"#6b7280"};function Fc(e){const t=(e.category||"general").toLowerCase(),n=t.replace(/\s+/g,"-"),s=Hu[t]||Hu.general,a=e.confidence!=null?Math.round(e.confidence*100):null;return`
    <div class="fact-card-sota question-card-sota ${e.verified?"has-answer":""}" data-id="${e.id}" style="--fact-category-bar: ${s}">
      <div class="card-priority-bar fact-category-bar"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="priority-pill fact-category-pill category-${n}">${Pn(e.category||"general")}</span>
            ${a!=null?`<span class="status-pill status-pending">${a}%</span>`:""}
            ${e.verified?'<span class="auto-pill">‚úì Verified</span>':""}
          </div>
          <span class="card-timestamp">${Ce(e.created_at)}</span>
        </div>
        <div class="card-question-text">${Pn(e.content)}</div>
        <div class="card-bottom-row">
          <div class="card-requester">
            ${e.source_file||e.source?`<span class="card-source-chip">${Pn((e.source_file||e.source||"").substring(0,40))}${(e.source_file||e.source||"").length>40?"‚Ä¶":""}</span>`:'<span class="card-source-chip text-muted">No source</span>'}
          </div>
          <div class="card-assignment">
            ${e.verified?'<span class="answered-badge">Verified</span>':'<button type="button" class="btn-link fact-verify-btn">Verify</button>'}
          </div>
        </div>
      </div>
    </div>
  `}async function Nl(e,t,n){e.classList.remove("hidden"),e.innerHTML='<div class="loading">Checking for conflicts...</div>';try{const s=await nt.detectConflicts();s.length===0?(e.innerHTML=`
        <div class="no-conflicts">
          <span class="success-icon">‚úì</span>
          <p>No conflicts detected</p>
        </div>
      `,setTimeout(()=>{e.classList.add("hidden")},3e3)):Eg(e,s,t,n)}catch{e.innerHTML='<div class="error">Failed to check conflicts</div>'}}function Eg(e,t,n,s){e.innerHTML=`
    <div class="conflicts-section">
      <div class="conflicts-header section-header-sota">
        <h3>Conflicts Detected</h3>
        <span class="conflicts-count panel-count">${t.length}</span>
        <button type="button" class="btn-icon close-conflicts" title="Close">√ó</button>
      </div>
      <div class="conflicts-list question-group">
        ${t.map((o,i)=>q4(o,i)).join("")}
      </div>
    </div>
  `;const a=e.querySelector(".close-conflicts");a&&d(a,"click",()=>{e.classList.add("hidden")}),t.forEach((o,i)=>{const r=e.querySelector(`[data-conflict-index="${i}"]`);if(!r)return;const c=r.querySelector(".conflict-resolve-keep-left"),l=r.querySelector(".conflict-resolve-keep-right");c&&d(c,"click",u=>{u.stopPropagation(),Bu(o,"left",n,s,e)}),l&&d(l,"click",u=>{u.stopPropagation(),Bu(o,"right",n,s,e)})})}async function Bu(e,t,n,s,a){const o=t==="left"?e.fact2:e.fact1,i=t==="left"?e.fact1:e.fact2;if(o?.id)try{await nt.deleteFact(o.id),m.success(`Removed conflicting fact; kept: "${Fo(i?.content??"",50)}"`),await Xn(n,s);try{await nt.runFactCheck()}catch{}if(i?.id)try{await nt.verifyFact(i.id)}catch{}await Nl(a,n,s);const r=await nt.detectConflicts();r.length===0?(a.classList.add("hidden"),a.innerHTML=""):Eg(a,r,n,s),Rl(n,s)}catch{m.error("Failed to resolve conflict")}}function q4(e,t){const n=(e.conflictType||"contradiction").toLowerCase(),s=e.description||e.reason||"Conflict detected";return`
    <div class="conflict-card-sota" data-conflict-index="${t}">
      <div class="conflict-type-bar ${n==="contradiction"?"conflict-bar-contradiction":n==="inconsistency"?"conflict-bar-inconsistency":"conflict-bar-process"}"></div>
      <div class="conflict-card-body">
        <div class="conflict-card-top">
          <span class="conflict-type-pill conflict-type-${n}">${Pn(n)}</span>
          ${e.confidence!=null?`<span class="conflict-confidence-pill">${Math.round(e.confidence*100)}%</span>`:""}
        </div>
        <div class="conflict-facts-row">
          <div class="conflict-fact-cell">
            <div class="conflict-fact-snippet">${Pn(Fo(e.fact1?.content??"",120))}</div>
            <button type="button" class="btn btn-sm conflict-resolve-keep-left">Keep this</button>
          </div>
          <span class="conflict-vs">vs</span>
          <div class="conflict-fact-cell">
            <div class="conflict-fact-snippet">${Pn(Fo(e.fact2?.content??"",120))}</div>
            <button type="button" class="btn btn-sm conflict-resolve-keep-right">Keep this</button>
          </div>
        </div>
        <div class="conflict-description-row">
          <div class="conflict-description">${Pn(s)}</div>
        </div>
      </div>
    </div>
  `}function Fo(e,t){return e.length<=t?e:e.slice(0,t).trim()+"‚Ä¶"}async function Ol(e,t){const{showFactModal:n}=await xe(async()=>{const{showFactModal:s}=await Promise.resolve().then(()=>_r);return{showFactModal:s}},void 0);n({mode:"create",onSave:()=>Xn(e,t)})}function j4(e,t){const n=e.querySelector("#facts-count");n&&(n.textContent=String(t))}function Pn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function qg(e){const t=b("div",{className:`stats-card ${e.onClick?"clickable":""} ${e.color?`color-${e.color}`:""}`});t.setAttribute("data-stat-id",e.id);const n=e.trend?`
    <div class="stat-trend ${e.trend.direction} ${e.trend.sentiment}">
      <span class="trend-arrow">${P4(e.trend.direction)}</span>
      <span class="trend-value">${e.trend.value}%</span>
    </div>
  `:"";return t.innerHTML=`
    ${e.icon?`<div class="stat-icon">${e.icon}</div>`:""}
    <div class="stat-value">${typeof e.value=="number"?_i(e.value):e.value}</div>
    <div class="stat-label">${e.label}</div>
    ${e.subValue?`<div class="stat-sub">${e.subValue}</div>`:""}
    ${n}
  `,e.onClick&&d(t,"click",e.onClick),t}function P4(e){switch(e){case"up":return"‚Üë";case"down":return"‚Üì";case"stable":return"‚Üí"}}function D4(e,t,n){const s=e.querySelector(".stat-value"),a=e.querySelector(".stat-sub");s&&(s.textContent=typeof t=="number"?_i(t):t),a&&n!==void 0&&(a.textContent=n)}function z4(e){const t=b("div",{className:"stats-grid"});return e.forEach(n=>{const s=qg(n);t.appendChild(s)}),t}function I4(e){const{health:t,showFactors:n=!0,size:s="md"}=e,a=t.status.toLowerCase().replace(/\s+/g,"-"),o=b("div",{className:`health-indicator ${a} size-${s}`});return o.innerHTML=`
    <div class="health-gauge">
      <svg class="gauge-svg" viewBox="0 0 100 50">
        <path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50" />
        <path class="gauge-fill" d="M 10 50 A 40 40 0 0 1 90 50" 
              style="stroke-dasharray: ${t.score/100*126} 126; stroke: ${t.color};" />
      </svg>
      <div class="gauge-center">
        <span class="score-value">${t.score}</span>
        <span class="score-label">Health</span>
      </div>
    </div>
    <div class="health-status" style="--health-status-color: ${t.color}">${t.status}</div>
    ${n&&t.factors.length>0?`
      <div class="health-factors">
        ${t.factors.slice(0,4).map(i=>`
          <div class="factor ${i.type}">
            <span class="factor-icon">${i.type==="positive"?"‚úì":"!"}</span>
            <span class="factor-text">${i.factor}</span>
          </div>
        `).join("")}
      </div>
    `:""}
  `,o}function H4(e,t,n){const s=b("div",{className:"health-badge"});return s.innerHTML=`
    <span class="badge-score" style="--badge-bg: ${n}">${e}</span>
    <span class="badge-status">${t}</span>
  `,s}function B4(e){return e>=80||e>=60?"var(--color-success-500)":e>=40?"var(--color-warning-500)":e>=20?"var(--color-warning-600)":"var(--color-danger-500)"}function R4(e){return e>=80?"Healthy":e>=60?"Good":e>=40?"Needs Attention":e>=20?"At Risk":"Critical"}const Uo={facts:{line:"var(--color-info-500)",fill:"color-mix(in srgb, var(--color-info-500), transparent 90%)"},questions:{line:"var(--color-warning-500)",fill:"color-mix(in srgb, var(--color-warning-500), transparent 90%)"},risks:{line:"var(--color-danger-500)",fill:"color-mix(in srgb, var(--color-danger-500), transparent 90%)"},actions:{line:"var(--color-success-500)",fill:"color-mix(in srgb, var(--color-success-500), transparent 90%)"},decisions:{line:"var(--color-accent-500)",fill:"color-mix(in srgb, var(--color-accent-500), transparent 90%)"}};function N4(e){const{data:t,metrics:n=["facts","questions","risks"],height:s=200}=e,a=b("div",{className:"trend-chart-container"});if(a.style.height=`${s}px`,t.length===0)return a.innerHTML='<div class="empty-chart">No trend data available</div>',a;const o=b("canvas",{id:`trend-chart-${Date.now()}`});return a.appendChild(o),O4(o,t,n),a}function O4(e,t,n){if(typeof window.Chart>"u"){console.warn("Chart.js not loaded, using fallback"),F4(e.parentElement,t,n);return}const s=window.Chart,a=t.map(i=>jg(i.date)),o=n.map(i=>({label:Uc(i),data:t.map(r=>r[i]||0),borderColor:Uo[i]?.line||"#6366f1",backgroundColor:Uo[i]?.fill||"rgba(99, 102, 241, 0.1)",fill:!0,tension:.3}));new s(e,{type:"line",data:{labels:a,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:!0}}}})}function F4(e,t,n){const s=Math.max(...t.flatMap(a=>n.map(o=>a[o]||0)));e.innerHTML=`
    <div class="fallback-chart">
      <div class="chart-legend">
        ${n.map(a=>`
          <span class="legend-item">
            <span class="legend-color" style="--legend-color: ${Uo[a]?.line||"#6366f1"}"></span>
            ${Uc(a)}
          </span>
        `).join("")}
      </div>
      <div class="chart-bars">
        ${t.slice(-7).map(a=>`
          <div class="bar-group">
            ${n.map(o=>{const i=a[o]||0;return`<div class="bar" style="--bar-height: ${s>0?i/s*100:0}; --bar-color: ${Uo[o]?.line||"#6366f1"}" title="${Uc(o)}: ${i}"></div>`}).join("")}
            <div class="bar-label">${jg(a.date)}</div>
          </div>
        `).join("")}
      </div>
    </div>
  `}function jg(e){return new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric"})}function Uc(e){return e.charAt(0).toUpperCase()+e.slice(1)}const U4=["critical","high","medium","low"],Ru=["high","medium","low"],V4={"critical-high":"var(--color-danger-700)","critical-medium":"var(--color-danger-600)","critical-low":"var(--color-danger-500)","high-high":"var(--color-danger-500)","high-medium":"var(--color-warning-600)","high-low":"var(--color-warning-500)","medium-high":"var(--color-warning-600)","medium-medium":"var(--color-warning-500)","medium-low":"var(--color-warning-100)","low-high":"var(--color-warning-500)","low-medium":"var(--color-success-500)","low-low":"var(--color-success-600)"};function G4(e){const{risks:t,onCellClick:n,size:s="md"}=e,a=b("div",{className:`risk-matrix size-${s}`}),o=Z4(t);return a.innerHTML=`
    <div class="matrix-container">
      <div class="matrix-y-label">Impact</div>
      <div class="matrix-grid">
        <div class="matrix-header">
          <div class="matrix-corner"></div>
          ${Ru.map(i=>`<div class="matrix-col-header">${Vc(i)}</div>`).join("")}
        </div>
        ${U4.map(i=>`
          <div class="matrix-row">
            <div class="matrix-row-header">${Vc(i)}</div>
            ${Ru.map(r=>{const c=`${i}-${r}`,l=o[c]||[],u=V4[c]||"#e5e7eb",p=l.length;return`
                <div class="matrix-cell ${p>0?"has-risks":""}" 
                     data-impact="${i}" 
                     data-likelihood="${r}"
                     style="background-color: ${p>0?u:"var(--color-surface-hover)"}">
                  ${p>0?`<span class="cell-count">${p}</span>`:""}
                </div>
              `}).join("")}
          </div>
        `).join("")}
      </div>
      <div class="matrix-x-label">Likelihood</div>
    </div>
    <div class="matrix-legend">
      <span class="legend-item"><span class="legend-color risk-legend-low"></span> Low</span>
      <span class="legend-item"><span class="legend-color risk-legend-medium"></span> Medium</span>
      <span class="legend-item"><span class="legend-color risk-legend-high"></span> High</span>
      <span class="legend-item"><span class="legend-color risk-legend-critical"></span> Critical</span>
    </div>
  `,n&&a.querySelectorAll(".matrix-cell.has-risks").forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-impact")||"",c=i.getAttribute("data-likelihood")||"",l=`${r}-${c}`,u=o[l]||[];n(u,r,c)})}),a}function Z4(e){const t={};return e.filter(n=>n.status!=="mitigated"&&n.status!=="closed").forEach(n=>{const s=`${n.impact}-${n.likelihood}`;t[s]||(t[s]=[]),t[s].push(n)}),t}function Vc(e){return e.charAt(0).toUpperCase()+e.slice(1)}function W4(e){const t=b("div",{className:"risk-summary"}),n={critical:e.filter(s=>s.impact==="critical"&&s.status==="open").length,high:e.filter(s=>s.impact==="high"&&s.status==="open").length,medium:e.filter(s=>s.impact==="medium"&&s.status==="open").length,low:e.filter(s=>s.impact==="low"&&s.status==="open").length};return t.innerHTML=`
    <div class="summary-bars">
      ${Object.entries(n).map(([s,a])=>`
        <div class="summary-bar">
          <span class="bar-label">${Vc(s)}</span>
          <div class="bar-track">
            <div class="bar-fill impact-${s}" style="--bar-width: ${Math.min(a*20,100)}"></div>
          </div>
          <span class="bar-count">${a}</span>
        </div>
      `).join("")}
    </div>
  `,t}let Dn=[];function K4(e={}){const{allowedTypes:t,maxFileSize:n=50*1024*1024,multiple:s=!0}=e,a=b("div",{className:"file-uploader"});a.innerHTML=`
    <div class="dropzone" id="dropzone">
      <div class="dropzone-content">
        <div class="dropzone-icon">üì§</div>
        <div class="dropzone-text">
          <p>Drag & drop files here</p>
          <p class="dropzone-subtext">or click to browse</p>
        </div>
        <input type="file" id="file-input" ${s?"multiple":""} 
               ${t?`accept="${t.join(",")}"`:""} hidden>
      </div>
    </div>
    <div class="file-queue hidden" id="file-queue"></div>
    <div class="upload-actions hidden" id="upload-actions">
      <button class="btn btn-secondary" id="clear-queue-btn">Clear</button>
      <button class="btn btn-primary" id="upload-btn">Upload Files</button>
    </div>
    <div class="processing-status hidden" id="processing-status"></div>
  `;const o=a.querySelector("#dropzone"),i=a.querySelector("#file-input"),r=a.querySelector("#file-queue"),c=a.querySelector("#upload-actions"),l=a.querySelector("#processing-status");d(o,"click",()=>i.click()),d(i,"change",()=>{i.files&&(Nu(Array.from(i.files),n),Jn(r,c)),i.value=""}),d(o,"dragover",g=>{g.preventDefault(),o.classList.add("dragover")}),d(o,"dragleave",()=>{o.classList.remove("dragover")}),d(o,"drop",g=>{g.preventDefault(),o.classList.remove("dragover");const f=Array.from(g.dataTransfer?.files||[]);f.length>0&&(Nu(f,n),Jn(r,c))});const u=a.querySelector("#clear-queue-btn");u&&d(u,"click",()=>{Dn=[],Jn(r,c)});const p=a.querySelector("#upload-btn");return p&&d(p,"click",async()=>{await Q4(r,c,l,e)}),J4(l),a}function Nu(e,t){e.forEach(n=>{if(n.size>t){m.warning(`${n.name} is too large (max ${Ji(t)})`);return}Dn.some(s=>s.file.name===n.name&&s.file.size===n.size)||Dn.push({file:n,id:`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,progress:0,status:"pending"})})}function Jn(e,t){if(Dn.length===0){e.classList.add("hidden"),t.classList.add("hidden");return}e.classList.remove("hidden"),t.classList.remove("hidden"),e.innerHTML=Dn.map(n=>`
    <div class="queued-file ${n.status}" data-id="${n.id}">
      <div class="file-info">
        <span class="file-icon">${Y4(n.file.type)}</span>
        <span class="file-name">${Gc(n.file.name)}</span>
        <span class="file-size">${Ji(n.file.size)}</span>
      </div>
      <div class="file-status">
        ${n.status==="uploading"?`
          <div class="progress-bar">
            <div class="progress-fill" style="--progress: ${n.progress}"></div>
          </div>
          <span class="progress-text">${n.progress}%</span>
        `:n.status==="complete"?`
          <span class="status-icon success">‚úì</span>
        `:n.status==="error"?`
          <span class="status-icon error">‚úï</span>
          <span class="error-text">${Gc(n.error||"Error")}</span>
        `:`
          <button class="btn-icon remove-file" data-id="${n.id}">√ó</button>
        `}
      </div>
    </div>
  `).join(""),e.querySelectorAll(".remove-file").forEach(n=>{d(n,"click",s=>{s.stopPropagation();const a=n.getAttribute("data-id");Dn=Dn.filter(o=>o.id!==a),Jn(e,t)})})}async function Q4(e,t,n,s){const a=Dn.filter(i=>i.status==="pending");if(a.length===0)return;const o=t.querySelector("#upload-btn");o&&(o.disabled=!0);try{a.forEach(r=>{r.status="uploading",r.progress=0}),Jn(e,t);const i=await Cs.upload(a.map(r=>r.file),r=>{a.forEach(c=>{c.progress=r}),Jn(e,t)});a.forEach(r=>{r.status="complete",r.progress=100}),Jn(e,t),m.success(`Uploaded ${i.files.length} file(s)`),s.onUploadComplete?.(i),setTimeout(()=>{Dn=Dn.filter(r=>r.status!=="complete"),Jn(e,t)},2e3),i.processingStarted&&(s.onProcessingStart?.(),Pg(n))}catch(i){a.forEach(r=>{r.status="error",r.error=i instanceof Error?i.message:"Upload failed"}),Jn(e,t)}finally{o&&(o.disabled=!1)}}async function J4(e){try{const t=await Cs.getProcessingStatus();(t.isProcessing||t.queueLength>0)&&(Dg(e,t),Pg(e))}catch{}}let cs=null;function Pg(e){cs||(cs=window.setInterval(async()=>{try{const t=await Cs.getProcessingStatus();Dg(e,t),!t.isProcessing&&t.queueLength===0&&(cs&&(clearInterval(cs),cs=null),setTimeout(()=>e.classList.add("hidden"),3e3))}catch{cs&&(clearInterval(cs),cs=null)}},2e3))}function Dg(e,t){e.classList.remove("hidden"),e.innerHTML=`
    <div class="processing-header">
      <span class="processing-icon">${t.isProcessing?"‚è≥":"‚úì"}</span>
      <span class="processing-title">${t.isProcessing?"Processing...":"Complete"}</span>
    </div>
    <div class="processing-stats">
      <span>Completed: ${t.completedCount}</span>
      <span>Pending: ${t.queueLength}</span>
      ${t.errorCount>0?`<span class="error">Errors: ${t.errorCount}</span>`:""}
    </div>
    ${t.processingFile?`<div class="current-file">Current: ${Gc(t.processingFile)}</div>`:""}
    ${t.isProcessing?`
      <div class="processing-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="--progress: ${t.completedCount/(t.completedCount+t.queueLength+1)*100}"></div>
        </div>
      </div>
    `:""}
  `}function Y4(e){return e.startsWith("image/")?"üñºÔ∏è":e.startsWith("video/")?"üé¨":e.startsWith("audio/")?"üéµ":e==="application/pdf"?"üìÑ":e.includes("spreadsheet")||e.includes("excel")?"üìä":e.includes("document")||e.includes("word")?"üìù":e.includes("presentation")||e.includes("powerpoint")?"üìΩÔ∏è":e.includes("text")?"üìÉ":"üìÅ"}function Gc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Vo={Person:"#6366f1",Document:"#22c55e",Question:"#f59e0b",Risk:"#ef4444",Action:"#8b5cf6",Decision:"#06b6d4",Fact:"#84cc16",Email:"#ec4899",default:"#9ca3af"};function X4(e={}){const{height:t=500}=e,n=b("div",{className:"knowledge-graph"});return n.innerHTML=`
    <div class="graph-toolbar">
      <div class="graph-filters">
        <label class="filter-item">
          <input type="checkbox" checked data-type="Person"> People
        </label>
        <label class="filter-item">
          <input type="checkbox" checked data-type="Document"> Documents
        </label>
        <label class="filter-item">
          <input type="checkbox" checked data-type="Question"> Questions
        </label>
        <label class="filter-item">
          <input type="checkbox" checked data-type="Risk"> Risks
        </label>
      </div>
      <div class="graph-actions">
        <input type="search" id="graph-search" class="search-input" placeholder="Search nodes...">
        <button class="btn btn-sm" id="graph-refresh">Refresh</button>
        <button class="btn btn-sm" id="graph-fit">Fit</button>
      </div>
    </div>
    <div class="graph-container" id="graph-container" style="--graph-height: ${t}px;">
      <div class="graph-loading">Loading graph...</div>
    </div>
    <div class="graph-stats" id="graph-stats"></div>
    <div class="node-details hidden" id="node-details"></div>
  `,Fl(n,e),n}async function Fl(e,t){const n=e.querySelector("#graph-container"),s=e.querySelector("#graph-stats");if(!window.vis){n.innerHTML=`
      <div class="graph-fallback">
        <p>Graph visualization requires vis-network library</p>
        <p class="text-muted">Add vis-network to enable interactive graph</p>
      </div>
    `,await Ou(s);return}try{const{nodes:a,edges:o}=await Cl.getVisualizationData();if(a.length===0){n.innerHTML=`
        <div class="graph-empty">
          <p>No graph data available</p>
          <p class="text-muted">Process some documents to populate the knowledge graph</p>
        </div>
      `;return}const i=e_(n,a,o,t);n_(e,i,a,t),await Ou(s)}catch{n.innerHTML=`
      <div class="graph-error">
        <p>Failed to load graph</p>
        <button class="btn btn-sm" id="retry-graph">Retry</button>
      </div>
    `;const o=n.querySelector("#retry-graph");o&&d(o,"click",()=>Fl(e,t))}}function e_(e,t,n,s){e.innerHTML="";const a=t.map(c=>({id:c.id,label:c.label||c.name||c.id,color:Vo[c.type]||Vo.default,title:`${c.type}: ${c.label||c.name||c.id}`,shape:"dot",size:t_(c)})),o=n.map(c=>({from:c.source,to:c.target,label:c.type,arrows:"to",color:{color:"#9ca3af",opacity:.6}})),i={nodes:{borderWidth:2,shadow:!0,font:{size:12,color:getComputedStyle(document.documentElement).getPropertyValue("--color-text").trim()||"#333"}},edges:{width:1,shadow:!1,smooth:{type:"continuous"},font:{size:10,color:"#9ca3af"}},physics:{stabilization:{iterations:100},barnesHut:{gravitationalConstant:-5e3,springLength:150}},interaction:{hover:!0,tooltipDelay:200}},r=new window.vis.Network(e,{nodes:new window.vis.DataSet(a),edges:new window.vis.DataSet(o)},i);return r.on("click",c=>{if(c.nodes&&c.nodes.length>0){const l=c.nodes[0],u=t.find(p=>p.id===l);u&&s.onNodeClick&&s.onNodeClick(u),s_(e,u)}}),r}function t_(e){const t=e.connections||1;return Math.min(10+t*2,30)}function n_(e,t,n,s){const a=e.querySelector("#graph-search");d(a,"input",()=>{const r=a.value.toLowerCase(),c=n.find(l=>(l.label||l.name||l.id).toLowerCase().includes(r));c&&t.focus(c.id,{scale:1.5})});const o=e.querySelector("#graph-refresh");o&&d(o,"click",()=>{Fl(e,s)});const i=e.querySelector("#graph-fit");i&&d(i,"click",()=>{t.fit()}),e.querySelectorAll(".filter-item input").forEach(r=>{d(r,"change",()=>{m.info("Filtering not yet implemented")})})}function s_(e,t){const n=e.querySelector("#node-details");if(!t){n.classList.add("hidden");return}n.classList.remove("hidden"),n.innerHTML=`
    <div class="details-header">
      <span class="node-type" style="--type-color: ${Vo[t.type]||Vo.default}">${t.type}</span>
      <span class="node-label">${Jr(t.label||t.name||t.id)}</span>
      <button class="btn-icon close-details">√ó</button>
    </div>
    ${t.properties?`
      <div class="details-properties">
        ${Object.entries(t.properties).map(([a,o])=>`
          <div class="property">
            <span class="property-key">${Jr(a)}:</span>
            <span class="property-value">${Jr(String(o))}</span>
          </div>
        `).join("")}
      </div>
    `:""}
  `;const s=n.querySelector(".close-details");s&&d(s,"click",()=>{n.classList.add("hidden")})}async function Ou(e){try{const t=await Cl.getStats();a_(e,t)}catch{e.innerHTML=""}}function a_(e,t){e.innerHTML=`
    <div class="stat-item">
      <span class="stat-value">${t.nodeCount}</span>
      <span class="stat-label">Nodes</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">${t.edgeCount}</span>
      <span class="stat-label">Edges</span>
    </div>
    ${t.nodeTypes?Object.entries(t.nodeTypes).map(([n,s])=>`
      <div class="stat-item type-${n.toLowerCase()}">
        <span class="stat-value">${s}</span>
        <span class="stat-label">${n}</span>
      </div>
    `).join(""):""}
  `}function Jr(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function i_(e={}){const{days:t=30}=e,n=b("div",{className:"timeline-container"});n.innerHTML=`
    <div class="timeline-header">
      <h3>Timeline</h3>
      <select id="timeline-days" class="filter-select">
        <option value="7" ${t===7?"selected":""}>Last 7 days</option>
        <option value="14" ${t===14?"selected":""}>Last 14 days</option>
        <option value="30" ${t===30?"selected":""}>Last 30 days</option>
        <option value="90" ${t===90?"selected":""}>Last 90 days</option>
      </select>
    </div>
    <div class="timeline-filters">
      <button class="filter-btn active" data-type="all">All</button>
      <button class="filter-btn" data-type="document">Documents</button>
      <button class="filter-btn" data-type="question">Questions</button>
      <button class="filter-btn" data-type="decision">Decisions</button>
      <button class="filter-btn" data-type="risk">Risks</button>
    </div>
    <div class="timeline-content" id="timeline-content">
      <div class="loading">Loading timeline...</div>
    </div>
  `;const s=n.querySelector("#timeline-days");d(s,"change",()=>{Fu(n,parseInt(s.value),e)});const a=n.querySelectorAll(".filter-btn");return a.forEach(o=>{d(o,"click",()=>{a.forEach(i=>i.classList.remove("active")),o.classList.add("active"),c_(n,o.getAttribute("data-type")||"all")})}),Fu(n,t,e),n}async function Fu(e,t,n){const s=e.querySelector("#timeline-content");s.innerHTML='<div class="loading">Loading...</div>';try{const a=await Yp.getAll({limit:t*10});o_(s,a.events||[],n)}catch{s.innerHTML='<div class="error">Failed to load timeline</div>'}}function o_(e,t,n){if(t.length===0){e.innerHTML='<div class="empty-state">No events in this period</div>';return}const s=r_(t);e.innerHTML=`
    <div class="timeline">
      ${Object.entries(s).map(([a,o])=>`
        <div class="timeline-day">
          <div class="timeline-date">${Os(a)}</div>
          ${o.map(i=>`
            <div class="timeline-event" data-type="${i.type}" data-id="${i.id}">
              <div class="event-marker ${i.type}"></div>
              <div class="event-content">
                <div class="event-header">
                  <span class="event-type">${i.type}</span>
                  <span class="event-time">${l_(i.date)}</span>
                </div>
                <div class="event-title">${Yr(i.title)}</div>
                ${i.description?`<div class="event-description">${Yr(i.description)}</div>`:""}
                ${i.user?`<div class="event-user">by ${Yr(i.user)}</div>`:""}
              </div>
            </div>
          `).join("")}
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".timeline-event").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);i&&n.onEventClick&&n.onEventClick(i)})})}function r_(e){const t={};return e.forEach(n=>{const s=n.date.split("T")[0];t[s]||(t[s]=[]),t[s].push(n)}),Object.fromEntries(Object.entries(t).sort(([n],[s])=>s.localeCompare(n)))}function c_(e,t){e.querySelectorAll(".timeline-event").forEach(s=>{t==="all"||s.getAttribute("data-type")===t?s.classList.remove("hidden"):s.classList.add("hidden")}),e.querySelectorAll(".timeline-day").forEach(s=>{const a=s.querySelectorAll(".timeline-event:not(.hidden)");s.classList.toggle("hidden",a.length===0)})}function l_(e){return new Date(e).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}function Yr(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const zg={document:{label:"Documents",icon:"üìÑ",color:"#1abc9c"},transcript:{label:"Transcripts",icon:"üéôÔ∏è",color:"#8b5cf6"},email:{label:"Emails",icon:"üìß",color:"#6366f1"},conversation:{label:"Conversations",icon:"üí¨",color:"#ec4899"},chat_session:{label:"Chat Sessions",icon:"ü§ñ",color:"#0ea5e9"},fact:{label:"Facts",icon:"üìå",color:"#3b82f6"},question:{label:"Questions",icon:"‚ùì",color:"#f59e0b"},question_answered:{label:"Answered",icon:"‚úÖ",color:"#10b981"},decision:{label:"Decisions",icon:"üìã",color:"#3498db"},risk:{label:"Risks",icon:"‚ö†Ô∏è",color:"#f39c12"},action:{label:"Actions",icon:"üìå",color:"#9b59b6"},action_completed:{label:"Completed",icon:"‚úÖ",color:"#2ecc71"},deadline:{label:"Deadlines",icon:"üìÖ",color:"#9b59b6"}},d_=[{label:"Last 7 days",days:7},{label:"Last 14 days",days:14},{label:"Last 30 days",days:30},{label:"Last 90 days",days:90},{label:"All time",days:365}];let Ul=30,ha="comfortable",pn=[],ca="",ba=[],bs=-1;function Ig(e={}){const t=b("div",{className:"timeline-panel sot-panel"});return t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Timeline</h2>
        <span class="panel-count" id="timeline-count">0</span>
      </div>
      <div class="panel-actions">
        <div class="timeline-search-wrapper">
          <input type="text" id="timeline-search" class="timeline-search" placeholder="Search events..." />
        </div>
        <select id="timeline-period" class="filter-select">
          ${d_.map(n=>`<option value="${n.days}" ${n.days===Ul?"selected":""}>${n.label}</option>`).join("")}
        </select>
        <div class="density-toggle" title="View density">
          <button class="density-btn ${ha==="compact"?"active":""}" data-density="compact" title="Compact">‚îÅ</button>
          <button class="density-btn ${ha==="comfortable"?"active":""}" data-density="comfortable" title="Comfortable">‚â°</button>
          <button class="density-btn ${ha==="spacious"?"active":""}" data-density="spacious" title="Spacious">‚ò∞</button>
        </div>
        <div class="timeline-actions-menu">
          <button class="btn btn-secondary btn-sm timeline-export-btn" title="Export">üì•</button>
        </div>
      </div>
    </div>
    <div class="timeline-filters" id="timeline-type-filters">
      <button class="filter-chip active" data-type="">All</button>
    </div>
    <div class="timeline-content" id="timeline-content">
      ${Hg()}
    </div>
    <div class="timeline-footer hidden" id="timeline-footer">
      <button class="btn btn-secondary btn-sm" id="timeline-load-more">Load more</button>
    </div>
  `,u_(t,e),Vl(t,e),t}function u_(e,t){const n=e.querySelector("#timeline-period");d(n,"change",()=>{Ul=parseInt(n.value),Vl(e,t)});const s=e.querySelectorAll(".density-btn");s.forEach(r=>{d(r,"click",()=>{s.forEach(c=>c.classList.remove("active")),r.classList.add("active"),ha=r.getAttribute("data-density"),h_(e)})});const a=e.querySelector("#timeline-search");let o;d(a,"input",()=>{clearTimeout(o),o=setTimeout(()=>{ca=a.value.toLowerCase(),$r(e,t)},200)});const i=e.querySelector(".timeline-export-btn");i&&d(i,"click",()=>y_(e)),d(e,"keydown",r=>{e.querySelector("#timeline-content")&&(r.key==="j"||r.key==="ArrowDown"?(r.preventDefault(),Uu(e,1)):r.key==="k"||r.key==="ArrowUp"?(r.preventDefault(),Uu(e,-1)):r.key==="Enter"?(r.preventDefault(),f_(e)):r.key==="/"?(r.preventDefault(),a.focus()):r.key==="Escape"&&(a.blur(),bs=-1,Rg(e)))}),e.setAttribute("tabindex","0")}async function Vl(e,t){const n=e.querySelector("#timeline-content");n.innerHTML=Hg();try{const s=new Date,a=new Date;a.setDate(a.getDate()-Ul),ba=(await xc({startDate:a.toISOString().split("T")[0],endDate:s.toISOString().split("T")[0],limit:500})).events||[],Bg(e,ba),$r(e,t),b_(e,ba.length)}catch(s){console.error("Failed to load timeline:",s),n.innerHTML=g_()}}function $r(e,t){let n=[...ba];pn.length>0&&(n=n.filter(i=>pn.includes(i.type))),ca&&(n=n.filter(i=>{const r=(i.title||"").toLowerCase(),c=(i.content||i.description||"").toLowerCase(),l=(i.owner||i.user||i.actor||"").toLowerCase();return r.includes(ca)||c.includes(ca)||l.includes(ca)}));const s=e.querySelector("#timeline-content");if(n.length===0){s.innerHTML=m_();return}const a=k_(n),o=new Date().toISOString().split("T")[0];s.innerHTML=`
    <div class="timeline-list density-${ha}">
      ${Object.entries(a).map(([i,r])=>`
        <div class="timeline-day" data-date="${i}">
          <div class="timeline-date-header sticky">
            <span class="date-label">${x_(i)}</span>
            <span class="event-count">${r.length} event${r.length===1?"":"s"}</span>
          </div>
          ${i===o?'<div class="today-marker"><span>Today</span></div>':""}
          <div class="timeline-day-events">
            ${r.map((c,l)=>p_(c,l)).join("")}
          </div>
        </div>
      `).join("")}
    </div>
  `,v_(e,n,t),bs=-1}function p_(e,t){const n=zg[e.type]||{label:e.type,icon:"üìé",color:"#888"},s=e.icon||n.icon,a=e.color||n.color,o=e.owner||e.user||e.actor,i=o?S_(o):"",r=e.status?`<span class="status-badge status-${e.status}">${e.status}</span>`:"",c=e.date?$_(e.date):"",l=e.date?Ce(e.date):"",u=e.date?Ts(e.date):"";return`
    <div class="timeline-event" data-id="${e.id}" data-index="${t}" tabindex="0">
      <div class="event-avatar" style="--event-color: ${a}">
        ${i||s}
      </div>
      <div class="event-body">
        <div class="event-header">
          <span class="event-type-badge" style="--event-color: ${a}">
            <span class="type-icon">${s}</span>
            ${n.label}
          </span>
          ${r}
          <span class="event-time" title="${u}">${l}</span>
        </div>
        <div class="event-title">${Xr(e.title)}</div>
        ${e.content||e.description?`<div class="event-content">${Xr(C_(e.content||e.description||"",150))}</div>`:""}
        ${o?`<div class="event-owner"><span class="owner-name">by ${Xr(o)}</span></div>`:""}
      </div>
      <div class="event-meta">
        <span class="meta-time">${c}</span>
      </div>
    </div>
  `}function Hg(){return`
    <div class="timeline-skeletons">
      ${Array(8).fill(0).map(()=>`
        <div class="skeleton-event">
          <div class="skeleton-avatar shimmer"></div>
          <div class="skeleton-body">
            <div class="skeleton-line short shimmer"></div>
            <div class="skeleton-line long shimmer"></div>
            <div class="skeleton-line medium shimmer"></div>
          </div>
        </div>
      `).join("")}
    </div>
  `}function m_(){return`
    <div class="timeline-empty">
      <div class="empty-illustration">
        <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
          <circle cx="60" cy="60" r="50" fill="var(--bg-card)" stroke="var(--border)" stroke-width="2"/>
          <path d="M60 30V60L80 75" stroke="var(--accent)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="60" cy="60" r="6" fill="var(--accent)"/>
        </svg>
      </div>
      <h3>No events found</h3>
      <p>Try adjusting your filters or date range</p>
      <div class="empty-actions">
        <button class="btn btn-primary btn-sm" id="empty-clear-filters">Clear Filters</button>
      </div>
    </div>
  `}function g_(){return`
    <div class="timeline-error">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Failed to load timeline</h3>
      <p>Please try again later</p>
      <button class="btn btn-primary btn-sm" id="timeline-retry">Retry</button>
    </div>
  `}function Bg(e,t){const n={};t.forEach(i=>{n[i.type]=(n[i.type]||0)+1});const s=e.querySelector("#timeline-type-filters"),a=Object.keys(n).filter(i=>n[i]>0);s.innerHTML=`
    <button class="filter-chip ${pn.length===0?"active":""}" data-type="">All (${t.length})</button>
    ${a.map(i=>{const r=zg[i]||{label:i,icon:"üìé",color:"#888"};return`
        <button class="filter-chip ${pn.includes(i)?"active":""}" data-type="${i}" style="--chip-color: ${r.color}">
          ${r.icon} ${r.label} (${n[i]})
        </button>
      `}).join("")}
  `;const o=s.querySelectorAll(".filter-chip");o.forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-type")||"";if(!r)pn=[],o.forEach(c=>c.classList.remove("active")),i.classList.add("active");else{const c=s.querySelector('[data-type=""]');c?.classList.remove("active"),pn.includes(r)?(pn=pn.filter(l=>l!==r),i.classList.remove("active")):(pn.push(r),i.classList.add("active")),pn.length===0&&c?.classList.add("active")}$r(e,{})})})}function v_(e,t,n){e.querySelectorAll(".timeline-event").forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);c&&n.onEventClick&&n.onEventClick(c)})});const a=e.querySelector("#empty-clear-filters");a&&d(a,"click",()=>{pn=[],ca="";const i=e.querySelector("#timeline-search");i&&(i.value=""),Bg(e,ba),$r(e,n)});const o=e.querySelector("#timeline-retry");o&&d(o,"click",()=>Vl(e,n))}function Uu(e,t,n){const s=e.querySelectorAll(".timeline-event");if(s.length===0)return;Rg(e),bs=Math.max(0,Math.min(s.length-1,bs+t));const a=s[bs];a&&(a.classList.add("focused"),a.scrollIntoView({behavior:"smooth",block:"nearest"}),a.focus())}function f_(e,t){const n=e.querySelectorAll(".timeline-event");bs>=0&&bs<n.length&&n[bs].click()}function Rg(e){e.querySelectorAll(".timeline-event.focused").forEach(t=>t.classList.remove("focused"))}function h_(e){const t=e.querySelector(".timeline-list");t&&(t.className=`timeline-list density-${ha}`)}function b_(e,t){const n=e.querySelector("#timeline-count");n&&(n.textContent=String(t))}function y_(e){const t=e.querySelector(".export-menu");if(t){t.remove();return}const n=b("div",{className:"export-menu dropdown-menu"});n.innerHTML=`
    <button class="dropdown-item" data-format="csv">üìä Export CSV</button>
    <button class="dropdown-item" data-format="json">üì¶ Export JSON</button>
  `;const s=e.querySelector(".timeline-export-btn");s&&s.appendChild(n),n.querySelectorAll(".dropdown-item").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-format");w_(o||"csv"),n.remove()})}),setTimeout(()=>{const a=o=>{n.contains(o.target)||(n.remove(),document.removeEventListener("click",a))};document.addEventListener("click",a)},0)}function w_(e){const t=ba.map(c=>({date:c.date,type:c.type,title:c.title,content:c.content||c.description,owner:c.owner||c.user||c.actor,status:c.status}));let n,s,a;if(e==="csv"){const c=["Date","Type","Title","Content","Owner","Status"],l=t.map(u=>[u.date,u.type,`"${(u.title||"").replace(/"/g,'""')}"`,`"${(u.content||"").replace(/"/g,'""')}"`,`"${(u.owner||"").replace(/"/g,'""')}"`,u.status||""].join(","));n=[c.join(","),...l].join(`
`),s=`timeline-${new Date().toISOString().split("T")[0]}.csv`,a="text/csv"}else n=JSON.stringify(t,null,2),s=`timeline-${new Date().toISOString().split("T")[0]}.json`,a="application/json";const o=new Blob([n],{type:a}),i=URL.createObjectURL(o),r=document.createElement("a");r.href=i,r.download=s,r.click(),URL.revokeObjectURL(i)}function k_(e){const t={};return e.forEach(n=>{const s=n.date?n.date.split("T")[0]:"unknown";t[s]||(t[s]=[]),t[s].push(n)}),Object.fromEntries(Object.entries(t).sort(([n],[s])=>s.localeCompare(n)))}function x_(e){const t=new Date(e+"T00:00:00"),n=new Date,s=new Date(n);s.setDate(s.getDate()-1);const a=new Date(n);a.setDate(n.getDate()-n.getDay());const o=n.toISOString().split("T")[0],i=s.toISOString().split("T")[0];return e===o?"Today":e===i?"Yesterday":t>=a?"This week - "+Os(t,{weekday:"long"}):Os(t,{weekday:"short",month:"short",day:"numeric"})}function $_(e){return new Date(e).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}function S_(e){return e.split(/\s+/).map(t=>t.charAt(0).toUpperCase()).slice(0,2).join("")}function C_(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function Xr(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const __=Object.freeze(Object.defineProperty({__proto__:null,createTimelinePanel:Ig},Symbol.toStringTag,{value:"Module"}));async function L_(){try{return(await v.get("/api/admin/billing/projects")).data?.projects||[]}catch(e){return console.error("[Billing] Error getting all projects billing:",e),[]}}async function T_(){try{return(await v.get("/api/admin/billing/pricing")).data?.config||null}catch(e){return console.error("[Billing] Error getting global pricing config:",e),null}}async function A_(e){try{return(await v.post("/api/admin/billing/pricing",e)).data||{success:!1}}catch(t){return console.error("[Billing] Error setting global pricing config:",t),{success:!1,error:String(t)}}}async function M_(){try{const e=await v.get("/api/admin/billing/pricing/tiers");return{tiers:e.data?.tiers||[],config_id:e.data?.config_id||null}}catch(e){return console.error("[Billing] Error getting global pricing tiers:",e),{tiers:[],config_id:null}}}async function E_(e){try{return(await v.post("/api/admin/billing/pricing/tiers",{tiers:e})).data||{success:!1}}catch(t){return console.error("[Billing] Error setting global pricing tiers:",t),{success:!1,error:String(t)}}}async function q_(e){try{return(await v.get(`/api/admin/billing/projects/${e}`)).data?.summary||null}catch(t){return console.error("[Billing] Error getting project billing summary:",t),null}}async function j_(e){try{const t=await v.get(`/api/admin/billing/projects/${e}/balance`);return t.data?.success?t.data:null}catch(t){return console.error("[Billing] Error getting project balance:",t),null}}async function P_(e,t,n){try{const s=await v.post(`/api/admin/billing/projects/${e}/balance`,{amount:t,description:n});return{success:s.data?.success||!1,new_balance:s.data?.new_balance,error:s.data?.reason}}catch(s){return console.error("[Billing] Error crediting project balance:",s),{success:!1,error:String(s)}}}async function D_(e,t){try{return{success:(await v.post(`/api/admin/billing/projects/${e}/balance`,{unlimited:t})).data?.success||!1}}catch(n){return console.error("[Billing] Error setting project unlimited:",n),{success:!1,error:String(n)}}}async function z_(e,t=50){try{return(await v.get(`/api/admin/billing/projects/${e}/transactions?limit=${t}`)).data?.transactions||[]}catch(n){return console.error("[Billing] Error getting balance transactions:",n),[]}}async function I_(e){try{const t=await v.get(`/api/admin/billing/projects/${e}/pricing`);return{override:t.data?.override||null,using_global:t.data?.using_global??!0,global_config:t.data?.global_config||null}}catch(t){return console.error("[Billing] Error getting project pricing override:",t),{override:null,using_global:!0,global_config:null}}}async function H_(e,t){try{return(await v.post(`/api/admin/billing/projects/${e}/pricing`,t)).data||{success:!1}}catch(n){return console.error("[Billing] Error setting project pricing override:",n),{success:!1,error:String(n)}}}async function B_(e){try{return(await v.delete(`/api/admin/billing/projects/${e}/pricing`)).data?.success||!1}catch(t){return console.error("[Billing] Error deleting project pricing override:",t),!1}}async function R_(e){try{return(await v.get(`/api/projects/${e}/billing`)).data?.summary||null}catch(t){return console.error("[Billing] Error getting project billing summary:",t),null}}function Vi(e){return new Intl.NumberFormat("pt-PT",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}function Fs(e){return e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString()}function N_(e){return!e||e.length===0?"No tiers configured":e.map((t,n)=>{const s=n>0?e[n-1].token_limit:0,a=Fs(s||0),o=t.token_limit?Fs(t.token_limit):"‚àû";return`${a}-${o}: +${t.markup_percent}%`}).join(" | ")}async function O_(){try{const e=await v.get("/api/admin/billing/exchange-rate");return e.data?.success?{auto:e.data.auto,manualRate:e.data.manualRate,currentRate:e.data.currentRate,source:e.data.source,lastUpdated:e.data.lastUpdated,defaultRate:e.data.defaultRate}:null}catch(e){return console.error("[Billing] Error getting exchange rate config:",e),null}}async function F_(e,t){try{return(await v.post("/api/admin/billing/exchange-rate",{auto:e,manualRate:t})).data||{success:!1}}catch(n){return console.error("[Billing] Error setting exchange rate mode:",n),{success:!1,error:String(n)}}}async function U_(){try{return(await v.post("/api/admin/billing/exchange-rate/refresh",{})).data||{success:!1}}catch(e){return console.error("[Billing] Error refreshing exchange rate:",e),{success:!1,error:String(e)}}}const gn={getAllProjectsBilling:L_,getGlobalPricingConfig:T_,setGlobalPricingConfig:A_,getGlobalPricingTiers:M_,setGlobalPricingTiers:E_,getProjectBillingSummaryAdmin:q_,getProjectBalance:j_,creditProjectBalance:P_,setProjectUnlimited:D_,getBalanceTransactions:z_,getProjectPricingOverride:I_,setProjectPricingOverride:H_,deleteProjectPricingOverride:B_,getExchangeRateConfig:O_,setExchangeRateMode:F_,refreshExchangeRate:U_,getProjectBillingSummary:R_,formatEur:Vi,formatTokens:Fs,getTierDisplayInfo:N_};let Ut=null;const si="costs-budget-modal";function Ng(e={}){const{period:t="month"}=e,n=b("div",{className:"costs-dashboard"});n.innerHTML=`
    <div class="costs-header">
      <div class="costs-header-title">
        <h3>LLM Costs</h3>
        <span class="costs-period-range" id="costs-period-range" aria-live="polite"></span>
      </div>
      <div class="costs-header-actions">
        <select id="costs-period" class="filter-select" aria-label="Time period">
          <option value="day" ${t==="day"?"selected":""}>Today</option>
          <option value="week" ${t==="week"?"selected":""}>This Week</option>
          <option value="month" ${t==="month"?"selected":""}>This Month</option>
          <option value="all" ${t==="all"?"selected":""}>All Time</option>
        </select>
        <button type="button" class="btn btn-secondary btn-sm" id="costs-export-btn" title="Export CSV or JSON">Export</button>
        <button type="button" class="btn btn-secondary btn-sm" id="costs-pricing-btn" title="View pricing table">Pricing</button>
        <button type="button" class="btn btn-secondary btn-sm" id="costs-budget-btn" title="Set budget and alert">Budget</button>
      </div>
    </div>
    <div class="costs-content" id="costs-content">
      <div class="loading">Loading costs...</div>
    </div>
    <div id="costs-pricing-panel" class="costs-pricing-panel hidden" aria-hidden="true"></div>
  `;const s=n.querySelector("#costs-period");d(s,"change",()=>{Zc(n,s.value)});const a=n.querySelector("#costs-export-btn");a&&d(a,"click",()=>W_(s.value));const o=n.querySelector("#costs-pricing-btn"),i=n.querySelector("#costs-pricing-panel");o&&i&&d(o,"click",()=>K_(i)),d(n,"click",c=>{c.target.id==="costs-pricing-close"&&(i?.classList.add("hidden"),i?.setAttribute("aria-hidden","true"))});const r=n.querySelector("#costs-budget-btn");return r&&d(r,"click",()=>Q_(n,s)),Zc(n,t),n}async function Zc(e,t){const n=e.querySelector("#costs-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=N.getState().currentProject?.id,[o,i,r]=await Promise.all([La.getSummary(t),La.getRecentRequests(20),a?gn.getProjectBillingSummary(a):Promise.resolve(null)]);Ut=r,V_(n,o,i);const c=e.querySelector("#costs-period-range");c&&(c.textContent=eL(o.period??{start:"",end:""}))}catch{n.innerHTML='<div class="error">Failed to load costs</div>'}}function V_(e,t,n=[]){const s=t.dailyBreakdown??[],a=t.byProvider??{},o=t.byModel??{},i=s.reduce((y,S)=>y+(S.calls??0),0),r=i>0?t.total/i:0,c=Object.entries(a).map(([y,S])=>({provider:y,cost:S})).sort((y,S)=>S.cost-y.cost),l=Object.entries(o).map(([y,S])=>({model:y,cost:S})).sort((y,S)=>S.cost-y.cost),u=new Map;for(const[y,S]of Object.entries(t.byOperation||{})){const P=y&&String(y).trim()?String(y).trim():"other";u.set(P,(u.get(P)??0)+S)}const p=Array.from(u.entries()).map(([y,S])=>({operation:y,cost:S})).sort((y,S)=>S.cost-y.cost),g=Object.entries(t.byContext||{}).map(([y,S])=>({context:y==="unknown"||!y?.trim()?"Other":y,cost:S})).sort((y,S)=>S.cost-y.cost),f=t.totalInputTokens??0,h=t.totalOutputTokens??0,k=(t.total??0)===0&&s.length===0&&Object.keys(a).length===0&&Object.keys(o).length===0,C=t.previousPeriodCost!=null&&t.percentChange!=null?`<div class="card-sub period-change ${t.percentChange>=0?"up":"down"}">vs previous period: ${t.percentChange>=0?"+":""}${t.percentChange.toFixed(1)}%</div>`:"",x=t.budgetLimit!=null&&t.budgetUsedPercent!=null?`
    <div class="costs-budget-bar ${t.budgetAlertTriggered?"alert":""}">
      <div class="costs-budget-bar-fill" style="--budget-width: ${Math.min(100,t.budgetUsedPercent)}%"></div>
      <span class="costs-budget-label">${Ln(t.total)} / ${Ln(t.budgetLimit)} (${t.budgetUsedPercent}%)</span>
      ${t.budgetAlertTriggered?'<span class="costs-budget-alert">Alert threshold reached</span>':""}
    </div>`:k?"":'<div class="costs-budget-bar costs-budget-bar-empty"><span class="costs-budget-label">No budget set</span><span class="costs-budget-set-hint">Use the Budget button above to set a limit.</span></div>',$=k?'<div class="costs-empty-state">No cost data for this period. LLM usage from Chat, document processing, and other features will appear here.</div>':"";let w="";if(Ut){const y=Ut.unlimited_balance?'<span class="costs-unlimited">‚àû Unlimited</span>':Vi(Ut.balance_eur),S=Ut.unlimited_balance?'<span class="badge badge-success costs-badge-sm">Unlimited</span>':Ut.balance_eur<=0?'<span class="badge badge-danger costs-badge-sm">Blocked</span>':Ut.balance_percent_used>=80?'<span class="badge badge-warning costs-badge-sm">Low Balance</span>':'<span class="badge badge-primary costs-badge-sm">Active</span>';w=`
      <div class="billing-summary-banner">
        <div class="billing-summary-row">
          <div>
            <div class="billing-summary-label">Project Balance</div>
            <div class="billing-summary-value">${y}</div>
          </div>
          <div>
            <div class="billing-summary-label">Status</div>
            <div>${S}</div>
          </div>
          ${Ut.current_tier_name?`
          <div>
            <div class="billing-summary-label">Current Tier</div>
            <div class="billing-summary-tier">${Ut.current_tier_name} (+${Ut.current_markup_percent}%)</div>
          </div>
          `:""}
        </div>
        <div class="billing-summary-meta">
          <div>
            <strong>${Fs(Ut.tokens_this_period)}</strong> tokens this period
          </div>
          <div>
            <strong>${Vi(Ut.billable_cost_this_period)}</strong> billed (${Ut.period_key})
          </div>
        </div>
      </div>
    `}e.innerHTML=`
    ${w}
    <div class="costs-dashboard-row">
      <div class="costs-stats-grid stats-grid">
        <div class="costs-stat-card stat-card" data-stat-id="cost-total">
          <div class="stat-value">${Ln(t.total)}</div>
          <div class="stat-label">Total Cost</div>
          ${C}
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-calls">
          <div class="stat-value">${_i(i)}</div>
          <div class="stat-label">API Calls</div>
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-avg">
          <div class="stat-value">${Ln(r)}</div>
          <div class="stat-label">Avg per Call</div>
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-input">
          <div class="stat-value">${_i(f)}</div>
          <div class="stat-label">Input Tokens</div>
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-output">
          <div class="stat-value">${_i(h)}</div>
          <div class="stat-label">Output Tokens</div>
        </div>
      </div>
    </div>
    ${x}
    ${$}

    <div class="costs-chart-section chart-container">
      <h4 class="costs-chart-title">Daily Costs</h4>
      <div class="costs-chart-inner">
        ${X_(s,t.period??{})}
      </div>
    </div>

    <div class="costs-breakdown">
      <div class="breakdown-section">
        <h4>By Provider</h4>
        <div class="breakdown-list">
          ${c.length>0?c.map(y=>`
            <div class="breakdown-item">
              <span class="item-name">${fs(y.provider)}</span>
              <span class="item-value">${Ln(y.cost)}</span>
            </div>
          `).join(""):'<div class="empty">No data</div>'}
        </div>
      </div>

      <div class="breakdown-section">
        <h4>By Model</h4>
        <div class="breakdown-list">
          ${l.length>0?l.map(y=>`
            <div class="breakdown-item">
              <span class="item-name">${fs(y.model)}</span>
              <span class="item-value">${Ln(y.cost)}</span>
            </div>
          `).join(""):'<div class="empty">No data</div>'}
        </div>
      </div>

      <div class="breakdown-section">
        <h4>By Operation</h4>
        <div class="breakdown-list">
          ${p.length>0?p.map(y=>`
            <div class="breakdown-item">
              <span class="item-name">${fs(y.operation)}</span>
              <span class="item-value">${Ln(y.cost)}</span>
            </div>
          `).join(""):'<div class="empty">No data</div>'}
        </div>
      </div>

      ${g.length>0?`
      <div class="breakdown-section">
        <h4>By Context</h4>
        <div class="breakdown-list">
          ${g.map(y=>`
            <div class="breakdown-item">
              <span class="item-name">${fs(y.context)}</span>
              <span class="item-value">${Ln(y.cost)}</span>
            </div>
          `).join("")}
        </div>
      </div>
      `:""}
    </div>

    <div class="costs-recent-section">
      <h4>Recent Requests <span class="costs-recent-caption">(last 20, all time)</span></h4>
      ${G_(n)}
    </div>
  `}function G_(e){return e.length?`
    <div class="costs-recent-table-wrap">
      <table class="costs-recent-table" aria-label="Recent LLM requests">
        <thead>
          <tr>
            <th>Time</th>
            <th>Provider / Model</th>
            <th>Operation</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>Latency</th>
          </tr>
        </thead>
        <tbody>
          ${e.slice(0,20).map(t=>`
            <tr>
              <td>${Z_(t.timestamp)}</td>
              <td>${fs(t.provider)} / ${fs(t.model)}</td>
              <td>${fs(t.request_type||t.operation||"‚Äî")}</td>
              <td>${t.input_tokens??0}+${t.output_tokens??0}</td>
              <td>${t.cost!=null?Ln(t.cost):"‚Äî"}</td>
              <td>${t.latency_ms!=null?`${t.latency_ms}ms`:"‚Äî"}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `:'<div class="empty-recent">No recent requests</div>'}function Z_(e){const t=new Date(e),s=new Date().getTime()-t.getTime();return s<6e4?"Just now":s<36e5?`${Math.floor(s/6e4)}m ago`:s<864e5?`${Math.floor(s/36e5)}h ago`:t.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}async function W_(e){const t=window.confirm(`Download as JSON?

Cancel = CSV, OK = JSON`)?"json":"csv",n=t==="json"?"json":"csv",s=`/api/costs/export?period=${e}&format=${t}`;try{const a=await at(s);if(!a.ok)throw new Error(a.statusText);const o=await a.blob(),i=`llm-costs-${e}-${new Date().toISOString().split("T")[0]}.${n}`,r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=i,r.click(),URL.revokeObjectURL(r.href)}catch(a){console.error("Export failed:",a),alert("Export failed. Try again.")}}async function K_(e){if(e.classList.contains("hidden")&&!e.innerHTML.trim()){e.innerHTML='<div class="loading">Loading pricing...</div>',e.classList.remove("hidden"),e.setAttribute("aria-hidden","false");try{const n=await La.getPricing();e.innerHTML=J_(n)}catch{e.innerHTML='<div class="error">Failed to load pricing</div>'}}else e.classList.toggle("hidden"),e.setAttribute("aria-hidden",String(e.classList.contains("hidden")))}async function Q_(e,t){const n=t.value,s=n==="week"?"week":"month",a=document.querySelector(`[data-modal-id="${si}"]`);a&&a.remove();let o=100,i=80;try{const f=await La.getBudget(s);f?.limitUsd!=null&&f.limitUsd>0&&(o=f.limitUsd),f?.alertThresholdPercent!=null&&(i=Math.min(100,Math.max(0,f.alertThresholdPercent)))}catch{}const r=b("div",{className:"costs-budget-modal-body"});r.innerHTML=`
    <p class="costs-budget-modal-desc">Set a ${s}ly spending limit and get an alert when usage reaches a percentage of that limit.</p>
    <div class="form-group">
      <label for="costs-budget-limit">Budget limit (USD)</label>
      <input type="number" id="costs-budget-limit" class="form-input" min="1" max="999999" step="0.01" value="${o}" placeholder="e.g. 100" aria-label="Budget limit in USD">
      <span class="form-hint">Min 1 USD</span>
    </div>
    <div class="form-group">
      <label for="costs-budget-threshold">Alert when usage reaches (%)</label>
      <input type="number" id="costs-budget-threshold" class="form-input" min="0" max="100" value="${i}" placeholder="e.g. 80" aria-label="Alert threshold percentage">
      <span class="form-hint">0‚Äì100%</span>
    </div>
    <p class="costs-budget-modal-hint" role="status">You will be notified when LLM costs reach this percentage of your budget.</p>
  `;const c=b("div",{className:"modal-footer"}),l=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),u=b("button",{className:"btn btn-primary",textContent:"Save budget"}),p=Pe({id:si,title:`Set ${s==="week"?"weekly":"monthly"} budget`,content:r,size:"md",closable:!0,footer:c});p.classList.add("costs-budget-modal");const g=r.querySelector(".costs-budget-modal-hint");d(l,"click",()=>K(si)),d(u,"click",async()=>{const f=r.querySelector("#costs-budget-limit"),h=r.querySelector("#costs-budget-threshold"),k=f?parseFloat(f.value):NaN,C=h!=null?parseInt(h.value,10):NaN,x=Number.isFinite(C)?Math.min(100,Math.max(0,C)):80;if(g.textContent="You will be notified when LLM costs reach this percentage of your budget.",!Number.isFinite(k)||k<1){g.textContent="Enter a valid budget (min 1 USD).",g.classList.add("costs-budget-modal-hint-error"),f?.focus();return}if(!Number.isFinite(C)||C<0||C>100){g.textContent="Alert threshold must be between 0 and 100%.",g.classList.add("costs-budget-modal-hint-error"),h?.focus();return}g.classList.remove("costs-budget-modal-hint-error"),u.setAttribute("disabled","true"),u.textContent="Saving‚Ä¶";try{await La.setBudget(s,k,x),K(si),Zc(e,t.value),m.success("Budget saved")}catch($){console.error("Set budget failed:",$),g.textContent="Failed to save. Please try again.",g.classList.add("costs-budget-modal-hint-error"),m.error("Failed to save budget")}finally{u.removeAttribute("disabled"),u.textContent="Save budget"}}),c.append(l,u),document.body.appendChild(p),De(si)}function J_(e){return e.length?`
    <div class="costs-pricing-header">
      <h4>Model pricing (USD per 1M tokens)</h4>
      <button type="button" class="btn btn-sm" id="costs-pricing-close" aria-label="Close">√ó</button>
    </div>
    <div class="costs-pricing-table-wrap">
      <table class="costs-pricing-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>Input</th>
            <th>Output</th>
          </tr>
        </thead>
        <tbody>
          ${e.map(t=>`
            <tr>
              <td>${fs(t.model)}</td>
              <td>$${t.inputPer1M.toFixed(2)}</td>
              <td>$${t.outputPer1M.toFixed(2)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `:'<div class="empty">No pricing data</div>'}function Y_(e){const n=[],s=new Date;for(let a=13;a>=0;a--){const o=new Date(s);o.setDate(o.getDate()-a),n.push({date:o.toISOString().split("T")[0],cost:0,calls:0})}return n}function X_(e,t){const n=e.length>0?e:Y_(),s=Math.max(1e-9,...n.map(o=>o.cost)),a=e.length===0;return`
    <div class="daily-chart">
      <div class="chart-bars">
        ${n.map(o=>{const i=s>0?Math.max(2,o.cost/s*100):2;return`
            <div class="bar-column" title="${o.date}: ${Ln(o.cost)} (${o.calls} calls)">
              <div class="bar ${a&&o.cost===0?"bar-placeholder":""}" style="--bar-height: ${i}%"></div>
              <div class="bar-label">${tL(o.date)}</div>
            </div>
          `}).join("")}
      </div>
      ${a?'<p class="chart-placeholder-hint">No cost data for this period. Usage will appear here as you use LLM features.</p>':""}
    </div>
  `}function eL(e){if(!e.start||!e.end)return"All time";const t=new Date(e.start),n=new Date(e.end),s=a=>a.toLocaleDateString(void 0,{month:"short",day:"numeric"});return`${s(t)} - ${s(n)}`}function tL(e){return new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric"})}function fs(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const nL=Object.freeze(Object.defineProperty({__proto__:null,createCostsDashboard:Ng},Symbol.toStringTag,{value:"Module"}));let Gl=!1,Gi="",fn=0,ps=[];const sL={question:"‚ùì",risk:"‚ö†Ô∏è",action:"‚úì",decision:"‚öñÔ∏è",contact:"üë§",document:"üìÑ",email:"üìß",fact:"üí°"};function Og(e={}){let t=document.getElementById("global-search-modal");t||(t=aL(e),document.body.appendChild(t)),Qt.register("mod+k",n=>{n.preventDefault(),Wc()}),Qt.register("/",n=>{document.activeElement?.tagName!=="INPUT"&&document.activeElement?.tagName!=="TEXTAREA"&&(n.preventDefault(),Wc())})}function aL(e){const t=b("div",{id:"global-search-modal",className:"global-search-modal hidden"});t.innerHTML=`
    <div class="search-backdrop"></div>
    <div class="search-dialog">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="global-search-input" class="search-input" 
               placeholder="Search questions, risks, contacts..." autocomplete="off">
        <kbd class="search-shortcut">ESC</kbd>
      </div>
      <div class="search-results" id="search-results">
        <div class="search-hint">
          <p>Start typing to search...</p>
          <div class="search-tips">
            <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
            <span><kbd>Enter</kbd> Select</span>
            <span><kbd>ESC</kbd> Close</span>
          </div>
        </div>
      </div>
      <div class="search-footer">
        <span>Type to search</span>
        <span>Press <kbd>?</kbd> for more shortcuts</span>
      </div>
    </div>
  `;const n=t.querySelector(".search-backdrop"),s=t.querySelector("#global-search-input"),a=t.querySelector("#search-results");return d(n,"click",Na),d(s,"input",()=>{Gi=s.value,fn=0,oL(a,e)}),d(s,"keydown",o=>{iL(o,a,e)}),t}function Wc(){Gl?Na():Fg()}function Fg(){const e=document.getElementById("global-search-modal");if(!e)return;Gl=!0,e.classList.remove("hidden");const t=e.querySelector("#global-search-input");t.value="",t.focus(),Gi="",ps=[],fn=0;const n=e.querySelector("#search-results");n.innerHTML=`
    <div class="search-hint">
      <p>Start typing to search...</p>
      <div class="search-tips">
        <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
        <span><kbd>Enter</kbd> Select</span>
        <span><kbd>ESC</kbd> Close</span>
      </div>
    </div>
  `,document.addEventListener("keydown",Ug)}function Na(){const e=document.getElementById("global-search-modal");e&&(Gl=!1,e.classList.add("hidden"),document.removeEventListener("keydown",Ug))}function Ug(e){e.key==="Escape"&&Na()}function iL(e,t,n){switch(e.key){case"ArrowDown":e.preventDefault(),fn=Math.min(fn+1,ps.length-1),Kc(t);break;case"ArrowUp":e.preventDefault(),fn=Math.max(fn-1,0),Kc(t);break;case"Enter":e.preventDefault();const s=ps[fn];s&&Vg(s,n);break;case"Escape":Na();break}}function Kc(e){e.querySelectorAll(".search-result").forEach((n,s)=>{n.classList.toggle("selected",s===fn),s===fn&&n.scrollIntoView({block:"nearest"})})}let Vu;function oL(e,t){clearTimeout(Vu),Vu=window.setTimeout(()=>{rL(e,t)},200)}async function rL(e,t){if(!Gi.trim()){e.innerHTML=`
      <div class="search-hint">
        <p>Start typing to search...</p>
        <div class="search-tips">
          <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
          <span><kbd>Enter</kbd> Select</span>
          <span><kbd>ESC</kbd> Close</span>
        </div>
      </div>
    `,ps=[];return}e.innerHTML='<div class="search-loading">Searching...</div>';try{ps=(await v.get(`/api/search?q=${encodeURIComponent(Gi)}&limit=10`)).data.results||[],Gu(e,ps,t)}catch{ps=cL(),Gu(e,ps,t)}}function cL(e){return[]}function Gu(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="search-empty">
        <p>No results found for "${ec(Gi)}"</p>
      </div>
    `;return}const s=dL(t);e.innerHTML=Object.entries(s).map(([a,o])=>`
    <div class="search-group">
      <div class="group-label">${uL(a)}s</div>
      ${o.map((i,r)=>`
        <div class="search-result ${r===fn?"selected":""}" data-index="${t.indexOf(i)}">
          <span class="result-icon">${sL[i.type]||"üìã"}</span>
          <div class="result-content">
            <div class="result-title">${ec(i.title)}</div>
            ${i.subtitle?`<div class="result-subtitle">${ec(i.subtitle)}</div>`:""}
          </div>
          <span class="result-type">${i.type}</span>
        </div>
      `).join("")}
    </div>
  `).join(""),e.querySelectorAll(".search-result").forEach(a=>{d(a,"click",()=>{const o=parseInt(a.getAttribute("data-index")||"0"),i=t[o];i&&Vg(i,n)}),d(a,"mouseenter",()=>{fn=parseInt(a.getAttribute("data-index")||"0"),Kc(e)})})}function Vg(e,t){Na(),t.onResultClick?t.onResultClick(e):lL(e)}function lL(e){window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{type:e.type,id:e.id}}))}function dL(e){const t={};return e.forEach(n=>{t[n.type]||(t[n.type]=[]),t[n.type].push(n)}),t}function uL(e){return e.charAt(0).toUpperCase()+e.slice(1)}function ec(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let Zt=new Set;function pL(e){const t=b("div",{className:"bulk-actions-bar hidden"});t.innerHTML=`
    <div class="bulk-info">
      <span class="bulk-count">0</span> selected
    </div>
    <div class="bulk-buttons">
      ${mL(e.type)}
      <button class="btn btn-sm btn-secondary" id="bulk-clear">Clear</button>
    </div>
  `;const n=t.querySelector("#bulk-clear");return n&&d(n,"click",()=>{Zl(),Sr(t)}),gL(t,e),t}function mL(e){const t=`
    <button class="btn btn-sm btn-danger" id="bulk-delete">Delete</button>
  `;switch(e){case"questions":return`
        <button class="btn btn-sm" id="bulk-status" data-status="resolved">Mark Resolved</button>
        <button class="btn btn-sm" id="bulk-assign">Assign To...</button>
        ${t}
      `;case"actions":return`
        <button class="btn btn-sm" id="bulk-status" data-status="completed">Mark Complete</button>
        <button class="btn btn-sm" id="bulk-assign">Assign To...</button>
        ${t}
      `;case"risks":return`
        <button class="btn btn-sm" id="bulk-status" data-status="mitigated">Mark Mitigated</button>
        ${t}
      `;case"decisions":return`
        <button class="btn btn-sm" id="bulk-status" data-status="approved">Approve</button>
        <button class="btn btn-sm" id="bulk-status" data-status="rejected">Reject</button>
        ${t}
      `;default:return t}}function gL(e,t){const n=e.querySelector("#bulk-delete");n&&d(n,"click",async()=>{confirm(`Delete ${Zt.size} items?`)&&await tc({type:t.type,ids:Array.from(Zt),action:"delete"},t)}),e.querySelectorAll('[id^="bulk-status"]').forEach(o=>{d(o,"click",async()=>{const i=o.getAttribute("data-status");i&&await tc({type:t.type,ids:Array.from(Zt),action:"status",data:{status:i}},t)})});const a=e.querySelector("#bulk-assign");a&&d(a,"click",()=>{const o=prompt("Assign to:");o&&tc({type:t.type,ids:Array.from(Zt),action:"assign",data:{assignee:o}},t)})}async function tc(e,t){try{let n="",s={type:e.type,ids:e.ids};switch(e.action){case"delete":n="/api/bulk/delete";break;case"status":n="/api/bulk/status",s={...s,status:e.data?.status};break;case"assign":n="/api/bulk/assign",s={...s,assignee:e.data?.assignee};break}const a=await v.post(n,s);a.data.actionId&&mn.push({type:`bulk-${e.action}`,description:`${e.action} ${e.ids.length} items`,undo:async()=>{await v.post(`/api/undo/${a.data.actionId}`),t.onComplete?.()}}),m.success(`Updated ${a.data.affected||e.ids.length} items`),Zl(),t.onComplete?.()}catch{m.error("Bulk operation failed")}}function Gg(e,t){Zt.has(e)?Zt.delete(e):Zt.add(e),Sr(t)}function vL(e,t){Zt.add(e),Sr(t)}function fL(e,t){Zt.delete(e),Sr(t)}function Zl(){Zt.clear(),document.querySelectorAll(".bulk-checkbox:checked").forEach(e=>{e.checked=!1})}function hL(){return Array.from(Zt)}function Qc(e){return Zt.has(e)}function Sr(e){const t=Zt.size;e.classList.toggle("hidden",t===0);const n=e.querySelector(".bulk-count");n&&(n.textContent=String(t))}function bL(e,t){const n=b("input",{type:"checkbox",className:"bulk-checkbox"});return n.setAttribute("data-id",e),n.checked=Qc(e),d(n,"change",s=>{s.stopPropagation(),Gg(e,t),n.checked=Qc(e)}),n}function yL(e={}){const t=b("div",{className:"sync-status"});t.innerHTML=`
    <div class="sync-indicator" id="sync-indicator">
      <span class="sync-icon">‚ü≥</span>
      <span class="sync-text">Checking...</span>
    </div>
    ${e.showDetails?`
      <div class="sync-details hidden" id="sync-details">
        <div class="sync-info"></div>
        <div class="dead-letters"></div>
      </div>
    `:""}
  `;const n=t.querySelector("#sync-indicator");return e.showDetails&&d(n,"click",()=>{const s=t.querySelector("#sync-details"),a=s.classList.contains("hidden");s.classList.toggle("hidden"),a&&Zg(t)}),Zu(t),setInterval(()=>Zu(t),3e4),t}async function Zu(e){try{const t=await v.get("/api/sync/status");Wu(e,t.data)}catch{Wu(e,{connected:!1,lastSync:null,pendingCount:0,errorCount:0})}}function Wu(e,t){const n=e.querySelector(".sync-icon"),s=e.querySelector(".sync-text"),a=e.querySelector(".sync-indicator");t.connected?t.pendingCount>0?(n.textContent="‚ü≥",s.textContent=`Syncing (${t.pendingCount})`,a.classList.remove("synced","error"),a.classList.add("syncing")):t.errorCount>0?(n.textContent="!",s.textContent=`${t.errorCount} errors`,a.classList.remove("synced","syncing"),a.classList.add("error")):(n.textContent="‚úì",s.textContent=t.lastSync?Ce(t.lastSync):"Synced",a.classList.remove("syncing","error"),a.classList.add("synced")):(n.textContent="‚ö†",s.textContent="Disconnected",a.classList.remove("synced","syncing"),a.classList.add("error"))}async function Zg(e){const t=e.querySelector(".sync-info"),n=e.querySelector(".dead-letters");t.innerHTML='<div class="loading">Loading...</div>';try{const a=(await v.get("/api/sync/status")).data;t.innerHTML=`
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Status</span>
          <span class="info-value ${a.connected?"success":"error"}">
            ${a.connected?"Connected":"Disconnected"}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">Last Sync</span>
          <span class="info-value">${a.lastSync?Ce(a.lastSync):"Never"}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Pending</span>
          <span class="info-value">${a.pendingCount}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Errors</span>
          <span class="info-value ${a.errorCount>0?"error":""}">${a.errorCount}</span>
        </div>
      </div>
    `;const i=(await v.get("/api/sync/dead-letters")).data.deadLetters||[];i.length>0?(n.innerHTML=`
        <h4>Failed Operations</h4>
        <div class="dead-letters-list">
          ${i.map(r=>`
            <div class="dead-letter" data-id="${r.id}">
              <div class="dl-header">
                <span class="dl-type">${r.type}</span>
                <span class="dl-time">${Ce(r.failedAt)}</span>
              </div>
              <div class="dl-error">${kL(r.error)}</div>
              <div class="dl-actions">
                <button class="btn btn-sm retry-btn" data-id="${r.id}">Retry</button>
                <span class="dl-retries">${r.retryCount} attempts</span>
              </div>
            </div>
          `).join("")}
        </div>
      `,n.querySelectorAll(".retry-btn").forEach(r=>{d(r,"click",async()=>{const c=r.getAttribute("data-id");if(c)try{await v.post(`/api/sync/retry/${c}`),m.success("Retry scheduled"),Zg(e)}catch{m.error("Retry failed")}})})):n.innerHTML=""}catch{t.innerHTML='<div class="error">Failed to load details</div>'}}function wL(){const e=b("div",{className:"sync-indicator-mini"});return e.innerHTML='<span class="sync-dot"></span>',Ku(e),setInterval(()=>Ku(e),3e4),e}async function Ku(e){try{const t=await v.get("/api/sync/status"),n=e.querySelector(".sync-dot");t.data.connected?t.data.errorCount>0?(n.className="sync-dot warning",e.title=`${t.data.errorCount} sync errors`):(n.className="sync-dot success",e.title="Synced"):(n.className="sync-dot error",e.title="Disconnected")}catch{const t=e.querySelector(".sync-dot");t.className="sync-dot error",e.title="Connection error"}}function kL(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}class xL{dialog=null;input=null;list=null;items=[];selectedIndex=0;visibleItems=[];constructor(){this.createDialog(),this.registerShortcut(),this.registerDefaultCommands()}createDialog(){this.dialog=b("dialog",{className:"command-palette-dialog"});const t=b("div",{className:"cmd-header"}),n=b("div",{className:"cmd-search-icon",innerHTML:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>'});this.input=b("input",{type:"text",className:"cmd-input",placeholder:"Type a command or search..."}),t.appendChild(n),t.appendChild(this.input),this.list=b("div",{className:"cmd-list"});const s=b("div",{className:"cmd-footer"});s.innerHTML=`
      <span><span class="cmd-shortcut">‚Üë‚Üì</span> to navigate</span>
      <span><span class="cmd-shortcut">‚Üµ</span> to select</span>
      <span><span class="cmd-shortcut">esc</span> to close</span>
    `,this.dialog.appendChild(t),this.dialog.appendChild(this.list),this.dialog.appendChild(s),document.body.appendChild(this.dialog),this.input.addEventListener("input",()=>this.filterItems()),this.input.addEventListener("keydown",a=>this.handleKeydown(a)),this.dialog.addEventListener("click",a=>{a.target===this.dialog&&this.close()}),this.dialog.addEventListener("close",()=>this.close())}registerShortcut(){Qt.register({key:"k",ctrl:!0,description:"Open Command Palette",handler:()=>{this.open()}}),window.addEventListener("keydown",t=>{(t.ctrlKey||t.metaKey)&&t.key==="k"&&(t.preventDefault(),this.open())})}registerDefaultCommands(){this.items=[{id:"nav-dashboard",title:"Go to Dashboard",section:"Navigation",icon:"üè†",action:()=>this.navigate("dashboard"),keywords:["home","main"]},{id:"nav-projects",title:"Go to Projects",section:"Navigation",icon:"üìÅ",action:()=>this.navigate("projects"),keywords:["list","manage"]},{id:"nav-chat",title:"Go to Chat",section:"Navigation",icon:"üí¨",action:()=>this.navigate("chat"),keywords:["ai","copilot","assistant"]},{id:"nav-sot",title:"Go to Source of Truth",section:"Navigation",icon:"üß†",action:()=>this.navigate("sot"),keywords:["facts","risks","decisions"]},{id:"nav-settings",title:"Go to Settings",section:"Navigation",icon:"‚öôÔ∏è",action:()=>this.navigate("settings"),keywords:["config","preferences"]},{id:"act-new-project",title:"Create New Project",section:"Actions",icon:"‚ûï",action:()=>{window.__godmodeProjectsOpen="create",this.navigate("projects")},keywords:["add","start"]},{id:"act-theme",title:"Toggle Theme",section:"Actions",icon:"üåì",action:()=>tt.cycle(),keywords:["dark","light","mode"]},{id:"act-logout",title:"Sign Out",section:"Account",icon:"üö™",action:()=>document.getElementById("logout-btn")?.click(),keywords:["log out","exit"]}]}open(){this.dialog&&!this.dialog.open&&(this.dialog.showModal(),this.input?.focus(),this.input.value="",this.filterItems())}close(){this.dialog&&this.dialog.open&&this.dialog.close()}navigate(t){const n=document.querySelector(`.nav-item[data-tab="${t}"]`);n&&n.click(),this.close()}filterItems(){const t=this.input?.value.toLowerCase().trim()||"";t?this.visibleItems=this.items.filter(n=>n.title.toLowerCase().includes(t)||n.section.toLowerCase().includes(t)||n.keywords?.some(s=>s.includes(t))):this.visibleItems=this.items,this.renderList()}renderList(){if(!this.list)return;if(this.list.innerHTML="",this.selectedIndex=0,this.visibleItems.length===0){this.list.innerHTML='<div style="padding:1rem;text-align:center;color:var(--color-text-muted)">No commands found</div>';return}let t="";this.visibleItems.forEach((n,s)=>{if(n.section!==t){const c=b("div",{className:"cmd-section-title"},[n.section]);this.list.appendChild(c),t=n.section}const a=b("div",{className:`cmd-item ${s===0?"selected":""}`,"data-index":s}),o=b("div",{className:"cmd-item-icon"},[n.icon||"üîπ"]),i=b("div",{className:"cmd-item-content"}),r=b("div",{className:"cmd-item-title"},[n.title]);i.appendChild(r),n.description&&i.appendChild(b("div",{className:"cmd-item-desc"},[n.description])),a.appendChild(o),a.appendChild(i),a.addEventListener("click",()=>{n.action(),this.close()}),a.addEventListener("mouseenter",()=>{this.selectedIndex=s,this.updateSelection()}),this.list.appendChild(a)})}updateSelection(){if(!this.list)return;this.list.querySelectorAll(".cmd-item").forEach((n,s)=>{s===this.selectedIndex?(n.classList.add("selected"),n.scrollIntoView({block:"nearest"})):n.classList.remove("selected")})}handleKeydown(t){if(t.key==="ArrowDown")t.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.visibleItems.length-1),this.updateSelection();else if(t.key==="ArrowUp")t.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.updateSelection();else if(t.key==="Enter"){t.preventDefault();const n=this.visibleItems[this.selectedIndex];n&&(n.action(),this.close())}else t.key==="Escape"&&this.close()}}let nc=null;function Wg(){return nc||(nc=new xL),nc}const ke={title:"Companies",newCompany:"+ New company",noCompanies:"No companies yet. Create one to use in projects.",edit:"Edit",analyze:"Analyze",reAnalyze:"Re-analyze",viewDetail:"View",detail:"Company detail",analyzedOn:"Analyzed",notAnalyzed:"Not analyzed",delete:"Delete",backToList:"Companies",name:"Name *",description:"Description",logoUrl:"Logo URL",website:"Website",linkedIn:"LinkedIn",save:"Save",create:"Create",cancel:"Cancel",invalidUrl:"Please enter a valid URL",updateFailed:"Update failed",createFailed:"Create failed",loadFailed:"Failed to load company",analysisComplete:"Analysis complete",analysisFailed:"Analysis failed",deleteConfirm:"Delete this company? Projects using it must be reassigned first.",companyDeleted:"Company deleted",templates:"Templates (A4 / PPT)",templateA4:"A4 document",templatePPT:"Presentation",generateWithAI:"Generate base with AI",loadCurrent:"Load current",saveTemplate:"Save template",templateLoaded:"Template loaded",templateSaved:"Template saved",templateGenerated:"Template generated",templateLoadFailed:"Failed to load template",templateSaveFailed:"Failed to save template",templateGenerateFailed:"Generation failed"};function pe(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function sc(e){if(!e||!e.trim())return!0;try{const t=new URL(e.trim());return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}function go(e){return`
    <div class="companies-breadcrumbs">
      ${e.map((t,n)=>n===e.length-1?`<span class="companies-breadcrumb-active">${pe(t.label)}</span>`:`
          <span class="breadcrumb-link companies-breadcrumb-link">${pe(t.label)}</span>
          <span class="companies-breadcrumb-separator">/</span>
        `).join("")}
    </div>
  `}function $L(e){e.innerHTML="";const t=b("div",{className:"companies-panel-content"});e.appendChild(t);function n(u){const p=t.querySelector("#companies-list");if(!p)return;const g=t.querySelector(".breadcrumbs-slot");g&&(g.innerHTML=go([{label:"Settings"},{label:"Companies"}]));const f=Array.isArray(u)?u:[];try{if(f.length===0){p.innerHTML=`<p class="companies-empty-state">${pe(ke.noCompanies)}</p>`;return}const h=k=>k.brand_assets?.analyzed_at;p.innerHTML=f.map(k=>{const C=!!h(k),x=C?ke.reAnalyze:ke.analyze,$=C?`<span class="companies-analyzed-badge" title="${pe(h(k)||"")}">${pe(ke.analyzedOn)}</span>`:`<span class="companies-not-analyzed-badge">${pe(ke.notAnalyzed)}</span>`;return`
      <div class="companies-row" data-id="${k.id}">
        <div class="companies-logo-wrapper">
          ${k.logo_url?`<img src="${pe(k.logo_url)}" alt="" class="companies-logo">`:'<span class="companies-logo-placeholder">üè¢</span>'}
          <div>
            <div class="companies-name-group">
                <strong class="companies-name">${pe(k.name)}</strong>
                ${$}
            </div>
            ${k.brand_assets?.primary_color&&k.brand_assets?.secondary_color?`<div class="companies-colors"><div class="companies-color-pill" style="background: ${pe(k.brand_assets.primary_color)};"></div><div class="companies-color-pill" style="background: ${pe(k.brand_assets.secondary_color)};"></div></div>`:""}
            ${k.website_url?`<a href="${pe(k.website_url)}" target="_blank" class="companies-website-link">${pe(k.website_url.replace(/^https?:\/\//,""))}</a>`:""}
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-sm btn-secondary companies-detail-btn" data-id="${k.id}" title="View analysis">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> 
            <span class="desktop-only">${pe(ke.viewDetail)}</span>
          </button>
          <button type="button" class="btn btn-sm btn-secondary companies-edit-btn" data-id="${k.id}" title="${pe(ke.edit)}">
             <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
             <span class="desktop-only">${pe(ke.edit)}</span>
          </button>
          <button type="button" class="btn btn-sm btn-secondary companies-templates-list-btn" data-id="${k.id}" title="${pe(ke.templates)}">
             <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
             <span class="desktop-only">${pe(ke.templates)}</span>
          </button>
          <button type="button" class="btn btn-sm btn-secondary companies-analyze-btn" data-id="${k.id}" title="Analyze with AI">
             <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
             <span class="desktop-only">${pe(x)}</span>
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger companies-delete-btn" data-id="${k.id}">
             <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          </button>
        </div>
      </div>
    `}).join("")}catch{p.innerHTML=`<p class="text-error">${pe(ke.loadFailed)}</p>`}}function s(){const u=t.querySelector("#companies-list");u&&(u.innerHTML='<div style="padding: 40px; text-align: center; color: var(--text-secondary);"><div class="spinner"></div> Loading companies...</div>'),mr().then(p=>n(Array.isArray(p)?p:[])).catch(()=>{const p=t.querySelector("#companies-list");p&&(p.innerHTML=`<p class="text-error">${pe(ke.loadFailed)}</p>`)})}function a(){t.innerHTML=`
      <div class="breadcrumbs-slot"></div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <div>
            <h2 style="font-size: 1.5rem; margin: 0; font-weight: 600;">Companies</h2>
             <p style="margin: 4px 0 0 0; color: var(--text-secondary);">Manage company profiles and assets</p>
          </div>
          <button type="button" class="btn btn-primary" id="companies-new-btn">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            ${pe(ke.newCompany)}
          </button>
      </div>
      <div id="companies-list" style="max-width: 800px;">Loading...</div>
    `,l(),s()}function o(u){const p=!!u,g=p?`Edit ${u.name}`:"New Company",f=[{label:"Settings"},{label:"Companies",onClick:a},{label:p?"Edit":"New"}];t.innerHTML=`
      <div class="settings-breadcrumbs-container"></div>
      
      <div style="max-width: 600px;">
          <h2 style="font-size: 1.5rem; margin: 0 0 24px 0; font-weight: 600;">${pe(g)}</h2>
          
          <form id="company-form" class="company-form">
            <div class="form-group">
              <label>${pe(ke.name)}</label>
              <input type="text" name="name" required value="${u?pe(u.name):""}" class="form-input">
            </div>
            
            <div class="form-group">
              <label>${pe(ke.description)}</label>
              <textarea name="description" rows="3" class="form-textarea">${u?.description?pe(u.description):""}</textarea>
            </div>
            
            <div class="form-group">
              <label>${pe(ke.logoUrl)}</label>
              <input type="url" name="logo_url" value="${u?.logo_url?pe(u.logo_url):""}" class="form-input" placeholder="https://...">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                  <label>${pe(ke.website)}</label>
                  <input type="url" name="website_url" value="${u?.website_url?pe(u.website_url):""}" class="form-input" placeholder="https://...">
                </div>
                <div class="form-group">
                  <label>${pe(ke.linkedIn)}</label>
                  <input type="url" name="linkedin_url" value="${u?.linkedin_url?pe(u.linkedin_url):""}" class="form-input" placeholder="https://linkedin.com/...">
                </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary" style="min-width: 100px;">${pe(p?ke.save:ke.create)}</button>
              <button type="button" class="btn btn-secondary" id="company-form-cancel">${pe(ke.cancel)}</button>
            </div>
            
            ${p&&u?`
            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
              <h3 style="font-size: 1rem; margin-bottom: 12px;">Documents</h3>
              <button type="button" class="btn btn-outline-secondary" id="companies-templates-btn" style="display: flex; align-items: center; gap: 8px;">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                ${pe(ke.templates)}
              </button>
            </div>
            `:""}
          </form>
      </div>
    `;const h=t.querySelector(".settings-breadcrumbs-container");h&&(h.innerHTML=go(f));const k=h?.querySelector(".breadcrumb-link");if(k&&d(k,"click",a),d(t.querySelector("#company-form"),"submit",async C=>{C.preventDefault();const x=t.querySelector("#company-form"),$=new FormData(x),w=$.get("logo_url")?.trim()||void 0,y=$.get("website_url")?.trim()||void 0,S=$.get("linkedin_url")?.trim()||void 0;if(w&&!sc(w)){m.error(ke.invalidUrl+" (Logo)");return}if(y&&!sc(y)){m.error(ke.invalidUrl+" (Website)");return}if(S&&!sc(S)){m.error(ke.invalidUrl+" (LinkedIn)");return}const P={name:$.get("name").trim(),description:$.get("description")?.trim()||void 0,logo_url:w,website_url:y,linkedin_url:S};try{p&&u?(await Ip(u.id,P),m.success("Company updated")):(await zp(P),m.success("Company created")),a()}catch{m.error(p?ke.updateFailed:ke.createFailed)}}),d(t.querySelector("#company-form-cancel"),"click",a),p&&u){const C=t.querySelector("#companies-templates-btn");C&&d(C,"click",()=>i(u))}}function i(u){let p="a4",g="code";const f=[{label:"Settings"},{label:"Companies",onClick:a},{label:"Edit "+u.name,onClick:()=>o(u)},{label:"Templates"}];t.innerHTML=`
      <div class="settings-breadcrumbs-container"></div>
      
      <div class="template-editor-layout">
          <h2 class="companies-title">${pe(u.name)} ‚Äì ${pe(ke.templates)}</h2>
          <p class="companies-subtitle">Manage the document templates for this company.</p>

          <div class="template-toolbar">
              <div class="template-toolbar-group">
                <button type="button" class="btn btn-sm template-type-btn active" data-type="a4">${pe(ke.templateA4)}</button>
                <button type="button" class="btn btn-sm template-type-btn" data-type="ppt">${pe(ke.templatePPT)}</button>
              </div>
              <div class="template-toolbar-group">
                <button type="button" class="btn btn-sm btn-secondary" id="template-load-btn">${pe(ke.loadCurrent)}</button>
                <button type="button" class="btn btn-sm btn-primary" id="template-generate-btn">${pe(ke.generateWithAI)}</button>
                <button type="button" class="btn btn-sm btn-primary" id="template-save-btn">${pe(ke.saveTemplate)}</button>
              </div>
          </div>
          
          <div class="template-workspace">
            <!-- Left Column: Editor & Controls -->
            <div class="template-sidebar">
                <!-- Tabs -->
                <div class="template-tabs">
                    <button type="button" class="template-tab-btn active" data-tab="code">Code</button>
                    <button type="button" class="template-tab-btn" data-tab="theme">Theme</button>
                </div>

                <!-- Code Tab -->
                <div id="editor-tab-code" class="flex-1 flex-col">
                    <textarea id="template-html-editor" class="template-code-area" placeholder="HTML template..."></textarea>
                </div>

                <!-- Theme Tab -->
                <div id="editor-tab-theme" class="template-theme-list hidden">
                    <p class="text-secondary mb-4 text-sm">Detected styles from <code>:root</code> variables. Change colors to update the template.</p>
                    <div id="theme-variables-list" class="flex flex-col gap-3"></div>
                </div>
            </div>

            <!-- Right Column: Preview -->
            <div class="template-preview-pane">
                <div class="template-preview-label">Preview</div>
                <div class="template-preview-container">
                    <iframe id="template-preview-frame" class="template-preview-frame" sandbox="allow-same-origin allow-scripts"></iframe>
                </div>
            </div>
          </div>
      </div>
      <style>
        /* Template Type Buttons */
        .template-type-btn {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .template-type-btn:hover {
            background: var(--bg-hover);
        }
        .template-type-btn.active {
            background: var(--primary);
            color: #ffffff !important;
            border-color: var(--primary);
        }
      </style>
    `;const h=t.querySelector(".settings-breadcrumbs-container");if(h){h.innerHTML=go(f);const oe=h.querySelectorAll(".breadcrumb-link");oe[0]&&d(oe[0],"click",a),oe[1]&&d(oe[1],"click",()=>o(u))}const k=t.querySelector("#template-html-editor"),C=t.querySelector("#template-load-btn"),x=t.querySelector("#template-generate-btn"),$=t.querySelector("#template-save-btn"),w=t.querySelector("#template-preview-frame"),y=t.querySelector("#theme-variables-list"),S=t.querySelector('.template-tab-btn[data-tab="code"]'),P=t.querySelector('.template-tab-btn[data-tab="theme"]'),j=t.querySelector("#editor-tab-code"),H=t.querySelector("#editor-tab-theme");function J(oe){if(!oe)return"";let me=oe;me=me.replace(/\{\{COMPANY_NAME\}\}/g,pe(u.name)),me=me.replace(/\{\{COMPANY_DESCRIPTION\}\}/g,pe(u.description||"")),me=me.replace(/\{\{WEBSITE_URL\}\}/g,pe(u.website_url||""));const ze=u.brand_assets?.primary_color||"#000000",re=u.brand_assets?.secondary_color||"#666666";me=me.replace(/\{\{PRIMARY_COLOR\}\}/g,ze),me=me.replace(/\{\{SECONDARY_COLOR\}\}/g,re),u.logo_url?me=me.replace(/\{\{LOGO_URL\}\}/gi,u.logo_url):me=me.replace(/\{\{LOGO_URL\}\}/gi,"https://placehold.co/200x80/EEE/31343C?text=LOGO");const Le=`
            <h2>1. Ficha de Identidade</h2>
                <p><strong>Nome: </strong> ${pe(u.name)}</p>
                    <p><strong>Setor: </strong> Consultoria Tecnol√≥gica</p>
                        <p><strong>Descri√ß√£o: </strong> ${pe(u.description||"Empresa l√≠der em inova√ß√£o...")}</p>

                            <h2>2. Vis√£o Geral</h2>
                                <p>A ${pe(u.name)} demonstra um forte posicionamento no mercado...</p>

                                    <h2>3. An√°lise SWOT</h2>
                                        <ul>
                                        <li><strong>For√ßas: </strong> Tecnologia propriet√°ria, Equipa experiente</li>
                                            <li><strong>Fraquezas: </strong> Baixa presen√ßa internacional</li>
                                                </ul>
                                                    `;return me=me.replace(/\{\{REPORT_DATA\}\}/g,Le),me}function B(){const oe=w.contentDocument;if(!oe)return;const me=k.value||"",ze=J(me);oe.open(),oe.write(ze),oe.close()}let Z;k.addEventListener("input",()=>{clearTimeout(Z),Z=setTimeout(()=>{B(),g==="theme"&&F()},300)});function O(oe){g=oe,oe==="code"?(S.classList.add("active"),P.classList.remove("active"),j.style.display="flex",H.style.display="none"):(S.classList.remove("active"),P.classList.add("active"),j.style.display="none",H.style.display="flex",F())}d(S,"click",()=>O("code")),d(P,"click",()=>O("theme"));function F(){const oe=k.value||"",me=oe.match(/<style[^>]*>([\s\S]*?)<\/style>/i),re=(me?me[1]:oe).match(/:root\s*\{([\s\S]*?)\}/i);if(!re){y.innerHTML='<p style="color: var(--text-secondary);">No <code>:root</code> CSS variables found. Ensure your template has a <code>&lt;style&gt;:root { ... }&lt;/style&gt;</code> block.</p>';return}const le=re[1].replace(/\/\*[\s\S]*?\*\//g,""),te=/--([a-zA-Z0-9-]+):\s*([^;\}]+)/g;let ne;const T=[];for(;(ne=te.exec(le))!==null;)T.push({name:ne[1],value:ne[2].trim()});y.innerHTML="",T.forEach(_=>{const A=/^#[0-9A-Fa-f]{3,8}$|^rgb|^hsl/.test(_.value),E=document.createElement("div");E.style.cssText="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-hover); border-radius: 6px;",E.innerHTML=`
                                                <div style="font-weight: 500; font-size: 0.9em; color: var(--text-primary);">${pe(_.name)}</div>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        ${A?`<input type="color" data-var="${_.name}" value="${_.value.startsWith("#")?_.value.substring(0,7):"#000000"}" style="width: 32px; height: 32px; padding: 0; border: none; border-radius: 4px; cursor: pointer;">`:""}
        <input type="text" data-var="${_.name}" value="${pe(_.value)}" style="width: 100px; padding: 4px 8px; font-size: 0.85em; border-radius: 4px; border: 1px solid var(--border-color); color: var(--text-primary); background: var(--bg-surface);">
            </div>
                `,y.appendChild(E);const U=E.querySelectorAll("input");U.forEach(M=>{M.addEventListener("input",z=>{const q=z.target.value,I=U.length>1?M.type==="color"?U[1]:U[0]:null;I&&(I.value=q),ee(_.name,q)})})})}function ee(oe,me){let ze=k.value;const re=new RegExp(`(--${oe}: \\s *)([^;]+) (;)`);re.test(ze)&&(k.value=ze.replace(re,`$1${me} $3`),B())}function ie(oe){p=oe,t.querySelectorAll(".template-type-btn").forEach(me=>me.classList.toggle("active",me.getAttribute("data-type")===oe)),oe==="ppt"?(w.style.width="297mm",w.style.minHeight="210mm"):(w.style.width="210mm",w.style.minHeight="297mm"),Si(u.id,p).then(me=>{k.value=me,B(),g==="theme"&&F()}).catch(()=>{k.value="",B()})}t.querySelectorAll(".template-type-btn").forEach(oe=>{d(oe,"click",()=>ie(oe.getAttribute("data-type")||"a4"))}),d(C,"click",async()=>{C.disabled=!0;try{const oe=await Si(u.id,p);k.value=oe,B(),g==="theme"&&F(),m.success(ke.templateLoaded)}catch{m.error(ke.templateLoadFailed)}finally{C.disabled=!1}}),d(x,"click",async()=>{x.disabled=!0,x.textContent="...";try{const{html:oe}=await Rp(u.id,p);k.value=oe,B(),g==="theme"&&F(),m.success(ke.templateGenerated)}catch{m.error(ke.templateGenerateFailed)}finally{x.disabled=!1,x.textContent=ke.generateWithAI}}),d($,"click",async()=>{$.disabled=!0;try{await Bp(u.id,p,k.value),m.success(ke.templateSaved)}catch{m.error(ke.templateSaveFailed)}finally{$.disabled=!1}}),Si(u.id,p).then(oe=>{k.value=oe,B()}).catch(()=>{})}const r={ficha_identidade:"1. Ficha de Identidade",visao_geral:"2. Vis√£o Geral e Posicionamento",produtos_servicos:"3. Produtos e Servi√ßos",publico_alvo:"4. P√∫blico-Alvo e Clientes",equipa_lideranca:"5. Equipa e Lideran√ßa",presenca_digital:"6. Presen√ßa Digital e Marketing",analise_competitiva:"7. An√°lise Competitiva",indicadores_crescimento:"8. Indicadores de Crescimento",swot:"9. An√°lise SWOT",conclusoes:"10. Conclus√µes e Insights"};function c(u){const p=u.brand_assets,g=p?.analysis_report||{},f=Object.keys(g).length>0,h="ficha_identidade",k=Object.keys(r).filter(O=>O!==h),C=[h,...k];let x=h;const $=[{label:"Settings"},{label:"Companies",onClick:a},{label:u.name}],w=u.logo_url?`<img src="${pe(u.logo_url)}" alt="" class="companies-detail-logo" style="width: 56px; height: 56px; object-fit: contain; background: white; padding: 4px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onerror="this.style.display='none'">`:'<span class="companies-detail-logo-placeholder" style="width: 56px; height: 56px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--border-color) 100%); border-radius: 8px; font-size: 24px; color: var(--text-secondary);">üè¢</span>',y=p?.primary_color||"‚Äî",S=p?.secondary_color||"‚Äî",P=y!=="‚Äî"||S!=="‚Äî"?`
            <div style="display: flex; gap: 6px; align-items: center; justify-content: center; padding: 4px 8px; background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 6px;" title="Brand Colors">
                ${y!=="‚Äî"?`<span style="width: 14px; height: 14px; border-radius: 3px; background: ${pe(y)}; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);"></span>`:""}
            ${S!=="‚Äî"?`<span style="width: 14px; height: 14px; border-radius: 3px; background: ${pe(S)}; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);"></span>`:""}
        </div>
            `:"";t.innerHTML=`
            <div class="settings-breadcrumbs-container"></div>

            <div class="companies-list-container">

                <!-- Header -->
                <div class="detail-header-card">
                    ${w}
                    <div class="flex-1">
                        <div class="flex-item-center gap-sm mb-1">
                            <h3 class="companies-title" style="font-size: 1.4rem;">${pe(u.name)}</h3>
                            ${P}
                        </div>
                        <div class="flex-item-center gap-md">
                            ${u.website_url?`<a href="${pe(u.website_url)}" target="_blank" class="companies-website-link flex-item-center gap-xs"><svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg> ${pe(u.website_url.replace(/^https?:\/\//,""))}</a>`:""}
                            ${u.linkedin_url?`<a href="${pe(u.linkedin_url)}" target="_blank" class="companies-website-link flex-item-center gap-xs" style="color: #0077b5;"><svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg> LinkedIn</a>`:""}
                        </div>
                    </div>

                    <div class="companies-actions">
                        <button type="button" class="btn btn-sm btn-primary" id="companies-detail-reanalyze-btn" data-id="${pe(u.id)}">
                            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" style="margin-right: 6px;"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                            ${pe(ke.reAnalyze)}
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" id="companies-detail-edit-btn" data-id="${pe(u.id)}">
                            ${pe(ke.edit)}
                        </button>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="companies-detail-grid">
                    
                    <!-- Sidebar -->
                    <div class="detail-sidebar">
                        <div class="detail-sidebar-header">Report Sections</div>
                        
                        ${f?C.map(O=>{const ee=(r[O]||O).replace(/^\d+\.\s*/,"");return`
                            <div class="detail-sidebar-item ${O===x?"active":""}" data-key="${O}" role="button">
                                <span>${pe(ee)}</span>
                                ${O===x?'<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><polyline points="9 18 15 12 9 6"></polyline></svg>':""}
                            </div>
                            `}).join(""):'<div class="companies-empty-state-sm">No report data available.</div>'}
                    </div>

                    <!-- Main Content Area -->
                    <div class="detail-content-area custom-scrollbar" id="detail-content-main">
                        <!-- Content injected via JS -->
                    </div>
                </div>
            </div>
        `;const j=t.querySelector(".settings-breadcrumbs-container");if(j){j.innerHTML=go($);const O=j.querySelectorAll(".breadcrumb-link");O[0]&&d(O[0],"click",a)}d(t.querySelector("#companies-detail-edit-btn"),"click",()=>o(u));const H=t.querySelector("#companies-detail-reanalyze-btn");d(H,"click",async()=>{H.disabled=!0,H.innerHTML='<span class="spinner-sm"></span> Analyzing...';try{const O=await Mo(u.id);m.success(ke.analysisComplete),c(O)}catch{m.error(ke.analysisFailed),H.innerHTML=ke.reAnalyze,H.disabled=!1}});const J=t.querySelector("#detail-content-main"),B=t.querySelectorAll(".detail-sidebar-item");function Z(){if(!f){J.innerHTML=`< div style = "display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center;" >
            <div style="font-size: 32px; margin-bottom: 16px;" >üìä</div>
                < p > No analysis data available yet.</p>
                    < p style = "font-size: 0.9rem;" > Click < strong > Re - analyze < /strong> to generate a comprehensive report.</p >
                        </div>`;return}const F=(r[x]||x).replace(/^\d+\.\s*/,""),ee=g[x]||"No content for this section.",ie=pe(ee).replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");J.innerHTML=`
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0 0 24px 0; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">${pe(F)}</h2>
                <div class="content-prose">
                    <p>${ie}</p>
                </div>
            `}B.forEach(O=>{d(O,"click",()=>{const F=O.getAttribute("data-key");F&&F!==x&&(x=F,B.forEach(ee=>{if(ee.getAttribute("data-key")===x){if(ee.classList.add("active"),!ee.querySelector("svg")){const ie=ee.querySelector("span");ie&&ie.insertAdjacentHTML("afterend",'<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><polyline points="9 18 15 12 9 6"></polyline></svg>')}}else{ee.classList.remove("active");const ie=ee.querySelector("svg");ie&&ie.remove()}}),Z())})}),Z()}function l(){d(t,"click",async u=>{const p=u.target;if(p.closest("#companies-new-btn")){o();return}const g=p.closest(".companies-edit-btn"),f=p.closest(".companies-templates-list-btn"),h=p.closest(".companies-analyze-btn"),k=p.closest(".companies-detail-btn"),C=p.closest(".companies-delete-btn"),x=(g||f||h||k||C)?.getAttribute("data-id");if(x){if(k){try{const $=await $i(x);$&&c($)}catch{m.error(ke.loadFailed)}return}if(f){try{const $=await $i(x);$&&i($)}catch{m.error(ke.loadFailed)}return}if(g){try{const $=await $i(x);$&&o($)}catch{m.error(ke.loadFailed)}return}if(h){const $=h;$.disabled=!0;const w=$.textContent;$.innerHTML='<span class="spinner-sm"></span>';try{await Mo(x),m.success(ke.analysisComplete),s()}catch{m.error(ke.analysisFailed),$.innerHTML=w||"",$.disabled=!1}return}if(C){if(!confirm(ke.deleteConfirm))return;try{await Hp(x),m.success(ke.companyDeleted),s()}catch{}}}})}a()}const Qu="settings-modal";function SL(e,t,n,s){const a=s?.pageMode??!1,o=a?"":`<button class="settings-close" id="close-settings-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>`;return`
    <style>
      .settings-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      
      .settings-modal-container {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        width: 100%;
        max-width: 520px;
      }

      .settings-modal-container.full-page {
        max-width: none;
        width: 100%;
        margin: 0;
        padding: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .settings-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248,250,252,0.98) 100%);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8);
        overflow: hidden;
      }
      
      [data-theme="dark"] .settings-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(15,23,42,0.98) 100%);
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      /* =========================================
       * DASHBOARD PAGE MODE STYLES
       * No Modal, Clean Dashboard Layout
       * ========================================= */
      .settings-page-card {
        box-shadow: none !important;
        background: transparent !important;
        backdrop-filter: none !important;
        border-radius: 0 !important;
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        grid-template-rows: auto auto;
        grid-template-areas:
          "tabs body"
          "tabs footer";
        gap: 0 24px;
        align-items: start;
        padding-top: 24px; /* Space from top (title in main layout) */
      }

      /* Hide Header in Page Mode (handled by main layout) */
      .settings-page-card .settings-header {
        display: none !important;
      }

      /* TABS CARD (Left Sidebar) */
      .settings-page-card .settings-tabs {
        grid-area: tabs;
        flex-direction: column;
        background: var(--bg-surface, #ffffff);
        border: 1px solid var(--border-color, rgba(0,0,0,0.1));
        border-radius: 12px;
        padding: 12px;
        margin: 0;
        gap: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        height: fit-content;
        position: sticky;
        top: 24px;
      }

      [data-theme="dark"] .settings-page-card .settings-tabs {
        background: var(--bg-surface, #1e293b);
        border-color: rgba(255,255,255,0.1);
      }

      .settings-page-card .settings-tab {
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.9rem;
        font-weight: 500;
        justify-content: flex-start;
        width: 100%;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        border: 1px solid transparent;
      }

      .settings-page-card .settings-tab:hover {
        background: var(--bg-secondary, #f1f5f9);
        color: var(--text-primary);
      }

      .settings-page-card .settings-tab.active {
        background: var(--bg-secondary, #f1f5f9);
        color: var(--accent, #e11d48);
        border-color: rgba(225, 29, 72, 0.1);
      }

      [data-theme="dark"] .settings-page-card .settings-tab.active {
        background: rgba(255,255,255,0.05);
        color: #fb7185;
        border-color: rgba(251, 113, 133, 0.2);
      }

      /* CONTENT CARD (Right Main Area) */
      .settings-page-card .settings-body {
        grid-area: body;
        background: var(--bg-surface, #ffffff);
        border: 1px solid var(--border-color, rgba(0,0,0,0.1));
        border-bottom: none; /* Merged with footer */
        border-radius: 12px 12px 0 0;
        padding: 32px;
        max-height: none;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      [data-theme="dark"] .settings-page-card .settings-body {
        background: var(--bg-surface, #1e293b);
        border-color: rgba(255,255,255,0.1);
      }

      /* FOOTER (Merged with Body) */
      .settings-page-card .settings-footer {
        grid-area: footer;
        margin-top: 0;
        background: var(--bg-surface, #ffffff);
        border: 1px solid var(--border-color, rgba(0,0,0,0.1));
        border-top: 1px solid var(--border-color, rgba(0,0,0,0.05));
        border-radius: 0 0 12px 12px;
        padding: 24px 32px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      [data-theme="dark"] .settings-page-card .settings-footer {
        background: var(--bg-surface, #1e293b);
        border-color: rgba(255,255,255,0.1);
        border-top-color: rgba(255,255,255,0.05);
      }
      
      /* Responsive */
      @media (max-width: 900px) {
        .settings-page-card {
           grid-template-columns: 1fr;
           grid-template-rows: auto auto auto;
           grid-template-areas:
             "tabs"
             "body"
             "footer";
           gap: 16px;
        }
        .settings-page-card .settings-tabs {
          flex-direction: row;
          padding: 8px;
          margin-bottom: 0;
          overflow-x: auto;
          position: static;
        }
        .settings-page-card .settings-tab {
          white-space: nowrap;
          width: auto;
        }
        .settings-page-card .settings-body {
          border-radius: 12px 12px 0 0;
          padding: 24px;
        }
        .settings-page-card .settings-footer {
          border-radius: 0 0 12px 12px;
          padding: 16px 24px;
        }
      }
      .settings-page-card .settings-header {
        grid-area: header;
        border-radius: 0;
        margin-bottom: 0;
        background: transparent;
        box-shadow: none;
        border-bottom: 1px solid var(--border-color, rgba(0,0,0,0.05));
        padding: 0 0 16px 0; /* Remove horizontal padding to align with content */
        margin: 0 24px; /* Add margin to align with body content if needed, or remove if full bleed */
      }

      [data-theme="dark"] .settings-page-card .settings-header {
        border-bottom-color: rgba(255,255,255,0.05);
      }

      .settings-page-card .settings-header::before {
        display: none;
      }

      .settings-page-card .settings-header-content {
        flex-direction: row-reverse;
        justify-content: flex-end;
      }

      .settings-page-card .settings-icon {
        display: none; 
      }

      .settings-page-card .settings-title h2 {
        color: var(--text-primary);
        font-size: 1.5rem;
        text-shadow: none;
      }

      .settings-page-card .settings-title p {
        color: var(--text-secondary);
      }

      .settings-page-card .settings-back {
        position: relative;
        top: auto;
        right: auto;
        background: transparent !important;
        color: var(--text-secondary);
        padding: 8px 12px;
        border-radius: 8px;
        margin-right: 16px; 
        border: 1px solid var(--border-color, rgba(0,0,0,0.1));
      }
      
      .settings-page-card .settings-back:hover {
        background: var(--bg-secondary) !important;
        color: var(--text-primary);
      }

      .settings-page-card .settings-back svg {
        stroke: currentColor;
        width: 16px;
        height: 16px;
        margin-right: 6px;
      }

      .settings-page-card .settings-tabs {
        grid-area: tabs;
        flex-direction: column;
        background: transparent;
        border-bottom: none;
        border-right: 1px solid var(--border-color, rgba(0,0,0,0.05));
        padding: 0 24px 0 0;
        margin: 0;
        gap: 8px;
      }

      [data-theme="dark"] .settings-page-card .settings-tabs {
        border-right-color: rgba(255,255,255,0.05);
      }

      .settings-page-card .settings-tab {
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.95rem;
        justify-content: flex-start;
        width: 100%;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .settings-page-card .settings-tab:hover {
        background: var(--bg-secondary);
        transform: translateX(4px);
      }

      .settings-page-card .settings-tab.active {
        background: var(--bg-surface, white);
        color: var(--accent, #e11d48);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color, rgba(0,0,0,0.05));
      }

      [data-theme="dark"] .settings-page-card .settings-tab.active {
        background: rgba(255,255,255,0.05);
        color: #fb7185;
        border-color: rgba(255,255,255,0.1);
      }

      .settings-page-card .settings-body {
        grid-area: body;
        border-left: 1px solid transparent; 
        padding: 0 0 0 32px;
        max-height: none;
      }

      .settings-page-card .settings-footer {
        grid-area: footer;
        margin-top: 32px;
        border-top: 1px solid var(--border-color, rgba(0,0,0,0.05));
        background: transparent;
        padding: 24px 0;
      }

      [data-theme="dark"] .settings-page-card .settings-footer {
        border-top-color: rgba(255,255,255,0.05);
        background: transparent;
      }
      
      @media (max-width: 900px) {
        .settings-page-card {
           grid-template-columns: 1fr;
           grid-template-rows: auto auto 1fr auto;
           grid-template-areas:
             "header"
             "tabs"
             "body"
             "footer";
        }
        .settings-page-card .settings-tabs {
          flex-direction: row;
          border-right: none;
          border-bottom: 1px solid var(--border-color, rgba(0,0,0,0.05));
          padding: 0 0 16px 0;
          margin-bottom: 24px;
          overflow-x: auto;
          gap: 12px;
        }
        .settings-page-card .settings-tab {
          width: auto;
          white-space: nowrap;
          justify-content: center;
        }
        .settings-page-card .settings-body {
          padding: 0;
          border-left: none;
        }
      }
      
      .settings-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 24px 28px;
        position: relative;
        overflow: hidden;
      }
      
      .settings-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
      }
      
      .settings-header-content {
        display: flex;
        align-items: center;
        gap: 14px;
        position: relative;
        z-index: 1;
      }
      
      .settings-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255,255,255,0.3);
      }
      
      .settings-icon svg {
        width: 28px;
        height: 28px;
        stroke: white;
        fill: none;
      }
      
      .settings-title {
        flex: 1;
      }
      
      .settings-title h2 {
        color: white;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      .settings-title p {
        color: rgba(255,255,255,0.85);
        font-size: 0.85rem;
        margin: 4px 0 0;
      }
      
      .settings-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        z-index: 2;
      }
      
      .settings-close:hover {
        background: rgba(255,255,255,0.3);
      }
      
      .settings-close svg {
        width: 18px;
        height: 18px;
        stroke: white;
      }
      
      .settings-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 24px;
        background: var(--bg-secondary, #f8fafc);
        border-bottom: 1px solid var(--border-color, #e2e8f0);
      }
      
      [data-theme="dark"] .settings-tabs {
        background: rgba(30,41,59,0.5);
        border-bottom-color: rgba(255,255,255,0.1);
      }
      
      .settings-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border: none;
        background: transparent;
        color: var(--text-secondary, #64748b);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.2s;
      }
      
      .settings-tab:hover {
        background: var(--bg-hover, rgba(0,0,0,0.05));
        color: var(--text-primary, #1e293b);
      }
      
      .settings-tab.active {
        background: white;
        color: #e11d48;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      
      [data-theme="dark"] .settings-tab.active {
        background: rgba(225,29,72,0.15);
        color: #fb7185;
      }
      
      .settings-tab svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
      }
      
      .settings-body {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .settings-section {
        display: none;
      }
      
      .settings-section.active {
        display: block;
      }
      
      .settings-section h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary, #64748b);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0 0 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .settings-section h3 svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group:last-child {
        margin-bottom: 0;
      }
      
      .form-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-primary, #1e293b);
        margin-bottom: 8px;
      }
      
      .form-group p.hint {
        font-size: 0.8rem;
        color: var(--text-secondary, #64748b);
        margin: 6px 0 0;
      }
      
      .form-select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 10px;
        background: var(--bg-primary, white);
        color: var(--text-primary, #1e293b);
        font-size: 0.9rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        cursor: pointer;
      }
      
      .form-select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
      }
      
      [data-theme="dark"] .form-select {
        background-color: rgba(30,41,59,0.8);
        border-color: rgba(255,255,255,0.1);
      }
      
      .toggle-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: var(--bg-secondary, #f8fafc);
        border-radius: 10px;
        margin-bottom: 12px;
      }
      
      [data-theme="dark"] .toggle-group {
        background: rgba(30,41,59,0.5);
      }
      
      .toggle-group:last-child {
        margin-bottom: 0;
      }
      
      .toggle-info {
        flex: 1;
      }
      
      .toggle-info strong {
        display: block;
        font-size: 0.9rem;
        color: var(--text-primary, #1e293b);
        margin-bottom: 2px;
      }
      
      .toggle-info span {
        font-size: 0.8rem;
        color: var(--text-secondary, #64748b);
      }
      
      .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
        flex-shrink: 0;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--bg-tertiary, #cbd5e1);
        border-radius: 26px;
        transition: 0.3s;
      }
      
      .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .toggle-switch input:checked + .toggle-slider {
        background: #e11d48;
      }
      
      .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(22px);
      }
      
      .settings-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 24px;
        background: var(--bg-secondary, #f8fafc);
        border-top: 1px solid var(--border-color, #e2e8f0);
      }
      
      [data-theme="dark"] .settings-footer {
        background: rgba(30,41,59,0.5);
        border-top-color: rgba(255,255,255,0.1);
      }
      
      .btn-cancel {
        padding: 10px 20px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 10px;
        background: var(--bg-primary, white);
        color: var(--text-primary, #1e293b);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .btn-cancel:hover {
        background: var(--bg-hover, #f1f5f9);
      }
      
      .btn-save {
        padding: 10px 24px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .btn-save:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }
      
      .btn-save svg {
        width: 18px;
        height: 18px;
        stroke: white;
      }
      
      .admin-notice {
        background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(37,99,235,0.1) 100%);
        border: 1px solid rgba(59,130,246,0.3);
        border-radius: 10px;
        padding: 14px 16px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .admin-notice svg {
        width: 20px;
        height: 20px;
        stroke: #3b82f6;
        flex-shrink: 0;
      }
      
      .admin-notice p {
        font-size: 0.85rem;
        color: var(--text-secondary, #64748b);
        margin: 0;
      }
      
      .admin-notice strong {
        color: #3b82f6;
      }
      .settings-back {
        position: static;
        display: inline-flex;
        align-items: center;
        padding: 8px 14px;
        font-size: 0.9rem;
        font-weight: 500;
        color: rgba(255,255,255,0.95);
      }
      .settings-back:hover {
        background: rgba(255,255,255,0.15);
      }
      .settings-page-card .settings-body {
        max-height: none;
      }
    </style>
    
    <div class="settings-modal-container ${a?"full-page":""}">
    <div class="settings-card ${a?"settings-page-card":""}">
      <!-- Header -->
      <div class="settings-header">
        <div class="settings-header-content">
          ${a?o:""}
          <div class="settings-title">
            <h2>Settings</h2>
            <p>Your personal preferences</p>
          </div>
           ${a?"":`<div class="settings-icon">
            <svg viewBox="0 0 24 24" stroke-width="2">
              <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </div>`}
        </div>
        ${a?"":o}
      </div>
      
      <!-- Tabs -->
      <div class="settings-tabs">
        <button class="settings-tab ${n==="general"?"active":""}" data-tab="general">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
          </svg>
          General
        </button>
        <button class="settings-tab ${n==="data"?"active":""}" data-tab="data">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          Data & Privacy
        </button>
        <button class="settings-tab ${n==="companies"?"active":""}" data-tab="companies">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-9a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v9"/>
          </svg>
          Companies
        </button>
      </div>
      
      <!-- Body -->
      <div class="settings-body">
        <!-- General Section -->
        <div class="settings-section ${n==="general"?"active":""}" id="section-general">
          <h3>
            <svg viewBox="0 0 24 24" stroke-width="2">
              <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/>
            </svg>
            Appearance
          </h3>
          
          <div class="form-group">
            <label>Theme</label>
            <select class="form-select" id="setting-theme">
              <option value="system" ${t==="system"?"selected":""}>System (Auto)</option>
              <option value="light" ${t==="light"?"selected":""}>Light</option>
              <option value="dark" ${t==="dark"?"selected":""}>Dark</option>
            </select>
            <p class="hint">Choose your preferred color scheme</p>
          </div>
          
          <div class="form-group">
            <label>Language</label>
            <select class="form-select" id="setting-language">
              <option value="en" ${e.config.language==="en"?"selected":""}>English</option>
              <option value="pt" ${e.config.language==="pt"?"selected":""}>Portugues</option>
              <option value="es" ${e.config.language==="es"?"selected":""}>Espanol</option>
            </select>
            <p class="hint">Interface language preference</p>
          </div>
          
          <h3 style="margin-top: 20px;">
            <svg viewBox="0 0 24 24" stroke-width="2" style="width: 16px; height: 16px;">
              <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            Companies
          </h3>
          <p class="hint" style="margin-bottom: 10px;">Manage company profiles for branding and document templates.</p>
          <button type="button" class="btn-save" id="settings-manage-companies-btn" style="margin-top: 0;">
            <svg viewBox="0 0 24 24" stroke-width="2" style="width: 18px; height: 18px;"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            Manage companies
          </button>
          
          ${e.currentUser?.role==="superadmin"?`
            <div class="admin-notice">
              <svg viewBox="0 0 24 24" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <p>For <strong>LLM configuration</strong>, <strong>Graph</strong>, and other platform settings, use the <strong>Admin</strong> section in the sidebar menu.</p>
            </div>
          `:""}
        </div>
        
        <!-- Data & Privacy Section -->
        <div class="settings-section ${n==="data"?"active":""}" id="section-data">
          <h3>
            <svg viewBox="0 0 24 24" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Privacy Settings
          </h3>
          
          <div class="toggle-group">
            <div class="toggle-info">
              <strong>Analytics</strong>
              <span>Help improve GodMode with anonymous usage data</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="setting-analytics" ${e.config.analyticsEnabled!==!1?"checked":""}>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="toggle-group">
            <div class="toggle-info">
              <strong>Error Reporting</strong>
              <span>Automatically report errors to help fix bugs</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="setting-error-reporting" ${e.config.errorReportingEnabled!==!1?"checked":""}>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="toggle-group">
            <div class="toggle-info">
              <strong>AI Data Improvement</strong>
              <span>Allow anonymized data to improve AI responses</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="setting-ai-improvement" ${e.config.aiImprovementEnabled===!0?"checked":""}>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Companies Section -->
        <div class="settings-section ${n==="companies"?"active":""}" id="section-companies">
          <!-- CompaniesPanel content will be mounted here -->
        </div>
      </div>
      
      <!-- Footer -->
      <div class="settings-footer">
        <button class="btn-cancel" id="cancel-settings-btn">Cancel</button>
        <button class="btn-save" id="save-settings-btn">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Save Settings
        </button>
      </div>
    </div>
    </div>
  `}function CL(e={}){const t=document.querySelector(`[data-modal-id="${Qu}"]`);t&&t.remove();const n=N.getState(),s=tt.getMode(),a=e.initialTab||"general",o=b("div",{className:"settings-modal-overlay"});o.setAttribute("data-modal-id",Qu);const i=b("div",{className:"settings-modal-container"});i.innerHTML=SL(n,s,a,{pageMode:!1}),o.appendChild(i),document.body.appendChild(o);const r=()=>o.remove();_L(o,{...e,onClose:r,onSaveSuccess:r})}function _L(e,t){const{onClose:n,onSaveSuccess:s,onSave:a}=t,o=e.querySelector("#section-companies");o&&$L(o);const i=e.querySelector("#close-settings-btn"),r=e.querySelector("#cancel-settings-btn"),c=e.classList.contains("settings-modal-overlay"),l=()=>{n?n():c&&e.remove()};i&&d(i,"click",l),r&&d(r,"click",l),c&&d(e,"click",h=>{h.target===e&&l()});const u=e.querySelector("#settings-manage-companies-btn");u&&d(u,"click",()=>{const h=e.querySelector('.settings-tab[data-tab="companies"]');h&&h.click()});const p=e.querySelectorAll(".settings-tab");p.forEach(h=>{d(h,"click",()=>{const k=h.getAttribute("data-tab");p.forEach(x=>x.classList.remove("active")),h.classList.add("active"),e.querySelectorAll(".settings-section").forEach(x=>{x.classList.remove("active")});const C=e.querySelector(`#section-${k}`);C&&C.classList.add("active")})});const g=e.querySelector("#setting-theme");g&&d(g,"change",()=>{tt.set(g.value)});const f=e.querySelector("#save-settings-btn");f&&d(f,"click",()=>{const h={theme:e.querySelector("#setting-theme")?.value,language:e.querySelector("#setting-language")?.value,analyticsEnabled:e.querySelector("#setting-analytics")?.checked,errorReportingEnabled:e.querySelector("#setting-error-reporting")?.checked,aiImprovementEnabled:e.querySelector("#setting-ai-improvement")?.checked};N.setConfig({...N.getState().config,...h}),t.onSave?.(h),m.success("Settings saved"),t.onSaveSuccess?.()})}const ys="processing-modal";let en=[],Wl;function LL(e={}){const{title:t="Processing",steps:n=[],onCancel:s,allowCancel:a=!0}=e;en=n,Wl=s;const o=document.querySelector(`[data-modal-id="${ys}"]`);o&&o.remove();const i=b("div",{className:"processing-content"});Cr(i);const r=a?AL():null,c=Pe({id:ys,title:t,content:i,size:"md",closable:!1,footer:r});document.body.appendChild(c),De(ys)}function Cr(e){e.innerHTML=`
    <div class="processing-steps">
      ${en.map(t=>TL(t)).join("")}
    </div>
    <div class="processing-overall">
      <div class="progress-bar">
        <div class="progress-fill" style="--progress: ${Ju()}"></div>
      </div>
      <div class="progress-text">${Ju()}% complete</div>
    </div>
  `}function TL(e){const t={pending:"‚è≥",running:"üîÑ",completed:"‚úÖ",error:"‚ùå"}[e.status];return`
    <div class="processing-step ${e.status}" data-step-id="${e.id}">
      <span class="step-icon">${t}</span>
      <div class="step-content">
        <div class="step-label">${e.label}</div>
        ${e.message?`<div class="step-message">${e.message}</div>`:""}
        ${e.status==="running"&&e.progress!==void 0?`
          <div class="step-progress">
            <div class="progress-bar small">
              <div class="progress-fill" style="--progress: ${e.progress}"></div>
            </div>
          </div>
        `:""}
      </div>
    </div>
  `}function Ju(){if(en.length===0)return 0;const e=en.filter(s=>s.status==="completed").length,t=en.find(s=>s.status==="running"),n=t?.progress||0;return Math.round((e+(t?n/100:0))/en.length*100)}function AL(){const e=b("div",{className:"modal-footer"}),t=b("button",{className:"btn btn-secondary",textContent:"Cancel"});return d(t,"click",()=>{Wl?.(),Kg()}),e.appendChild(t),e}function ML(e,t){const n=en.findIndex(a=>a.id===e);if(n===-1)return;en[n]={...en[n],...t};const s=document.querySelector(`[data-modal-id="${ys}"]`);if(s){const a=s.querySelector(".processing-content");a&&Cr(a)}}function EL(e){en.push(e);const t=document.querySelector(`[data-modal-id="${ys}"]`);if(t){const n=t.querySelector(".processing-content");n&&Cr(n)}}function qL(e){en=e;const t=document.querySelector(`[data-modal-id="${ys}"]`);if(t){const n=t.querySelector(".processing-content");n&&Cr(n)}}function Kg(){K(ys),en=[],Wl=void 0}function jL(){return document.querySelector(`[data-modal-id="${ys}"]`)?.classList.contains("open")||!1}const Rt="auth-modal";let Bn="login",$s={},as="",yn=0,Zn=null;function Kl(e={}){Bn=e.initialMode||"login",$s=e;const t=document.querySelector(`[data-modal-id="${Rt}"]`);t&&t.remove();const n=b("div",{className:"auth-content"});Ms(n);const s=Pe({id:Rt,title:As(),content:n,size:"sm",closable:!e.required,onClose:e.onClose,footer:null});document.body.appendChild(s),De(Rt),setTimeout(()=>{const a=n.querySelector("input");a&&a.focus()},100)}function As(){switch(Bn){case"login":return"Sign In";case"register":return"Create Account";case"forgot":return"Reset Password";case"reset":return"Set New Password";case"otp-request":return"Sign In with Code";case"otp-verify":return"Enter Code";case"email-confirm":return"Confirm Email"}}function Ms(e){switch(Zn&&(clearInterval(Zn),Zn=null),Bn){case"login":PL(e);break;case"register":DL(e);break;case"forgot":zL(e);break;case"reset":IL(e);break;case"otp-request":HL(e);break;case"otp-verify":BL(e);break;case"email-confirm":RL(e);break}}function PL(e){e.innerHTML=`
    <form id="login-form" class="auth-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-error hidden" id="login-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Sign In</span>
          <span class="btn-loading hidden">Signing in...</span>
        </button>
      </div>
      <div class="auth-divider">
        <span>or</span>
      </div>
      <div class="form-group">
        <button type="button" class="btn btn-secondary btn-block" data-action="otp-request">
          Sign in with email code
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="forgot">Forgot password?</button>
        <span class="separator">|</span>
        <button type="button" class="btn-link" data-action="register">Create account</button>
      </div>
    </form>
  `;const t=e.querySelector("#login-form");d(t,"submit",async n=>{n.preventDefault(),await VL(t)}),Oa(e)}function DL(e){e.innerHTML=`
    <form id="register-form" class="auth-form">
      <div class="form-group">
        <label for="register-email">Email <span class="required">*</span></label>
        <input type="email" id="register-email" required autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label for="register-username">Username</label>
        <input type="text" id="register-username" autocomplete="username" placeholder="username (optional)" 
               pattern="^[a-zA-Z0-9_]+$" minlength="3">
        <small class="form-hint">Letters, numbers, and underscores only. Min 3 characters.</small>
      </div>
      <div class="form-group">
        <label for="register-display-name">Display Name</label>
        <input type="text" id="register-display-name" autocomplete="name" placeholder="Your Name (optional)">
      </div>
      <div class="form-group">
        <label for="register-password">Password <span class="required">*</span></label>
        <input type="password" id="register-password" required autocomplete="new-password" 
               minlength="12" placeholder="Min. 12 characters">
        <div class="password-strength" id="password-strength"></div>
      </div>
      <div class="form-group">
        <label for="register-confirm">Confirm Password <span class="required">*</span></label>
        <input type="password" id="register-confirm" required autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-error hidden" id="register-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Create Account</span>
          <span class="btn-loading hidden">Creating account...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Already have an account? Sign in</button>
      </div>
    </form>
  `;const t=e.querySelector("#register-form"),n=t.querySelector("#register-password");d(n,"input",()=>{Yg(n.value)}),d(t,"submit",async s=>{s.preventDefault(),await GL(t)}),Oa(e)}function zL(e){e.innerHTML=`
    <form id="forgot-form" class="auth-form">
      <p class="form-description">
        Enter your email address and we'll send you a link to reset your password.
      </p>
      <div class="form-group">
        <label for="forgot-email">Email</label>
        <input type="email" id="forgot-email" required autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="form-error hidden" id="forgot-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Send Reset Link</span>
          <span class="btn-loading hidden">Sending...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Back to sign in</button>
      </div>
    </form>
  `;const t=e.querySelector("#forgot-form");d(t,"submit",async n=>{n.preventDefault(),await ZL(t)}),Oa(e)}function IL(e){e.innerHTML=`
    <form id="reset-form" class="auth-form">
      <p class="form-description">
        Enter your new password below.
      </p>
      <div class="form-group">
        <label for="reset-password">New Password</label>
        <input type="password" id="reset-password" required autocomplete="new-password" 
               minlength="12" placeholder="Min. 12 characters">
        <div class="password-strength" id="reset-password-strength"></div>
      </div>
      <div class="form-group">
        <label for="reset-confirm">Confirm Password</label>
        <input type="password" id="reset-confirm" required autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-error hidden" id="reset-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Reset Password</span>
          <span class="btn-loading hidden">Resetting...</span>
        </button>
      </div>
    </form>
  `;const t=e.querySelector("#reset-form"),n=t.querySelector("#reset-password");d(n,"input",()=>{Yg(n.value,"reset-password-strength")}),d(t,"submit",async s=>{s.preventDefault(),await WL(t)})}function HL(e){e.innerHTML=`
    <form id="otp-request-form" class="auth-form">
      <p class="form-description">
        Enter your email address and we'll send you a one-time code to sign in.
      </p>
      <div class="form-group">
        <label for="otp-email">Email</label>
        <input type="email" id="otp-email" required autocomplete="email" placeholder="your@email.com" value="${as}">
      </div>
      <div class="form-error hidden" id="otp-request-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Send Code</span>
          <span class="btn-loading hidden">Sending...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Sign in with password</button>
        <span class="separator">|</span>
        <button type="button" class="btn-link" data-action="register">Create account</button>
      </div>
    </form>
  `;const t=e.querySelector("#otp-request-form");d(t,"submit",async n=>{n.preventDefault(),await NL(t,e)}),Oa(e)}function BL(e){const t=as?as.replace(/(.{2})(.*)(@.*)/,"$1***$3"):"your email";e.innerHTML=`
    <form id="otp-verify-form" class="auth-form">
      <p class="form-description">
        Enter the 6-digit code sent to <strong>${t}</strong>
      </p>
      <div class="form-group otp-input-group">
        <div class="otp-inputs">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="one-time-code" data-index="0">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="1">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="2">
          <span class="otp-separator">-</span>
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="3">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="4">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="5">
        </div>
        <input type="hidden" id="otp-code" name="code">
      </div>
      <div class="form-error hidden" id="otp-verify-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block" id="otp-verify-btn" disabled>
          <span class="btn-text">Verify Code</span>
          <span class="btn-loading hidden">Verifying...</span>
        </button>
      </div>
      <div class="otp-resend">
        <button type="button" class="btn-link" id="resend-code-btn" ${yn>0?"disabled":""}>
          ${yn>0?`Resend code in ${yn}s`:"Resend code"}
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="otp-request">Use different email</button>
        <span class="separator">|</span>
        <button type="button" class="btn-link" data-action="login">Sign in with password</button>
      </div>
    </form>
  `;const n=e.querySelector("#otp-verify-form"),s=e.querySelectorAll(".otp-digit"),a=e.querySelector("#otp-code"),o=e.querySelector("#otp-verify-btn"),i=e.querySelector("#resend-code-btn");Qg(s,a,o),yn>0&&Jg(i),d(i,"click",async()=>{await FL(e)}),d(n,"submit",async r=>{r.preventDefault(),await OL(n)}),Oa(e),setTimeout(()=>s[0]?.focus(),100)}function RL(e){const t=$s.email||as||"";e.innerHTML=`
    <form id="email-confirm-form" class="auth-form">
      <div class="confirm-icon">‚úâÔ∏è</div>
      <p class="form-description">
        Enter the confirmation code sent to <strong>${t||"your email"}</strong>
      </p>
      <div class="form-group otp-input-group">
        <div class="otp-inputs">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="0">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="1">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="2">
          <span class="otp-separator">-</span>
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="3">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="4">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="5">
        </div>
        <input type="hidden" id="confirm-code" name="code">
      </div>
      <div class="form-error hidden" id="email-confirm-error"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block" id="confirm-btn" disabled>
          <span class="btn-text">Confirm Email</span>
          <span class="btn-loading hidden">Confirming...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Back to sign in</button>
      </div>
    </form>
  `;const n=e.querySelector("#email-confirm-form"),s=e.querySelectorAll(".otp-digit"),a=e.querySelector("#confirm-code"),o=e.querySelector("#confirm-btn");Qg(s,a,o),d(n,"submit",async i=>{i.preventDefault(),await UL(n,e,t)}),Oa(e),setTimeout(()=>s[0]?.focus(),100)}function Qg(e,t,n){const s=()=>{const a=Array.from(e).map(o=>o.value).join("");t.value=a,n.disabled=a.length!==6||!/^\d{6}$/.test(a)};e.forEach((a,o)=>{d(a,"input",i=>{const r=i.target.value;if(!/^\d*$/.test(r)){a.value=r.replace(/\D/g,"");return}if(r.length>1){const c=r.split("");e.forEach((u,p)=>{u.value=c[p]||""});const l=Math.min(c.length,5);e[l]?.focus(),s();return}r&&o<e.length-1&&e[o+1].focus(),s()}),d(a,"keydown",i=>{const r=i.key;r==="Backspace"&&!a.value&&o>0&&(e[o-1].focus(),e[o-1].value="",s()),r==="ArrowLeft"&&o>0&&e[o-1].focus(),r==="ArrowRight"&&o<e.length-1&&e[o+1].focus()}),d(a,"paste",i=>{i.preventDefault();const c=(i.clipboardData?.getData("text")||"").replace(/\D/g,"").slice(0,6);if(c){c.split("").forEach((u,p)=>{e[p]&&(e[p].value=u)});const l=Math.min(c.length,5);e[l]?.focus(),s()}}),d(a,"focus",()=>a.select())})}function Jg(e){Zn&&clearInterval(Zn);const t=()=>{yn>0?(e.disabled=!0,e.textContent=`Resend code in ${yn}s`,yn--):(e.disabled=!1,e.textContent="Resend code",Zn&&(clearInterval(Zn),Zn=null))};t(),Zn=setInterval(t,1e3)}async function NL(e,t){const n=e.querySelector("#otp-email").value.trim(),s=e.querySelector("#otp-request-error");Ot(e,!0),Ys(s);try{const a=await Nt.requestLoginCode(n);as=n,yn=60,m.success(a.message||"Code sent! Check your email."),Bn="otp-verify";const o=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);o&&(o.textContent=As()),Ms(t)}catch(a){const i=a.message||"Failed to send code";Wt(s,i)}finally{Ot(e,!1)}}async function OL(e,t){const n=e.querySelector("#otp-code").value,s=e.querySelector("#otp-verify-error");if(!n||n.length!==6){Wt(s,"Please enter the 6-digit code");return}Ot(e,!0),Ys(s);try{const a=await Nt.verifyLoginCode(as,n);m.success("Signed in successfully"),$s.onSuccess?.(a),K(Rt),window.dispatchEvent(new CustomEvent("godmode:auth-success"))}catch(a){const o=a;let i=o.message||"Verification failed";o.attemptsRemaining!==void 0&&o.attemptsRemaining>0&&(i+=` (${o.attemptsRemaining} attempts remaining)`),o.needsEmailVerification&&(i="Please confirm your email address first."),o.fallbackToPassword&&(i="Please sign in with your password instead."),Wt(s,i);const r=e.querySelectorAll(".otp-digit");r.forEach(c=>c.value=""),r[0]?.focus()}finally{Ot(e,!1)}}async function FL(e){if(yn>0)return;const t=e.querySelector("#resend-code-btn");t.disabled=!0,t.textContent="Sending...";try{await Nt.requestLoginCode(as),m.success("New code sent!"),yn=60,Jg(t)}catch(n){const s=n;m.error(s.message||"Failed to resend code"),t.disabled=!1,t.textContent="Resend code"}}async function UL(e,t,n){const s=e.querySelector("#confirm-code").value,a=e.querySelector("#email-confirm-error");if(!s||s.length!==6){Wt(a,"Please enter the 6-digit code");return}Ot(e,!0),Ys(a);try{await Nt.confirmEmail(n,s),m.success("Email confirmed! You can now sign in."),Bn="login";const o=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);o&&(o.textContent=As()),Ms(t)}catch(o){Wt(a,o.message||"Confirmation failed");const r=e.querySelectorAll(".otp-digit");r.forEach(c=>c.value=""),r[0]?.focus()}finally{Ot(e,!1)}}function Oa(e){e.querySelectorAll("[data-action]").forEach(n=>{d(n,"click",()=>{Bn=n.getAttribute("data-action");const a=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);a&&(a.textContent=As()),Ms(e)})})}async function VL(e){const t=e.querySelector("#login-email").value.trim(),n=e.querySelector("#login-password").value,s=e.querySelector("#login-error");Ot(e,!0),Ys(s);try{const a=await Nt.login({email:t,password:n});m.success("Signed in successfully"),$s.onSuccess?.(a),K(Rt),window.dispatchEvent(new CustomEvent("godmode:auth-success"))}catch(a){const o=a,i=o.response?.data;if(i?.needsEmailVerification){as=i.email||t,$s.email=as,yn=60,m.info("Please verify your email to continue."),Bn="email-confirm";const c=e.parentElement,l=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);l&&(l.textContent=As()),Ms(c);return}const r=o.message||"Login failed";Wt(s,r)}finally{Ot(e,!1)}}async function GL(e){const t=e.querySelector("#register-email").value.trim(),n=e.querySelector("#register-username").value.trim(),s=e.querySelector("#register-display-name").value.trim(),a=e.querySelector("#register-password").value,o=e.querySelector("#register-confirm").value,i=e.querySelector("#register-error");if(a!==o){Wt(i,"Passwords do not match");return}if(a.length<12){Wt(i,"Password must be at least 12 characters");return}Ot(e,!0),Ys(i);try{const r=await Nt.register({email:t,password:a,username:n||void 0,display_name:s||void 0});if(r.needsEmailVerification){m.success("Account created! Please check your email to verify."),Bn="login";const c=e.parentElement,l=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);l&&(l.textContent=As()),Ms(c)}else m.success("Account created successfully"),$s.onSuccess?.(r.user),K(Rt),window.dispatchEvent(new CustomEvent("godmode:auth-success"))}catch(r){const c=r instanceof Error?r.message:"Registration failed";Wt(i,c)}finally{Ot(e,!1)}}async function ZL(e){const t=e.querySelector("#forgot-email").value.trim(),n=e.querySelector("#forgot-error");Ot(e,!0),Ys(n);try{await Nt.forgotPassword(t),m.success("If an account exists with this email, you will receive a reset link."),Bn="login";const s=e.parentElement,a=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);a&&(a.textContent=As()),Ms(s)}catch{m.success("If an account exists with this email, you will receive a reset link.")}finally{Ot(e,!1)}}async function WL(e){const t=e.querySelector("#reset-password").value,n=e.querySelector("#reset-confirm").value,s=e.querySelector("#reset-error");if(t!==n){Wt(s,"Passwords do not match");return}if(t.length<12){Wt(s,"Password must be at least 12 characters");return}if(!$s.resetToken){Wt(s,"Invalid reset token. Please request a new reset link.");return}Ot(e,!0),Ys(s);try{await Nt.resetPassword(t,$s.resetToken),m.success("Password reset successfully. You can now sign in."),Bn="login";const a=e.parentElement,o=document.querySelector(`[data-modal-id="${Rt}"] .modal-header h3`);o&&(o.textContent=As()),Ms(a)}catch(a){const o=a instanceof Error?a.message:"Password reset failed";Wt(s,o)}finally{Ot(e,!1)}}function Ot(e,t){const n=e.querySelector('button[type="submit"]'),s=e.querySelectorAll("input"),a=n.querySelector(".btn-text"),o=n.querySelector(".btn-loading");n.disabled=t,s.forEach(i=>i.disabled=t),a&&o&&(a.classList.toggle("hidden",!!t),o.classList.toggle("hidden",!t))}function Wt(e,t){e.textContent=t,e.classList.remove("hidden")}function Ys(e){e.classList.add("hidden"),e.textContent=""}function Yg(e,t="password-strength"){const n=document.getElementById(t);if(!n)return;const s=KL(e);n.className=`password-strength strength-${s.level}`,n.innerHTML=`
    <div class="strength-bar">
      <div class="strength-fill" style="--strength-width: ${s.score}%"></div>
    </div>
    <span class="strength-label">${s.label}</span>
  `}function KL(e){let t=0;return e.length>=12&&(t+=25),e.length>=16&&(t+=15),/[a-z]/.test(e)&&(t+=15),/[A-Z]/.test(e)&&(t+=15),/[0-9]/.test(e)&&(t+=15),/[^a-zA-Z0-9]/.test(e)&&(t+=15),t<30?{level:"weak",score:t,label:"Weak"}:t<60?{level:"fair",score:t,label:"Fair"}:t<80?{level:"good",score:t,label:"Good"}:{level:"strong",score:Math.min(t,100),label:"Strong"}}function QL(){K(Rt)}const Yu="companies-modal",he={title:"Companies",close:"Close",newCompany:"+ New company",noCompanies:"No companies yet. Create one to use in projects.",edit:"Edit",analyze:"Analyze",reAnalyze:"Re-analyze",viewDetail:"View",detail:"Company detail",analyzedOn:"Analyzed",notAnalyzed:"Not analyzed",delete:"Delete",backToList:"‚Üê Back to list",name:"Name *",description:"Description",logoUrl:"Logo URL",website:"Website",linkedIn:"LinkedIn",save:"Save",create:"Create",cancel:"Cancel",invalidUrl:"Please enter a valid URL",updateFailed:"Update failed",createFailed:"Create failed",loadFailed:"Failed to load company",analysisComplete:"Analysis complete",analysisFailed:"Analysis failed",deleteConfirm:"Delete this company? Projects using it must be reassigned first.",companyDeleted:"Company deleted",templates:"Templates (A4 / PPT)",templateA4:"A4 document",templatePPT:"Presentation",generateWithAI:"Generate base with AI",loadCurrent:"Load current",saveTemplate:"Save template",templateLoaded:"Template loaded",templateSaved:"Template saved",templateGenerated:"Template generated",templateLoadFailed:"Failed to load template",templateSaveFailed:"Failed to save template",templateGenerateFailed:"Generation failed"};function ve(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ac(e){if(!e||!e.trim())return!0;try{const t=new URL(e.trim());return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}function JL(){const e=document.querySelector(`[data-modal-id="${Yu}"]`);e&&e.remove();const t=b("div",{className:"modal-overlay"});t.setAttribute("data-modal-id",Yu);const n=b("div",{className:"modal-container",style:"max-width: 640px;"});n.innerHTML=`
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-color, #e2e8f0);">
      <h2 style="margin: 0; font-size: 1.25rem;">${ve(he.title)}</h2>
      <button type="button" class="btn-icon" id="companies-close-btn" title="${ve(he.close)}">‚úï</button>
    </div>
    <div class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
      <button type="button" class="btn btn-primary" id="companies-new-btn" style="margin-bottom: 16px;">${ve(he.newCompany)}</button>
      <div id="companies-list">Loading...</div>
    </div>
  `,t.appendChild(n),document.body.appendChild(t);function s(){t.remove()}function a(f){const h=t.querySelector("#companies-list");if(!h)return;const k=Array.isArray(f)?f:[];try{if(k.length===0){h.innerHTML=`<p style="color: var(--text-secondary);">${ve(he.noCompanies)}</p>`;return}const C=x=>x.brand_assets?.analyzed_at;h.innerHTML=k.map(x=>{const $=!!C(x),w=$?he.reAnalyze:he.analyze,y=$?`<span class="companies-analyzed-badge" title="${ve(C(x)||"")}" style="font-size: 11px; color: var(--text-secondary); margin-left: 6px;">${ve(he.analyzedOn)}</span>`:`<span class="companies-not-analyzed-badge" style="font-size: 11px; color: var(--text-muted, #94a3b8); margin-left: 6px;">${ve(he.notAnalyzed)}</span>`;return`
      <div class="companies-row" data-id="${x.id}" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          ${x.logo_url?`<img src="${ve(x.logo_url)}" alt="" style="width: 36px; height: 36px; object-fit: contain; border-radius: 6px;">`:'<span style="width: 36px; height: 36px; background: var(--bg-secondary); border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; font-size: 18px;">üè¢</span>'}
          <div>
            <strong>${ve(x.name)}</strong>${y}
            ${x.brand_assets?.primary_color&&x.brand_assets?.secondary_color?`<span style="display: inline-flex; gap: 4px; margin-left: 8px;"><i style="width: 12px; height: 12px; border-radius: 2px; background: ${ve(x.brand_assets.primary_color)};"></i><i style="width: 12px; height: 12px; border-radius: 2px; background: ${ve(x.brand_assets.secondary_color)};"></i></span>`:""}
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn btn-sm btn-secondary companies-detail-btn" data-id="${x.id}" title="View analysis">${ve(he.viewDetail)}</button>
          <button type="button" class="btn btn-sm btn-secondary companies-edit-btn" data-id="${x.id}">${ve(he.edit)}</button>
          <button type="button" class="btn btn-sm btn-secondary companies-analyze-btn" data-id="${x.id}" title="Analyze with AI">${ve(w)}</button>
          <button type="button" class="btn btn-sm btn-outline-danger companies-delete-btn" data-id="${x.id}">${ve(he.delete)}</button>
        </div>
      </div>
    `}).join("")}catch{h.innerHTML=`<p class="text-error">${ve(he.loadFailed)}</p>`}}function o(){const f=t.querySelector("#companies-list");f&&(f.innerHTML="Loading..."),mr().then(h=>a(Array.isArray(h)?h:[])).catch(()=>{try{const h=t.querySelector("#companies-list");h&&(h.innerHTML=`<p class="text-error">${ve(he.loadFailed)}</p>`)}catch{}})}const i=`
    <button type="button" class="btn btn-primary" id="companies-new-btn" style="margin-bottom: 16px;">${ve(he.newCompany)}</button>
    <div id="companies-list">Loading...</div>
  `;function r(){const f=t.querySelector(".modal-body");f&&(f.innerHTML=i,o(),g())}function c(f){const h=t.querySelector(".modal-body");if(!h)return;const k=!!f;if(h.innerHTML=`
      <div style="margin-bottom: 16px;">
        <button type="button" class="btn btn-secondary btn-sm" id="companies-back-btn">${ve(he.backToList)}</button>
      </div>
      <form id="company-form" style="display: flex; flex-direction: column; gap: 14px;">
        <div>
          <label>${ve(he.name)}</label>
          <input type="text" name="name" required value="${f?ve(f.name):""}" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color);">
        </div>
        <div>
          <label>${ve(he.description)}</label>
          <textarea name="description" rows="2" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color);">${f?.description?ve(f.description):""}</textarea>
        </div>
        <div>
          <label>${ve(he.logoUrl)}</label>
          <input type="url" name="logo_url" value="${f?.logo_url?ve(f.logo_url):""}" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color);" placeholder="https://...">
        </div>
        <div>
          <label>${ve(he.website)}</label>
          <input type="url" name="website_url" value="${f?.website_url?ve(f.website_url):""}" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color);" placeholder="https://...">
        </div>
        <div>
          <label>${ve(he.linkedIn)}</label>
          <input type="url" name="linkedin_url" value="${f?.linkedin_url?ve(f.linkedin_url):""}" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color);" placeholder="https://linkedin.com/...">
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="submit" class="btn btn-primary">${ve(k?he.save:he.create)}</button>
          <button type="button" class="btn btn-secondary" id="company-form-cancel">${ve(he.cancel)}</button>
        </div>
        ${k&&f?`
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
          <button type="button" class="btn btn-secondary btn-sm" id="companies-templates-btn">${ve(he.templates)}</button>
        </div>
        `:""}
      </form>
    `,d(h.querySelector("#companies-back-btn"),"click",r),d(h.querySelector("#company-form"),"submit",async C=>{C.preventDefault();const x=h.querySelector("#company-form"),$=new FormData(x),w=$.get("logo_url")?.trim()||void 0,y=$.get("website_url")?.trim()||void 0,S=$.get("linkedin_url")?.trim()||void 0;if(w&&!ac(w)){m.error(he.invalidUrl+" (Logo)");return}if(y&&!ac(y)){m.error(he.invalidUrl+" (Website)");return}if(S&&!ac(S)){m.error(he.invalidUrl+" (LinkedIn)");return}const P={name:$.get("name").trim(),description:$.get("description")?.trim()||void 0,logo_url:w,website_url:y,linkedin_url:S};try{k&&f?(await Ip(f.id,P),m.success("Company updated")):(await zp(P),m.success("Company created")),r()}catch{m.error(k?he.updateFailed:he.createFailed)}}),d(h.querySelector("#company-form-cancel"),"click",r),k&&f){const C=h.querySelector("#companies-templates-btn");C&&d(C,"click",()=>l(f))}}function l(f){const h=t.querySelector(".modal-body");if(!h)return;let k="a4";h.innerHTML=`
      <div style="margin-bottom: 16px;">
        <button type="button" class="btn btn-secondary btn-sm" id="templates-back-btn">${ve(he.backToList)}</button>
      </div>
      <h3 style="margin: 0 0 12px 0; font-size: 1rem;">${ve(f.name)} ‚Äì ${ve(he.templates)}</h3>
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button type="button" class="btn btn-sm btn-secondary template-type-btn active" data-type="a4">${ve(he.templateA4)}</button>
        <button type="button" class="btn btn-sm btn-secondary template-type-btn" data-type="ppt">${ve(he.templatePPT)}</button>
      </div>
      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <button type="button" class="btn btn-sm btn-secondary" id="template-load-btn">${ve(he.loadCurrent)}</button>
        <button type="button" class="btn btn-sm btn-primary" id="template-generate-btn">${ve(he.generateWithAI)}</button>
        <button type="button" class="btn btn-sm btn-primary" id="template-save-btn">${ve(he.saveTemplate)}</button>
      </div>
      <textarea id="template-html-editor" rows="14" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-family: monospace; font-size: 12px;" placeholder="HTML template..."></textarea>
    `;const C=h.querySelector("#template-html-editor"),x=h.querySelector("#template-load-btn"),$=h.querySelector("#template-generate-btn"),w=h.querySelector("#template-save-btn");function y(S){k=S,h.querySelectorAll(".template-type-btn").forEach(P=>P.classList.toggle("active",P.getAttribute("data-type")===S))}d(h.querySelector("#templates-back-btn"),"click",()=>c(f)),h.querySelectorAll(".template-type-btn").forEach(S=>{d(S,"click",()=>y(S.getAttribute("data-type")||"a4"))}),d(x,"click",async()=>{x.disabled=!0;try{const S=await Si(f.id,k);C.value=S,m.success(he.templateLoaded)}catch{m.error(he.templateLoadFailed)}finally{x.disabled=!1}}),d($,"click",async()=>{$.disabled=!0,$.textContent="...";try{const{html:S}=await Rp(f.id,k);C.value=S,m.success(he.templateGenerated)}catch{m.error(he.templateGenerateFailed)}finally{$.disabled=!1,$.textContent=he.generateWithAI}}),d(w,"click",async()=>{w.disabled=!0;try{await Bp(f.id,k,C.value),m.success(he.templateSaved)}catch{m.error(he.templateSaveFailed)}finally{w.disabled=!1}}),Si(f.id,k).then(S=>{C.value=S}).catch(()=>{})}const u={ficha_identidade:"1. Ficha de Identidade",visao_geral:"2. Vis√£o Geral e Posicionamento",produtos_servicos:"3. Produtos e Servi√ßos",publico_alvo:"4. P√∫blico-Alvo e Clientes",equipa_lideranca:"5. Equipa e Lideran√ßa",presenca_digital:"6. Presen√ßa Digital e Marketing",analise_competitiva:"7. An√°lise Competitiva",indicadores_crescimento:"8. Indicadores de Crescimento",swot:"9. An√°lise SWOT",conclusoes:"10. Conclus√µes e Insights"};function p(f){const h=t.querySelector(".modal-body");if(!h)return;const k=f.brand_assets,C=k?.analyzed_at?new Date(k.analyzed_at).toLocaleString():"‚Äî",x=(k?.ai_context||"").trim()||"‚Äî",$=k?.primary_color||"‚Äî",w=k?.secondary_color||"‚Äî",y=k?.analysis_report||{},S=Object.keys(y).length>0,P=Object.keys(u),j=S?P.map(B=>{const Z=u[B],O=(y[B]||"").trim()||"‚Äî";return`<div class="companies-report-section"><strong>${ve(Z)}</strong><div class="companies-report-text">${ve(O)}</div></div>`}).join(""):`<div><strong>AI context</strong><div class="companies-report-text">${ve(x)}</div></div>
        <div><strong>Primary color</strong> <span style="display: inline-flex; align-items: center; gap: 6px;">${$!=="‚Äî"?`<span style="width: 20px; height: 20px; border-radius: 4px; background: ${ve($)};"></span><code>${ve($)}</code>`:"‚Äî"}</span></div>
        <div><strong>Secondary color</strong> <span style="display: inline-flex; align-items: center; gap: 6px;">${w!=="‚Äî"?`<span style="width: 20px; height: 20px; border-radius: 4px; background: ${ve(w)};"></span><code>${ve(w)}</code>`:"‚Äî"}</span></div>`,H=f.logo_url?`<img src="${ve(f.logo_url)}" alt="" class="companies-detail-logo" onerror="this.style.display='none'">`:'<span class="companies-detail-logo-placeholder">üè¢</span>';h.innerHTML=`
      <div style="margin-bottom: 16px;">
        <button type="button" class="btn btn-secondary btn-sm" id="companies-detail-back-btn">${ve(he.backToList)}</button>
      </div>
      <div class="companies-detail-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
        ${H}
        <div>
          <h3 style="margin: 0 0 4px 0; font-size: 1.25rem;">${ve(f.name)}</h3>
          <div style="font-size: 12px; color: var(--text-secondary);">${ve(he.analyzedOn)} ${ve(C)}</div>
        </div>
      </div>
      <div class="companies-detail-report" style="display: flex; flex-direction: column; gap: 14px; max-height: 55vh; overflow-y: auto;">
        ${j}
      </div>
      ${S?`<div style="margin-top: 8px;"><strong>Primary color</strong> ${$!=="‚Äî"?`<span style="display: inline-flex; align-items: center; gap: 6px;"><span style="width: 16px; height: 16px; border-radius: 4px; background: ${ve($)};"></span><code>${ve($)}</code></span>`:"‚Äî"} &nbsp; <strong>Secondary</strong> ${w!=="‚Äî"?`<span style="display: inline-flex; align-items: center; gap: 6px;"><span style="width: 16px; height: 16px; border-radius: 4px; background: ${ve(w)};"></span><code>${ve(w)}</code></span>`:"‚Äî"}</div>`:""}
      <div style="margin-top: 16px; display: flex; gap: 8px;">
        <button type="button" class="btn btn-primary" id="companies-detail-reanalyze-btn" data-id="${ve(f.id)}">${ve(he.reAnalyze)}</button>
        <button type="button" class="btn btn-secondary" id="companies-detail-edit-btn" data-id="${ve(f.id)}">${ve(he.edit)}</button>
      </div>
    `,d(h.querySelector("#companies-detail-back-btn"),"click",r),d(h.querySelector("#companies-detail-edit-btn"),"click",()=>c(f));const J=h.querySelector("#companies-detail-reanalyze-btn");d(J,"click",async()=>{J.disabled=!0,J.textContent="...";try{const B=await Mo(f.id);m.success(he.analysisComplete),p(B)}catch{m.error(he.analysisFailed)}finally{J.disabled=!1,J.textContent=he.reAnalyze}})}function g(){d(t.querySelector("#companies-close-btn"),"click",s),d(t,"click",f=>{f.target===t&&s()}),d(n,"click",f=>f.stopPropagation()),d(n,"click",async f=>{const h=f.target;if(h.closest("#companies-new-btn")){c();return}const k=h.closest(".companies-edit-btn"),C=h.closest(".companies-analyze-btn"),x=h.closest(".companies-detail-btn"),$=h.closest(".companies-delete-btn"),w=(k||C||x||$)?.getAttribute("data-id");if(w){if(x){try{const y=await $i(w);y&&p(y)}catch{m.error(he.loadFailed)}return}if(k){try{const y=await $i(w);y&&c(y)}catch{m.error(he.loadFailed)}return}if(C){const y=C;y.disabled=!0;const S=y.textContent;y.textContent="...";try{await Mo(w),m.success(he.analysisComplete),o()}catch{m.error(he.analysisFailed)}finally{y.disabled=!1,y.textContent=S||he.analyze}return}if($){if(!confirm(he.deleteConfirm))return;try{await Hp(w),m.success(he.companyDeleted),o()}catch{}}}})}o(),g()}const ms="contact-modal";let Xg=null,Go=[],ya=[],Jc=[],Zi=[],Pa=[];function zn(e){const{mode:t,contact:n}=e;Xg=n||null;const s=document.querySelector(`[data-modal-id="${ms}"]`);s&&s.remove();const a=YL(t,n),o=Pe({id:ms,title:"",content:a,size:"lg"}),i=o.querySelector(".modal-content");i&&i.classList.add("modal-content-transparent");const r=o.querySelector(".modal-header");r&&r.classList.add("hidden"),document.body.appendChild(o),De(ms),t==="edit"&&n?.id?XL(a,n.id):(e5(a),n5(a),t5(a)),a5(a,e)}function YL(e,t){const n=b("div",{className:"contact-modal-sota"}),s=e==="edit",a=t?Ai(t.name):"?",o=!!(t?.photoUrl||t?.avatarUrl),i=t?.photoUrl||t?.avatarUrl;return n.innerHTML=`
    <style>
      .contact-modal-sota {
        background: var(--bg-primary);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      }

      /* Header */
      .contact-modal-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 50%, #9f1239 100%);
        padding: 32px 32px 24px;
        position: relative;
      }

      .contact-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.2s;
      }

      .contact-modal-close:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
      }

      .contact-modal-close svg {
        width: 20px;
        height: 20px;
      }

      .contact-header-content {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .contact-avatar-large {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 700;
        color: white;
        border: 4px solid rgba(255,255,255,0.3);
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .contact-avatar-large:hover {
        border-color: rgba(255,255,255,0.5);
      }

      .contact-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .contact-avatar-large .avatar-upload-hint {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .contact-avatar-large:hover .avatar-upload-hint {
        opacity: 1;
      }

      .contact-avatar-large .avatar-upload-hint svg {
        width: 28px;
        height: 28px;
        color: white;
      }

      .contact-header-info {
        flex: 1;
        color: white;
      }

      .contact-header-info h2 {
        margin: 0 0 4px 0;
        font-size: 26px;
        font-weight: 700;
      }

      .contact-header-info p {
        margin: 0;
        font-size: 15px;
        opacity: 0.85;
      }

      .contact-header-actions {
        display: flex;
        gap: 10px;
      }

      .header-action-btn {
        padding: 10px 16px;
        border-radius: 10px;
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .header-action-btn:hover {
        background: rgba(255,255,255,0.25);
      }

      .header-action-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Tabs */
      .contact-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        padding: 0 32px;
        background: var(--bg-secondary);
      }

      .contact-tab-btn {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        transition: color 0.2s;
      }

      .contact-tab-btn:hover {
        color: var(--text-primary);
      }

      .contact-tab-btn.active {
        color: #e11d48;
      }

      .contact-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #e11d48, #f59e0b);
        border-radius: 3px 3px 0 0;
      }

      .contact-tab-btn svg {
        width: 16px;
        height: 16px;
      }

      .contact-tab-btn .tab-count {
        background: rgba(225,29,72,0.1);
        color: #e11d48;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
      }

      /* Tab Content */
      .contact-tab-content {
        padding: 28px 32px;
        min-height: 400px;
        max-height: 500px;
        overflow-y: auto;
      }

      .contact-section {
        display: none;
      }

      .contact-section.active {
        display: block;
      }

      /* Form Styles */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .form-grid.full {
        grid-template-columns: 1fr;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-field.full-width {
        grid-column: 1 / -1;
      }

      .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .form-field label svg {
        width: 14px;
        height: 14px;
        color: #e11d48;
      }

      .form-field input,
      .form-field textarea,
      .form-field select {
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s;
      }

      .form-field input:focus,
      .form-field textarea:focus,
      .form-field select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
      }

      .form-field textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-hint {
        font-size: 12px;
        color: var(--text-tertiary);
      }

      /* Projects Section */
      .projects-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .project-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        transition: all 0.2s;
      }

      .project-item:hover {
        border-color: rgba(225,29,72,0.3);
      }

      .project-checkbox {
        width: 20px;
        height: 20px;
        accent-color: #e11d48;
      }

      .project-item label {
        flex: 1;
        font-size: 14px;
        color: var(--text-primary);
        cursor: pointer;
      }

      .project-item .primary-badge {
        padding: 3px 8px;
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
      }

      /* Relations Section */
      .relations-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .relation-card {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        transition: all 0.2s;
      }

      .relation-card:hover {
        border-color: rgba(225,29,72,0.3);
        transform: translateX(4px);
      }

      .relation-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: white;
        overflow: hidden;
      }

      .relation-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .relation-info {
        flex: 1;
      }

      .relation-info h4 {
        margin: 0 0 2px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .relation-info p {
        margin: 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .relation-type {
        padding: 4px 10px;
        background: rgba(99,102,241,0.1);
        color: #6366f1;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      .add-relation-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        background: var(--bg-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .add-relation-btn:hover {
        border-color: #e11d48;
        color: #e11d48;
      }

      .add-relation-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Activity Section */
      .activity-timeline {
        position: relative;
        padding-left: 28px;
      }

      .activity-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
      }

      .activity-item {
        position: relative;
        padding-bottom: 20px;
      }

      .activity-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e11d48;
        border: 2px solid var(--bg-primary);
      }

      .activity-item.email::before { background: #3b82f6; }
      .activity-item.meeting::before { background: #10b981; }
      .activity-item.note::before { background: #f59e0b; }

      .activity-time {
        font-size: 11px;
        color: var(--text-tertiary);
        margin-bottom: 4px;
      }

      .activity-content {
        font-size: 14px;
        color: var(--text-primary);
        line-height: 1.5;
      }

      .activity-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .activity-empty svg {
        width: 48px;
        height: 48px;
        opacity: 0.4;
        margin-bottom: 12px;
      }

      /* Footer */
      .contact-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 32px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }

      .footer-left {
        display: flex;
        gap: 10px;
      }

      .footer-right {
        display: flex;
        gap: 10px;
      }

      .btn-sota {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }

      .btn-sota.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(225,29,72,0.4);
      }

      .btn-sota.secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-sota.secondary:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
      }

      .btn-sota.danger {
        background: transparent;
        color: #dc2626;
        border: 1px solid #dc2626;
      }

      .btn-sota.danger:hover {
        background: #dc2626;
        color: white;
      }

      .btn-sota svg {
        width: 16px;
        height: 16px;
      }

      .btn-sota:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Loading */
      .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .loading-spinner::after {
        content: '';
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 12px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>

    <!-- Header -->
    <div class="contact-modal-header">
      <button class="contact-modal-close" id="close-contact-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <div class="contact-header-content">
        <div class="contact-avatar-large" id="contact-avatar-upload">
          ${o?`<img src="${i}" alt="">`:`<span>${a}</span>`}
          <div class="avatar-upload-hint">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
        </div>

        <div class="contact-header-info">
          <h2 id="header-contact-name">${s?Ke(t?.name||""):"New Contact"}</h2>
          <p id="header-contact-org">${s&&t?.organization?Ke(t.organization):"Add organization"}</p>
        </div>

        ${s?`
          <div class="contact-header-actions">
            <button class="header-action-btn" id="enrich-ai-btn" title="Enrich with AI">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Enrich with AI
            </button>
          </div>
        `:""}
      </div>
    </div>

    <!-- Tabs -->
    <div class="contact-tabs">
      <button class="contact-tab-btn active" data-tab="info">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        Info
      </button>
      <button class="contact-tab-btn" data-tab="projects">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        Projects
        <span class="tab-count" id="projects-count">0</span>
      </button>
      <button class="contact-tab-btn" data-tab="relations">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        Relations
        <span class="tab-count" id="relations-count">0</span>
      </button>
      <button class="contact-tab-btn" data-tab="activity">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Activity
      </button>
    </div>

    <!-- Tab Content -->
    <div class="contact-tab-content">
      <!-- Info Section -->
      <div class="contact-section active" id="section-info">
        <form id="contact-form">
          <div class="form-grid">
            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Name *
              </label>
              <input type="text" id="contact-name" required value="${Ke(t?.name||"")}" placeholder="Full name">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Role
              </label>
              <select id="contact-role">
                <option value="">-- Select role --</option>
                <option value="__custom__">Custom role...</option>
              </select>
              <input type="text" id="contact-role-custom" class="contact-role-custom hidden" placeholder="Enter custom role" value="${t?.role&&!Pa.some(r=>r.display_name===t.role)?Ke(t.role):""}">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Email
              </label>
              <input type="email" id="contact-email" value="${Ke(t?.email||"")}" placeholder="email@example.com">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                Phone
              </label>
              <input type="tel" id="contact-phone" value="${Ke(t?.phone||"")}" placeholder="+1 234 567 890">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Organization
              </label>
              <input type="text" id="contact-organization" value="${Ke(t?.organization||t?.company||"")}" placeholder="Company name">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                </svg>
                LinkedIn
              </label>
              <input type="url" id="contact-linkedin" value="${Ke(t?.linkedin||"")}" placeholder="https://linkedin.com/in/...">
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Avatar URL
              </label>
              <input type="url" id="contact-avatar-url" value="${Ke(t?.photoUrl||t?.avatarUrl||t?.photo_url||t?.avatar_url||"")}" placeholder="https://example.com/photo.jpg">
              <div class="form-hint">Enter a URL to set the contact's profile picture</div>
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Department
              </label>
              <input type="text" id="contact-department" value="${Ke(t?.department||"")}" placeholder="Engineering, Sales, etc.">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Location
              </label>
              <input type="text" id="contact-location" value="${Ke(t?.location||"")}" placeholder="City, Country">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Timezone
              </label>
              <select id="contact-timezone" data-current="${Ke(t?.timezone||"")}">
                <option value="">Select timezone...</option>
              </select>
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Aliases
              </label>
              <input type="text" id="contact-aliases" value="${t?.aliases?.join(", ")||""}" placeholder="Alternative names (comma separated)">
              <div class="form-hint">Names used to identify this person in documents (e.g., "Luuc" for "Luuk")</div>
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Notes
              </label>
              <textarea id="contact-notes" placeholder="Additional notes about this contact...">${Ke(t?.notes||"")}</textarea>
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                Tags
              </label>
              <input type="text" id="contact-tags" value="${t?.tags?.join(", ")||""}" placeholder="client, vip, technical (comma separated)">
              <div class="form-hint">Separate tags with commas</div>
            </div>
          </div>
        </form>
      </div>

      <!-- Projects Section -->
      <div class="contact-section" id="section-projects">
        <div class="projects-list" id="projects-list">
          <div class="loading-spinner">Loading projects</div>
        </div>
      </div>

      <!-- Relations Section -->
      <div class="contact-section" id="section-relations">
        <div class="relations-list" id="relations-list">
          <div class="loading-spinner">Loading relations</div>
        </div>
        <button class="add-relation-btn" id="add-relation-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Relationship
        </button>
      </div>

      <!-- Activity Section -->
      <div class="contact-section" id="section-activity">
        <div class="activity-timeline" id="activity-timeline">
          <div class="loading-spinner">Loading activity</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="contact-modal-footer">
      <div class="footer-left">
        ${s?`
          <button class="btn-sota danger" id="delete-contact-btn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete
          </button>
        `:""}
      </div>
      <div class="footer-right">
        <button class="btn-sota secondary" id="cancel-contact-btn">Cancel</button>
        <button class="btn-sota primary" id="save-contact-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          ${s?"Save Changes":"Create Contact"}
        </button>
      </div>
    </div>
  `,n}async function XL(e,t){try{const[n,s,a,o,i,r]=await Promise.all([v.get(`/api/contacts/${t}/projects`).catch(()=>({data:{projects:[]}})),v.get(`/api/contacts/${t}/relationships`).catch(()=>({data:{relationships:[]}})),v.get(`/api/contacts/${t}/activity`).catch(()=>({data:{activities:[]}})),v.get("/api/role-templates").catch(()=>({data:{roles:[]}})),v.get("/api/projects").catch(()=>({data:{projects:[]}})),v.get("/api/timezones").catch(()=>({data:{timezones:[]}}))]);Go=n.data?.projects||[],ya=s.data?.relationships||[],Jc=a.data?.activities||[],Pa=o.data?.roles||[],Zi=i.data?.projects||[];const c=r.data?.timezones||[];ev(e,c),tv(e),nv(e),sv(e),s5(e),av(e)}catch(n){console.error("Failed to load contact data:",n)}}async function e5(e){try{Pa=(await v.get("/api/role-templates")).data?.roles||[],tv(e)}catch{Pa=[]}}async function t5(e){try{const n=(await v.get("/api/timezones")).data?.timezones||[];ev(e,n)}catch{}}async function n5(e){try{Zi=(await v.get("/api/projects")).data?.projects||[],nv(e)}catch{Zi=[]}}function ev(e,t){const n=e.querySelector("#contact-timezone");if(!n)return;const s=n.dataset.current||"",a={};for(const i of t){const r=i.code.includes("/")?i.code.split("/")[0]:"Other";a[r]||(a[r]=[]),a[r].push(i)}const o=Object.keys(a).sort();n.innerHTML=`
    <option value="">Select timezone...</option>
    ${o.map(i=>`
      <optgroup label="${i}">
        ${a[i].map(r=>`
          <option value="${Ke(r.code)}" ${s===r.code?"selected":""}>
            ${Ke(r.name||r.code)} (${r.utc_offset})
          </option>
        `).join("")}
      </optgroup>
    `).join("")}
  `}function tv(e){const t=e.querySelector("#contact-role"),n=e.querySelector("#contact-role-custom");if(!t)return;const s=Xg?.role,a=s&&!Pa.some(o=>o.display_name===s||o.name===s);t.innerHTML=`
    <option value="">-- Select role --</option>
    ${Pa.filter(o=>o.is_active).map(o=>`
      <option value="${Ke(o.display_name||o.name)}" ${s===o.display_name||s===o.name?"selected":""}>
        ${Ke(o.display_name||o.name)}
      </option>
    `).join("")}
    <option value="__custom__" ${a?"selected":""}>Custom role...</option>
  `,a&&n&&(n.classList.remove("hidden"),n.value=s),d(t,"change",()=>{const o=t.value==="__custom__";n.classList.toggle("hidden",!o),o&&n.focus()})}function nv(e){const t=e.querySelector("#projects-list");if(!t)return;if(Zi.length===0){t.innerHTML='<p class="contact-no-projects-hint">No projects available</p>';return}const n=new Set(Go.map(s=>s.id));t.innerHTML=Zi.map(s=>`
    <div class="project-item">
      <input type="checkbox" class="project-checkbox" name="contact-project" value="${s.id}" 
             ${n.has(s.id)?"checked":""}>
      <label>${Ke(s.name)}</label>
      ${Go.find(a=>a.id===s.id)?.is_primary?'<span class="primary-badge">Primary</span>':""}
    </div>
  `).join(""),e.querySelector("#projects-count").textContent=String(n.size)}function sv(e){const t=e.querySelector("#relations-list");if(t){if(ya.length===0){t.innerHTML=`
      <div class="activity-empty">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <p>No relationships yet</p>
      </div>
    `;return}t.innerHTML=ya.map(n=>{const s=n.to_contact,a=s?Ai(s.name):"?";return`
      <div class="relation-card" data-id="${n.id}">
        <div class="relation-avatar">
          ${s?.avatar_url?`<img src="${s.avatar_url}" alt="">`:a}
        </div>
        <div class="relation-info">
          <h4>${Ke(s?.name||"Unknown")}</h4>
          <p>${Ke(s?.organization||s?.role||"")}</p>
        </div>
        <span class="relation-type">${o5(n.relationship_type)}</span>
      </div>
    `}).join(""),e.querySelector("#relations-count").textContent=String(ya.length)}}function s5(e){const t=e.querySelector("#activity-timeline");if(t){if(Jc.length===0){t.innerHTML=`
      <div class="activity-empty">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No activity recorded yet</p>
      </div>
    `;return}t.innerHTML=Jc.map(n=>`
    <div class="activity-item ${n.activity_type}">
      <div class="activity-time">${r5(n.occurred_at)}</div>
      <div class="activity-content">${Ke(n.description)}</div>
    </div>
  `).join("")}}function av(e){const t=e.querySelector("#projects-count"),n=e.querySelector("#relations-count");t&&(t.textContent=String(Go.length)),n&&(n.textContent=String(ya.length))}function a5(e,t){const{mode:n,contact:s,onSave:a,onDelete:o}=t,i=n==="edit",r=e.querySelector("#close-contact-btn");r&&d(r,"click",()=>K(ms));const c=e.querySelector("#cancel-contact-btn");c&&d(c,"click",()=>K(ms));const l=e.querySelectorAll(".contact-tab-btn");l.forEach(y=>{d(y,"click",()=>{l.forEach(P=>P.classList.remove("active")),y.classList.add("active");const S=y.getAttribute("data-tab");e.querySelectorAll(".contact-section").forEach(P=>{P.classList.toggle("active",P.id===`section-${S}`)})})});const u=e.querySelector("#save-contact-btn");u&&d(u,"click",async()=>{const y=e.querySelector("#contact-form");if(!y.checkValidity()){y.reportValidity();return}const S=ie=>e.querySelector(`#${ie}`)?.value.trim()||"",P=e.querySelector("#contact-role"),j=e.querySelector("#contact-role-custom"),H=P.value==="__custom__"?j.value.trim():P.value,J=S("contact-tags"),B=J?J.split(",").map(ie=>ie.trim()).filter(Boolean):[],Z=S("contact-aliases"),O=Z?Z.split(",").map(ie=>ie.trim()).filter(Boolean):[],F={id:s?.id||`contact-${Date.now()}`,name:S("contact-name"),email:S("contact-email")||void 0,phone:S("contact-phone")||void 0,organization:S("contact-organization")||void 0,company:S("contact-organization")||void 0,role:H||void 0,department:S("contact-department")||void 0,linkedin:S("contact-linkedin")||void 0,location:S("contact-location")||void 0,timezone:S("contact-timezone")||void 0,photoUrl:S("contact-avatar-url")||void 0,avatarUrl:S("contact-avatar-url")||void 0,aliases:O.length>0?O:void 0,notes:S("contact-notes")||void 0,tags:B.length>0?B:void 0},ee=[];e.querySelectorAll('input[name="contact-project"]:checked').forEach(ie=>{ee.push(ie.value)}),u.disabled=!0,u.textContent="Saving...";try{let ie=s?.id;if(i)await v.put(`/api/contacts/${s.id}`,F),m.success("Contact updated");else{const oe=await v.post("/api/contacts",F);F.id=oe.data.id,ie=oe.data.id,m.success("Contact created")}if(ie&&ee.length>=0)try{await v.post(`/api/contacts/${ie}/projects/sync`,{projectIds:ee})}catch(oe){console.warn("Failed to sync project associations:",oe)}a?.(F),K(ms)}catch{m.error("Failed to save contact")}finally{u.disabled=!1,u.innerHTML=`
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          ${i?"Save Changes":"Create Contact"}
        `}});const p=e.querySelector("#delete-contact-btn");p&&i&&d(p,"click",async()=>{if(await xs(`Are you sure you want to delete "${s.name}"?`,{title:"Delete Contact",confirmText:"Delete",confirmClass:"btn-danger"}))try{await v.delete(`/api/contacts/${s.id}`),m.success("Contact deleted"),o?.(s.id),K(ms)}catch{m.error("Failed to delete contact")}});const g=e.querySelector("#enrich-ai-btn");g&&i&&d(g,"click",async()=>{m.info("AI enrichment is processing...");try{await v.post(`/api/contacts/${s.id}/enrich`),m.success("Contact enriched! Refreshing..."),K(ms);const y=await v.get(`/api/contacts/${s.id}`);zn({...t,contact:y.data.contact})}catch{m.error("AI enrichment failed")}});const f=e.querySelector("#add-relation-btn");f&&s?.id&&d(f,"click",()=>{i5(e,s.id)});const h=e.querySelector("#contact-name"),k=e.querySelector("#contact-organization"),C=e.querySelector("#header-contact-name"),x=e.querySelector("#header-contact-org");h&&C&&d(h,"input",()=>{C.textContent=h.value||"New Contact";const y=e.querySelector(".contact-avatar-large");if(y&&!y.querySelector("img")){const S=y.querySelector("span");S&&(S.textContent=Ai(h.value||"?"))}}),k&&x&&d(k,"input",()=>{x.textContent=k.value||"Add organization"});const $=e.querySelector("#contact-avatar-url"),w=e.querySelector(".contact-avatar-large");$&&w&&d($,"input",()=>{const y=$.value.trim();if(y){const S=new Image;S.onload=()=>{w.innerHTML=`
            <img src="${y}" alt="">
            <div class="avatar-upload-hint">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
          `},S.onerror=()=>{const P=e.querySelector("#contact-name")?.value||"?";w.innerHTML=`
            <span>${Ai(P)}</span>
            <div class="avatar-upload-hint">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
          `},S.src=y}else{const S=e.querySelector("#contact-name")?.value||"?";w.innerHTML=`
          <span>${Ai(S)}</span>
          <div class="avatar-upload-hint">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
        `}})}async function i5(e,t,n){let s=[];try{s=((await v.get("/api/contacts")).data?.contacts||[]).filter(p=>p.id!==t)}catch{m.error("Failed to load contacts");return}if(s.length===0){m.info("No other contacts available to create a relationship");return}const a=b("div",{className:"relation-dialog-overlay"});a.innerHTML=`
    <style>
      .relation-dialog-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .relation-dialog {
        background: var(--bg-primary);
        border-radius: 16px;
        padding: 24px;
        width: 400px;
        max-width: 90vw;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        animation: slideUp 0.2s ease;
      }
      
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .relation-dialog h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .relation-dialog h3 svg {
        width: 22px;
        height: 22px;
        color: #e11d48;
      }
      
      .relation-dialog-field {
        margin-bottom: 16px;
      }
      
      .relation-dialog-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }
      
      .relation-dialog-field select {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
      }
      
      .relation-dialog-field select:focus {
        outline: none;
        border-color: #e11d48;
      }
      
      .relation-dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 24px;
      }
      
      .relation-dialog-actions button {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .relation-dialog-actions .cancel-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }
      
      .relation-dialog-actions .cancel-btn:hover {
        background: var(--bg-tertiary);
      }
      
      .relation-dialog-actions .save-btn {
        background: linear-gradient(135deg, #e11d48, #be123c);
        border: none;
        color: white;
      }
      
      .relation-dialog-actions .save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }
      
      .relation-dialog-actions .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
    </style>
    
    <div class="relation-dialog">
      <h3>
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        Add Relationship
      </h3>
      
      <div class="relation-dialog-field">
        <label>Related Contact</label>
        <select id="rel-contact-select">
          <option value="">-- Select contact --</option>
          ${s.map(u=>`
            <option value="${u.id}">${Ke(u.name)}${u.organization?` (${Ke(u.organization)})`:""}</option>
          `).join("")}
        </select>
      </div>
      
      <div class="relation-dialog-field">
        <label>Relationship Type</label>
        <select id="rel-type-select">
          <option value="">-- Select type --</option>
          <option value="reports_to">Reports to</option>
          <option value="manages">Manages</option>
          <option value="works_with">Works with</option>
          <option value="knows">Knows</option>
          <option value="referred_by">Referred by</option>
        </select>
      </div>
      
      <div class="relation-dialog-actions">
        <button class="cancel-btn" id="rel-cancel-btn">Cancel</button>
        <button class="save-btn" id="rel-save-btn">Add Relationship</button>
      </div>
    </div>
  `,document.body.appendChild(a);const o=a.querySelector("#rel-cancel-btn"),i=a.querySelector("#rel-save-btn"),r=a.querySelector("#rel-contact-select"),c=a.querySelector("#rel-type-select"),l=()=>a.remove();d(o,"click",l),d(a,"click",u=>{u.target===a&&l()}),d(i,"click",async()=>{const u=r.value,p=c.value;if(!u||!p){m.error("Please select both a contact and relationship type");return}i.disabled=!0,i.textContent="Saving...";try{await v.post(`/api/contacts/${t}/relationships`,{toContactId:u,type:p}),m.success("Relationship added"),l(),ya=(await v.get(`/api/contacts/${t}/relationships`)).data?.relationships||[],sv(e),av(e)}catch(g){const f=g instanceof Error?g.message:"Failed to add relationship";m.error(f),i.disabled=!1,i.textContent="Add Relationship"}})}function Ai(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)||"?"}function Ke(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function o5(e){return{reports_to:"Reports to",manages:"Manages",works_with:"Works with",knows:"Knows",referred_by:"Referred by"}[e]||e.replace(/_/g," ")}function r5(e){const t=new Date(e),s=new Date().getTime()-t.getTime(),a=Math.floor(s/(1e3*60*60*24));return a===0?"Today":a===1?"Yesterday":a<7?`${a} days ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}const ai="team-modal";let sa=[];async function Zo(e){const{projectId:t,onInvite:n,onRemove:s,onRoleChange:a}=e,o=document.querySelector(`[data-modal-id="${ai}"]`);o&&o.remove();const i=b("div",{className:"team-modal-content"});i.innerHTML='<div class="loading">Loading team members...</div>';const r=b("div",{className:"modal-footer"}),c=b("button",{className:"btn btn-primary",textContent:"Invite Member"}),l=b("button",{className:"btn btn-secondary",textContent:"Close"});d(l,"click",()=>K(ai)),d(c,"click",()=>{K(ai),n?.()}),r.appendChild(l),r.appendChild(c);const u=Pe({id:ai,title:"Team Members",content:i,size:"lg",footer:r});document.body.appendChild(u),De(ai);try{sa=(await v.get(`/api/projects/${t}/members`)).data,iv(i,e)}catch{i.innerHTML='<div class="error">Failed to load team members</div>'}}function iv(e,t){if(sa.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No team members yet</p>
        <p class="text-muted">Invite members to collaborate on this project</p>
      </div>
    `;return}e.innerHTML=`
    <div class="team-list">
      ${sa.map(n=>c5(n)).join("")}
    </div>
  `,e.querySelectorAll(".member-card").forEach(n=>{const s=n.getAttribute("data-member-id");if(!s)return;const a=sa.find(r=>r.id===s);if(!a)return;const o=n.querySelector(".role-select");o&&d(o,"change",async()=>{const r=o.value;try{await v.patch(`/api/projects/${t.projectId}/members/${s}`,{role:r}),a.role=r,m.success("Role updated"),t.onRoleChange?.(s,r)}catch{o.value=a.role}});const i=n.querySelector(".btn-remove");i&&d(i,"click",async()=>{const{confirm:r}=await xe(async()=>{const{confirm:l}=await Promise.resolve().then(()=>In);return{confirm:l}},void 0);if(await r(`Remove ${a.name} from this project?`,{title:"Remove Member",confirmText:"Remove",confirmClass:"btn-danger"}))try{await v.delete(`/api/projects/${t.projectId}/members/${s}`),sa=sa.filter(l=>l.id!==s),iv(e,t),m.success("Member removed"),t.onRemove?.(s)}catch{}})})}function c5(e){const t=e.name.split(" ").map(s=>s[0]).join("").toUpperCase().slice(0,2),n=e.role==="superadmin";return`
    <div class="member-card" data-member-id="${e.id}">
      <div class="member-avatar">
        ${e.avatarUrl?`<img src="${e.avatarUrl}" alt="${ic(e.name)}">`:t}
      </div>
      <div class="member-info">
        <div class="member-name">${ic(e.name)}</div>
        <div class="member-email">${ic(e.email)}</div>
      </div>
      <div class="member-role">
        ${n?'<span class="role-badge superadmin">Owner</span>':`<select class="role-select form-control">
              <option value="admin" ${e.role==="admin"?"selected":""}>Admin</option>
              <option value="member" ${e.role==="member"?"selected":""}>Member</option>
            </select>`}
      </div>
      <div class="member-actions">
        ${n?"":'<button class="btn btn-sm btn-danger btn-remove" title="Remove member">‚úï</button>'}
      </div>
    </div>
  `}function ic(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ds="invite-modal";let Yc=[];function Ql(e){const{projectId:t,onInviteSent:n}=e,s=document.querySelector(`[data-modal-id="${Ds}"]`);s&&s.remove();const a=b("div",{className:"invite-modal-content"});a.innerHTML=`
    <style>
      .invite-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color, #e2e8f0);
      }
      
      .invite-tab-btn {
        flex: 1;
        padding: 12px 16px;
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary, #64748b);
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }
      
      .invite-tab-btn:hover {
        color: var(--text-primary, #1e293b);
      }
      
      .invite-tab-btn.active {
        color: #e11d48;
      }
      
      .invite-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e11d48;
      }
      
      .invite-tab-content {
        display: none;
      }
      
      .invite-tab-content.active {
        display: block;
      }
      
      .contacts-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        margin-bottom: 16px;
      }
      
      .contact-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid var(--border-color, #e2e8f0);
      }
      
      .contact-option:last-child {
        border-bottom: none;
      }
      
      .contact-option:hover {
        background: var(--bg-secondary, #f8fafc);
      }
      
      .contact-option.selected {
        background: linear-gradient(135deg, rgba(225,29,72,0.08) 0%, rgba(225,29,72,0.04) 100%);
      }
      
      .contact-option input[type="radio"] {
        display: none;
      }
      
      .contact-option .radio-circle {
        width: 18px;
        height: 18px;
        border: 2px solid var(--border-color, #cbd5e1);
        border-radius: 50%;
        flex-shrink: 0;
        position: relative;
        transition: all 0.2s;
      }
      
      .contact-option.selected .radio-circle {
        border-color: #e11d48;
      }
      
      .contact-option.selected .radio-circle::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 8px;
        height: 8px;
        background: #e11d48;
        border-radius: 50%;
      }
      
      .contact-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
        overflow: hidden;
      }
      
      .contact-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      
      .contact-name {
        font-weight: 500;
        color: var(--text-primary, #1e293b);
        margin-bottom: 2px;
      }
      
      .contact-email {
        font-size: 12px;
        color: var(--text-secondary, #64748b);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .no-contacts-msg {
        padding: 24px;
        text-align: center;
        color: var(--text-secondary, #64748b);
      }
      
      .email-status {
        margin-top: 8px;
        padding: 8px 12px;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        font-size: 12px;
        color: #166534;
        display: none;
      }
      
      .email-status.show {
        display: block;
      }
      
      .email-status.error {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }
    </style>
    
    <!-- Tabs -->
    <div class="invite-tabs">
      <button type="button" class="invite-tab-btn active" data-tab="new">
        New Email
      </button>
      <button type="button" class="invite-tab-btn" data-tab="contacts">
        Existing Contacts
      </button>
    </div>
    
    <!-- Tab: New Email -->
    <div class="invite-tab-content active" id="tab-new">
      <form id="invite-form" class="invite-form">
        <div class="form-group">
          <label for="invite-email">Email Address *</label>
          <input type="email" id="invite-email" required 
                 placeholder="colleague@example.com">
          <div class="form-hint">They will receive an email invitation to join this project</div>
        </div>
        
        <div class="form-group">
          <label for="invite-role">Access Level</label>
          <select id="invite-role">
            <option value="read">Viewer - Can view data only</option>
            <option value="write" selected>Member - Can view and edit data</option>
            <option value="admin">Admin - Can manage team and settings</option>
          </select>
          <div class="form-hint invite-form-hint">You can assign a project role after they join.</div>
        </div>
        
        <div class="form-group">
          <label for="invite-message">Personal Message (optional)</label>
          <textarea id="invite-message" rows="2" 
                    placeholder="Add a personal note to the invitation..."></textarea>
        </div>
        
        <div class="email-status" id="email-status"></div>
      </form>
    </div>
    
    <!-- Tab: Existing Contacts -->
    <div class="invite-tab-content" id="tab-contacts">
      <div id="contacts-list" class="contacts-list">
        <div class="no-contacts-msg">Loading contacts...</div>
      </div>
      
      <div class="form-group">
        <label for="invite-role-contact">Access Level</label>
        <select id="invite-role-contact">
          <option value="read">Viewer - Can view data only</option>
          <option value="write" selected>Member - Can view and edit data</option>
          <option value="admin">Admin - Can manage team and settings</option>
        </select>
      </div>
      
      <div class="add-options">
        <button type="button" id="btn-add-direct" class="btn btn-primary invite-btn-flex">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="invite-btn-icon">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Add to Team
        </button>
        <button type="button" id="btn-send-invite" class="btn btn-secondary invite-btn-flex">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="invite-btn-icon">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          Send Invitation
        </button>
      </div>
      <div class="form-hint invite-form-hint-sm">
        <strong>Add to Team:</strong> Adds contact as team member directly (no email sent)<br>
        <strong>Send Invitation:</strong> Sends an email invitation to join
      </div>
      
      <div class="email-status" id="email-status-contact"></div>
    </div>
    
    <div class="invite-link-section">
      <h4 class="invite-link-title">Or share invite link</h4>
      <div class="input-group invite-input-group">
        <input type="text" id="invite-link" readonly 
               value="Generating link..." class="form-control invite-link-input">
        <button type="button" id="btn-copy-link" class="btn btn-secondary">Copy</button>
      </div>
    </div>
  `;let o="new",i=null;const r=b("div",{className:"modal-footer"}),c=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=b("button",{className:"btn btn-primary",textContent:"Send Invitation"});d(c,"click",()=>K(Ds)),d(l,"click",async()=>{if(o!=="new")return;const g=a.querySelector("#invite-form");if(!g.checkValidity()){g.reportValidity();return}const f=a.querySelector("#invite-email").value.trim(),h=a.querySelector("#invite-role").value,k=a.querySelector("#invite-message").value.trim();l.disabled=!0,l.textContent="Sending...";const C=a.querySelector("#email-status");try{(await v.post(`/api/projects/${t}/invites`,{email:f,role:h,message:k||void 0})).data.email_sent?(C.textContent=`‚úì Invitation email sent to ${f}`,C.classList.remove("error"),C.classList.add("show")):(C.textContent="Invitation created, but email could not be sent. Share the link manually.",C.classList.add("error","show")),m.success(`Invitation sent to ${f}`),n?.(f),setTimeout(()=>K(Ds),1500)}catch{C.textContent="Failed to create invitation",C.classList.add("error","show")}finally{l.disabled=!1,l.textContent="Send Invitation"}}),r.appendChild(c),r.appendChild(l),setTimeout(()=>{const g=a.querySelector("#btn-add-direct"),f=a.querySelector("#btn-send-invite"),h=a.querySelector("#email-status-contact");g&&d(g,"click",async()=>{if(!i){m.error("Please select a contact");return}const k=a.querySelector("#invite-role-contact").value;g.disabled=!0,g.innerHTML='<span class="spinner"></span> Adding...';try{await v.post(`/api/projects/${t}/members/add-contact`,{contact_id:i.id,role:k}),h.textContent=`‚úì ${i.name} added to team`,h.classList.remove("error"),h.classList.add("show"),m.success(`${i.name} added to team`),n?.(i.email||i.name),setTimeout(()=>K(Ds),1e3)}catch(C){const x=C?.response?.data?.error||"Failed to add member";h.textContent=x,h.classList.add("error","show"),m.error(x)}finally{g.disabled=!1,g.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="invite-btn-icon">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Add to Team
          `}}),f&&d(f,"click",async()=>{if(!i||!i.email){m.error("Please select a contact with an email address");return}const k=a.querySelector("#invite-role-contact").value;f.disabled=!0,f.innerHTML='<span class="spinner"></span> Sending...';try{(await v.post(`/api/projects/${t}/invites`,{email:i.email,role:k})).data.email_sent?(h.textContent=`‚úì Invitation email sent to ${i.email}`,h.classList.remove("error"),h.classList.add("show")):(h.textContent="Invitation created, but email could not be sent.",h.classList.add("error","show")),m.success(`Invitation sent to ${i.name}`),n?.(i.email),setTimeout(()=>K(Ds),1500)}catch{h.textContent="Failed to send invitation",h.classList.add("error","show")}finally{f.disabled=!1,f.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="invite-btn-icon">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            Send Invitation
          `}})},0);const u=Pe({id:Ds,title:"Invite Team Member",content:a,size:"md",footer:r});document.body.appendChild(u),De(Ds),l5(a,t);const p=a.querySelectorAll(".invite-tab-btn");p.forEach(g=>{d(g,"click",()=>{const f=g.getAttribute("data-tab")||"new";o=f,p.forEach(h=>h.classList.remove("active")),g.classList.add("active"),a.querySelectorAll(".invite-tab-content").forEach(h=>{h.classList.toggle("active",h.id===`tab-${f}`)})})}),u5(a,t,g=>{i=g}),setTimeout(()=>{const g=a.querySelector("#btn-copy-link");g&&d(g,"click",()=>{const f=a.querySelector("#invite-link");navigator.clipboard.writeText(f.value).then(()=>{m.success("Link copied to clipboard")}).catch(()=>{f.select(),document.execCommand("copy"),m.success("Link copied")})})},0)}async function l5(e,t){const n=e.querySelector("#invite-link");try{const s=await v.get(`/api/projects/${t}/invites/link`);n.value=s.data.link||s.data.invite_url||"Link not available"}catch{try{const s=await v.post(`/api/projects/${t}/invites`,{email:"",role:"member",generate_link_only:!0});s.data.invite_url?n.value=s.data.invite_url:n.value="Use email invitation instead"}catch{n.value="Use email invitation instead"}}}async function d5(e){try{Yc=(await v.get(`/api/projects/${e}/members`)).data.members||[]}catch(t){console.warn("[InviteModal] Failed to load project members:",t),Yc=[]}}async function u5(e,t,n){const s=e.querySelector("#contacts-list");if(s)try{await d5(t);const o=(await v.get("/api/contacts")).data.contacts||[],i=new Set(Yc.filter(l=>l.linked_contact_id).map(l=>l.linked_contact_id)),r=o.filter(l=>!i.has(l.id));if(r.length===0){s.innerHTML=`
        <div class="no-contacts-msg">
          ${i.size>0?"All contacts are already team members.":"No contacts found."}
          <br>
          <small class="invite-no-contacts-hint">Add contacts in the Contacts panel.</small>
        </div>
      `;return}s.innerHTML=r.map(l=>{const u=l.name.split(" ").map(h=>h[0]).join("").substring(0,2).toUpperCase(),p=l.avatar_url||l.photo_url,g=!!l.email,f=[l.email,l.organization].filter(Boolean).join(" ‚Ä¢ ")||l.role||"No email";return`
        <label class="contact-option" data-id="${l.id}" data-has-email="${g}">
          <input type="radio" name="contact-select" value="${l.id}">
          <span class="radio-circle"></span>
          <div class="contact-avatar">
            ${p?`<img src="${p}" alt="${oc(l.name)}">`:u}
          </div>
          <div class="contact-info">
            <div class="contact-name">${oc(l.name)}</div>
            <div class="contact-email">${oc(f)}${g?"":' <span class="contact-no-email">(no email)</span>'}</div>
          </div>
        </label>
      `}).join("");const c=s.querySelectorAll(".contact-option");c.forEach(l=>{d(l,"click",()=>{c.forEach(g=>g.classList.remove("selected")),l.classList.add("selected");const u=l.getAttribute("data-id"),p=r.find(g=>g.id===u)||null;n(p)})})}catch{s.innerHTML=`
      <div class="no-contacts-msg">
        Failed to load contacts
      </div>
    `}}function oc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const p5=Object.freeze(Object.defineProperty({__proto__:null,showInviteModal:Ql},Symbol.toStringTag,{value:"Module"})),ls="role-modal",m5=["view:dashboard","view:chat","view:sot","view:contacts","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","manage:team","manage:settings","manage:roles","delete:data","export:data"];function ov(e){const{mode:t,role:n,availablePermissions:s=m5,onSave:a,onDelete:o}=e,i=t==="edit"&&n?.id,r=t==="view",c=document.querySelector(`[data-modal-id="${ls}"]`);c&&c.remove();const l=b("div",{className:"role-modal-content"});if(r&&n)l.innerHTML=`
      <div class="role-view">
        <div class="role-header-info">
          <div class="role-color-badge" style="--role-color: ${n.color||"#e94560"}"></div>
          <div>
            <h3>${ep(n.name)}</h3>
            ${n.description?`<p class="text-muted">${ep(n.description)}</p>`:""}
          </div>
        </div>
        
        <div class="role-permissions">
          <h4>Permissions (${n.permissions.length})</h4>
          <div class="permissions-list">
            ${n.permissions.map(g=>`
              <span class="permission-tag">${Xu(g)}</span>
            `).join("")}
          </div>
        </div>
        
        ${n.isDefault?'<p class="text-muted"><em>This is a system role and cannot be modified.</em></p>':""}
      </div>
    `;else{const g=n?.permissions||[];l.innerHTML=`
      <form id="role-form" class="role-form">
        <div class="form-row">
          <div class="form-group role-form-flex-1">
            <label for="role-name">Role Name *</label>
            <input type="text" id="role-name" required 
                   value="${n?.name||""}" 
                   placeholder="e.g., Project Manager">
          </div>
          <div class="form-group role-form-w-80">
            <label for="role-color">Color</label>
            <input type="color" id="role-color" 
                   value="${n?.color||"#e94560"}">
          </div>
        </div>
        
        <div class="form-group">
          <label for="role-description">Description</label>
          <textarea id="role-description" rows="2" 
                    placeholder="Brief description of this role...">${n?.description||""}</textarea>
        </div>
        
        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-grid">
            ${s.map(f=>`
              <label class="permission-checkbox">
                <input type="checkbox" name="permissions" value="${f}" 
                       ${g.includes(f)?"checked":""}>
                <span>${Xu(f)}</span>
              </label>
            `).join("")}
          </div>
        </div>
        
        <div class="form-group">
          <button type="button" class="btn btn-sm btn-secondary" data-action="select-all">Select All</button>
          <button type="button" class="btn btn-sm btn-secondary" data-action="select-none">Select None</button>
        </div>
      </form>
    `,setTimeout(()=>{const f=l.querySelector('[data-action="select-all"]'),h=l.querySelector('[data-action="select-none"]');f&&d(f,"click",()=>{l.querySelectorAll('[name="permissions"]').forEach(k=>{k.checked=!0})}),h&&d(h,"click",()=>{l.querySelectorAll('[name="permissions"]').forEach(k=>{k.checked=!1})})},0)}const u=b("div",{className:"modal-footer"});if(r){const g=b("button",{className:"btn btn-primary",textContent:"Edit"}),f=b("button",{className:"btn btn-secondary",textContent:"Close"});d(f,"click",()=>K(ls)),n?.isDefault||(d(g,"click",()=>{K(ls),ov({...e,mode:"edit"})}),u.appendChild(g)),u.appendChild(f)}else{const g=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),f=b("button",{className:"btn btn-primary",textContent:i?"Save Changes":"Create Role"});if(d(g,"click",()=>K(ls)),d(f,"click",async()=>{const h=l.querySelector("#role-form");if(!h.checkValidity()){h.reportValidity();return}const k=l.querySelector("#role-name").value.trim(),C=l.querySelector("#role-description").value.trim(),x=l.querySelector("#role-color").value,$=[];l.querySelectorAll('[name="permissions"]:checked').forEach(y=>{$.push(y.value)});const w={id:n?.id||`role-${Date.now()}`,name:k,description:C||void 0,color:x,permissions:$};f.disabled=!0,f.textContent="Saving...";try{if(i)await v.put(`/api/roles/${n.id}`,w),m.success("Role updated");else{const y=await v.post("/api/roles",w);w.id=y.data.id,m.success("Role created")}a?.(w),K(ls)}catch{}finally{f.disabled=!1,f.textContent=i?"Save Changes":"Create Role"}}),i&&!n?.isDefault){const h=b("button",{className:"btn btn-danger",textContent:"Delete"});d(h,"click",async()=>{const{confirm:k}=await xe(async()=>{const{confirm:x}=await Promise.resolve().then(()=>In);return{confirm:x}},void 0);if(await k(`Are you sure you want to delete the "${n.name}" role?`,{title:"Delete Role",confirmText:"Delete",confirmClass:"btn-danger"}))try{await v.delete(`/api/roles/${n.id}`),m.success("Role deleted"),o?.(n.id),K(ls)}catch{}}),u.appendChild(h)}u.appendChild(g),u.appendChild(f)}const p=Pe({id:ls,title:r?"Role Details":i?"Edit Role":"New Role",content:l,size:"md",footer:u});document.body.appendChild(p),De(ls)}function Xu(e){return e.replace(":",": ").split(/[_:]/).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function ep(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const ii="export-modal";function g5(e={}){const{defaultFormat:t="json",defaultScope:n="all"}=e,s=document.querySelector(`[data-modal-id="${ii}"]`);s&&s.remove();const a=b("div",{className:"export-modal-content"});a.innerHTML=`
    <div class="export-options">
      <div class="form-group">
        <label>What to Export</label>
        <div class="scope-options">
          <label class="radio-card ${n==="all"?"selected":""}">
            <input type="radio" name="export-scope" value="all" ${n==="all"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üì¶</span>
              <span class="label">Everything</span>
            </div>
          </label>
          <label class="radio-card ${n==="questions"?"selected":""}">
            <input type="radio" name="export-scope" value="questions" ${n==="questions"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">‚ùì</span>
              <span class="label">Questions</span>
            </div>
          </label>
          <label class="radio-card ${n==="risks"?"selected":""}">
            <input type="radio" name="export-scope" value="risks" ${n==="risks"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">‚ö†Ô∏è</span>
              <span class="label">Risks</span>
            </div>
          </label>
          <label class="radio-card ${n==="actions"?"selected":""}">
            <input type="radio" name="export-scope" value="actions" ${n==="actions"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">‚úÖ</span>
              <span class="label">Actions</span>
            </div>
          </label>
          <label class="radio-card ${n==="decisions"?"selected":""}">
            <input type="radio" name="export-scope" value="decisions" ${n==="decisions"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üéØ</span>
              <span class="label">Decisions</span>
            </div>
          </label>
          <label class="radio-card ${n==="contacts"?"selected":""}">
            <input type="radio" name="export-scope" value="contacts" ${n==="contacts"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üë•</span>
              <span class="label">Contacts</span>
            </div>
          </label>
        </div>
      </div>
      
      <div class="form-group">
        <label>Format</label>
        <div class="format-options">
          <label class="radio-card ${t==="json"?"selected":""}">
            <input type="radio" name="export-format" value="json" ${t==="json"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">{ }</span>
              <span class="label">JSON</span>
              <span class="hint">Full data backup</span>
            </div>
          </label>
          <label class="radio-card ${t==="csv"?"selected":""}">
            <input type="radio" name="export-format" value="csv" ${t==="csv"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üìä</span>
              <span class="label">CSV</span>
              <span class="hint">Spreadsheet</span>
            </div>
          </label>
          <label class="radio-card ${t==="markdown"?"selected":""}">
            <input type="radio" name="export-format" value="markdown" ${t==="markdown"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üìù</span>
              <span class="label">Markdown</span>
              <span class="hint">Documentation</span>
            </div>
          </label>
          <label class="radio-card ${t==="pdf"?"selected":""}">
            <input type="radio" name="export-format" value="pdf" ${t==="pdf"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üìÑ</span>
              <span class="label">PDF</span>
              <span class="hint">Report</span>
            </div>
          </label>
        </div>
      </div>
    </div>
  `,a.querySelectorAll(".radio-card input").forEach(l=>{d(l,"change",()=>{const u=l.name;a.querySelectorAll(`[name="${u}"]`).forEach(p=>{const g=p.closest(".radio-card");g&&(p.checked?bn(g,"selected"):ss(g,"selected"))})})});const o=b("div",{className:"modal-footer"}),i=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),r=b("button",{className:"btn btn-primary",textContent:"Export"});d(i,"click",()=>K(ii)),d(r,"click",async()=>{const l=a.querySelector('[name="export-format"]:checked')?.value,u=a.querySelector('[name="export-scope"]:checked')?.value;r.disabled=!0,r.textContent="Exporting...";try{await v5(l,u),e.onExport?.(l,u),K(ii)}catch{}finally{r.disabled=!1,r.textContent="Export"}}),o.appendChild(i),o.appendChild(r);const c=Pe({id:ii,title:"Export Data",content:a,size:"md",footer:o});document.body.appendChild(c),De(ii)}async function v5(e,t){const n=N.getState().currentProjectId;if(!n){m.error("No project selected");return}try{const s=await v.get(`/api/projects/${n}/export`,{headers:{Accept:f5(e)}}),a=b5(s.data,e),o=URL.createObjectURL(a),i=document.createElement("a");i.href=o,i.download=`godmode-${t}-${new Date().toISOString().split("T")[0]}.${h5(e)}`,i.click(),URL.revokeObjectURL(o),m.success("Export completed")}catch{throw m.error("Export failed"),new Error("Export failed")}}function f5(e){switch(e){case"json":return"application/json";case"csv":return"text/csv";case"markdown":return"text/markdown";case"pdf":return"application/pdf"}}function h5(e){switch(e){case"json":return"json";case"csv":return"csv";case"markdown":return"md";case"pdf":return"pdf"}}function b5(e,t){let n,s;switch(t){case"json":n=JSON.stringify(e,null,2),s="application/json";break;case"csv":n=typeof e=="string"?e:JSON.stringify(e),s="text/csv";break;case"markdown":n=typeof e=="string"?e:JSON.stringify(e,null,2),s="text/markdown";break;case"pdf":n=typeof e=="string"?e:"",s="application/pdf";break}return new Blob([n],{type:s})}const oi="file-upload-modal";let Vt=[],ri=!1,rc=[],cc=[],la="",da="";function Jl(e={}){const{accept:t="*/*",multiple:n=!0,maxSize:s=50*1024*1024,onUpload:a,onComplete:o}=e;Vt=[],ri=!1,la="",da="";const i=document.querySelector(`[data-modal-id="${oi}"]`);i&&i.remove();const r=b("div",{className:"file-upload-modal-content"});function c(){const $=rc.map(y=>`<option value="${y.id}" ${y.id===la?"selected":""}>${Wo(y.name)}</option>`).join(""),w=cc.map(y=>`<option value="${y.id}" ${y.id===da?"selected":""}>${Wo((y.content||y.task||String(y.id)).slice(0,60))}${(y.content||y.task||"").length>60?"‚Ä¶":""}</option>`).join("");r.innerHTML=`
      <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-icon">üìÅ</div>
        <div class="drop-zone-text">
          <strong>Drop files here</strong> or click to browse
        </div>
        <div class="drop-zone-hint">
          ${n?"You can upload multiple files":"Single file only"}
          ${s?` ‚Ä¢ Max ${Ji(s)}`:""}
        </div>
        <input type="file" id="file-input" ${t!=="*/*"?`accept="${t}"`:""} ${n?"multiple":""} hidden>
      </div>

      <div class="upload-association" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color, #e2e8f0);">
        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Associate with (optional)</label>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 140px;">
            <select id="upload-sprint-select" class="form-select" style="width: 100%;">
              <option value="">No sprint</option>
              ${$}
            </select>
            <span class="form-hint" style="font-size: 0.75rem; color: var(--text-tertiary);">Sprint</span>
          </div>
          <div style="flex: 1; min-width: 180px;">
            <select id="upload-action-select" class="form-select" style="width: 100%;">
              <option value="">No task</option>
              ${w}
            </select>
            <span class="form-hint" style="font-size: 0.75rem; color: var(--text-tertiary);">Task</span>
          </div>
        </div>
      </div>
      
      ${Vt.length>0?`
        <div class="upload-list">
          <h4>Files (${Vt.length})</h4>
          ${Vt.map(y=>y5(y)).join("")}
        </div>
      `:""}
    `,l(),u(),f()}function l(){const $=r.querySelector("#drop-zone"),w=r.querySelector("#file-input");!$||!w||(d($,"click",()=>w.click()),d(w,"change",()=>{w.files&&(tp(Array.from(w.files),s),c())}),d($,"dragover",y=>{y.preventDefault(),bn($,"drag-over")}),d($,"dragleave",()=>{ss($,"drag-over")}),d($,"drop",y=>{y.preventDefault(),ss($,"drag-over");const S=y.dataTransfer;S?.files&&(tp(Array.from(S.files),s),c())}))}function u(){r.querySelectorAll('[data-action="remove"]').forEach($=>{d($,"click",()=>{const w=$.getAttribute("data-file-id");w&&(Vt=Vt.filter(y=>y.id!==w),c())})})}async function p(){try{rc=await Xi()}catch{rc=[]}}async function g($){try{cc=await $l(void 0,$||void 0)}catch{cc=[]}}function f(){const $=r.querySelector("#upload-sprint-select"),w=r.querySelector("#upload-action-select");$&&d($,"change",async()=>{la=$.value||"",da="",await g(la),c()}),w&&d(w,"change",()=>{da=w.value||""})}c(),p().then(()=>c());const h=b("div",{className:"modal-footer"}),k=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),C=b("button",{className:"btn btn-primary",textContent:"Upload"});d(k,"click",()=>{if(ri){m.warning("Upload in progress");return}K(oi)}),d(C,"click",async()=>{if(Vt.length===0){m.warning("No files selected");return}if(!ri){ri=!0,C.disabled=!0,C.textContent="Uploading...";try{if(a){const $=Vt.map(w=>w.file);await a($),Vt.forEach(w=>{w.status="completed",w.progress=100})}else await w5(Vt,c);m.success("Upload complete"),o?.(Vt),K(oi)}catch{m.error("Upload failed")}finally{ri=!1,C.disabled=!1,C.textContent="Upload",c()}}}),h.appendChild(k),h.appendChild(C);const x=Pe({id:oi,title:"Upload Files",content:r,size:"md",footer:h});document.body.appendChild(x),De(oi)}function tp(e,t){e.forEach(n=>{if(n.size>t){m.error(`${n.name} exceeds max size`);return}Vt.some(s=>s.file.name===n.name&&s.file.size===n.size)||Vt.push({id:`file-${Date.now()}-${Math.random().toString(36).slice(2)}`,file:n,progress:0,status:"pending"})})}function y5(e){const t=k5(e.file.type);return`
    <div class="upload-item ${e.status}" data-file-id="${e.id}">
      <span class="file-icon">${t}</span>
      <div class="file-info">
        <div class="file-name">${Wo(e.file.name)}</div>
        <div class="file-size">${Ji(e.file.size)}</div>
        ${e.status==="uploading"?`
          <div class="progress-bar">
            <div class="progress-fill" style="--progress: ${e.progress}"></div>
          </div>
        `:""}
        ${e.error?`<div class="file-error">${Wo(e.error)}</div>`:""}
      </div>
      <div class="file-status">
        ${e.status==="completed"?"‚úì":""}
        ${e.status==="error"?"‚úï":""}
        ${e.status==="pending"?`
          <button class="btn-sm btn-danger" data-action="remove" data-file-id="${e.id}">√ó</button>
        `:""}
      </div>
    </div>
  `}async function w5(e,t){for(const n of e){n.status="uploading",t();try{const s=new FormData;s.append("file",n.file),la&&s.append("sprintId",la),da&&s.append("actionId",da);const a=new XMLHttpRequest;await new Promise((o,i)=>{a.upload.addEventListener("progress",r=>{r.lengthComputable&&(n.progress=Math.round(r.loaded/r.total*100),t())}),a.addEventListener("load",()=>{a.status>=200&&a.status<300?(n.status="completed",n.progress=100,o()):(n.status="error",n.error="Upload failed",i(new Error("Upload failed")))}),a.addEventListener("error",()=>{n.status="error",n.error="Network error",i(new Error("Network error"))}),a.open("POST","/api/upload"),a.send(s)})}catch{n.status="error"}t()}}function k5(e){return e.startsWith("image/")?"üñºÔ∏è":e.startsWith("video/")?"üé•":e.startsWith("audio/")?"üéµ":e.includes("pdf")?"üìÑ":e.includes("word")||e.includes("document")?"üìù":e.includes("sheet")||e.includes("excel")?"üìä":e.includes("presentation")||e.includes("powerpoint")?"üìΩÔ∏è":e.includes("zip")||e.includes("archive")?"üì¶":e.includes("text")?"üìÉ":"üìÅ"}function Wo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const rv=Object.freeze(Object.defineProperty({__proto__:null,showFileUploadModal:Jl},Symbol.toStringTag,{value:"Module"})),vo="developer-modal";function Yl(){const e=document.querySelector(`[data-modal-id="${vo}"]`);e&&e.remove();const t=b("div",{className:"developer-modal-content"});let n="info";function s(){t.innerHTML=`
      <div class="dev-tabs">
        <button class="dev-tab ${n==="info"?"active":""}" data-tab="info">Info</button>
        <button class="dev-tab ${n==="logs"?"active":""}" data-tab="logs">Logs</button>
        <button class="dev-tab ${n==="cache"?"active":""}" data-tab="cache">Cache</button>
        <button class="dev-tab ${n==="api"?"active":""}" data-tab="api">API Test</button>
      </div>
      <div class="dev-content">
        ${x5(n)}
      </div>
    `,t.querySelectorAll(".dev-tab").forEach(r=>{d(r,"click",()=>{n=r.getAttribute("data-tab"),s()})}),L5(t)}s();const a=b("div",{className:"modal-footer"}),o=b("button",{className:"btn btn-secondary",textContent:"Close"});d(o,"click",()=>K(vo)),a.appendChild(o);const i=Pe({id:vo,title:"Developer Tools",content:t,size:"lg",footer:a});document.body.appendChild(i),De(vo)}function x5(e){switch(e){case"info":return $5();case"logs":return S5();case"cache":return C5();case"api":return _5()}}function $5(){const e=N.getState(),t=ce.getState(),n=Ie.getState();return`
    <div class="dev-section">
      <h4>Application State</h4>
      <pre class="code-block">${JSON.stringify({projectId:e.currentProjectId,user:e.currentUser?.email,authConfigured:e.authConfigured},null,2)}</pre>
    </div>
    
    <div class="dev-section">
      <h4>Data Counts</h4>
      <table class="dev-table">
        <tr><td>Questions</td><td>${t.questions.length}</td></tr>
        <tr><td>Risks</td><td>${t.risks.length}</td></tr>
        <tr><td>Actions</td><td>${t.actions.length}</td></tr>
        <tr><td>Decisions</td><td>${t.decisions.length}</td></tr>
        <tr><td>Contacts</td><td>${t.contacts.length}</td></tr>
        <tr><td>Chat Messages</td><td>${t.chatHistory.length}</td></tr>
      </table>
    </div>
    
    <div class="dev-section">
      <h4>UI State</h4>
      <pre class="code-block">${JSON.stringify({currentTab:n.currentTab,sotView:n.sotCurrentView,sidebarOpen:n.sidebarOpen,modalOpen:n.modalOpen},null,2)}</pre>
    </div>
    
    <div class="dev-section">
      <h4>Environment</h4>
      <table class="dev-table">
        <tr><td>User Agent</td><td>${navigator.userAgent.slice(0,50)}...</td></tr>
        <tr><td>Screen</td><td>${window.innerWidth}x${window.innerHeight}</td></tr>
        <tr><td>Theme</td><td>${document.documentElement.getAttribute("data-theme")}</td></tr>
      </table>
    </div>
  `}function S5(){return`
    <div class="dev-section">
      <h4>Console Logs</h4>
      <p class="text-muted">Open browser DevTools (F12) to view console logs.</p>
      <div class="dev-actions">
        <button class="btn btn-secondary btn-sm" data-action="clear-console">Clear Console</button>
        <button class="btn btn-secondary btn-sm" data-action="log-state">Log State</button>
      </div>
    </div>
    
    <div class="dev-section">
      <h4>Performance</h4>
      <table class="dev-table">
        <tr><td>Page Load</td><td>${Math.round(performance.now())}ms</td></tr>
        <tr><td>Memory</td><td>${A5()}</td></tr>
      </table>
    </div>
  `}function C5(){const e=Object.keys(localStorage),t=e.reduce((n,s)=>n+(localStorage.getItem(s)?.length||0),0);return`
    <div class="dev-section">
      <h4>LocalStorage</h4>
      <p>Items: ${e.length} | Size: ${Xc(t*2)}</p>
      <div class="dev-actions">
        <button class="btn btn-danger btn-sm" data-action="clear-storage">Clear All Storage</button>
        <button class="btn btn-secondary btn-sm" data-action="export-storage">Export Storage</button>
      </div>
      <div class="storage-list">
        ${e.map(n=>`
          <div class="storage-item">
            <span class="storage-key">${n}</span>
            <span class="storage-size">${Xc((localStorage.getItem(n)?.length||0)*2)}</span>
            <button class="btn-sm btn-danger" data-action="delete-key" data-key="${n}">√ó</button>
          </div>
        `).join("")}
      </div>
    </div>
  `}function _5(){return`
    <div class="dev-section">
      <h4>API Test</h4>
      <div class="form-group">
        <label>Endpoint</label>
        <div class="input-group">
          <select id="api-method" class="form-control api-method-select">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input type="text" id="api-endpoint" class="form-control" value="/api/health" placeholder="/api/...">
        </div>
      </div>
      <div class="form-group">
        <label>Body (JSON)</label>
        <textarea id="api-body" class="form-control" rows="3" placeholder='{"key": "value"}'></textarea>
      </div>
      <button class="btn btn-primary" data-action="test-api">Send Request</button>
    </div>
    
    <div class="dev-section">
      <h4>Response</h4>
      <pre id="api-response" class="code-block">No request sent yet</pre>
    </div>
  `}function L5(e){e.querySelectorAll("[data-action]").forEach(t=>{const n=t.getAttribute("data-action");d(t,"click",async()=>{switch(n){case"clear-console":console.clear(),m.success("Console cleared");break;case"log-state":console.group("Application State"),console.log("App:",N.getState()),console.log("Data:",ce.getState()),console.log("UI:",Ie.getState()),console.groupEnd(),m.success("State logged to console");break;case"clear-storage":localStorage.clear(),m.success("Storage cleared"),location.reload();break;case"export-storage":const s={...localStorage},a=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),o=URL.createObjectURL(a),i=document.createElement("a");i.href=o,i.download="localstorage-backup.json",i.click(),m.success("Storage exported");break;case"delete-key":const r=t.getAttribute("data-key");r&&(localStorage.removeItem(r),m.success(`Removed: ${r}`),Yl());break;case"test-api":await T5(e);break}})})}async function T5(e){const t=e.querySelector("#api-method").value,n=e.querySelector("#api-endpoint").value,s=e.querySelector("#api-body").value,a=e.querySelector("#api-response");a.textContent="Loading...";try{const o={method:t};s&&t!=="GET"&&(o.body=s,o.headers={"Content-Type":"application/json"});const i=performance.now(),r=await at(n,o),c=Math.round(performance.now()-i),l=await r.json().catch(()=>r.text());a.textContent=`Status: ${r.status} (${c}ms)

${JSON.stringify(l,null,2)}`}catch(o){a.textContent=`Error: ${o instanceof Error?o.message:"Unknown error"}`}}function A5(){const e=performance;return e.memory?Xc(e.memory.usedJSHeapSize):"N/A"}function Xc(e){if(e===0)return"0 B";const t=1024,n=["B","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(1))+" "+n[s]}const fo="shortcuts-modal",M5=[{title:"General",shortcuts:[{keys:["Ctrl","Z"],description:"Undo last action"},{keys:["Ctrl","Shift","Z"],description:"Redo"},{keys:["Ctrl","S"],description:"Save current item"},{keys:["Esc"],description:"Close modal / Cancel"},{keys:["?"],description:"Show this help"}]},{title:"Navigation",shortcuts:[{keys:["Ctrl","1"],description:"Go to Dashboard"},{keys:["Ctrl","2"],description:"Go to Chat"},{keys:["Ctrl","3"],description:"Go to Source of Truth"},{keys:["Ctrl","4"],description:"Go to Timeline"},{keys:["Ctrl","5"],description:"Go to Contacts"}]},{title:"Actions",shortcuts:[{keys:["Ctrl","K"],description:"Quick search"},{keys:["Ctrl","N"],description:"New item"},{keys:["Ctrl","E"],description:"Export data"},{keys:["Ctrl","Shift","T"],description:"Toggle theme"}]},{title:"Chat",shortcuts:[{keys:["Enter"],description:"Send message"},{keys:["Shift","Enter"],description:"New line"},{keys:["‚Üë"],description:"Previous message"}]}];function cv(){const e=document.querySelector(`[data-modal-id="${fo}"]`);e&&e.remove();const t=b("div",{className:"shortcuts-modal-content"}),n=Qt.getAll();t.innerHTML=`
    <div class="shortcuts-grid">
      ${M5.map(i=>`
        <div class="shortcut-group">
          <h4>${i.title}</h4>
          <div class="shortcut-list">
            ${i.shortcuts.map(r=>`
              <div class="shortcut-item">
                <div class="shortcut-keys">
                  ${r.keys.map(c=>`<kbd>${c}</kbd>`).join(" + ")}
                </div>
                <div class="shortcut-desc">${r.description}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
    
    ${n.length>0?`
      <div class="shortcuts-custom">
        <h4>Active Shortcuts</h4>
        <div class="shortcut-list">
          ${n.map(i=>{const r=[];return i.ctrl&&r.push("Ctrl"),i.shift&&r.push("Shift"),i.alt&&r.push("Alt"),i.meta&&r.push("Cmd"),r.push(i.key.toUpperCase()),`
              <div class="shortcut-item">
                <div class="shortcut-keys">
                  ${r.map(c=>`<kbd>${c}</kbd>`).join(" + ")}
                </div>
                <div class="shortcut-desc">${i.description}</div>
              </div>
            `}).join("")}
        </div>
      </div>
    `:""}
    
    <div class="shortcuts-tip">
      <p class="text-muted">
        üí° Tip: Most shortcuts use Ctrl on Windows/Linux or Cmd on Mac.
      </p>
    </div>
  `;const s=b("div",{className:"modal-footer"}),a=b("button",{className:"btn btn-primary",textContent:"Got it"});d(a,"click",()=>K(fo)),s.appendChild(a);const o=Pe({id:fo,title:"Keyboard Shortcuts",content:t,size:"lg",footer:s});document.body.appendChild(o),De(fo)}const ci="notifications-modal";let zs=[],ta="all";async function E5(e={}){ta="all";const t=document.querySelector(`[data-modal-id="${ci}"]`);t&&t.remove();const n=b("div",{className:"notifications-modal-content"});n.innerHTML='<div class="loading">Loading notifications...</div>';const s=b("div",{className:"modal-footer"}),a=b("button",{className:"btn btn-secondary",textContent:"Mark All Read"}),o=b("button",{className:"btn btn-primary",textContent:"Close"});d(a,"click",async()=>{try{await v.post("/api/notifications/mark-all-read"),zs.forEach(c=>c.read=!0),r(),m.success("All marked as read"),e.onMarkAllRead?.()}catch{}}),d(o,"click",()=>K(ci)),s.appendChild(a),s.appendChild(o);const i=Pe({id:ci,title:"Notifications",content:n,size:"md",footer:s});document.body.appendChild(i),De(ci);try{zs=(await v.get("/api/notifications")).data,r()}catch{n.innerHTML='<div class="error">Failed to load notifications</div>'}function r(){const c=ta==="unread"?zs.filter(u=>!u.read):zs,l=zs.filter(u=>!u.read).length;n.innerHTML=`
      <div class="notifications-header">
        <div class="filter-tabs">
          <button class="filter-tab ${ta==="all"?"active":""}" data-filter="all">
            All (${zs.length})
          </button>
          <button class="filter-tab ${ta==="unread"?"active":""}" data-filter="unread">
            Unread (${l})
          </button>
        </div>
      </div>
      
      ${c.length===0?`
        <div class="empty-state">
          <span class="empty-icon">üîî</span>
          <p>${ta==="unread"?"No unread notifications":"No notifications yet"}</p>
        </div>
      `:`
        <div class="notifications-list">
          ${c.map(u=>q5(u)).join("")}
        </div>
      `}
    `,n.querySelectorAll(".filter-tab").forEach(u=>{d(u,"click",()=>{ta=u.getAttribute("data-filter"),r()})}),n.querySelectorAll(".notification-item").forEach(u=>{const p=u.getAttribute("data-notification-id"),g=zs.find(f=>f.id===p);g&&d(u,"click",async()=>{if(!g.read)try{await v.patch(`/api/notifications/${p}/read`),g.read=!0,ss(u,"unread")}catch{}e.onNotificationClick?.(g),g.link&&K(ci)})})}}function q5(e){const t=j5(e.type);return`
    <div class="notification-item ${e.read?"":"unread"}" 
         data-notification-id="${e.id}">
      <div class="notification-icon ${e.type}">${t}</div>
      <div class="notification-content">
        <div class="notification-title">${lc(e.title)}</div>
        <div class="notification-message">${lc(e.message)}</div>
        <div class="notification-meta">
          ${e.actor?`<span class="notification-actor">${lc(e.actor.name)}</span> ‚Ä¢ `:""}
          <span class="notification-time">${Ce(e.createdAt)}</span>
        </div>
      </div>
      ${e.read?"":'<div class="notification-dot"></div>'}
    </div>
  `}function j5(e){switch(e){case"info":return"‚ÑπÔ∏è";case"success":return"‚úÖ";case"warning":return"‚ö†Ô∏è";case"error":return"‚ùå";case"mention":return"üí¨";case"update":return"üîÑ";default:return"üîî"}}function lc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Is="email-modal";function Xl(e){const{mode:t,email:n,onSend:s}=e,a=document.querySelector(`[data-modal-id="${Is}"]`);a&&a.remove();const o=b("div",{className:"email-modal-content"});if(t==="view"&&n)o.innerHTML=`
      <div class="email-view">
        <div class="email-header">
          <div class="email-subject">${rn(n.subject)}</div>
          <div class="email-meta">
            <div class="email-from">
              <strong>${rn(n.from.name)}</strong>
              <span class="text-muted">&lt;${rn(n.from.email)}&gt;</span>
            </div>
            <div class="email-to">
              To: ${n.to.map(c=>rn(c.name||c.email)).join(", ")}
            </div>
            ${n.cc?.length?`
              <div class="email-cc">
                Cc: ${n.cc.map(c=>rn(c.name||c.email)).join(", ")}
              </div>
            `:""}
            <div class="email-date">${Ce(n.date)}</div>
          </div>
        </div>
        
        <div class="email-body">
          ${n.bodyHtml||rn(n.body).replace(/\n/g,"<br>")}
        </div>
        
        ${n.attachments?.length?`
          <div class="email-attachments">
            <h4>Attachments (${n.attachments.length})</h4>
            <div class="attachments-list">
              ${n.attachments.map(c=>`
                <div class="attachment-item">
                  <span class="attachment-icon">üìé</span>
                  <span class="attachment-name">${rn(c.name)}</span>
                  <span class="attachment-size">${P5(c.size)}</span>
                </div>
              `).join("")}
            </div>
          </div>
        `:""}
        
        ${n.thread?.length?`
          <div class="email-thread">
            <h4>Thread (${n.thread.length} messages)</h4>
            ${n.thread.map(c=>`
              <div class="thread-message">
                <div class="thread-header">
                  <strong>${rn(c.from.name)}</strong>
                  <span>${Ce(c.date)}</span>
                </div>
                <div class="thread-preview">${rn(c.body.slice(0,100))}...</div>
              </div>
            `).join("")}
          </div>
        `:""}
      </div>
    `;else{const c=t==="reply"&&n,l=c?n.from.email:"",u=c?`Re: ${n.subject}`:"";o.innerHTML=`
      <form id="email-form" class="email-form">
        <div class="form-group">
          <label for="email-to">To *</label>
          <input type="text" id="email-to" required 
                 value="${l}" 
                 placeholder="recipient@example.com">
        </div>
        
        <div class="form-group">
          <label for="email-cc">Cc</label>
          <input type="text" id="email-cc" 
                 placeholder="cc@example.com">
        </div>
        
        <div class="form-group">
          <label for="email-subject">Subject *</label>
          <input type="text" id="email-subject" required 
                 value="${rn(u)}" 
                 placeholder="Email subject">
        </div>
        
        <div class="form-group">
          <label for="email-body">Message *</label>
          <textarea id="email-body" rows="10" required 
                    placeholder="Write your message...">${c?`

---
On ${n.date}, ${n.from.name} wrote:
${n.body}`:""}</textarea>
        </div>
        
        <div class="form-group">
          <label>Attachments</label>
          <div class="attachment-dropzone" id="attachment-zone">
            <span>Drop files here or click to attach</span>
            <input type="file" id="attachment-input" multiple hidden>
          </div>
          <div id="attachments-preview"></div>
        </div>
      </form>
    `,setTimeout(()=>{const p=o.querySelector("#attachment-zone"),g=o.querySelector("#attachment-input");p&&g&&(d(p,"click",()=>g.click()),d(g,"change",()=>{if(g.files){const f=o.querySelector("#attachments-preview");f.innerHTML=Array.from(g.files).map(h=>`<div class="attachment-item">${rn(h.name)}</div>`).join("")}}))},0)}const i=b("div",{className:"modal-footer"});if(t==="view"){const c=b("button",{className:"btn btn-primary",textContent:"Reply"}),l=b("button",{className:"btn btn-secondary",textContent:"Forward"}),u=b("button",{className:"btn btn-secondary",textContent:"Close"});d(c,"click",()=>{K(Is),Xl({...e,mode:"reply"})}),d(l,"click",()=>{m.info("Forward not implemented")}),d(u,"click",()=>K(Is)),i.appendChild(u),i.appendChild(l),i.appendChild(c)}else{const c=b("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=b("button",{className:"btn btn-primary",textContent:"Send"});d(c,"click",()=>K(Is)),d(l,"click",async()=>{const u=o.querySelector("#email-form");if(!u.checkValidity()){u.reportValidity();return}const p=o.querySelector("#email-to").value,g=o.querySelector("#email-cc").value,f=o.querySelector("#email-subject").value,h=o.querySelector("#email-body").value,k={to:p.split(",").map(C=>({name:"",email:C.trim()})),cc:g?g.split(",").map(C=>({name:"",email:C.trim()})):void 0,subject:f,body:h};l.disabled=!0,l.textContent="Sending...";try{s?await s(k):await v.post("/api/emails/send",k),m.success("Email sent"),K(Is)}catch{}finally{l.disabled=!1,l.textContent="Send"}}),i.appendChild(c),i.appendChild(l)}const r=Pe({id:Is,title:t==="view"?"Email":t==="reply"?"Reply":"Compose Email",content:o,size:"lg",footer:i});document.body.appendChild(r),De(Is)}function P5(e){if(e===0)return"0 B";const t=1024,n=["B","KB","MB"],s=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,s)).toFixed(1))+" "+n[s]}function rn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const yt={charts:new Map,networks:new Map,activeChart:null},el=new Set;function Fa(){el.forEach(e=>e())}function D5(e,t,n,s){yt.charts.set(e,{id:e,chart:t,container:n,type:s}),Fa()}function z5(e){return yt.charts.get(e)?.chart??null}function I5(e){const t=yt.charts.get(e);t?.chart&&t.chart.destroy(),yt.charts.delete(e),Fa()}function H5(e,t){const n=yt.charts.get(e);n?.chart&&(n.chart.data=t,n.chart.update())}function B5(e,t,n){yt.networks.set(e,{id:e,network:t,container:n}),Fa()}function R5(e){return yt.networks.get(e)?.network??null}function N5(e){const t=yt.networks.get(e);t?.network&&typeof t.network.destroy=="function"&&t.network.destroy(),yt.networks.delete(e),Fa()}function O5(e){yt.activeChart=e,Fa()}function F5(){return Array.from(yt.charts.keys())}function U5(){return Array.from(yt.networks.keys())}function V5(){yt.charts.forEach(e=>{e.chart&&e.chart.destroy()}),yt.networks.forEach(e=>{e.network&&typeof e.network.destroy=="function"&&e.network.destroy()}),yt.charts.clear(),yt.networks.clear(),yt.activeChart=null,Fa()}function G5(e){return el.add(e),()=>el.delete(e)}const Es={registerChart:D5,getChart:z5,destroyChart:I5,updateChartData:H5,registerNetwork:B5,getNetwork:R5,destroyNetwork:N5,setActiveChart:O5,getChartIds:F5,getNetworkIds:U5,destroyAll:V5,subscribe:G5},ho="graph-modal";function Z5(e){const{title:t="Graph View",nodes:n,edges:s,onNodeClick:a,onEdgeClick:o}=e,i=document.querySelector(`[data-modal-id="${ho}"]`);i&&i.remove();const r=b("div",{className:"graph-modal-content"});r.innerHTML=`
    <div class="graph-toolbar">
      <div class="graph-info">
        <span>Nodes: ${n.length}</span>
        <span>Edges: ${s.length}</span>
      </div>
      <div class="graph-controls">
        <button class="btn btn-sm btn-secondary" data-action="zoom-in" title="Zoom In">+</button>
        <button class="btn btn-sm btn-secondary" data-action="zoom-out" title="Zoom Out">‚àí</button>
        <button class="btn btn-sm btn-secondary" data-action="fit" title="Fit to View">‚ä°</button>
        <button class="btn btn-sm btn-secondary" data-action="fullscreen" title="Fullscreen">‚õ∂</button>
      </div>
    </div>
    <div id="graph-container" class="graph-container">
      <div class="graph-placeholder">
        <p>Loading graph visualization...</p>
        <p class="text-muted">Requires vis-network library</p>
      </div>
    </div>
    <div class="graph-legend">
      ${Q5(n).map(g=>`
        <span class="legend-item">
          <span class="legend-color" style="--legend-color: ${lv(g)}"></span>
          ${g}
        </span>
      `).join("")}
    </div>
  `;const c=b("div",{className:"modal-footer"}),l=b("button",{className:"btn btn-secondary",textContent:"Export Image"}),u=b("button",{className:"btn btn-primary",textContent:"Close"});d(l,"click",()=>{const g=r.querySelector("canvas");if(g){const f=document.createElement("a");f.download="graph.png",f.href=g.toDataURL(),f.click()}else m.warning("Graph not rendered")}),d(u,"click",()=>{Es.destroyNetwork("modal-graph"),K(ho)}),c.appendChild(l),c.appendChild(u);const p=Pe({id:ho,title:t,content:r,size:"xl",footer:c});document.body.appendChild(p),De(ho),setTimeout(()=>{W5(r,n,s,a,o),K5(r)},100)}function W5(e,t,n,s,a){const o=e.querySelector("#graph-container");if(typeof window.vis>"u"){o.innerHTML=`
      <div class="graph-fallback">
        <h4>Graph Data</h4>
        <div class="graph-data">
          <strong>Nodes (${t.length}):</strong>
          <ul>${t.slice(0,10).map(p=>`<li>${p.label} (${p.type||"default"})</li>`).join("")}</ul>
          ${t.length>10?`<p class="text-muted">...and ${t.length-10} more</p>`:""}
        </div>
        <div class="graph-data">
          <strong>Edges (${n.length}):</strong>
          <ul>${n.slice(0,10).map(p=>`<li>${p.from} ‚Üí ${p.to}${p.label?` (${p.label})`:""}</li>`).join("")}</ul>
          ${n.length>10?`<p class="text-muted">...and ${n.length-10} more</p>`:""}
        </div>
        <p class="text-muted"><em>vis-network library not loaded</em></p>
      </div>
    `;return}const i=window.vis,r=new i.DataSet(t.map(p=>({id:p.id,label:p.label,color:p.color||lv(p.type),size:p.size||20}))),c=new i.DataSet(n.map(p=>({id:p.id,from:p.from,to:p.to,label:p.label,color:p.color}))),l={nodes:{shape:"dot",font:{color:"#eaeaea",size:12},borderWidth:2},edges:{arrows:"to",color:{color:"#2a2a4a",highlight:"#e94560"},font:{color:"#a0a0a0",size:10}},physics:{enabled:!0,stabilization:{iterations:100}},interaction:{hover:!0,tooltipDelay:200}};o.innerHTML="";const u=new i.Network(o,{nodes:r,edges:c},l);Es.registerNetwork("modal-graph",u,"#graph-container"),s&&u.on("click",p=>{if(p.nodes.length>0){const g=t.find(f=>f.id===p.nodes[0]);g&&s(g)}}),a&&u.on("click",p=>{if(p.edges.length>0){const g=n.find(f=>f.id===p.edges[0]);g&&a(g)}})}function K5(e){const t=Es.getNetwork("modal-graph");t&&e.querySelectorAll("[data-action]").forEach(n=>{d(n,"click",()=>{switch(n.getAttribute("data-action")){case"zoom-in":t.moveTo?.({scale:1.2});break;case"zoom-out":t.moveTo?.({scale:.8});break;case"fit":t.fit?.();break;case"fullscreen":const a=e.querySelector(".graph-container");a&&a.requestFullscreen?.();break}})})}function Q5(e){const t=new Set(e.map(n=>n.type||"default"));return Array.from(t)}function lv(e){const t={person:"#4ecdc4",organization:"#e94560",document:"#ffe66d",event:"#ff6b6b",location:"#45b7d1",default:"#a0a0a0"};return t[e||"default"]||t.default}const bo="history-modal";let wa=[],tl=1,Ko=!0,dc=!1;async function J5(e={}){const{entityType:t,entityId:n,title:s="History",onRestore:a}=e;wa=[],tl=1,Ko=!0;const o=document.querySelector(`[data-modal-id="${bo}"]`);o&&o.remove();const i=b("div",{className:"history-modal-content"});i.innerHTML='<div class="loading">Loading history...</div>';const r=b("div",{className:"modal-footer"}),c=b("button",{className:"btn btn-primary",textContent:"Close"});d(c,"click",()=>K(bo)),r.appendChild(c);const l=Pe({id:bo,title:s,content:i,size:"lg",footer:r});document.body.appendChild(l),De(bo),await dv(i,t,n,a)}async function dv(e,t,n,s){if(!(dc||!Ko)){dc=!0;try{const a=new URLSearchParams({page:String(tl),limit:"20"});t&&a.set("entityType",t),n&&a.set("entityId",n);const o=await v.get(`/api/history?${a}`);wa=[...wa,...o.data.entries],Ko=o.data.hasMore,tl++,Y5(e,s)}catch{e.innerHTML='<div class="error">Failed to load history</div>'}finally{dc=!1}}}function Y5(e,t){if(wa.length===0){e.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">üìú</span>
        <p>No history entries</p>
      </div>
    `;return}const n=eT(wa);e.innerHTML=`
    <div class="history-timeline">
      ${Object.entries(n).map(([a,o])=>`
        <div class="history-date-group">
          <div class="history-date">${a}</div>
          ${o.map(i=>X5(i)).join("")}
        </div>
      `).join("")}
    </div>
    ${Ko?`
      <div class="history-load-more">
        <button class="btn btn-secondary" data-action="load-more">Load More</button>
      </div>
    `:""}
  `;const s=e.querySelector('[data-action="load-more"]');s&&d(s,"click",async()=>{await dv(e,void 0,void 0,t)}),t&&e.querySelectorAll('[data-action="restore"]').forEach(a=>{d(a,"click",async()=>{const o=a.getAttribute("data-entry-id"),i=wa.find(r=>r.id===o);if(i){const{confirm:r}=await xe(async()=>{const{confirm:l}=await Promise.resolve().then(()=>In);return{confirm:l}},void 0);await r("Are you sure you want to restore this version?",{title:"Restore",confirmText:"Restore"})&&t(i)}})}),e.querySelectorAll('[data-action="expand"]').forEach(a=>{d(a,"click",()=>{const o=a.closest(".history-entry")?.querySelector(".history-changes");o&&(o.classList.toggle("expanded"),a.textContent=o.classList.contains("expanded")?"Hide details":"Show details")})})}function X5(e){const t={create:"‚ûï",update:"‚úèÔ∏è",delete:"üóëÔ∏è",restore:"‚Ü©Ô∏è"},n={create:"success",update:"info",delete:"danger",restore:"warning"},s=e.changes&&Object.keys(e.changes).length>0;return`
    <div class="history-entry ${n[e.action]}" data-entry-id="${e.id}">
      <div class="history-icon">${t[e.action]}</div>
      <div class="history-content">
        <div class="history-summary">
          <strong>${e.actor.name}</strong>
          ${e.action}d
          <span class="entity-type">${e.entityType}</span>
          ${e.entityName?`"${tT(e.entityName)}"`:""}
        </div>
        <div class="history-time">${Ce(e.timestamp)}</div>
        
        ${s?`
          <div class="history-changes">
            ${Object.entries(e.changes).map(([a,o])=>`
              <div class="change-item">
                <span class="change-field">${a}:</span>
                <span class="change-old">${np(o.old)}</span>
                <span class="change-arrow">‚Üí</span>
                <span class="change-new">${np(o.new)}</span>
              </div>
            `).join("")}
          </div>
          <button class="btn-link" data-action="expand">Show details</button>
        `:""}
        
        ${e.action==="delete"?`
          <button class="btn btn-sm btn-secondary" data-action="restore" data-entry-id="${e.id}">
            Restore
          </button>
        `:""}
      </div>
    </div>
  `}function eT(e){const t={};return e.forEach(n=>{const s=new Date(n.timestamp).toLocaleDateString();t[s]||(t[s]=[]),t[s].push(n)}),t}function np(e){return e==null?"(empty)":typeof e=="object"?JSON.stringify(e):String(e)}function tT(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const uc="comment-modal";let Us=[];async function nT(e){const{entityType:t,entityId:n,entityName:s,onCommentAdded:a}=e;Us=[];const o=document.querySelector(`[data-modal-id="${uc}"]`);o&&o.remove();const i=b("div",{className:"comment-modal-content"});i.innerHTML='<div class="loading">Loading comments...</div>';const r=b("div",{className:"modal-footer comment-footer"});r.innerHTML=`
    <div class="comment-input-wrapper">
      <textarea id="comment-input" placeholder="Write a comment..." rows="2"></textarea>
      <button id="submit-comment" class="btn btn-primary">Post</button>
    </div>
  `;const c=Pe({id:uc,title:s?`Comments on "${s}"`:"Comments",content:i,size:"md",footer:r});document.body.appendChild(c),De(uc);const l=r.querySelector("#submit-comment"),u=r.querySelector("#comment-input");d(l,"click",async()=>{const p=u.value.trim();if(!p){m.warning("Please write a comment");return}l.disabled=!0,l.textContent="Posting...";try{const g=await v.post(`/api/${t}/${n}/comments`,{content:p});Us.unshift(g.data),u.value="",Mi(i,e),a?.(g.data),m.success("Comment added")}catch{}finally{l.disabled=!1,l.textContent="Post"}}),d(u,"keydown",p=>{p.key==="Enter"&&p.ctrlKey&&l.click()});try{Us=(await v.get(`/api/${t}/${n}/comments`)).data,Mi(i,e)}catch{i.innerHTML='<div class="error">Failed to load comments</div>'}}function Mi(e,t){if(Us.length===0){e.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">üí¨</span>
        <p>No comments yet</p>
        <p class="text-muted">Be the first to comment!</p>
      </div>
    `;return}e.innerHTML=`
    <div class="comments-list">
      ${Us.map(n=>uv(n,t)).join("")}
    </div>
  `,sT(e,t)}function uv(e,t,n=0){const a=N.getState().currentUser?.id===e.author.id,o=e.author.name.split(" ").map(i=>i[0]).join("").toUpperCase().slice(0,2);return`
    <div class="comment ${n>0?"reply":""}" data-comment-id="${e.id}" style="--reply-offset: ${n*20}px">
      <div class="comment-avatar">
        ${e.author.avatar?`<img src="${e.author.avatar}" alt="${So(e.author.name)}">`:o}
      </div>
      <div class="comment-body">
        <div class="comment-header">
          <strong class="comment-author">${So(e.author.name)}</strong>
          <span class="comment-time">${Ce(e.createdAt)}</span>
          ${e.edited?'<span class="comment-edited">(edited)</span>':""}
        </div>
        <div class="comment-content">${So(e.content)}</div>
        <div class="comment-actions">
          <button class="btn-link" data-action="reply" data-comment-id="${e.id}">Reply</button>
          ${a?`
            <button class="btn-link" data-action="edit" data-comment-id="${e.id}">Edit</button>
            <button class="btn-link text-danger" data-action="delete" data-comment-id="${e.id}">Delete</button>
          `:""}
        </div>
      </div>
    </div>
    ${e.replies?.map(i=>uv(i,t,n+1)).join("")||""}
  `}function sT(e,t){e.querySelectorAll("[data-action]").forEach(n=>{const s=n.getAttribute("data-action"),a=n.getAttribute("data-comment-id");d(n,"click",async()=>{const o=pv(Us,a);if(o)switch(s){case"reply":const i=n.closest(".comment")?.querySelector(".comment-body");if(i&&!i.querySelector(".reply-input")){const u=b("div",{className:"reply-input"});u.innerHTML=`
              <textarea placeholder="Write a reply..." rows="2"></textarea>
              <div class="reply-actions">
                <button class="btn btn-sm btn-secondary cancel-reply">Cancel</button>
                <button class="btn btn-sm btn-primary submit-reply">Reply</button>
              </div>
            `,i.appendChild(u);const p=u.querySelector(".cancel-reply"),g=u.querySelector(".submit-reply"),f=u.querySelector("textarea");d(p,"click",()=>u.remove()),d(g,"click",async()=>{const h=f.value.trim();if(h)try{const k=await v.post(`/api/${t.entityType}/${t.entityId}/comments/${a}/replies`,{content:h});o.replies||(o.replies=[]),o.replies.push(k.data),Mi(e,t)}catch{}}),f.focus()}break;case"edit":const r=n.closest(".comment")?.querySelector(".comment-content");if(r){const u=o.content;r.innerHTML=`
              <textarea class="edit-textarea">${So(u)}</textarea>
              <div class="edit-actions">
                <button class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
                <button class="btn btn-sm btn-primary save-edit">Save</button>
              </div>
            `;const p=r.querySelector("textarea"),g=r.querySelector(".cancel-edit"),f=r.querySelector(".save-edit");d(g,"click",()=>{r.textContent=u}),d(f,"click",async()=>{const h=p.value.trim();if(h)try{await v.patch(`/api/${t.entityType}/${t.entityId}/comments/${a}`,{content:h}),o.content=h,o.edited=!0,Mi(e,t)}catch{}}),p.focus()}break;case"delete":const{confirm:c}=await xe(async()=>{const{confirm:u}=await Promise.resolve().then(()=>In);return{confirm:u}},void 0);if(await c("Delete this comment?",{title:"Delete Comment",confirmText:"Delete",confirmClass:"btn-danger"}))try{await v.delete(`/api/${t.entityType}/${t.entityId}/comments/${a}`),mv(Us,a),Mi(e,t),m.success("Comment deleted")}catch{}break}})})}function pv(e,t){for(const n of e){if(n.id===t)return n;if(n.replies){const s=pv(n.replies,t);if(s)return s}}}function mv(e,t){const n=e.findIndex(s=>s.id===t);if(n!==-1)return e.splice(n,1),!0;for(const s of e)if(s.replies&&mv(s.replies,t))return!0;return!1}function So(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ks="profile-modal";let nl={},Mn=null,fi=null;function gv(e={}){nl=e;const t=vv(),n=Pe({id:Ks,title:"",size:"lg",content:t,onClose:e.onClose});n.classList.add("profile-modal-overlay");const s=n.querySelector(".modal-content");s&&s.classList.add("profile-modal-content");const a=n.querySelector(".modal-header");a&&a.classList.add("hidden"),document.body.appendChild(n),De(Ks),fv(t)}function vv(){const e=b("div",{className:"profile-modal-sota"});return e.innerHTML=`
    <style>
      .profile-modal-sota {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      .profile-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
        overflow: hidden;
      }
      
      [data-theme="dark"] .profile-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(15,23,42,0.95) 100%);
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      
      .profile-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 32px;
        position: relative;
        overflow: hidden;
      }
      
      .profile-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
      }
      
      .profile-header-content {
        display: flex;
        align-items: center;
        gap: 24px;
        position: relative;
        z-index: 1;
      }
      
      .profile-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: 600;
        color: white;
        border: 4px solid rgba(255,255,255,0.3);
        overflow: hidden;
        flex-shrink: 0;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
      
      .profile-avatar-large:hover {
        border-color: rgba(255,255,255,0.5);
        transform: scale(1.05);
      }
      
      .profile-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .avatar-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        border-radius: 50%;
      }
      
      .profile-avatar-large:hover .avatar-overlay {
        opacity: 1;
      }
      
      .avatar-overlay svg {
        width: 28px;
        height: 28px;
        color: white;
      }
      
      .profile-user-info h2 {
        margin: 0 0 4px 0;
        font-size: 28px;
        font-weight: 700;
        color: white;
      }
      
      .profile-user-info .email {
        color: rgba(255,255,255,0.8);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .profile-user-info .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(255,255,255,0.2);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
      }
      
      .profile-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
      }
      
      .profile-close-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
      }
      
      .profile-close-btn svg {
        width: 20px;
        height: 20px;
        color: white;
      }
      
      .profile-tabs-nav {
        display: flex;
        gap: 0;
        padding: 0 24px;
        background: rgba(0,0,0,0.02);
        border-bottom: 1px solid rgba(0,0,0,0.06);
      }
      
      [data-theme="dark"] .profile-tabs-nav {
        background: rgba(255,255,255,0.02);
        border-bottom-color: rgba(255,255,255,0.06);
      }
      
      .profile-tab-btn {
        padding: 16px 24px;
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }
      
      .profile-tab-btn:hover {
        color: #1e293b;
      }
      
      [data-theme="dark"] .profile-tab-btn:hover {
        color: #e2e8f0;
      }
      
      .profile-tab-btn.active {
        color: #e11d48;
      }
      
      .profile-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 24px;
        right: 24px;
        height: 2px;
        background: #e11d48;
        border-radius: 2px 2px 0 0;
      }
      
      .profile-tab-icon {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        vertical-align: middle;
      }
      
      .profile-body {
        padding: 32px;
      }
      
      .profile-section {
        display: none;
      }
      
      .profile-section.active {
        display: block;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
      
      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      [data-theme="dark"] .form-field label {
        color: #94a3b8;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s;
        outline: none;
      }
      
      [data-theme="dark"] .form-field input,
      [data-theme="dark"] .form-field select,
      [data-theme="dark"] .form-field textarea {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .form-field input:disabled {
        background: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
      }
      
      [data-theme="dark"] .form-field input:disabled {
        background: rgba(255,255,255,0.02);
        color: #64748b;
      }
      
      .form-field textarea {
        resize: vertical;
        min-height: 100px;
      }
      
      .form-hint {
        font-size: 12px;
        color: #94a3b8;
      }
      
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(0,0,0,0.06);
      }
      
      [data-theme="dark"] .form-actions {
        border-top-color: rgba(255,255,255,0.06);
      }
      
      .btn-sota {
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-sota.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .btn-sota.secondary {
        background: #f1f5f9;
        color: #475569;
      }
      
      [data-theme="dark"] .btn-sota.secondary {
        background: rgba(255,255,255,0.1);
        color: #e2e8f0;
      }
      
      .btn-sota.secondary:hover {
        background: #e2e8f0;
      }
      
      [data-theme="dark"] .btn-sota.secondary:hover {
        background: rgba(255,255,255,0.15);
      }
      
      .btn-sota.danger {
        background: transparent;
        color: #dc2626;
        border: 1px solid #fecaca;
      }
      
      .btn-sota.danger:hover {
        background: #fef2f2;
        border-color: #dc2626;
      }
      
      /* Security Section */
      .security-section {
        margin-bottom: 32px;
      }
      
      .security-section h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      [data-theme="dark"] .security-section h3 {
        color: #f1f5f9;
      }
      
      .danger-zone {
        background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
        border: 1px solid #fecaca;
        border-radius: 16px;
        padding: 24px;
      }
      
      [data-theme="dark"] .danger-zone {
        background: linear-gradient(135deg, rgba(220,38,38,0.1) 0%, rgba(220,38,38,0.05) 100%);
        border-color: rgba(220,38,38,0.3);
      }
      
      .danger-zone h3 {
        color: #dc2626 !important;
      }
      
      .danger-zone p {
        color: #991b1b;
        font-size: 14px;
        margin: 0 0 16px 0;
      }
      
      [data-theme="dark"] .danger-zone p {
        color: #fca5a5;
      }
      
      /* Sessions */
      .sessions-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .session-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid transparent;
      }
      
      [data-theme="dark"] .session-card {
        background: rgba(255,255,255,0.03);
      }
      
      .session-card.current {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
      }
      
      .session-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .session-icon {
        width: 44px;
        height: 44px;
        background: #e2e8f0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      [data-theme="dark"] .session-icon {
        background: rgba(255,255,255,0.1);
      }
      
      .session-icon svg {
        width: 22px;
        height: 22px;
        color: #64748b;
      }
      
      .session-details h4 {
        margin: 0 0 4px 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
      }
      
      [data-theme="dark"] .session-details h4 {
        color: #f1f5f9;
      }
      
      .session-details p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
      }
      
      .session-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        background: #e11d48;
        color: white;
      }
      
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #94a3b8;
      }
      
      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 48px;
      }
      
      .loading-spinner::after {
        content: '';
        width: 32px;
        height: 32px;
        border: 3px solid #e2e8f0;
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
    
    <div class="profile-card">
      <div class="loading-spinner"></div>
    </div>
  `,e}async function fv(e,t){const n=e.querySelector(".profile-card");if(n)try{const[s,a]=await Promise.all([Kn.get(),oT()]);if(s)Mn=s,pc(n,Mn,a,t);else{const o=N.getState().currentUser;o?(Mn={id:o.id,email:o.email,display_name:o.name||o.email?.split("@")[0]||"User",avatar_url:o.avatar,created_at:new Date().toISOString()},pc(n,Mn,a,t)):n.innerHTML='<div class="empty-state">Please log in to view your profile</div>'}}catch{const s=N.getState().currentUser;s?(Mn={id:s.id,email:s.email,display_name:s.name||"User",avatar_url:s.avatar,created_at:new Date().toISOString()},pc(n,Mn,void 0,t)):n.innerHTML='<div class="empty-state">Failed to load profile</div>'}}function pc(e,t,n,s){iT(t.display_name||t.email);const o=N.getState().currentUser?.role||t.role||"user";e.innerHTML=`
    <!-- Header -->
    <div class="profile-header">
      <button class="profile-close-btn" id="close-profile-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="profile-header-content">
        <label class="profile-avatar-large" for="avatar-input-hidden" id="profile-avatar-display">
          <img src="${t.avatar_url||Ei(t.display_name||t.email)}" alt="Avatar" onerror="this.src='${Ei(t.display_name||t.email)}'">
          <div class="avatar-overlay">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <input type="file" id="avatar-input-hidden" accept="image/*" hidden>
        </label>
        
        <div class="profile-user-info">
          <h2>${Bt(t.display_name||t.username||"User")}</h2>
          <div class="email">
            ${Bt(t.email)}
            <span class="role-badge">
              <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                ${o==="superadmin"?'<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>':'<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>'}
              </svg>
              ${o==="superadmin"?"Super Admin":"User"}
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <nav class="profile-tabs-nav">
      <button class="profile-tab-btn active" data-tab="general">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        General
      </button>
      <button class="profile-tab-btn" data-tab="security">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        Security
      </button>
      <button class="profile-tab-btn" data-tab="sessions">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        Sessions
      </button>
      <button class="profile-tab-btn" data-tab="integrations">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
        </svg>
        Integrations
      </button>
    </nav>
    
    <!-- Tab Content -->
    <div class="profile-body">
      <!-- General Tab -->
      <div class="profile-section active" id="section-general">
        <form id="profile-form">
          <div class="form-grid">
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Email
              </label>
              <input type="email" value="${Bt(t.email)}" disabled>
              <span class="form-hint">Email cannot be changed</span>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"/>
                </svg>
                Username
              </label>
              <input type="text" name="username" value="${Bt(t.username||"")}" placeholder="Enter username">
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Display Name
              </label>
              <input type="text" name="display_name" value="${Bt(t.display_name||"")}" placeholder="Your display name">
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                </svg>
                Bio
              </label>
              <textarea name="bio" placeholder="Tell us a bit about yourself">${Bt(t.bio||"")}</textarea>
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Avatar URL
              </label>
              <input type="url" name="avatar_url" id="avatar-url-input" value="${Bt(t.avatar_url||"")}" placeholder="https://example.com/avatar.jpg">
              <span class="form-hint">Enter an image URL or upload using the avatar above. Leave empty for auto-generated avatar.</span>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Timezone
              </label>
              <select name="timezone">
                ${rT(t.timezone,n)}
              </select>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                </svg>
                Language
              </label>
              <select name="locale">
                <option value="en" ${t.locale==="en"?"selected":""}>English</option>
                <option value="pt" ${t.locale==="pt"?"selected":""}>Portugu√™s</option>
                <option value="es" ${t.locale==="es"?"selected":""}>Espa√±ol</option>
                <option value="fr" ${t.locale==="fr"?"selected":""}>Fran√ßais</option>
              </select>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-sota primary">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save Changes
            </button>
          </div>
        </form>
      </div>
      
      <!-- Security Tab -->
      <div class="profile-section" id="section-security">
        <div class="security-section">
          <h3>
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
            Change Password
          </h3>
          
          <form id="password-form">
            <div class="form-grid">
              <div class="form-field full-width">
                <label>Current Password</label>
                <input type="password" name="current_password" required>
              </div>
              
              <div class="form-field">
                <label>New Password</label>
                <input type="password" name="new_password" minlength="12" required>
                <span class="form-hint">Minimum 12 characters</span>
              </div>
              
              <div class="form-field">
                <label>Confirm Password</label>
                <input type="password" name="confirm_password" required>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn-sota primary">Update Password</button>
            </div>
          </form>
        </div>
        
        <div class="danger-zone">
          <h3>
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Danger Zone
          </h3>
          <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
          <button type="button" class="btn-sota danger" id="delete-account-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Account
          </button>
        </div>
      </div>
      
      <!-- Sessions Tab -->
      <div class="profile-section" id="section-sessions">
        <div id="sessions-list" class="sessions-list">
          <div class="loading-spinner"></div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-sota secondary" id="revoke-all-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            Sign out all other sessions
          </button>
        </div>
      </div>
      
      <!-- Integrations Tab -->
      <div class="profile-section" id="section-integrations">
        <div class="security-section">
          <h3>
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
            </svg>
            Krisp AI Meeting Assistant
          </h3>
          <p class="form-hint form-hint-mb">
            Connect your Krisp account to automatically import meeting transcriptions into GodMode.
          </p>
          
          <div id="krisp-integration-content">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </div>
  `,aT(e,s)}function aT(e,t){const n=e.querySelector("#close-profile-btn");n&&d(n,"click",()=>{t?.onBack?t.onBack():(K(Ks),nl.onClose?.())});const s=e.querySelectorAll(".profile-tab-btn");s.forEach(p=>{d(p,"click",()=>{s.forEach(f=>f.classList.remove("active")),p.classList.add("active");const g=p.getAttribute("data-tab");e.querySelectorAll(".profile-section").forEach(f=>{f.classList.toggle("active",f.id===`section-${g}`)}),g==="sessions"&&sl(),g==="integrations"&&hi(e)})});const a=e.querySelector("#avatar-input-hidden");a&&d(a,"change",async()=>{const p=a.files?.[0];if(p)try{const g=await Kn.uploadAvatar(p),f=e.querySelector(".profile-avatar-large");if(f){const h=f.querySelector("img");h?h.src=g:f.innerHTML=`
                <img src="${g}" alt="Avatar">
                <div class="avatar-overlay">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </div>
                <input type="file" id="avatar-input-hidden" accept="image/*" hidden>
              `}m.success("Avatar updated")}catch{m.error("Failed to upload avatar")}});const o=e.querySelector("#avatar-url-input"),i=e.querySelector("#profile-avatar-display img");o&&i&&d(o,"input",()=>{const p=o.value.trim();p?i.src=p:Mn&&(i.src=Ei(Mn.display_name||Mn.email))});const r=e.querySelector("#profile-form");r&&d(r,"submit",async p=>{p.preventDefault();const g=new FormData(r),f=g.get("avatar_url")?.trim(),h=g.get("display_name")||void 0,k={username:g.get("username")||void 0,display_name:h,bio:g.get("bio")||void 0,timezone:g.get("timezone")||void 0,locale:g.get("locale")||void 0,avatar_url:f||(h?Ei(h):void 0)};try{const C=await Kn.update(k);Mn=C,m.success("Profile updated"),nl.onUpdate?.(C),i&&(i.src=C.avatar_url||Ei(C.display_name||C.email))}catch{m.error("Failed to update profile")}});const c=e.querySelector("#password-form");c&&d(c,"submit",async p=>{p.preventDefault();const g=new FormData(c),f=g.get("current_password"),h=g.get("new_password"),k=g.get("confirm_password");if(h!==k){m.error("Passwords do not match");return}try{await Kn.changePassword({current_password:f,new_password:h}),m.success("Password changed"),c.reset()}catch(C){m.error(C instanceof Error?C.message:"Failed to change password")}});const l=e.querySelector("#delete-account-btn");l&&d(l,"click",async()=>{const p=prompt("Enter your password to confirm account deletion:");if(p&&confirm("Are you sure? This action cannot be undone."))try{await Kn.deleteAccount(p),K(Ks),m.success("Account deleted"),window.location.reload()}catch{m.error("Failed to delete account")}});const u=e.querySelector("#revoke-all-btn");u&&d(u,"click",async()=>{if(confirm("Sign out from all other devices?"))try{await Kn.revokeAllSessions(),m.success("All other sessions signed out"),sl()}catch{m.error("Failed to revoke sessions")}})}async function sl(){const e=document.querySelector("#sessions-list");if(e)try{const t=await Kn.getSessions();if(!t||t.length===0){e.innerHTML=`
        <div class="empty-state">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <p>No active sessions found</p>
        </div>
      `;return}e.innerHTML=t.map(n=>`
      <div class="session-card ${n.is_current?"current":""}">
        <div class="session-info">
          <div class="session-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              ${n.device?.toLowerCase().includes("mobile")?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>'}
            </svg>
          </div>
          <div class="session-details">
            <h4>${Bt(n.device||"Unknown device")}</h4>
            <p>${n.location?`${Bt(n.location)} ‚Ä¢ `:""}${Bt(n.ip_address||"Unknown IP")} ‚Ä¢ Last active: ${cT(n.last_active)}</p>
          </div>
        </div>
        ${n.is_current?'<span class="session-badge">Current</span>':`<button class="btn-sota secondary revoke-session-btn" data-id="${n.id}">Revoke</button>`}
      </div>
    `).join(""),e.querySelectorAll(".revoke-session-btn").forEach(n=>{d(n,"click",async()=>{const s=n.getAttribute("data-id");if(s)try{await Kn.revokeSession(s),m.success("Session revoked"),sl()}catch{m.error("Failed to revoke session")}})})}catch{e.innerHTML=`
      <div class="empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>Session management requires authentication</p>
      </div>
    `}}function iT(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function Ei(e){return`https://ui-avatars.com/api/?name=${encodeURIComponent(e||"User")}&background=e11d48&color=fff&size=200&font-size=0.4&bold=true`}async function oT(){if(fi)return fi;try{return fi=(await v.get("/api/timezones")).data.timezones,fi}catch{return[{code:"UTC",name:"Coordinated Universal Time",utc_offset:"+00:00"},{code:"Europe/Lisbon",name:"Lisbon, Portugal",utc_offset:"+00:00"},{code:"Europe/London",name:"London, United Kingdom",utc_offset:"+00:00"}]}}function rT(e,t){const s=(t||fi||[{code:"UTC",name:"Coordinated Universal Time",utc_offset:"+00:00"}]).reduce((r,c)=>{const l=c.region||"Other";return r[l]||(r[l]=[]),r[l].push(c),r},{}),a=["Europe","Americas","Asia","Oceania","Africa","Atlantic","UTC","Other"],o=Object.keys(s).sort((r,c)=>{const l=a.indexOf(r),u=a.indexOf(c);return(l===-1?999:l)-(u===-1?999:u)});let i="";for(const r of o){i+=`<optgroup label="${r}">`;for(const c of s[r]){const l=`${c.name} (${c.utc_offset})`;i+=`<option value="${c.code}" ${e===c.code?"selected":""}>${l}</option>`}i+="</optgroup>"}return i}function cT(e){const t=new Date(e),s=new Date().getTime()-t.getTime();return s<6e4?"Just now":s<36e5?`${Math.floor(s/6e4)} min ago`:s<864e5?`${Math.floor(s/36e5)} hours ago`:s<6048e5?`${Math.floor(s/864e5)} days ago`:t.toLocaleDateString()}function Bt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function hi(e){const t=e.querySelector("#krisp-integration-content");if(!t)return;const s=N.getState().currentUser?.role==="superadmin";try{const a=await Dd(),o=await xw();if(!a){t.innerHTML=`
        <div class="krisp-not-configured">
          <p>Krisp integration is not configured yet.</p>
          <button type="button" class="btn-sota primary" id="enable-krisp-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Enable Krisp Integration
          </button>
        </div>
      `;const g=t.querySelector("#enable-krisp-btn");g&&d(g,"click",async()=>{try{await Dd(),hi(e),m.success("Krisp integration enabled")}catch{m.error("Failed to enable Krisp integration")}});return}t.innerHTML=`
      <div class="krisp-config">
        ${s?`
        <div class="krisp-mcp-banner">
          <div class="mcp-icon">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <div class="mcp-info">
            <strong>MCP Direct Access</strong>
            <span>As a Super Admin, you can import meetings directly via MCP without webhook configuration.</span>
          </div>
          <button type="button" class="btn-sota primary" id="mcp-import-btn">
            Import via MCP
          </button>
        </div>
        `:""}
        
        <div class="krisp-status">
          <span class="status-indicator ${a.is_active?"active":"inactive"}"></span>
          <span>${a.is_active?"Active":"Inactive"}</span>
          <button type="button" class="btn-sota small ${a.is_active?"secondary":"primary"}" id="toggle-krisp-btn">
            ${a.is_active?"Disable":"Enable"}
          </button>
        </div>

        <div class="form-field">
          <label>Webhook URL</label>
          <div class="input-with-copy">
            <input type="text" value="${Bt(a.webhook_url)}" readonly>
            <button type="button" class="btn-copy" data-copy="${Bt(a.webhook_url)}" title="Copy URL">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-field">
          <label>Authorization Token</label>
          <div class="input-with-copy">
            <input type="password" value="${Bt(a.webhook_secret)}" readonly id="krisp-secret-input">
            <button type="button" class="btn-toggle-visibility" id="toggle-secret-btn" title="Show/Hide">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
            <button type="button" class="btn-copy" data-copy="${Bt(a.webhook_secret)}" title="Copy Token">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
          </div>
          <span class="form-hint">Use this token in the Authorization header when configuring Krisp webhook.</span>
        </div>

        <div class="krisp-stats">
          <div class="stat">
            <span class="stat-value">${o?.total_count||0}</span>
            <span class="stat-label">Total Transcripts</span>
          </div>
          <div class="stat">
            <span class="stat-value">${o?.processed_count||0}</span>
            <span class="stat-label">Processed</span>
          </div>
          <div class="stat ${(o?.quarantine_count||0)+(o?.ambiguous_count||0)>0?"warning":""}">
            <span class="stat-value">${(o?.quarantine_count||0)+(o?.ambiguous_count||0)}</span>
            <span class="stat-label">Need Attention</span>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-sota secondary" id="regenerate-krisp-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Regenerate Credentials
          </button>
          <a href="#" class="btn-sota primary" id="view-transcripts-btn">
            View Transcripts
          </a>
        </div>
      </div>
      
      <style>
        .krisp-config { padding: 16px 0; }
        .krisp-status { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .status-indicator.active { background: #22c55e; }
        .status-indicator.inactive { background: #94a3b8; }
        .input-with-copy { display: flex; gap: 8px; }
        .input-with-copy input { flex: 1; }
        .btn-copy, .btn-toggle-visibility { padding: 8px; background: var(--bg-secondary, #f1f5f9); border: 1px solid var(--border-color, #e2e8f0); border-radius: 6px; cursor: pointer; }
        .btn-copy:hover, .btn-toggle-visibility:hover { background: var(--bg-tertiary, #e2e8f0); }
        .krisp-stats { display: flex; gap: 16px; margin: 24px 0; padding: 16px; background: var(--bg-secondary, #f8fafc); border-radius: 12px; }
        .stat { flex: 1; text-align: center; }
        .stat-value { display: block; font-size: 24px; font-weight: 600; color: var(--text-primary, #1e293b); }
        .stat-label { font-size: 12px; color: var(--text-secondary, #64748b); }
        .stat.warning .stat-value { color: #f59e0b; }
        .btn-sota.small { padding: 4px 12px; font-size: 12px; }
        .krisp-not-configured { text-align: center; padding: 32px; }
        .krisp-not-configured p { margin-bottom: 16px; color: var(--text-secondary, #64748b); }
        .krisp-mcp-banner {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px;
          background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
          border: 1px solid #93c5fd;
          border-radius: 12px;
          margin-bottom: 20px;
        }
        .mcp-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }
        .mcp-icon svg { color: white; }
        .mcp-info {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }
        .mcp-info strong {
          font-size: 14px;
          color: #1e40af;
        }
        .mcp-info span {
          font-size: 12px;
          color: #3b82f6;
        }
        .krisp-mcp-banner .btn-sota {
          flex-shrink: 0;
        }
        [data-theme="dark"] .krisp-mcp-banner {
          background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(29,78,216,0.1) 100%);
          border-color: rgba(59,130,246,0.3);
        }
        [data-theme="dark"] .mcp-info strong { color: #93c5fd; }
        [data-theme="dark"] .mcp-info span { color: #60a5fa; }
        [data-theme="dark"] .krisp-stats { background: rgba(30,41,59,0.5); }
        [data-theme="dark"] .btn-copy, [data-theme="dark"] .btn-toggle-visibility { background: rgba(30,41,59,0.8); border-color: rgba(255,255,255,0.1); }
      </style>
    `,t.querySelectorAll(".btn-copy").forEach(g=>{d(g,"click",()=>{const f=g.getAttribute("data-copy")||"";navigator.clipboard.writeText(f),m.success("Copied to clipboard")})});const i=t.querySelector("#toggle-secret-btn"),r=t.querySelector("#krisp-secret-input");i&&r&&d(i,"click",()=>{r.type=r.type==="password"?"text":"password"});const c=t.querySelector("#mcp-import-btn");c&&d(c,"click",async()=>{K(Ks);const{showKrispManager:g}=await xe(async()=>{const{showKrispManager:f}=await import("./KrispManager-GdNHfUwe.js");return{showKrispManager:f}},__vite__mapDeps([0,1]));g("import")});const l=t.querySelector("#toggle-krisp-btn");l&&d(l,"click",async()=>{const g=!a.is_active;await ww(g)?(m.success(g?"Krisp integration enabled":"Krisp integration disabled"),hi(e)):m.error("Failed to update integration")});const u=t.querySelector("#regenerate-krisp-btn");u&&d(u,"click",async()=>{if(!confirm("Are you sure? You will need to update the webhook URL in Krisp."))return;await yw()?(m.success("Credentials regenerated"),hi(e)):m.error("Failed to regenerate credentials")});const p=t.querySelector("#view-transcripts-btn");p&&d(p,"click",async g=>{g.preventDefault(),K(Ks);const{showKrispManager:f}=await xe(async()=>{const{showKrispManager:h}=await import("./KrispManager-GdNHfUwe.js");return{showKrispManager:h}},__vite__mapDeps([0,1]));f()})}catch(a){console.error("[ProfileModal] Krisp integration error:",a),t.innerHTML=`
      <div class="error-message">
        <p>Failed to load Krisp integration. Please try again.</p>
        <button type="button" class="btn-sota secondary" id="retry-krisp-btn">Retry</button>
      </div>
    `;const o=t.querySelector("#retry-krisp-btn");o&&d(o,"click",()=>hi(e))}}function hv(){K(Ks)}function lT(e,t={}){e.innerHTML="";const n=vv();e.appendChild(n),fv(n,{onBack:t.onBack})}const dT=Object.freeze(Object.defineProperty({__proto__:null,closeProfileModal:hv,initProfilePage:lT,showProfileModal:gv},Symbol.toStringTag,{value:"Module"})),gs="fact-modal";function ed(e){const t=e.mode==="create"?"Add Fact":e.mode==="edit"?"Edit Fact":"View Fact",n=Pe({id:gs,title:t,size:"md",content:uT(e),onClose:e.onClose});document.body.appendChild(n),De(gs)}function uT(e){const t=b("div",{className:"fact-modal-content"}),n=e.fact,s=e.mode==="view";return t.innerHTML=`
    <form id="fact-form" class="fact-form">
      <div class="form-group">
        <label for="content">Fact Content *</label>
        <textarea id="content" name="content" rows="4" required 
                  ${s?"disabled":""}
                  placeholder="Enter the fact...">${li(n?.content||"")}</textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="source">Source</label>
          <input type="text" id="source" name="source" 
                 ${s?"disabled":""}
                 value="${li(n?.source||"")}"
                 placeholder="Document, conversation, etc.">
        </div>
        <div class="form-group">
          <label for="category">Category</label>
          <input type="text" id="category" name="category" 
                 ${s?"disabled":""}
                 value="${li(n?.category||"")}"
                 placeholder="Technical, Business, etc.">
        </div>
      </div>

      ${n?.verified?`
        <div class="verified-info">
          <span class="verified-badge">‚úì Verified</span>
          ${n.verified_by?`<span>by ${li(n.verified_by)}</span>`:""}
          ${n.verified_at?`<span>on ${mc(n.verified_at)}</span>`:""}
        </div>
      `:""}

      ${n?.source_file?`
        <div class="source-file">
          <span class="label">Source File:</span>
          <span class="value">${li(n.source_file)}</span>
        </div>
      `:""}

      ${n?`
        <div class="metadata">
          <span>Created: ${mc(n.created_at)}</span>
          ${n.updated_at?`<span>Updated: ${mc(n.updated_at)}</span>`:""}
        </div>
      `:""}

      <div class="form-actions">
        ${e.mode==="view"?`
          <button type="button" class="btn btn-secondary" id="edit-btn">Edit</button>
          ${n?.verified?"":'<button type="button" class="btn btn-success" id="verify-btn">Verify</button>'}
          <button type="button" class="btn btn-danger" id="delete-btn">Delete</button>
        `:`
          <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn btn-primary">
            ${e.mode==="create"?"Add Fact":"Save Changes"}
          </button>
        `}
      </div>
    </form>
  `,pT(t,e),t}function pT(e,t){const n=e.querySelector("#fact-form");n&&d(n,"submit",async r=>{r.preventDefault();const c=new FormData(n),l={content:c.get("content"),source:c.get("source")||void 0,category:c.get("category")||void 0};if(!l.content.trim()){m.error("Fact content is required");return}try{let u;t.mode==="create"?(u=await nt.create(l),m.success("Fact added")):(u=await nt.update(t.fact.id,l),m.success("Fact updated")),K(gs),t.onSave?.(u)}catch{m.error("Failed to save fact")}});const s=e.querySelector("#cancel-btn");s&&d(s,"click",()=>{K(gs)});const a=e.querySelector("#edit-btn");a&&d(a,"click",()=>{K(gs),ed({...t,mode:"edit"})});const o=e.querySelector("#verify-btn");o&&t.fact&&d(o,"click",async()=>{try{const r=await nt.verify(t.fact.id);m.success("Fact verified"),K(gs),t.onSave?.(r)}catch{m.error("Failed to verify fact")}});const i=e.querySelector("#delete-btn");i&&t.fact&&d(i,"click",async()=>{if(confirm("Are you sure you want to delete this fact?"))try{await nt.delete(t.fact.id),m.success("Fact deleted"),K(gs),t.onDelete?.(t.fact.id)}catch{m.error("Failed to delete fact")}})}function mc(e){return new Date(e).toLocaleDateString()}function li(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function bv(){K(gs)}const _r=Object.freeze(Object.defineProperty({__proto__:null,closeFactModal:bv,showFactModal:ed},Symbol.toStringTag,{value:"Module"}));function sp(e,t){const n=document.querySelector(".conversation-preview-overlay");n&&n.remove();const s=document.createElement("div");s.className="conversation-preview-modal",s.innerHTML=`
    <style>
      .conversation-preview-modal {
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-height: 800px;
        width: 900px;
        max-width: 95vw;
      }
      .conv-preview-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), transparent);
      }
      .conv-preview-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: rgba(var(--primary-rgb), 0.1);
        border-radius: 12px;
      }
      .conv-preview-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 4px 0;
      }
      .conv-preview-meta {
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        gap: 16px;
      }
      .conv-preview-tabs {
        display: flex;
        gap: 4px;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .conv-preview-tab {
        padding: 12px 16px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s ease;
      }
      .conv-preview-tab:hover {
        color: var(--text-primary);
      }
      .conv-preview-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .conv-preview-tab-badge {
        background: var(--bg-tertiary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 6px;
      }
      .conv-preview-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
      }
      .conv-preview-section {
        display: none;
      }
      .conv-preview-section.active {
        display: block;
      }
      .messages-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .message-item {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
      }
      .message-speaker {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 4px;
      }
      .message-text {
        color: var(--text-primary);
        line-height: 1.5;
      }
      .message-time {
        font-size: 11px;
        color: var(--text-tertiary);
        margin-top: 4px;
      }
      .entity-card {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .entity-type {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }
      .entity-content {
        color: var(--text-primary);
      }
      .entity-meta {
        font-size: 12px;
        color: var(--text-tertiary);
        margin-top: 4px;
      }
      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
      }
      .empty-section {
        text-align: center;
        padding: 40px;
        color: var(--text-tertiary);
      }
      .notes-rendered {
        padding: 20px;
        background: var(--bg-secondary);
        border-radius: 12px;
        line-height: 1.7;
      }
      .notes-header {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .notes-meta {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      }
      .notes-topic {
        margin-bottom: 20px;
      }
      .notes-topic-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 10px;
        padding-left: 8px;
        border-left: 3px solid var(--primary);
      }
      .notes-bullet {
        padding: 10px 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 14px;
        line-height: 1.6;
      }
    </style>
    
    <div class="conv-preview-header">
      <div class="conv-preview-icon">üí¨</div>
      <div class="conv-preview-header-fill">
        <h2 class="conv-preview-title">${ft(e.title||"Untitled Conversation")}</h2>
        <div class="conv-preview-meta">
          <span>${e.participants?.length||0} participants</span>
          <span>${e.messages?.length||0} messages</span>
          <span>${Ce(e.created_at)}</span>
        </div>
      </div>
      <button class="btn btn-sm conv-preview-close-btn">√ó</button>
    </div>
    
    <div class="conv-preview-tabs">
      <button class="conv-preview-tab active" data-tab="messages">Messages</button>
      <button class="conv-preview-tab" data-tab="entities">
        Entities
        <span class="conv-preview-tab-badge" id="entities-count">0</span>
      </button>
      <button class="conv-preview-tab" data-tab="extraction">
        Extraction
        <span class="conv-preview-tab-badge" id="extraction-count">0</span>
      </button>
      <button class="conv-preview-tab hidden" data-tab="notes" id="notes-tab">
        Notes
      </button>
    </div>
    
    <div class="conv-preview-body">
      <div class="conv-preview-section active" data-section="messages" id="messages-container">
        <div class="messages-list">
          ${(e.messages||[]).map(r=>`
            <div class="message-item">
              <div class="message-speaker">${ft(r.speaker||"Unknown")}</div>
              <div class="message-text">${ft(r.text||"")}</div>
              ${r.timestamp?`<div class="message-time">${r.timestamp}</div>`:""}
            </div>
          `).join("")}
        </div>
      </div>
      
      <div class="conv-preview-section" data-section="entities" id="entities-container">
        <div class="empty-section">Loading entities...</div>
      </div>
      
      <div class="conv-preview-section" data-section="extraction" id="extraction-container">
        <div class="empty-section">Loading extraction results...</div>
      </div>
      
      <div class="conv-preview-section" data-section="notes" id="notes-container">
        <div class="empty-section">No notes available</div>
      </div>
    </div>
  `,s.querySelectorAll(".conv-preview-tab").forEach(r=>{r.addEventListener("click",()=>{const c=r.dataset.tab;s.querySelectorAll(".conv-preview-tab").forEach(l=>l.classList.remove("active")),r.classList.add("active"),s.querySelectorAll(".conv-preview-section").forEach(l=>l.classList.remove("active")),s.querySelector(`[data-section="${c}"]`)?.classList.add("active")})}),s.querySelector(".close-btn")?.addEventListener("click",()=>{a.remove()}),mT(s,e);const a=document.createElement("div");a.className="modal-overlay overlay-preview conversation-preview-overlay";const o=document.createElement("div");o.className="modal-preview-box",o.appendChild(s),a.appendChild(o),a.addEventListener("click",r=>{r.target===a&&a.remove()});const i=r=>{r.key==="Escape"&&(a.remove(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i),document.body.appendChild(a)}function mT(e,t){const n=t.metadata,s=n?.extraction_result,a=n?.extractedEntities||s?.entities||[],o=e.querySelector("#entities-container"),i=e.querySelector("#entities-count");i&&(i.textContent=String(a.length)),a.length>0?o.innerHTML=a.map(x=>`
      <div class="entity-card">
        <div class="entity-type">${ft(x.type)}</div>
        <div class="entity-content">${ft(x.name)}</div>
        ${x.confidence?`<div class="entity-meta">Confidence: ${Math.round(x.confidence*100)}%</div>`:""}
      </div>
    `).join(""):o.innerHTML='<div class="empty-section">No entities extracted</div>';const r=e.querySelector("#extraction-container"),c=s?.facts||[],l=s?.decisions||[],u=s?.action_items||[],p=s?.questions||[],g=e.querySelector("#extraction-count"),f=c.length+l.length+u.length+p.length;if(g&&(g.textContent=String(f)),f>0){let x="";c.length>0&&(x+=`<div class="section-title">Facts (${c.length})</div>`,x+=c.map($=>`
        <div class="entity-card">
          <div class="entity-type">${$.category||"fact"}</div>
          <div class="entity-content">${ft($.content)}</div>
        </div>
      `).join("")),l.length>0&&(x+=`<div class="section-title section-title-mt">Decisions (${l.length})</div>`,x+=l.map($=>`
        <div class="entity-card">
          <div class="entity-content">${ft($.content)}</div>
        </div>
      `).join("")),u.length>0&&(x+=`<div class="section-title section-title-mt">Action Items (${u.length})</div>`,x+=u.map($=>`
        <div class="entity-card">
          <div class="entity-content">${ft($.task)}</div>
          ${$.owner?`<div class="entity-meta">Owner: ${ft($.owner)}</div>`:""}
        </div>
      `).join("")),p.length>0&&(x+=`<div class="section-title section-title-mt">Questions (${p.length})</div>`,x+=p.map($=>`
        <div class="entity-card">
          <div class="entity-content">${ft($.content)}</div>
        </div>
      `).join("")),r.innerHTML=x}else r.innerHTML='<div class="empty-section">No extraction results available</div>';const h=e.querySelector("#notes-container"),k=e.querySelector("#notes-tab"),C=s?.notes_rendered_text;if(C)k&&k.classList.remove("hidden"),h.innerHTML=`
      <div class="notes-rendered">
        ${gT(C)}
        <div class="conv-notes-actions-mt">
          <button class="btn btn-secondary btn-sm" id="copy-notes-btn">üìã Copy Notes</button>
        </div>
      </div>
    `,e.querySelector("#copy-notes-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(C),m.success("Notes copied to clipboard")});else if(s?.notes?.outline?.length){k&&k.classList.remove("hidden");const x=s.notes.outline;h.innerHTML=`
      <div class="notes-rendered">
        ${x.map($=>`
          <div class="notes-topic">
            <div class="notes-topic-title">${ft($.topic)}</div>
            ${$.bullets?.map(w=>`<div class="notes-bullet">${ft(w.text)}</div>`).join("")||""}
          </div>
        `).join("")}
      </div>
    `}}function gT(e){const t=e.split(`
`);let n="",s="",a="",o=!1,i=!1;const r=()=>{s&&a&&(n+=`
        <div class="notes-topic">
          <div class="notes-topic-title">${ft(s)}</div>
          ${a}
        </div>
      `),s="",a=""};for(const c of t){const l=c.trim();if(l){if(!o&&l.startsWith("üìù")){n+=`<div class="notes-header">${ft(l)}</div>`,o=!0;continue}if(!i&&l.startsWith("üïû")){n+=`<div class="notes-meta">${ft(l)}</div>`,i=!0;continue}if(l.startsWith("-")){const u=l.substring(1).trim();a+=`<div class="notes-bullet">${ft(u)}</div>`;continue}r(),s=l}}return r(),n.includes("notes-topic")?n:`<pre class="conv-notes-pre">${ft(e)}</pre>`}function ft(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ap(e,t){const n=document.querySelector(".email-preview-overlay");n&&n.remove();const s=e.extracted_entities,a=s&&(s.key_points?.length||s.action_items?.length||s.entities?.length),o=document.createElement("div");o.className="email-preview-modal",o.innerHTML=`
    <style>
      .email-preview-modal {
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-height: 800px;
        width: 900px;
        max-width: 95vw;
      }
      .email-preview-header {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), transparent);
      }
      .email-preview-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: rgba(var(--primary-rgb), 0.1);
        border-radius: 12px;
        flex-shrink: 0;
      }
      .email-preview-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 8px 0;
        line-height: 1.3;
      }
      .email-preview-meta {
        font-size: 13px;
        color: var(--text-secondary);
      }
      .email-preview-meta-row {
        display: flex;
        gap: 8px;
        margin-bottom: 4px;
      }
      .email-preview-meta-label {
        color: var(--text-tertiary);
        min-width: 40px;
      }
      .email-preview-badges {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }
      .email-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .email-badge.intent {
        background: rgba(var(--primary-rgb), 0.1);
        color: var(--primary);
      }
      .email-badge.sentiment-positive {
        background: rgba(46, 160, 67, 0.1);
        color: #2ea043;
      }
      .email-badge.sentiment-negative {
        background: rgba(248, 81, 73, 0.1);
        color: #f85149;
      }
      .email-badge.sentiment-neutral {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }
      .email-badge.response-needed {
        background: rgba(248, 81, 73, 0.1);
        color: #f85149;
      }
      .email-preview-tabs {
        display: flex;
        gap: 4px;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .email-preview-tab {
        padding: 12px 16px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s ease;
      }
      .email-preview-tab:hover {
        color: var(--text-primary);
      }
      .email-preview-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .email-preview-tab-badge {
        background: var(--bg-tertiary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 6px;
      }
      .email-preview-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
      }
      .email-preview-section {
        display: none;
      }
      .email-preview-section.active {
        display: block;
      }
      .email-content-body {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 12px;
        line-height: 1.7;
      }
      .extraction-card {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .extraction-type {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }
      .extraction-content {
        color: var(--text-primary);
      }
      .extraction-meta {
        font-size: 12px;
        color: var(--text-tertiary);
        margin-top: 4px;
      }
      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
      }
      .empty-section {
        text-align: center;
        padding: 40px;
        color: var(--text-tertiary);
      }
      .ai-summary-box {
        padding: 16px;
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), transparent);
        border-left: 3px solid var(--primary);
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .ai-summary-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .key-points-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .key-points-list li {
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        gap: 8px;
      }
      .key-points-list li:last-child {
        border-bottom: none;
      }
      .key-points-list li::before {
        content: "‚Ä¢";
        color: var(--primary);
      }
      .contact-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .contact-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--text-secondary);
      }
      .contact-info {
        flex: 1;
      }
      .contact-name {
        font-weight: 600;
      }
      .contact-details {
        font-size: 12px;
        color: var(--text-secondary);
      }
    </style>
    
    <div class="email-preview-header">
      <div class="email-preview-icon">üìß</div>
      <div class="email-preview-header-fill">
        <h2 class="email-preview-title">${dt(e.subject||"No Subject")}</h2>
        <div class="email-preview-meta">
          <div class="email-preview-meta-row">
            <span class="email-preview-meta-label">From:</span>
            <span><strong>${dt(e.from?.name||"")}</strong> &lt;${dt(e.from?.email||"")}&gt;</span>
          </div>
          <div class="email-preview-meta-row">
            <span class="email-preview-meta-label">To:</span>
            <span>${(e.to||[]).map(l=>dt(l.name||l.email)).join(", ")}</span>
          </div>
          <div class="email-preview-meta-row">
            <span class="email-preview-meta-label">Date:</span>
            <span>${Ce(e.date)}</span>
          </div>
        </div>
        <div class="email-preview-badges">
          ${s?.intent?`<span class="email-badge intent">üìã ${dt(s.intent)}</span>`:""}
          ${s?.sentiment?`<span class="email-badge sentiment-${s.sentiment}">${vT(s.sentiment)} ${dt(s.sentiment)}</span>`:""}
          ${e.requires_response?'<span class="email-badge response-needed">‚ö†Ô∏è Response Needed</span>':""}
        </div>
      </div>
      <button class="btn btn-sm email-preview-close-btn">√ó</button>
    </div>
    
    <div class="email-preview-tabs">
      <button class="email-preview-tab active" data-tab="content">Content</button>
      <button class="email-preview-tab ${a?"":"hidden"}" data-tab="analysis">
        Analysis
      </button>
      <button class="email-preview-tab ${s?.entities?.length?"":"hidden"}" data-tab="entities">
        Entities
        <span class="email-preview-tab-badge">${s?.entities?.length||0}</span>
      </button>
      <button class="email-preview-tab ${s?.contacts?.length?"":"hidden"}" data-tab="contacts">
        Contacts
        <span class="email-preview-tab-badge">${s?.contacts?.length||0}</span>
      </button>
    </div>
    
    <div class="email-preview-body">
      <div class="email-preview-section active" data-section="content">
        ${s?.summary||e.ai_summary?`
          <div class="ai-summary-box">
            <div class="ai-summary-label">ü§ñ AI Summary</div>
            <div>${dt(s?.summary||e.ai_summary||"")}</div>
          </div>
        `:""}
        <div class="email-content-body">
          ${e.body_html||dt(e.body||"").replace(/\n/g,"<br>")}
        </div>
      </div>
      
      <div class="email-preview-section" data-section="analysis">
        ${s?.key_points?.length?`
          <div class="section-title">Key Points</div>
          <ul class="key-points-list">
            ${s.key_points.map(l=>`<li>${dt(l)}</li>`).join("")}
          </ul>
        `:""}
        
        ${s?.action_items?.length?`
          <div class="section-title section-title-mt">Action Items</div>
          ${s.action_items.map(l=>`
            <div class="extraction-card">
              <div class="extraction-content">‚òê ${dt(l.task)}</div>
              ${l.owner?`<div class="extraction-meta">Owner: ${dt(l.owner)}</div>`:""}
            </div>
          `).join("")}
        `:""}
        
        ${s?.questions?.length?`
          <div class="section-title section-title-mt">Questions</div>
          ${s.questions.map(l=>`
            <div class="extraction-card">
              <div class="extraction-content">‚ùì ${dt(l)}</div>
            </div>
          `).join("")}
        `:""}
        
        ${!s?.key_points?.length&&!s?.action_items?.length&&!s?.questions?.length?`
          <div class="empty-section">No analysis available</div>
        `:""}
      </div>
      
      <div class="email-preview-section" data-section="entities">
        ${s?.entities?.length?s.entities.map(l=>`
          <div class="extraction-card">
            <div class="extraction-type">${dt(l.type)}</div>
            <div class="extraction-content">${dt(l.name)}</div>
            ${l.confidence?`<div class="extraction-meta">Confidence: ${Math.round(l.confidence*100)}%</div>`:""}
          </div>
        `).join(""):'<div class="empty-section">No entities extracted</div>'}
      </div>
      
      <div class="email-preview-section" data-section="contacts">
        ${s?.contacts?.length?s.contacts.map(l=>`
          <div class="contact-card">
            <div class="contact-avatar">${fT(l.name)}</div>
            <div class="contact-info">
              <div class="contact-name">${dt(l.name)}</div>
              <div class="contact-details">
                ${l.title?dt(l.title)+(l.organization?" at ":""):""}
                ${l.organization?dt(l.organization):""}
                ${l.email?`<br>${dt(l.email)}`:""}
              </div>
            </div>
          </div>
        `).join(""):'<div class="empty-section">No contacts extracted</div>'}
      </div>
    </div>
  `,o.querySelectorAll(".email-preview-tab").forEach(l=>{l.addEventListener("click",()=>{const u=l.dataset.tab;o.querySelectorAll(".email-preview-tab").forEach(p=>p.classList.remove("active")),l.classList.add("active"),o.querySelectorAll(".email-preview-section").forEach(p=>p.classList.remove("active")),o.querySelector(`[data-section="${u}"]`)?.classList.add("active")})}),o.querySelector(".close-btn")?.addEventListener("click",()=>{i.remove()});const i=document.createElement("div");i.className="modal-overlay overlay-preview email-preview-overlay";const r=document.createElement("div");r.className="modal-preview-box",r.appendChild(o),i.appendChild(r),i.addEventListener("click",l=>{l.target===i&&i.remove()});const c=l=>{l.key==="Escape"&&(i.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),document.body.appendChild(i)}function vT(e){switch(e?.toLowerCase()){case"positive":return"üòä";case"negative":return"üòü";default:return"üòê"}}function fT(e){return e.split(" ").map(t=>t[0]).slice(0,2).join("").toUpperCase()}function dt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let al=null,yo=!1;function yv(e={}){const t=b("div",{className:"briefing-panel"});t.innerHTML=`
    <div class="briefing-header">
      <h2>Daily Briefing</h2>
      <div class="briefing-actions">
        <button class="btn btn-sm" id="toggle-history-btn">History</button>
        <button class="btn btn-sm btn-primary" id="refresh-briefing-btn">Refresh</button>
      </div>
    </div>
    <div class="briefing-content" id="briefing-content">
      <div class="loading">Generating briefing...</div>
    </div>
    <div class="briefing-history hidden" id="briefing-history"></div>
  `;const n=t.querySelector("#refresh-briefing-btn");n&&d(n,"click",()=>ip(t,!0,e));const s=t.querySelector("#toggle-history-btn");return s&&d(s,"click",()=>{yo=!yo;const a=t.querySelector("#briefing-history");a.classList.toggle("hidden",!yo),yo&&hT(a)}),ip(t,!1,e),t}async function ip(e,t,n){const s=e.querySelector("#briefing-content");s.innerHTML='<div class="loading">Generating briefing...</div>';try{const a=await Ri.getBriefing(t);al=a,wv(s,a,n)}catch{s.innerHTML='<div class="error">Failed to generate briefing</div>'}}function wv(e,t,n){e.innerHTML=`
    <div class="briefing-meta">
      <span class="briefing-date">${td(t.generated_at)}</span>
      ${t.cached?'<span class="cached-badge">Cached</span>':""}
    </div>

    <div class="briefing-text">
      ${il(t.briefing)}
    </div>

    ${t.analysis?`
      <div class="briefing-analysis">
        <h4>Analysis</h4>
        <div class="analysis-content">${il(t.analysis)}</div>
      </div>
    `:""}

  `}async function hT(e){e.innerHTML='<div class="loading">Loading history...</div>';try{const t=await Ri.getBriefingHistory(10);if(!t||t.length===0){e.innerHTML='<p class="empty">No previous briefings</p>';return}e.innerHTML=`
      <h4>Previous Briefings</h4>
      <div class="history-list">
        ${t.map(n=>`
          <div class="history-item" data-id="${n.id}">
            <div class="history-date">${td(n.generated_at)}</div>
            <div class="history-preview">${yT(n.briefing.substring(0,150))}...</div>
          </div>
        `).join("")}
      </div>
    `,e.querySelectorAll(".history-item").forEach(n=>{d(n,"click",()=>{const s=n.getAttribute("data-id"),a=t.find(o=>o.id===s);a&&bT(e.closest(".briefing-panel"),a)})})}catch{e.innerHTML='<div class="error">Failed to load history</div>'}}function bT(e,t){const n=e.querySelector("#briefing-content");n.innerHTML=`
    <div class="history-detail">
      <button class="btn btn-sm back-btn" id="back-to-current">‚Üê Back to current</button>
      <div class="briefing-meta">
        <span class="briefing-date">${td(t.generated_at)}</span>
        <span class="history-badge">Historical</span>
      </div>
      <div class="briefing-text">${il(t.briefing)}</div>
    </div>
  `;const s=n.querySelector("#back-to-current");s&&al&&d(s,"click",()=>{wv(n,al)})}function il(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*$)/gm,"<h5>$1</h5>").replace(/^## (.*$)/gm,"<h4>$1</h4>").replace(/^# (.*$)/gm,"<h3>$1</h3>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/gs,"<ul>$1</ul>").replace(/\n\n/g,"</p><p>").replace(/^(.+)$/gm,"<p>$1</p>").replace(/<p><\/p>/g,"").replace(/<p>(<[hul])/g,"$1").replace(/(<\/[hul][^>]*>)<\/p>/g,"$1")}function td(e){return new Date(e).toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function yT(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const wT=Object.freeze(Object.defineProperty({__proto__:null,createBriefingPanel:yv},Symbol.toStringTag,{value:"Module"}));let bi="",Qo="weekly";function kT(e={}){const t=b("div",{className:"reports-panel"});t.innerHTML=`
    <div class="reports-header">
      <h2>Reports</h2>
      <div class="reports-actions">
        <button class="btn btn-sm" id="export-md-btn">Export MD</button>
        <button class="btn btn-sm btn-primary" id="export-pdf-btn">Export PDF</button>
      </div>
    </div>
    <div class="reports-tabs">
      <button class="report-tab active" data-type="weekly">Weekly Report</button>
      <button class="report-tab" data-type="executive">Executive Summary</button>
    </div>
    <div class="reports-content" id="reports-content">
      <div class="loading">Generating report...</div>
    </div>
  `;const n=t.querySelectorAll(".report-tab");n.forEach(o=>{d(o,"click",()=>{n.forEach(i=>i.classList.remove("active")),o.classList.add("active"),Qo=o.getAttribute("data-type"),op(t,Qo)})});const s=t.querySelector("#export-md-btn");s&&d(s,"click",()=>rp("md",e));const a=t.querySelector("#export-pdf-btn");return a&&d(a,"click",()=>rp("pdf",e)),op(t,"weekly"),t}async function op(e,t){const n=e.querySelector("#reports-content");n.innerHTML='<div class="loading">Generating report...</div>';try{let s;t==="weekly"?s=await Ri.getWeeklyReport():s=await Ri.generateExecutiveSummary(),bi=s,xT(n,s)}catch{n.innerHTML='<div class="error">Failed to generate report</div>'}}function xT(e,t){e.innerHTML=`
    <div class="report-preview">
      ${ol(t)}
    </div>
  `}async function rp(e,t){if(!bi){m.error("No report to export");return}if(t.onExport){t.onExport(e,bi);return}e==="md"?(kv(`${Qo}-report.md`,bi,"text/markdown"),m.success("Report downloaded")):e==="pdf"&&await $T(bi,`${Qo}-report`)}function kv(e,t,n){const s=new Blob([t],{type:n}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}async function $T(e,t){const n=window.html2pdf;if(!n){const a=`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>${t}</title>
        <style>
          body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; }
          h1 { color: #1a1a2e; }
          h2 { color: #16213e; border-bottom: 1px solid #eee; padding-bottom: 10px; }
          h3 { color: #0f3460; }
          ul { padding-left: 20px; }
          li { margin: 5px 0; }
        </style>
      </head>
      <body>
        ${ol(e)}
      </body>
      </html>
    `;kv(`${t}.html`,a,"text/html"),m.info("Downloaded as HTML (PDF library not available)");return}const s=document.createElement("div");s.className="report-pdf-container",s.innerHTML=ol(e),document.body.appendChild(s);try{await n(s).save(`${t}.pdf`),m.success("PDF exported")}catch{m.error("Failed to export PDF")}finally{document.body.removeChild(s)}}function ol(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/gs,"<ul>$1</ul>").replace(/\n\n/g,"</p><p>").replace(/^(.+)$/gm,"<p>$1</p>").replace(/<p><\/p>/g,"").replace(/<p>(<[hul])/g,"$1").replace(/(<\/[hul][^>]*>)<\/p>/g,"$1")}let Jo="",ka={},xv=[],es=new Set;function $v(e={}){const t=b("div",{className:"contacts-panel-sota"});return t.innerHTML=`
    <style>
      .contacts-panel-sota {
        padding: 24px;
        min-height: 100%;
      }

      /* Header */
      .contacts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .contacts-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .contacts-title-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
      }

      .contacts-title-icon svg {
        width: 26px;
        height: 26px;
        color: white;
      }

      .contacts-title h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .contacts-count {
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      .contacts-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Search Bar */
      .contacts-search-wrapper {
        position: relative;
        flex: 1;
        max-width: 400px;
        min-width: 200px;
      }

      .contacts-search-wrapper svg {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: var(--text-tertiary);
        pointer-events: none;
        transition: color 0.2s;
      }

      .contacts-search {
        width: 100%;
        padding: 12px 14px 12px 44px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s;
      }

      .contacts-search:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }

      .contacts-search:focus + svg {
        color: #e11d48;
      }

      /* SOTA Buttons */
      .btn-sota {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
      }

      .btn-sota.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(225, 29, 72, 0.4);
      }

      .btn-sota.secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-sota.secondary:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
      }

      .btn-sota svg {
        width: 16px;
        height: 16px;
      }

      /* Filters */
      .contacts-filters {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .filter-chip:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
        color: #e11d48;
      }

      .filter-chip.active {
        background: linear-gradient(135deg, rgba(225,29,72,0.1) 0%, rgba(225,29,72,0.05) 100%);
        border-color: #e11d48;
        color: #e11d48;
      }

      .filter-chip svg {
        width: 14px;
        height: 14px;
      }

      .filter-select {
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 13px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
      }

      .filter-select:focus {
        outline: none;
        border-color: #e11d48;
      }

      /* Alerts */
      .contacts-alerts {
        margin-bottom: 20px;
      }

      .alert-sota {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(245,158,11,0.05) 100%);
        border: 1px solid rgba(245,158,11,0.3);
        border-radius: 12px;
        color: #d97706;
      }

      .alert-sota svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .alert-sota span {
        flex: 1;
        font-size: 14px;
      }

      .alert-sota .btn-sota {
        padding: 6px 12px;
        font-size: 12px;
      }

      /* Favorites Section */
      .favorites-section {
        margin-bottom: 28px;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 14px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .section-header svg {
        width: 16px;
        height: 16px;
        color: #f59e0b;
      }

      .favorites-grid {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
      }

      .favorite-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(245,158,11,0.02) 100%);
        border: 1px solid rgba(245,158,11,0.2);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .favorite-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245,158,11,0.15);
        border-color: #f59e0b;
      }

      .favorite-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .favorite-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .favorite-info h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .favorite-info p {
        margin: 2px 0 0 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Contacts Grid */
      .contacts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      .contact-card-sota {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.5) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
      }

      [data-theme="dark"] .contact-card-sota {
        background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(30,41,59,0.5) 100%);
      }

      .contact-card-sota:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0,0,0,0.1);
        border-color: rgba(225,29,72,0.3);
      }

      .contact-card-sota::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #e11d48, #f59e0b);
        opacity: 0;
        transition: opacity 0.2s;
      }

      .contact-card-sota:hover::before {
        opacity: 1;
      }

      .contact-card-header {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        margin-bottom: 14px;
      }

      .contact-avatar-sota {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(225,29,72,0.25);
      }

      .contact-avatar-sota img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .contact-main-info {
        flex: 1;
        min-width: 0;
      }

      .contact-name-sota {
        margin: 0 0 4px 0;
        font-size: 17px;
        font-weight: 700;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .contact-role-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: linear-gradient(135deg, rgba(225,29,72,0.1) 0%, rgba(225,29,72,0.05) 100%);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        color: #e11d48;
        margin-bottom: 4px;
      }

      .contact-org-sota {
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .contact-org-sota svg {
        width: 14px;
        height: 14px;
        opacity: 0.6;
      }

      .contact-details-sota {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
      }

      .contact-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .contact-detail-item svg {
        width: 14px;
        height: 14px;
        color: #e11d48;
        flex-shrink: 0;
      }

      .contact-detail-item span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .contact-tags-sota {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
      }

      .contact-tag {
        padding: 3px 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .contact-quick-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .contact-card-sota:hover .contact-quick-actions {
        opacity: 1;
      }

      .quick-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quick-action-btn:hover {
        background: #e11d48;
        border-color: #e11d48;
        color: white;
      }

      .quick-action-btn.favorite {
        color: #f59e0b;
      }

      .quick-action-btn.favorite.active {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
      }

      .quick-action-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Selection Checkbox */
      .contact-select-checkbox {
        position: absolute;
        top: 12px;
        left: 12px;
        width: 22px;
        height: 22px;
        border-radius: 6px;
        border: 2px solid var(--border-color);
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 5;
        opacity: 0;
      }

      .contact-card-sota:hover .contact-select-checkbox,
      .contact-card-sota.selected .contact-select-checkbox {
        opacity: 1;
      }

      .contact-select-checkbox:hover {
        border-color: #e11d48;
      }

      .contact-select-checkbox.checked {
        background: linear-gradient(135deg, #e11d48, #be123c);
        border-color: #e11d48;
      }

      .contact-select-checkbox svg {
        width: 14px;
        height: 14px;
        color: white;
        display: none;
      }

      .contact-select-checkbox.checked svg {
        display: block;
      }

      .contact-card-sota.selected {
        border-color: #e11d48;
        box-shadow: 0 0 0 2px rgba(225,29,72,0.2);
      }

      /* Selection Bar */
      .selection-bar {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #1e293b, #0f172a);
        padding: 12px 24px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }

      .selection-bar-count {
        color: white;
        font-size: 14px;
        font-weight: 600;
      }

      .selection-bar-count span {
        color: #f59e0b;
      }

      .selection-bar-btn {
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border: none;
      }

      .selection-bar-btn.merge {
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
      }

      .selection-bar-btn.merge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(225,29,72,0.4);
      }

      .selection-bar-btn.cancel {
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
      }

      .selection-bar-btn.cancel:hover {
        background: rgba(255,255,255,0.2);
      }

      .selection-bar-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Empty State */
      .contacts-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 24px;
        text-align: center;
      }

      .contacts-empty-state svg {
        width: 80px;
        height: 80px;
        color: #e11d48;
        opacity: 0.4;
        margin-bottom: 24px;
      }

      .contacts-empty-state h3 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .contacts-empty-state p {
        margin: 0 0 24px 0;
        font-size: 14px;
        color: var(--text-secondary);
      }

      /* Loading */
      .contacts-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: var(--text-secondary);
      }

      .contacts-loading::after {
        content: '';
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 12px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Projects indicator */
      .contact-projects-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-tertiary);
      }

      .contact-projects-indicator svg {
        width: 14px;
        height: 14px;
      }

      .project-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e11d48;
      }
    </style>

    <!-- Header -->
    <div class="contacts-header">
      <div class="contacts-title">
        <div class="contacts-title-icon">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
        </div>
        <h1>Contacts</h1>
        <span class="contacts-count" id="contacts-count">0</span>
      </div>

      <div class="contacts-actions">
        <div class="contacts-search-wrapper">
          <input type="search" class="contacts-search" id="contacts-search" placeholder="Search contacts...">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <button class="btn-sota secondary" id="import-contacts-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          Import
        </button>
        <button class="btn-sota secondary" id="export-contacts-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Export
        </button>
        <button class="btn-sota primary" id="add-contact-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Contact
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="contacts-filters">
      <div class="filter-chip" id="filter-favorites" data-filter="favorites">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
        </svg>
        Favorites
      </div>
      <select class="filter-select" id="org-filter">
        <option value="">All Organizations</option>
      </select>
      <select class="filter-select" id="tag-filter">
        <option value="">All Tags</option>
      </select>
    </div>

    <!-- Alerts -->
    <div class="contacts-alerts" id="contacts-alerts"></div>

    <!-- Favorites Section -->
    <div class="favorites-section hidden" id="favorites-section">
      <div class="section-header">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
        </svg>
        Favorites
      </div>
      <div class="favorites-grid" id="favorites-grid"></div>
    </div>

    <!-- Main Content -->
    <div id="contacts-content">
      <div class="contacts-loading">Loading contacts</div>
    </div>
  `,ST(t,e),hn(t,e),ET(t),t}function ST(e,t){const n=e.querySelector("#contacts-search");let s;d(n,"input",()=>{clearTimeout(s),s=window.setTimeout(()=>{Jo=n.value,hn(e,t)},300)});const a=e.querySelector("#org-filter");d(a,"change",()=>{ka.organization=a.value||void 0,hn(e,t)});const o=e.querySelector("#tag-filter");d(o,"change",()=>{ka.tag=o.value||void 0,hn(e,t)});const i=e.querySelector("#filter-favorites");i&&d(i,"click",()=>{i.classList.toggle("active"),ka.favorites=i.classList.contains("active"),hn(e,t)});const r=e.querySelector("#add-contact-btn");r&&d(r,"click",()=>{zn({mode:"create",onSave:()=>hn(e,t)})});const c=e.querySelector("#export-contacts-btn");c&&d(c,"click",()=>PT());const l=e.querySelector("#import-contacts-btn");l&&d(l,"click",()=>{m.info("Import functionality coming soon")})}async function hn(e,t){const n=e.querySelector("#contacts-content");n.innerHTML='<div class="contacts-loading">Loading contacts</div>';try{const{contacts:s,total:a}=await Ne.getAll({search:Jo||void 0,organization:ka.organization,tag:ka.tag});let o=s;ka.favorites&&(o=s.filter(i=>i.isFavorite)),xv=s,CT(n,o,t),Sv(e,s.filter(i=>i.isFavorite),t),DT(e,a),jT(e,s)}catch{n.innerHTML=`
      <div class="contacts-empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h3>Failed to load contacts</h3>
        <p>Please try again later</p>
      </div>
    `}}function CT(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="contacts-empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        <h3>${Jo?"No contacts match your search":"No contacts yet"}</h3>
        <p>${Jo?"Try a different search term":"Add your first contact to get started"}</p>
        <button class="btn-sota primary" id="empty-add-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Contact
        </button>
      </div>
    `;const s=e.querySelector("#empty-add-btn");s&&d(s,"click",()=>{zn({mode:"create"})});return}e.innerHTML=`
    <div class="contacts-grid">
      ${t.map(s=>_T(s)).join("")}
    </div>
  `,LT(e,t,n)}function _T(e){const t=nd(e.name),n=!!(e.photoUrl||e.avatarUrl),s=e.photoUrl||e.avatarUrl,a=es.has(e.id);return`
    <div class="contact-card-sota ${a?"selected":""}" data-id="${e.id}">
      <div class="contact-select-checkbox ${a?"checked":""}" data-action="select" data-id="${e.id}">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      <div class="contact-quick-actions">
        <button class="quick-action-btn favorite ${e.isFavorite?"active":""}" data-action="favorite" data-id="${e.id}" title="Toggle favorite">
          <svg fill="${e.isFavorite?"currentColor":"none"}" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
        </button>
        <button class="quick-action-btn" data-action="edit" data-id="${e.id}" title="Edit contact">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
        </button>
      </div>

      <div class="contact-card-header">
        <div class="contact-avatar-sota">
          ${n?`<img src="${s}" alt="${ut(e.name)}">`:t}
        </div>
        <div class="contact-main-info">
          <h3 class="contact-name-sota">${ut(e.name)}</h3>
          ${e.role?`<span class="contact-role-badge">${ut(e.role)}</span>`:""}
          ${e.organization?`
            <div class="contact-org-sota">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              ${ut(e.organization)}
            </div>
          `:""}
        </div>
      </div>

      <div class="contact-details-sota">
        ${e.email?`
          <div class="contact-detail-item">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <span>${ut(e.email)}</span>
          </div>
        `:""}
        ${e.phone?`
          <div class="contact-detail-item">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            <span>${ut(e.phone)}</span>
          </div>
        `:""}
      </div>

      ${e.tags&&e.tags.length>0?`
        <div class="contact-tags-sota">
          ${e.tags.slice(0,4).map(o=>`<span class="contact-tag">${ut(o)}</span>`).join("")}
          ${e.tags.length>4?`<span class="contact-tag">+${e.tags.length-4}</span>`:""}
        </div>
      `:""}
    </div>
  `}function LT(e,t,n){const s=e.closest(".contacts-panel-sota");e.querySelectorAll(".contact-select-checkbox").forEach(a=>{d(a,"click",o=>{o.stopPropagation();const i=a.getAttribute("data-id");if(!i)return;const r=a.closest(".contact-card-sota");es.has(i)?(es.delete(i),a.classList.remove("checked"),r.classList.remove("selected")):(es.add(i),a.classList.add("checked"),r.classList.add("selected")),n&&TT(s,t,n)})}),e.querySelectorAll(".contact-card-sota").forEach(a=>{d(a,"click",o=>{if(o.target.closest(".quick-action-btn")||o.target.closest(".contact-select-checkbox"))return;const i=a.getAttribute("data-id"),r=t.find(c=>String(c.id)===i);r&&(n?.onContactClick?n.onContactClick(r):zn({mode:"edit",contact:r,onSave:()=>hn(s,n)}))})}),e.querySelectorAll(".quick-action-btn").forEach(a=>{d(a,"click",async o=>{o.stopPropagation();const i=a.getAttribute("data-action"),r=a.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);c&&(i==="favorite"?n&&await MT(c,a,s,n):i==="edit"&&zn({mode:"edit",contact:c,onSave:()=>hn(s,n)}))})})}function TT(e,t,n){const s=document.querySelector(".selection-bar");if(s&&s.remove(),es.size<2)return;const a=b("div",{className:"selection-bar"});a.innerHTML=`
    <span class="selection-bar-count"><span>${es.size}</span> contacts selected</span>
    <button class="selection-bar-btn merge" id="merge-selected-btn">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
      </svg>
      Merge Selected
    </button>
    <button class="selection-bar-btn cancel" id="cancel-selection-btn">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Cancel
    </button>
  `,document.body.appendChild(a);const o=a.querySelector("#merge-selected-btn"),i=a.querySelector("#cancel-selection-btn");d(i,"click",()=>{cp(e)}),d(o,"click",async()=>{const r=Array.from(es),c=t.filter(u=>es.has(u.id));if(await AT(c)){o.disabled=!0,o.textContent="Merging...";try{await Ne.mergeContacts(r),m.success(`Merged ${r.length} contacts successfully`),cp(e),await hn(e,n)}catch(u){const p=u instanceof Error?u.message:"Failed to merge contacts";m.error(p),o.disabled=!1,o.innerHTML=`
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        Merge Selected
      `}}})}function AT(e){return new Promise(t=>{const n=b("div",{className:"merge-confirm-overlay"});e[0],e.slice(1),n.innerHTML=`
      <style>
        .merge-confirm-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(4px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        
        .merge-confirm-modal {
          background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
          border-radius: 16px;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          max-width: 480px;
          width: 90%;
          overflow: hidden;
          animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        
        .merge-confirm-header {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
          padding: 20px 24px;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .merge-confirm-header svg {
          width: 24px;
          height: 24px;
        }
        
        .merge-confirm-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
        }
        
        .merge-confirm-body {
          padding: 24px;
        }
        
        .merge-confirm-body p {
          margin: 0 0 16px 0;
          color: #64748b;
          font-size: 14px;
        }
        
        .merge-contact-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 16px;
        }
        
        .merge-contact-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          background: #f8fafc;
          border-radius: 10px;
          border: 1px solid #e2e8f0;
        }
        
        .merge-contact-item.primary {
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          border-color: #f59e0b;
        }
        
        .merge-contact-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 14px;
          flex-shrink: 0;
        }
        
        .merge-contact-avatar img {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
        }
        
        .merge-contact-info {
          flex: 1;
          min-width: 0;
        }
        
        .merge-contact-name {
          font-weight: 600;
          color: #1e293b;
          font-size: 14px;
          margin-bottom: 2px;
        }
        
        .merge-contact-details {
          font-size: 12px;
          color: #64748b;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .merge-contact-badge {
          background: #f59e0b;
          color: white;
          font-size: 10px;
          font-weight: 600;
          padding: 4px 8px;
          border-radius: 6px;
          text-transform: uppercase;
        }
        
        .merge-warning {
          display: flex;
          align-items: flex-start;
          gap: 10px;
          padding: 12px;
          background: #fef3c7;
          border-radius: 10px;
          margin-top: 16px;
        }
        
        .merge-warning svg {
          width: 18px;
          height: 18px;
          color: #d97706;
          flex-shrink: 0;
          margin-top: 1px;
        }
        
        .merge-warning p {
          margin: 0;
          color: #92400e;
          font-size: 13px;
          line-height: 1.5;
        }
        
        .merge-confirm-footer {
          display: flex;
          gap: 12px;
          padding: 16px 24px 24px;
          justify-content: flex-end;
        }
        
        .merge-confirm-btn {
          padding: 10px 20px;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .merge-confirm-btn.cancel {
          background: #f1f5f9;
          border: 1px solid #e2e8f0;
          color: #64748b;
        }
        
        .merge-confirm-btn.cancel:hover {
          background: #e2e8f0;
        }
        
        .merge-confirm-btn.confirm {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          border: none;
          color: white;
          box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
        }
        
        .merge-confirm-btn.confirm:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
        }
        
        .merge-confirm-btn svg {
          width: 16px;
          height: 16px;
        }
      </style>
      
      <div class="merge-confirm-modal">
        <div class="merge-confirm-header">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
          </svg>
          <h3>Merge Contacts</h3>
        </div>
        
        <div class="merge-confirm-body">
          <p>The following contacts will be merged into one:</p>
          
          <div class="merge-contact-list">
            ${e.map((r,c)=>{const l=r.photoUrl||r.avatarUrl||r.photo_url||r.avatar_url,u=(r.name||"?").split(" ").map(g=>g[0]).join("").substring(0,2).toUpperCase(),p=r.email||r.organization||r.company||"";return`
                <div class="merge-contact-item ${c===0?"primary":""}">
                  <div class="merge-contact-avatar">
                    ${l?`<img src="${l}" alt="${r.name}">`:u}
                  </div>
                  <div class="merge-contact-info">
                    <div class="merge-contact-name">${r.name||"Unknown"}</div>
                    <div class="merge-contact-details">${p}</div>
                  </div>
                  ${c===0?'<span class="merge-contact-badge">Primary</span>':""}
                </div>
              `}).join("")}
          </div>
          
          <div class="merge-warning">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>All information will be combined into the primary contact. Other contacts will be archived. This action cannot be undone.</p>
          </div>
        </div>
        
        <div class="merge-confirm-footer">
          <button class="merge-confirm-btn cancel" id="merge-cancel-btn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Cancel
          </button>
          <button class="merge-confirm-btn confirm" id="merge-confirm-btn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Merge Contacts
          </button>
        </div>
      </div>
    `,document.body.appendChild(n);const s=n.querySelector("#merge-cancel-btn"),a=n.querySelector("#merge-confirm-btn"),o=r=>{n.remove(),t(r)};d(s,"click",()=>o(!1)),d(a,"click",()=>o(!0)),d(n,"click",r=>{r.target===n&&o(!1)});const i=r=>{r.key==="Escape"&&(document.removeEventListener("keydown",i),o(!1))};document.addEventListener("keydown",i)})}function cp(e){es.clear(),e.querySelectorAll(".contact-card-sota.selected").forEach(n=>{n.classList.remove("selected")}),e.querySelectorAll(".contact-select-checkbox.checked").forEach(n=>{n.classList.remove("checked")});const t=document.querySelector(".selection-bar");t&&t.remove()}async function MT(e,t,n,s){const a=!e.isFavorite;try{await v.put(`/api/contacts/${e.id}`,{is_favorite:a}),e.isFavorite=a,t.classList.toggle("active",a);const o=t.querySelector("svg");o&&o.setAttribute("fill",a?"currentColor":"none"),Sv(n,xv.filter(i=>i.isFavorite||i.id===e.id&&a),s),m.success(a?"Added to favorites":"Removed from favorites")}catch{m.error("Failed to update favorite")}}function Sv(e,t,n){const s=e.querySelector("#favorites-section"),a=e.querySelector("#favorites-grid");if(t.length===0){s.classList.add("hidden");return}s.classList.remove("hidden"),a.innerHTML=t.map(o=>{const i=nd(o.name),r=!!(o.photoUrl||o.avatarUrl),c=o.photoUrl||o.avatarUrl;return`
      <div class="favorite-card" data-id="${o.id}">
        <div class="favorite-avatar">
          ${r?`<img src="${c}" alt="${ut(o.name)}">`:i}
        </div>
        <div class="favorite-info">
          <h4>${ut(o.name)}</h4>
          ${o.organization?`<p>${ut(o.organization)}</p>`:""}
        </div>
      </div>
    `}).join(""),a.querySelectorAll(".favorite-card").forEach(o=>{d(o,"click",()=>{const i=o.getAttribute("data-id"),r=t.find(c=>String(c.id)===i);r&&zn({mode:"edit",contact:r,onSave:()=>hn(e,n)})})})}async function ET(e){const t=e.querySelector("#contacts-alerts");try{const{duplicates:n}=await Ne.getDuplicates();if(n.length>0){t.innerHTML=`
        <div class="alert-sota">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span><strong>${n.length}</strong> potential duplicate contacts found</span>
          <button class="btn-sota secondary" id="review-duplicates-btn">Review Duplicates</button>
        </div>
      `;const s=t.querySelector("#review-duplicates-btn");s&&d(s,"click",()=>{qT(n,e)})}}catch{}}function qT(e,t){const n=b("div",{className:"duplicates-review-overlay"});n.innerHTML=`
    <style>
      .duplicates-review-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .duplicates-modal {
        background: var(--bg-primary);
        border-radius: 16px;
        width: 700px;
        max-width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 60px rgba(0,0,0,0.3);
        animation: slideUp 0.2s ease;
      }
      
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .duplicates-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .duplicates-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .duplicates-header h2 svg {
        width: 24px;
        height: 24px;
        color: #f59e0b;
      }
      
      .duplicates-header .close-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      
      .duplicates-header .close-btn:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
      }
      
      .duplicates-header .close-btn svg {
        width: 18px;
        height: 18px;
        color: var(--text-secondary);
      }
      
      .duplicates-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }
      
      .duplicate-group {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .duplicate-group:last-child {
        margin-bottom: 0;
      }
      
      .duplicate-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
      }
      
      .duplicate-group-header h4 {
        margin: 0;
        font-size: 14px;
        color: var(--text-secondary);
      }
      
      .merge-group-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }
      
      .merge-group-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }
      
      .merge-group-btn svg {
        width: 16px;
        height: 16px;
      }
      
      .duplicate-contacts {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .duplicate-contact-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }
      
      .duplicate-contact-row input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #e11d48;
      }
      
      .duplicate-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48, #be123c);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
      }
      
      .duplicate-info {
        flex: 1;
        min-width: 0;
      }
      
      .duplicate-info h5 {
        margin: 0 0 2px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .duplicate-info p {
        margin: 0;
        font-size: 12px;
        color: var(--text-secondary);
      }
      
      .duplicate-aliases {
        margin-top: 4px;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }
      
      .alias-tag {
        padding: 2px 6px;
        background: rgba(99,102,241,0.1);
        color: #6366f1;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
      }
      
      .duplicates-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .duplicates-footer button {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .duplicates-footer .close-review-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }
      
      .duplicates-footer .close-review-btn:hover {
        background: var(--bg-tertiary);
      }
      
      .no-duplicates-msg {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }
      
      .no-duplicates-msg svg {
        width: 48px;
        height: 48px;
        opacity: 0.4;
        margin-bottom: 12px;
      }
    </style>
    
    <div class="duplicates-modal">
      <div class="duplicates-header">
        <h2>
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Review Duplicate Contacts
        </h2>
        <button class="close-btn" id="close-duplicates-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="duplicates-content" id="duplicates-content">
        ${e.length===0?`
          <div class="no-duplicates-msg">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>No duplicate contacts found</p>
          </div>
        `:e.map((i,r)=>`
          <div class="duplicate-group" data-group-index="${r}">
            <div class="duplicate-group-header">
              <h4>Potential duplicates (${i.length} contacts)</h4>
              <button class="merge-group-btn" data-group-index="${r}">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                Merge All
              </button>
            </div>
            <div class="duplicate-contacts">
              ${i.map((c,l)=>`
                <div class="duplicate-contact-row">
                  <input type="radio" name="primary-${r}" value="${c.id}" ${l===0?"checked":""}>
                  <div class="duplicate-avatar">${nd(c.name)}</div>
                  <div class="duplicate-info">
                    <h5>${ut(c.name)}${l===0?" (Primary)":""}</h5>
                    <p>${ut(c.email||"")}${c.organization?` ‚Ä¢ ${ut(c.organization)}`:""}</p>
                    ${c.aliases&&c.aliases.length>0?`
                      <div class="duplicate-aliases">
                        ${c.aliases.map(u=>`<span class="alias-tag">${ut(u)}</span>`).join("")}
                      </div>
                    `:""}
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `).join("")}
      </div>
      
      <div class="duplicates-footer">
        <button class="close-review-btn" id="close-review-btn">Close</button>
      </div>
    </div>
  `,document.body.appendChild(n);const s=()=>n.remove(),a=n.querySelector("#close-duplicates-btn"),o=n.querySelector("#close-review-btn");a&&d(a,"click",s),o&&d(o,"click",s),d(n,"click",i=>{i.target===n&&s()}),n.querySelectorAll(".merge-group-btn").forEach(i=>{d(i,"click",async()=>{const r=parseInt(i.getAttribute("data-group-index")||"0"),c=e[r];if(!c||c.length<2)return;const u=n.querySelector(`input[name="primary-${r}"]:checked`)?.value||c[0].id,p=[u,...c.filter(g=>g.id!==u).map(g=>g.id)];i.disabled=!0,i.textContent="Merging...";try{await Ne.mergeContacts(p),m.success(`Merged ${c.length} contacts successfully`);const g=n.querySelector(`.duplicate-group[data-group-index="${r}"]`);if(g&&g.remove(),n.querySelectorAll(".duplicate-group").length===0){const h=n.querySelector("#duplicates-content");h&&(h.innerHTML=`
              <div class="no-duplicates-msg">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p>All duplicates have been merged!</p>
              </div>
            `)}await hn(t)}catch(g){const f=g instanceof Error?g.message:"Failed to merge contacts";m.error(f),i.disabled=!1,i.innerHTML=`
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
          </svg>
          Merge All
        `}})})}function jT(e,t){const n=e.querySelector("#org-filter"),s=[...new Set(t.map(l=>l.organization).filter(Boolean))].sort(),a=n.value;n.innerHTML=`
    <option value="">All Organizations</option>
    ${s.map(l=>`<option value="${ut(l)}" ${a===l?"selected":""}>${ut(l)}</option>`).join("")}
  `;const o=e.querySelector("#tag-filter"),i=t.flatMap(l=>l.tags||[]),r=[...new Set(i)].sort(),c=o.value;o.innerHTML=`
    <option value="">All Tags</option>
    ${r.map(l=>`<option value="${ut(l)}" ${c===l?"selected":""}>${ut(l)}</option>`).join("")}
  `}async function PT(){try{await Ne.export("json"),m.success("Contacts exported")}catch{m.error("Failed to export contacts")}}function DT(e,t){const n=e.querySelector("#contacts-count");n&&(n.textContent=String(t))}function nd(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function ut(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const zT=Object.freeze(Object.defineProperty({__proto__:null,createContactsPanel:$v},Symbol.toStringTag,{value:"Module"}));function Cv(e={}){const t=b("div",{className:"teams-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Teams</h2>
        <span class="panel-count" id="teams-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="add-team-btn">+ Add Team</button>
      </div>
    </div>
    <div class="panel-content" id="teams-content">
      <div class="loading">Loading teams...</div>
    </div>
  `;const n=t.querySelector("#add-team-btn");return n&&d(n,"click",()=>{Zo({mode:"create",onSave:()=>rl(t,e)})}),rl(t,e),t}async function rl(e,t){const n=e.querySelector("#teams-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=await Zp.getAll();IT(n,s,t),BT(e,s.length)}catch{n.innerHTML='<div class="error">Failed to load teams</div>'}}function IT(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No teams yet</p>
        <button class="btn btn-primary" id="empty-add-btn">Create Team</button>
      </div>
    `;const s=e.querySelector("#empty-add-btn");s&&d(s,"click",()=>{Zo({mode:"create"})});return}e.innerHTML=`
    <div class="teams-grid">
      ${t.map(s=>HT(s)).join("")}
    </div>
  `,e.querySelectorAll(".team-card").forEach(s=>{d(s,"click",()=>{const a=s.getAttribute("data-id"),o=t.find(i=>String(i.id)===a);o&&(n.onTeamClick?n.onTeamClick(o):Zo({mode:"edit",team:o,onSave:()=>rl(s.closest(".teams-panel"),n)}))})})}function HT(e){const t=e.memberCount||0,n=e.memberDetails?.find(s=>s.isLead);return`
    <div class="team-card" data-id="${e.id}">
      <div class="team-header">
        <div class="team-color" style="--team-color: ${e.color||"#6366f1"}"></div>
        <div class="team-name">${wo(e.name)}</div>
        ${e.team_type?`<span class="team-type">${e.team_type}</span>`:""}
      </div>
      ${e.description?`<div class="team-description">${wo(e.description)}</div>`:""}
      <div class="team-stats">
        <span class="member-count">${t} member${t!==1?"s":""}</span>
        ${n?`<span class="team-lead">Lead: ${wo(n.name)}</span>`:""}
      </div>
      ${e.memberDetails&&e.memberDetails.length>0?`
        <div class="team-members-preview">
          ${e.memberDetails.slice(0,5).map(s=>`
            <div class="member-avatar" title="${wo(s.name)}">
              ${RT(s.name)}
            </div>
          `).join("")}
          ${e.memberDetails.length>5?`<div class="more-members">+${e.memberDetails.length-5}</div>`:""}
        </div>
      `:""}
    </div>
  `}function BT(e,t){const n=e.querySelector("#teams-count");n&&(n.textContent=String(t))}function RT(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function wo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const NT=Object.freeze(Object.defineProperty({__proto__:null,createTeamsPanel:Cv},Symbol.toStringTag,{value:"Module"}));function _v(){return window.vis}function Lv(e={}){const t=b("div",{className:"org-chart"});t.innerHTML=`
    <div class="chart-toolbar">
      <button class="btn btn-sm" id="fit-chart-btn">Fit</button>
      <button class="btn btn-sm" id="refresh-chart-btn">Refresh</button>
    </div>
    <div class="chart-container" id="org-chart-container">
      <div class="loading">Loading org chart...</div>
    </div>
  `;const n=t.querySelector("#fit-chart-btn");n&&d(n,"click",()=>{t._network?.fit()});const s=t.querySelector("#refresh-chart-btn");return s&&d(s,"click",()=>lp(t,e)),lp(t,e),t}async function lp(e,t){const n=e.querySelector("#org-chart-container");n.innerHTML='<div class="loading">Loading...</div>';try{const{contacts:s}=await Ne.getAll({});if(s.length===0){n.innerHTML=`
        <div class="empty-state">
          <p>No contacts to display</p>
        </div>
      `;return}const{nodes:a,edges:o}=OT(s);if(!_v()){UT(n,s,t);return}FT(n,a,o,s,t)}catch{n.innerHTML='<div class="error">Failed to load org chart</div>'}}function OT(e){const t=[],n=[],s=new Map;return e.forEach(a=>{const o=a.relationships?.find(i=>i.type==="reports_to");if(o){const i=s.get(o.contactId)||0;s.set(String(a.id),i+1)}else s.set(String(a.id),0)}),e.forEach(a=>{t.push({id:String(a.id),label:a.name,title:`${a.name}${a.role?`
${a.role}`:""}${a.organization?`
${a.organization}`:""}`,level:s.get(String(a.id))||0,color:a.teams?.[0]?.color})}),e.forEach(a=>{a.relationships?.forEach(o=>{o.type==="reports_to"&&n.push({from:o.contactId,to:String(a.id),arrows:"to"})})}),{nodes:t,edges:n}}function FT(e,t,n,s,a){e.innerHTML="";const o=t.map(l=>({id:l.id,label:l.label,title:l.title,level:l.level,color:{background:l.color||"#6366f1",border:l.color||"#4f46e5",highlight:{background:"#818cf8",border:"#6366f1"}},font:{color:"#ffffff"},shape:"box",margin:10})),i={layout:{hierarchical:{direction:"UD",sortMethod:"directed",levelSeparation:100,nodeSpacing:150}},nodes:{borderWidth:2,shadow:!0},edges:{color:{color:"#9ca3af",highlight:"#6366f1"},width:2,smooth:{type:"cubicBezier"}},physics:!1,interaction:{hover:!0,tooltipDelay:200}},r=_v(),c=new r.Network(e,{nodes:new r.DataSet(o),edges:new r.DataSet(n)},i);e.closest(".org-chart")._network=c,c.on("click",l=>{if(l.nodes.length>0){const u=l.nodes[0],p=s.find(g=>String(g.id)===u);p&&(a.onNodeClick?a.onNodeClick(p):zn({mode:"view",contact:p}))}}),c.fit()}function UT(e,t,n){const s={};t.forEach(a=>{const o=a.organization||"Other";s[o]||(s[o]=[]),s[o].push(a)}),e.innerHTML=`
    <div class="fallback-org-chart">
      ${Object.entries(s).map(([a,o])=>`
        <div class="org-group">
          <h4 class="org-name">${gc(a)}</h4>
          <div class="org-members">
            ${o.map(i=>`
              <div class="org-member" data-id="${i.id}">
                <div class="member-avatar">${VT(i.name)}</div>
                <div class="member-info">
                  <div class="member-name">${gc(i.name)}</div>
                  ${i.role?`<div class="member-role">${gc(i.role)}</div>`:""}
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".org-member").forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);i&&(n.onNodeClick?n.onNodeClick(i):zn({mode:"view",contact:i}))})})}function VT(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function gc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const GT=Object.freeze(Object.defineProperty({__proto__:null,createOrgChart:Lv},Symbol.toStringTag,{value:"Module"}));let Co="processed",_o="all",qi="date",dp="grid",yi="",mt=new Set,wi=[];function cl(e={}){const t=b("div",{className:"documents-panel-minimal"});return t.innerHTML=`
    <style>
      .documents-panel-minimal {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bg-primary);
        padding: 32px;
      }

      /* Header - Minimal */
      .docs-header-minimal {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
      }
      .docs-title-section {
        display: flex;
        align-items: baseline;
        gap: 16px;
      }
      .docs-title-section h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .docs-total-count {
        font-size: 16px;
        color: var(--text-tertiary);
        font-weight: 400;
      }
      .docs-header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      /* View Mode Toggle */
      .view-mode-toggle {
        display: flex;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 4px;
        gap: 2px;
      }
      .view-mode-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-tertiary);
        transition: all 0.15s ease;
      }
      .view-mode-btn:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }
      .view-mode-btn.active {
        background: var(--primary);
        color: white;
      }
      .view-mode-btn svg {
        width: 18px;
        height: 18px;
      }

      .btn-minimal {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      .btn-minimal.primary {
        background: var(--primary);
        color: white;
      }
      .btn-minimal.primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .btn-minimal.secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .btn-minimal.secondary:hover {
        background: var(--bg-tertiary);
      }
      .btn-minimal svg {
        width: 16px;
        height: 16px;
      }

      /* Search and Filters - Single Line */
      .docs-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      .docs-search-minimal {
        flex: 1;
        min-width: 280px;
        max-width: 400px;
        position: relative;
      }
      .docs-search-minimal input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.15s ease;
      }
      .docs-search-minimal input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .docs-search-minimal input::placeholder {
        color: var(--text-tertiary);
      }
      .docs-search-minimal svg {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-tertiary);
        width: 18px;
        height: 18px;
      }

      /* Filter Chips */
      .docs-filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .filter-chip-minimal {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .filter-chip-minimal:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .filter-chip-minimal.active {
        background: var(--primary);
        color: white;
      }

      /* Divider with status */
      .docs-status-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 24px;
      }
      .status-chip {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        background: transparent;
        border: none;
        color: var(--text-secondary);
      }
      .status-chip:hover {
        background: var(--bg-tertiary);
      }
      .status-chip.active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .status-chip.active.processed { color: #10b981; background: rgba(16, 185, 129, 0.1); }
      .status-chip.active.pending { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
      .status-chip.active.failed { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
      .status-chip.active.deleted { color: #6b7280; background: rgba(107, 114, 128, 0.1); }
      .status-chip .chip-count {
        margin-left: 6px;
        padding: 2px 6px;
        font-size: 10px;
        background: rgba(0,0,0,0.05);
        border-radius: 6px;
      }
      [data-theme="dark"] .status-chip .chip-count {
        background: rgba(255,255,255,0.1);
      }
      .status-chip.active .chip-count {
        background: rgba(0,0,0,0.1);
      }
      .docs-sort-minimal {
        margin-left: auto;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
      }

      /* Documents Grid - Larger Cards */
      .docs-content-minimal {
        flex: 1;
        overflow-y: auto;
      }
      .docs-grid-minimal {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
      }
      
      /* List View Mode */
      .docs-grid-minimal.list-view {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .docs-grid-minimal.list-view .doc-card-minimal {
        flex-direction: row;
        align-items: center;
        padding: 12px 20px;
        gap: 16px;
        border-radius: 12px;
      }
      .docs-grid-minimal.list-view .doc-card-header {
        flex-shrink: 0;
        gap: 12px;
      }
      .docs-grid-minimal.list-view .doc-card-header .doc-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
        border-radius: 8px;
      }
      .docs-grid-minimal.list-view .doc-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 24px;
        min-width: 0;
      }
      .docs-grid-minimal.list-view .doc-filename {
        flex: 1;
        min-width: 0;
        margin: 0;
      }
      .docs-grid-minimal.list-view .doc-meta {
        display: flex;
        gap: 16px;
        color: var(--text-tertiary);
        font-size: 13px;
        flex-shrink: 0;
      }
      .docs-grid-minimal.list-view .doc-status-badge {
        margin: 0;
        flex-shrink: 0;
      }
      .docs-grid-minimal.list-view .doc-summary-section,
      .docs-grid-minimal.list-view .doc-entities-mini,
      .docs-grid-minimal.list-view .doc-card-hover {
        display: none;
      }

      /* Document Card - Clean Design */
      .doc-card-minimal {
        background: var(--bg-secondary);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .doc-card-minimal:hover {
        border-color: rgba(var(--primary-rgb), 0.4);
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        transform: translateY(-2px);
      }
      .doc-card-minimal.selected {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.02);
      }

      /* Card Header */
      .doc-card-top {
        display: flex;
        align-items: flex-start;
        gap: 16px;
      }
      .doc-icon-minimal {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }
      .doc-icon-minimal.pdf { background: linear-gradient(135deg, #fef2f2, #fee2e2); }
      .doc-icon-minimal.doc { background: linear-gradient(135deg, #eff6ff, #dbeafe); }
      .doc-icon-minimal.img { background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
      .doc-icon-minimal.txt { background: linear-gradient(135deg, #fefce8, #fef9c3); }
      .doc-icon-minimal.default { background: linear-gradient(135deg, #f5f5f5, #e5e5e5); }
      [data-theme="dark"] .doc-icon-minimal.pdf { background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.doc { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.img { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.txt { background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.default { background: linear-gradient(135deg, rgba(107,114,128,0.15), rgba(107,114,128,0.1)); }

      .doc-info-minimal {
        flex: 1;
        min-width: 0;
      }
      .doc-filename-minimal {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .doc-meta-minimal {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-tertiary);
      }
      .doc-meta-minimal .sep {
        color: var(--border-color);
      }
      .doc-status-badge {
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 6px;
        text-transform: capitalize;
      }
      .doc-status-badge.processed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
      .doc-status-badge.pending { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
      .doc-status-badge.failed { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
      .doc-status-badge.deleted { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

      /* Card Summary */
      .doc-summary-minimal {
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-secondary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Card Footer */
      .doc-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }
      .doc-entities {
        display: flex;
        gap: 16px;
      }
      .doc-entity-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-secondary);
      }
      .doc-entity-item .icon {
        width: 20px;
        height: 20px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
      }
      .doc-entity-item.facts .icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
      .doc-entity-item.decisions .icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
      .doc-entity-item.risks .icon { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

      .doc-actions-minimal {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.15s ease;
      }
      .doc-card-minimal:hover .doc-actions-minimal {
        opacity: 1;
      }
      .doc-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s ease;
        color: var(--text-secondary);
        font-size: 14px;
      }
      .doc-action-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }
      .doc-action-btn.favorite.active {
        color: #f59e0b;
      }
      .doc-action-btn.favorite:hover {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
      }

      /* Selection */
      .doc-select-checkbox {
        position: absolute;
        top: 16px;
        left: 16px;
        width: 22px;
        height: 22px;
        border-radius: 6px;
        border: 2px solid var(--border-color);
        background: var(--bg-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.15s ease;
        font-size: 12px;
        color: white;
      }
      .doc-card-minimal:hover .doc-select-checkbox,
      .doc-card-minimal.selected .doc-select-checkbox {
        opacity: 1;
      }
      .doc-card-minimal.selected .doc-select-checkbox {
        background: var(--primary);
        border-color: var(--primary);
      }

      /* Selection Bar */
      .selection-bar-minimal {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        background: #1e293b;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        z-index: 100;
        animation: slideUp 0.25s ease;
      }
      @keyframes slideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
      .selection-bar-minimal.hidden { display: none; }
      .selection-count-minimal {
        color: white;
        font-weight: 600;
        padding-right: 16px;
        border-right: 1px solid rgba(255,255,255,0.2);
      }
      .selection-count-minimal span { color: #60a5fa; }
      .selection-bar-minimal .btn-minimal {
        padding: 8px 16px;
        font-size: 13px;
      }
      .selection-bar-minimal .btn-minimal.secondary {
        background: rgba(255,255,255,0.1);
        color: white;
        border-color: transparent;
      }
      .selection-bar-minimal .btn-minimal.secondary:hover {
        background: rgba(255,255,255,0.2);
      }
      .selection-bar-minimal .btn-minimal.danger {
        background: #ef4444;
        color: white;
        border: none;
      }

      /* Empty State */
      .docs-empty-minimal {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        text-align: center;
        grid-column: 1 / -1;
      }
      .docs-empty-minimal .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 24px;
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin-bottom: 24px;
      }
      .docs-empty-minimal h3 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .docs-empty-minimal p {
        margin: 0 0 24px 0;
        color: var(--text-secondary);
      }

      /* Loading */
      .docs-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px;
        grid-column: 1 / -1;
        color: var(--text-secondary);
        gap: 12px;
      }
      .docs-loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Accessibility: Screen reader only content */
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      
      /* Focus styles for keyboard navigation */
      .doc-card-minimal:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }
      .doc-card-minimal:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }
    </style>
    
    <!-- Header -->
    <div class="docs-header-minimal">
      <div class="docs-title-section">
        <h1>Files</h1>
        <span class="docs-total-count"><span id="total-count">0</span> documents</span>
      </div>
      <div class="docs-header-actions">
        <!-- View Mode Toggle -->
        <div class="view-mode-toggle">
          <button class="view-mode-btn active" data-view="grid" title="Grid view">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
            </svg>
          </button>
          <button class="view-mode-btn" data-view="list" title="List view">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
          </button>
        </div>
        <button class="btn-minimal primary" id="upload-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Upload
        </button>
      </div>
    </div>

    <!-- Controls -->
    <div class="docs-controls" role="search">
      <div class="docs-search-minimal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.3-4.3"/>
        </svg>
        <input type="text" id="docs-search-input" placeholder="Search files..." 
               aria-label="Search files" autocomplete="off">
      </div>
      <div class="docs-filters" role="tablist" aria-label="Filter by document type">
        <button class="filter-chip-minimal active" data-type="all" role="tab" aria-selected="true">All</button>
        <button class="filter-chip-minimal" data-type="documents" role="tab" aria-selected="false">Documents</button>
        <button class="filter-chip-minimal" data-type="transcripts" role="tab" aria-selected="false">Transcripts</button>
        <button class="filter-chip-minimal" data-type="emails" role="tab" aria-selected="false">Emails</button>
        <button class="filter-chip-minimal" data-type="images" role="tab" aria-selected="false">Images</button>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="docs-status-bar" role="tablist" aria-label="Filter by status">
      <button class="status-chip active processed" data-status="processed" role="tab" aria-selected="true">
        Processed <span class="chip-count" id="count-processed" aria-label="count">0</span>
      </button>
      <button class="status-chip pending" data-status="pending" role="tab" aria-selected="false">
        Pending <span class="chip-count" id="count-pending" aria-label="count">0</span>
      </button>
      <button class="status-chip failed" data-status="failed" role="tab" aria-selected="false">
        Failed <span class="chip-count" id="count-failed" aria-label="count">0</span>
      </button>
      <button class="status-chip deleted" data-status="deleted" role="tab" aria-selected="false">
        Deleted <span class="chip-count" id="count-deleted" aria-label="count">0</span>
      </button>
      <label for="sort-select" class="visually-hidden">Sort order</label>
      <select class="docs-sort-minimal" id="sort-select" aria-label="Sort files">
        <option value="date">Newest first</option>
        <option value="name">Name A-Z</option>
        <option value="size">Largest first</option>
      </select>
    </div>

    <!-- Content -->
    <div class="docs-content-minimal" role="main">
      <div class="docs-grid-minimal" id="docs-grid" role="list" aria-label="Document list" tabindex="0">
        <div class="docs-loading" aria-live="polite">Loading files</div>
      </div>
    </div>

    <!-- Selection Bar -->
    <div class="selection-bar-minimal hidden" id="selection-bar" role="toolbar" aria-label="Bulk actions">
      <span class="selection-count-minimal" aria-live="polite"><span id="selected-count">0</span> selected</span>
      <button class="btn-minimal secondary" id="bulk-export-btn" aria-label="Export selected files">Export</button>
      <button class="btn-minimal secondary" id="bulk-reprocess-btn" aria-label="Reprocess selected files">Reprocess</button>
      <button class="btn-minimal danger" id="bulk-delete-btn" aria-label="Delete selected files">Delete</button>
      <button class="btn-minimal secondary" id="cancel-selection-btn" aria-label="Cancel selection">Cancel</button>
    </div>
  `,ZT(t,e),ws(t,e),t}function ZT(e,t){e.querySelector("#upload-btn")?.addEventListener("click",async()=>{const{showFileUploadModal:a}=await xe(async()=>{const{showFileUploadModal:o}=await Promise.resolve().then(()=>rv);return{showFileUploadModal:o}},void 0);a({onComplete:()=>ws(e,t)})});const n=e.querySelector("#docs-search-input");let s;n?.addEventListener("input",()=>{clearTimeout(s),s=setTimeout(()=>{const a=n.value.trim();a!==yi&&(yi=a,(yi.length>=2||yi.length===0)&&ws(e,t))},500)}),e.querySelector("#sort-select")?.addEventListener("change",a=>{qi=a.target.value,ll(e,t)}),e.querySelectorAll(".filter-chip-minimal").forEach(a=>{a.addEventListener("click",()=>{e.querySelectorAll(".filter-chip-minimal").forEach(o=>o.classList.remove("active")),a.classList.add("active"),_o=a.getAttribute("data-type"),ll(e,t)})}),e.querySelectorAll(".status-chip").forEach(a=>{a.addEventListener("click",()=>{e.querySelectorAll(".status-chip").forEach(o=>o.classList.remove("active")),a.classList.add("active"),Co=a.getAttribute("data-status"),ws(e,t)})}),e.querySelectorAll(".view-mode-btn").forEach(a=>{a.addEventListener("click",()=>{e.querySelectorAll(".view-mode-btn").forEach(i=>i.classList.remove("active")),a.classList.add("active"),dp=a.getAttribute("data-view");const o=e.querySelector("#docs-grid");o&&(dp==="list"?o.classList.add("list-view"):o.classList.remove("list-view"))})}),e.querySelector("#bulk-delete-btn")?.addEventListener("click",()=>JT(e,t)),e.querySelector("#bulk-export-btn")?.addEventListener("click",()=>YT()),e.querySelector("#bulk-reprocess-btn")?.addEventListener("click",()=>XT(e,t)),e.querySelector("#cancel-selection-btn")?.addEventListener("click",()=>{mt.clear(),Yo(e)})}async function ws(e,t){const n=e.querySelector("#docs-grid");n.innerHTML='<div class="docs-loading" aria-live="polite">Loading files</div>';try{const s=await Cs.getAll({status:Co==="all"?void 0:Co,type:_o==="all"?void 0:_o,search:yi||void 0,sort:qi==="date"?"created_at":qi==="name"?"filename":void 0,order:qi==="date"?"desc":"asc",limit:100});wi=s.documents||[],console.log("%c[DocumentsPanel] Load result:","color: green; font-weight: bold",{total:s.total,docsCount:wi.length,firstDoc:wi[0],currentStatus:Co,currentType:_o});const a=s.statuses||{};e.querySelector("#total-count").textContent=String(s.total||wi.length),e.querySelector("#count-processed").textContent=String(a.processed||0),e.querySelector("#count-pending").textContent=String((a.pending||0)+(a.processing||0)),e.querySelector("#count-failed").textContent=String(a.failed||0),e.querySelector("#count-deleted").textContent=String(a.deleted||0),ll(e,t)}catch(s){console.error("[DocumentsPanel] Failed to load:",s),n.innerHTML='<div class="docs-empty-minimal"><div class="empty-icon">!</div><h3>Failed to load files</h3><p>Please try again</p></div>'}}function ll(e,t){let n=[...wi];qi==="size"&&n.sort((s,a)=>(a.size||0)-(s.size||0)),WT(e,n,t)}function WT(e,t,n){const s=e.querySelector("#docs-grid");if(t.length===0){s.innerHTML=`
      <div class="docs-empty-minimal">
        <div class="empty-icon">üìÅ</div>
        <h3>No files found</h3>
        <p>Upload files to get started</p>
        <button class="btn-minimal primary" id="empty-upload-btn">Upload Files</button>
      </div>
    `,s.querySelector("#empty-upload-btn")?.addEventListener("click",async()=>{const{showFileUploadModal:a}=await xe(async()=>{const{showFileUploadModal:o}=await Promise.resolve().then(()=>rv);return{showFileUploadModal:o}},void 0);a({onComplete:()=>ws(e,n)})});return}s.innerHTML=t.map((a,o)=>KT(a,o)).join(""),s.setAttribute("data-total",String(t.length)),s.querySelectorAll(".doc-card-minimal").forEach(a=>{const o=a.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);a.addEventListener("click",r=>{const c=r.target;c.closest(".doc-select-checkbox")||c.closest(".doc-action-btn")||i&&n.onDocumentClick&&n.onDocumentClick(i)}),a.addEventListener("keydown",r=>{const c=r,l=Array.from(s.querySelectorAll(".doc-card-minimal")),u=l.indexOf(a);switch(c.key){case"Enter":case" ":r.preventDefault(),i&&n.onDocumentClick&&n.onDocumentClick(i);break;case"ArrowDown":case"ArrowRight":r.preventDefault(),u<l.length-1&&l[u+1].focus();break;case"ArrowUp":case"ArrowLeft":r.preventDefault(),u>0&&l[u-1].focus();break;case"s":r.preventDefault(),mt.has(o)?mt.delete(o):mt.add(o),Yo(e);break;case"Delete":case"Backspace":r.preventDefault(),i&&confirm(`Delete "${i.filename}"?`)&&Cs.delete(o,{softDelete:!0}).then(()=>{m.success("File deleted"),ws(e,n)}).catch(()=>m.error("Failed to delete"));break}}),a.querySelector(".doc-select-checkbox")?.addEventListener("click",r=>{r.stopPropagation(),mt.has(o)?mt.delete(o):mt.add(o),Yo(e)}),a.querySelector(".doc-action-btn.favorite")?.addEventListener("click",async r=>{r.stopPropagation();try{await v.post(`/api/documents/${o}/favorite`),r.target.classList.toggle("active"),m.success("Updated favorites")}catch{m.error("Failed to update favorite")}})})}function KT(e,t=0){const n=QT(e.filename||""),s=e3(e.filename||""),a=mt.has(e.id),o=e.facts_count||0,i=e.decisions_count||0,r=e.risks_count||0,c=[o>0?`${o} facts`:"",i>0?`${i} decisions`:"",r>0?`${r} risks`:""].filter(Boolean).join(", ")||"No entities";return`
    <div class="doc-card-minimal ${a?"selected":""}" 
         data-id="${e.id}"
         data-index="${t}"
         role="listitem"
         tabindex="0"
         aria-label="${vc(e.filename||"Untitled")}. Status: ${e.status}. ${c}">
      <div class="doc-select-checkbox" role="checkbox" aria-checked="${a}" aria-label="Select document">${a?"‚úì":""}</div>
      
      <div class="doc-card-top">
        <div class="doc-icon-minimal ${n}" aria-hidden="true">${s}</div>
        <div class="doc-info-minimal">
          <div class="doc-filename-minimal">${vc(e.filename||"Untitled")}</div>
          <div class="doc-meta-minimal">
            <span>${Ji(e.file_size||e.size||0)}</span>
            <span class="sep" aria-hidden="true">‚Ä¢</span>
            <span>${Ce(e.created_at)}</span>
          </div>
        </div>
        <span class="doc-status-badge ${e.status}" aria-label="Status: ${e.status}">${e.status}</span>
      </div>
      
      ${e.summary?`<div class="doc-summary-minimal">${vc(e.summary)}</div>`:""}
      
      <div class="doc-card-footer">
        <div class="doc-entities" aria-label="Extracted entities">
          ${o>0?`<span class="doc-entity-item facts"><span class="icon" aria-hidden="true">üìã</span> ${o} facts</span>`:""}
          ${i>0?`<span class="doc-entity-item decisions"><span class="icon" aria-hidden="true">‚úì</span> ${i}</span>`:""}
          ${r>0?`<span class="doc-entity-item risks"><span class="icon" aria-hidden="true">‚ö†</span> ${r}</span>`:""}
          ${o===0&&i===0&&r===0?'<span class="doc-entity-item text-muted">No entities</span>':""}
        </div>
        <div class="doc-actions-minimal">
          <button class="doc-action-btn favorite ${e.is_favorite?"active":""}" 
                  title="Favorite" aria-label="${e.is_favorite?"Remove from favorites":"Add to favorites"}"
                  aria-pressed="${e.is_favorite?"true":"false"}">‚òÖ</button>
        </div>
      </div>
    </div>
  `}function QT(e){switch(e.split(".").pop()?.toLowerCase()){case"pdf":return"pdf";case"doc":case"docx":return"doc";case"jpg":case"jpeg":case"png":case"gif":return"img";case"txt":case"md":return"txt";default:return"default"}}function Yo(e){const t=mt.size;e.querySelector("#selection-bar").classList.toggle("hidden",t===0),e.querySelector("#selected-count").textContent=String(t),e.querySelectorAll(".doc-card-minimal").forEach(s=>{const a=s.getAttribute("data-id"),o=mt.has(a);s.classList.toggle("selected",o);const i=s.querySelector(".doc-select-checkbox");i&&(i.textContent=o?"‚úì":"")})}function Tv(e,t){const n=document.createElement("div");return n.className="bulk-loading-overlay",n.innerHTML=`
    <div class="bulk-loading-content">
      <div class="bulk-loading-spinner"></div>
      <div class="bulk-loading-message">${t}</div>
      <div class="bulk-loading-progress" id="bulk-progress"></div>
    </div>
  `,n.querySelector(".bulk-loading-content"),e.classList.add("position-relative"),e.appendChild(n),n}function Av(e){e?.remove()}function Xo(e,t){e.querySelectorAll("#bulk-delete-btn, #bulk-export-btn, #bulk-reprocess-btn").forEach(s=>{s.disabled=t})}async function JT(e,t){const n=mt.size;if(!confirm(`Delete ${n} files? This action can be undone from the Deleted tab.`))return;const s=Tv(e,`Deleting ${n} files...`);Xo(e,!0);try{const a=Array.from(mt),i=(await v.post("/api/documents/bulk/delete",{ids:a})).data;i.errors&&i.errors.length>0?m.warning(`Deleted ${i.deleted} files, ${i.errors.length} failed`):m.success(`Deleted ${i.deleted} files`),mt.clear(),ws(e,t)}catch(a){console.error("[BulkDelete] Error:",a),m.error("Failed to delete files")}finally{Av(s),Xo(e,!1)}}async function YT(){const e=mt.size;m.info(`Preparing export of ${e} files...`);try{const t=Array.from(mt),n=await at("/api/documents/bulk/export",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:t,format:"original"})});if(!n.ok)throw new Error("Export failed");const s=await n.blob(),a=window.URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=`documents-export-${new Date().toISOString().split("T")[0]}.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(a),m.success(`Exported ${e} files`)}catch(t){console.error("[BulkExport] Error:",t),m.error("Failed to export files")}}async function XT(e,t){const n=mt.size;if(!confirm(`Reprocess ${n} files? This will use AI tokens.`))return;const s=Tv(e,`Queuing ${n} files for reprocessing...`);Xo(e,!0);try{const a=Array.from(mt),i=(await v.post("/api/documents/bulk/reprocess",{ids:a})).data;i.failed&&i.failed.length>0?m.warning(`Queued ${i.queued?.length||0} files, ${i.failed.length} failed`):m.success(`Queued ${i.queued?.length||n} files for reprocessing`),mt.clear(),Yo(e),setTimeout(()=>ws(e,t),1e3)}catch(a){console.error("[BulkReprocess] Error:",a),m.error("Failed to queue files for reprocessing")}finally{Av(s),Xo(e,!1)}}function e3(e){switch(e.split(".").pop()?.toLowerCase()){case"pdf":return"üìÑ";case"doc":case"docx":return"üìù";case"xls":case"xlsx":return"üìä";case"ppt":case"pptx":return"üìΩÔ∏è";case"txt":case"md":return"üìÉ";case"jpg":case"jpeg":case"png":case"gif":return"üñºÔ∏è";default:return"üìÅ"}}function vc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const t3=Object.freeze(Object.defineProperty({__proto__:null,createDocumentsPanel:cl,default:cl},Symbol.toStringTag,{value:"Module"}));function n3(e={}){const t=b("div",{className:"knowledge-panel"});t.innerHTML=`
    <div class="panel-header">
      <h2>Knowledge Base</h2>
    </div>
    <div class="panel-content">
      <div class="knowledge-status" id="knowledge-status">
        <div class="loading">Loading status...</div>
      </div>
      <div class="knowledge-actions">
        <div class="action-group">
          <h4>Export</h4>
          <div class="action-buttons">
            <button class="btn btn-sm" id="export-md-btn">Export Markdown</button>
            <button class="btn btn-sm" id="export-json-btn">Export JSON</button>
          </div>
        </div>
        <div class="action-group">
          <h4>Maintenance</h4>
          <div class="action-buttons">
            <button class="btn btn-sm" id="regenerate-btn">Regenerate Files</button>
            <button class="btn btn-sm" id="synthesize-btn">Synthesize Facts</button>
          </div>
        </div>
      </div>
    </div>
  `;const n=t.querySelector("#export-md-btn");n&&d(n,"click",()=>up("md",e));const s=t.querySelector("#export-json-btn");s&&d(s,"click",()=>up("json",e));const a=t.querySelector("#regenerate-btn");a&&d(a,"click",()=>a3(t));const o=t.querySelector("#synthesize-btn");return o&&d(o,"click",()=>i3(t)),sd(t),t}async function sd(e){const t=e.querySelector("#knowledge-status");try{const n=await _a.getStatus();s3(t,n)}catch{t.innerHTML='<div class="error">Failed to load status</div>'}}function s3(e,t){e.innerHTML=`
    <div class="status-grid">
      <div class="status-item">
        <span class="status-label">Documents Embedded</span>
        <span class="status-value">${t.embedded}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Total Chunks</span>
        <span class="status-value">${t.totalChunks}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Embedding Model</span>
        <span class="status-value">${t.model||"Default"}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Last Updated</span>
        <span class="status-value">${t.lastUpdated?o3(t.lastUpdated):"Never"}</span>
      </div>
    </div>
    ${t.available_embedding_models&&t.available_embedding_models.length>0?`
      <div class="available-models">
        <h5>Available Models</h5>
        <div class="model-list">
          ${t.available_embedding_models.map(n=>`
            <span class="model-badge">${n}</span>
          `).join("")}
        </div>
      </div>
    `:""}
  `}async function up(e,t){if(t.onExport){t.onExport(e);return}try{e==="md"?await _a.exportMarkdown():await _a.exportJson(),m.success(`Knowledge base exported as ${e.toUpperCase()}`)}catch{m.error("Failed to export knowledge base")}}async function a3(e){if(!confirm("This will regenerate all knowledge files. Continue?"))return;const t=e.querySelector("#regenerate-btn");t.disabled=!0,t.textContent="Regenerating...";try{await _a.regenerate(),m.success("Knowledge files regenerated"),sd(e)}catch{m.error("Failed to regenerate knowledge files")}finally{t.disabled=!1,t.textContent="Regenerate Files"}}async function i3(e){if(!confirm("This will consolidate and synthesize facts using AI. This may take a while. Continue?"))return;const t=e.querySelector("#synthesize-btn");t.disabled=!0,t.textContent="Synthesizing...";try{await _a.synthesize(),m.success("Facts synthesized"),sd(e)}catch{m.error("Failed to synthesize facts")}finally{t.disabled=!1,t.textContent="Synthesize Facts"}}function o3(e){return new Date(e).toLocaleDateString()}let er="paste";function dl(e={}){const t=document.getElementById("conversation-composer-overlay");t&&t.remove();const n=b("div",{id:"conversation-composer-overlay",className:"composer-overlay"}),s=r3(e);n.appendChild(s),document.body.appendChild(n),d(n,"click",a=>{a.target===n&&(Wi(),e.onClose?.())}),requestAnimationFrame(()=>n.classList.add("visible"))}function Wi(){const e=document.getElementById("conversation-composer-overlay");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),200))}function r3(e){const t=b("div",{className:"composer-modal"});return t.innerHTML=`
    <style>
      .composer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .composer-overlay.visible {
        opacity: 1;
      }
      .composer-overlay.visible .composer-modal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .composer-modal {
        width: 640px;
        max-width: 95vw;
        max-height: 85vh;
        background: var(--bg-primary);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px) scale(0.98);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .composer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }
      .composer-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .composer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: all 0.15s ease;
      }
      .composer-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .composer-tabs {
        display: flex;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-tab {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        transition: color 0.15s ease;
      }
      .composer-tab:hover { color: var(--text-primary); }
      .composer-tab.active { color: var(--primary); }
      .composer-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        border-radius: 2px 2px 0 0;
      }
      
      .composer-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      .paste-section label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 12px;
      }
      .paste-section textarea {
        width: 100%;
        min-height: 280px;
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      .paste-section textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .paste-section textarea::placeholder { color: var(--text-tertiary); }
      .paste-hint {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-tertiary);
      }
      
      .format-row {
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .format-row label {
        font-size: 13px;
        color: var(--text-secondary);
        white-space: nowrap;
      }
      .format-row select {
        flex: 1;
        max-width: 200px;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 13px;
      }
      
      .upload-section .dropzone {
        border: 2px dashed var(--border-color);
        border-radius: 16px;
        padding: 60px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
      }
      .upload-section .dropzone:hover,
      .upload-section .dropzone.dragover {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.03);
      }
      .dropzone-icon { font-size: 48px; margin-bottom: 16px; }
      .dropzone-title {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 8px;
      }
      .dropzone-hint { font-size: 13px; color: var(--text-tertiary); }
      
      .selected-file {
        display: none;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }
      .selected-file.visible { display: flex; }
      .file-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 70%, white));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      .file-info { flex: 1; min-width: 0; }
      .file-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .file-size { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
      .file-remove {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-tertiary);
        font-size: 18px;
        transition: all 0.15s ease;
      }
      .file-remove:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }
      
      .preview-area {
        margin-top: 20px;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        display: none;
      }
      .preview-area.visible { display: block; }
      .preview-area h4 {
        margin: 0 0 12px 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .preview-stats {
        display: flex;
        gap: 24px;
        font-size: 14px;
      }
      .preview-stats span { color: var(--text-secondary); }
      .preview-stats strong { color: var(--text-primary); }
      
      .composer-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-footer .btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      .composer-footer .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .composer-footer .btn-secondary:hover { background: var(--bg-tertiary); }
      .composer-footer .btn-outline {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .composer-footer .btn-outline:hover { background: var(--bg-tertiary); }
      .composer-footer .btn-primary {
        background: var(--primary);
        color: white;
      }
      .composer-footer .btn-primary:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .composer-footer .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
    
    <div class="composer-header">
      <h2>Import Conversation</h2>
      <button class="composer-close" id="close-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="composer-tabs">
      <button class="composer-tab active" data-mode="paste">Paste Text</button>
      <button class="composer-tab" data-mode="upload">Upload File</button>
    </div>
    
    <div class="composer-body" id="composer-body">
      ${Mv()}
    </div>
    
    <div class="composer-footer">
      <button class="btn btn-secondary" id="cancel-btn">Cancel</button>
      <button class="btn btn-outline" id="preview-btn" disabled>Preview</button>
      <button class="btn btn-primary" id="import-btn" disabled>Import</button>
    </div>
  `,t.querySelectorAll(".composer-tab").forEach(n=>{d(n,"click",()=>{t.querySelectorAll(".composer-tab").forEach(s=>s.classList.remove("active")),n.classList.add("active"),er=n.getAttribute("data-mode"),c3(t)})}),d(t.querySelector("#close-btn"),"click",()=>{Wi(),e.onClose?.()}),d(t.querySelector("#cancel-btn"),"click",()=>{Wi(),e.onClose?.()}),d(t.querySelector("#preview-btn"),"click",()=>u3(t)),d(t.querySelector("#import-btn"),"click",()=>p3(t,e)),Ev(t),t}function c3(e){const t=e.querySelector("#composer-body");t.innerHTML=er==="paste"?Mv():l3(),er==="paste"?Ev(e):d3(e)}function Mv(){return`
    <div class="paste-section">
      <label>Paste conversation or transcript:</label>
      <textarea id="conversation-input" placeholder="Paste your conversation here...

Supported formats:
‚Ä¢ WhatsApp, Slack, Teams, Discord chats
‚Ä¢ Meeting transcripts (Zoom, Google Meet)
‚Ä¢ Email threads
‚Ä¢ Any text with speaker names

Example:
[10:30] John: Hello everyone
[10:31] Jane: Hi John!
[10:32] John: Let's discuss the project..."></textarea>
      <p class="paste-hint">Include timestamps and speaker names for better parsing.</p>
      <div class="format-row">
        <label>Format:</label>
        <select id="format-select">
          <option value="">Auto-detect</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="slack">Slack</option>
          <option value="teams">Microsoft Teams</option>
          <option value="discord">Discord</option>
          <option value="zoom">Zoom Transcript</option>
          <option value="generic">Generic Chat</option>
        </select>
      </div>
    </div>
    <div class="preview-area" id="preview-area"></div>
  `}function Ev(e){const t=e.querySelector("#conversation-input"),n=e.querySelector("#preview-btn"),s=e.querySelector("#import-btn");t&&d(t,"input",()=>{const a=t.value.trim().length>10;n.disabled=!a,s.disabled=!a})}function l3(){return`
    <div class="upload-section">
      <div class="dropzone" id="file-dropzone">
        <div class="dropzone-icon">üí¨</div>
        <p class="dropzone-title">Drop chat file here</p>
        <p class="dropzone-hint">or click to browse ‚Ä¢ .txt, .json</p>
        <input type="file" id="file-input" accept=".txt,.md,.srt,.vtt,.json" hidden>
      </div>
      <div class="selected-file" id="selected-file">
        <div class="file-icon">üìÑ</div>
        <div class="file-info">
          <div class="file-name" id="file-name"></div>
          <div class="file-size" id="file-size"></div>
        </div>
        <button class="file-remove" id="file-remove">√ó</button>
      </div>
    </div>
    <div class="preview-area" id="preview-area"></div>
  `}function d3(e){const t=e.querySelector("#file-dropzone"),n=e.querySelector("#file-input"),s=e.querySelector("#selected-file"),a=e.querySelector("#preview-btn"),o=e.querySelector("#import-btn");d(t,"click",()=>n.click()),d(t,"dragover",i=>{i.preventDefault(),t.classList.add("dragover")}),d(t,"dragleave",()=>t.classList.remove("dragover")),d(t,"drop",i=>{i.preventDefault(),t.classList.remove("dragover"),i.dataTransfer?.files[0]&&pp(i.dataTransfer.files[0],e)}),d(n,"change",()=>{n.files?.[0]&&pp(n.files[0],e)}),d(e.querySelector("#file-remove"),"click",()=>{s.classList.remove("visible"),e._fileContent=null,a.disabled=!0,o.disabled=!0})}function pp(e,t){const n=t.querySelector("#selected-file"),s=t.querySelector("#preview-btn"),a=t.querySelector("#import-btn");t.querySelector("#file-name").textContent=e.name,t.querySelector("#file-size").textContent=m3(e.size),n.classList.add("visible");const o=new FileReader;o.onload=()=>{t._fileContent=o.result,s.disabled=!1,a.disabled=!1},o.readAsText(e)}function qv(e){return er==="paste"?e.querySelector("#conversation-input")?.value||"":e._fileContent||""}async function u3(e){const t=e.querySelector("#preview-btn"),n=e.querySelector("#preview-area"),s=qv(e);if(s){t.disabled=!0,t.textContent="Parsing...";try{const a=await pa.parsePreview(s);n.classList.add("visible"),n.innerHTML=`
      <h4>Preview</h4>
      <div class="preview-stats">
        <span>Messages: <strong>${a.message_count||0}</strong></span>
        <span>Participants: <strong>${a.participants?.length||0}</strong></span>
        <span>Format: <strong>${a.format||"Unknown"}</strong></span>
      </div>
    `}catch{m.error("Failed to parse conversation")}finally{t.disabled=!1,t.textContent="Preview"}}}async function p3(e,t){const n=e.querySelector("#import-btn"),s=qv(e),a=e.querySelector("#format-select");if(s){n.disabled=!0,n.textContent="Importing...";try{const o=await pa.import(s,{formatHint:a?.value});m.success("Conversation imported"),t.onImport?.(o),Wi()}catch{m.error("Failed to import conversation")}finally{n.disabled=!1,n.textContent="Import"}}}function m3(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}const g3=Object.freeze(Object.defineProperty({__proto__:null,closeConversationComposer:Wi,default:dl,showConversationComposer:dl},Symbol.toStringTag,{value:"Module"}));function v3(e={}){const t=b("div",{className:"conversations-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Conversations</h2>
        <span class="panel-count" id="conversations-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="import-conv-btn">Import</button>
      </div>
    </div>
    <div class="panel-content" id="conversations-content">
      <div class="loading">Loading conversations...</div>
    </div>
  `;const n=t.querySelector("#import-conv-btn");return n&&d(n,"click",()=>b3(t,e)),tr(t,e),t}async function tr(e,t){const n=e.querySelector("#conversations-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=await pa.getAll();f3(n,s,t),y3(e,s.length)}catch{n.innerHTML='<div class="error">Failed to load conversations</div>'}}function f3(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No conversations imported</p>
        <p class="text-muted">Import chat transcripts, meeting notes, or message threads</p>
      </div>
    `;return}e.innerHTML=`
    <div class="conversations-list">
      ${t.map(s=>h3(s)).join("")}
    </div>
  `,e.querySelectorAll(".conversation-card").forEach(s=>{d(s,"click",async i=>{if(i.target.closest(".conv-actions"))return;const r=s.getAttribute("data-id"),c=t.find(l=>l.id===r);if(c){try{const l=await pa.getById(r);sp(l)}catch{sp(c)}n.onConversationClick&&n.onConversationClick(c)}});const a=s.querySelector(".reembed-btn");a&&d(a,"click",async i=>{i.stopPropagation();const r=s.getAttribute("data-id");if(!r)return;const c=a;c.disabled=!0,c.textContent="Processing...";try{await pa.reembed(r),m.success("Conversation re-embedded"),tr(e.closest(".conversations-panel"),n)}catch{m.error("Failed to re-embed conversation"),c.disabled=!1,c.textContent="Re-embed"}});const o=s.querySelector(".delete-conv-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=s.getAttribute("data-id");if(r&&confirm("Delete this conversation?"))try{await pa.delete(r),m.success("Conversation deleted"),tr(e.closest(".conversations-panel"),n)}catch{m.error("Failed to delete conversation")}})})}function h3(e){return`
    <div class="conversation-card" data-id="${e.id}">
      <div class="conv-icon">üí¨</div>
      <div class="conv-info">
        <div class="conv-title">${w3(e.title||"Untitled Conversation")}</div>
        <div class="conv-meta">
          ${e.participants?`<span>${e.participants.length} participants</span>`:""}
          ${e.message_count?`<span>${e.message_count} messages</span>`:""}
          <span>${Ce(e.created_at)}</span>
        </div>
      </div>
      <div class="conv-status">
        ${e.embedded?'<span class="embedded-badge">Embedded</span>':'<span class="not-embedded-badge">Not embedded</span>'}
      </div>
      <div class="conv-actions">
        <button class="btn btn-sm reembed-btn">Re-embed</button>
        <button class="btn btn-sm btn-danger delete-conv-btn">Delete</button>
      </div>
    </div>
  `}function b3(e,t){dl({onImport:()=>{tr(e,t)},onClose:()=>{}})}function y3(e,t){const n=e.querySelector("#conversations-count");n&&(n.textContent=String(t))}function w3(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let ul="all",jv=!1;function Pv(e={}){const t=b("div",{className:"emails-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Emails</h2>
        <span class="panel-count" id="emails-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="direction-filter" class="filter-select">
          <option value="all">All</option>
          <option value="inbound">Inbound</option>
          <option value="outbound">Outbound</option>
          <option value="internal">Internal</option>
        </select>
        <label class="checkbox-label">
          <input type="checkbox" id="needs-response-filter"> Needs Response
        </label>
        <button class="btn btn-primary btn-sm" id="add-email-btn">+ Add Email</button>
      </div>
    </div>
    <div class="panel-content" id="emails-content">
      <div class="loading">Loading emails...</div>
    </div>
  `;const n=t.querySelector("#direction-filter");d(n,"change",()=>{ul=n.value,ki(t,e)});const s=t.querySelector("#needs-response-filter");d(s,"change",()=>{jv=s.checked,ki(t,e)});const a=t.querySelector("#add-email-btn");return a&&d(a,"click",async()=>{const{createEmailComposer:o,showEmailComposer:i}=await xe(async()=>{const{createEmailComposer:r,showEmailComposer:c}=await Promise.resolve().then(()=>Iv);return{createEmailComposer:r,showEmailComposer:c}},void 0);i({onSave:()=>ki(t,e)})}),ki(t,e),t}async function ki(e,t){const n=e.querySelector("#emails-content");n.innerHTML='<div class="loading">Loading...</div>';try{let s;jv?s=await ma.getNeedingResponse():s=(await ma.getAll({direction:ul==="all"?void 0:ul})).emails,k3(n,s,t),S3(e,s.length)}catch{n.innerHTML='<div class="error">Failed to load emails</div>'}}function k3(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No emails found</p>
      </div>
    `;return}e.innerHTML=`
    <div class="emails-list">
      ${t.map(s=>x3(s)).join("")}
    </div>
  `,e.querySelectorAll(".email-card").forEach(s=>{d(s,"click",async i=>{if(i.target.closest(".email-actions"))return;const r=s.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);if(c){try{const l=await ma.getById(r);ap(l)}catch{ap(c)}n.onEmailClick&&n.onEmailClick(c)}});const a=s.querySelector(".mark-responded-btn");a&&d(a,"click",async i=>{i.stopPropagation();const r=s.getAttribute("data-id");if(r)try{await ma.markResponded(r),m.success("Marked as responded"),ki(e.closest(".emails-panel"),n)}catch{m.error("Failed to update email")}});const o=s.querySelector(".generate-response-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=s.getAttribute("data-id");if(!r)return;const c=o;c.disabled=!0,c.textContent="Generating...";try{const u=(await ma.generateResponse(r))[0]?.response||"";m.success("Response generated");const p=t.find(g=>String(g.id)===r);p&&(p.draft_response=u,Xl({mode:"view",email:p}))}catch{m.error("Failed to generate response")}finally{c.disabled=!1,c.textContent="AI Response"}})})}function x3(e){const t=e.direction==="inbound"?"üì•":e.direction==="outbound"?"üì§":"üîÑ",n=e.requires_response&&!e.response_sent;return`
    <div class="email-card ${n?"needs-response":""}" data-id="${e.id}">
      <div class="email-direction">${t}</div>
      <div class="email-info">
        <div class="email-header">
          <span class="email-from">${fc(e.from_name||e.from_email||e.from||"")}</span>
          <span class="email-date">${Ce(e.created_at||e.date||new Date().toISOString())}</span>
        </div>
        <div class="email-subject">${fc(e.subject||"(No subject)")}</div>
        <div class="email-preview">${fc($3(e.body_text||""))}</div>
      </div>
      <div class="email-badges">
        ${n?'<span class="needs-response-badge">Needs Response</span>':""}
        ${e.response_drafted?'<span class="draft-badge">Draft Ready</span>':""}
        ${e.response_sent?'<span class="responded-badge">Responded</span>':""}
        ${e.ai_summary?'<span class="ai-badge">AI Analyzed</span>':""}
      </div>
      <div class="email-actions">
        ${n?`
          <button class="btn btn-sm generate-response-btn">AI Response</button>
          <button class="btn btn-sm mark-responded-btn">Mark Responded</button>
        `:""}
      </div>
    </div>
  `}function $3(e,t=100){const n=e.replace(/\s+/g," ").trim();return n.length>t?n.slice(0,t)+"...":n}function S3(e,t){const n=e.querySelector("#emails-count");n&&(n.textContent=String(t))}function fc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const C3=Object.freeze(Object.defineProperty({__proto__:null,createEmailsPanel:Pv},Symbol.toStringTag,{value:"Module"}));let ad="paste";function pl(e={}){const t=document.getElementById("email-composer-overlay");t&&t.remove();const n=b("div",{id:"email-composer-overlay",className:"composer-overlay"}),s=id(e);n.appendChild(s),document.body.appendChild(n),d(n,"click",a=>{a.target===n&&(Da(),e.onClose?.())}),requestAnimationFrame(()=>n.classList.add("visible"))}function Da(){const e=document.getElementById("email-composer-overlay");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),200))}function id(e={}){const t=b("div",{className:"composer-modal"});return t.innerHTML=`
    <style>
      .composer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .composer-overlay.visible { opacity: 1; }
      .composer-overlay.visible .composer-modal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .composer-modal {
        width: 640px;
        max-width: 95vw;
        max-height: 85vh;
        background: var(--bg-primary);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px) scale(0.98);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .composer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }
      .composer-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .composer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: all 0.15s ease;
      }
      .composer-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .composer-tabs {
        display: flex;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-tab {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        transition: color 0.15s ease;
      }
      .composer-tab:hover { color: var(--text-primary); }
      .composer-tab.active { color: var(--primary); }
      .composer-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        border-radius: 2px 2px 0 0;
      }
      
      .composer-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* Paste Mode */
      .paste-section label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 12px;
      }
      .paste-section textarea {
        width: 100%;
        min-height: 280px;
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      .paste-section textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .paste-section textarea::placeholder { color: var(--text-tertiary); }
      .paste-hint {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-tertiary);
      }
      
      /* Upload Mode */
      .upload-section .dropzone {
        border: 2px dashed var(--border-color);
        border-radius: 16px;
        padding: 60px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
      }
      .upload-section .dropzone:hover,
      .upload-section .dropzone.dragover {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.03);
      }
      .dropzone-icon { font-size: 48px; margin-bottom: 16px; }
      .dropzone-title {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 8px;
      }
      .dropzone-hint { font-size: 13px; color: var(--text-tertiary); }
      
      .selected-file {
        display: none;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }
      .selected-file.visible { display: flex; }
      .file-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      .file-info { flex: 1; min-width: 0; }
      .file-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .file-size { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
      .file-remove {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-tertiary);
        font-size: 18px;
        transition: all 0.15s ease;
      }
      .file-remove:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }
      
      /* Manual Mode */
      .manual-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .form-row {
        display: flex;
        gap: 16px;
      }
      .form-row > .form-group { flex: 1; }
      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .form-group label .required { color: var(--primary); }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }
      .form-group input::placeholder,
      .form-group textarea::placeholder { color: var(--text-tertiary); }
      
      .composer-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-footer .btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      .composer-footer .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .composer-footer .btn-secondary:hover { background: var(--bg-tertiary); }
      .composer-footer .btn-primary {
        background: var(--primary);
        color: white;
      }
      .composer-footer .btn-primary:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .composer-footer .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
    
    <div class="composer-header">
      <h2>Add Email</h2>
      <button class="composer-close" id="close-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="composer-tabs">
      <button class="composer-tab active" data-mode="paste">Paste Text</button>
      <button class="composer-tab" data-mode="upload">Upload .eml/.msg</button>
      <button class="composer-tab" data-mode="manual">Manual Entry</button>
    </div>
    
    <div class="composer-body" id="composer-body">
      ${Dv()}
    </div>
    
    <div class="composer-association" style="padding: 12px 24px; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
      <span style="font-size: 13px; font-weight: 500; color: var(--text-secondary);">Associate with (optional)</span>
      <select id="email-sprint-select" class="form-select" style="min-width: 140px;"><option value="">No sprint</option></select>
      <select id="email-action-select" class="form-select" style="min-width: 180px;"><option value="">No task</option></select>
    </div>
    
    <div class="composer-footer">
      <button class="btn btn-secondary" id="cancel-btn">Cancel</button>
      <button class="btn btn-primary" id="save-btn" disabled>Add Email</button>
    </div>
  `,t.querySelectorAll(".composer-tab").forEach(n=>{d(n,"click",()=>{t.querySelectorAll(".composer-tab").forEach(s=>s.classList.remove("active")),n.classList.add("active"),ad=n.getAttribute("data-mode"),L3(t)})}),d(t.querySelector("#close-btn"),"click",()=>{Da(),e.onClose?.()}),d(t.querySelector("#cancel-btn"),"click",()=>{Da(),e.onClose?.()}),d(t.querySelector("#save-btn"),"click",()=>j3(t,e)),zv(t),_3(t),t}async function _3(e){const t=e.querySelector("#email-sprint-select"),n=e.querySelector("#email-action-select");if(!(!t||!n))try{(await Xi()).forEach(a=>{const o=document.createElement("option");o.value=a.id,o.textContent=a.name,t.appendChild(o)}),d(t,"change",async()=>{const a=t.value||"";if(n.innerHTML='<option value="">No task</option>',!!a)try{(await $l(void 0,a)).forEach(i=>{const r=document.createElement("option");r.value=String(i.id),r.textContent=(i.content||i.task||String(i.id)).slice(0,60)+((i.content||i.task||"").length>60?"‚Ä¶":""),n.appendChild(r)})}catch{}})}catch{}}function L3(e){const t=e.querySelector("#composer-body");switch(ad){case"paste":t.innerHTML=Dv(),zv(e);break;case"upload":t.innerHTML=T3(),A3(e);break;case"manual":t.innerHTML=M3(),E3(e);break}}function Dv(){return`
    <div class="paste-section">
      <label>Paste email content:</label>
      <textarea id="email-paste" placeholder="Paste the full email content here...

Include headers if available:
From: sender@example.com
To: recipient@example.com
Subject: Meeting notes
Date: Jan 31, 2026

Email body text..."></textarea>
      <p class="paste-hint">Include headers (From, To, Subject, Date) for better parsing.</p>
    </div>
  `}function zv(e){const t=e.querySelector("#email-paste"),n=e.querySelector("#save-btn");t&&d(t,"input",()=>{n.disabled=t.value.trim().length<10})}function T3(){return`
    <div class="upload-section">
      <div class="dropzone" id="file-dropzone">
        <div class="dropzone-icon">üìß</div>
        <p class="dropzone-title">Drop email file here</p>
        <p class="dropzone-hint">or click to browse ‚Ä¢ .eml, .msg</p>
        <input type="file" id="file-input" accept=".eml,.msg" hidden>
      </div>
      <div class="selected-file" id="selected-file">
        <div class="file-icon">üìß</div>
        <div class="file-info">
          <div class="file-name" id="file-name"></div>
          <div class="file-size" id="file-size"></div>
        </div>
        <button class="file-remove" id="file-remove">√ó</button>
      </div>
    </div>
  `}function A3(e){const t=e.querySelector("#file-dropzone"),n=e.querySelector("#file-input"),s=e.querySelector("#selected-file"),a=e.querySelector("#save-btn");d(t,"click",()=>n.click()),d(t,"dragover",o=>{o.preventDefault(),t.classList.add("dragover")}),d(t,"dragleave",()=>t.classList.remove("dragover")),d(t,"drop",o=>{o.preventDefault(),t.classList.remove("dragover"),o.dataTransfer?.files[0]&&mp(o.dataTransfer.files[0],e)}),d(n,"change",()=>{n.files?.[0]&&mp(n.files[0],e)}),d(e.querySelector("#file-remove"),"click",()=>{s.classList.remove("visible"),e._emlFile=null,a.disabled=!0})}function mp(e,t){const n=t.querySelector("#selected-file"),s=t.querySelector("#save-btn");t.querySelector("#file-name").textContent=e.name,t.querySelector("#file-size").textContent=P3(e.size),n.classList.add("visible"),t._emlFile=e,s.disabled=!1}function M3(){return`
    <form class="manual-form" id="manual-form">
      <div class="form-row">
        <div class="form-group">
          <label>From <span class="required">*</span></label>
          <input type="email" name="from" placeholder="sender@example.com" required>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="datetime-local" name="date">
        </div>
      </div>
      <div class="form-group">
        <label>To <span class="required">*</span></label>
        <input type="text" name="to" placeholder="recipient@example.com (comma-separated)" required>
      </div>
      <div class="form-group">
        <label>CC</label>
        <input type="text" name="cc" placeholder="cc@example.com (comma-separated)">
      </div>
      <div class="form-group">
        <label>Subject</label>
        <input type="text" name="subject" placeholder="Email subject">
      </div>
      <div class="form-group">
        <label>Body <span class="required">*</span></label>
        <textarea name="body" placeholder="Email content..." required></textarea>
      </div>
    </form>
  `}function E3(e){const t=e.querySelector("#manual-form"),n=e.querySelector("#save-btn"),s=()=>{const a=t.querySelector('[name="from"]'),o=t.querySelector('[name="to"]'),i=t.querySelector('[name="body"]');n.disabled=!a.value||!o.value||!i.value};t.querySelectorAll("input, textarea").forEach(a=>{d(a,"input",s)})}async function q3(e){return new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const a=s.result.split(",")[1];t(a)},s.onerror=n,s.readAsDataURL(e)})}async function j3(e,t){const n=e.querySelector("#save-btn");n.disabled=!0,n.textContent="Processing...";try{let s;switch(ad){case"paste":{s={emailText:e.querySelector("#email-paste").value};break}case"upload":{const r=e._emlFile;if(!r)throw new Error("No file selected");const c=await q3(r);r.name.toLowerCase().endsWith(".msg")?s={msgBase64:c,filename:r.name}:s={emlBase64:c,filename:r.name};break}case"manual":{const r=e.querySelector("#manual-form"),c=new FormData(r);s={from:c.get("from"),to:c.get("to").split(",").map(l=>l.trim()),cc:c.get("cc")?c.get("cc").split(",").map(l=>l.trim()):void 0,subject:c.get("subject"),body:c.get("body"),date:c.get("date")||void 0};break}}const a=e.querySelector("#email-sprint-select")?.value||"",o=e.querySelector("#email-action-select")?.value||"";a&&(s.sprint_id=a),o&&(s.action_id=o);const i=await v.post("/api/emails",s);m.success("Email added successfully"),t.onSave?.(i),Da()}catch(s){m.error("Failed to add email"),console.error("[EmailComposer] Error:",s)}finally{n.disabled=!1,n.textContent="Add Email"}}function P3(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}const Iv=Object.freeze(Object.defineProperty({__proto__:null,closeEmailComposer:Da,createEmailComposer:id,default:pl,showEmailComposer:pl},Symbol.toStringTag,{value:"Module"}));let xi=!1,Rs=0;function Hv(e={}){const t=b("div",{className:"notifications-dropdown"});t.innerHTML=`
    <button class="notifications-trigger" id="notifications-trigger">
      <span class="bell-icon">üîî</span>
      <span class="notification-badge hidden" id="notification-badge">0</span>
    </button>
    <div class="notifications-panel hidden" id="notifications-panel">
      <div class="notifications-header">
        <h3>Notifications</h3>
        <button class="btn-link" id="mark-all-read">Mark all read</button>
      </div>
      <div class="notifications-list" id="notifications-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  `;const n=t.querySelector("#notifications-trigger");n&&d(n,"click",a=>{a.stopPropagation(),D3(t,e)});const s=t.querySelector("#mark-all-read");return s&&d(s,"click",async()=>{try{await Ta.markAllRead(),m.success("All notifications marked as read"),Rv(t,e),nr(t,0)}catch{m.error("Failed to mark notifications as read")}}),document.addEventListener("click",()=>{Bv(t)}),gp(t),setInterval(()=>gp(t),6e4),t}function D3(e,t){xi=!xi;const n=e.querySelector("#notifications-panel");n&&(n.classList.toggle("hidden",!xi),xi&&Rv(e,t))}function Bv(e){xi=!1;const t=e.querySelector("#notifications-panel");t&&t.classList.add("hidden")}async function gp(e){try{const t=await Ta.getUnreadCount();Rs=t,nr(e,t)}catch{}}function nr(e,t){const n=e.querySelector("#notification-badge");n&&(n.textContent=t>99?"99+":String(t),n.classList.toggle("hidden",t===0))}async function Rv(e,t){const n=e.querySelector("#notifications-list");n.innerHTML='<div class="loading">Loading...</div>';try{const s=await Ta.getAll({limit:20});z3(n,s,e,t)}catch{n.innerHTML='<div class="error">Failed to load</div>'}}function z3(e,t,n,s){if(t.length===0){e.innerHTML='<div class="empty">No notifications</div>';return}e.innerHTML=t.map(a=>`
    <div class="notification-item ${a.read?"":"unread"}" data-id="${a.id}">
      <div class="notification-icon">${I3(a.type)}</div>
      <div class="notification-content">
        <div class="notification-title">${vp(a.title)}</div>
        ${a.message?`<div class="notification-message">${vp(a.message)}</div>`:""}
        <div class="notification-time">${Ce(a.created_at)}</div>
      </div>
      <button class="btn-icon dismiss-btn" title="Dismiss">√ó</button>
    </div>
  `).join(""),e.querySelectorAll(".notification-item").forEach(a=>{d(a,"click",async i=>{if(i.target.closest(".dismiss-btn"))return;const r=a.getAttribute("data-id"),c=t.find(l=>l.id===r);c&&(c.read||(await Ta.markRead(r),a.classList.remove("unread"),Rs=Math.max(0,Rs-1),nr(n,Rs)),Bv(n),s.onNotificationClick?.(c))});const o=a.querySelector(".dismiss-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=a.getAttribute("data-id");if(r)try{if(await Ta.delete(r),a.remove(),!a.classList.contains("unread"))return;Rs=Math.max(0,Rs-1),nr(n,Rs)}catch{}})})}function I3(e){switch(e){case"question":return"‚ùì";case"risk":return"‚ö†Ô∏è";case"action":return"‚úÖ";case"decision":return"‚öñÔ∏è";case"mention":return"@";case"comment":return"üí¨";case"assignment":return"üë§";default:return"üì£"}}function vp(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Nv(e,t={}){const n=Hv(t);return e.appendChild(n),n}function H3(e={}){const t=b("div",{className:"members-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Team Members</h2>
        <span class="panel-count" id="members-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="invite-member-btn">+ Invite</button>
      </div>
    </div>
    <div class="panel-content" id="members-content">
      <div class="loading">Loading members...</div>
    </div>
    <div class="pending-invites" id="pending-invites"></div>
  `;const n=t.querySelector("#invite-member-btn");n&&d(n,"click",()=>{const a=e.projectId||N.getState().currentProject?.id;if(!a){m.error("No project selected");return}Ql({projectId:a})});const s=e.projectId||N.getState().currentProject?.id;return s&&(Lo(t,s,e),R3(t,s)),t}async function Lo(e,t,n){const s=e.querySelector("#members-content");s.innerHTML='<div class="loading">Loading...</div>';try{const a=await Ni.getAll(t);B3(s,a,t,n),N3(e,a.length)}catch{s.innerHTML='<div class="error">Failed to load members</div>'}}function B3(e,t,n,s){if(t.length===0){e.innerHTML='<div class="empty">No team members</div>';return}const a=N.getState().currentUser;e.innerHTML=`
    <div class="members-list">
      ${t.map(o=>`
        <div class="member-card" data-id="${o.user_id}">
          <div class="member-avatar">
            ${o.avatar_url?`<img src="${o.avatar_url}" alt="">`:`<span>${O3(o.name||o.email)}</span>`}
          </div>
          <div class="member-info">
            <div class="member-name">${ml(o.name||o.email)}</div>
            <div class="member-email">${ml(o.email)}</div>
          </div>
          <div class="member-role">
            <select class="role-select" data-user-id="${o.user_id}" ${o.user_id===a?.id?"disabled":""}>
              <option value="viewer" ${o.role==="viewer"?"selected":""}>Viewer</option>
              <option value="editor" ${o.role==="editor"?"selected":""}>Editor</option>
              <option value="admin" ${o.role==="admin"?"selected":""}>Admin</option>
              <option value="owner" ${o.role==="owner"?"selected":""}>Owner</option>
            </select>
          </div>
          <button class="btn-icon permissions-btn permissions-btn-icon" data-user-id="${o.user_id}" title="Permissions">üîê</button>
          ${o.user_id!==a?.id?`
            <button class="btn-icon remove-member-btn" data-user-id="${o.user_id}" title="Remove">√ó</button>
          `:""}
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".role-select").forEach(o=>{d(o,"change",async()=>{const i=o.getAttribute("data-user-id"),r=o.value;if(i)try{await Ni.updateRole(i,r,n),m.success("Role updated")}catch{m.error("Failed to update role"),Lo(e.closest(".members-panel"),n,s)}})}),e.querySelectorAll(".remove-member-btn").forEach(o=>{d(o,"click",async()=>{const i=o.getAttribute("data-user-id");if(!(!i||!confirm("Remove this member from the project?")))try{await Ni.remove(n,i),m.success("Member removed"),Lo(e.closest(".members-panel"),n,s)}catch{m.error("Failed to remove member")}})}),e.querySelectorAll(".permissions-btn").forEach(o=>{d(o,"click",()=>{const i=o.getAttribute("data-user-id"),r=t.find(c=>c.user_id===i);r&&Lm({projectId:n,userId:r.user_id,userName:r.name||"",userEmail:r.email,avatarUrl:r.avatar_url,currentRole:r.role,currentPermissions:r.permissions,onSave:()=>{Lo(e.closest(".members-panel"),n,s)}})})}),e.querySelectorAll(".member-card").forEach(o=>{d(o,"click",i=>{if(i.target.closest(".role-select, .remove-member-btn"))return;const r=o.getAttribute("data-id"),c=t.find(l=>l.user_id===r);c&&s.onMemberClick&&s.onMemberClick(c)})})}async function R3(e,t){const n=e.querySelector("#pending-invites");try{const s=await Ni.getInvites(t);if(s.length===0){n.innerHTML="";return}n.innerHTML=`
      <div class="invites-section">
        <h4>Pending Invites</h4>
        <div class="invites-list">
          ${s.map(a=>`
            <div class="invite-card" data-id="${a.id}">
              <div class="invite-info">
                <span class="invite-email">${ml(a.email)}</span>
                <span class="invite-role">${a.role}</span>
                <span class="invite-time">Sent ${Ce(a.invited_at||a.created_at||new Date().toISOString())}</span>
              </div>
              <button class="btn btn-sm cancel-invite-btn" data-id="${a.id}">Cancel</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".cancel-invite-btn").forEach(a=>{d(a,"click",async()=>{if(a.getAttribute("data-id"))try{m.info("Invite cancellation not implemented")}catch{m.error("Failed to cancel invite")}})})}catch{}}function N3(e,t){const n=e.querySelector("#members-count");n&&(n.textContent=String(t))}function O3(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function ml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function F3(e={}){const t=b("div",{className:"api-keys-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>API Keys</h2>
        <span class="panel-count" id="keys-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="create-key-btn">+ Create Key</button>
      </div>
    </div>
    <div class="panel-content" id="keys-content">
      <div class="loading">Loading API keys...</div>
    </div>
  `;const n=t.querySelector("#create-key-btn");return n&&d(n,"click",()=>V3(t,e)),od(t,e),t}async function od(e,t){const n=e.querySelector("#keys-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=await v.get("/api/keys");U3(n,s.data.keys||[],e,t),Z3(e,s.data.keys?.length||0)}catch{n.innerHTML='<div class="error">Failed to load API keys</div>'}}function U3(e,t,n,s){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No API keys created yet</p>
        <p class="hint">Create an API key to access the GodMode API programmatically</p>
      </div>
    `;return}e.innerHTML=`
    <div class="keys-list">
      ${t.map(a=>`
        <div class="key-card" data-id="${a.id}">
          <div class="key-info">
            <div class="key-name">${Ov(a.name)}</div>
            <div class="key-preview">${a.key_prefix}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            <div class="key-meta">
              Created ${Ce(a.created_at)}
              ${a.last_used?`‚Ä¢ Last used ${Ce(a.last_used)}`:"‚Ä¢ Never used"}
              ${a.expires_at?`‚Ä¢ Expires ${Ce(a.expires_at)}`:""}
            </div>
            ${a.scopes.length>0?`
              <div class="key-scopes">
                ${a.scopes.map(o=>`<span class="scope-badge">${o}</span>`).join("")}
              </div>
            `:""}
          </div>
          <div class="key-actions">
            <button class="btn btn-sm revoke-key-btn" data-id="${a.id}">Revoke</button>
          </div>
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".revoke-key-btn").forEach(a=>{d(a,"click",async o=>{o.stopPropagation();const i=a.getAttribute("data-id");if(!(!i||!confirm("Revoke this API key? This action cannot be undone.")))try{await v.delete(`/api/keys/${i}`),m.success("API key revoked"),od(n,s)}catch{m.error("Failed to revoke API key")}})})}function V3(e,t){const n=b("div",{className:"modal-overlay"});n.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create API Key</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <form id="create-key-form" class="modal-body">
        <div class="form-group">
          <label for="key-name">Key Name *</label>
          <input type="text" id="key-name" required placeholder="e.g., My Integration">
        </div>
        <div class="form-group">
          <label for="key-expiry">Expires</label>
          <select id="key-expiry">
            <option value="">Never</option>
            <option value="30">30 days</option>
            <option value="90">90 days</option>
            <option value="365">1 year</option>
          </select>
        </div>
        <div class="form-group">
          <label>Scopes</label>
          <div class="scopes-grid">
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="read" checked> Read
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="write"> Write
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="chat"> Chat
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="admin"> Admin
            </label>
          </div>
        </div>
      </form>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Cancel</button>
        <button class="btn btn-primary" id="submit-key-btn">Create Key</button>
      </div>
    </div>
  `,document.body.appendChild(n),n.querySelectorAll(".close-modal").forEach(a=>{d(a,"click",()=>n.remove())}),d(n,"click",a=>{a.target===n&&n.remove()});const s=n.querySelector("#submit-key-btn");s&&d(s,"click",async()=>{const a=n.querySelector("#create-key-form"),o=a.querySelector("#key-name"),i=a.querySelector("#key-expiry"),r=a.querySelectorAll('input[name="scopes"]:checked');if(!o.value.trim()){m.error("Key name is required");return}const c=Array.from(r).map(u=>u.value),l=s;l.disabled=!0,l.textContent="Creating...";try{const u=await v.post("/api/keys",{name:o.value.trim(),expires_in_days:i.value?parseInt(i.value):null,scopes:c});G3(u.data.key),n.remove(),od(e,t)}catch{m.error("Failed to create API key"),l.disabled=!1,l.textContent="Create Key"}})}function G3(e){const t=b("div",{className:"modal-overlay"});t.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>API Key Created</h2>
      </div>
      <div class="modal-body">
        <p class="warning-text">‚ö†Ô∏è Copy this key now! You won't be able to see it again.</p>
        <div class="key-display">
          <code id="new-key-value">${Ov(e)}</code>
          <button class="btn btn-sm" id="copy-key-btn">Copy</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary close-modal">Done</button>
      </div>
    </div>
  `,document.body.appendChild(t);const n=t.querySelector("#copy-key-btn");n&&d(n,"click",async()=>{try{await navigator.clipboard.writeText(e),m.success("Key copied to clipboard"),n.textContent="Copied!"}catch{m.error("Failed to copy")}}),t.querySelectorAll(".close-modal").forEach(s=>{d(s,"click",()=>t.remove())})}function Z3(e,t){const n=e.querySelector("#keys-count");n&&(n.textContent=String(t))}function Ov(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const W3=["question.created","question.updated","question.answered","risk.created","risk.updated","risk.mitigated","action.created","action.completed","decision.created","decision.approved","decision.rejected","document.uploaded","document.processed","chat.message"];function K3(e={}){const t=b("div",{className:"webhooks-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Webhooks</h2>
        <span class="panel-count" id="webhooks-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="create-webhook-btn">+ Add Webhook</button>
      </div>
    </div>
    <div class="panel-content" id="webhooks-content">
      <div class="loading">Loading webhooks...</div>
    </div>
  `;const n=t.querySelector("#create-webhook-btn");return n&&d(n,"click",()=>Fv(t,e)),rd(t,e),t}async function rd(e,t){const n=e.querySelector("#webhooks-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=await v.get("/api/webhooks");Q3(n,s.data.webhooks||[],e,t),J3(e,s.data.webhooks?.length||0)}catch{n.innerHTML='<div class="error">Failed to load webhooks</div>'}}function Q3(e,t,n,s){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No webhooks configured</p>
        <p class="hint">Webhooks allow you to receive real-time notifications when events occur</p>
      </div>
    `;return}e.innerHTML=`
    <div class="webhooks-list">
      ${t.map(a=>`
        <div class="webhook-card ${a.active?"":"inactive"}" data-id="${a.id}">
          <div class="webhook-status">
            <span class="status-indicator ${a.active?"active":"inactive"}"></span>
          </div>
          <div class="webhook-info">
            <div class="webhook-name">${ji(a.name)}</div>
            <div class="webhook-url">${ji(a.url)}</div>
            <div class="webhook-events">
              ${a.events.slice(0,3).map(o=>`<span class="event-badge">${o}</span>`).join("")}
              ${a.events.length>3?`<span class="more-events">+${a.events.length-3}</span>`:""}
            </div>
            <div class="webhook-meta">
              Created ${Ce(a.created_at)}
              ${a.last_triggered?`‚Ä¢ Last triggered ${Ce(a.last_triggered)} (${a.last_status})`:"‚Ä¢ Never triggered"}
            </div>
          </div>
          <div class="webhook-actions">
            <button class="btn btn-sm test-webhook-btn" data-id="${a.id}">Test</button>
            <button class="btn btn-sm edit-webhook-btn" data-id="${a.id}">Edit</button>
            <button class="btn btn-sm btn-danger delete-webhook-btn" data-id="${a.id}">Delete</button>
          </div>
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".test-webhook-btn").forEach(a=>{d(a,"click",async o=>{o.stopPropagation();const i=a.getAttribute("data-id");if(!i)return;const r=a;r.disabled=!0,r.textContent="Testing...";try{await v.post(`/api/webhooks/${i}/test`),m.success("Test webhook sent")}catch{m.error("Failed to send test webhook")}finally{r.disabled=!1,r.textContent="Test"}})}),e.querySelectorAll(".edit-webhook-btn").forEach(a=>{d(a,"click",o=>{o.stopPropagation();const i=a.getAttribute("data-id"),r=t.find(c=>c.id===i);r&&Fv(n,s,r)})}),e.querySelectorAll(".delete-webhook-btn").forEach(a=>{d(a,"click",async o=>{o.stopPropagation();const i=a.getAttribute("data-id");if(!(!i||!confirm("Delete this webhook?")))try{await v.delete(`/api/webhooks/${i}`),m.success("Webhook deleted"),rd(n,s)}catch{m.error("Failed to delete webhook")}})})}function Fv(e,t,n){const s=!!n,a=b("div",{className:"modal-overlay"});a.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>${s?"Edit Webhook":"Create Webhook"}</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <form id="webhook-form" class="modal-body">
        <div class="form-group">
          <label for="webhook-name">Name *</label>
          <input type="text" id="webhook-name" required value="${ji(n?.name||"")}" placeholder="e.g., Slack Notifications">
        </div>
        <div class="form-group">
          <label for="webhook-url">URL *</label>
          <input type="url" id="webhook-url" required value="${ji(n?.url||"")}" placeholder="https://your-endpoint.com/webhook">
        </div>
        <div class="form-group">
          <label for="webhook-secret">Secret (Optional)</label>
          <input type="text" id="webhook-secret" value="${ji(n?.secret||"")}" placeholder="Used to sign payloads">
        </div>
        <div class="form-group">
          <label>Events *</label>
          <div class="events-grid">
            ${W3.map(i=>`
              <label class="checkbox-label">
                <input type="checkbox" name="events" value="${i}" ${n?.events.includes(i)?"checked":""}>
                ${i}
              </label>
            `).join("")}
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="webhook-active" ${n?.active!==!1?"checked":""}>
            Active
          </label>
        </div>
      </form>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Cancel</button>
        <button class="btn btn-primary" id="submit-webhook-btn">${s?"Save":"Create"}</button>
      </div>
    </div>
  `,document.body.appendChild(a),a.querySelectorAll(".close-modal").forEach(i=>{d(i,"click",()=>a.remove())}),d(a,"click",i=>{i.target===a&&a.remove()});const o=a.querySelector("#submit-webhook-btn");o&&d(o,"click",async()=>{const i=a.querySelector("#webhook-form"),r=i.querySelector("#webhook-name"),c=i.querySelector("#webhook-url"),l=i.querySelector("#webhook-secret"),u=i.querySelector("#webhook-active"),p=i.querySelectorAll('input[name="events"]:checked');if(!r.value.trim()||!c.value.trim()){m.error("Name and URL are required");return}const g=Array.from(p).map(k=>k.value);if(g.length===0){m.error("Select at least one event");return}const f={name:r.value.trim(),url:c.value.trim(),secret:l.value.trim()||void 0,events:g,active:u.checked},h=o;h.disabled=!0,h.textContent=s?"Saving...":"Creating...";try{s?(await v.put(`/api/webhooks/${n.id}`,f),m.success("Webhook updated")):(await v.post("/api/webhooks",f),m.success("Webhook created")),a.remove(),rd(e,t)}catch{m.error(`Failed to ${s?"update":"create"} webhook`),h.disabled=!1,h.textContent=s?"Save":"Create"}})}function J3(e,t){const n=e.querySelector("#webhooks-count");n&&(n.textContent=String(t))}function ji(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let Tn={},An=1;const Uv=50;function Y3(e={}){const t=b("div",{className:"audit-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Audit Log</h2>
        <span class="panel-count" id="audit-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-sm" id="export-audit-btn">Export</button>
        <button class="btn btn-sm" id="filter-audit-btn">Filter</button>
      </div>
    </div>
    <div class="audit-filters hidden" id="audit-filters">
      <div class="filter-row">
        <select id="filter-action" class="filter-select">
          <option value="">All Actions</option>
          <option value="create">Create</option>
          <option value="update">Update</option>
          <option value="delete">Delete</option>
          <option value="login">Login</option>
          <option value="logout">Logout</option>
          <option value="export">Export</option>
        </select>
        <select id="filter-entity" class="filter-select">
          <option value="">All Entities</option>
          <option value="question">Questions</option>
          <option value="risk">Risks</option>
          <option value="action">Actions</option>
          <option value="decision">Decisions</option>
          <option value="contact">Contacts</option>
          <option value="document">Documents</option>
          <option value="user">Users</option>
          <option value="project">Projects</option>
        </select>
        <input type="date" id="filter-from" class="filter-date" placeholder="From">
        <input type="date" id="filter-to" class="filter-date" placeholder="To">
        <button class="btn btn-sm" id="apply-filters-btn">Apply</button>
        <button class="btn btn-sm" id="clear-filters-btn">Clear</button>
      </div>
    </div>
    <div class="panel-content" id="audit-content">
      <div class="loading">Loading audit logs...</div>
    </div>
    <div class="audit-pagination" id="audit-pagination"></div>
  `;const n=t.querySelector("#filter-audit-btn");n&&d(n,"click",()=>{t.querySelector("#audit-filters")?.classList.toggle("hidden")});const s=t.querySelector("#apply-filters-btn");s&&d(s,"click",()=>{Tn={action:t.querySelector("#filter-action").value||void 0,entity_type:t.querySelector("#filter-entity").value||void 0,from_date:t.querySelector("#filter-from").value||void 0,to_date:t.querySelector("#filter-to").value||void 0},An=1,Pi(t,e)});const a=t.querySelector("#clear-filters-btn");a&&d(a,"click",()=>{Tn={},An=1,t.querySelector("#filter-action").value="",t.querySelector("#filter-entity").value="",t.querySelector("#filter-from").value="",t.querySelector("#filter-to").value="",Pi(t,e)});const o=t.querySelector("#export-audit-btn");return o&&d(o,"click",()=>sA()),Pi(t,e),t}async function Pi(e,t){const n=e.querySelector("#audit-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=new URLSearchParams;s.set("page",String(An)),s.set("limit",String(Uv)),Tn.action&&s.set("action",Tn.action),Tn.entity_type&&s.set("entity_type",Tn.entity_type),Tn.from_date&&s.set("from_date",Tn.from_date),Tn.to_date&&s.set("to_date",Tn.to_date);const a=await v.get(`/api/audit?${s}`);X3(n,a.data.logs||[]),aA(e,a.data.total),tA(e,a.data.total,t)}catch{n.innerHTML='<div class="error">Failed to load audit logs</div>'}}function X3(e,t){if(t.length===0){e.innerHTML='<div class="empty">No audit logs found</div>';return}e.innerHTML=`
    <div class="audit-table">
      <div class="audit-header">
        <span class="audit-col time">Time</span>
        <span class="audit-col user">User</span>
        <span class="audit-col action">Action</span>
        <span class="audit-col entity">Entity</span>
        <span class="audit-col details">Details</span>
      </div>
      <div class="audit-body">
        ${t.map(n=>`
          <div class="audit-row" data-id="${n.id}">
            <span class="audit-col time" title="${new Date(n.created_at).toLocaleString()}">
              ${Ce(n.created_at)}
            </span>
            <span class="audit-col user">
              ${n.user_name||n.user_email||"System"}
              ${n.ip_address?`<span class="ip-address">${n.ip_address}</span>`:""}
            </span>
            <span class="audit-col action">
              <span class="action-badge ${eA(n.action)}">${n.action}</span>
            </span>
            <span class="audit-col entity">
              ${n.entity_type}${n.entity_id?` #${n.entity_id.slice(0,8)}`:""}
            </span>
            <span class="audit-col details">
              ${n.details?'<button class="btn-link view-details-btn">View</button>':"-"}
            </span>
          </div>
        `).join("")}
      </div>
    </div>
  `,e.querySelectorAll(".view-details-btn").forEach((n,s)=>{d(n,"click",()=>{const a=t[s];a?.details&&nA(a)})})}function eA(e){return e.includes("create")?"create":e.includes("update")?"update":e.includes("delete")?"delete":e.includes("login")?"login":e.includes("export")?"export":""}function tA(e,t,n){const s=e.querySelector("#audit-pagination"),a=Math.ceil(t/Uv);if(a<=1){s.innerHTML="";return}s.innerHTML=`
    <button class="btn btn-sm" id="prev-page" ${An===1?"disabled":""}>Previous</button>
    <span class="page-info">Page ${An} of ${a}</span>
    <button class="btn btn-sm" id="next-page" ${An===a?"disabled":""}>Next</button>
  `;const o=s.querySelector("#prev-page");o&&d(o,"click",()=>{An>1&&(An--,Pi(e,n))});const i=s.querySelector("#next-page");i&&d(i,"click",()=>{An<a&&(An++,Pi(e,n))})}function nA(e){const t=b("div",{className:"modal-overlay"});t.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Audit Log Details</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <div class="modal-body">
        <div class="detail-row">
          <span class="detail-label">ID:</span>
          <span class="detail-value">${e.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time:</span>
          <span class="detail-value">${new Date(e.created_at).toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Action:</span>
          <span class="detail-value">${e.action}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Entity:</span>
          <span class="detail-value">${e.entity_type} ${e.entity_id||""}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">User:</span>
          <span class="detail-value">${e.user_name||e.user_email||"System"}</span>
        </div>
        ${e.ip_address?`
          <div class="detail-row">
            <span class="detail-label">IP Address:</span>
            <span class="detail-value">${e.ip_address}</span>
          </div>
        `:""}
        <div class="detail-row">
          <span class="detail-label">Details:</span>
          <pre class="detail-json">${JSON.stringify(e.details,null,2)}</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary close-modal">Close</button>
      </div>
    </div>
  `,document.body.appendChild(t),t.querySelectorAll(".close-modal").forEach(n=>{d(n,"click",()=>t.remove())}),d(t,"click",n=>{n.target===t&&t.remove()})}function sA(e){const t=b("div",{className:"modal-overlay"});t.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Export Audit Logs</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Date Range</label>
          <div class="date-range">
            <input type="date" id="export-from" placeholder="From">
            <span>to</span>
            <input type="date" id="export-to" placeholder="To">
          </div>
        </div>
        <div class="form-group">
          <label>Format</label>
          <select id="export-format">
            <option value="csv">CSV</option>
            <option value="json">JSON</option>
          </select>
        </div>
        <div class="form-group">
          <label>Include</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="include" value="details" checked> Details
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="include" value="ip"> IP Addresses
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Cancel</button>
        <button class="btn btn-primary" id="export-btn">Export</button>
      </div>
    </div>
  `,document.body.appendChild(t),t.querySelectorAll(".close-modal").forEach(s=>{d(s,"click",()=>t.remove())}),d(t,"click",s=>{s.target===t&&t.remove()});const n=t.querySelector("#export-btn");n&&d(n,"click",async()=>{const s=t.querySelector("#export-from").value,a=t.querySelector("#export-to").value,o=t.querySelector("#export-format").value,i=t.querySelectorAll('input[name="include"]:checked'),r=Array.from(i).map(l=>l.value),c=n;c.disabled=!0,c.textContent="Exporting...";try{const l=new URLSearchParams;l.set("format",o),s&&l.set("from_date",s),a&&l.set("to_date",a),r.forEach(h=>l.append("include",h));const u=await at(`/api/audit/export?${l}`);if(!u.ok)throw new Error("Export failed");const p=await u.blob(),g=URL.createObjectURL(p),f=document.createElement("a");f.href=g,f.download=`audit-logs-${new Date().toISOString().split("T")[0]}.${o}`,f.click(),URL.revokeObjectURL(g),m.success("Audit logs exported"),t.remove()}catch{m.error("Failed to export audit logs"),c.disabled=!1,c.textContent="Export"}})}function aA(e,t){const n=e.querySelector("#audit-count");n&&(n.textContent=String(t))}const Vv=[{id:"project",name:"Project",icon:"üìã",examples:"Project Manager, Scrum Master, Product Owner"},{id:"technical",name:"Technical",icon:"üíª",examples:"Developer, Architect, DevOps, QA"},{id:"management",name:"Management",icon:"üëî",examples:"Director, VP, C-Level"},{id:"stakeholder",name:"Stakeholder",icon:"ü§ù",examples:"Client, Sponsor, External Partner"},{id:"custom",name:"Custom",icon:"‚ú®",examples:"Custom roles for your team"}];let sr=[],xa=null;async function Gv(e){e.innerHTML=`
    <style>
      .roles-panel-sota {
        padding: 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .roles-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
      }
      
      .roles-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .roles-header h2 svg {
        width: 28px;
        height: 28px;
        color: #e11d48;
      }
      
      .roles-header-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 4px;
        font-weight: 400;
      }
      
      .btn-create-role {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-create-role:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .roles-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
      }
      
      @media (max-width: 900px) {
        .roles-layout {
          grid-template-columns: 1fr;
        }
      }
      
      .roles-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .role-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      
      .role-card:hover {
        border-color: #e11d48;
        transform: translateX(4px);
      }
      
      .role-card.active {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.08) 0%, rgba(225,29,72,0.03) 100%);
      }
      
      .role-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      
      .role-color-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      
      .role-card-name {
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }
      
      .role-card-badges {
        display: flex;
        gap: 4px;
      }
      
      .role-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
      }
      
      .role-badge.template {
        background: #dbeafe;
        color: #1d4ed8;
      }
      
      .role-badge.system {
        background: #fef3c7;
        color: #92400e;
      }
      
      .role-card-category {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }
      
      .role-card-desc {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      /* Editor Panel */
      .role-editor {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        overflow: hidden;
      }
      
      .role-editor-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 24px;
        color: white;
      }
      
      .role-editor-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
      }
      
      .role-editor-body {
        padding: 24px;
      }
      
      .form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .form-group {
        flex: 1;
      }
      
      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s;
        box-sizing: border-box;
      }
      
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .form-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 6px;
      }
      
      .ai-enhance-section {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        margin-top: 12px;
      }
      
      .ai-enhance-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      
      .ai-enhance-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }
      
      .ai-enhance-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .ai-enhance-btn svg {
        width: 14px;
        height: 14px;
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .spin {
        animation: spin 1s linear infinite;
      }
      
      /* Actions */
      .role-editor-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
      }
      
      .btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }
      
      .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      
      .btn-secondary:hover {
        background: var(--bg-tertiary);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .btn-danger {
        background: #fee2e2;
        color: #dc2626;
      }
      
      .btn-danger:hover {
        background: #fecaca;
      }
      
      .template-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        padding: 14px 16px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border: 1px solid #86efac;
        border-radius: 12px;
      }
      
      .template-toggle label {
        margin: 0;
        font-size: 13px;
        color: #166534;
        font-weight: 500;
      }
      
      .template-toggle input {
        accent-color: #16a34a;
        width: 18px;
        height: 18px;
      }
      
      .empty-state {
        text-align: center;
        padding: 48px;
        color: var(--text-muted);
      }
      
      .empty-state svg {
        width: 64px;
        height: 64px;
        opacity: 0.3;
        margin-bottom: 16px;
      }
      
      .info-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #93c5fd;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .info-card h4 {
        margin: 0 0 8px;
        font-size: 14px;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .info-card p {
        margin: 0;
        font-size: 13px;
        color: #3b82f6;
        line-height: 1.5;
      }
    </style>
    
    <div class="roles-panel-sota">
      <div class="roles-header">
        <div>
          <h2>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
            </svg>
            Role Templates
          </h2>
          <div class="roles-header-subtitle">Define roles to assign to team members and contacts. The AI uses role context to adapt responses.</div>
        </div>
        <button class="btn-create-role" id="btn-create-role">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create Role
        </button>
      </div>
      
      <div class="roles-layout">
        <div class="roles-list" id="roles-list">
          <div class="empty-state">Loading roles...</div>
        </div>
        
        <div class="role-editor hidden" id="role-editor">
          <!-- Editor content will be rendered here -->
        </div>
      </div>
    </div>
  `,await gl(e);const t=e.querySelector("#btn-create-role");t&&d(t,"click",()=>{xa=null,Zv(e,null)})}async function gl(e){const t=e.querySelector("#roles-list");if(t)try{if(sr=(await v.get("/api/role-templates")).data.roles||[],sr.length===0){t.innerHTML=`
        <div class="empty-state">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197"/>
          </svg>
          <p>No roles defined yet</p>
          <p class="empty-state-hint">Click "Create Role" to get started</p>
        </div>
      `;return}iA(t,e)}catch(n){console.error("[RolesPanel] Failed to load roles:",n),t.innerHTML='<div class="empty-state">Failed to load roles</div>'}}function iA(e,t){const n=Object.fromEntries(Vv.map(s=>[s.id,s]));e.innerHTML=sr.map(s=>{const a=n[s.category||"custom"];return`
      <div class="role-card${xa?.id===s.id?" active":""}" data-id="${s.id}">
        <div class="role-card-header">
          <div class="role-color-dot" style="--role-color: ${s.color||"#e11d48"}"></div>
          <div class="role-card-name">${Di(s.display_name||s.name)}</div>
          <div class="role-card-badges">
            ${s.is_template?'<span class="role-badge template">Template</span>':""}
            ${s.is_system?'<span class="role-badge system">System</span>':""}
          </div>
        </div>
        <div class="role-card-category">${a?.icon||"‚ú®"} ${a?.name||"Custom"}</div>
        ${s.description?`<div class="role-card-desc">${Di(s.description)}</div>`:""}
      </div>
    `}).join(""),e.querySelectorAll(".role-card").forEach(s=>{d(s,"click",()=>{const a=s.getAttribute("data-id"),o=sr.find(i=>i.id===a);o&&(xa=o,e.querySelectorAll(".role-card").forEach(i=>i.classList.remove("active")),s.classList.add("active"),Zv(t,o))})})}function Zv(e,t){const n=e.querySelector("#role-editor");if(!n)return;n.classList.remove("hidden");const s=!t;n.innerHTML=`
    <div class="role-editor-header">
      <h3>${s?"Create New Role":"Edit Role"}</h3>
    </div>
    
    <div class="role-editor-body">
      <div class="info-card">
        <h4>üí° How Role Templates Work</h4>
        <p>Role templates define job titles and context that helps the AI understand each person's perspective. When you assign a role to a team member or contact, the AI adapts its responses to be more relevant to their responsibilities.</p>
      </div>
      
      <form id="role-form">
        <div class="form-row">
          <div class="form-group role-form-flex-2">
            <label>Role Name *</label>
            <input type="text" id="role-name" required value="${Di(t?.display_name||t?.name||"")}" placeholder="e.g., Project Manager, Senior Developer">
          </div>
          <div class="form-group role-form-flex-1">
            <label>Category</label>
            <select id="role-category">
              ${Vv.map(a=>`
                <option value="${a.id}" ${t?.category===a.id?"selected":""}>${a.icon} ${a.name}</option>
              `).join("")}
            </select>
          </div>
          <div class="form-group role-form-w-80">
            <label>Color</label>
            <input type="color" id="role-color" class="role-color-input" value="${t?.color||"#e11d48"}">
          </div>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="role-description" rows="2" placeholder="Brief description of this role's main responsibilities...">${Di(t?.description||"")}</textarea>
          <div class="form-hint">A short summary shown in role lists and dropdowns.</div>
        </div>
        
        <div class="form-group">
          <label>Role Context (for AI)</label>
          <textarea id="role-context" rows="6" placeholder="Describe this role in detail for the AI:&#10;&#10;‚Ä¢ What are their main responsibilities?&#10;‚Ä¢ What decisions do they typically make?&#10;‚Ä¢ What information is most relevant to them?&#10;‚Ä¢ How should the AI adapt its tone and detail level?">${Di(t?.role_context||"")}</textarea>
          <div class="form-hint">This context helps the AI provide more relevant and targeted responses when interacting with people in this role.</div>
          <div class="ai-enhance-section">
            <button type="button" class="ai-enhance-btn" id="btn-ai-enhance">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Enhance with AI
            </button>
            <span class="form-hint role-form-hint-ai">Let AI generate or improve the role context based on the role name.</span>
          </div>
        </div>
        
        <div class="template-toggle">
          <input type="checkbox" id="is-template" ${t?.is_template!==!1?"checked":""}>
          <label for="is-template">Save as template (reusable across all projects)</label>
        </div>
        
        <div class="role-editor-actions">
          ${!s&&!t?.is_system?`
            <button type="button" class="btn btn-danger" id="btn-delete-role">Delete</button>
          `:""}
          <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
          <button type="submit" class="btn btn-primary">${s?"Create Role":"Save Changes"}</button>
        </div>
      </form>
    </div>
  `,oA(e,t)}function oA(e,t){const n=e.querySelector("#role-editor");if(!n)return;const s=n.querySelector("#btn-cancel");s&&d(s,"click",()=>{n.classList.add("hidden"),xa=null;const r=e.querySelector("#roles-list");r&&r.querySelectorAll(".role-card").forEach(c=>c.classList.remove("active"))});const a=n.querySelector("#btn-delete-role");a&&t&&d(a,"click",async()=>{if(confirm(`Are you sure you want to delete "${t.display_name||t.name}"?`))try{await v.delete(`/api/role-templates/${t.id}`),m.success("Role deleted"),n.classList.add("hidden"),xa=null,await gl(e)}catch{m.error("Failed to delete role")}});const o=n.querySelector("#btn-ai-enhance");o&&d(o,"click",async()=>{const r=n.querySelector("#role-name"),c=n.querySelector("#role-context"),l=n.querySelector("#role-description"),u=r.value.trim();if(!u){m.error("Please enter a role name first");return}o.disabled=!0,o.innerHTML='<svg class="spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Enhancing...';try{const p=await v.post("/api/roles/generate",{title:u,currentContext:c.value});p.data.prompt&&(c.value=p.data.prompt),p.data.description&&!l.value&&(l.value=p.data.description),m.success("Role context enhanced with AI")}catch{m.error("Failed to enhance with AI")}finally{o.disabled=!1,o.innerHTML='<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Enhance with AI'}});const i=n.querySelector("#role-form");i&&d(i,"submit",async r=>{r.preventDefault();const c=n.querySelector("#role-name").value.trim(),l=n.querySelector("#role-category").value,u=n.querySelector("#role-color").value,p=n.querySelector("#role-description").value.trim(),g=n.querySelector("#role-context").value.trim(),f=n.querySelector("#is-template").checked,h={name:c.toLowerCase().replace(/\s+/g,"_"),display_name:c,description:p,role_context:g,category:l,color:u,is_template:f};try{t?(await v.put(`/api/role-templates/${t.id}`,h),m.success("Role updated")):(await v.post("/api/role-templates",h),m.success("Role created")),n.classList.add("hidden"),xa=null,await gl(e)}catch{m.error("Failed to save role")}})}function Di(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const rA=Object.freeze(Object.defineProperty({__proto__:null,renderRolesPanel:Gv},Symbol.toStringTag,{value:"Module"}));let ar=[],ir=[],cd=!1,zi=!1,$a=[],ln=null,Wv=!1,vl=!1,hc=!1,Ii="llm",_n={},To=[],or=[],Ns=[],fl=!1,Vs={enabled:!0,access:"admin_only"},Sa=!1,Ki=!1,aa=[],ua=null,vn=[],Vn=null,Gn=!1,rr=!1,hl=null,cr=!1,Gs=!1;async function Kv(){try{const e=await v.get("/api/system/config");if(_n={},e.data?.llm_pertask){_n.llm=[];const t=e.data.llm_pertask;t.text&&_n.llm.push({key:"text_provider",value:t.text,category:"llm"}),t.vision&&_n.llm.push({key:"vision_provider",value:t.vision,category:"llm"}),t.embeddings&&_n.llm.push({key:"embeddings_provider",value:t.embeddings,category:"llm"})}e.data?.processing&&(_n.processing=[{key:"processing",value:e.data.processing,category:"processing"}]),e.data?.graph&&(_n.graph=[{key:"graph",value:e.data.graph,category:"graph"}]),console.log("[AdminPanel] Loaded system config:",_n)}catch(e){console.warn("Failed to load system config:",e),_n={}}}async function cA(){try{hc=((await v.get("/api/secrets")).data?.secrets||[]).some(n=>n.name==="GRAPH_PASSWORD"),console.log("[AdminPanel] Graph password set:",hc)}catch(e){console.warn("Failed to load secrets:",e),hc=!1}}const lA=[{id:"openai",name:"OpenAI"},{id:"anthropic",name:"Anthropic (Claude)"},{id:"google",name:"Google AI (Gemini)"},{id:"xai",name:"xAI (Grok)"},{id:"deepseek",name:"DeepSeek"},{id:"kimi",name:"Kimi (Moonshot)"},{id:"minimax",name:"MiniMax"},{id:"ollama",name:"Ollama (Local)"}];async function dA(){const e=lA.map(t=>({id:t.id,name:t.name,enabled:!1,models:[]}));try{const n=(await v.get("/api/llm/providers")).data?.providers;Array.isArray(n)&&n.length>0?To=n.map(s=>({id:s.id,name:s.name??s.label??s.id,enabled:s.enabled??!1,models:Array.isArray(s.models)?s.models:[]})):To=e}catch(t){console.warn("Failed to load providers, using defaults:",t),To=e}}async function Qv(){try{const e=await v.get("/api/system/audit?limit=50");or=Array.isArray(e.data?.logs)?e.data.logs:[]}catch(e){console.warn("Failed to load audit logs:",e),or=[]}}async function bl(){try{const e=await v.get("/api/system/prompts");Ns=Array.isArray(e.data?.prompts)?e.data.prompts:[]}catch(e){console.warn("Failed to load system prompts:",e),Ns=[{id:"1",key:"document",name:"Document Extraction",description:"Extract information from PDFs and text files",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"2",key:"transcript",name:"Transcript Extraction",description:"Extract information from meeting transcripts",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"3",key:"vision",name:"Vision/Image Extraction",description:"Extract information from images and diagrams",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"4",key:"conversation",name:"Conversation Extraction",description:"Extract information from chat conversations",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"5",key:"email",name:"Email Extraction",description:"Extract information from emails",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"6",key:"summary",name:"Content Summary",description:"Generate concise summaries",category:"analysis",prompt_template:"",uses_ontology:!1}]}}async function fp(){zi=!0;try{const[e,t]=await Promise.all([v.get("/api/ontology/entities"),v.get("/api/ontology/relations")]);ar=e.data?.entityTypes??[],ir=t.data?.relationTypes??[],cd=!0}catch(e){console.warn("Failed to load ontology:",e),ar=[],ir=[]}finally{zi=!1}}async function hp(){vl=!0;try{const[e,t]=await Promise.all([v.get("/api/graph/list"),v.get("/api/graph/status").catch(()=>({data:{}}))]);$a=e.data?.graphs??[],e.data?.error&&($a=[]),ln=t.data??null,Wv=!0}catch(e){console.warn("Failed to load graph overview:",e),$a=[],ln=null}finally{vl=!1}}async function ds(e,t,n){try{await v.post("/api/system/config",{key:e,value:t,category:n}),m.success("Configuration saved"),await Kv()}catch{m.error("Failed to save configuration")}}async function uA(e){try{const t=await v.post(`/api/llm/test/${e}`);if(t.data.ok){const n=t.data.models?` (${t.data.models} models)`:"";m.success(`${e} connection successful${n}`)}else m.error(t.data.error?.message||"Connection failed")}catch{m.error("Connection test failed")}}function Wn(e,t,n=""){const s=_n[e]||[];if(e==="graph"){const o=s.find(i=>i.key==="graph");if(o?.value&&typeof o.value=="object")return o.value[t]??n}return s.find(o=>o.key===t)?.value??n}function pA(){return[{id:"llm",label:"LLM Providers",icon:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"},{id:"models",label:"Model Metadata",icon:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"},{id:"queue",label:"LLM Queue",icon:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},{id:"graph",label:"Graph",icon:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"},{id:"ontology",label:"Ontology",icon:"M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"},{id:"prompts",label:"Prompts",icon:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"},{id:"processing",label:"Processing",icon:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"},{id:"team-analysis",label:"Team Analysis",icon:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"},{id:"google-drive",label:"Google Drive",icon:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"},{id:"billing",label:"Billing",icon:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"},{id:"audit",label:"Audit Log",icon:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"}].map(t=>`
    <button class="admin-nav-btn ${Ii===t.id?"active":""}" data-section="${t.id}">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${t.icon}"/>
      </svg>
      <span>${t.label}</span>
    </button>
  `).join("")}function bp(){const e=["text","vision","embeddings"];return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>LLM Provider Configuration</h3>
        <p>Configure AI providers for different task types</p>
      </div>

      <!-- Provider Status -->
      <div class="admin-card">
        <h4>Provider Health</h4>
        <div class="provider-grid">
          ${To.map(t=>`
            <div class="provider-card ${t.enabled?"enabled":"disabled"}">
              <div class="provider-header">
                <span class="provider-name">${t.name}</span>
                <span class="provider-status ${t.status||"unknown"}">${t.status||"unknown"}</span>
              </div>
              <div class="provider-models">${t.models&&t.models.length>0?t.models.slice(0,3).join(", "):"‚Äî"}</div>
              <div class="provider-actions">
                <button class="btn-sm" data-test-provider="${t.id}">Test</button>
                <label class="toggle-switch">
                  <input type="checkbox" ${t.enabled?"checked":""} data-toggle-provider="${t.id}">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          `).join("")}
        </div>
      </div>

      <!-- Task Configuration -->
      <div class="admin-card">
        <h4>Task-Specific AI Configuration</h4>
        <p class="text-muted">Configure which provider and model to use for each AI task. These settings apply globally to the platform and are persisted in Supabase.</p>
        
        ${e.map(t=>{const n=Wn("llm",t+"_provider",{provider:"",model:""}),s={text:"üí¨",vision:"üëÅÔ∏è",embeddings:"üîó"},a={text:"Text / Chat",vision:"Vision / Images",embeddings:"Embeddings"},o={text:"Document analysis, chat, briefings, Q&A, extraction",vision:"Image analysis, scanned documents, diagrams, charts",embeddings:"Semantic search, similarity matching, RAG"},i=s[t]||"‚öôÔ∏è",r=a[t]||t,c=o[t]||"",l=["openai","anthropic","google","deepseek","grok","kimi","minimax","ollama"],u={openai:"OpenAI",anthropic:"Anthropic (Claude)",google:"Google AI (Gemini)",deepseek:"DeepSeek",grok:"xAI (Grok)",kimi:"Kimi (Moonshot)",minimax:"MiniMax",ollama:"Ollama (Local)"};return'<div class="task-config-row admin-task-config-row" data-task-row="'+t+'"><div class="task-label admin-task-label"><span class="admin-task-label-icon">'+i+'</span><strong class="admin-task-label-strong">'+r+'</strong><span class="text-muted admin-task-desc">'+c+'</span></div><div class="task-selects admin-task-selects"><div><label class="admin-field-label">Provider</label><select class="form-select provider-select" data-task="'+t+'" data-field="provider"><option value=""'+(n.provider?"":" selected")+">-- Select Provider --</option>"+l.map(p=>'<option value="'+p+'"'+(n.provider===p?" selected":"")+">"+u[p]+"</option>").join("")+'</select></div><div><label class="admin-field-label">Model</label><select class="form-select model-select" data-task="'+t+'" data-field="model"><option value="">-- Select Provider First --</option>'+(n.model?'<option value="'+n.model+'" selected>'+n.model+"</option>":"")+'</select><span class="model-loading hidden" data-task="'+t+'">Loading models...</span></div></div><div class="model-status admin-model-status" data-task="'+t+'"></div></div>'}).join("")}
        
        <div class="admin-llm-save-row">
          <button class="btn-primary" id="save-llm-config">Save LLM Configuration</button>
          <span class="text-muted admin-llm-warning">‚ö†Ô∏è Changes apply immediately to all AI processing</span>
        </div>
      </div>

      <!-- API Keys - LLM Providers -->
      <div class="admin-card">
        <h4>LLM API Keys</h4>
        <p class="text-muted">System-level API keys (stored encrypted in Supabase)</p>
        
        <div class="api-keys-grid" id="api-keys-container">
          <div class="form-group" data-secret-name="OPENAI_API_KEY">
            <label>OpenAI <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="openai-key" name="llm_key_openai_${Date.now()}" placeholder="sk-proj-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="openai-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="CLAUDE_API_KEY">
            <label>Anthropic (Claude) <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="anthropic-key" name="llm_key_claude_${Date.now()}" placeholder="sk-ant-api03-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="anthropic-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="GOOGLE_API_KEY">
            <label>Google AI (Gemini) <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="google-key" name="llm_key_google_${Date.now()}" placeholder="AIza..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="google-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="XAI_API_KEY">
            <label>xAI (Grok) <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="xai-key" name="llm_key_xai_${Date.now()}" placeholder="xai-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="xai-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="DEEPSEEK_API_KEY">
            <label>DeepSeek <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="deepseek-key" name="llm_key_deepseek_${Date.now()}" placeholder="sk-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="deepseek-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="KIMI_API_KEY">
            <label>Kimi (Moonshot) <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="kimi-key" name="llm_key_kimi_${Date.now()}" placeholder="sk-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="kimi-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="MINIMAX_API_KEY">
            <label>MiniMax <span class="key-status admin-key-status"></span></label>
            <div class="input-group">
              <input type="text" id="minimax-key" name="llm_key_minimax_${Date.now()}" placeholder="MINIMAX-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="minimax-key">Show</button>
            </div>
          </div>
        </div>
        
        <div id="api-keys-loading" class="admin-keys-loading">Loading configured keys...</div>
        <button class="btn-primary mt-4" id="save-api-keys">Save LLM API Keys</button>
      </div>

      <!-- Service API Keys -->
      <div class="admin-card">
        <h4>Service API Keys</h4>
        <p class="text-muted">Keys for email, notifications and other services</p>
        
        <div class="form-group" data-secret-name="RESEND_API_KEY">
          <label>Resend API Key (Email Service) <span class="key-status admin-key-status"></span></label>
          <div class="input-group">
            <input type="text" id="resend-key" name="service_key_resend_${Date.now()}" placeholder="re_..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
            <button class="btn-icon" data-toggle-visibility="resend-key">Show</button>
          </div>
        </div>
        
        <div class="form-group" data-secret-name="BRAVE_API_KEY">
          <label>Brave Search API Key (Company analysis) <span class="key-status admin-key-status"></span></label>
          <div class="input-group">
            <input type="password" id="brave-key" name="service_key_brave_${Date.now()}" placeholder="Optional ‚Äì for richer company reports" class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
            <button class="btn-icon" data-toggle-visibility="brave-key">Show</button>
          </div>
          <p class="text-muted text-sm">Get key at <a href="https://api-dashboard.search.brave.com/documentation" target="_blank" rel="noopener">Brave Search API</a>. Used to enrich company analysis with web search.</p>
        </div>
        
        <button class="btn-primary mt-4" id="save-service-keys">Save Service Keys</button>
      </div>
    </div>
  `}function mA(){const e={enabled:Wn("graph","enabled",!1),graphName:Wn("graph","graphName","godmode")};return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Graph Database Configuration</h3>
        <p>Supabase Graph for knowledge graph and GraphRAG</p>
      </div>

      <div class="admin-card">
        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="graph-enabled" ${e.enabled?"checked":""}>
            <span>Enable Graph Database</span>
          </label>
        </div>

        <div class="form-group admin-form-group-box">
          <p class="admin-form-group-p">
            <strong>Provider:</strong> Supabase Graph (PostgreSQL-based)
          </p>
          <p class="admin-form-group-p-sm">
            Uses your existing Supabase connection. No additional configuration needed.
          </p>
        </div>

        <div class="form-group">
          <label>Graph Name</label>
          <input type="text" id="graph-name" value="${e.graphName}" class="form-input" placeholder="godmode">
        </div>

        <div class="btn-group mt-4">
          <button class="btn-primary" id="save-graph-config">Save Configuration</button>
          <button class="btn-secondary" id="test-graph-connection">Test Connection</button>
        </div>
      </div>

      <div class="admin-card" id="graph-overview-card">
        <h4>Graph overview</h4>
        <p class="text-muted">Current graph status. Enable and save configuration above first.</p>
        <div id="graph-overview-content">
          ${vl?'<p class="text-muted">Loading...</p>':Wv?$a.length===0&&!ln?.enabled?'<p class="text-muted">Graph not enabled or not connected. Enable and save configuration.</p><button class="btn-secondary mt-4" id="refresh-graph-overview">Refresh</button>':`
            ${ln?.enabled&&(ln.stats!=null||ln.graphName)?`
              <div class="graph-status-row admin-graph-status-row">
                <strong>Current graph:</strong> ${ln.graphName??"‚Äî"}
                ${ln.stats?.nodes!==void 0?` ¬∑ Nodes: ${ln.stats.nodes}`:""}
                ${ln.stats?.relationships!==void 0?` ¬∑ Edges: ${ln.stats.relationships}`:""}
              </div>
            `:""}
            ${$a.length>0?`
              <table class="admin-table admin-table-full">
                <thead><tr><th>Graph name</th><th>Project</th></tr></thead>
                <tbody>
                  ${$a.map(t=>`<tr><td><code>${t.graphName}</code></td><td>${t.projectName??"‚Äî"}</td></tr>`).join("")}
                </tbody>
              </table>
            `:""}
            <div class="btn-group mt-4">
              <button class="btn-secondary" id="open-graph-tab">Open in Graph tab</button>
              <button class="btn-secondary" id="refresh-graph-overview">Refresh</button>
            </div>
          `:'<button class="btn-secondary" id="load-graph-overview">Load overview</button>'}
        </div>
      </div>
    </div>
  `}function gA(){return zi||!cd?`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Ontology</h3>
        <p>Entity types and relation types used by extraction and GraphRAG</p>
      </div>
      <div class="admin-card">
        <p class="text-muted">${zi?"Loading ontology...":"Click Load to fetch entity and relation types from the API."}</p>
        ${zi?"":'<button class="btn-primary" id="load-ontology">Load ontology</button>'}
      </div>
    </div>
    `:`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Ontology</h3>
        <p>Entity types and relation types used by extraction and GraphRAG</p>
      </div>

      <div class="admin-card">
        <h4>Entity types</h4>
        <p class="text-muted">Types of entities that can be extracted and stored in the graph.</p>
        ${ar.length===0?'<p class="text-muted">No entity types returned.</p>':`
          <ul class="ontology-list">
            ${ar.map(e=>`
              <li><code>${e.name}</code>
                ${e.sharedEntity?' <span class="badge badge-info">shared</span>':""}
                ${e.properties?.length?` ¬∑ properties: ${e.properties.join(", ")}`:""}
              </li>
            `).join("")}
          </ul>
        `}
      </div>

      <div class="admin-card">
        <h4>Relation types</h4>
        <p class="text-muted">Allowed relationships between entity types.</p>
        ${ir.length===0?'<p class="text-muted">No relation types returned.</p>':`
          <ul class="ontology-list">
            ${ir.map(e=>`
              <li><code>${e.name}</code>
                ${e.sourceType?` (${e.sourceType} ‚Üí ${e.targetType})`:""}
              </li>
            `).join("")}
          </ul>
        `}
      </div>

      <div class="btn-group mt-4">
        <button class="btn-secondary" id="reload-ontology">Reload ontology</button>
      </div>
    </div>
  `}function vA(){const e=Ns.filter(i=>i.category==="extraction"),t=Ns.filter(i=>i.category==="analysis"),n=Ns.filter(i=>i.category==="template"),s=Ns.filter(i=>i.category==="sprint"),a=Ns.filter(i=>i.category==="report"),o=i=>`
    <div class="admin-card prompt-card" data-prompt-id="${i.id}">
      <div class="prompt-header">
        <div>
          <h4>${i.name}</h4>
          <p class="text-muted">${i.description}</p>
        </div>
        <div class="prompt-badges">
          ${i.uses_ontology?'<span class="badge badge-info">Ontology-Aware</span>':""}
          <span class="badge badge-secondary">${i.key}</span>
        </div>
      </div>
      <textarea class="form-textarea prompt-editor" data-prompt-key="${i.key}" rows="12" 
                placeholder="Enter prompt template...

Available placeholders:
{{CONTENT}} - The document/transcript content
{{FILENAME}} - The file/document name
{{TODAY}} - Current date
{{ONTOLOGY_SECTION}} - Ontology context (if uses_ontology=true)
{{ROLE_CONTEXT}} - User role context
{{PROJECT_CONTEXT}} - Project context">${i.prompt_template||""}</textarea>
      <div class="prompt-actions">
        <button class="btn-sm btn-secondary" data-view-versions="${i.key}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12,6 12,12 16,14"/>
          </svg>
          Version History
        </button>
        <span class="prompt-status" id="status-${i.key}"></span>
      </div>
      <div class="version-history hidden" id="versions-${i.key}">
        <div class="version-list"></div>
      </div>
    </div>
  `;return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>AI Prompts Configuration</h3>
        <p>Customize ontology-aware prompts for AI extraction. All prompts support template variables.</p>
      </div>

      <div class="prompt-info admin-card">
        <h4>Template Variables</h4>
        <div class="variables-grid">
          <code>{{CONTENT}}</code> <span>Document/transcript content</span>
          <code>{{FILENAME}}</code> <span>File or document name</span>
          <code>{{TODAY}}</code> <span>Current date (YYYY-MM-DD)</span>
          <code>{{ONTOLOGY_SECTION}}</code> <span>Injected ontology context</span>
          <code>{{ROLE_CONTEXT}}</code> <span>User role context line</span>
          <code>{{PROJECT_CONTEXT}}</code> <span>Project context line</span>
          <code>{{CONTENT_LENGTH}}</code> <span>Content length in characters</span>
        </div>
      </div>

      <h4 class="section-subtitle">Extraction Prompts</h4>
      ${e.length>0?e.map(o).join(""):'<p class="text-muted">Run migration 031 to create default prompts</p>'}

      ${t.length>0?`
        <h4 class="section-subtitle">Analysis Prompts</h4>
        ${t.map(o).join("")}
      `:""}

      ${n.length>0?`
        <h4 class="section-subtitle">Template Sections</h4>
        ${n.map(o).join("")}
      `:""}

      ${s.length>0?`
        <h4 class="section-subtitle">Sprint / Task prompts</h4>
        <p class="text-muted">Prompts for task description from rules, user stories, and dependencies. Used when adding tasks manually and in sprint flows.</p>
        ${s.map(o).join("")}
      `:""}

      ${a.length>0?`
        <h4 class="section-subtitle">Report prompts (Relat√≥rios)</h4>
        <p class="text-muted">Prompts for generating sprint reports as A4 document or PPT-style presentation. Placeholders: {{REPORT_DATA}}, {{STYLE_VARIANT}} (document only).</p>
        ${a.map(o).join("")}
      `:""}

      <div class="btn-group mt-4">
        <button class="btn-primary" id="save-prompts">Save All Prompts</button>
        <button class="btn-secondary" id="reload-prompts">Reload from Database</button>
      </div>
    </div>
  `}function fA(){const e={chunkSize:Wn("processing","chunk_size",1e3),chunkOverlap:Wn("processing","chunk_overlap",200),maxTokens:Wn("processing","max_tokens",4096),temperature:Wn("processing","temperature",.7),autoProcess:Wn("processing","auto_process",!0),parallelJobs:Wn("processing","parallel_jobs",3)};return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Document Processing Settings</h3>
        <p>Configure how documents are processed and analyzed</p>
      </div>

      <div class="admin-card">
        <h4>Chunking Settings</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Chunk Size (tokens)</label>
            <input type="number" id="proc-chunk-size" value="${e.chunkSize}" class="form-input" min="100" max="8000">
          </div>
          <div class="form-group">
            <label>Chunk Overlap (tokens)</label>
            <input type="number" id="proc-chunk-overlap" value="${e.chunkOverlap}" class="form-input" min="0" max="1000">
          </div>
        </div>
      </div>

      <div class="admin-card">
        <h4>Generation Settings</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Max Tokens</label>
            <input type="number" id="proc-max-tokens" value="${e.maxTokens}" class="form-input" min="256" max="32000">
          </div>
          <div class="form-group">
            <label>Temperature</label>
            <input type="number" id="proc-temperature" value="${e.temperature}" class="form-input" min="0" max="2" step="0.1">
          </div>
        </div>
      </div>

      <div class="admin-card">
        <h4>Job Settings</h4>
        
        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="proc-auto-process" ${e.autoProcess?"checked":""}>
            <span>Auto-process uploaded documents</span>
          </label>
        </div>
        
        <div class="form-group">
          <label>Parallel Jobs</label>
          <input type="number" id="proc-parallel-jobs" value="${e.parallelJobs}" class="form-input" min="1" max="10">
        </div>
      </div>

      <button class="btn-primary" id="save-processing">Save Processing Settings</button>
    </div>
  `}async function Jv(){if(!N.getState().currentProject?.id){Vs={enabled:!0,access:"admin_only"},Sa=!0;return}Ki=!0;try{const n=await v.get("/api/team-analysis/config");Vs={enabled:n?.data?.config?.enabled??!0,access:n?.data?.config?.access??"admin_only"},Sa=!0}catch(n){console.error("[AdminPanel] Error loading team analysis settings:",n),Vs={enabled:!0,access:"admin_only"},Sa=!0}finally{Ki=!1}}async function hA(e,t){if(!N.getState().currentProject?.id){m.error("No project selected");return}try{await v.put("/api/team-analysis/config",{enabled:e,access:t}),Vs={enabled:e,access:t},m.success("Team Analysis settings saved")}catch(a){console.error("[AdminPanel] Error saving team analysis settings:",a),m.error("Failed to save settings")}}async function Ao(){cr=!0;try{const e=await v.get("/api/system/google-drive");hl={enabled:e.data.enabled??!1,rootFolderId:e.data.rootFolderId??"",hasSystemCredentials:e.data.hasSystemCredentials??!1,bootstrappedAt:e.data.bootstrappedAt??null},Gs=!0}catch(e){console.error("[AdminPanel] Error loading Google Drive config:",e),hl={enabled:!1,rootFolderId:"",hasSystemCredentials:!1,bootstrappedAt:null},Gs=!0}finally{cr=!1}}function bA(){if(cr||!Gs)return!cr&&!Gs&&Ao(),`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Google Drive</h3>
        <p>Store uploads and transcripts in Google Drive</p>
      </div>
      <div class="admin-card">
        <div class="admin-empty-state"><div class="loading-spinner"></div><p>Loading...</p></div>
      </div>
    </div>`;const e=hl;return`
  <div class="admin-section">
    <div class="admin-section-header">
      <h3>Google Drive</h3>
      <p>Store uploads and transcripts in Google Drive. Configure system account and root folder, then bootstrap projects.</p>
    </div>
    <div class="admin-card">
      <h4>Integration</h4>
      <div class="form-group admin-form-group-box">
        <label class="admin-checkbox-label">
          <input type="checkbox" id="google-drive-enabled" ${e.enabled?"checked":""}>
          Enable Google Drive for uploads
        </label>
      </div>
      <div class="form-group admin-form-group-box">
        <label class="admin-field-label-block">Root Folder ID</label>
        <input type="text" id="google-drive-root-folder" class="form-input" placeholder="Google Drive folder ID" value="${(e.rootFolderId||"").replace(/"/g,"&quot;")}">
        <p class="text-muted admin-field-hint">Create a folder in Google Drive and paste its ID here. All project folders will be created under it.</p>
      </div>
      <div class="form-group admin-form-group-box">
        <label class="admin-field-label-block">System Service Account JSON</label>
        <textarea id="google-drive-service-json" class="form-input" rows="4" placeholder="${e.hasSystemCredentials?"Already configured. Paste new JSON to replace.":"Paste the full JSON key file content"}"></textarea>
        ${e.hasSystemCredentials?'<p class="text-muted">Credentials are stored. Paste new JSON only to replace.</p>':""}
      </div>
      <button type="button" class="btn-primary" id="save-google-drive">Save Google Drive config</button>
    </div>
    <div class="admin-card">
      <h4>Bootstrap projects</h4>
      <p class="text-muted admin-mb-4">Create folder structure (uploads, newtranscripts, archived, exports) for all projects under the root folder.</p>
      <button type="button" class="btn-secondary" id="bootstrap-google-drive">Bootstrap all projects</button>
      ${e.bootstrappedAt?`<p class="text-muted admin-mt-2">Last run: ${e.bootstrappedAt}</p>`:""}
    </div>
  </div>`}function yA(){const e=N.getState(),t=e.currentProject?.id,n=e.currentProject?.name||"Unknown";return t?Ki||!Sa?(!Ki&&!Sa&&Jv(),`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Team Analysis Settings</h3>
        <p>Configure access control for behavioral analysis features</p>
      </div>
      
      <div class="admin-card">
        <div class="admin-empty-state">
          <div class="loading-spinner"></div>
          <p>Loading settings...</p>
        </div>
      </div>
    </div>
    `):`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Team Analysis Settings</h3>
        <p>Configure access control for behavioral analysis features</p>
      </div>

      <!-- Current Project Info -->
      <div class="admin-card">
        <h4>Current Project</h4>
        <div class="admin-project-preview">
          <div class="admin-project-preview-icon">${n.charAt(0).toUpperCase()}</div>
          <div>
            <div class="admin-project-name">${n}</div>
            <div class="admin-project-id">ID: ${t}</div>
          </div>
        </div>
      </div>

      <!-- Feature Toggle -->
      <div class="admin-card">
        <h4>Feature Status</h4>
        <p class="text-muted admin-mb-4">Enable or disable Team Analysis for this project</p>
        
        <div class="form-group">
          <label class="toggle-label admin-toggle-label">
            <input type="checkbox" id="team-analysis-enabled" ${Vs.enabled?"checked":""} class="admin-checkbox">
            <div>
              <span class="admin-toggle-title">Enable Team Analysis</span>
              <p class="admin-toggle-desc">When enabled, users with access can analyze team member behavior from meeting transcripts</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Access Control -->
      <div class="admin-card">
        <h4>Access Control</h4>
        <p class="text-muted admin-mb-4">Define who can access Team Analysis features</p>
        
        <div class="form-group">
          <label class="admin-field-label-block">Access Level</label>
          <select id="team-analysis-access" class="form-input admin-select-max">
            <option value="admin_only" ${Vs.access==="admin_only"?"selected":""}>Admins Only - Only project owner and admins can access</option>
            <option value="all" ${Vs.access==="all"?"selected":""}>All Members - All project members can access</option>
          </select>
          <p class="admin-field-hint">
            <strong>Admins Only:</strong> Restricts access to sensitive behavioral analysis to project owner and administrators.<br>
            <strong>All Members:</strong> Allows all project collaborators to view and run team analysis.
          </p>
        </div>
      </div>

      <!-- Analysis Scope Info -->
      <div class="admin-card">
        <h4>How It Works</h4>
        <div class="admin-steps-grid">
          <div class="admin-step-row">
            <div class="admin-step-num">1</div>
            <div>
              <div class="admin-step-title">Contact-Based Analysis</div>
              <div class="admin-step-desc">Analysis is performed on contacts defined in the project. Contacts can have aliases to match different name variations in transcripts.</div>
            </div>
          </div>
          <div class="admin-step-row">
            <div class="admin-step-num">2</div>
            <div>
              <div class="admin-step-title">Incremental Learning</div>
              <div class="admin-step-desc">Profiles are refined iteratively as more transcripts are processed, building evidence over time.</div>
            </div>
          </div>
          <div class="admin-step-row">
            <div class="admin-step-num">3</div>
            <div>
              <div class="admin-step-title">Privacy Consideration</div>
              <div class="admin-step-desc">Behavioral analysis may contain sensitive insights. Configure access carefully.</div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-primary admin-mt-2" id="save-team-analysis">Save Team Analysis Settings</button>
    </div>
  `:`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Team Analysis Settings</h3>
        <p>Configure access control for behavioral analysis features</p>
      </div>
      
      <div class="admin-card">
        <div class="admin-empty-state">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="48" height="48">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p>Please select a project to configure Team Analysis settings.</p>
        </div>
      </div>
    </div>
    `}function wA(){return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>LLM Processing Queue</h3>
        <p>Monitor and control AI request processing - All requests are persisted in database</p>
      </div>

      <!-- Queue Status -->
      <div class="admin-card" id="queue-status-card">
        <div class="admin-card-header">
          <h4>Queue Status</h4>
          <div class="admin-card-actions">
            <span id="db-status-badge" class="badge admin-badge-sm">DB: Checking...</span>
            <button class="btn-sm" id="refresh-queue-status">‚Üª Refresh</button>
          </div>
        </div>
        
        <div id="queue-status-content" class="admin-placeholder">
          Loading queue status...
        </div>
      </div>

      <!-- Queue Controls -->
      <div class="admin-card">
        <h4>Queue Controls</h4>
        <p class="text-muted">Control queue processing behavior</p>
        
        <div class="admin-actions-row">
          <button class="btn-primary" id="queue-pause-btn">‚è∏ Pause Queue</button>
          <button class="btn-primary" id="queue-resume-btn">‚ñ∂ Resume Queue</button>
          <button class="btn-secondary admin-btn-warning" id="queue-clear-btn">üóë Clear Queue</button>
        </div>
      </div>

      <!-- Statistics -->
      <div class="admin-card">
        <h4>Queue Statistics (Today)</h4>
        <div id="queue-stats-content" class="admin-stats-grid">
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value admin-stat-primary" id="stat-pending">-</div>
            <div class="admin-stat-label">Pending</div>
          </div>
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value admin-stat-info" id="stat-processing">-</div>
            <div class="admin-stat-label">Processing</div>
          </div>
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value admin-stat-success" id="stat-success">-</div>
            <div class="admin-stat-label">Completed</div>
          </div>
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value admin-stat-error" id="stat-failed">-</div>
            <div class="admin-stat-label">Failed</div>
          </div>
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value admin-stat-warning" id="stat-retry">-</div>
            <div class="admin-stat-label">Retry Pending</div>
          </div>
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value" id="stat-avg-time">-</div>
            <div class="admin-stat-label">Avg Time (ms)</div>
          </div>
          <div class="stat-box admin-stat-box">
            <div class="admin-stat-value admin-stat-success" id="stat-cost">$-</div>
            <div class="admin-stat-label">Cost Today</div>
          </div>
        </div>
      </div>

      <!-- Queue Items -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h4>Pending Items</h4>
          <span id="pending-count" class="text-muted">0 items</span>
        </div>
        
        <div id="queue-items-content" class="admin-scroll-content admin-scroll-300">
          <div class="admin-placeholder">
            No items in queue
          </div>
        </div>
      </div>

      <!-- Failed Items (Retryable) -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h4>Failed Items</h4>
          <div class="admin-card-actions">
            <button class="btn-sm btn-primary" id="retry-all-btn">‚Üª Retry All</button>
            <button class="btn-sm" id="refresh-failed-btn">‚Üª Refresh</button>
          </div>
        </div>
        
        <div id="failed-items-content" class="admin-scroll-content admin-scroll-300">
          <div class="admin-placeholder">
            No failed items
          </div>
        </div>
      </div>

      <!-- Recent History -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h4>Recent Processing History</h4>
          <button class="btn-sm" id="refresh-queue-history">‚Üª Refresh</button>
        </div>
        
        <div id="queue-history-content" class="admin-scroll-content admin-scroll-400">
          <div class="admin-placeholder">
            Loading history...
          </div>
        </div>
      </div>
    </div>
  `}async function Hs(){console.log("[AdminPanel] loadBillingData() starting...");try{console.log("[AdminPanel] Calling billing API...");const[e,t,n,s]=await Promise.all([gn.getAllProjectsBilling(),gn.getGlobalPricingConfig(),gn.getGlobalPricingTiers(),gn.getExchangeRateConfig()]);console.log("[AdminPanel] API responses:",{projects:e,config:t,tiersData:n,exchangeRate:s}),aa=e,ua=t,vn=n.tiers,Vn=s,Gn=!0,console.log("[AdminPanel] Loaded billing data:",{projects:e.length,config:!!t,tiers:n.tiers.length,exchangeRate:s?.currentRate})}catch(e){console.error("[AdminPanel] Error loading billing data:",e),m.error("Failed to load billing data")}finally{rr=!1}}function kA(){return rr&&!Gn?`
      <div class="admin-section">
        <div class="admin-section-header">
          <h3>Billing & Cost Control</h3>
          <p>Manage project balances, pricing, and cost limits</p>
        </div>
        <div class="admin-card admin-loading-card">
          <div class="spinner"></div>
          <p class="admin-loading-p">Loading billing data...</p>
        </div>
      </div>
    `:(vn.length>0&&vn.map((e,t)=>{const n=t>0?vn[t-1].token_limit:0,s=Fs(n||0),a=e.token_limit?Fs(e.token_limit):"‚àû";return`${e.name||`Tier ${t+1}`}: ${s}-${a} tokens ‚Üí +${e.markup_percent}%`}).join("<br>"),`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Billing & Cost Control</h3>
        <p>Manage project balances, pricing, and cost limits</p>
      </div>

      <!-- Exchange Rate Configuration -->
      <div class="admin-card">
        <h4 class="admin-h4-mb">Exchange Rate (USD to EUR)</h4>
        
        <div class="admin-exchange-grid">
          <div>
            <div class="form-group">
              <label class="admin-checkbox-label">
                <input type="checkbox" id="exchange-rate-auto" ${Vn?.auto!==!1?"checked":""}>
                <span>Automatic rate from API</span>
              </label>
              <small class="text-muted">Fetches live USD/EUR rate daily</small>
            </div>
            
            <div class="form-group ${Vn?.auto!==!1?"hidden":""}" id="manual-rate-group">
              <label>Manual Rate</label>
              <input type="number" id="exchange-rate-manual" class="form-input" 
                     value="${Vn?.manualRate??.92}" min="0.01" max="2" step="0.001">
            </div>
          </div>
          
          <div class="admin-rate-block">
            <div class="admin-rate-label">Current Rate</div>
            <div class="admin-rate-value" id="current-rate-display">
              ${Vn?.currentRate?.toFixed(4)??"0.9200"}
            </div>
            <div class="admin-rate-meta">
              Source: <span id="rate-source">${Vn?.source??"default"}</span>
              ${Vn?.lastUpdated?`<br>Updated: ${new Date(Vn.lastUpdated).toLocaleString()}`:""}
            </div>
            <button class="btn-sm btn-secondary admin-rate-refresh" id="refresh-rate-btn" ${Vn?.auto===!1?"disabled":""}>
              Refresh Rate
            </button>
          </div>
        </div>
        
        <div class="admin-actions-end">
          <button class="btn-primary" id="save-exchange-rate-btn">Save Exchange Rate Settings</button>
        </div>
      </div>

      <!-- Global Pricing Configuration -->
      <div class="admin-card">
        <h4 class="admin-h4-mb">Global Pricing Configuration</h4>
        
        <div class="admin-form-grid admin-form-grid-2">
          <div class="form-group">
            <label>Fixed Markup (%)</label>
            <input type="number" id="global-markup-percent" class="form-input" 
                   value="${ua?.fixed_markup_percent??0}" min="0" max="500" step="0.1">
            <small class="text-muted">Applied when no tier matches</small>
          </div>
          
          <div class="form-group">
            <label>Period Type</label>
            <select id="global-period-type" class="form-input">
              <option value="monthly" ${ua?.period_type==="monthly"?"selected":""}>Monthly</option>
              <option value="weekly" ${ua?.period_type==="weekly"?"selected":""}>Weekly</option>
            </select>
            <small class="text-muted">Tier reset period</small>
          </div>
        </div>
        
        <div class="admin-actions-end">
          <button class="btn-primary" id="save-global-pricing-btn">Save Global Pricing</button>
        </div>
      </div>
      
      <!-- Pricing Tiers -->
      <div class="admin-card">
        <div class="admin-card-header">
          <div>
            <h4>Pricing Tiers (Volume Discount)</h4>
            <p class="text-muted admin-subtitle">
              Lower markup as projects consume more tokens per period
            </p>
          </div>
          <button class="btn-sm btn-primary" id="add-tier-btn">+ Add Tier</button>
        </div>
        
        <div id="pricing-tiers-list">
          ${vn.length>0?vn.map((e,t)=>`
            <div class="tier-row admin-tier-row" data-tier-index="${t}">
              <input type="text" class="form-input tier-name" placeholder="Tier Name" value="${e.name||`Tier ${t+1}`}">
              <input type="number" class="form-input tier-limit" placeholder="Token Limit" value="${e.token_limit||""}" min="0" ${e.token_limit===null?"disabled":""}>
              <div class="admin-tier-markup-wrap">
                <input type="number" class="form-input tier-markup" placeholder="Markup %" value="${e.markup_percent}" min="0" step="0.1">
                <span>%</span>
              </div>
              <div class="admin-tier-actions">
                <label class="admin-tier-unlimited-label">
                  <input type="checkbox" class="tier-unlimited" ${e.token_limit===null?"checked":""}>
                  Unlimited
                </label>
                <button class="btn-sm btn-danger remove-tier-btn" data-index="${t}">‚úï</button>
              </div>
            </div>
          `).join(""):`
            <div class="admin-placeholder">
              No tiers configured. Using fixed markup of ${ua?.fixed_markup_percent??0}% for all usage.
            </div>
          `}
        </div>
        
        ${vn.length>0?`
          <div class="admin-actions-end admin-mt-4">
            <button class="btn-primary" id="save-tiers-btn">Save Tiers</button>
          </div>
        `:""}
      </div>

      <!-- Projects Billing Overview -->
      <div class="admin-card">
        <div class="admin-card-header">
          <div>
            <h4>Projects Billing</h4>
            <p class="text-muted admin-subtitle">
              ${aa.length} projects | 
              ${aa.filter(e=>e.is_blocked).length} blocked | 
              ${aa.filter(e=>e.unlimited_balance).length} unlimited
            </p>
          </div>
          <button class="btn-sm" id="refresh-billing-btn">‚Üª Refresh</button>
        </div>
        
        <div class="admin-table-wrap">
          <table class="data-table admin-data-table">
            <thead>
              <tr>
                <th class="admin-th-left">Project</th>
                <th class="admin-th-right">Balance</th>
                <th class="admin-th-center">Status</th>
                <th class="admin-th-right">Tokens (Period)</th>
                <th class="admin-th-right">Cost (Period)</th>
                <th class="admin-th-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${aa.length>0?aa.map(e=>`
                <tr class="admin-tr">
                  <td class="admin-td admin-td-project">
                    <div class="admin-td-project-name">${yp(e.project_name)}</div>
                    ${e.current_tier_name?`<small class="text-muted">Tier: ${e.current_tier_name}</small>`:""}
                  </td>
                  <td class="admin-td admin-td-right">
                    ${e.unlimited_balance?'<span class="admin-unlimited">‚àû Unlimited</span>':Vi(e.balance_eur)}
                  </td>
                  <td class="admin-td admin-td-center">
                    ${e.is_blocked?'<span class="badge badge-danger">Blocked</span>':e.unlimited_balance?'<span class="badge badge-success">Unlimited</span>':'<span class="badge badge-primary">Active</span>'}
                  </td>
                  <td class="admin-td admin-td-right">${Fs(e.tokens_this_period)}</td>
                  <td class="admin-td admin-td-right">${Vi(e.billable_cost_this_period)}</td>
                  <td class="admin-td admin-td-center">
                    <div class="admin-td-actions">
                      <button class="btn-sm add-balance-btn" data-project-id="${e.project_id}" data-project-name="${yp(e.project_name)}" title="Add Balance">üí∞</button>
                      <button class="btn-sm toggle-unlimited-btn" data-project-id="${e.project_id}" data-unlimited="${e.unlimited_balance}" title="${e.unlimited_balance?"Disable Unlimited":"Enable Unlimited"}">
                        ${e.unlimited_balance?"üîì":"üîí"}
                      </button>
                    </div>
                  </td>
                </tr>
              `).join(""):`
                <tr>
                  <td colspan="6" class="admin-placeholder">
                    No projects found
                  </td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `)}function yp(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function xA(){return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Configuration Audit Log</h3>
        <p>Track all configuration changes</p>
      </div>

      <div class="admin-card">
        <div class="audit-filters">
          <select id="audit-filter-table" class="form-select">
            <option value="">All Tables</option>
            <option value="system_config">System Config</option>
            <option value="project_config">Project Config</option>
            <option value="secrets">Secrets</option>
          </select>
          <button class="btn-secondary" id="refresh-audit">Refresh</button>
        </div>

        <div class="audit-log-list">
          ${or.length===0?`
            <div class="empty-state">
              <p>No audit logs found</p>
            </div>
          `:or.map(e=>`
            <div class="audit-log-item">
              <div class="audit-log-header">
                <span class="audit-operation ${e.operation.toLowerCase()}">${e.operation}</span>
                <span class="audit-table">${e.table_name}</span>
                <span class="audit-time">${new Date(e.changed_at).toLocaleString()}</span>
              </div>
              <div class="audit-log-details">
                <span class="audit-user">${e.changed_by_email||"System"}</span>
                ${e.new_values?`<pre class="audit-values">${JSON.stringify(e.new_values,null,2)}</pre>`:""}
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `}function $A(){return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>LLM Model Metadata</h3>
        <p>Manage model information, pricing, and capabilities from database</p>
      </div>
      
      <!-- Sync Controls -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h4>Sync Model Metadata</h4>
          <button class="btn btn-primary" id="sync-all-metadata-btn">
            ‚Üª Sync All Providers
          </button>
        </div>
        <p class="admin-desc admin-mb-4">
          Fetch the latest model list from each configured provider API and update the database with current models and capabilities.
          Pricing information is updated from known sources.
        </p>
        
        <div id="metadata-sync-status" class="admin-mb-4">
          <div class="admin-placeholder">
            Loading sync status...
          </div>
        </div>
        
        <div id="metadata-sync-result" class="hidden"></div>
      </div>
      
      <!-- Provider Status -->
      <div class="admin-card">
        <h4 class="admin-h4-mb">Provider Model Count</h4>
        <div id="provider-model-counts">
          <div class="admin-placeholder">
            Loading...
          </div>
        </div>
      </div>
      
      <!-- Model Browser -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h4>Browse Models</h4>
          <div class="admin-card-actions">
            <select id="browse-provider-select" class="form-select admin-select-min">
              <option value="">Select Provider</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="google">Google</option>
              <option value="grok">Grok (xAI)</option>
              <option value="deepseek">DeepSeek</option>
            </select>
            <button class="btn btn-secondary" id="browse-models-btn">Load Models</button>
          </div>
        </div>
        
        <div id="models-browser-content">
          <div class="admin-empty-state">
            Select a provider to browse available models
          </div>
        </div>
      </div>
    </div>
  `}function SA(){switch(Ii){case"llm":return bp();case"models":return $A();case"graph":return mA();case"ontology":return gA();case"queue":return wA();case"prompts":return vA();case"processing":return fA();case"team-analysis":return yA();case"google-drive":return bA();case"billing":return kA();case"audit":return xA();default:return bp()}}function CA(e){e.querySelectorAll(".admin-nav-btn").forEach(T=>{d(T,"click",async()=>{const _=T.getAttribute("data-section")||"llm";Ii=_,_==="team-analysis"?(Sa=!1,Ki=!1,Be(e),await Jv(),Be(e)):_==="google-drive"?(Gs=!1,Be(e),await Ao(),Be(e)):(_==="billing"&&!Gn&&!rr&&(rr=!0,Be(e),await Hs()),Be(e))})}),e.querySelectorAll("[data-toggle-visibility]").forEach(T=>{d(T,"click",()=>{const _=T.getAttribute("data-toggle-visibility");if(_){const A=e.querySelector(`#${_}`);A&&(A.type=A.type==="password"?"text":"password",T.textContent=A.type==="password"?"Show":"Hide")}})}),e.querySelectorAll("[data-test-provider]").forEach(T=>{d(T,"click",async()=>{const _=T.getAttribute("data-test-provider");_&&(T.textContent="Testing...",await uA(_),T.textContent="Test")})});const t={};async function n(T,_){const A=e.querySelector(`select.model-select[data-task="${_}"]`),E=e.querySelector(`.model-loading[data-task="${_}"]`),U=e.querySelector(`.model-status[data-task="${_}"]`);if(!A||!T){A&&(A.innerHTML='<option value="">-- Select Provider First --</option>');return}E&&E.classList.remove("hidden"),A.disabled=!0;try{if(!t[T]){const q=await v.get(`/api/llm/models?provider=${T}`);t[T]={textModels:(q.data.textModels||[]).map(I=>I.id||I.name||"").filter(Boolean),visionModels:(q.data.visionModels||[]).map(I=>I.id||I.name||"").filter(Boolean),embeddingModels:(q.data.embeddingModels||[]).map(I=>I.id||I.name||"").filter(Boolean)}}let M=[];_==="text"?M=t[T].textModels:_==="vision"?M=t[T].visionModels:_==="embeddings"&&(M=t[T].embeddingModels);const z=A.value;A.innerHTML='<option value="">-- Select Model --</option>'+M.map(q=>`<option value="${q}"${q===z?" selected":""}>${q}</option>`).join(""),U&&(U.textContent=M.length>0?`${M.length} model(s) available`:"No models found for this task type. Check provider configuration.",U.classList.remove("admin-status-success","admin-status-warning","admin-status-error"),U.classList.add(M.length>0?"admin-status-success":"admin-status-warning"))}catch(M){console.error(`Failed to load models for ${T}:`,M),A.innerHTML='<option value="">Error loading models</option>',U&&(U.textContent="Failed to load models. Check API key configuration.",U.classList.remove("admin-status-success","admin-status-warning"),U.classList.add("admin-status-error"))}finally{E&&E.classList.add("hidden"),A.disabled=!1}}e.querySelectorAll("select.provider-select").forEach(T=>{d(T,"change",async()=>{const E=T.getAttribute("data-task"),U=T.value;E&&await n(U,E)});const _=T.getAttribute("data-task"),A=T.value;_&&A&&n(A,_)});const s=e.querySelector("#save-llm-config");s&&d(s,"click",async()=>{const T={};e.querySelectorAll("select[data-task]").forEach(_=>{const A=_.getAttribute("data-task"),E=_.getAttribute("data-field");T[A]||(T[A]={provider:"",model:""}),T[A][E]=_.value});try{for(const[_,A]of Object.entries(T))A.provider&&await ds(`${_}_provider`,A,"llm");m.success("LLM configuration saved to Supabase")}catch{m.error("Failed to save LLM configuration")}});async function a(){const T=e.querySelector("#api-keys-loading");try{const _=await v.get("/api/secrets");if(_.data?.success&&_.data.secrets)for(const A of _.data.secrets){const E=e.querySelector(`[data-secret-name="${A.name}"]`);if(E){const U=E.querySelector(".key-status"),M=E.querySelector("input");U&&A.masked_value&&(U.textContent="‚úì Configured",U.classList.add("admin-status-success"),M&&(M.placeholder=A.masked_value))}}}catch(_){console.warn("Failed to load API keys status:",_)}finally{T&&T.classList.add("hidden")}}a();const o=e.querySelector("#save-api-keys");o&&d(o,"click",async()=>{const T=[{id:"openai-key",name:"OPENAI_API_KEY"},{id:"anthropic-key",name:"CLAUDE_API_KEY"},{id:"google-key",name:"GOOGLE_API_KEY"},{id:"xai-key",name:"XAI_API_KEY"},{id:"deepseek-key",name:"DEEPSEEK_API_KEY"},{id:"kimi-key",name:"KIMI_API_KEY"},{id:"minimax-key",name:"MINIMAX_API_KEY"}];try{let _=0;for(const A of T){const E=e.querySelector(`#${A.id}`)?.value;E&&E.trim()&&(await v.post("/api/secrets",{name:A.name,value:E.trim(),scope:"system"}),_++)}_>0?m.success(`${_} API key(s) saved securely`):m.info("No API keys to save")}catch{m.error("Failed to save API keys")}});const i=e.querySelector("#save-service-keys");i&&d(i,"click",async()=>{const T=e.querySelector("#resend-key")?.value,_=e.querySelector("#brave-key")?.value;try{let A=0;T&&T.trim()&&(await v.post("/api/secrets",{name:"RESEND_API_KEY",value:T.trim(),scope:"system"}),A++),_&&_.trim()&&(await v.post("/api/secrets",{name:"BRAVE_API_KEY",value:_.trim(),scope:"system"}),A++),A>0?m.success("Service API key(s) saved securely"):m.info("No service keys to save")}catch(A){const E=A?.message;m.error(E&&typeof E=="string"?E:"Failed to save service keys")}});async function r(){const T=e.querySelector("#queue-status-content"),_=e.querySelector("#queue-items-content"),A=e.querySelector("#pending-count"),E=e.querySelector("#db-status-badge");try{const M=(await v.get("/api/llm/queue/status")).data;if(E&&(M.database?(E.className="badge badge-success",E.textContent="DB: Connected"):(E.className="badge badge-warning",E.textContent="DB: Memory Only")),T){const Te=M.isPaused?"var(--warning)":M.isProcessing?"var(--success)":"var(--text-tertiary)",Oe=M.isPaused?"‚è∏ PAUSED":M.isProcessing?"üîÑ PROCESSING":"‚úì IDLE";T.innerHTML=`
          <div class="admin-queue-status-grid">
            <div class="admin-queue-stat">
              <div class="admin-queue-stat-value" style="--queue-stat-color: ${Te}">${Oe}</div>
              <div class="admin-queue-stat-label">Queue Status</div>
            </div>
            <div class="admin-queue-stat">
              <div class="admin-queue-stat-value">${M.queueLength}</div>
              <div class="admin-queue-stat-label">Items in Queue</div>
            </div>
            <div class="admin-queue-stat">
              <div class="admin-queue-stat-value admin-queue-stat-primary">${M.isProcessing?"1":"0"}</div>
              <div class="admin-queue-stat-label">Processing Now</div>
            </div>
          </div>
          ${M.currentRequest?`
            <div class="admin-queue-current-box">
              <strong>Currently Processing:</strong> ${M.currentRequest.context||"Unknown"} 
              <span class="admin-queue-current-meta">(Priority: ${M.currentRequest.priority})</span>
              <span class="admin-queue-current-meta admin-queue-current-time">Started: ${new Date(M.currentRequest.startedAt).toLocaleTimeString()}</span>
            </div>
          `:""}
        `}if(_&&A){const Te=M.pendingItems?.length||0;A.textContent=`${Te} items`,Te>0?_.innerHTML=`
            <table class="admin-queue-table admin-queue-table-sm">
              <thead>
                <tr>
                  <th class="admin-queue-th">Context</th>
                  <th class="admin-queue-th">Priority</th>
                  <th class="admin-queue-th">Queued</th>
                  <th class="admin-queue-th">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${M.pendingItems.map(Oe=>`
                  <tr>
                    <td class="admin-queue-td">${Oe.context||"Unknown"}</td>
                    <td class="admin-queue-td"><span class="badge badge-${Oe.priority}">${Oe.priority}</span></td>
                    <td class="admin-queue-td">${new Date(Oe.queuedAt).toLocaleTimeString()}</td>
                    <td class="admin-queue-td"><button class="btn-sm btn-danger" data-cancel-item="${Oe.id}">Cancel</button></td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:_.innerHTML='<div class="admin-placeholder">No items in queue</div>'}const z=M.database,q=e.querySelector("#stat-pending"),I=e.querySelector("#stat-processing"),X=e.querySelector("#stat-success"),se=e.querySelector("#stat-failed"),Se=e.querySelector("#stat-retry"),fe=e.querySelector("#stat-avg-time"),we=e.querySelector("#stat-cost");q&&(q.textContent=String(z?.pendingCount||M.queueLength||0)),I&&(I.textContent=String(z?.processingCount||(M.isProcessing?1:0))),X&&(X.textContent=String(z?.completedToday||M.stats?.successful||0)),se&&(se.textContent=String(z?.failedToday||M.stats?.failed||0)),Se&&(Se.textContent=String(z?.retryPendingCount||0)),fe&&(fe.textContent=String(Math.round(z?.avgProcessingTimeMs||M.stats?.avgProcessingTime||0))),we&&(we.textContent=`$${(z?.totalCostTodayUsd||0).toFixed(4)}`)}catch(U){console.error("Failed to load queue status:",U),T&&(T.innerHTML='<div class="admin-error-msg">Failed to load queue status</div>')}}async function c(){const T=e.querySelector("#queue-history-content");try{const A=(await v.get("/api/llm/queue/history?limit=50")).data?.history||[];T&&(A.length>0?T.innerHTML=`
            <table class="admin-queue-table">
              <thead>
                <tr>
                  <th class="admin-queue-th">Context</th>
                  <th class="admin-queue-th">Provider/Model</th>
                  <th class="admin-queue-th">Status</th>
                  <th class="admin-queue-th">Tokens</th>
                  <th class="admin-queue-th">Time</th>
                  <th class="admin-queue-th">Completed</th>
                  <th class="admin-queue-th">Details</th>
                </tr>
              </thead>
              <tbody>
                ${A.map(E=>`
                  <tr>
                    <td class="admin-queue-td admin-queue-td-ellipsis" title="${E.context||""}">${E.context||"Unknown"}</td>
                    <td class="admin-queue-td admin-queue-td-sm">${E.provider||"-"}/${E.model||"-"}</td>
                    <td class="admin-queue-td">
                      <span class="admin-queue-status-dot admin-queue-status-${E.status==="completed"?"ok":"err"}">${E.status==="completed"?"‚úì":"‚úó"}</span>
                      ${E.error?`<span class="admin-queue-error-hint" title="${E.error}">Error</span>`:""}
                    </td>
                    <td class="admin-queue-td admin-queue-td-sm">${E.inputTokens||"-"}/${E.outputTokens||"-"}</td>
                    <td class="admin-queue-td">${E.processingTime||"-"}ms</td>
                    <td class="admin-queue-td admin-queue-td-sm">${E.completedAt?new Date(E.completedAt).toLocaleString():"-"}</td>
                    <td class="admin-queue-td"><button class="btn-sm" data-view-request="${E.id}">View</button></td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:T.innerHTML='<div class="admin-placeholder">No processing history yet</div>')}catch(_){console.error("Failed to load queue history:",_),T&&(T.innerHTML='<div class="admin-error-msg">Failed to load history</div>')}}async function l(T){try{const _=await v.get(`/api/llm/queue/${T}`);if(!_.data.success||!_.data.request){m.error("Request not found");return}const A=_.data.request,E=Te=>Te?Te.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):"",U=Te=>{const Oe=JSON.stringify(Te,null,2);return E(Oe).replace(/"([^"]+)":/g,'<span class="hl-json-key">"$1"</span>:').replace(/: "([^"]*)"/g,': <span class="hl-json-string">"$1"</span>').replace(/: (\d+)/g,': <span class="hl-json-num">$1</span>').replace(/: (true|false|null)/g,': <span class="hl-json-bool">$1</span>')},M=Te=>Te?E(Te).replace(/\\n/g,`
`).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/^(#{1,3})\s*(.+)$/gm,'<span class="hl-prompt-heading">$2</span>').replace(/^[-‚Ä¢]\s*(.+)$/gm,"  ‚Ä¢ $1").replace(/---+/g,'<hr class="hl-prompt-hr">'):'<span class="hl-prompt-empty">(No content)</span>',q=(Te=>({completed:{color:"var(--success)",icon:"‚úì",bg:"rgba(34, 197, 94, 0.1)"},failed:{color:"var(--error)",icon:"‚úó",bg:"rgba(239, 68, 68, 0.1)"},processing:{color:"var(--warning)",icon:"‚ü≥",bg:"rgba(234, 179, 8, 0.1)"},pending:{color:"var(--text-secondary)",icon:"‚óã",bg:"var(--bg-tertiary)"},retry_pending:{color:"var(--warning)",icon:"‚Üª",bg:"rgba(234, 179, 8, 0.1)"},cancelled:{color:"var(--text-tertiary)",icon:"‚äò",bg:"var(--bg-tertiary)"}})[Te]||{color:"var(--text-primary)",icon:"?",bg:"var(--bg-secondary)"})(A.status),I=A.input_data||{},X=I.messages,se=I.prompt||X?.[0]?.content||"",Se=document.getElementById("llm-request-details-modal");Se&&Se.remove();const fe=document.createElement("div");fe.id="llm-request-details-modal",fe.className="modal open",fe.className="modal open admin-llm-modal-overlay",fe.innerHTML=`
        <div class="modal-content admin-llm-modal-content">
          <div class="modal-header">
            <div class="admin-llm-modal-header-inner">
              <span class="admin-llm-modal-icon" style="--status-bg: ${q.bg}; --status-color: ${q.color}">${q.icon}</span>
              <div>
                <h3 class="admin-llm-modal-title">LLM Request Details</h3>
                <span class="admin-llm-modal-id">ID: ${A.id}</span>
              </div>
            </div>
            <button class="modal-close">&times;</button>
          </div>
          
          <div class="modal-body admin-llm-modal-body">
            <div class="admin-llm-status-bar">
              <div class="admin-llm-status-item">
                <div class="admin-llm-status-label">Context</div>
                <div class="admin-llm-status-value admin-llm-status-accent">${A.context||"Unknown"}</div>
              </div>
              <div class="admin-llm-status-item">
                <div class="admin-llm-status-label">Provider</div>
                <div class="admin-llm-status-value">${A.provider||"-"}</div>
              </div>
              <div class="admin-llm-status-item">
                <div class="admin-llm-status-label">Model</div>
                <div class="admin-llm-status-value admin-llm-status-mono">${A.model||"-"}</div>
              </div>
              <div class="admin-llm-status-item">
                <div class="admin-llm-status-label">Status</div>
                <div class="admin-llm-status-badge" style="--status-bg: ${q.bg}; --status-color: ${q.color}">${q.icon} ${A.status}</div>
              </div>
            </div>
            
            <div class="admin-llm-metrics-grid">
              <div class="admin-llm-metric-box">
                <div class="admin-llm-metric-value">${A.input_tokens?.toLocaleString()||"-"}</div>
                <div class="admin-llm-metric-label">Input Tokens</div>
              </div>
              <div class="admin-llm-metric-box">
                <div class="admin-llm-metric-value">${A.output_tokens?.toLocaleString()||"-"}</div>
                <div class="admin-llm-metric-label">Output Tokens</div>
              </div>
              <div class="admin-llm-metric-box">
                <div class="admin-llm-metric-value">${A.processing_time_ms?`${(A.processing_time_ms/1e3).toFixed(1)}s`:"-"}</div>
                <div class="admin-llm-metric-label">Duration</div>
              </div>
              <div class="admin-llm-metric-box">
                <div class="admin-llm-metric-value admin-llm-metric-cost${A.estimated_cost_usd?" admin-llm-metric-has-cost":""}">$${A.estimated_cost_usd?.toFixed(4)||"-"}</div>
                <div class="admin-llm-metric-label">Est. Cost</div>
              </div>
            </div>
            
            <div class="admin-llm-timeline">
              <div><strong class="admin-llm-timeline-label">Queued:</strong> ${A.queued_at?new Date(A.queued_at).toLocaleString():"-"}</div>
              <div><strong class="admin-llm-timeline-label">Started:</strong> ${A.started_at?new Date(A.started_at).toLocaleString():"-"}</div>
              <div><strong class="admin-llm-timeline-label">Completed:</strong> ${A.completed_at?new Date(A.completed_at).toLocaleString():"-"}</div>
            </div>
            
            ${A.last_error?`
              <div class="admin-llm-error-box">
                <div class="admin-llm-error-header">
                  <span class="admin-llm-error-icon">‚ö†</span>
                  <strong>Error</strong>
                  <span class="admin-llm-error-attempt">(Attempt ${A.attempt_count}/${A.max_attempts})</span>
                </div>
                <div class="admin-llm-error-body">${E(A.last_error)}</div>
              </div>
            `:""}
            
            <!-- Prompt / Input -->
            <div class="admin-llm-section">
              <div class="admin-llm-section-header">
                <h4 class="admin-llm-section-title"><span class="admin-llm-section-emoji">üìù</span> Prompt / Input</h4>
                <button class="btn btn-sm btn-secondary" id="copy-input-btn">Copy</button>
              </div>
              <div class="admin-llm-code-block" id="input-display">${M(se)}</div>
            </div>
            
            <!-- Output -->
            <div class="admin-llm-section">
              <div class="admin-llm-section-header">
                <h4 class="admin-llm-section-title"><span class="admin-llm-section-emoji">ü§ñ</span> Response</h4>
                <button class="btn btn-sm btn-secondary" id="copy-output-btn">Copy</button>
              </div>
              <div class="admin-llm-code-block admin-llm-code-block-tall" id="output-display">${M(A.output_text)}</div>
            </div>
            
            <!-- Raw Data Toggle -->
            <details class="admin-llm-details">
              <summary class="admin-llm-details-summary">
                <span class="admin-llm-details-summary-inner">üìã Raw Data (JSON)</span>
              </summary>
              <div class="admin-llm-details-content">
                <div class="admin-llm-json-block">
                  <div class="admin-llm-json-header">
                    <span class="admin-llm-json-label">Input Data</span>
                    <button class="btn btn-xs btn-secondary" id="copy-input-json-btn">Copy JSON</button>
                  </div>
                  <pre class="admin-llm-pre">${U(A.input_data)}</pre>
                </div>
                ${A.output_data?`
                  <div class="admin-llm-json-block">
                    <div class="admin-llm-json-header">
                      <span class="admin-llm-json-label">Output Data</span>
                      <button class="btn btn-xs btn-secondary" id="copy-output-json-btn">Copy JSON</button>
                    </div>
                    <pre class="admin-llm-pre">${U(A.output_data)}</pre>
                  </div>
                `:""}
              </div>
            </details>
          </div>
          
          <div class="modal-footer">
            <button class="btn btn-secondary modal-close-btn">Close</button>
          </div>
        </div>
      `,document.body.appendChild(fe),fe.querySelector(".modal-close")?.addEventListener("click",()=>fe.remove()),fe.querySelector(".modal-close-btn")?.addEventListener("click",()=>fe.remove()),fe.addEventListener("click",Te=>{Te.target===fe&&fe.remove()});const we=Te=>{Te.key==="Escape"&&(fe.remove(),document.removeEventListener("keydown",we))};document.addEventListener("keydown",we),fe.querySelector("#copy-input-btn")?.addEventListener("click",()=>{const Te=se||JSON.stringify(A.input_data,null,2);navigator.clipboard.writeText(Te),m.success("Input copied to clipboard")}),fe.querySelector("#copy-output-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(A.output_text||""),m.success("Response copied to clipboard")}),fe.querySelector("#copy-input-json-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(JSON.stringify(A.input_data,null,2)),m.success("Input JSON copied to clipboard")}),fe.querySelector("#copy-output-json-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(JSON.stringify(A.output_data,null,2)),m.success("Output JSON copied to clipboard")})}catch(_){console.error("Failed to load request details:",_),m.error("Failed to load request details")}}async function u(){const T=e.querySelector("#failed-items-content");try{const A=(await v.get("/api/llm/queue/retryable?limit=20")).data?.items||[];T&&(A.length>0?T.innerHTML=`
            <table class="admin-queue-table">
              <thead>
                <tr>
                  <th class="admin-queue-th">Context</th>
                  <th class="admin-queue-th">Provider</th>
                  <th class="admin-queue-th">Attempts</th>
                  <th class="admin-queue-th">Error</th>
                  <th class="admin-queue-th">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${A.map(E=>`
                  <tr>
                    <td class="admin-queue-td">${E.context||"Unknown"}</td>
                    <td class="admin-queue-td admin-queue-td-sm">${E.provider||"-"}</td>
                    <td class="admin-queue-td">${E.attemptCount}/${E.maxAttempts}</td>
                    <td class="admin-queue-td admin-queue-td-ellipsis admin-queue-td-error" title="${E.error||""}">${E.error||"-"}</td>
                    <td class="admin-queue-td">
                      <button class="btn-sm btn-primary" data-retry-item="${E.id}" ${E.canRetry?"":"disabled"}>‚Üª Retry</button>
                      <button class="btn-sm admin-ml-1" data-retry-reset-item="${E.id}">Reset & Retry</button>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:T.innerHTML='<div class="admin-placeholder">No failed items</div>')}catch(_){console.error("Failed to load failed items:",_),T&&(T.innerHTML='<div class="admin-error-msg">Failed to load failed items</div>')}}const p=e.querySelector("#refresh-queue-status");p&&d(p,"click",r);const g=e.querySelector("#refresh-queue-history");g&&d(g,"click",c);const f=e.querySelector("#refresh-failed-btn");f&&d(f,"click",u);const h=e.querySelector("#retry-all-btn");h&&d(h,"click",async()=>{try{const _=((await v.get("/api/llm/queue/retryable?limit=50")).data?.items||[]).filter(E=>E.canRetry);let A=0;for(const E of _)try{await v.post(`/api/llm/queue/${E.id}/retry`,{resetAttempts:!1}),A++}catch{}m.success(`Queued ${A} items for retry`),r(),u()}catch{m.error("Failed to retry items")}});const k=e.querySelector("#queue-pause-btn");k&&d(k,"click",async()=>{try{await v.post("/api/llm/queue/pause"),m.success("Queue paused"),r()}catch{m.error("Failed to pause queue")}});const C=e.querySelector("#queue-resume-btn");C&&d(C,"click",async()=>{try{await v.post("/api/llm/queue/resume"),m.success("Queue resumed"),r()}catch{m.error("Failed to resume queue")}});const x=e.querySelector("#queue-clear-btn");x&&d(x,"click",async()=>{if(confirm("Are you sure you want to clear all pending items from the queue?"))try{await v.post("/api/llm/queue/clear"),m.success("Queue cleared"),r()}catch{m.error("Failed to clear queue")}}),e.addEventListener("click",async T=>{const _=T.target,A=_.closest("[data-view-request]");if(A){T.preventDefault(),T.stopPropagation();const z=A.getAttribute("data-view-request");z&&l(z);return}const E=_.closest("[data-cancel-item]");if(E){const z=E.getAttribute("data-cancel-item");if(z){try{await v.delete(`/api/llm/queue/${z}`),m.success("Item cancelled"),r()}catch{m.error("Failed to cancel item")}return}}const U=_.closest("[data-retry-item]");if(U){const z=U.getAttribute("data-retry-item");if(z){try{await v.post(`/api/llm/queue/${z}/retry`,{resetAttempts:!1}),m.success("Item queued for retry"),r(),u()}catch{m.error("Failed to retry item")}return}}const M=_.closest("[data-retry-reset-item]");if(M){const z=M.getAttribute("data-retry-reset-item");if(z){try{await v.post(`/api/llm/queue/${z}/retry`,{resetAttempts:!0}),m.success("Item queued for retry (attempts reset)"),r(),u()}catch{m.error("Failed to retry item")}return}}});async function $(){const T=e.querySelector("#metadata-sync-status"),_=e.querySelector("#provider-model-counts");try{const E=(await v.get("/api/llm/metadata/status")).data?.providers||[];if(T&&(E.length>0?T.innerHTML=`
            <table class="admin-queue-table admin-queue-table-sm">
              <thead>
                <tr>
                  <th class="admin-queue-th">Provider</th>
                  <th class="admin-queue-th">Text</th>
                  <th class="admin-queue-th">Vision</th>
                  <th class="admin-queue-th">Embeddings</th>
                  <th class="admin-queue-th">Total</th>
                  <th class="admin-queue-th">Last Synced</th>
                </tr>
              </thead>
              <tbody>
                ${E.map(U=>`
                  <tr>
                    <td class="admin-queue-td admin-queue-td-bold admin-queue-td-cap">${U.provider}</td>
                    <td class="admin-queue-td">${U.text_models||0}</td>
                    <td class="admin-queue-td">${U.vision_models||0}</td>
                    <td class="admin-queue-td">${U.embedding_models||0}</td>
                    <td class="admin-queue-td admin-queue-td-bold">${U.active_models||0}</td>
                    <td class="admin-queue-td admin-queue-td-sm admin-queue-td-muted">${U.last_synced?new Date(U.last_synced).toLocaleString():"Never"}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:T.innerHTML='<div class="admin-placeholder">No metadata found. Click "Sync All Providers" to fetch model data.</div>'),_&&E.length>0){const U=E.reduce((M,z)=>M+(z.active_models||0),0);_.innerHTML=`
          <div class="admin-provider-counts-grid">
            ${E.map(M=>`
              <div class="admin-provider-count-card">
                <div class="admin-provider-count-value">${M.active_models||0}</div>
                <div class="admin-provider-count-label">${M.provider}</div>
              </div>
            `).join("")}
            <div class="admin-provider-count-total">
              <div class="admin-provider-count-value">${U}</div>
              <div class="admin-provider-count-label">Total Models</div>
            </div>
          </div>
        `}}catch(A){console.error("Failed to load metadata status:",A),T&&(T.innerHTML='<div class="admin-error-msg">Failed to load metadata status</div>')}}const w=e.querySelector("#sync-all-metadata-btn");w&&d(w,"click",async()=>{const T=e.querySelector("#metadata-sync-result");w.disabled=!0,w.textContent="Syncing...";try{const _=await v.post("/api/llm/metadata/sync",{});if(T){T.classList.remove("hidden");const A=_.data?.providers||{},E=Object.entries(A);T.innerHTML=`
            <div class="admin-sync-result-box">
              <div class="admin-sync-result-title">Sync Results</div>
              <div class="admin-sync-result-chips">
                ${E.map(([U,M])=>`
                  <div class="admin-sync-chip admin-sync-chip-${M.status}">
                    <span class="admin-sync-chip-provider">${U}</span>
                    ${M.status==="success"?`<span class="admin-sync-chip-ok"> ‚úì ${M.synced} models</span>`:""}
                    ${M.status==="skipped"?`<span class="admin-sync-chip-skip"> - ${M.reason}</span>`:""}
                    ${M.status==="error"?`<span class="admin-sync-chip-err"> ‚úó ${M.error}</span>`:""}
                  </div>
                `).join("")}
              </div>
              <div class="admin-sync-result-total">
                Total: ${_.data?.totalModels||0} models synced
              </div>
            </div>
          `}m.success(`Synced ${_.data?.totalModels||0} models`),$()}catch{m.error("Failed to sync metadata"),T&&(T.classList.remove("hidden"),T.innerHTML='<div class="admin-error-msg">Sync failed. Check console for details.</div>')}finally{w.disabled=!1,w.textContent="‚Üª Sync All Providers"}});const y=e.querySelector("#browse-models-btn");y&&d(y,"click",async()=>{const T=e.querySelector("#browse-provider-select"),_=e.querySelector("#models-browser-content"),A=T?.value;if(!A){m.info("Please select a provider");return}_&&(_.innerHTML='<div class="admin-placeholder">Loading models...</div>');try{const E=await v.get(`/api/llm/metadata/${A}`),{textModels:U=[],visionModels:M=[],embeddingModels:z=[]}=E.data||{};_&&(U.length===0&&z.length===0?_.innerHTML='<div class="admin-empty-state">No models found for this provider. Try syncing first.</div>':_.innerHTML=`
              <div class="admin-models-browser-grid">
                ${U.length>0?`
                  <div>
                    <h5 class="admin-models-section-title">Text Models (${U.length})</h5>
                    <div class="admin-models-cards">
                      ${U.map(q=>`
                        <div class="admin-model-card">
                          <div class="admin-model-card-name">${q.display_name||q.model_id}</div>
                          <div class="admin-model-card-id">${q.model_id}</div>
                          <div class="admin-model-card-meta">
                            <span title="Context Window">üìè ${q.context_tokens?(q.context_tokens/1e3).toFixed(0)+"K":"-"}</span>
                            <span title="Input Price">üí∞ $${q.price_input?.toFixed(2)||"-"}/1M</span>
                            <span title="Output Price">üíµ $${q.price_output?.toFixed(2)||"-"}/1M</span>
                          </div>
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""}
                ${z.length>0?`
                  <div>
                    <h5 class="admin-models-section-title">Embedding Models (${z.length})</h5>
                    <div class="admin-models-chips">
                      ${z.map(q=>`
                        <div class="admin-model-chip">${q.display_name||q.model_id}</div>
                      `).join("")}
                    </div>
                  </div>
                `:""}
              </div>
            `)}catch{_&&(_.innerHTML='<div class="admin-error-msg">Failed to load models</div>')}}),Ii==="models"&&$(),Ii==="queue"&&(r(),c(),u());const S=e.querySelector("#save-graph-config");S&&d(S,"click",async()=>{const T={enabled:e.querySelector("#graph-enabled")?.checked??!0,provider:"supabase",graphName:e.querySelector("#graph-name")?.value||"godmode"};try{await ds("graph",T,"graph"),m.success("Graph configuration saved!"),console.log("[AdminPanel] Saved graph config:",T)}catch(_){console.error("[AdminPanel] Error saving graph config:",_),m.error("Failed to save graph configuration")}});const P=e.querySelector("#test-graph-connection");P&&d(P,"click",async()=>{P.textContent="Testing...";try{const T={provider:"supabase",graphName:e.querySelector("#graph-name")?.value||"godmode"};console.log("[AdminPanel] Testing Supabase graph connection");const _=await v.post("/api/graph/test",T);_.data.success||_.data.ok?m.success("Supabase graph connection successful!"):m.error(_.data.message||_.data.error||"Connection failed")}catch(T){console.error("[AdminPanel] Graph test error:",T),m.error("Graph connection test failed")}P.textContent="Test Connection"});const j=e.querySelector("#load-graph-overview");j&&d(j,"click",async()=>{await hp(),Be(e)});const H=e.querySelector("#refresh-graph-overview");H&&d(H,"click",async()=>{await hp(),Be(e),m.info("Graph overview refreshed")});const J=e.querySelector("#open-graph-tab");J&&d(J,"click",()=>{document.querySelector('.nav-item[data-tab="graph"]')?.dispatchEvent(new MouseEvent("click",{bubbles:!0}))});const B=e.querySelector("#load-ontology");B&&d(B,"click",async()=>{await fp(),Be(e)});const Z=e.querySelector("#reload-ontology");Z&&d(Z,"click",async()=>{cd=!1,await fp(),Be(e),m.info("Ontology reloaded")});const O=e.querySelector("#save-prompts");O&&d(O,"click",async()=>{const T=e.querySelectorAll("[data-prompt-key]");let _=0;for(const A of T){const E=A.getAttribute("data-prompt-key"),U=A.value;if(U&&U.trim())try{await v.put(`/api/system/prompts/${E}`,{prompt_template:U.trim()}),_++;const M=e.querySelector(`#status-${E}`);M&&(M.textContent="‚úì Saved",M.className="prompt-status saved")}catch(M){console.warn(`Failed to save prompt ${E}:`,M);const z=e.querySelector(`#status-${E}`);z&&(z.textContent="‚úó Error",z.className="prompt-status error")}}_>0?m.success(`${_} prompt(s) saved successfully`):m.info("No prompts to save")});const F=e.querySelector("#reload-prompts");F&&d(F,"click",async()=>{await bl(),Be(e),m.info("Prompts reloaded from database")}),e.querySelectorAll("[data-view-versions]").forEach(T=>{d(T,"click",async()=>{const _=T.getAttribute("data-view-versions"),A=e.querySelector(`#versions-${_}`),E=A?.querySelector(".version-list");if(!(!A||!E)){if(!A.classList.contains("hidden")){A.classList.add("hidden");return}E.innerHTML='<p class="text-muted">Loading versions...</p>',A.classList.remove("hidden");try{const U=await v.get(`/api/system/prompts/${_}/versions`),M=U.data?.versions||[],z=U.data?.current_version||1;if(M.length===0){E.innerHTML=`
            <p class="text-muted">No previous versions. Current version: ${z}</p>
            <p class="text-sm text-muted">Versions are saved automatically when you edit a prompt.</p>
          `;return}E.innerHTML=`
          <p class="text-sm"><strong>Current version:</strong> ${z}</p>
          <div class="version-items">
            ${M.map(q=>`
              <div class="version-item">
                <div class="version-info">
                  <span class="version-number">v${q.version}</span>
                  <span class="version-date">${new Date(q.created_at).toLocaleString()}</span>
                </div>
                <div class="version-actions">
                  <button class="btn-sm" data-preview-version="${_}:${q.version}">Preview</button>
                  <button class="btn-sm btn-primary" data-restore-version="${_}:${q.version}">Restore</button>
                </div>
              </div>
            `).join("")}
          </div>
        `,E.querySelectorAll("[data-restore-version]").forEach(q=>{d(q,"click",async()=>{const[I,X]=q.getAttribute("data-restore-version").split(":"),se=parseInt(X,10);if(confirm(`Restore prompt "${I}" to version ${se}? The current version will be saved in history.`))try{await v.post(`/api/system/prompts/${I}/restore`,{version:se}),m.success(`Restored to version ${se}`),await bl(),Be(e)}catch{m.error("Failed to restore version")}})}),E.querySelectorAll("[data-preview-version]").forEach(q=>{d(q,"click",async()=>{const[I,X]=q.getAttribute("data-preview-version").split(":"),se=parseInt(X,10);try{const fe=(await v.get(`/api/system/prompts/${I}/versions/${se}`)).data?.version?.prompt_template||"",we=document.createElement("div");we.className="modal-overlay",we.innerHTML=`
                <div class="modal-content admin-prompt-preview-modal">
                  <div class="modal-header">
                    <h3>Version ${se} Preview</h3>
                    <button class="modal-close">&times;</button>
                  </div>
                  <div class="modal-body">
                    <pre class="admin-prompt-preview-pre">${fe.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>
                  </div>
                </div>
              `,document.body.appendChild(we),we.querySelector(".modal-close")?.addEventListener("click",()=>{we.remove()}),we.addEventListener("click",Te=>{Te.target===we&&we.remove()})}catch{m.error("Failed to load version preview")}})})}catch{E.innerHTML='<p class="text-error">Failed to load version history</p>'}}})});const ee=e.querySelector("#save-processing");ee&&d(ee,"click",async()=>{await ds("chunk_size",parseInt(e.querySelector("#proc-chunk-size")?.value||"1000"),"processing"),await ds("chunk_overlap",parseInt(e.querySelector("#proc-chunk-overlap")?.value||"200"),"processing"),await ds("max_tokens",parseInt(e.querySelector("#proc-max-tokens")?.value||"4096"),"processing"),await ds("temperature",parseFloat(e.querySelector("#proc-temperature")?.value||"0.7"),"processing"),await ds("auto_process",e.querySelector("#proc-auto-process")?.checked,"processing"),await ds("parallel_jobs",parseInt(e.querySelector("#proc-parallel-jobs")?.value||"3"),"processing")});const ie=e.querySelector("#save-team-analysis");ie&&d(ie,"click",async()=>{const T=e.querySelector("#team-analysis-enabled")?.checked??!0,_=e.querySelector("#team-analysis-access")?.value||"admin_only";await hA(T,_),Be(e)}),d(e,"click",async T=>{const _=T.target.closest?.("[id]");if(_?.id){if(_.id==="save-google-drive"){T.preventDefault();const A=e.querySelector("#google-drive-enabled")?.checked??!1,E=e.querySelector("#google-drive-root-folder")?.value?.trim()??"",U=e.querySelector("#google-drive-service-json")?.value?.trim()??"";try{await v.post("/api/system/google-drive",{enabled:A,rootFolderId:E,serviceAccountJson:U||void 0}),m.success("Google Drive config saved"),Gs=!1,await Ao(),Be(e)}catch(M){m.error(M&&typeof M=="object"&&"message"in M?String(M.message):"Failed to save")}}else if(_.id==="bootstrap-google-drive"){T.preventDefault();const A=e.querySelector("#bootstrap-google-drive");A&&(A.disabled=!0,A.textContent="Running...");try{const E=await v.post("/api/system/google-drive/bootstrap-all");m.success(E.data?.message??`Bootstrap complete: ${E.data?.projectsCount??0} projects`),Gs=!1,await Ao(),Be(e)}catch(E){m.error(E&&typeof E=="object"&&"message"in E?String(E.message):"Bootstrap failed")}finally{A&&(A.disabled=!1,A.textContent="Bootstrap all projects")}}}});const oe=e.querySelector("#exchange-rate-auto");oe&&d(oe,"change",()=>{const T=oe.checked,_=e.querySelector("#manual-rate-group"),A=e.querySelector("#refresh-rate-btn");_&&_.classList.toggle("hidden",!!T),A&&(A.disabled=!T)});const me=e.querySelector("#refresh-rate-btn");me&&d(me,"click",async()=>{const T=me;T.disabled=!0,T.textContent="Refreshing...";try{const _=await gn.refreshExchangeRate();if(_.success&&_.rate){const A=e.querySelector("#current-rate-display"),E=e.querySelector("#rate-source");A&&(A.textContent=_.rate.toFixed(4)),E&&(E.textContent=_.source||"api"),m.success(`Rate updated: ${_.rate.toFixed(4)}`)}else m.error(_.error||"Failed to refresh rate")}catch{m.error("Failed to refresh rate")}finally{T.disabled=!1,T.textContent="Refresh Rate"}});const ze=e.querySelector("#save-exchange-rate-btn");ze&&d(ze,"click",async()=>{const T=e.querySelector("#exchange-rate-auto")?.checked??!0,_=parseFloat(e.querySelector("#exchange-rate-manual")?.value||"0.92"),A=await gn.setExchangeRateMode(T,_);A.success?(m.success("Exchange rate settings saved"),Gn=!1,await Hs(),Be(e)):m.error(A.error||"Failed to save")});const re=e.querySelector("#save-global-pricing-btn");re&&d(re,"click",async()=>{const T=parseFloat(e.querySelector("#global-markup-percent")?.value||"0"),_=e.querySelector("#global-period-type")?.value||"monthly",A=await gn.setGlobalPricingConfig({fixed_markup_percent:T,period_type:_});A.success?(m.success("Global pricing saved"),Gn=!1,await Hs(),Be(e)):m.error(A.error||"Failed to save")});const Le=e.querySelector("#add-tier-btn");Le&&d(Le,"click",()=>{vn.push({id:"",pricing_config_id:ua?.id||"",token_limit:1e5,markup_percent:20,name:`Tier ${vn.length+1}`,tier_order:vn.length}),Be(e)}),e.querySelectorAll(".remove-tier-btn").forEach(T=>{d(T,"click",()=>{const _=parseInt(T.getAttribute("data-index")||"0",10);vn.splice(_,1),Be(e)})}),e.querySelectorAll(".tier-unlimited").forEach(T=>{d(T,"change",()=>{const A=T.closest(".tier-row")?.querySelector(".tier-limit");A&&(A.disabled=T.checked,T.checked&&(A.value=""))})});const le=e.querySelector("#save-tiers-btn");le&&d(le,"click",async()=>{const T=[];e.querySelectorAll(".tier-row").forEach(A=>{const E=A.querySelector(".tier-name")?.value||"",U=A.querySelector(".tier-limit")?.value,M=parseFloat(A.querySelector(".tier-markup")?.value||"0"),z=A.querySelector(".tier-unlimited")?.checked;T.push({token_limit:z?null:U?parseInt(U,10):null,markup_percent:M,name:E||void 0})});const _=await gn.setGlobalPricingTiers(T);_.success?(m.success("Pricing tiers saved"),Gn=!1,await Hs(),Be(e)):m.error(_.error||"Failed to save tiers")});const te=e.querySelector("#refresh-billing-btn");te&&d(te,"click",async()=>{Gn=!1,await Hs(),Be(e),m.info("Billing data refreshed")}),e.querySelectorAll(".add-balance-btn").forEach(T=>{d(T,"click",async()=>{const _=T.getAttribute("data-project-id"),A=T.getAttribute("data-project-name");if(!_)return;const E=prompt(`Enter amount in EUR to add to "${A}":`);if(!E||isNaN(parseFloat(E)))return;const U=await gn.creditProjectBalance(_,parseFloat(E));U.success?(m.success(`Added ‚Ç¨${parseFloat(E).toFixed(2)} to ${A}. New balance: ‚Ç¨${U.new_balance?.toFixed(2)}`),Gn=!1,await Hs(),Be(e)):m.error(U.error||"Failed to add balance")})}),e.querySelectorAll(".toggle-unlimited-btn").forEach(T=>{d(T,"click",async()=>{const _=T.getAttribute("data-project-id"),A=T.getAttribute("data-unlimited")==="true";if(!_||!confirm(`Are you sure you want to ${A?"disable unlimited mode":"enable unlimited mode"} for this project?`))return;const U=await gn.setProjectUnlimited(_,!A);U.success?(m.success(`Unlimited mode ${A?"disabled":"enabled"}`),Gn=!1,await Hs(),Be(e)):m.error(U.error||"Failed to update")})});const ne=e.querySelector("#refresh-audit");ne&&d(ne,"click",async()=>{await Qv(),Be(e)})}function Be(e){e.innerHTML=`
    <div class="admin-panel">
      <div class="admin-header">
        <div class="admin-header-content">
          <div class="admin-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="32" height="32">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <div class="admin-title">
            <h2>Platform Administration</h2>
            <p>System configuration for superadmins</p>
          </div>
        </div>
      </div>

      <div class="admin-body">
        <nav class="admin-nav">
          ${pA()}
        </nav>

        <main class="admin-content">
          ${fl?'<div class="loading-spinner">Loading...</div>':SA()}
        </main>
      </div>
    </div>
  `,CA(e)}async function Yv(e){if(N.getState().currentUser?.role!=="superadmin"){e.innerHTML=`
      <div class="admin-panel">
        <div class="admin-header">
          <h2>Access Denied</h2>
          <p>You need superadmin privileges to access this section.</p>
        </div>
      </div>
    `;return}fl=!0,Be(e),await Promise.all([Kv(),dA(),Qv(),bl(),cA()]),fl=!1,Be(e)}const _A=Object.freeze(Object.defineProperty({__proto__:null,initAdminPanel:Yv},Symbol.toStringTag,{value:"Module"}));let Ca=[],ia=1,ld=!0,bc=!1,bt={action:"",entityType:"",dateFrom:"",dateTo:""};function Xv(e={}){const t=b("div",{className:"history-panel"});return t.innerHTML=`
    <div class="history-filters">
      <select id="history-action-filter" class="filter-select">
        <option value="">All Actions</option>
        <option value="create">Created</option>
        <option value="update">Updated</option>
        <option value="delete">Deleted</option>
        <option value="restore">Restored</option>
        <option value="process">Processed</option>
        <option value="upload">Uploaded</option>
      </select>
      <select id="history-entity-filter" class="filter-select">
        <option value="">All Types</option>
        <option value="document">Documents</option>
        <option value="fact">Facts</option>
        <option value="question">Questions</option>
        <option value="risk">Risks</option>
        <option value="action">Actions</option>
        <option value="decision">Decisions</option>
        <option value="contact">Contacts</option>
        <option value="email">Emails</option>
      </select>
      <input type="date" id="history-date-from" class="filter-date" placeholder="From">
      <input type="date" id="history-date-to" class="filter-date" placeholder="To">
      <button class="btn btn-sm" id="history-clear-filters">Clear</button>
    </div>
    <div class="history-content" id="history-content">
      <div class="loading">Loading history...</div>
    </div>
  `,LA(t,e),dd(t,e),t}function LA(e,t){const n=e.querySelector("#history-action-filter"),s=e.querySelector("#history-entity-filter"),a=e.querySelector("#history-date-from"),o=e.querySelector("#history-date-to"),i=e.querySelector("#history-clear-filters"),r=()=>{bt={action:n.value,entityType:s.value,dateFrom:a.value,dateTo:o.value},Ca=[],ia=1,ld=!0,dd(e,t)};d(n,"change",r),d(s,"change",r),d(a,"change",r),d(o,"change",r),d(i,"click",()=>{n.value="",s.value="",a.value="",o.value="",r()})}async function dd(e,t){if(bc)return;const n=e.querySelector("#history-content");ia===1&&(n.innerHTML='<div class="loading">Loading history...</div>'),bc=!0;try{const s=new URLSearchParams({page:String(ia),limit:"30"});bt.action&&s.set("action",bt.action),bt.entityType&&s.set("entityType",bt.entityType),bt.dateFrom&&s.set("dateFrom",bt.dateFrom),bt.dateTo&&s.set("dateTo",bt.dateTo);const a=await v.get(`/api/history?${s}`);Ca=ia===1?a.data.entries:[...Ca,...a.data.entries],ld=a.data.hasMore,ia++,TA(n,t)}catch{ia===1&&(n.innerHTML='<div class="error">Failed to load history</div>')}finally{bc=!1}}function TA(e,t){if(Ca.length===0){e.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">üìú</span>
        <p>No history entries found</p>
        <span class="empty-hint">Processing and editing activity will appear here</span>
      </div>
    `;return}const n=EA(Ca);e.innerHTML=`
    <div class="history-timeline">
      ${Object.entries(n).map(([a,o])=>`
        <div class="history-date-group">
          <div class="history-date-header">${a}</div>
          <div class="history-items">
            ${o.map(i=>AA(i,t)).join("")}
          </div>
        </div>
      `).join("")}
    </div>
    ${ld?`
      <div class="history-load-more">
        <button class="btn btn-secondary" id="load-more-history">Load More</button>
      </div>
    `:`
      <div class="history-end">
        <span>End of history</span>
      </div>
    `}
  `;const s=e.querySelector("#load-more-history");s&&d(s,"click",async()=>{const a=e.closest(".history-panel");await dd(a,t)}),e.querySelectorAll('[data-action="expand"]').forEach(a=>{d(a,"click",()=>{const o=a.closest(".history-entry")?.querySelector(".history-changes");o&&(o.classList.toggle("expanded"),a.textContent=o.classList.contains("expanded")?"Hide details":"Show details")})}),t.onRestore&&e.querySelectorAll('[data-action="restore"]').forEach(a=>{d(a,"click",()=>{const o=a.getAttribute("data-entry-id"),i=Ca.find(r=>r.id===o);i&&t.onRestore&&t.onRestore(i)})})}function AA(e,t){const n={create:"‚ûï",update:"‚úèÔ∏è",delete:"üóëÔ∏è",restore:"‚Ü©Ô∏è",process:"‚öôÔ∏è",upload:"üì§"},s={create:"success",update:"info",delete:"danger",restore:"warning",process:"info",upload:"success"},a=e.changes&&Object.keys(e.changes).length>0;return`
    <div class="history-entry ${s[e.action]||"info"}" data-entry-id="${e.id}">
      <div class="history-icon">${n[e.action]||"üìù"}</div>
      <div class="history-content">
        <div class="history-summary">
          <strong>${kp(e.actor.name)}</strong>
          ${MA(e.action)}
          <span class="entity-type">${e.entityType}</span>
          ${e.entityName?`"${kp(e.entityName)}"`:""}
        </div>
        <div class="history-time">${Ce(e.timestamp)}</div>
        
        ${a?`
          <div class="history-changes">
            ${Object.entries(e.changes).slice(0,5).map(([o,i])=>`
              <div class="change-item">
                <span class="change-field">${qA(o)}:</span>
                <span class="change-old">${wp(i.old)}</span>
                <span class="change-arrow">‚Üí</span>
                <span class="change-new">${wp(i.new)}</span>
              </div>
            `).join("")}
            ${Object.keys(e.changes).length>5?`<div class="change-more">+${Object.keys(e.changes).length-5} more changes</div>`:""}
          </div>
          <button class="btn-link" data-action="expand">Show details</button>
        `:""}
        
        ${e.action==="delete"&&t.onRestore?`
          <button class="btn btn-sm btn-secondary" data-action="restore" data-entry-id="${e.id}">
            Restore
          </button>
        `:""}
      </div>
    </div>
  `}function MA(e){return{create:"created",update:"updated",delete:"deleted",restore:"restored",process:"processed",upload:"uploaded"}[e]||e}function EA(e){const t={},n=new Date().toDateString(),s=new Date(Date.now()-864e5).toDateString();return e.forEach(a=>{const o=new Date(a.timestamp);let i;o.toDateString()===n?i="Today":o.toDateString()===s?i="Yesterday":i=o.toLocaleDateString(void 0,{weekday:"long",month:"long",day:"numeric"}),t[i]||(t[i]=[]),t[i].push(a)}),t}function qA(e){return e.replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^./,t=>t.toUpperCase())}function wp(e){if(e==null)return"(empty)";if(typeof e=="boolean")return e?"Yes":"No";if(typeof e=="object"){const n=JSON.stringify(e);return n.length>50?n.substring(0,47)+"...":n}const t=String(e);return t.length>50?t.substring(0,47)+"...":t}function kp(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function ef(e="json"){try{const t=new URLSearchParams({format:e,limit:"1000"});bt.action&&t.set("action",bt.action),bt.entityType&&t.set("entityType",bt.entityType),bt.dateFrom&&t.set("dateFrom",bt.dateFrom),bt.dateTo&&t.set("dateTo",bt.dateTo);const s=await(await at(`/api/history/export?${t}`)).blob(),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=`history-export.${e}`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),m.success("History exported successfully")}catch{m.error("Failed to export history")}}const jA=Object.freeze(Object.defineProperty({__proto__:null,createHistoryPanel:Xv,exportHistory:ef},Symbol.toStringTag,{value:"Module"})),PA=Object.freeze(Object.defineProperty({__proto__:null,addProcessingStep:EL,alert:_m,clearSelection:Zl,closeAllModals:xm,closeAuthModal:QL,closeEmailComposer:Da,closeFactModal:bv,closeModal:K,closeProcessingModal:Kg,closeProfileModal:hv,closeSearch:Na,confirm:xs,createActionsPanel:Bo,createApiKeysPanel:F3,createAuditPanel:Y3,createBreakdownChart:yg,createBriefingPanel:yv,createBulkActionsBar:pL,createBulkCheckbox:bL,createChat:Dl,createCommentsThread:wg,createContactsPanel:$v,createConversationsPanel:v3,createCostsDashboard:Ng,createDashboard:zo,createDecisionsPanel:No,createDocumentsPanel:cl,createEmailComposer:id,createEmailsPanel:Pv,createFactsPanel:ja,createFileUploader:K4,createHeader:bm,createHealthBadge:H4,createHealthIndicator:I4,createHistoryPanel:Xv,createKnowledgeGraph:X4,createKnowledgePanel:n3,createMembersPanel:H3,createModal:Pe,createNotificationsDropdown:Hv,createOrgChart:Lv,createProjectSelector:US,createQuestionDetailView:br,createQuestionsPanel:zl,createReportsPanel:kT,createRiskMatrix:G4,createRiskSummary:W4,createRisksPanel:Io,createSidebar:ym,createSourceOfTruth:pg,createStatsCard:qg,createStatsGrid:z4,createSyncIndicator:wL,createSyncStatus:yL,createTeamsPanel:Cv,createThemeToggle:Ll,createTimeline:i_,createTimelinePanel:Ig,createToastElement:km,createTrendChart:N4,createWebhooksPanel:K3,deselectItem:fL,exportHistory:ef,getHealthColor:B4,getHealthStatus:R4,getSelectedIds:hL,getToastContainer:wm,initAdminPanel:Yv,initCommandPalette:Wg,initGlobalSearch:Og,initNotificationsDropdown:Nv,initProjectSelector:FS,isModalOpen:$m,isProcessingModalOpen:jL,isSelected:Qc,mountChat:og,mountDashboard:ag,mountHeader:o2,mountSidebar:u2,mountSourceOfTruth:MC,mountThemeToggle:Uw,openModal:De,openSearch:Fg,renderRolesPanel:Gv,selectItem:vL,setProcessingSteps:qL,showActionModal:Ea,showAuthModal:Kl,showCommentModal:nT,showCompaniesModal:JL,showContactModal:zn,showDecisionModal:Ra,showDeveloperModal:Yl,showEmailComposer:pl,showEmailModal:Xl,showExportModal:g5,showFactModal:ed,showFileUploadModal:Jl,showGraphModal:Z5,showHistoryModal:J5,showInviteModal:Ql,showNotificationsModal:E5,showProcessingModal:LL,showProfileModal:gv,showProjectModal:Ui,showQuestionModal:Yi,showRiskModal:Ba,showRoleModal:ov,showSettingsModal:CL,showShortcutsModal:cv,showTeamModal:Zo,showToastInContainer:p2,toggleSearch:Wc,toggleSelection:Gg,updateModalContent:Sm,updateModalTitle:Cm,updateProcessingStep:ML,updateStatsCard:D4,updateTabBadge:d2},Symbol.toStringTag,{value:"Module"}));class lr{static isInitialized=!1;static init(){this.isInitialized||(window.addEventListener("error",this.handleError),window.addEventListener("unhandledrejection",this.handleRejection),this.isInitialized=!0,console.log("[ErrorBoundary] Initialized global error handling."))}static handleError(t){console.error("[ErrorBoundary] Uncaught Exception:",t.error),lr.showErrorUI("An unexpected error occurred.",t.error?.message)}static handleRejection(t){console.error("[ErrorBoundary] Unhandled Promise Rejection:",t.reason);const n=t.reason?.message||(typeof t.reason=="string"?t.reason:"Unknown failure");lr.showErrorUI("Async operation failed.",n)}static showErrorUI(t,n){const s=`${t} ${n?`(${n})`:""}`;m.error(s)}}const tf={profiles:[],selectedProfile:null,teamAnalysis:null,relationships:[],graphData:null,loading:!1,analyzing:!1,error:null,currentSubtab:"profiles"};let Xe={...tf};const yl=new Set;function Rn(){yl.forEach(e=>e(Xe))}function nf(){return Xe}function sf(e){return yl.add(e),()=>yl.delete(e)}function Ss(e){Xe={...Xe,loading:e},Rn()}function za(e){Xe={...Xe,analyzing:e},Rn()}function wt(e){Xe={...Xe,error:e},Rn()}function Lr(e){Xe={...Xe,profiles:e},Rn()}function Tr(e){Xe={...Xe,selectedProfile:e},Rn()}function Ar(e){Xe={...Xe,teamAnalysis:e},Rn()}function ud(e){Xe={...Xe,relationships:e},Rn()}function pd(e){Xe={...Xe,graphData:e},Rn()}function af(e){Xe={...Xe,currentSubtab:e},Rn()}async function md(){Ss(!0),wt(null);try{const t=await(await at("/api/team-analysis/profiles")).json();t.ok?Lr(t.profiles||[]):wt(t.error||"Failed to load profiles")}catch(e){wt(e.message||"Failed to load profiles")}finally{Ss(!1)}}async function of(e){Ss(!0),wt(null);try{const n=await(await at(`/api/team-analysis/profiles/${e}`)).json();return n.ok&&n.profile?(Tr(n.profile),n.profile):(wt(n.error||"Profile not found"),null)}catch(t){return wt(t.message||"Failed to load profile"),null}finally{Ss(!1)}}async function rf(e,t={}){za(!0),wt(null);try{const s=await(await at(`/api/team-analysis/profiles/${e}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();if(s.ok&&s.profile){const a=Xe.profiles.map(o=>o.person_id===e?s.profile:o);return a.find(o=>o.person_id===e)||a.push(s.profile),Lr(a),Tr(s.profile),s.profile}else return wt(s.error||"Failed to analyze profile"),null}catch(n){return wt(n.message||"Failed to analyze profile"),null}finally{za(!1)}}async function gd(){Ss(!0),wt(null);try{console.log("[TeamAnalysisStore] Loading team analysis...");const t=await(await at("/api/team-analysis/team")).json();console.log("[TeamAnalysisStore] Team analysis response:",t),t.ok?(console.log("[TeamAnalysisStore] Setting team analysis:",t.analysis),Ar(t.analysis)):(console.error("[TeamAnalysisStore] Error:",t.error),wt(t.error||"Failed to load team analysis"))}catch(e){console.error("[TeamAnalysisStore] Exception:",e),wt(e.message||"Failed to load team analysis")}finally{Ss(!1)}}async function cf(e=!1){za(!0),wt(null);try{const n=await(await at("/api/team-analysis/team/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({forceReanalysis:e})})).json();return n.ok&&n.analysis?(Ar(n.analysis),n.analysis):(wt(n.error||"Failed to analyze team"),null)}catch(t){return wt(t.message||"Failed to analyze team"),null}finally{za(!1)}}async function vd(){try{const t=await(await at("/api/team-analysis/relationships")).json();t.ok&&ud(t.relationships||[])}catch(e){console.error("Failed to load relationships:",e)}}async function fd(){try{console.log("[TeamAnalysisStore] Loading graph data...");const t=await(await at("/api/team-analysis/graph")).json();console.log("[TeamAnalysisStore] Graph data response:",t),t.ok&&(console.log("[TeamAnalysisStore] Setting graph data:",t.nodes?.length,"nodes,",t.edges?.length,"edges"),pd({nodes:t.nodes||[],edges:t.edges||[]}))}catch(e){console.error("[TeamAnalysisStore] Failed to load graph data:",e)}}async function lf(){await Promise.all([md(),gd(),vd(),fd()])}function df(){Xe={...tf},Rn()}const uf={getState:nf,subscribe:sf,setLoading:Ss,setAnalyzing:za,setError:wt,setProfiles:Lr,setSelectedProfile:Tr,setTeamAnalysis:Ar,setRelationships:ud,setGraphData:pd,setSubtab:af,loadProfiles:md,loadProfile:of,analyzeProfile:rf,loadTeamAnalysis:gd,analyzeTeam:cf,loadRelationships:vd,loadGraphData:fd,loadAll:lf,reset:df},DA=Object.freeze(Object.defineProperty({__proto__:null,analyzeProfile:rf,analyzeTeam:cf,getState:nf,loadAll:lf,loadGraphData:fd,loadProfile:of,loadProfiles:md,loadRelationships:vd,loadTeamAnalysis:gd,reset:df,setAnalyzing:za,setError:wt,setGraphData:pd,setLoading:Ss,setProfiles:Lr,setRelationships:ud,setSelectedProfile:Tr,setSubtab:af,setTeamAnalysis:Ar,subscribe:sf,teamAnalysisStore:uf},Symbol.toStringTag,{value:"Module"}));Object.defineProperty(window,"currentProject",{get:()=>N.getState().currentProject,set:e=>N.setCurrentProject(e),configurable:!0});Object.defineProperty(window,"currentProjectId",{get:()=>N.getState().currentProjectId,set:e=>N.setCurrentProjectId(e),configurable:!0});Object.defineProperty(window,"currentUser",{get:()=>N.getState().currentUser,set:e=>N.setCurrentUser(e),configurable:!0});Object.defineProperty(window,"authConfigured",{get:()=>N.getState().authConfigured,set:e=>N.setAuthConfigured(e),configurable:!0});Object.defineProperty(window,"currentTab",{get:()=>Ie.getState().currentTab,set:e=>Ie.setTab(e),configurable:!0});Object.defineProperty(window,"questions",{get:()=>ce.getState().questions,set:e=>ce.setQuestions(e),configurable:!0});Object.defineProperty(window,"risks",{get:()=>ce.getState().risks,set:e=>ce.setRisks(e),configurable:!0});Object.defineProperty(window,"actions",{get:()=>ce.getState().actions,set:e=>ce.setActions(e),configurable:!0});Object.defineProperty(window,"decisions",{get:()=>ce.getState().decisions,set:e=>ce.setDecisions(e),configurable:!0});Object.defineProperty(window,"contacts",{get:()=>ce.getState().contacts,set:e=>ce.setContacts(e),configurable:!0});Object.defineProperty(window,"chatHistory",{get:()=>ce.getState().chatHistory,set:e=>ce.setChatHistory(e),configurable:!0});window.api=async function(t,n="GET",s){try{let a;switch(n.toUpperCase()){case"GET":a=await v.get(t);break;case"POST":a=await v.post(t,s);break;case"PUT":a=await v.put(t,s);break;case"PATCH":a=await v.patch(t,s);break;case"DELETE":a=await v.delete(t);break;default:a=await En(t,{method:n,body:s?JSON.stringify(s):void 0})}return a.data}catch(a){throw console.error("API Error:",a),a}};window.showToast=function(t,n="info"){m[n](t)};window.setTheme=function(t){tt.set(t)};window.toggleTheme=function(){tt.toggle()};window.getStorageItem=function(t,n=null){return Yt.get(t,n)};window.setStorageItem=function(t,n){Yt.set(t,n)};window.switchTab=function(t){Ie.setTab(t)};window.refreshData=async function(){const t=N.getState().currentProjectId;if(t)try{const[n,s,a,o,i]=await Promise.all([v.get(`/api/projects/${t}/questions`),v.get(`/api/projects/${t}/risks`),v.get(`/api/projects/${t}/actions`),v.get(`/api/projects/${t}/decisions`),v.get(`/api/projects/${t}/contacts`)]);ce.setQuestions(n.data),ce.setRisks(s.data),ce.setActions(a.data),ce.setDecisions(o.data),ce.setContacts(i.data)}catch(n){console.error("Failed to refresh data:",n)}};window.registerChart=function(e,t,n,s="bar"){Es.registerChart(e,t,n,s)};window.destroyChart=function(e){Es.destroyChart(e)};window.getChart=function(e){return Es.getChart(e)};window.registerShortcut=function(e,t,n={}){Qt.register({key:e,ctrl:n.ctrl,shift:n.shift,alt:n.alt,handler:t,description:n.description||"Custom shortcut"})};window.pushUndoAction=function(e,t,n){mn.push({id:`undo-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,description:e,undo:t,redo:n})};window.undoLastAction=function(){return mn.undo()};window.redoLastAction=function(){return mn.redo()};function zA(){console.log("[GodMode] Legacy bridge initialized"),N.init()}function IA(e){if(!document.startViewTransition){e();return}document.startViewTransition(async()=>{await e()}).finished.then(()=>{document.documentElement.classList.remove("vt-slide","vt-slide-back")})}lr.init();window.godmode={theme:tt,toast:m,shortcuts:Qt,undo:mn,storage:Yt,http:v,api:En,configureApi:Ap,auth:Nt,projects:ks,dashboard:xl,questions:Qe,risks:jt,actions:Ee,decisions:Ue,chat:Ri,contacts:Ne,teams:Zp,documents:Cs,knowledge:_a,emails:ma,graph:Cl,timeline:Yp,costs:La,notifications:Ta,comments:ga,members:Ni,profile:Kn,userSettings:sw,projectSettings:aw,apiKeys:iw,webhooks:ow,audit:rw,facts:nt,appStore:N,uiStore:Ie,dataStore:ce,chartsStore:Es,version:"2.0.0"};Sf(()=>N.getState().currentProjectId);_f(e=>{const t=N.getState().currentProjectId;return t&&e.headers&&(e.headers["X-Project-Id"]=t),e});function HA(){Qt.register({key:"z",ctrl:!0,description:"Undo last action",handler:async()=>{mn.canUndo()&&(await mn.undo(),m.info("Undo: "+(mn.getRedoDescription()||"Action undone")))}}),Qt.register({key:"z",ctrl:!0,shift:!0,description:"Redo last action",handler:async()=>{mn.canRedo()&&(await mn.redo(),m.info("Redo: "+(mn.getUndoDescription()||"Action redone")))}}),Qt.register({key:"t",ctrl:!0,shift:!0,description:"Cycle theme (light/dark/system)",handler:()=>{tt.cycle(),m.info(`Theme: ${tt.getLabel()}`)}}),Qt.register({key:"?",description:"Show keyboard shortcuts",handler:()=>{Qt.showHelp()}})}function BA(){Ap({onUnauthorized:()=>{N.setCurrentUser(null),m.error("Session expired. Please log in again."),window.dispatchEvent(new CustomEvent("godmode:auth-required"))},onForbidden:()=>{m.error("You do not have permission to perform this action.")}})}function RA(){const e=document.getElementById("theme-toggle");e&&(e.addEventListener("click",()=>{tt.cycle(),Sp(),m.info(`Theme: ${tt.getLabel()}`)}),Sp()),Wg();const t=document.getElementById("user-avatar"),n=document.getElementById("user-dropdown");t&&n&&(t.addEventListener("click",S=>{S.stopPropagation(),n.classList.toggle("hidden")}),document.addEventListener("click",()=>{n.classList.add("hidden")}));const s=document.getElementById("login-btn");s&&s.addEventListener("click",()=>{Kl({onSuccess:()=>{Hi(),ns()}})});const a=document.getElementById("logout-btn");a&&a.addEventListener("click",async()=>{await Nt.logout(),dr(),ce.setProjects([]),N.setCurrentProject(null),N.setCurrentProjectId(null),Hi(),GA(),N.getState().authConfigured?(m.info("Signed out successfully"),window.location.href="/"):m.info("Signed out")});const o=document.getElementById("settings-btn");o&&o.addEventListener("click",()=>{Fe("settings")});const i=document.getElementById("shortcuts-btn");i&&i.addEventListener("click",()=>{cv()});const r=document.getElementById("dev-tools-btn");r&&r.addEventListener("click",()=>{Yl()});const c=document.getElementById("profile-btn");c&&c.addEventListener("click",()=>{n?.classList.add("hidden"),Fe("profile")});const l=document.getElementById("notifications-container");l&&Nv(l,{onNotificationClick:S=>{console.log("Notification clicked:",S),S.entity_type&&S.entity_id&&window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{type:S.entity_type,id:S.entity_id}}))}}),document.querySelectorAll(".nav-item[data-tab]").forEach(S=>{S.addEventListener("click",()=>{const P=S.getAttribute("data-tab");P&&Fe(P)})});const p=document.querySelectorAll(".sot-tab");p.forEach(S=>{S.addEventListener("click",()=>{const P=S.getAttribute("data-view");P&&(p.forEach(j=>j.classList.remove("active")),S.classList.add("active"),Ie.setSotView(P),hs(P))})});const g=document.getElementById("menu-toggle"),f=document.getElementById("app-sidebar");g&&f&&g.addEventListener("click",()=>{f.classList.toggle("open")});const h=document.getElementById("new-contact-btn");h&&h.addEventListener("click",()=>{zn({mode:"create"})}),document.querySelectorAll("#new-upload-btn, #upload-files-btn").forEach(S=>{S.addEventListener("click",()=>{Jl()})}),KA();const C=document.getElementById("project-selector"),x=document.getElementById("new-project-btn"),$=document.getElementById("edit-project-btn");C&&(C.addEventListener("change",async()=>{const S=C.value;console.log("üîÑ Project selector changed, value:",S),S?(await VA(S),$&&$.classList.remove("hidden")):(console.log("üì≠ Clearing project - starting..."),$&&$.classList.add("hidden"),N.setCurrentProject(null),N.setCurrentProjectId(null),console.log("üì≠ Store cleared"),dr(),console.log("üì≠ Data store cleared"),console.log("üì≠ Calling showNoProjectState..."),pf(),console.log("üì≠ showNoProjectState called"),Fe("dashboard"),hs(Ie.getState().sotCurrentView),v.post("/api/projects/deactivate").catch(()=>{}),console.log("üì≠ Project deselected - ALL DONE"))}),hd()),x&&x.addEventListener("click",()=>{window.__godmodeProjectsOpen="create",Fe("projects")}),$&&$.addEventListener("click",()=>{const S=N.getState().currentProject;S&&(window.__godmodeProjectsOpen="edit:"+S.id,Fe("projects"))});const w=document.querySelectorAll("#contacts-subtabs .subtab");w.forEach(S=>{S.addEventListener("click",()=>{w.forEach(j=>j.classList.remove("active")),S.classList.add("active");const P=S.getAttribute("data-subtab");document.querySelectorAll('[id^="contacts-subtab-"]').forEach(j=>{j.classList.toggle("hidden",j.id!==`contacts-subtab-${P}`)})})});const y=document.getElementById("refresh-dashboard-btn");y&&y.addEventListener("click",()=>{xp(),m.info("Dashboard refreshed")}),xp(),NA()}function pf(){console.log("üì≠ showNoProjectState() called");const e=document.getElementById("dashboard-container");if(console.log("üì≠ dashboardContainer:",e?"FOUND":"NOT FOUND"),!e)return;console.log("üì≠ Setting innerHTML NOW..."),e.innerHTML=`
    <div class="dashboard gm-p-5">
      <div class="no-project-state gm-empty-state">
        <svg class="gm-empty-state-icon" width="96" height="96" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        <h2 class="gm-empty-state-title">No Project Selected</h2>
        <p class="gm-empty-state-desc">
          Select a project from the dropdown above, or create a new one to get started with your data management.
        </p>
        <button id="create-project-empty-cta" class="btn btn-primary gm-empty-state-cta">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create New Project
        </button>
      </div>
    </div>
  `,console.log("üì≠ innerHTML SET! Container visible:",e.offsetParent!==null),console.log("üì≠ Container display:",window.getComputedStyle(e).display);const t=document.getElementById("create-project-empty-cta");t&&t.addEventListener("click",()=>{window.__godmodeProjectsOpen="create",Fe("projects")})}async function wl(){const e=document.getElementById("dashboard-container");if(!e)return;const t=N.getState().currentProject,n=N.getState().currentProjectId;if(!t&&!n){pf();return}e.innerHTML='<div class="gm-loading-placeholder">Loading dashboard...</div>';try{const{createDashboard:s}=await xe(async()=>{const{createDashboard:o}=await Promise.resolve().then(()=>rC);return{createDashboard:o}},void 0);e.innerHTML="";const a=s({onStatClick:o=>{console.log("Stat clicked:",o),o==="questions"?Fe("sot"):o==="facts"?(Fe("sot"),Ie.setSotView("facts"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="facts")}),hs("facts")):o==="risks"?(Fe("sot"),Ie.setSotView("risks"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="risks")}),hs("risks")):o==="actions"?(Fe("sot"),Ie.setSotView("actions"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="actions")}),hs("actions")):o==="decisions"?(Fe("sot"),Ie.setSotView("decisions"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="decisions")}),hs("decisions")):o==="contacts"&&Fe("contacts")}});e.appendChild(a)}catch(s){console.error("Failed to load Dashboard:",s),e.innerHTML='<div class="gm-error-placeholder">Failed to load dashboard</div>'}}function xp(){wl();const e=document.getElementById("chat-panel-container");e&&e.children.length===0&&xe(async()=>{const{createChat:l}=await Promise.resolve().then(()=>cC);return{createChat:l}},void 0).then(({createChat:l})=>{const u=l({showSources:!0,showSessions:!0});e.appendChild(u)}).catch(l=>{console.error("[Chat] Failed to load Chat:",l),e.innerHTML='<div class="gm-loading-placeholder gm-text-secondary">Failed to load chat</div>'});const t=document.getElementById("emails-panel-container");t&&t.children.length===0&&xe(async()=>{const{createEmailsPanel:l}=await Promise.resolve().then(()=>C3);return{createEmailsPanel:l}},void 0).then(({createEmailsPanel:l})=>{const u=l();t.appendChild(u)});const n=document.getElementById("contacts-panel-container");n&&n.querySelectorAll(".contacts-panel-sota").length===0&&xe(async()=>{const{createContactsPanel:l}=await Promise.resolve().then(()=>zT);return{createContactsPanel:l}},void 0).then(({createContactsPanel:l})=>{n.innerHTML="";const u=l();n.appendChild(u)});const s=document.getElementById("teams-panel-container");s&&s.children.length===0&&xe(async()=>{const{createTeamsPanel:l}=await Promise.resolve().then(()=>NT);return{createTeamsPanel:l}},void 0).then(({createTeamsPanel:l})=>{const u=l();s.appendChild(u)});const a=document.getElementById("roles-panel-container");a&&a.children.length===0&&xe(async()=>{const{renderRolesPanel:l}=await Promise.resolve().then(()=>rA);return{renderRolesPanel:l}},void 0).then(({renderRolesPanel:l})=>{l(a)});const o=document.getElementById("files-panel-container");o&&o.querySelectorAll(".documents-panel-minimal").length===0&&(o.innerHTML="",xe(async()=>{const{default:l}=await Promise.resolve().then(()=>t3);return{default:l}},void 0).then(({default:l})=>{const u=l({onDocumentClick:async p=>{const{showDocumentPreviewModal:g}=await xe(async()=>{const{showDocumentPreviewModal:f}=await import("./DocumentPreviewModal-hKXOUBAt.js");return{showDocumentPreviewModal:f}},__vite__mapDeps([2,1]));g({document:p})}});o.appendChild(u)}).catch(l=>{console.error("[FilesPanel] Failed to load DocumentsPanel:",l),o.innerHTML='<div class="gm-loading-placeholder gm-text-secondary">Failed to load files panel</div>'}));const i=document.getElementById("org-chart-container");i&&i.children.length===0&&xe(async()=>{const{createOrgChart:l}=await Promise.resolve().then(()=>GT);return{createOrgChart:l}},void 0).then(({createOrgChart:l})=>{const u=l();i.appendChild(u)});const r=document.getElementById("costs-container");r&&r.children.length===0&&xe(async()=>{const{createCostsDashboard:l}=await Promise.resolve().then(()=>nL);return{createCostsDashboard:l}},void 0).then(({createCostsDashboard:l})=>{const u=l();r.appendChild(u)});const c=document.getElementById("history-container");c&&c.children.length===0&&xe(async()=>{const{createHistoryPanel:l,exportHistory:u}=await Promise.resolve().then(()=>jA);return{createHistoryPanel:l,exportHistory:u}},void 0).then(({createHistoryPanel:l,exportHistory:u})=>{const p=l({onRestore:f=>{m.info(`Restoring ${f.entityType} "${f.entityName||f.entityId}"`)}});c.appendChild(p);const g=document.getElementById("export-history-btn");g&&g.addEventListener("click",()=>u("json"))})}function NA(){const e=document.querySelectorAll(".dropzone-card[data-type]");console.log("[DropZones] Found",e.length,"dropzones"),e.forEach(t=>{const n=t.getAttribute("data-type");console.log("[DropZones] Adding click handler for:",n),t.addEventListener("click",async s=>{console.log("[DropZones] Click on:",n),s.preventDefault(),s.stopPropagation();try{switch(n){case"emails":console.log("[DropZones] Opening EmailComposer...");const{showEmailComposer:a}=await xe(async()=>{const{showEmailComposer:c}=await Promise.resolve().then(()=>Iv);return{showEmailComposer:c}},void 0);a({onSave:()=>{m.success("Email imported")}});return;case"conversations":console.log("[DropZones] Opening ConversationComposer...");const{showConversationComposer:o}=await xe(async()=>{const{showConversationComposer:c}=await Promise.resolve().then(()=>g3);return{showConversationComposer:c}},void 0);o({onImport:()=>{m.success("Conversation imported")}});return;case"transcripts":console.log("[DropZones] Opening TranscriptComposer...");const{showTranscriptComposer:i}=await xe(async()=>{const{showTranscriptComposer:c}=await import("./TranscriptComposer-DdklGiRc.js");return{showTranscriptComposer:c}},__vite__mapDeps([3,1]));i({onImport:()=>{m.success("Transcript imported")}});return;default:console.log("[DropZones] Opening file picker for documents...");const r=document.createElement("input");r.type="file",r.multiple=!0,r.accept=".pdf,.doc,.docx,.txt,.md,.rtf,.odt,.xls,.xlsx,.ppt,.pptx,.csv,.json",r.onchange=()=>{r.files&&r.files.length>0&&$p(Array.from(r.files),"documents")},r.click();return}}catch(a){console.error("[DropZones] Error:",a),m.error("Failed to open import dialog")}}),t.addEventListener("dragover",s=>{s.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",s=>{s.preventDefault(),t.classList.remove("drag-over");const a=s.dataTransfer;a?.files&&a.files.length>0&&$p(Array.from(a.files),n||"documents")})})}async function $p(e,t){WA(e);const n=e.map(s=>s.name).join(", ");m.info(`Added ${e.length} ${t} to queue: ${n.substring(0,50)}${n.length>50?"...":""}`)}function Sp(){const e=document.getElementById("theme-toggle");e&&(e.textContent=tt.getIcon(),e.title=`Theme: ${tt.getLabel()}`)}const OA=["dashboard","chat","sot","timeline","contacts","team-analysis","files","graph","emails","costs","history","roles","profile","settings","admin","org","projects"];function Cp(){const t=window.location.pathname.match(/^\/app\/([^/]+)/);return t&&OA.includes(t[1])?t[1]:"dashboard"}function FA(e,t=!1){const n=e==="dashboard"?"/app":`/app/${e}`;window.location.pathname!==n&&(t?window.history.replaceState({tab:e},"",n):window.history.pushState({tab:e},"",n))}function UA(){window.addEventListener("popstate",t=>{const n=t.state?.tab||Cp();Fe(n,!1)});const e=Cp();e!=="dashboard"&&setTimeout(()=>Fe(e,!0),0)}function Fe(e,t=!0){IA(()=>{document.querySelectorAll(".nav-item[data-tab]").forEach(s=>{s.classList.toggle("active",s.getAttribute("data-tab")===e)}),document.querySelectorAll(".tab-content").forEach(s=>{s.classList.toggle("active",s.id===`tab-${e}`),s.classList.toggle("hidden",s.id!==`tab-${e}`)});const n=document.getElementById("app-sidebar");if(n&&n.classList.remove("open"),t&&FA(e),Ie.setTab(e),e==="profile"){const s=document.getElementById("profile-page-container");s&&xe(async()=>{const{initProfilePage:a}=await Promise.resolve().then(()=>dT);return{initProfilePage:a}},void 0).then(({initProfilePage:a})=>{a(s,{onBack:()=>Fe("dashboard")})})}if(e==="projects"){const s=document.getElementById("projects-page-container");s&&xe(async()=>{const{initProjectsPage:a}=await import("./ProjectsPage-Czx4uj8q.js");return{initProjectsPage:a}},__vite__mapDeps([4,1])).then(({initProjectsPage:a})=>{a(s,{onBack:()=>Fe("dashboard")})})}if(e==="settings"){const s=document.getElementById("settings-page-container");s&&xe(async()=>{const{initSettingsPage:a}=await import("./SettingsPage-CinL5LtU.js");return{initSettingsPage:a}},__vite__mapDeps([5,1])).then(({initSettingsPage:a})=>{a(s,{onBack:()=>Fe("dashboard")})})}if(e==="admin"){const s=document.getElementById("tab-admin");s&&xe(async()=>{const{initAdminPanel:a}=await Promise.resolve().then(()=>_A);return{initAdminPanel:a}},void 0).then(({initAdminPanel:a})=>{a(s)})}if(e==="graph"){const s=document.getElementById("graph-container"),a=s?.querySelector(".graph-explorer");s&&!a&&(console.log("[Graph] Loading GraphExplorer..."),xe(async()=>{const{createGraphExplorer:o}=await import("./GraphExplorer-7mjX8jdS.js");return{createGraphExplorer:o}},__vite__mapDeps([6,1])).then(({createGraphExplorer:o})=>{s.innerHTML="";const i=o({onNodeSelect:r=>{console.log("Graph node selected:",r)},onQueryExecute:r=>{console.log("Query executed:",r)}});s.appendChild(i),console.log("[Graph] GraphExplorer loaded successfully")}).catch(o=>{console.error("[Graph] Failed to load GraphExplorer:",o),s.innerHTML='<div class="gm-loading-placeholder gm-text-center">Failed to load Graph Explorer</div>'}))}if(e==="timeline"){const s=document.getElementById("timeline-content"),a=s?.querySelector(".timeline-panel");s&&!a&&(console.log("[Timeline] Loading TimelinePanel..."),xe(async()=>{const{createTimelinePanel:o}=await Promise.resolve().then(()=>__);return{createTimelinePanel:o}},void 0).then(({createTimelinePanel:o})=>{s.innerHTML="";const i=o({onEventClick:r=>{if(console.log("Timeline event clicked:",r),r.entity_type&&r.entity_id){const c=r.entity_type;c==="question"?c==="question"?xe(()=>Promise.resolve().then(()=>lC),void 0).then(async({createQuestionDetailView:l})=>{const u=document.getElementById("timeline-content");if(u&&r.entity_id)try{const p=await window.godmode.questions.get(r.entity_id);if(!p)throw new Error("Question not found");u.innerHTML="";const g=l({question:p,onClose:()=>Fe("timeline")});u.appendChild(g)}catch(p){console.error("Failed to load question details:",p),m.error("Failed to load question details")}}):c==="decision"?xe(()=>Promise.resolve().then(()=>b4),void 0).then(async({createDecisionDetailView:l})=>{const u=document.getElementById("timeline-content");if(u&&r.entity_id)try{const p=await window.godmode.decisions.get(r.entity_id);if(!p)throw new Error("Decision not found");u.innerHTML="";const g=l({decision:p,onClose:()=>Fe("timeline")});u.appendChild(g)}catch(p){console.error("Failed to load decision details:",p),m.error("Failed to load decision details")}}):c==="fact"?xe(()=>Promise.resolve().then(()=>T4),void 0).then(async({createFactDetailView:l})=>{const u=document.getElementById("timeline-content");if(u&&r.entity_id)try{const p=await window.godmode.facts.get(r.entity_id);if(!p)throw new Error("Fact not found");u.innerHTML="";const g=l({fact:p,onClose:()=>Fe("timeline")});u.appendChild(g)}catch(p){console.error("Failed to load fact details:",p),m.error("Failed to load fact details")}}):c==="risk"?xe(()=>Promise.resolve().then(()=>jC),void 0).then(async({createRiskDetailView:l})=>{const u=document.getElementById("timeline-content");if(u&&r.entity_id)try{const p=await window.godmode.risks.get(r.entity_id);if(!p)throw new Error("Risk not found");u.innerHTML="";const g=l({risk:p,onClose:()=>Fe("timeline")});u.appendChild(g)}catch(p){console.error("Failed to load risk details:",p),m.error("Failed to load risk details")}}):c==="action"&&xe(()=>Promise.resolve().then(()=>d4),void 0).then(async({createActionDetailView:l})=>{const u=document.getElementById("timeline-content");if(u&&r.entity_id)try{const p=await window.godmode.actions.get(r.entity_id);if(!p)throw new Error("Action not found");u.innerHTML="";const g=l({action:p,onClose:()=>Fe("timeline")});u.appendChild(g)}catch(p){console.error("Failed to load action details:",p),m.error("Failed to load action details")}}):m.info(`Event: ${r.title}`)}}});s.appendChild(i),console.log("[Timeline] TimelinePanel loaded successfully")}).catch(o=>{console.error("[Timeline] Failed to load TimelinePanel:",o),s.innerHTML='<div class="gm-loading-placeholder gm-text-center">Failed to load Timeline</div>'}))}if(e==="team-analysis"){const s=document.getElementById("team-analysis-container"),a=s?.querySelector(".team-analysis-panel");s&&!a?(console.log("[TeamAnalysis] Loading TeamAnalysis component..."),xe(async()=>{const{createTeamAnalysis:o}=await import("./TeamAnalysis-TQHHOzIo.js");return{createTeamAnalysis:o}},__vite__mapDeps([7,1])).then(({createTeamAnalysis:o})=>{s.innerHTML="";const i=o();s.appendChild(i),console.log("[TeamAnalysis] TeamAnalysis loaded successfully"),_p()}).catch(o=>{console.error("[TeamAnalysis] Failed to load TeamAnalysis:",o),s.innerHTML='<div class="gm-loading-placeholder gm-text-center">Failed to load Team Analysis</div>'})):_p()}})}function _p(){xe(async()=>{const{teamAnalysisStore:e}=await Promise.resolve().then(()=>DA);return{teamAnalysisStore:e}},void 0).then(({teamAnalysisStore:e})=>{document.querySelectorAll("#team-analysis-subtabs .subtab").forEach(t=>{const n=t.cloneNode(!0);t.parentNode?.replaceChild(n,t),n.addEventListener("click",s=>{const a=s.target.dataset.subtab;a&&(console.log("[TeamAnalysis] Switching to subtab:",a),document.querySelectorAll("#team-analysis-subtabs .subtab").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-subtab")===a)}),e.setSubtab(a))})})})}async function hd(){const e=document.getElementById("project-selector");if(e)try{const t=await ks.getAll();e.innerHTML='<option value="">Select Project...</option>',t.forEach(a=>{const o=document.createElement("option");o.value=a.id,o.textContent=a.name+(a.isDefault?" (default)":""),e.appendChild(o)});const n=N.getState().currentProjectId,s=document.getElementById("edit-project-btn");if(n)e.value=n,s&&s.classList.remove("hidden");else if(t.length>0){const a=t.find(o=>o.isDefault)||t[0];e.value=a.id,N.setCurrentProject(a),N.setCurrentProjectId(a.id),s&&s.classList.remove("hidden")}else s&&s.classList.add("hidden")}catch(t){console.warn("Projects not available:",t)}}function dr(){ce.setQuestions([]),ce.setRisks([]),ce.setActions([]),ce.setDecisions([]),ce.setFacts([]),ce.setContacts([]),ce.clearChatHistory(),uf.reset(),Es.destroyAll();try{localStorage.removeItem("copilot_session")}catch{}if(typeof window<"u"&&(window.location.hash||window.location.search)){const e=window.location.pathname||"/app";window.history.replaceState(null,"",e)}}async function VA(e){try{dr();const t=await ks.activate(e);t&&(m.success(`Switched to: ${t.name}`),await ns())}catch{m.error("Failed to load project")}}async function ns(){try{await hd();let e=N.getState().currentProject,t=N.getState().currentProjectId;if(!e&&!t){const r=document.getElementById("project-selector");if(r?.value)try{const c=await ks.activate(r.value);c&&(N.setCurrentProject(c),N.setCurrentProjectId(c.id),e=c,t=c.id)}catch{}}if(!e&&!t){console.log("üì≠ No project selected - showing empty state"),Fe("dashboard"),dr(),await wl(),hs(Ie.getState().sotCurrentView);return}const[n,s,a,o,i]=await Promise.all([v.get("/api/questions").catch(()=>({data:{questions:[]}})),v.get("/api/risks").catch(()=>({data:{risks:[]}})),v.get("/api/actions").catch(()=>({data:{actions:[]}})),v.get("/api/decisions").catch(()=>({data:{decisions:[]}})),v.get("/api/contacts").catch(()=>({data:{contacts:[]}}))]);ce.setQuestions(n.data.questions||[]),ce.setRisks(s.data.risks||[]),ce.setActions(a.data.actions||[]),ce.setDecisions(o.data.decisions||[]),ce.setContacts(i.data.contacts||[]),await wl(),hs(Ie.getState().sotCurrentView)}catch{console.error("Failed to refresh data")}}function GA(){const e=document.getElementById("dashboard-stats"),t=document.getElementById("dashboard-content");if(!e)return;const n=N.getState().currentProject,s=N.getState().currentProjectId;if(!n&&!s){e.innerHTML=`
      <div class="no-project-message gm-grid-col-all gm-empty-state gm-p-6">
        <svg class="gm-empty-state-icon" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        <h3 class="gm-empty-state-title gm-text-lg">No Project Selected</h3>
        <p class="gm-empty-state-desc">
          Select an existing project from the dropdown above or create a new one to start managing your data.
        </p>
        <button id="create-project-cta" class="btn btn-primary gm-empty-state-cta">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create New Project
        </button>
      </div>
    `,t&&t.classList.add("gm-none");const i=document.getElementById("create-project-cta");i&&i.addEventListener("click",()=>{window.__godmodeProjectsOpen="create",Fe("projects")});return}t&&t.classList.remove("gm-none");const a=ce.getState(),o=a.questions.filter(i=>i.status!=="dismissed"&&i.status!=="resolved"&&i.status!=="answered");e.innerHTML=`
    <div class="stat-card">
      <div class="stat-value">${o.length}</div>
      <div class="stat-label">Questions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${a.risks.length}</div>
      <div class="stat-label">Risks</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${a.actions.length}</div>
      <div class="stat-label">Actions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${a.decisions.length}</div>
      <div class="stat-label">Decisions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${a.contacts.length}</div>
      <div class="stat-label">Contacts</div>
    </div>
  `}function hs(e){const t=document.getElementById("sot-content");if(t)switch(ce.getState(),e){case"questions":t.innerHTML="";const n=zl({useDetailView:!0,containerElement:t});t.appendChild(n);return;case"facts":t.innerHTML="";const s=ja({useDetailView:!0,containerElement:t});t.appendChild(s);return;case"decisions":t.innerHTML="";const a=No({useDetailView:!0,containerElement:t});t.appendChild(a);return;case"risks":t.innerHTML="";const o=Io({useDetailView:!0,containerElement:t});t.appendChild(o);return;case"actions":t.innerHTML="";const i=Bo({useDetailView:!0,containerElement:t});t.appendChild(i);return;default:t.innerHTML='<p class="text-muted">Select a view</p>';return}}function kl(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const jn=[];function ur(){const e=document.getElementById("pending-count"),t=document.getElementById("pending-files-list");e&&(e.textContent=`${jn.length} file${jn.length!==1?"s":""}`),t&&(jn.length===0?t.innerHTML='<div class="empty-hint">No files pending</div>':(t.innerHTML=jn.map((n,s)=>`
        <div class="pending-file-item" data-index="${s}">
          <div class="pending-file-info">
            <div class="pending-file-name" title="${kl(n.name)}">${kl(n.name)}</div>
            <div class="pending-file-size">${ZA(n.size)}</div>
          </div>
          <button class="pending-file-remove" data-index="${s}" title="Remove">√ó</button>
        </div>
      `).join(""),t.querySelectorAll(".pending-file-remove").forEach(n=>{n.addEventListener("click",s=>{s.stopPropagation();const a=parseInt(n.dataset.index||"0");jn.splice(a,1),ur()})})))}function ZA(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function WA(e){Array.from(e).forEach(t=>{jn.some(n=>n.name===t.name&&n.size===t.size)||jn.push(t)}),ur()}function KA(){const e=document.getElementById("process-files-btn");e&&e.addEventListener("click",async()=>{if(jn.length===0){m.warning("No files to process. Add files first.");return}e.setAttribute("disabled","true"),e.innerHTML='<span class="btn-icon">‚è≥</span> Processing...';try{const c=await Cs.upload(jn);c.success&&(m.success(`Processed ${c.files.length} files successfully`),jn.length=0,ur(),ns())}catch(c){m.error("Failed to process files"),console.error("Process error:",c)}finally{e.removeAttribute("disabled"),e.innerHTML='<span class="btn-icon">‚ö°</span> Process Files'}});const t=document.getElementById("export-knowledge-btn");t&&t.addEventListener("click",async()=>{try{const c=ce.getState(),l={facts:c.facts||[],decisions:c.decisions||[],exportedAt:new Date().toISOString()},u=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),p=URL.createObjectURL(u),g=document.createElement("a");g.href=p,g.download="godmode-knowledge-export.json",g.click(),URL.revokeObjectURL(p),m.success("Knowledge exported")}catch{m.error("Export failed")}});const n=document.getElementById("export-knowledge-clipboard");n&&n.addEventListener("click",async()=>{try{const c=ce.getState(),l={facts:c.facts||[],decisions:c.decisions||[]};await navigator.clipboard.writeText(JSON.stringify(l,null,2)),m.success("Copied to clipboard")}catch{m.error("Copy failed")}});const s=document.getElementById("export-questions-btn");s&&s.addEventListener("click",async()=>{try{const l=ce.getState().questions||[],u=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),p=URL.createObjectURL(u),g=document.createElement("a");g.href=p,g.download="godmode-questions-export.json",g.click(),URL.revokeObjectURL(p),m.success("Questions exported")}catch{m.error("Export failed")}});const a=document.getElementById("export-questions-clipboard");a&&a.addEventListener("click",async()=>{try{const l=ce.getState().questions||[];await navigator.clipboard.writeText(JSON.stringify(l,null,2)),m.success("Copied to clipboard")}catch{m.error("Copy failed")}});const o=document.getElementById("copy-overdue-btn");o&&o.addEventListener("click",async()=>{try{const c=ce.getState(),l=new Date,u=(c.actions||[]).filter(f=>{if(f.status==="completed")return!1;const h=f.dueDate;return h?new Date(h)<l:!1}),p=(c.questions||[]).filter(f=>{if(f.status==="resolved")return!1;const h=f.created_at||f.createdAt;if(!h)return!1;const k=new Date(h),C=new Date(l.getTime()-10080*60*1e3);return k<C}),g={actions:u,questions:p,exportedAt:l.toISOString()};await navigator.clipboard.writeText(JSON.stringify(g,null,2)),m.success(`Copied ${u.length} actions and ${p.length} questions`)}catch{m.error("Copy failed")}});const i=document.getElementById("clean-orphan-btn");i&&i.addEventListener("click",async()=>{if(await xs("This will remove orphaned data entries that are not linked to any documents. Continue?",{title:"Clean Orphan Data",confirmText:"Clean",confirmClass:"btn-warning"}))try{const l=await v.post("/api/cleanup/orphans");m.success("Orphan data cleaned"),ns()}catch{m.error("Cleanup failed")}});const r=document.getElementById("reset-data-btn");r&&r.addEventListener("click",async()=>{if(await xs("This will clear all knowledge data (facts, decisions, questions, risks, actions, documents, etc.) for the current project. Team, contacts, and cost data will be kept. Continue?",{title:"Reset Project Data",confirmText:"Reset Knowledge Data",confirmClass:"btn-danger"}))try{await v.post("/api/reset"),m.success("Project data reset; team, contacts and cost preserved."),ns()}catch{m.error("Reset failed")}}),ur()}async function Lp(){if(console.log("üöÄ GodMode Frontend initializing..."),zA(),console.log("üîó Legacy bridge initialized"),BA(),console.log("üì° API client configured"),await QA(),console.log("üîê Auth initialized"),console.log(`üìé Theme: ${tt.getMode()} (effective: ${tt.getEffective()})`),HA(),console.log("‚å®Ô∏è Keyboard shortcuts registered"),Og({onResultClick:t=>{console.log("Search result clicked:",t),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:t}))}}),console.log("üîç Global search initialized"),window.addEventListener("godmode:projects-changed",()=>{hd()}),window.addEventListener("godmode:navigate",async t=>{const n=t.detail;if(!n||n.tab!=="files"||!n.documentId)return;Fe("files"),await new Promise(a=>setTimeout(a,400));const s=await Cs.get(n.documentId);if(s){const{showDocumentPreviewModal:a}=await xe(async()=>{const{showDocumentPreviewModal:o}=await import("./DocumentPreviewModal-hKXOUBAt.js");return{showDocumentPreviewModal:o}},__vite__mapDeps([2,1]));a({document:s})}}),RA(),console.log("üé® UI initialized"),UA(),console.log("üîÄ Client-side routing initialized"),Nt.isAuthenticated())ns(),console.log("üìä Data loading started");else if(N.getState().authConfigured){console.log("üîê Authentication required - redirecting to landing page"),window.location.href="/";return}else console.log("üìä Guest mode - loading data"),ns();const e=document.getElementById("app-loading");e&&(e.classList.add("fade-out"),setTimeout(()=>e.classList.add("hidden"),300)),console.log("‚úÖ GodMode Frontend ready"),console.log(`üì¶ Version: ${window.godmode.version}`),console.log("üí° Press ? for keyboard shortcuts")}async function QA(){await Nt.init(),Hi(),Nt.onAuthRequired(()=>{Kl({required:!0,onSuccess:()=>{Hi(),ns(),m.success("Session restored! Refreshing data...")}})}),window.addEventListener("godmode:auth-success",()=>{Hi(),ns()})}function Hi(){const e=Nt.getCurrentUser(),t=document.getElementById("user-avatar"),n=document.getElementById("user-dropdown"),s=document.getElementById("login-btn"),a=document.getElementById("auth-blocker-overlay");a&&e&&a.remove();const o=document.getElementById("nav-admin-btn");if(e){if(t){const i=e.name||e.email.split("@")[0]||"User",r=(e.name?.[0]||e.email[0]).toUpperCase(),c=`https://ui-avatars.com/api/?name=${encodeURIComponent(i)}&background=e11d48&color=fff&size=80&font-size=0.4&bold=true`,l=e.avatar||c;t.innerHTML=`<img src="${l}" alt="${kl(r)}" class="gm-avatar-img" onerror="this.classList.add('gm-none');this.parentElement.textContent=this.alt">`,t.title=e.name||e.email,t.classList.remove("hidden")}if(s&&s.classList.add("hidden"),n){const i=n.querySelector(".user-name"),r=n.querySelector(".user-email");i&&(i.textContent=e.name||"User"),r&&(r.textContent=e.email)}o&&(e.role==="superadmin"?(o.classList.remove("hidden"),console.log("üîë Admin nav enabled for superadmin:",e.email)):o.classList.add("hidden"))}else t&&t.classList.add("hidden"),s&&s.classList.remove("hidden"),o&&o.classList.add("hidden")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Lp):Lp();Object.assign(window.godmode,{components:PA});export{sM as A,lM as B,dM as C,eM as D,XA as E,YA as F,tM as G,rM as H,cM as I,aM as J,xe as _,Ce as a,at as b,Ts as c,b as d,$l as e,Ji as f,Xi as g,v as h,N as i,tt as j,SL as k,_L as l,Cl as m,uf as n,d as o,ks as p,K as q,Pe as r,Ui as s,m as t,De as u,oM as v,Qs as w,nM as x,iM as y,kw as z};
//# sourceMappingURL=main-BEBbDhZA.js.map
