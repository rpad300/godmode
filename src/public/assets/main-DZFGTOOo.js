const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/KrispManager-Ch5caStR.js","assets/modulepreload-polyfill-B5Qt9EMX.js","assets/DocumentPreviewModal-bm1HEf5x.js","assets/TranscriptComposer-2LIkQTLj.js","assets/GraphExplorer-S4ugv9np.js","assets/TeamAnalysis-BKtZPBFt.js","assets/teamAnalysis-b6DZM1KK.js"])))=>i.map(i=>d[i]);
import"./modulepreload-polyfill-B5Qt9EMX.js";const Cp="modulepreload",Lp=function(e){return"/"+e},Lr={},Y=function(t,n,a){let s=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(m=>Promise.resolve(m).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),r=i?.nonce||i?.getAttribute("nonce");s=c(n.map(l=>{if(l=Lp(l),l in Lr)return;Lr[l]=!0;const m=l.endsWith(".css"),v=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${v}`))return;const g=document.createElement("link");if(g.rel=m?"stylesheet":Cp,m||(g.as="script"),g.crossOrigin="",g.href=l,r&&g.setAttribute("nonce",r),document.head.appendChild(g),m)return new Promise((f,b)=>{g.addEventListener("load",f),g.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return s.then(i=>{for(const r of i||[])r.status==="rejected"&&o(r.reason);return t().catch(o)})};class Mp{mode;listeners=new Set;mediaQuery;constructor(){this.mode=this.getSavedTheme(),this.mediaQuery=window.matchMedia("(prefers-color-scheme: light)"),this.apply(),this.watchSystemChanges()}getSavedTheme(){const t=localStorage.getItem("theme");return t==="light"||t==="dark"||t==="system"?t:"system"}getSystemTheme(){return this.mediaQuery.matches?"light":"dark"}watchSystemChanges(){this.mediaQuery.addEventListener("change",()=>{this.mode==="system"&&this.apply()})}getEffective(){return this.mode==="system"?this.getSystemTheme():this.mode}getMode(){return this.mode}apply(){const t=this.getEffective();document.documentElement.setAttribute("data-theme",t),this.listeners.forEach(n=>n(t))}set(t){this.mode=t,localStorage.setItem("theme",t),this.apply()}cycle(){const t=["light","dark","system"],a=(t.indexOf(this.mode)+1)%t.length;return this.set(t[a]),this.mode}toggle(){const n=this.getEffective()==="dark"?"light":"dark";return this.set(n),n}onChange(t){return this.listeners.add(t),()=>this.listeners.delete(t)}getIcon(){switch(this.mode){case"light":return"‚òÄÔ∏è";case"dark":return"üåô";case"system":return"üíª"}}getLabel(){switch(this.mode){case"light":return"Light";case"dark":return"Dark";case"system":return"System"}}}const Ae=new Mp,qp={duration:3e3,position:"bottom-right"},Tp={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--accent)"};function ys(e,t="success",n={}){const a={...qp,...n},s=document.createElement("div");s.className="toast fade-in",s.style.cssText=`
    position: fixed;
    ${a.position?.includes("bottom")?"bottom":"top"}: 20px;
    ${a.position?.includes("right")?"right":"left"}: 20px;
    background: ${Tp[t]};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    word-wrap: break-word;
  `,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.transition="opacity 0.3s",setTimeout(()=>s.remove(),300)},a.duration)}function Ap(e,t){ys(e,"success",t)}function Ep(e,t){ys(e,"error",t)}function _p(e,t){ys(e,"warning",t)}function jp(e,t){ys(e,"info",t)}const u={show:ys,success:Ap,error:Ep,warning:_p,info:jp},Qe={baseUrl:"",defaultHeaders:{"Content-Type":"application/json"},showErrorToasts:!0,timeout:3e4,retryCount:2,retryDelay:1e3},js=[],Dp=[];function Pp(e){return js.push(e),()=>{const t=js.indexOf(e);t>-1&&js.splice(t,1)}}async function Rt(e,t={},n=0){const a=`${Qe.baseUrl}${e}`;let s={...t,headers:{...Qe.defaultHeaders,...t.headers}};for(const l of js)s=await l(s);const i=s.timeout??Qe.timeout;delete s.timeout;const r=new AbortController,c=setTimeout(()=>r.abort(),i);try{const l=await fetch(a,{...s,signal:r.signal,credentials:"include"});clearTimeout(c);let m;if(l.headers.get("content-type")?.includes("application/json")?m=await l.json():m=await l.text(),!l.ok){switch(l.status){case 401:Qe.onUnauthorized&&Qe.onUnauthorized();break;case 403:Qe.onForbidden&&Qe.onForbidden();break;case 429:if(n<3){const b=parseInt(l.headers.get("Retry-After")||"5",10);return await Co(b*1e3),Rt(e,t,n+1)}break;case 503:case 504:if(n<Qe.retryCount)return await Co(Qe.retryDelay*Math.pow(2,n)),Rt(e,t,n+1);break}const f=Hp(m,l.statusText);throw Qe.showErrorToasts&&u.error(f),new ks(f,l.status,m)}let g={data:m,ok:!0,status:l.status,statusText:l.statusText};for(const f of Dp)g=await f(g);return g}catch(l){if(clearTimeout(c),l instanceof ks)throw l;if(l instanceof DOMException&&l.name==="AbortError"){const v="Request timed out";throw Qe.showErrorToasts&&u.error(v),new ks(v,0)}if(n<Qe.retryCount)return await Co(Qe.retryDelay*Math.pow(2,n)),Rt(e,t,n+1);const m=l instanceof Error?l.message:"Network error";throw Qe.showErrorToasts&&u.error(`Connection error: ${m}`),new ks(m,0)}}function Hp(e,t){if(typeof e=="object"&&e!==null){const n=e;return String(n.error||n.message||n.detail||t)}return t||"Request failed"}function Co(e){return new Promise(t=>setTimeout(t,e))}class ks extends Error{status;details;constructor(t,n,a){super(t),this.name="ApiError",this.status=n,this.details=a}}const p={get:(e,t)=>Rt(e,{...t,method:"GET"}),post:(e,t,n)=>Rt(e,{...n,method:"POST",body:t?JSON.stringify(t):void 0}),put:(e,t,n)=>Rt(e,{...n,method:"PUT",body:t?JSON.stringify(t):void 0}),patch:(e,t,n)=>Rt(e,{...n,method:"PATCH",body:t?JSON.stringify(t):void 0}),delete:(e,t)=>Rt(e,{...t,method:"DELETE"})};function Jc(e){Object.assign(Qe,e)}function zp(e,t){try{const n=localStorage.getItem(e);return n===null?t:JSON.parse(n)}catch{return t}}function Bp(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch{}}function Ip(e){try{localStorage.removeItem(e)}catch{}}function Rp(){try{localStorage.clear()}catch{}}function Np(e){try{return localStorage.getItem(e)!==null}catch{return!1}}function Fp(){try{return Object.keys(localStorage)}catch{return[]}}const Xe={get:zp,set:Bp,remove:Ip,clear:Rp,has:Np,keys:Fp};class Op{shortcuts=new Map;enabled=!0;isMac=typeof navigator<"u"&&/Mac|iPod|iPhone|iPad/.test(navigator.platform);constructor(){this.handleKeydown=this.handleKeydown.bind(this),document.addEventListener("keydown",this.handleKeydown)}parseShortcut(t,n,a=""){const s=t.toLowerCase().split("+"),o=s.pop()||t;return{key:o,ctrl:s.includes("ctrl")||s.includes("mod")&&!this.isMac,shift:s.includes("shift"),alt:s.includes("alt"),meta:s.includes("meta")||s.includes("mod")&&this.isMac,description:a,handler:()=>{const r=new KeyboardEvent("keydown",{key:o});n(r)}}}getShortcutKey(t){const n=[];return t.ctrl&&n.push("ctrl"),t.shift&&n.push("shift"),t.alt&&n.push("alt"),t.meta&&n.push("meta"),t.key&&n.push(t.key.toLowerCase()),n.join("+")}handleKeydown(t){if(!this.enabled)return;const n=t.target;if((n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.isContentEditable)&&t.key!=="Escape")return;const a=this.getShortcutKey({key:t.key,ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey}),s=this.shortcuts.get(a);s&&(t.preventDefault(),s.handler())}register(t,n,a){let s;if(typeof t=="string"){if(!n)throw new Error("Handler is required when using string shortcut format");s=this.parseShortcut(t,n,a||"")}else s=t;const o=this.getShortcutKey(s);return this.shortcuts.set(o,s),()=>this.shortcuts.delete(o)}unregister(t){const n=this.getShortcutKey(t);this.shortcuts.delete(n)}setEnabled(t){this.enabled=t}getAll(){return Array.from(this.shortcuts.values())}showHelp(){const t=this.getAll();console.log("Keyboard Shortcuts:"),t.forEach(n=>{const a=[];n.ctrl&&a.push("Ctrl"),n.shift&&a.push("Shift"),n.alt&&a.push("Alt"),n.meta&&a.push("Cmd"),a.push(n.key.toUpperCase()),console.log(`  ${a.join("+")} - ${n.description}`)})}destroy(){document.removeEventListener("keydown",this.handleKeydown),this.shortcuts.clear()}}const Ct=new Op;class Up{undoStack=[];redoStack=[];maxSize=50;listeners=new Set;push(t){this.undoStack.push({...t,timestamp:Date.now()}),this.redoStack=[],this.undoStack.length>this.maxSize&&this.undoStack.shift(),this.notify()}async undo(){const t=this.undoStack.pop();if(!t)return!1;try{return await t.undo(),this.redoStack.push(t),this.notify(),!0}catch(n){return console.error("Undo failed:",n),this.undoStack.push(t),!1}}async redo(){const t=this.redoStack.pop();if(!t||!t.redo)return!1;try{return await t.redo(),this.undoStack.push(t),this.notify(),!0}catch(n){return console.error("Redo failed:",n),this.redoStack.push(t),!1}}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getUndoDescription(){return this.undoStack[this.undoStack.length-1]?.description??null}getRedoDescription(){return this.redoStack[this.redoStack.length-1]?.description??null}clear(){this.undoStack=[],this.redoStack=[],this.notify()}onChange(t){return this.listeners.add(t),()=>this.listeners.delete(t)}notify(){this.listeners.forEach(t=>t())}getState(){return{undoCount:this.undoStack.length,redoCount:this.redoStack.length}}}const wt=new Up;function Zc(e){return typeof e=="string"&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}const Jo=Xe.get("currentProjectId",null),Ds=Xe.get("currentProject",null),Xc=Zc(Jo)?Jo:null,el=Ds&&Zc(Ds.id)?Ds:null;!Xc&&Jo&&Xe.remove("currentProjectId");!el&&Ds&&Xe.remove("currentProject");const tl={currentProjectId:Xc,currentProject:el,currentUser:null,authConfigured:!1,config:{},isLoading:!1,error:null,isOnline:navigator.onLine,version:"1.0.0"};let Me={...tl};const Zo=new Set;function pn(){Zo.forEach(e=>e(Me))}function Vp(){return Me}function Gp(e){return Zo.add(e),()=>Zo.delete(e)}function Qp(e){Me={...Me,currentProjectId:e},e?Xe.set("currentProjectId",e):(Xe.remove("currentProjectId"),Xe.remove("currentProject"),Me={...Me,currentProject:null}),pn()}function Kp(e){Me={...Me,currentProject:e,currentProjectId:e?.id||null},e?(Xe.set("currentProject",e),Xe.set("currentProjectId",e.id)):(Xe.remove("currentProject"),Xe.remove("currentProjectId")),pn()}function Wp(e){Me={...Me,currentUser:e},pn()}function Yp(e){Me={...Me,authConfigured:e},pn()}function Jp(e){Me={...Me,config:{...Me.config,...e}},pn()}function Zp(e){Me={...Me,isLoading:e},pn()}function Xp(e){Me={...Me,error:e},pn()}function Xo(e){Me={...Me,isOnline:e},pn()}function eu(){Me={...tl},pn()}function tu(){window.addEventListener("online",()=>Xo(!0)),window.addEventListener("offline",()=>Xo(!1))}const P={getState:Vp,subscribe:Gp,setCurrentProject:Kp,setCurrentProjectId:Qp,setCurrentUser:Wp,setAuthConfigured:Yp,setConfig:Jp,setLoading:Zp,setError:Xp,setOnline:Xo,reset:eu,init:tu};let Ps=!1,Ta=null;async function nl(){try{const e=await p.get("/api/auth/status"),t=e.data.configured;return P.setAuthConfigured(t),e.data}catch{return P.setAuthConfigured(!1),{configured:!1}}}async function al(){try{const e=await p.get("/api/auth/me");if(e.data.authenticated&&e.data.user){const t=e.data.user,n=go(t);return P.setCurrentUser(n),n}return P.setCurrentUser(null),null}catch{return P.setCurrentUser(null),null}}async function nu(){return Ta||(Ta=(async()=>{try{if(!(await nl()).configured)return Ps=!0,!1;const t=await al();return Ps=!0,t?!0:(P.setCurrentUser(null),console.log("üîê Supabase configured but no valid session - login required"),!1)}catch{return P.setCurrentUser(null),Ps=!0,!1}finally{Ta=null}})(),Ta)}async function au(e){const t=await p.post("/api/auth/login",e);if(!t.data.success)throw new Error("Login failed");const n=go(t.data.user);return P.setCurrentUser(n),n}async function su(e){if(e.password.length<12)throw new Error("Password must be at least 12 characters");if(e.username&&e.username.length<3)throw new Error("Username must be at least 3 characters");if(e.username&&!/^[a-zA-Z0-9_]+$/.test(e.username))throw new Error("Username can only contain letters, numbers, and underscores");const t=await p.post("/api/auth/register",e);if(!t.data.success)throw new Error("Registration failed");const n=go(t.data.user);return t.data.needsEmailVerification||P.setCurrentUser(n),{user:n,needsEmailVerification:t.data.needsEmailVerification}}async function ou(){try{await p.post("/api/auth/logout")}catch{}P.setCurrentUser(null),P.setCurrentProject(null)}async function iu(e){await p.post("/api/auth/forgot-password",{email:e})}async function ru(e,t){if(e.length<12)throw new Error("Password must be at least 12 characters");if(!(await p.post("/api/auth/reset-password",{password:e,access_token:t})).data.success)throw new Error("Password reset failed")}async function cu(){try{return(await p.post("/api/auth/refresh")).data.success}catch{return!1}}async function lu(e){return(await p.post("/api/auth/otp/request",{email:e})).data}async function du(e,t){const n=await p.post("/api/auth/otp/verify",{email:e,code:t});if(!n.data.success){const s=new Error(n.data.error||"Verification failed");throw s.attemptsRemaining=n.data.attemptsRemaining,s.needsEmailVerification=n.data.needsEmailVerification,s.fallbackToPassword=n.data.fallbackToPassword,s}if(n.data.redirectTo)throw window.location.href=n.data.redirectTo,new Error("Redirecting...");if(!n.data.user)throw new Error("Login completed but no user data received");const a=go(n.data.user);return P.setCurrentUser(a),a}async function pu(){try{return(await p.get("/api/auth/otp/config")).data}catch{return{codeLength:6,expirationMinutes:10,resendCooldownSeconds:60}}}async function uu(e,t){const n=await p.post("/api/auth/confirm-email",{email:e,code:t});if(!n.data.success)throw new Error(n.data.error||"Confirmation failed")}async function mu(e){const t=await p.post("/api/auth/resend-confirmation",{email:e});if(!t.data.success){const n=new Error(t.data.error||"Failed to resend confirmation");throw n.retryAfter=t.data.retryAfter,n}return{expiresInMinutes:t.data.expiresInMinutes}}function go(e){const t=e.profile,n=e.user_metadata||{};return{id:e.id,email:e.email,name:t?.display_name||n.display_name||n.username||e.email.split("@")[0],avatar:t?.avatar_url,role:t?.role==="superadmin"?"superadmin":t?.role==="admin"?"admin":"member"}}function gu(){return P.getState().currentUser!==null}function vu(){return Ps}function fu(){return P.getState().currentUser}function hu(e){const t=()=>e();return window.addEventListener("godmode:auth-required",t),()=>window.removeEventListener("godmode:auth-required",t)}function bu(){window.dispatchEvent(new CustomEvent("godmode:auth-required"))}const tt={checkStatus:nl,checkSession:al,init:nu,login:au,register:su,logout:ou,forgotPassword:iu,resetPassword:ru,refreshSession:cu,isAuthenticated:gu,isInitialized:vu,getCurrentUser:fu,onAuthRequired:hu,triggerAuthRequired:bu,requestLoginCode:lu,verifyLoginCode:du,getOTPConfig:pu,confirmEmail:uu,resendConfirmation:mu},sl={questions:[],risks:[],actions:[],decisions:[],facts:[],contacts:[],chatHistory:[],projects:[],lastUpdated:{}};let ue={...sl};const ei=new Set;function At(){ei.forEach(e=>e(ue))}function yu(){return ue}function xu(e){return ei.add(e),()=>ei.delete(e)}function wu(e){ue={...ue,questions:e,lastUpdated:{...ue.lastUpdated,questions:Date.now()}},At()}function ku(e){ue={...ue,risks:e,lastUpdated:{...ue.lastUpdated,risks:Date.now()}},At()}function $u(e){ue={...ue,actions:e,lastUpdated:{...ue.lastUpdated,actions:Date.now()}},At()}function Su(e){ue={...ue,decisions:e,lastUpdated:{...ue.lastUpdated,decisions:Date.now()}},At()}function Cu(e){ue={...ue,facts:e,lastUpdated:{...ue.lastUpdated,facts:Date.now()}},At()}function Lu(e){ue={...ue,contacts:e,lastUpdated:{...ue.lastUpdated,contacts:Date.now()}},At()}function Mu(e){ue={...ue,chatHistory:e},At()}function qu(e){ue={...ue,chatHistory:[...ue.chatHistory,e]},At()}function Tu(e){ue={...ue,projects:e,lastUpdated:{...ue.lastUpdated,projects:Date.now()}},At()}function Au(){ue={...ue,chatHistory:[]},At()}function Eu(){ue={...sl},At()}const B={getState:yu,subscribe:xu,setQuestions:wu,setRisks:ku,setActions:$u,setDecisions:Su,setFacts:Cu,setContacts:Lu,setChatHistory:Mu,addChatMessage:qu,setProjects:Tu,clearChatHistory:Au,reset:Eu};async function Gn(){try{const t=(await p.get("/api/projects")).data.projects||[];return B.setProjects(t),t}catch{return[]}}async function Ui(){try{const t=(await p.get("/api/projects/current")).data.project;return t?(P.setCurrentProject(t),t):null}catch{return null}}async function _u(e){const n={id:(await p.post("/api/projects",e)).data.id,name:e.name,description:e.description};return await Gn(),n}async function ju(e,t){await p.put(`/api/projects/${e}`,t);const n=P.getState().currentProject;n?.id===e&&P.setCurrentProject({...n,...t}),await Gn()}async function Du(e){await p.delete(`/api/projects/${e}`),P.getState().currentProjectId===e&&P.setCurrentProject(null),await Gn()}async function ol(e){try{return await p.put(`/api/projects/${e}/activate`),await Ui()}catch{return null}}async function Pu(e){await p.post(`/api/projects/${e}/set-default`),await Gn()}async function Hu(e){try{return(await p.get(`/api/projects/${e}/stats`)).data.stats||{}}catch{return{}}}async function zu(e){const t=await fetch(`/api/projects/${e}/export`);if(!t.ok)throw new Error("Failed to export project");return t.blob()}async function Bu(e){const t=new FormData;t.append("file",e);const n=await fetch("/api/projects/import",{method:"POST",body:t});if(!n.ok){const s=await n.json().catch(()=>({error:"Import failed"}));throw new Error(s.error||"Import failed")}const a=await n.json();return await Gn(),a.project}async function Iu(){if(await Gn(),!await Ui()){const t=B.getState().projects;if(t.length>0){const n=t.find(a=>a.isDefault)||t[0];await ol(n.id)}}}const Cn={getAll:Gn,getCurrent:Ui,create:_u,update:ju,delete:Du,activate:ol,setDefault:Pu,getStats:Hu,export:zu,import:Bu,init:Iu};async function il(){try{return(await p.get("/api/dashboard")).data}catch{return null}}async function Ru(){try{return(await p.get("/api/stats")).data}catch{return null}}async function Nu(e=7){try{return(await p.get(`/api/trends?days=${e}`)).data}catch{return null}}async function rl(){try{return(await p.get("/api/sot/health")).data}catch{return null}}async function cl(){try{return(await p.get("/api/sot/insights")).data.insights||[]}catch{return[]}}async function ll(){try{return(await p.get("/api/sot/alerts")).data.alerts||[]}catch{return[]}}async function Fu(){const[e,t,n,a]=await Promise.all([il(),rl(),cl(),ll()]);return{dashboard:e,health:t,insights:n,alerts:a}}const Vi={getDashboard:il,getStats:Ru,getTrends:Nu,getHealth:rl,getInsights:cl,getAlerts:ll,loadAll:Fu};async function Ou(e){try{const t=new URLSearchParams;e?.status&&t.set("status",e.status),e?.priority&&t.set("priority",e.priority);const n=t.toString(),a=n?`/api/questions?${n}`:"/api/questions";return(await p.get(a)).data.questions||[]}catch{return[]}}async function Uu(e){return(await p.post("/api/questions",e)).data}async function Vu(e,t){return(await p.put(`/api/questions/${e}`,t)).data.question}async function Gu(e,t){await p.delete(`/api/questions/${e}`,{body:JSON.stringify({reason:t})})}async function Qu(e,t){return(await p.post(`/api/questions/${e}/answer`,t)).data}async function Ku(){try{return(await p.get("/api/questions/by-person")).data.questionsByPerson||{}}catch{return{}}}async function Wu(){try{return(await p.get("/api/questions/by-team")).data.questionsByTeam||{}}catch{return{}}}async function Yu(e){const t=new URLSearchParams;return e.content&&t.set("content",e.content),e.id&&t.set("id",String(e.id)),e.useAI===!1&&t.set("ai","false"),e.refresh&&t.set("refresh","true"),(await p.get(`/api/questions/suggest-assignee?${t.toString()}`,{timeout:9e4})).data}async function Ju(e,t){return(await p.post(`/api/questions/${e}/reopen`,{reason:t})).data.question}async function Zu(e,t,n){return(await p.post(`/api/questions/${e}/dismiss`,{reason:t,details:n})).data.question}async function Xu(e,t,n){return(await p.post(`/api/questions/${e}/defer`,{until:typeof t=="string"?t:t.toISOString(),reason:n})).data.question}async function em(e,t,n){return(await p.post(`/api/questions/${e}/feedback`,{wasUseful:t,feedback:n})).data.question}function tm(e){const t=new Date,n=new Date(t.getTime()-10080*60*1e3);return{total:e.length,pending:e.filter(a=>a.status==="pending").length,assigned:e.filter(a=>a.status==="assigned").length,resolved:e.filter(a=>a.status==="resolved").length,critical:e.filter(a=>a.priority==="critical"&&a.status!=="resolved").length,overdue:e.filter(a=>a.status==="resolved"?!1:new Date(a.created_at)<n).length}}const we={getAll:Ou,create:Uu,update:Vu,delete:Gu,answer:Qu,getByPerson:Ku,getByTeam:Wu,suggestAssignee:Yu,reopen:Ju,getStats:tm,dismissQuestion:Zu,deferQuestion:Xu,submitAnswerFeedback:em};async function nm(e){try{const t=e?`/api/risks?status=${e}`:"/api/risks";return(await p.get(t)).data.risks||[]}catch{return[]}}async function am(e){try{return(await p.get(`/api/risks/${e}`)).data.risk??null}catch{return null}}async function sm(){try{return(await p.get("/api/risks/deleted")).data.risks||[]}catch{return[]}}async function om(e){return(await p.post(`/api/risks/${e}/restore`,{})).data.risk}async function im(e){try{return(await p.get(`/api/risks/${e}/events`)).data.events||[]}catch{return[]}}async function rm(){try{return(await p.get("/api/risks/by-category")).data.risksByCategory||{}}catch{return{}}}async function cm(e){const t=await p.post("/api/risks",e);return t.data.risk||{...e,id:t.data.id,status:"open",created_at:new Date().toISOString()}}async function lm(e,t){return(await p.put(`/api/risks/${e}`,t)).data.risk}async function dm(e){await p.delete(`/api/risks/${e}`)}function pm(e,t){const n={low:1,medium:2,high:3,critical:4},a={low:1,medium:2,high:3};return(n[e]||2)*(a[t]||2)}async function um(e){const t=await p.post("/api/risks/suggest",{content:e.content?.trim()||"",impact:e.impact||"medium",likelihood:e.likelihood??e.probability??"medium"});if(t.data.error)throw new Error(t.data.error);const n=Array.isArray(t.data.suggested_owners)?t.data.suggested_owners:[];return{suggested_owner:t.data.suggested_owner??n[0]?.name??"",suggested_mitigation:t.data.suggested_mitigation??"",suggested_owners:n}}function mm(e){const t={};return e.filter(n=>n.status!=="mitigated"&&n.status!=="closed").forEach(n=>{const a=(n.impact||"").toString().toLowerCase(),s=(n.likelihood||"").toString().toLowerCase(),o=`${a}-${s}`;t[o]||(t[o]=[]),t[o].push(n)}),t}const Ke={getAll:nm,get:am,getByCategory:rm,getDeleted:sm,restore:om,getEvents:im,suggest:um,create:cm,update:lm,delete:dm,calculateScore:pm,getMatrixData:mm};function Gi(e){return{...e,content:e.content??e.task,assignee:e.assignee??e.owner,due_date:e.due_date??e.deadline}}async function gm(e){try{const t=e?`/api/actions?status=${e}`:"/api/actions";return((await p.get(t)).data.actions||[]).map(Gi)}catch{return[]}}async function vm(e){const t={content:e.content,task:e.content,assignee:e.assignee,owner:e.assignee,due_date:e.due_date,deadline:e.due_date,status:e.status,priority:e.priority},n=await p.post("/api/actions",t),a=n.data.action||{...t,id:n.data.id,created_at:new Date().toISOString()};return Gi(a)}async function fm(e,t){const n={...t,task:t.content??t.task,owner:t.assignee??t.owner,deadline:t.due_date??t.deadline},s=(await p.put(`/api/actions/${e}`,n)).data.action;return s?Gi(s):{}}async function hm(e){await p.delete(`/api/actions/${e}`)}async function bm(e){try{const t=await p.post("/api/actions/suggest",{content:(e.content||"").trim()});return{suggested_assignees:Array.isArray(t.data.suggested_assignees)?t.data.suggested_assignees:[]}}catch{return{suggested_assignees:[]}}}async function ym(e){try{return(await p.get(`/api/actions/${e}/events`)).data.events||[]}catch{return[]}}function dl(e){return!e.due_date||e.status==="completed"||e.status==="cancelled"?!1:new Date(e.due_date)<new Date}function xm(e){return{total:e.length,pending:e.filter(t=>t.status==="pending").length,inProgress:e.filter(t=>t.status==="in_progress").length,completed:e.filter(t=>t.status==="completed").length,overdue:e.filter(t=>dl(t)).length}}const We={getAll:gm,create:vm,update:fm,delete:hm,getEvents:ym,suggest:bm,isOverdue:dl,getStats:xm};async function wm(e){try{const t=e?`/api/decisions?status=${e}`:"/api/decisions";return(await p.get(t)).data.decisions||[]}catch{return[]}}async function km(e){try{return(await p.get(`/api/decisions/${e}`)).data.decision}catch{return null}}async function $m(){try{return(await p.get("/api/decisions/deleted")).data.decisions||[]}catch{return[]}}async function Sm(e){return(await p.post(`/api/decisions/${e}/restore`,{})).data.decision}async function Cm(e){try{return(await p.get(`/api/decisions/${e}/events`)).data.events||[]}catch{return[]}}async function Lm(e,t=10){try{const n=new URLSearchParams;t!==10&&n.set("limit",String(t));const a=n.toString(),s=a?`/api/decisions/${e}/similar?${a}`:`/api/decisions/${e}/similar`;return(await p.get(s)).data.similar||[]}catch{return[]}}async function Mm(){return(await p.post("/api/decision-check/run",{})).data}async function qm(){try{return(await p.get("/api/conflicts/decisions")).data.conflicts||[]}catch{return[]}}async function Tm(e,t){return(await p.post("/api/decisions/suggest",{content:e.trim(),rationale:t?.trim()||""})).data}async function Am(e,t){return(await p.post("/api/decisions/suggest-owner",{content:e.trim(),rationale:t?.trim()||""})).data}async function Em(e){const t=await p.post("/api/decisions",e);return t.data.decision||{...e,id:t.data.id,status:e.status||"proposed",created_at:new Date().toISOString()}}async function Qi(e,t){return(await p.put(`/api/decisions/${e}`,t)).data.decision}async function _m(e){await p.delete(`/api/decisions/${e}`)}async function jm(e,t){return Qi(e,{status:"approved",approved_by:t,decided_at:new Date().toISOString()})}async function Dm(e,t){return Qi(e,{status:"rejected",rationale:t,decided_at:new Date().toISOString()})}const Le={getAll:wm,get:km,create:Em,update:Qi,delete:_m,approve:jm,reject:Dm,getDeletedDecisions:$m,restore:Sm,getEvents:Cm,getSimilarDecisions:Lm,runDecisionCheck:Mm,detectConflicts:qm,suggest:Tm,suggestOwner:Am};let ps=[];async function Pm(e){const t=await p.post("/api/chat",{message:e.message,context:e.context,history:e.history||ps.slice(-10).map(s=>({role:s.role,content:s.content})),semantic:e.semantic??!0,deepReasoning:e.deepReasoning??!1}),n={id:`msg-${Date.now()}-user`,role:"user",content:e.message,timestamp:new Date().toISOString()},a={id:`msg-${Date.now()}-assistant`,role:"assistant",content:t.data.response,timestamp:new Date().toISOString(),sources:t.data.sources,contextQuality:t.data.contextQuality};return ps.push(n,a),t.data}async function Hm(e){return(await p.post("/api/ask",e)).data}async function zm(e){return(await p.post("/api/sot/chat",e)).data}async function Bm(e=!1){const t=e?"/api/briefing?refresh=true":"/api/briefing";return(await p.get(t)).data}async function Im(e=30){return(await p.get(`/api/briefing/history?limit=${e}`)).data.history||[]}async function Rm(){const e=await p.get("/api/reports/weekly");return typeof e.data=="string"?e.data:""}async function Nm(){return(await p.post("/api/sot/executive-summary")).data.summary||""}function Fm(){return[...ps]}function Om(){ps=[]}function Um(e){ps.push(e)}const us={send:Pm,ask:Hm,sotChat:zm,getBriefing:Bm,getBriefingHistory:Im,getWeeklyReport:Rm,generateExecutiveSummary:Nm,getHistory:Fm,clearHistory:Om,addToHistory:Um};async function Vm(e){try{const t=new URLSearchParams;e?.organization&&t.set("organization",e.organization),e?.tag&&t.set("tag",e.tag),e?.search&&t.set("search",e.search);const n=t.toString(),a=n?`/api/contacts?${n}`:"/api/contacts",s=await p.get(a),i=(s.data.contacts||[]).map(r=>({...r,photoUrl:r.photo_url||r.avatar_url||r.photoUrl||r.avatarUrl,avatarUrl:r.avatar_url||r.photo_url||r.avatarUrl||r.photoUrl,isFavorite:r.is_favorite??r.isFavorite??!1,company:r.organization||r.company}));return{contacts:i,total:s.data.total||i.length}}catch(t){return console.error("[ContactsService] Failed to get contacts:",t),{contacts:[],total:0}}}async function pl(e){try{return(await p.get(`/api/contacts/${e}`)).data.contact}catch{return null}}async function Gm(e){const t=await p.post("/api/contacts",e);return{...e,id:t.data.id,created_at:new Date().toISOString()}}async function Qm(e,t){await p.put(`/api/contacts/${e}`,t)}async function Km(e){await p.delete(`/api/contacts/${e}`)}async function Wm(){return(await p.get("/api/contacts/stats")).data}async function Ym(e){try{const t=await p.get(`/api/contacts/find-by-name?name=${encodeURIComponent(e)}`);return t.data.found?t.data.contact:null}catch{return null}}async function Jm(){return(await p.get("/api/contacts/duplicates")).data}async function Mr(e){return(await p.post("/api/contacts/merge",{contactIds:e})).data.mergedId}async function Zm(e){return(await p.post(`/api/contacts/${e}/enrich`)).data.suggestions}async function Xm(e="json"){try{const t=await fetch(`/api/contacts/export?format=${e}`);if(!t.ok)throw new Error("Export failed");const n=await t.blob(),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=`contacts-export.${e}`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}catch(t){throw console.error("Export failed:",t),t}}async function eg(e){try{return(await p.get(`/api/contacts/${e}/associations`)).data.contact}catch{return pl(e)}}async function tg(e,t,n){await p.post(`/api/contacts/${e}/projects`,{projectId:t,...n})}async function ng(e,t){await p.delete(`/api/contacts/${e}/projects/${t}`)}async function ag(e){try{return(await p.get(`/api/contacts/${e}/projects`)).data.projects||[]}catch{return[]}}async function sg(){try{return(await p.get("/api/teams")).data.teams||[]}catch{return[]}}async function og(e){try{return(await p.get(`/api/teams/${e}`)).data}catch{return null}}async function ig(e){const t=await p.post("/api/teams",e);return{...e,id:t.data.id,created_at:new Date().toISOString()}}async function rg(e,t){await p.put(`/api/teams/${e}`,t)}async function cg(e){await p.delete(`/api/teams/${e}`)}async function lg(e,t,n,a=!1){await p.post(`/api/teams/${e}/members`,{contactId:t,role:n,isLead:a})}async function dg(e,t){await p.delete(`/api/teams/${e}/members/${t}`)}const ke={getAll:Vm,get:pl,create:Gm,update:Qm,delete:Km,getStats:Wm,findByName:Ym,getDuplicates:Jm,merge:Mr,mergeContacts:Mr,enrich:Zm,export:Xm,getWithAssociations:eg,addToProject:tg,removeFromProject:ng,getProjects:ag},ul={getAll:sg,get:og,create:ig,update:rg,delete:cg,addMember:lg,removeMember:dg};async function pg(e,t){const n=new FormData;e.forEach(s=>{n.append("files",s)});const a=new XMLHttpRequest;return new Promise((s,o)=>{a.upload.addEventListener("progress",i=>{i.lengthComputable&&t&&t(Math.round(i.loaded/i.total*100))}),a.addEventListener("load",()=>{if(a.status>=200&&a.status<300)try{s(JSON.parse(a.responseText))}catch{o(new Error("Invalid response"))}else o(new Error(`Upload failed: ${a.statusText}`))}),a.addEventListener("error",()=>{o(new Error("Upload failed"))}),a.open("POST","/api/upload"),a.send(n)})}async function ug(e){const t=new FormData;t.append("file",e);const n=await fetch("/api/upload-extract",{method:"POST",body:t});if(!n.ok)throw new Error("Upload failed");return n.json()}async function mg(){return(await p.get("/api/processing-status")).data}async function gg(e){try{const t=typeof e=="string"?{status:e}:e||{},n=new URLSearchParams;t.status&&t.status!=="all"&&n.set("status",t.status),t.type&&t.type!=="all"&&n.set("type",t.type),t.search&&n.set("search",t.search),t.sort&&n.set("sort",t.sort),t.order&&n.set("order",t.order),t.limit&&n.set("limit",String(t.limit)),t.offset&&n.set("offset",String(t.offset));const a=n.toString(),s=a?`/api/documents?${a}`:"/api/documents",o=await p.get(s);return{documents:o.data.documents||[],total:o.data.total||0,limit:o.data.limit,offset:o.data.offset,hasMore:o.data.hasMore,statuses:o.data.statuses||{processed:0,pending:0,failed:0,deleted:0}}}catch{return{documents:[],total:0,statuses:{processed:0,pending:0,failed:0,deleted:0}}}}async function vg(e){try{return(await p.get(`/api/documents/${e}`)).data.document}catch{return null}}async function fg(e,t){const n=t?.softDelete?"?soft=true":"";await p.delete(`/api/documents/${e}${n}`)}async function hg(e){await p.post(`/api/documents/${e}/restore`),u.success("Document restored")}async function bg(e){await p.post(`/api/documents/${e}/reprocess`),u.info("Document queued for reprocessing")}async function yg(e){return(await p.get(`/api/documents/${e}/summary`)).data.summary||""}async function xg(e){try{const t=e?`/api/knowledge?category=${e}`:"/api/knowledge";return(await p.get(t)).data.items||[]}catch{return[]}}async function wg(e,t){const n=await p.post("/api/knowledge",{content:e,category:t});return n.data.item||{id:n.data.id,content:e,category:t,created_at:new Date().toISOString()}}async function kg(e,t=10){return(await p.get(`/api/knowledge/search?q=${encodeURIComponent(e)}&limit=${t}`)).data.results||[]}async function $g(){try{return(await p.get("/api/conversations")).data.conversations||[]}catch{return[]}}async function qr(e){try{return(await p.get(`/api/conversations/${e}`)).data.conversation}catch{return null}}async function Sg(e){return(await p.post("/api/conversations/parse",{text:e})).data}async function Cg(e,t){return(await p.post("/api/conversations",{text:e,...t})).data.conversation}async function Lg(e){await p.delete(`/api/conversations/${e}`)}async function Mg(e){await p.post(`/api/conversations/${e}/reembed`)}async function qg(e){return(await p.post("/api/documents/bulk/delete",{ids:e})).data}async function Tg(e){return(await p.post("/api/documents/bulk/reprocess",{ids:e})).data}async function ml(e,t="original"){const n=await fetch("/api/documents/bulk/export",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e,format:t}),credentials:"include"});if(!n.ok)throw new Error("Failed to export documents");return n.blob()}async function Ag(e,t="original"){const n=await ml(e,t),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=`documents_export_${Date.now()}.zip`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}const qn={upload:pg,uploadWithExtraction:ug,getProcessingStatus:mg,getAll:gg,get:vg,delete:fg,restore:hg,reprocess:bg,getSummary:yg,bulkDelete:qg,bulkReprocess:Tg,bulkExport:ml,downloadBulkExport:Ag};async function Eg(){try{return(await p.get("/api/knowledge/status")).data.status}catch{return{total:0,embedded:0,pending:0,models:[]}}}async function _g(){return(await p.get("/api/knowledge/export?format=markdown")).data.markdown||""}async function jg(){return(await p.get("/api/knowledge/export?format=json")).data.items||[]}async function Dg(){return(await p.post("/api/knowledge/regenerate")).data}async function Pg(e){return(await p.post("/api/knowledge/synthesize",{topic:e})).data}const fa={getAll:xg,add:wg,search:kg,getStatus:Eg,exportMarkdown:_g,exportJson:jg,regenerate:Dg,synthesize:Pg},na={getAll:$g,get:qr,getById:qr,parsePreview:Sg,import:Cg,delete:Lg,reembed:Mg};async function Hg(e){try{const t=new URLSearchParams;e?.folder&&t.set("folder",e.folder),e?.label&&t.set("label",e.label),e?.unread&&t.set("unread","true"),e?.starred&&t.set("starred","true"),e?.search&&t.set("search",e.search),e?.limit&&t.set("limit",String(e.limit)),e?.offset&&t.set("offset",String(e.offset));const n=t.toString(),a=n?`/api/emails?${n}`:"/api/emails";return(await p.get(a)).data}catch{return{emails:[],total:0}}}async function gl(e){try{return(await p.get(`/api/emails/${e}`)).data.email}catch{return null}}async function zg(e){try{return(await p.get(`/api/emails/thread/${e}`)).data.thread}catch{return null}}async function Bg(e){await p.put(`/api/emails/${e}/read`)}async function Ig(e){await p.put(`/api/emails/${e}/unread`)}async function Rg(e){await p.put(`/api/emails/${e}/star`)}async function Ng(e){await p.put(`/api/emails/${e}/unstar`)}async function Fg(e){await p.put(`/api/emails/${e}/archive`)}async function Og(e){await p.delete(`/api/emails/${e}`)}async function Ug(e){return(await p.post("/api/emails/send",e)).data}async function Vg(e){return(await p.post("/api/emails/draft",e)).data}async function vl(e,t){return(await p.post(`/api/emails/${e}/ai-response`,{tone:t})).data.suggestions||[]}async function Gg(e){return(await p.post(`/api/emails/${e}/summarize`)).data.summary||""}async function Qg(e){return(await p.post(`/api/emails/${e}/categorize`)).data}async function Kg(){return(await p.get("/api/emails/stats")).data}async function Wg(){return(await p.post("/api/emails/sync")).data}async function Yg(e){return gl(e)}async function Jg(){try{return(await p.get("/api/emails?requires_response=true&response_sent=false")).data.emails||[]}catch{return[]}}async function Zg(e){await p.put(`/api/emails/${e}/responded`)}async function Xg(e,t){return vl(e,t)}const aa={getAll:Hg,get:gl,getById:Yg,getThread:zg,markAsRead:Bg,markAsUnread:Ig,star:Rg,unstar:Ng,archive:Fg,delete:Og,send:Ug,saveDraft:Vg,generateAIResponse:vl,generateResponse:Xg,generateSummary:Gg,categorize:Qg,getStats:Kg,sync:Wg,getNeedingResponse:Jg,markResponded:Zg};async function ev(e){try{const t=new URLSearchParams;e?.types?.length&&t.set("types",e.types.join(",")),e?.limit&&t.set("limit",String(e.limit)),e?.communityId!==void 0&&t.set("communityId",String(e.communityId));const n=await p.get(`/api/graph/nodes?${t.toString()}`),a=await p.get(`/api/graph/relationships?${t.toString()}`),s=n.data.nodes||n.data.results?.map(r=>{const c=r;return{id:String(c.id||c.nodeId||""),label:String(c.name||c.label||c.title||c.content?.substring(0,50)||""),name:String(c.name||""),type:String(c.type||c.label||"Unknown"),avatarUrl:c.avatarUrl||c.avatar_url||c.photoUrl||c.photo_url,role:c.role,organization:c.organization,properties:c}})||[],i=(a.data.relationships||a.data.results||[]).map(r=>{const c=r;return{id:String(c.id||`${c.from||c.source}-${c.to||c.target}-${c.type}`),source:String(c.from||c.source||""),target:String(c.to||c.target||""),label:String(c.type||c.label||""),type:String(c.type||"")}});return{nodes:s,edges:i}}catch(t){return console.error("[GraphService] getVisualizationData error:",t),{nodes:[],edges:[]}}}async function tv(){try{const e=await p.get("/api/graph/status");return e.data.stats?{...e.data.stats,graphName:e.data.graphName,connected:e.data.connected}:{nodeCount:e.data.nodes||0,edgeCount:e.data.relationships||0,graphName:e.data.graphName,connected:e.data.connected}}catch{return{nodeCount:0,edgeCount:0,connected:!1}}}async function nv(e){try{const t=new URLSearchParams;e?.type&&t.set("type",e.type),e?.depth&&t.set("depth",String(e.depth)),e?.limit&&t.set("limit",String(e.limit));const n=t.toString(),a=n?`/api/graph?${n}`:"/api/graph";return(await p.get(a)).data}catch{return{nodes:[],edges:[]}}}async function av(e,t=2){try{return(await p.get(`/api/graph/entity/${e}?depth=${t}`)).data}catch{return{nodes:[],edges:[]}}}async function sv(e){try{return(await p.get(`/api/graph/related/${e}`)).data.related||[]}catch{return[]}}async function fl(){try{return(await p.get("/api/ontology/schema")).data.schema||null}catch{return null}}async function ov(){try{return(await p.get("/api/ontology/entities")).data.entityTypes||[]}catch{return[]}}async function iv(){try{return(await p.get("/api/ontology/relations")).data.relationTypes||[]}catch{return[]}}async function rv(){try{return(await p.get("/api/ontology/suggestions")).data.suggestions||[]}catch{return[]}}async function cv(e){try{return(await p.post(`/api/ontology/suggestions/${e}/approve`,{})).data.ok}catch{return!1}}async function lv(e){try{return(await p.post(`/api/ontology/suggestions/${e}/reject`,{})).data.ok}catch{return!1}}async function dv(){try{return(await p.get("/api/ontology/stats")).data.stats||null}catch{return null}}async function pv(){try{return(await p.get("/api/ontology/sync/status")).data.status||null}catch{return null}}async function uv(){try{return(await p.post("/api/ontology/sync/force",{})).data}catch(e){return{ok:!1,error:String(e)}}}async function mv(){try{const e=await p.post("/api/ontology/analyze",{});return e.data.ok?e.data:null}catch{return null}}async function gv(e=.85){try{const t=await p.post("/api/ontology/suggestions/auto-approve",{threshold:e});return{approved:t.data.approved||0,skipped:t.data.skipped||0}}catch{return{approved:0,skipped:0}}}async function vv(e={}){try{const t=new URLSearchParams;return e.targetType&&t.append("targetType",e.targetType),e.targetName&&t.append("targetName",e.targetName),e.limit&&t.append("limit",String(e.limit)),(await p.get(`/api/ontology/changes?${t.toString()}`)).data.changes||[]}catch{return[]}}async function fv(){try{return(await p.post("/api/ontology/migrate",{})).data}catch(e){return{success:!1,error:String(e)}}}async function hv(){try{const e=await p.get("/api/ontology/worker/status");return e.data.ok?{status:e.data.status,stats:e.data.stats}:null}catch{return null}}async function bv(e,t={}){try{const n=await p.post("/api/ontology/worker/trigger",{type:e,config:t});return n.data.ok?n.data:null}catch{return null}}async function yv(e={}){try{const t=new URLSearchParams;return e.type&&t.append("type",e.type),e.status&&t.append("status",e.status),e.limit&&t.append("limit",String(e.limit)),(await p.get(`/api/ontology/worker/log?${t.toString()}`)).data.log||[]}catch{return[]}}async function xv(){try{return(await p.get("/api/ontology/jobs")).data.jobs||[]}catch{return[]}}async function wv(e,t){try{const n=await p.post(`/api/ontology/jobs/${e}/toggle`,{enabled:t});return n.data.ok?n.data.job:null}catch{return null}}async function kv(){try{return(await p.get("/api/ontology/extract-from-graph")).data}catch{return{ok:!1,error:"Failed to extract ontology"}}}async function $v(){try{const e=await p.get("/api/ontology/validate-compliance");return e.data.ok?e.data:null}catch{return null}}async function Sv(){try{const e=await p.get("/api/ontology/diff");return e.data.ok?{diff:e.data.diff,extractedOntology:e.data.extractedOntology}:null}catch{return null}}async function Cv(){try{return(await p.get("/api/ontology/unused-types")).data.unused||{entities:[],relations:[]}}catch{return{entities:[],relations:[]}}}async function Lv(e){try{return(await p.post("/api/ontology/merge",e)).data}catch{return{ok:!1}}}async function Mv(e){try{return(await p.post("/api/ontology/cleanup",e)).data}catch{return{ok:!1}}}async function qv(){try{const e=await p.get("/api/graph/falkordb-browser");return e.data.ok?e.data:null}catch{return null}}async function Tv(){try{return(await p.get("/api/graph/list-all")).data}catch{return{ok:!1,graphs:[]}}}async function Av(e=!1){try{return(await p.post("/api/graph/sync-projects",{dryRun:e})).data}catch{return{ok:!1,error:"Request failed",graphs:[],validGraphs:[],orphanGraphs:[],deleted:[],dryRun:e}}}async function Ev(e){try{return(await p.delete(`/api/graph/delete/${encodeURIComponent(e)}`)).data}catch{return{ok:!1,error:"Request failed"}}}async function _v(){try{return(await p.get("/api/graphrag/communities")).data.communities||[]}catch{return[]}}async function jv(){try{return(await p.get("/api/graphrag/centrality")).data.centrality||{topNodes:[]}}catch{return{topNodes:[]}}}async function Dv(){try{return(await p.get("/api/graphrag/bridges")).data.bridges||[]}catch{return[]}}async function Pv(){try{return(await p.get("/api/graph/insights")).data.insights||[]}catch{return[]}}async function Hv(e,t){try{return(await p.post("/api/graphrag/query",{query:e,noCache:t?.noCache})).data}catch{return{ok:!1,answer:"Failed to process query",sources:[],queryType:"hybrid",latencyMs:0}}}function zv(e,t,n,a){const s=new AbortController;return fetch("/api/graphrag/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e}),signal:s.signal}).then(async o=>{if(!o.ok)throw new Error("Stream request failed");const i=o.body?.getReader();if(!i)throw new Error("No reader available");const r=new TextDecoder;let c="";for(;;){const{done:l,value:m}=await i.read();if(l)break;const g=r.decode(m,{stream:!0}).split(`
`);for(const f of g)if(f.startsWith("data: ")){const b=f.slice(6);if(b==="[DONE]"){n({ok:!0,answer:c,sources:[],queryType:"hybrid",latencyMs:0});return}try{const w=JSON.parse(b);w.content&&(c+=w.content,t(w.content))}catch{c+=b,t(b)}}}}).catch(o=>{o.name!=="AbortError"&&a(o)}),()=>s.abort()}async function Bv(e){try{return(await p.post("/api/graphrag/multihop",{query:e})).data}catch{return{answer:"Failed to process multi-hop query",reasoningChain:[],confidence:0}}}async function Iv(e,t){try{return(await p.post("/api/graphrag/explain",{nodeId1:e,nodeId2:t})).data}catch{return{explanation:"Unable to explain connection",paths:[],facts:[]}}}async function Rv(e){try{return(await p.post("/api/graphrag/summarize",{nodeIds:e})).data}catch{return{summary:"Unable to generate summary",insights:[],suggestedActions:[]}}}async function Nv(e){try{return(await p.post("/api/graphrag/filter",{filterText:e})).data}catch{return{filters:{},explanation:"Unable to parse filter"}}}async function Fv(e){try{return(await p.post("/api/graphrag/suggest-related",{nodeId:e})).data.suggestions||[]}catch{return[]}}async function Ov(e){try{return(await p.post("/api/graph/query",{cypher:e})).data}catch(t){return{ok:!1,results:[],error:t instanceof Error?t.message:"Query failed"}}}async function Uv(){try{const e=await fl();return e?.queryPatterns?Object.entries(e.queryPatterns).map(([t,n])=>({id:t,name:t.replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()),description:n.description,cypher:n.cypher,category:"ontology"})):[]}catch{return[]}}async function Vv(){try{return(await p.get("/api/graph/projects")).data.graphs||[]}catch{return[]}}async function Gv(e){try{return(await p.get(`/api/graph/cross-project/${e}`)).data.entities||[]}catch{return[]}}async function Qv(e){try{return(await p.post("/api/graph/queries",e)).data.query||null}catch{return null}}async function Kv(e){try{const t=new URLSearchParams;return e?.limit&&t.set("limit",String(e.limit)),e?.favoritesOnly&&t.set("favorites","true"),(await p.get(`/api/graph/queries?${t.toString()}`)).data.queries||[]}catch{return[]}}async function Wv(e){try{return(await p.patch(`/api/graph/queries/${e}/favorite`,{})).data.ok}catch{return!1}}async function Yv(e){try{return(await p.delete(`/api/graph/queries/${e}`)).data.ok}catch{return!1}}async function Jv(e){try{return(await p.post("/api/graph/views",e)).data.view||null}catch{return null}}async function Zv(){try{return(await p.get("/api/graph/views")).data.views||[]}catch{return[]}}async function Xv(e,t){try{return(await p.patch(`/api/graph/views/${e}`,t)).data.ok}catch{return!1}}async function ef(e){try{return(await p.delete(`/api/graph/views/${e}`)).data.ok}catch{return!1}}async function tf(e){try{return(await p.post("/api/graph/bookmarks",e)).data.bookmark||null}catch{return null}}async function nf(){try{return(await p.get("/api/graph/bookmarks")).data.bookmarks||[]}catch{return[]}}async function af(e,t){try{return(await p.patch(`/api/graph/bookmarks/${e}`,t)).data.ok}catch{return!1}}async function sf(e){try{return(await p.delete(`/api/graph/bookmarks/${e}`)).data.ok}catch{return!1}}async function of(e){try{return(await p.post("/api/graph/annotations",e)).data.annotation||null}catch{return null}}async function rf(e){try{const t=new URLSearchParams;return e?.targetType&&t.set("targetType",e.targetType),e?.targetId&&t.set("targetId",e.targetId),e?.includeShared&&t.set("includeShared","true"),(await p.get(`/api/graph/annotations?${t.toString()}`)).data.annotations||[]}catch{return[]}}async function cf(e,t){try{return(await p.patch(`/api/graph/annotations/${e}`,t)).data.ok}catch{return!1}}async function lf(e){try{return(await p.delete(`/api/graph/annotations/${e}`)).data.ok}catch{return!1}}async function df(e){try{return(await p.post("/api/graph/chat",e)).data.message||null}catch{return null}}async function pf(){try{return(await p.get("/api/graph/chat/sessions")).data.sessions||[]}catch{return[]}}async function uf(e){try{return(await p.get(`/api/graph/chat/session/${e}`)).data.messages||[]}catch{return[]}}async function mf(e){try{return(await p.patch(`/api/graph/chat/${e}/pin`,{})).data.ok}catch{return!1}}async function gf(e){try{return(await p.post("/api/graph/snapshots",e)).data.snapshot||null}catch{return null}}async function vf(){try{return(await p.get("/api/graph/snapshots")).data.snapshots||[]}catch{return[]}}async function ff(e){try{return(await p.get(`/api/graph/snapshots/${e}`)).data.snapshot||null}catch{return null}}async function hf(e,t){try{return(await p.get(`/api/graph/snapshots/compare?id1=${e}&id2=${t}`)).data}catch{return{diff:{nodesAdded:[],nodesRemoved:[],edgesAdded:[],edgesRemoved:[],statsComparison:{nodeCountDiff:0,edgeCountDiff:0}}}}}async function bf(e){try{return(await p.delete(`/api/graph/snapshots/${e}`)).data.ok}catch{return!1}}async function ti(e){try{const t=new URLSearchParams;e?.startDate&&t.set("startDate",e.startDate),e?.endDate&&t.set("endDate",e.endDate),e?.types?.length&&t.set("types",e.types.join(",")),e?.limit&&t.set("limit",String(e.limit));const n=t.toString(),a=n?`/api/timeline?${n}`:"/api/timeline",s=await p.get(a),i=(s.data.events||[]).map(r=>({id:String(r.id??""),date:String(r.date??""),title:String(r.title??""),description:r.content!=null?String(r.content):void 0,content:r.content!=null?String(r.content):void 0,type:r.type??"document",entity_id:r.entity_id!=null?String(r.entity_id):void 0,entity_type:r.entity_type!=null?String(r.entity_type):void 0,metadata:r.metadata??void 0,user:r.owner!=null?String(r.owner):r.user,actor:r.owner!=null?String(r.owner):r.actor,owner:r.owner!=null?String(r.owner):void 0,icon:r.icon,color:r.color,status:r.status}));return{events:i,totalEvents:s.data.totalEvents??i.length,startDate:s.data.startDate??"",endDate:s.data.endDate??""}}catch{return{events:[],startDate:"",endDate:"",totalEvents:0}}}async function yf(e,t){try{return(await p.get(`/api/timeline/${e}/${t}`)).data.events||[]}catch{return[]}}async function xf(e){try{const t=new URLSearchParams;e?.startDate&&t.set("startDate",e.startDate),e?.endDate&&t.set("endDate",e.endDate),e?.provider&&t.set("provider",e.provider),e?.model&&t.set("model",e.model);const n=t.toString(),a=n?`/api/costs?${n}`:"/api/costs";return(await p.get(a)).data.costs||[]}catch{return[]}}async function wf(e){try{const t=e?`/api/costs/summary?period=${e}`:"/api/costs/summary",a=(await p.get(t)).data;if(!a)return{total:0,byProvider:{},byModel:{},byOperation:{},period:{start:"",end:""},dailyBreakdown:[]};const o=(a.dailyBreakdown??a.daily_breakdown??[]).map(i=>({date:i.date,cost:typeof i.cost=="number"?i.cost:parseFloat(String(i.cost))||0,calls:i.calls??i.requests??0}));return{total:typeof a.total=="number"?a.total:parseFloat(String(a.total))||0,byProvider:a.byProvider??a.by_provider??{},byModel:a.byModel??a.by_model??{},byOperation:a.byOperation??a.by_operation??{},byContext:a.byContext??a.by_context,period:a.period??{start:"",end:""},dailyBreakdown:o,totalInputTokens:a.totalInputTokens??a.total_input_tokens,totalOutputTokens:a.totalOutputTokens??a.total_output_tokens,previousPeriodCost:a.previousPeriodCost??a.previous_period_cost,percentChange:a.percentChange??a.percent_change,budgetLimit:a.budgetLimit??a.budget_limit,budgetUsedPercent:a.budgetUsedPercent??a.budget_used_percent,budgetAlertTriggered:a.budgetAlertTriggered??a.budget_alert_triggered}}catch{return{total:0,byProvider:{},byModel:{},byOperation:{},period:{start:"",end:""},dailyBreakdown:[]}}}async function kf(e=20){try{return(await p.get(`/api/costs/recent?limit=${e}`)).data?.requests??[]}catch{return[]}}async function $f(){try{return(await p.get("/api/costs/pricing")).data?.pricing??[]}catch{return[]}}async function Sf(e){try{const n=(await p.get(`/api/costs/budget?period=${e}`)).data?.budget;if(!n)return null;const a=n.limitUsd??n.limit_usd,s=n.alertThresholdPercent??n.alert_threshold_percent;return a==null||!Number.isFinite(Number(a))?null:{period:n.period??e,limitUsd:Number(a),alertThresholdPercent:s!=null?Math.min(100,Math.max(0,Number(s))):80,notifiedAt:n.notifiedAt??n.notified_at}}catch{return null}}async function Cf(e,t,n){await p.post("/api/costs/budget",{period:e,limitUsd:t,alertThresholdPercent:n})}async function Lf(){try{return(await p.get("/api/llm/config")).data}catch{return{provider:"unknown",model:"unknown",available:[]}}}const Ki={getVisualizationData:ev,getStats:tv,getGraph:nv,getEntityGraph:av,getRelated:sv,getOntologySchema:fl,getOntologyEntities:ov,getOntologyRelations:iv,getOntologySuggestions:rv,approveOntologySuggestion:cv,rejectOntologySuggestion:lv,getOntologyTypeStats:dv,getOntologySyncStatus:pv,forceOntologySync:uv,runLLMAnalysis:mv,autoApproveHighConfidence:gv,getOntologyChanges:vv,migrateOntologyToSupabase:fv,getBackgroundWorkerStatus:hv,triggerBackgroundAnalysis:bv,getBackgroundWorkerLog:yv,getOntologyJobs:xv,toggleOntologyJob:wv,extractOntologyFromGraph:kv,validateOntologyCompliance:$v,getOntologyDiff:Sv,findUnusedOntologyTypes:Cv,mergeOntology:Lv,cleanupOntology:Mv,getFalkorDBBrowserInfo:qv,listAllFalkorDBGraphs:Tv,syncFalkorDBGraphs:Av,deleteFalkorDBGraph:Ev,getCommunities:_v,getCentrality:jv,getBridges:Dv,getInsights:Pv,query:Hv,stream:zv,multiHop:Bv,explainConnection:Iv,summarizeSelection:Rv,naturalLanguageFilter:Nv,suggestRelated:Fv,executeCypher:Ov,getQueryTemplates:Uv,getProjectGraphs:Vv,getCrossProjectEntities:Gv,saveQueryHistory:Qv,getQueryHistory:Kv,toggleQueryFavorite:Wv,deleteQueryHistory:Yv,saveView:Jv,getSavedViews:Zv,updateView:Xv,deleteView:ef,addBookmark:tf,getBookmarks:nf,updateBookmark:af,removeBookmark:sf,createAnnotation:of,getAnnotations:rf,updateAnnotation:cf,deleteAnnotation:lf,saveChatMessage:df,getChatSessions:pf,getChatHistory:uf,toggleChatPin:mf,createSnapshot:gf,getSnapshots:vf,getSnapshot:ff,compareSnapshots:hf,deleteSnapshot:bf},hl={getAll:ti,getTimeline:ti,getForEntity:yf},ha={getAll:xf,getSummary:wf,getRecentRequests:kf,getPricing:$f,getBudget:Sf,setBudget:Cf,getLLMConfig:Lf};async function Mf(e){try{const t=new URLSearchParams;e?.unread&&t.set("unread","true"),e?.type&&t.set("type",e.type),e?.limit&&t.set("limit",String(e.limit));const n=t.toString(),a=n?`/api/notifications?${n}`:"/api/notifications";return(await p.get(a)).data.notifications||[]}catch{return[]}}async function qf(){try{return(await p.get("/api/notifications/count")).data.count||0}catch{return 0}}async function Tr(e){await p.post(`/api/notifications/${e}/read`)}async function Ar(){await p.post("/api/notifications/read-all")}async function Tf(e){await p.delete(`/api/notifications/${e}`)}async function Af(e,t){try{return(await p.get(`/api/comments/${e}/${t}`)).data.comments||[]}catch{return[]}}async function bl(e,t,n,a){const s=await p.post(`/api/comments/${e}/${t}`,{content:n,parentId:a});return s.data.comment||{id:s.data.id,entity_type:e,entity_id:t,content:n,author:"You",created_at:new Date().toISOString(),is_edited:!1}}async function Ef(e,t){await p.put(`/api/comments/${e}`,{content:t})}async function _f(e){await p.delete(`/api/comments/${e}`)}async function jf(e,t){await p.post(`/api/comments/${e}/react`,{emoji:t})}async function Df(e,t){await p.delete(`/api/comments/${e}/react/${t}`)}async function Pf(e,t,n,a){return bl(e,t,n,a)}async function Hf(e){await p.put(`/api/comments/${e}/resolve`)}async function zf(e){try{const t=e?`/api/projects/${e}/members`:"/api/project/members";return(await p.get(t)).data.members||[]}catch{return[]}}async function Bf(e,t,n){const a=n?`/api/projects/${n}/members`:"/api/project/members";return(await p.post(a,{email:e,role:t})).data}async function If(e,t,n){const a=n?`/api/projects/${n}/members/${e}`:`/api/project/members/${e}`;await p.put(a,{role:t})}async function Rf(e,t){const n=t?`/api/projects/${t}/members/${e}`:`/api/project/members/${e}`;await p.delete(n)}const ba={getAll:Mf,getUnreadCount:qf,markAsRead:Tr,markRead:Tr,markAllAsRead:Ar,markAllRead:Ar,delete:Tf},sa={getAll:Af,add:bl,create:Pf,update:Ef,delete:_f,addReaction:jf,removeReaction:Df,resolve:Hf};async function Nf(e){try{const t=e?`/api/projects/${e}/invites`:"/api/project/invites";return(await p.get(t)).data.invites||[]}catch{return[]}}const ms={getAll:zf,invite:Bf,updateRole:If,remove:Rf,getInvites:Nf};async function Ff(){try{return(await p.get("/api/settings")).data}catch{return{}}}async function Of(e){await p.put("/api/settings",e)}async function Uf(e){try{const t=e?`/api/projects/${e}/settings`:"/api/project/settings";return(await p.get(t)).data.settings}catch{return null}}async function Vf(e,t){const n=t?`/api/projects/${t}/settings`:"/api/project/settings";await p.put(n,e)}async function Gf(){try{return(await p.get("/api/api-keys")).data.keys||[]}catch{return[]}}async function Qf(e,t){return(await p.post("/api/api-keys",{name:e,permissions:t})).data}async function Kf(e){await p.delete(`/api/api-keys/${e}`)}async function Wf(){try{return(await p.get("/api/webhooks")).data.webhooks||[]}catch{return[]}}async function Yf(e){const t=await p.post("/api/webhooks",e);return t.data.webhook||{...e,id:t.data.id,is_active:!0,failure_count:0,created_at:new Date().toISOString()}}async function Jf(e,t){await p.put(`/api/webhooks/${e}`,t)}async function Zf(e){await p.delete(`/api/webhooks/${e}`)}async function Xf(e){return(await p.post(`/api/webhooks/${e}/test`)).data}async function eh(e){try{const t=new URLSearchParams;e?.action&&t.set("action",e.action),e?.entity_type&&t.set("entity_type",e.entity_type),e?.user_id&&t.set("user_id",e.user_id),e?.startDate&&t.set("startDate",e.startDate),e?.endDate&&t.set("endDate",e.endDate),e?.limit&&t.set("limit",String(e.limit)),e?.offset&&t.set("offset",String(e.offset));const n=t.toString(),a=n?`/api/audit?${n}`:"/api/audit";return(await p.get(a)).data}catch{return{logs:[],total:0}}}async function th(e,t){const n=new URLSearchParams;n.set("format",e),t?.startDate&&n.set("startDate",t.startDate),t?.endDate&&n.set("endDate",t.endDate);const a=await fetch(`/api/audit/export?${n.toString()}`);if(!a.ok)throw new Error("Export failed");return a.blob()}const nh={get:Ff,update:Of},ah={get:Uf,update:Vf},sh={getAll:Gf,create:Qf,revoke:Kf},oh={getAll:Wf,create:Yf,update:Jf,delete:Zf,test:Xf},ih={getAll:eh,export:th};async function rh(){try{return(await p.get("/api/profile")).data.profile}catch{return null}}async function ch(e){const t=await p.put("/api/profile",e),n=P.getState().currentUser;return n&&P.setCurrentUser({...n,name:e.display_name||n.name,avatar:e.avatar_url||n.avatar}),t.data.profile}async function lh(e){const t=new FormData;t.append("avatar",e);const n=await fetch("/api/profile/avatar",{method:"POST",body:t});if(!n.ok)throw new Error("Avatar upload failed");const a=await n.json(),s=P.getState().currentUser;return s&&P.setCurrentUser({...s,avatar:a.avatar_url}),a.avatar_url}async function dh(){await p.delete("/api/profile/avatar");const e=P.getState().currentUser;e&&P.setCurrentUser({...e,avatar:void 0})}async function ph(e){if(e.new_password.length<12)throw new Error("New password must be at least 12 characters");await p.post("/api/profile/change-password",e)}async function uh(e){await p.post("/api/profile/delete",{password:e}),P.setCurrentUser(null),P.setCurrentProject(null)}async function mh(e=50){try{return(await p.get(`/api/profile/activity?limit=${e}`)).data.activities||[]}catch{return[]}}async function gh(){try{return(await p.get("/api/profile/sessions")).data.sessions||[]}catch{return[]}}async function vh(e){await p.delete(`/api/profile/sessions/${e}`)}async function fh(){await p.post("/api/profile/sessions/revoke-all")}const en={get:rh,update:ch,uploadAvatar:lh,removeAvatar:dh,changePassword:ph,deleteAccount:uh,getActivity:mh,getSessions:gh,revokeSession:vh,revokeAllSessions:fh};async function vo(e){try{const t=new URLSearchParams;e?.limit&&t.set("limit",String(e.limit)),e?.offset&&t.set("offset",String(e.offset)),e?.search&&t.set("search",e.search),e?.category&&t.set("category",e.category),e?.verified!==void 0&&t.set("verified",String(e.verified));const n=t.toString(),a=n?`/api/facts?${n}`:"/api/facts",s=await p.get(a);return{facts:s.data.facts||[],total:s.data.total||s.data.facts?.length||0}}catch{return{facts:[],total:0}}}async function hh(e){try{return(await p.get(`/api/facts/${e}`)).data.fact}catch{return null}}async function bh(e){const t=await p.post("/api/facts",e);return t.data.fact||{...e,id:t.data.id,created_at:new Date().toISOString()}}async function yl(e,t){return(await p.put(`/api/facts/${e}`,t)).data.fact}async function Er(e){await p.delete(`/api/facts/${e}`)}async function yh(){try{return(await p.get("/api/facts/deleted")).data.facts||[]}catch{return[]}}async function xh(e){return(await p.post(`/api/facts/${e}/restore`,{})).data.fact}async function _r(e){return yl(e,{verified:!0})}async function wh(){return(await p.post("/api/fact-check/run",{})).data}async function kh(){try{return(await p.get("/api/conflicts")).data.conflicts||[]}catch{return[]}}async function $h(){try{const{facts:e}=await vo({limit:1e3}),t={};return e.forEach(n=>{const a=n.category||"Uncategorized";t[a]||(t[a]=[]),t[a].push(n)}),t}catch{return{}}}async function Sh(){try{const{facts:e}=await vo({limit:1e3}),t={};return e.forEach(n=>{const a=n.source_file||n.source||"Unknown source";t[a]||(t[a]=[]),t[a].push(n)}),t}catch{return{}}}async function Ch(e){try{const t=new URLSearchParams({document_id:e});return(await p.get(`/api/facts?${t}`)).data.facts||[]}catch{return[]}}async function Lh(e){try{return(await p.get(`/api/facts/${e}/events`)).data.events||[]}catch{return[]}}async function Mh(e,t=10){try{const n=new URLSearchParams;t!==10&&n.set("limit",String(t));const a=n.toString(),s=a?`/api/facts/${e}/similar?${a}`:`/api/facts/${e}/similar`;return(await p.get(s)).data.similar||[]}catch{return[]}}async function qh(e,t=20){const{facts:n}=await vo({search:e,limit:t});return n}function Th(e){const t={total:e.length,verified:e.filter(n=>n.verified).length,unverified:e.filter(n=>!n.verified).length,byCategory:{}};return e.forEach(n=>{const a=n.category||"Uncategorized";t.byCategory[a]=(t.byCategory[a]||0)+1}),t}const Ee={getAll:vo,get:hh,create:bh,update:yl,delete:Er,deleteFact:Er,verify:_r,verifyFact:_r,detectConflicts:kh,getByCategory:$h,getBySource:Sh,getByDocument:Ch,getEvents:Lh,getSimilarFacts:Mh,search:qh,getStats:Th,getDeletedFacts:yh,restoreFact:xh,runFactCheck:wh};async function jr(){try{return(await p.get("/api/krisp/webhook")).data.webhook}catch{return null}}async function Ah(){try{return(await p.post("/api/krisp/webhook/regenerate")).data.webhook}catch{return null}}async function Eh(e){try{return await p.put("/api/krisp/webhook/toggle",{is_active:e}),!0}catch{return!1}}async function _h(e={}){const t=new URLSearchParams;e.status&&(Array.isArray(e.status)?t.append("status",e.status.join(",")):t.append("status",e.status)),e.projectId&&t.append("project_id",e.projectId),e.limit&&t.append("limit",String(e.limit)),e.offset&&t.append("offset",String(e.offset));const n=`/api/krisp/transcripts${t.toString()?`?${t}`:""}`;return(await p.get(n)).data.transcripts}async function jh(){try{return(await p.get("/api/krisp/transcripts/summary")).data.summary}catch{return null}}async function g$(e,t){try{return await p.post(`/api/krisp/transcripts/${e}/assign`,{project_id:t}),!0}catch{return!1}}async function v$(e,t){try{return await p.post(`/api/krisp/transcripts/${e}/skip`,{reason:t}),!0}catch{return!1}}async function f$(e){try{return await p.post(`/api/krisp/transcripts/${e}/retry`),!0}catch{return!1}}async function h$(e){try{return await p.post(`/api/krisp/transcripts/${e}/process`),!0}catch{return!1}}async function b$(){try{return(await p.get("/api/krisp/mappings")).data.mappings}catch{return[]}}async function y$(e){try{return await p.delete(`/api/krisp/mappings/${e}`),!0}catch{return!1}}async function x$(e,t={}){try{return(await p.post(`/api/krisp/transcripts/${e}/summary`,{forceRegenerate:t.forceRegenerate||!1})).data.summary}catch{return null}}async function w$(){return _h({status:["quarantine","ambiguous"]})}async function k$(e={}){try{const t=new URLSearchParams;e.limit&&t.set("limit",String(e.limit)),e.offset&&t.set("offset",String(e.offset)),e.showImported===!1&&t.set("showImported","false"),e.startDate&&t.set("startDate",e.startDate),e.endDate&&t.set("endDate",e.endDate),e.search&&t.set("search",e.search);const n=`/api/krisp/available${t.toString()?"?"+t.toString():""}`;return(await p.get(n)).data}catch{return null}}async function $$(e,t){try{return(await p.post("/api/krisp/available/import",{meetingIds:e,projectId:t})).data}catch{return null}}async function S$(e){try{return(await p.post("/api/krisp/available/summary",{meetingId:e})).data}catch{return null}}function C$(e){return{pending:{label:"Pending",color:"blue"},quarantine:{label:"Quarantine",color:"yellow"},ambiguous:{label:"Ambiguous",color:"orange"},matched:{label:"Matched",color:"cyan"},processed:{label:"Processed",color:"green"},failed:{label:"Failed",color:"red"},skipped:{label:"Skipped",color:"gray"}}[e]||{label:e,color:"gray"}}function L$(e){if(!e)return"-";const t=Math.floor(e/60),n=e%60;return t>0?`${t}h ${n}m`:`${n}m`}function x(e,t,n){const a=document.createElement(e);return t&&Object.entries(t).forEach(([s,o])=>{s==="className"?a.className=o:s==="style"&&typeof o=="object"?Object.assign(a.style,o):s.startsWith("data")?a.setAttribute(s.replace(/([A-Z])/g,"-$1").toLowerCase(),String(o)):a[s]=o}),a}function d(e,t,n,a){return e.addEventListener(t,n,a),()=>e.removeEventListener(t,n,a)}function qt(e,...t){e.classList.add(...t)}function cn(e,...t){e.classList.remove(...t)}function Wi(e){const t=x("button",{className:"btn btn-ghost theme-toggle",title:`Theme: ${Ae.getLabel()} (Ctrl+Shift+T)`});function n(){t.innerHTML=a(),t.title=`Theme: ${Ae.getLabel()} (Ctrl+Shift+T)`,t.setAttribute("data-theme-mode",Ae.getMode())}function a(){switch(Ae.getMode()){case"light":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>`;case"dark":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>`;case"system":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
          <line x1="8" y1="21" x2="16" y2="21"/>
          <line x1="12" y1="17" x2="12" y2="21"/>
        </svg>`}}return d(t,"click",()=>{Ae.cycle(),n(),u.info(`Theme: ${Ae.getLabel()}`)}),Ae.onChange(()=>{n()}),n(),e&&e.appendChild(t),t}function Dh(e){const t=document.querySelector(e);return t?Wi(t):(console.warn(`ThemeToggle: Container not found: ${e}`),null)}const xl={currentTab:"dashboard",currentDevTab:"info",sotCurrentView:"questions",selectedPerson:null,sidebarOpen:!0,modalOpen:null,searchQuery:"",filterActive:!1};let ye={...xl};const ni=new Set;function Et(){ni.forEach(e=>e(ye))}function Ph(){return ye}function Hh(e){return ni.add(e),()=>ni.delete(e)}function zh(e){ye={...ye,currentTab:e},Et()}function Bh(e){ye={...ye,currentDevTab:e},Et()}function Ih(e){ye={...ye,sotCurrentView:e},Et()}function Rh(e){ye={...ye,selectedPerson:e},Et()}function Nh(){ye={...ye,sidebarOpen:!ye.sidebarOpen},Et()}function Fh(e){ye={...ye,sidebarOpen:e},Et()}function Oh(e){ye={...ye,modalOpen:e},Et()}function Uh(){ye={...ye,modalOpen:null},Et()}function Vh(e){ye={...ye,searchQuery:e},Et()}function Gh(){ye={...ye,filterActive:!ye.filterActive},Et()}function Qh(){ye={...xl},Et()}const ve={getState:Ph,subscribe:Hh,setTab:zh,setDevTab:Bh,setSotView:Ih,setSelectedPerson:Rh,toggleSidebar:Nh,setSidebarOpen:Fh,openModal:Oh,closeModal:Uh,setSearchQuery:Vh,toggleFilter:Gh,reset:Qh};function wl(e={}){const t=x("header",{className:"app-header"}),n=x("div",{className:"header-logo"});n.innerHTML=`
    <span class="logo-icon">‚ö°</span>
    <h1>GodMode</h1>
  `;const a=x("div",{className:"header-actions"}),s=Kh(e.onProjectChange);a.appendChild(s);const o=Wi();a.appendChild(o);const i=Wh(e);a.appendChild(i);const r=x("button",{className:"mobile-menu-btn",innerHTML:"‚ò∞"});return d(r,"click",()=>{ve.toggleSidebar()}),t.appendChild(r),t.appendChild(n),t.appendChild(a),t}function Kh(e){const t=x("div",{className:"project-selector"}),n=x("button",{className:"project-btn"}),a=x("div",{className:"project-dropdown"});function s(){const r=P.getState().currentProjectId||"Select Project";n.innerHTML=`
      <span class="project-name">${r}</span>
      <span class="dropdown-arrow">‚ñº</span>
    `}let o=!1;return d(n,"click",i=>{i.stopPropagation(),o=!o,a.classList.toggle("show",o)}),d(document,"click",()=>{o=!1,a.classList.remove("show")}),P.subscribe(()=>{s()}),s(),t.appendChild(n),t.appendChild(a),t}function Wh(e){const t=x("div",{className:"user-menu"}),n=x("button",{className:"user-menu-btn"}),a=x("div",{className:"user-dropdown"});function s(){const l=P.getState().currentUser,m=l?.name?l.name.split(" ").map(v=>v[0]).join("").toUpperCase().slice(0,2):l?.email?.[0]?.toUpperCase()||"?";n.innerHTML=`
      <div class="user-avatar">${m}</div>
      <span class="user-name">${l?.name||l?.email||"Guest"}</span>
    `}function o(){const l=P.getState().currentUser;a.innerHTML=`
      <div class="user-dropdown-header">
        <strong>${l?.name||"Guest"}</strong>
        <span class="text-muted">${l?.email||""}</span>
        ${l?.role?`<span class="role-badge ${l.role}">${l.role}</span>`:""}
      </div>
      <div class="user-dropdown-items">
        <button data-action="settings">
          <span>‚öôÔ∏è</span> Settings
        </button>
        <button data-action="shortcuts">
          <span>‚å®Ô∏è</span> Shortcuts
        </button>
        <button data-action="logout" class="text-error">
          <span>üö™</span> Logout
        </button>
      </div>
    `;const m=a.querySelector('[data-action="settings"]'),v=a.querySelector('[data-action="shortcuts"]'),g=a.querySelector('[data-action="logout"]');m&&d(m,"click",()=>{e.onSettings?.(),r()}),v&&d(v,"click",()=>{ve.openModal("shortcuts"),r()}),g&&d(g,"click",()=>{e.onLogout?.(),r()})}let i=!1;function r(){i=!1,a.classList.remove("show")}return d(n,"click",c=>{c.stopPropagation(),i=!i,a.classList.toggle("show",i),i&&o()}),d(document,"click",r),P.subscribe(s),s(),t.appendChild(n),t.appendChild(a),t}function Yh(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Header: Container not found: ${e}`),null;const a=wl(t);return n.appendChild(a),a}const Dr=[{id:"dashboard",label:"Dashboard",icon:"üìä"},{id:"chat",label:"Chat",icon:"üí¨"},{id:"sot",label:"Source of Truth",icon:"üìã"},{id:"timeline",label:"Timeline",icon:"üìÖ"},{id:"org",label:"Org Chart",icon:"üë•"},{id:"files",label:"Files",icon:"üìÅ"},{id:"emails",label:"Emails",icon:"üìß"},{id:"contacts",label:"Contacts",icon:"üìá"},{id:"roles",label:"Roles",icon:"üîê"},{id:"graph",label:"Graph DB",icon:"üï∏Ô∏è"},{id:"costs",label:"Costs",icon:"üí∞"},{id:"history",label:"History",icon:"üïê"}],Jh={id:"admin",label:"Admin",icon:"‚öôÔ∏è"};function Zh(){return P.getState().currentUser?.role==="superadmin"?[...Dr,Jh]:Dr}function Xh(e,t){const n=x("button",{className:"sidebar-tab"});return n.setAttribute("data-tab",e.id),n.innerHTML=`
    <span class="tab-icon">${e.icon}</span>
    <span class="tab-label">${e.label}</span>
    ${e.badge?`<span class="tab-badge">${e.badge}</span>`:""}
  `,d(n,"click",()=>{ve.setTab(e.id),t.onTabChange?.(e.id),window.innerWidth<768&&ve.setSidebarOpen(!1)}),n}function Pr(e,t){const n=t.tabs||Zh(),a=ve.getState().currentTab;e.innerHTML="",n.forEach(s=>{const o=Xh(s,t);s.id===a&&qt(o,"active"),e.appendChild(o)})}function kl(e={}){const t=x("aside",{className:"sidebar"}),n=x("button",{className:"sidebar-close-btn",innerHTML:"‚úï"});d(n,"click",()=>{ve.setSidebarOpen(!1)}),t.appendChild(n);const a=x("nav",{className:"sidebar-nav"});Pr(a,e),t.appendChild(a),P.subscribe(()=>{Pr(a,e)}),ve.subscribe(i=>{a.querySelectorAll(".sidebar-tab").forEach(c=>{c.getAttribute("data-tab")===i.currentTab?qt(c,"active"):cn(c,"active")}),i.sidebarOpen?qt(t,"mobile-open"):cn(t,"mobile-open")});const s=ve.getState(),o=a.querySelector(`[data-tab="${s.currentTab}"]`);return o&&qt(o,"active"),t}function eb(e,t){const n=document.querySelector(`.sidebar-tab[data-tab="${e}"]`);if(!n)return;let a=n.querySelector(".tab-badge");if(t===null||t===0){a?.remove();return}a||(a=x("span",{className:"tab-badge"}),n.appendChild(a)),a.textContent=t>99?"99+":String(t)}function tb(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Sidebar: Container not found: ${e}`),null;const a=kl(t);return n.appendChild(a),a}let Lo=null;function $l(e={}){if(Lo)return Lo;const t=e.position||"bottom-right",n=x("div",{className:`toast-container toast-${t}`}),a={"top-right":"top: 20px; right: 20px;","top-left":"top: 20px; left: 20px;","bottom-right":"bottom: 20px; right: 20px;","bottom-left":"bottom: 20px; left: 20px;","top-center":"top: 20px; left: 50%; transform: translateX(-50%);","bottom-center":"bottom: 20px; left: 50%; transform: translateX(-50%);"};return n.style.cssText=`
    position: fixed;
    ${a[t]}
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 400px;
    pointer-events: none;
  `,document.body.appendChild(n),Lo=n,n}function Sl(e,t="info",n=3e3){const a=x("div",{className:`toast toast-${t} fade-in`}),s={success:"‚úì",error:"‚úï",warning:"‚ö†",info:"‚Ñπ"},o={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--accent)"};return a.style.cssText=`
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: ${o[t]};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    font-size: 14px;
    pointer-events: auto;
    cursor: pointer;
    animation: slideInRight 0.3s ease;
  `,a.innerHTML=`
    <span class="toast-icon">${s[t]}</span>
    <span class="toast-message">${e}</span>
  `,d(a,"click",()=>{Hr(a)}),n>0&&setTimeout(()=>{Hr(a)},n),a}function Hr(e){e.style.opacity="0",e.style.transform="translateX(100%)",e.style.transition="all 0.3s ease",setTimeout(()=>{e.remove()},300)}function nb(e,t="info",n=3e3){const a=$l(),s=Sl(e,t,n);return a.appendChild(s),s}const vt=new Map;function fe(e){const{id:t,title:n,content:a,size:s="md",closable:o=!0,onClose:i,onOpen:r,footer:c}=e,l=x("div",{className:`modal modal-${s}`});l.setAttribute("data-modal-id",t);const m=x("div",{className:"modal-content"}),v=x("div",{className:"modal-header"});if(v.innerHTML=`<h3>${n}</h3>`,o){const b=x("button",{className:"modal-close",innerHTML:"√ó"});d(b,"click",()=>H(t)),v.appendChild(b)}const g=x("div",{className:"modal-body"});typeof a=="string"?g.innerHTML=a:a&&g.appendChild(a);const f=c||x("div",{className:"modal-footer"});return m.appendChild(v),m.appendChild(g),c!==null&&m.appendChild(f),l.appendChild(m),o&&d(l,"click",b=>{b.target===l&&H(t)}),vt.set(t,l),l}function he(e){const t=vt.get(e)||document.querySelector(`[data-modal-id="${e}"]`);if(!t){console.warn(`Modal not found: ${e}`);return}t.style.display="flex",qt(t,"open"),document.body.style.overflow="hidden",ve.openModal(e),setTimeout(()=>{t.querySelector("input, textarea, select, button")?.focus()},100)}function H(e){const t=vt.get(e)||document.querySelector(`[data-modal-id="${e}"]`);t&&(cn(t,"open"),t.style.display="none",document.body.style.overflow="",ve.closeModal())}function Cl(){vt.forEach((e,t)=>H(t))}function Ll(e){return vt.get(e)?.classList.contains("open")||!1}function Ml(e,t){const n=vt.get(e);if(!n)return;const a=n.querySelector(".modal-body");a&&(typeof t=="string"?a.innerHTML=t:(a.innerHTML="",a.appendChild(t)))}function ql(e,t){const n=vt.get(e);if(!n)return;const a=n.querySelector(".modal-header h3");a&&(a.textContent=t)}function Ln(e,t={}){return new Promise(n=>{const{title:a="Confirm",confirmText:s="Confirm",cancelText:o="Cancel",confirmClass:i="btn-primary"}=t,r=`confirm-${Date.now()}`,c=x("div",{className:"modal-footer"}),l=x("button",{className:"btn btn-secondary",textContent:o}),m=x("button",{className:`btn ${i}`,textContent:s});d(l,"click",()=>{H(r),v.remove(),vt.delete(r),n(!1)}),d(m,"click",()=>{H(r),v.remove(),vt.delete(r),n(!0)}),c.appendChild(l),c.appendChild(m);const v=fe({id:r,title:a,content:`<p>${e}</p>`,size:"sm",closable:!0,onClose:()=>n(!1),footer:c});document.body.appendChild(v),he(r)})}function Tl(e,t="Alert"){return new Promise(n=>{const a=`alert-${Date.now()}`,s=x("div",{className:"modal-footer"}),o=x("button",{className:"btn btn-primary",textContent:"OK"});d(o,"click",()=>{H(a),i.remove(),vt.delete(a),n()}),s.appendChild(o);const i=fe({id:a,title:t,content:`<p>${e}</p>`,size:"sm",closable:!0,onClose:()=>n(),footer:s});document.body.appendChild(i),he(a)})}function ab(e,t={}){return new Promise(n=>{const a=`prompt-${Date.now()}`,{title:s="Input",placeholder:o="",defaultValue:i=""}=t,r=x("div",{className:"prompt-content"});r.innerHTML=`
      <p>${e}</p>
      <input type="text" class="prompt-input" placeholder="${o}" value="${i}" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-top: 8px;">
    `;const c=x("div",{className:"modal-footer"}),l=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),m=x("button",{className:"btn btn-primary",textContent:"OK"});d(l,"click",()=>{H(a),v.remove(),vt.delete(a),n(null)}),d(m,"click",()=>{const f=v.querySelector(".prompt-input")?.value||"";H(a),v.remove(),vt.delete(a),n(f)}),c.appendChild(l),c.appendChild(m);const v=fe({id:a,title:s,content:r,size:"sm",closable:!0,onClose:()=>n(null),footer:c});document.body.appendChild(v),he(a),setTimeout(()=>{v.querySelector(".prompt-input")?.focus()},100)})}Ct.register({key:"Escape",description:"Close modal",handler:()=>{const e=ve.getState();e.modalOpen&&H(e.modalOpen)}});const Gt=Object.freeze(Object.defineProperty({__proto__:null,alert:Tl,closeAllModals:Cl,closeModal:H,confirm:Ln,createModal:fe,isModalOpen:Ll,openModal:he,prompt:ab,updateModalContent:Ml,updateModalTitle:ql},Symbol.toStringTag,{value:"Module"})),Aa="member-permissions-modal",sb=[{id:"view",name:"View",icon:"üëÅÔ∏è",color:"#3b82f6",permissions:[{id:"view:dashboard",name:"Dashboard",desc:"View project dashboard and stats"},{id:"view:chat",name:"AI Chat",desc:"Use the AI assistant"},{id:"view:sot",name:"Source of Truth",desc:"View decisions, risks, actions, questions"},{id:"view:contacts",name:"Contacts",desc:"View project contacts"},{id:"view:documents",name:"Documents",desc:"View uploaded documents"},{id:"view:emails",name:"Emails",desc:"View email history"},{id:"view:team",name:"Team",desc:"View team members"}]},{id:"comment",name:"Comment",icon:"üí¨",color:"#8b5cf6",permissions:[{id:"comment:sot",name:"Comment on Items",desc:"Add comments to decisions, risks, etc."},{id:"comment:documents",name:"Comment on Docs",desc:"Add comments to documents"}]},{id:"edit",name:"Edit",icon:"‚úèÔ∏è",color:"#10b981",permissions:[{id:"edit:questions",name:"Questions",desc:"Create and edit questions"},{id:"edit:risks",name:"Risks",desc:"Create and edit risks"},{id:"edit:actions",name:"Actions",desc:"Create and edit actions"},{id:"edit:decisions",name:"Decisions",desc:"Create and edit decisions"},{id:"edit:contacts",name:"Contacts",desc:"Create and edit contacts"},{id:"edit:documents",name:"Documents",desc:"Upload and edit documents"}]},{id:"manage",name:"Manage",icon:"‚öôÔ∏è",color:"#f59e0b",permissions:[{id:"manage:team",name:"Team",desc:"Invite and remove team members"},{id:"manage:roles",name:"Roles",desc:"Create and assign roles"},{id:"manage:settings",name:"Settings",desc:"Change project settings"},{id:"manage:integrations",name:"Integrations",desc:"Configure integrations"}]},{id:"delete",name:"Delete",icon:"üóëÔ∏è",color:"#ef4444",permissions:[{id:"delete:data",name:"Delete Data",desc:"Permanently delete items"},{id:"export:data",name:"Export Data",desc:"Export project data"}]}],zr={viewer:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team"],editor:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team","comment:sot","comment:documents","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","edit:documents"],admin:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team","comment:sot","comment:documents","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","edit:documents","manage:team","manage:roles","manage:settings","manage:integrations","delete:data","export:data"],owner:["view:dashboard","view:chat","view:sot","view:contacts","view:documents","view:emails","view:team","comment:sot","comment:documents","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","edit:documents","manage:team","manage:roles","manage:settings","manage:integrations","delete:data","export:data"]};function Al(e){const{projectId:t,userId:n,userName:a,userEmail:s,avatarUrl:o,currentRole:i,onSave:r}=e;let c=new Set(e.currentPermissions||zr[i]||[]);const l=document.querySelector(`[data-modal-id="${Aa}"]`);l&&l.remove();const m=document.createElement("div");m.className="member-permissions-content",m.innerHTML=`
    <style>
      .member-permissions-content {
        padding: 0;
      }
      
      .member-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px 24px;
        background: linear-gradient(135deg, rgba(225,29,72,0.08) 0%, rgba(225,29,72,0.03) 100%);
        border-bottom: 1px solid var(--border-color);
      }
      
      .member-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
        overflow: hidden;
      }
      
      .member-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .member-info h4 {
        margin: 0 0 4px;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .member-info p {
        margin: 0;
        font-size: 13px;
        color: var(--text-secondary);
      }
      
      .role-selector {
        margin-left: auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      
      .role-selector label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .role-selector select {
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
      }
      
      .permissions-body {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .permission-category {
        margin-bottom: 20px;
      }
      
      .permission-category:last-child {
        margin-bottom: 0;
      }
      
      .category-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
      }
      
      .category-icon {
        font-size: 16px;
      }
      
      .category-name {
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }
      
      .category-toggle {
        font-size: 11px;
        padding: 4px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: transparent;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.15s;
      }
      
      .category-toggle:hover {
        background: var(--bg-secondary);
        border-color: #e11d48;
        color: #e11d48;
      }
      
      .permission-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 8px;
      }
      
      .permission-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.15s;
        border: 1px solid transparent;
      }
      
      .permission-item:hover {
        background: var(--bg-tertiary);
      }
      
      .permission-item.selected {
        background: linear-gradient(135deg, rgba(225,29,72,0.1) 0%, rgba(225,29,72,0.05) 100%);
        border-color: rgba(225,29,72,0.3);
      }
      
      .permission-item input {
        margin-top: 2px;
        accent-color: #e11d48;
        width: 16px;
        height: 16px;
      }
      
      .permission-info {
        flex: 1;
        min-width: 0;
      }
      
      .permission-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
      }
      
      .permission-desc {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
      }
      
      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      
      .btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }
      
      .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      
      .btn-secondary:hover {
        background: var(--bg-tertiary);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
    </style>
    
    <div class="member-header">
      <div class="member-avatar">
        ${o?`<img src="${o}" alt="">`:ib(a||s)}
      </div>
      <div class="member-info">
        <h4>${Br(a||s)}</h4>
        <p>${Br(s)}</p>
      </div>
      <div class="role-selector">
        <label>Base Role</label>
        <select id="base-role">
          <option value="viewer" ${i==="viewer"?"selected":""}>Viewer</option>
          <option value="editor" ${i==="editor"?"selected":""}>Editor</option>
          <option value="admin" ${i==="admin"?"selected":""}>Admin</option>
          <option value="owner" ${i==="owner"?"selected":""}>Owner</option>
        </select>
      </div>
    </div>
    
    <div class="permissions-body">
      ${sb.map(g=>`
        <div class="permission-category" data-category="${g.id}">
          <div class="category-header">
            <span class="category-icon">${g.icon}</span>
            <span class="category-name">${g.name}</span>
            <button type="button" class="category-toggle" data-action="toggle">Toggle All</button>
          </div>
          <div class="permission-grid">
            ${g.permissions.map(f=>`
              <label class="permission-item${c.has(f.id)?" selected":""}">
                <input type="checkbox" name="permission" value="${f.id}" ${c.has(f.id)?"checked":""}>
                <div class="permission-info">
                  <div class="permission-name">${f.name}</div>
                  <div class="permission-desc">${f.desc}</div>
                </div>
              </label>
            `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
    
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="btn-save">Save Permissions</button>
    </div>
  `,setTimeout(()=>{const g=m.querySelector("#base-role");g&&d(g,"change",()=>{const w=g.value,$=zr[w]||[];c=new Set($),ob(m,c)}),m.querySelectorAll('input[name="permission"]').forEach(w=>{d(w,"change",()=>{const $=w.value;w.checked?c.add($):c.delete($),ai(m)})}),m.querySelectorAll(".category-toggle").forEach(w=>{d(w,"click",()=>{const $=w.closest(".permission-category");if(!$)return;const M=$.querySelectorAll('input[name="permission"]'),q=Array.from(M).every(C=>C.checked);M.forEach(C=>{const S=C;S.checked=!q,q?c.delete(S.value):c.add(S.value)}),ai(m)})});const f=m.querySelector("#btn-cancel");f&&d(f,"click",()=>H(Aa));const b=m.querySelector("#btn-save");b&&d(b,"click",async()=>{const w=g?.value||i,$=Array.from(c);b.disabled=!0,b.textContent="Saving...";try{await p.put(`/api/projects/${t}/members/${n}/permissions`,{role:w,permissions:$}),u.success("Permissions updated"),H(Aa),r?.()}catch{u.error("Failed to update permissions"),b.disabled=!1,b.textContent="Save Permissions"}})},0);const v=fe({id:Aa,title:"Member Permissions",content:m,size:"lg"});document.body.appendChild(v),he(Aa)}function ob(e,t){e.querySelectorAll('input[name="permission"]').forEach(n=>{const a=n;a.checked=t.has(a.value)}),ai(e)}function ai(e){e.querySelectorAll(".permission-item").forEach(t=>{const n=t.querySelector('input[name="permission"]');t.classList.toggle("selected",n?.checked||!1)})}function ib(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function Br(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Rn="project-modal";let Ge={mode:"create"},Ye=null,He=[],an=[],si=null,oi=[];function ln(e){Ge=e,Ye=e.project||null;const t=rb(e.mode),n=fe({id:Rn,title:"",size:"lg",content:t}),a=n.querySelector(".modal-content");a&&(a.style.cssText="background: transparent; box-shadow: none; padding: 0; max-width: 800px;");const s=n.querySelector(".modal-header");s&&(s.style.display="none"),document.body.appendChild(n),he(Rn),e.mode==="edit"&&e.project?.id?cb(t,e.project.id):lb(t)}function rb(e){const t=x("div",{className:"project-modal-sota"});return t.innerHTML=`
    <style>
      .project-modal-sota {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      .project-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
        overflow: hidden;
      }
      
      [data-theme="dark"] .project-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(15,23,42,0.95) 100%);
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      
      .project-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 32px;
        position: relative;
        overflow: hidden;
      }
      
      .project-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
      }
      
      .project-header-content {
        display: flex;
        align-items: center;
        gap: 20px;
        position: relative;
        z-index: 1;
      }
      
      .project-icon-large {
        width: 72px;
        height: 72px;
        border-radius: 18px;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid rgba(255,255,255,0.3);
        flex-shrink: 0;
      }
      
      .project-icon-large svg {
        width: 36px;
        height: 36px;
        color: white;
      }
      
      .project-title-info h2 {
        margin: 0 0 4px 0;
        font-size: 24px;
        font-weight: 700;
        color: white;
      }
      
      .project-title-info p {
        margin: 0;
        color: rgba(255,255,255,0.8);
        font-size: 14px;
      }
      
      .project-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
      }
      
      .project-close-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
      }
      
      .project-close-btn svg {
        width: 20px;
        height: 20px;
        color: white;
      }
      
      .project-tabs-nav {
        display: flex;
        gap: 0;
        padding: 0 24px;
        background: rgba(0,0,0,0.02);
        border-bottom: 1px solid rgba(0,0,0,0.06);
        overflow-x: auto;
      }
      
      [data-theme="dark"] .project-tabs-nav {
        background: rgba(255,255,255,0.02);
        border-bottom-color: rgba(255,255,255,0.06);
      }
      
      .project-tab-btn {
        padding: 16px 20px;
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .project-tab-btn:hover {
        color: #1e293b;
      }
      
      [data-theme="dark"] .project-tab-btn:hover {
        color: #e2e8f0;
      }
      
      .project-tab-btn.active {
        color: #e11d48;
      }
      
      .project-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 20px;
        right: 20px;
        height: 2px;
        background: #e11d48;
        border-radius: 2px 2px 0 0;
      }
      
      .project-tab-icon {
        width: 18px;
        height: 18px;
      }
      
      .project-body {
        padding: 32px;
        max-height: 60vh;
        overflow-y: auto;
      }
      
      .project-section {
        display: none;
      }
      
      .project-section.active {
        display: block;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
      
      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      [data-theme="dark"] .form-field label {
        color: #94a3b8;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s;
        outline: none;
      }
      
      [data-theme="dark"] .form-field input,
      [data-theme="dark"] .form-field select,
      [data-theme="dark"] .form-field textarea {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .form-field input:disabled {
        background: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
      }
      
      .form-field textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .form-hint {
        font-size: 12px;
        color: #94a3b8;
      }
      
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(0,0,0,0.06);
      }
      
      [data-theme="dark"] .form-actions {
        border-top-color: rgba(255,255,255,0.06);
      }
      
      .btn-sota {
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-sota.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .btn-sota.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-sota.secondary {
        background: #f1f5f9;
        color: #475569;
      }
      
      [data-theme="dark"] .btn-sota.secondary {
        background: rgba(255,255,255,0.1);
        color: #e2e8f0;
      }
      
      .btn-sota.secondary:hover {
        background: #e2e8f0;
      }
      
      .btn-sota.danger {
        background: transparent;
        color: #dc2626;
        border: 1px solid #fecaca;
      }
      
      .btn-sota.danger:hover {
        background: #fef2f2;
        border-color: #dc2626;
      }
      
      .btn-sota.small {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      /* Section Headers */
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      
      .section-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      [data-theme="dark"] .section-header h3 {
        color: #f1f5f9;
      }
      
      .section-header h3 svg {
        width: 20px;
        height: 20px;
        color: #e11d48;
      }
      
      /* Members List */
      .members-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .member-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid transparent;
        transition: all 0.2s;
      }
      
      [data-theme="dark"] .member-card {
        background: rgba(255,255,255,0.03);
      }
      
      .member-card:hover {
        border-color: #e2e8f0;
      }
      
      .member-card.owner {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
      }
      
      .member-info {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      
      .member-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }
      
      .member-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .member-details h4 {
        margin: 0 0 4px 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
      }
      
      [data-theme="dark"] .member-details h4 {
        color: #f1f5f9;
      }
      
      .member-details p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
      }
      
      .member-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .role-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .role-badge.owner {
        background: #e11d48;
        color: white;
      }
      
      .role-badge.admin {
        background: #8b5cf6;
        color: white;
      }
      
      .role-badge.write {
        background: #0ea5e9;
        color: white;
      }
      
      .role-badge.read {
        background: #64748b;
        color: white;
      }
      
      .role-select {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 13px;
        background: white;
        cursor: pointer;
      }
      
      [data-theme="dark"] .role-select {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      /* Role Templates List */
      .roles-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .role-card {
        padding: 20px;
        background: #f8fafc;
        border-radius: 16px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      [data-theme="dark"] .role-card {
        background: rgba(255,255,255,0.03);
      }
      
      .role-card:hover {
        border-color: #e2e8f0;
        transform: translateY(-2px);
      }
      
      .role-card.active {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
      }
      
      .role-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      
      .role-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .role-icon svg {
        width: 20px;
        height: 20px;
        color: white;
      }
      
      .role-card h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
      }
      
      [data-theme="dark"] .role-card h4 {
        color: #f1f5f9;
      }
      
      .role-card p {
        margin: 0;
        font-size: 13px;
        color: #64748b;
        line-height: 1.5;
      }
      
      .role-card .toggle-active {
        margin-top: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #64748b;
      }
      
      /* Config Section */
      .config-group {
        margin-bottom: 32px;
      }
      
      .config-group h4 {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      [data-theme="dark"] .config-group h4 {
        color: #f1f5f9;
      }
      
      .config-group h4 svg {
        width: 16px;
        height: 16px;
        color: #e11d48;
      }
      
      .api-key-field {
        display: flex;
        gap: 12px;
      }
      
      .api-key-field input {
        flex: 1;
      }
      
      .api-key-field .btn-sota {
        flex-shrink: 0;
      }
      
      /* Danger Zone */
      .danger-zone {
        background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
        border: 1px solid #fecaca;
        border-radius: 16px;
        padding: 24px;
        margin-top: 32px;
      }
      
      [data-theme="dark"] .danger-zone {
        background: linear-gradient(135deg, rgba(220,38,38,0.1) 0%, rgba(220,38,38,0.05) 100%);
        border-color: rgba(220,38,38,0.3);
      }
      
      .danger-zone h3 {
        color: #dc2626 !important;
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .danger-zone h3 svg {
        width: 18px;
        height: 18px;
      }
      
      .danger-zone p {
        color: #991b1b;
        font-size: 14px;
        margin: 0 0 16px 0;
      }
      
      [data-theme="dark"] .danger-zone p {
        color: #fca5a5;
      }
      
      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #94a3b8;
      }
      
      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      
      .empty-state p {
        margin: 0 0 16px 0;
      }
      
      /* Loading */
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 48px;
      }
      
      .loading-spinner::after {
        content: '';
        width: 32px;
        height: 32px;
        border: 3px solid #e2e8f0;
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Responsive */
      @media (max-width: 640px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
        
        .roles-grid {
          grid-template-columns: 1fr;
        }
        
        .project-tabs-nav {
          padding: 0 16px;
        }
        
        .project-tab-btn {
          padding: 14px 16px;
        }
      }
    </style>
    
    <div class="project-card">
      <div class="loading-spinner"></div>
    </div>
  `,t}async function cb(e,t){const n=e.querySelector(".project-card");if(n)try{const[a,s,o,i,r]=await Promise.all([p.get(`/api/projects/${t}`).catch(()=>null),p.get(`/api/projects/${t}/members`).catch(()=>({data:{members:[]}})),p.get("/api/role-templates").catch(()=>({data:{roles:[]}})),p.get(`/api/projects/${t}/config`).catch(()=>({data:{config:null}})),p.get("/api/contacts").catch(()=>({data:{contacts:[]}}))]);a?.data?.project&&(Ye=a.data.project),He=s?.data?.members||[],an=o?.data?.roles||[],si=i?.data?.config||null;const c=r?.data;oi=Array.isArray(c)?c:c?.contacts||[],Ir(n)}catch{Ir(n)}}function lb(e){const t=e.querySelector(".project-card");t&&(t.innerHTML=`
    <!-- Header -->
    <div class="project-header">
      <button class="project-close-btn" id="close-project-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="project-header-content">
        <div class="project-icon-large">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
        </div>
        <div class="project-title-info">
          <h2>New Project</h2>
          <p>Create a new project to organize your work</p>
        </div>
      </div>
    </div>
    
    <!-- Form -->
    <div class="project-body">
      <form id="project-form">
        <div class="form-grid">
          <div class="form-field full-width">
            <label>
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
              </svg>
              Project Name *
            </label>
            <input type="text" name="name" required placeholder="Enter project name">
          </div>
          
          <div class="form-field full-width">
            <label>
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
              </svg>
              Description
            </label>
            <textarea name="description" placeholder="Brief description of the project"></textarea>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-sota secondary" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn-sota primary">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Create Project
          </button>
        </div>
      </form>
    </div>
  `,db(t))}function Ir(e){const t=Ye||Ge.project;if(!t)return;const n=t.settings||{};e.innerHTML=`
    <!-- Header -->
    <div class="project-header">
      <button class="project-close-btn" id="close-project-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="project-header-content">
        <div class="project-icon-large">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
        </div>
        <div class="project-title-info">
          <h2>${ge(t.name)}</h2>
          <p>${t.description?ge(t.description):"No description"}</p>
        </div>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <nav class="project-tabs-nav">
      <button class="project-tab-btn active" data-tab="general">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        General
      </button>
      <button class="project-tab-btn" data-tab="members">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        Members
        <span class="badge">${He.length}</span>
      </button>
      <button class="project-tab-btn" data-tab="roles">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        Roles
      </button>
      <button class="project-tab-btn" data-tab="config">
        <svg class="project-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
        </svg>
        Config
      </button>
    </nav>
    
    <!-- Tab Content -->
    <div class="project-body">
      <!-- General Tab -->
      <div class="project-section active" id="section-general">
        <form id="project-form">
          <div class="form-grid">
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                Project Name *
              </label>
              <input type="text" name="name" required value="${ge(t.name)}" placeholder="Enter project name">
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                </svg>
                Description
              </label>
              <textarea name="description" placeholder="Brief description of the project">${ge(t.description||"")}</textarea>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Your Role
              </label>
              <input type="text" name="userRole" value="${ge(n.userRole||"")}" placeholder="e.g., Project Manager, Tech Lead">
              <span class="form-hint">Your role in this project (used for AI context)</span>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                Role Prompt
              </label>
              <input type="text" name="userRolePrompt" value="${ge(n.userRolePrompt||"")}" placeholder="e.g., I manage the project timeline">
              <span class="form-hint">Brief description of your responsibilities</span>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-sota primary">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save Changes
            </button>
          </div>
        </form>
        
        <!-- Danger Zone -->
        <div class="danger-zone">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Danger Zone
          </h3>
          <p>Deleting a project will permanently remove all associated data including questions, decisions, risks, and contacts.</p>
          <button type="button" class="btn-sota danger" id="delete-project-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Project
          </button>
        </div>
      </div>
      
      <!-- Members Tab -->
      <div class="project-section" id="section-members">
        <div class="section-header">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            Team Members
          </h3>
          <button class="btn-sota primary small" id="invite-member-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
            </svg>
            Invite
          </button>
        </div>
        
        <div class="members-list" id="members-list">
          ${ya()}
        </div>
      </div>
      
      <!-- Roles Tab -->
      <div class="project-section" id="section-roles">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            Available Roles
          </h3>
          <button class="btn-sota primary small" id="add-role-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Role
          </button>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">
          Select which roles are available for team members in this project.
        </p>
        
        <div class="roles-grid" id="roles-grid">
          ${El()}
        </div>
      </div>
      
      <!-- Config Tab -->
      <div class="project-section" id="section-config">
        <div class="section-header">
          <h3>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
            Project Configuration
          </h3>
        </div>
        <p style="color: #64748b; font-size: 14px; margin-bottom: 24px;">
          Override system defaults with project-specific API keys. Leave empty to use system defaults.
        </p>
        
        <form id="config-form">
          <!-- LLM Per-Task Configuration -->
          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
              </svg>
              LLM Model Selection
            </h4>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">
              Override system defaults for each task type. Uncheck to use platform defaults.
            </p>
            
            <!-- Text -->
            <div class="llm-task-override">
              <div class="task-header-inline">
                <label class="checkbox-inline">
                  <input type="checkbox" name="use_system_text" ${dt("llm_pertask.useSystemDefaults.text")!=="false"?"checked":""}>
                  <span class="task-icon">üìù</span> Text / Chat
                </label>
                <span class="system-hint">(Use system default)</span>
              </div>
              <div class="task-override-fields ${dt("llm_pertask.useSystemDefaults.text")!=="false"?"disabled":""}">
                <select name="text_provider" class="form-control" disabled>
                  <option value="">Loading...</option>
                </select>
                <select name="text_model" class="form-control" disabled>
                  <option value="">Select provider first</option>
                </select>
              </div>
            </div>
            
            <!-- Vision -->
            <div class="llm-task-override">
              <div class="task-header-inline">
                <label class="checkbox-inline">
                  <input type="checkbox" name="use_system_vision" ${dt("llm_pertask.useSystemDefaults.vision")!=="false"?"checked":""}>
                  <span class="task-icon">üëÅÔ∏è</span> Vision
                </label>
                <span class="system-hint">(Use system default)</span>
              </div>
              <div class="task-override-fields ${dt("llm_pertask.useSystemDefaults.vision")!=="false"?"disabled":""}">
                <select name="vision_provider" class="form-control" disabled>
                  <option value="">Loading...</option>
                </select>
                <select name="vision_model" class="form-control" disabled>
                  <option value="">Select provider first</option>
                </select>
              </div>
            </div>
            
            <!-- Embeddings -->
            <div class="llm-task-override">
              <div class="task-header-inline">
                <label class="checkbox-inline">
                  <input type="checkbox" name="use_system_embeddings" ${dt("llm_pertask.useSystemDefaults.embeddings")!=="false"?"checked":""}>
                  <span class="task-icon">üîó</span> Embeddings
                </label>
                <span class="system-hint">(Use system default)</span>
              </div>
              <div class="task-override-fields ${dt("llm_pertask.useSystemDefaults.embeddings")!=="false"?"disabled":""}">
                <select name="embeddings_provider" class="form-control" disabled>
                  <option value="">Loading...</option>
                </select>
                <select name="embeddings_model" class="form-control" disabled>
                  <option value="">Select provider first</option>
                </select>
              </div>
            </div>
          </div>

          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
              </svg>
              Google Drive Storage
            </h4>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">
              Configure per-project Google Drive storage (Service Account). This keeps files portable and avoids local filesystem paths.
            </p>

            <div class="llm-task-override" style="padding: 16px; border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 12px; background: rgba(15, 23, 42, 0.02);">
              <div class="task-header-inline" style="margin-bottom: 12px;">
                <label class="checkbox-inline" style="gap: 10px;">
                  <input type="checkbox" id="gdrive-enabled" ${n.googleDrive?.enabled?"checked":""}>
                  <span class="task-icon">üìÅ</span> Enable Google Drive for this project
                </label>
              </div>

              <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-field full-width">
                  <label>Platform Google Drive</label>
                  <div style="font-size: 13px; color: #64748b; line-height: 1.4;">
                    Google Drive is configured at platform level by a superadmin. This project can only <b>Test</b> the connection and <b>Bootstrap</b> its folder structure.
                  </div>
                </div>
              </div>

              <div class="form-actions" style="justify-content: flex-start; gap: 10px; margin-top: 8px;">
                <button type="button" class="btn-sota secondary" id="gdrive-test-btn">Test</button>
                <button type="button" class="btn-sota secondary" id="gdrive-bootstrap-btn">Bootstrap Folders</button>
              </div>
            </div>
          </div>

          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
              </svg>
              LLM API Keys
            </h4>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">
              Override system API keys for this project. Leave empty to use system defaults.
            </p>
            
            <div class="form-grid">
              <div class="form-field">
                <label>OpenAI API Key</label>
                <input type="password" name="openai_key" placeholder="sk-..." value="${ge(dt("llm_config.openai_key"))}">
              </div>
              
              <div class="form-field">
                <label>Anthropic API Key</label>
                <input type="password" name="anthropic_key" placeholder="sk-ant-..." value="${ge(dt("llm_config.anthropic_key"))}">
              </div>
              
              <div class="form-field">
                <label>Google AI API Key</label>
                <input type="password" name="google_key" placeholder="AI..." value="${ge(dt("llm_config.google_key"))}">
              </div>
              
              <div class="form-field">
                <label>xAI (Grok) API Key</label>
                <input type="password" name="grok_key" placeholder="xai-..." value="${ge(dt("llm_config.grok_key"))}">
              </div>
            </div>
          </div>
          
          <div class="config-group">
            <h4>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
              </svg>
              Ollama Configuration
            </h4>
            
            <div class="form-grid">
              <div class="form-field">
                <label>Ollama URL</label>
                <input type="url" name="ollama_url" placeholder="http://localhost:11434" value="${ge(dt("ollama_config.url"))}">
              </div>
              
              <div class="form-field">
                <label>Default Model</label>
                <input type="text" name="ollama_model" placeholder="llama2, mistral, etc." value="${ge(dt("ollama_config.model"))}">
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-sota primary">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save Configuration
            </button>
          </div>
        </form>
      </div>
    </div>
  `,pb(e)}function ya(){return He.length===0?`
      <div class="empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <p>No team members yet</p>
        <button class="btn-sota primary small" id="invite-first-btn">Invite Member</button>
      </div>
    `:He.map(e=>{const t=fb(e.display_name||e.email||"U"),n=e.role==="owner";return`
      <div class="member-card ${n?"owner":""}" data-user-id="${e.user_id}">
        <div class="member-info">
          <div class="member-avatar">
            ${e.avatar_url?`<img src="${e.avatar_url}" alt="${ge(e.display_name||"")}">`:t}
          </div>
          <div class="member-details">
            <h4>${ge(e.display_name||e.email||"Unknown")}</h4>
            <p>
              ${ge(e.email||"")}
              ${e.user_role?` ‚Ä¢ <strong>${ge(e.user_role)}</strong>`:' ‚Ä¢ <em style="opacity: 0.6">No role defined</em>'}
              ${e.linked_contact?` ‚Ä¢ <span style="color: #e11d48;" title="Linked to contact: ${ge(e.linked_contact.name)}">üîó ${ge(e.linked_contact.name)}</span>`:""}
            </p>
          </div>
        </div>
        <div class="member-actions">
          <button class="btn-sota secondary small edit-user-role-btn" data-user-id="${e.user_id}" title="Edit project role">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </button>
          <button class="btn-sota secondary small permissions-btn" data-user-id="${e.user_id}" title="Edit permissions" style="font-size: 14px;">
            üîê
          </button>
          ${n?'<span class="role-badge owner">Owner</span>':`
              <select class="role-select member-role-select" data-user-id="${e.user_id}" title="Access level">
                <option value="admin" ${e.role==="admin"?"selected":""}>Admin</option>
                <option value="write" ${e.role==="write"?"selected":""}>Write</option>
                <option value="read" ${e.role==="read"?"selected":""}>Read</option>
              </select>
              <button class="btn-sota danger small remove-member-btn" data-user-id="${e.user_id}" title="Remove member">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            `}
        </div>
      </div>
    `}).join("")}function El(){return an.length===0?`
      <div class="empty-state" style="grid-column: 1 / -1;">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        <p>No role templates available</p>
      </div>
    `:an.map(e=>`
    <div class="role-card ${e.is_active?"active":""}" data-role-id="${e.id}">
      <div class="role-card-header">
        <div class="role-icon">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        </div>
        <h4>${ge(e.display_name)}</h4>
      </div>
      <p>${ge(e.description||"No description")}</p>
      <div class="toggle-active">
        <input type="checkbox" id="role-${e.id}" ${e.is_active?"checked":""}>
        <label for="role-${e.id}">Active in this project</label>
      </div>
    </div>
  `).join("")}function dt(e){if(!si)return"";const t=e.split(".");let n=si;for(const a of t)if(n&&typeof n=="object"&&a in n)n=n[a];else return"";return typeof n=="string"?n:""}function db(e){const t=e.querySelector("#close-project-btn");t&&d(t,"click",()=>H(Rn));const n=e.querySelector("#cancel-btn");n&&d(n,"click",()=>H(Rn));const a=e.querySelector("#project-form");a&&d(a,"submit",async s=>{s.preventDefault();const o=new FormData(a),i={name:o.get("name").trim(),description:o.get("description").trim()||void 0},r=a.querySelector('button[type="submit"]');r.disabled=!0,r.innerHTML='<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Creating...';try{const c=await p.post("/api/projects",i);i.id=c.data.id,u.success("Project created"),P.setCurrentProject({id:i.id,name:i.name,description:i.description}),Ge.onSave?.(i),H(Rn),_l()}catch{u.error("Failed to create project")}finally{r.disabled=!1,r.innerHTML=`
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create Project
        `}})}function pb(e){const t=e.querySelector("#close-project-btn");t&&d(t,"click",()=>H(Rn));const n=e.querySelectorAll(".project-tab-btn");n.forEach(f=>{d(f,"click",()=>{n.forEach(w=>w.classList.remove("active")),f.classList.add("active");const b=f.getAttribute("data-tab");e.querySelectorAll(".project-section").forEach(w=>{w.classList.toggle("active",w.id===`section-${b}`)})})});const a=e.querySelector("#project-form");a&&d(a,"submit",async f=>{f.preventDefault();const b=new FormData(a),w={name:b.get("name").trim(),description:b.get("description").trim()||void 0,settings:{userRole:b.get("userRole").trim()||void 0,userRolePrompt:b.get("userRolePrompt").trim()||void 0}};try{await p.put(`/api/projects/${Ye?.id||Ge.project?.id}`,w),u.success("Project updated"),Ge.onSave?.({...Ye,...w});const $=e.querySelector(".project-title-info h2"),M=e.querySelector(".project-title-info p");$&&($.textContent=w.name),M&&(M.textContent=w.description||"No description")}catch{u.error("Failed to update project")}});const s=e.querySelector("#delete-project-btn");s&&d(s,"click",async()=>{const f=Ye||Ge.project;if(!f?.id)return;if(await Ln(`Are you sure you want to delete "${f.name}"? This action cannot be undone.`,{title:"Delete Project",confirmText:"Delete",confirmClass:"btn-danger"}))try{await p.delete(`/api/projects/${f.id}`),u.success("Project deleted"),Ge.onDelete?.(f.id),H(Rn),P.getState().currentProjectId===f.id&&P.setCurrentProject(null),_l()}catch{u.error("Failed to delete project")}});const o=e.querySelector("#invite-member-btn"),i=e.querySelector("#invite-first-btn");[o,i].forEach(f=>{f&&d(f,"click",()=>{gb()})});const r=e.querySelector("#add-role-btn");r&&d(r,"click",()=>{ub(e)}),e.querySelectorAll(".member-role-select").forEach(f=>{d(f,"change",async()=>{const b=f.getAttribute("data-user-id"),w=f.value,$=Ye?.id||Ge.project?.id;if(!(!b||!$))try{await p.put(`/api/projects/${$}/members/${b}`,{role:w}),u.success("Member role updated")}catch{u.error("Failed to update role")}})}),e.querySelectorAll(".remove-member-btn").forEach(f=>{d(f,"click",async()=>{const b=f.getAttribute("data-user-id"),w=Ye?.id||Ge.project?.id;if(!b||!w)return;if(await Ln("Remove this member from the project?",{title:"Remove Member",confirmText:"Remove",confirmClass:"btn-danger"}))try{await p.delete(`/api/projects/${w}/members/${b}`),u.success("Member removed"),He=He.filter(q=>q.user_id!==b);const M=e.querySelector("#members-list");M&&(M.innerHTML=ya(),xa(e))}catch{u.error("Failed to remove member")}})});const c=e.querySelector("#gdrive-test-btn"),l=e.querySelector("#gdrive-bootstrap-btn"),m=()=>Ye?.id||Ge.project?.id;async function v(){const f=m();if(f&&!gdriveDirty)try{const b=await p.get(`/api/projects/${f}/google-drive`),w=e.querySelector("#gdrive-enabled"),$=e.querySelector("#gdrive-root-folder");w&&(w.checked=!!b.data.googleDrive?.enabled),$&&($.value=b.data.googleDrive?.rootFolderId||"")}catch{}}v(),c&&d(c,"click",async()=>{const f=m();if(f)try{await p.post(`/api/projects/${f}/google-drive/test`,{}),u.success("Google Drive connection OK")}catch{u.error("Google Drive test failed")}}),l&&d(l,"click",async()=>{const f=m();if(f)try{gdriveDirty=!1,await p.post(`/api/projects/${f}/google-drive/bootstrap`,{}),u.success("Google Drive folders created"),await v()}catch{u.error("Failed to bootstrap Google Drive folders")}});const g=e.querySelector("#config-form");g&&d(g,"submit",async f=>{f.preventDefault();const b=new FormData(g),w={llm_config:{openai_key:b.get("openai_key")||void 0,anthropic_key:b.get("anthropic_key")||void 0,google_key:b.get("google_key")||void 0,grok_key:b.get("grok_key")||void 0},ollama_config:{url:b.get("ollama_url")||void 0,model:b.get("ollama_model")||void 0}},$=m();if($)try{await p.put(`/api/projects/${$}/config`,w),u.success("Configuration saved")}catch{u.error("Failed to save configuration")}}),xa(e)}function xa(e){e.querySelectorAll(".edit-user-role-btn").forEach(t=>{d(t,"click",()=>{const n=t.getAttribute("data-user-id");if(!n)return;const a=He.find(s=>s.user_id===n);a&&mb(e,a)})}),e.querySelectorAll(".permissions-btn").forEach(t=>{d(t,"click",()=>{const n=t.getAttribute("data-user-id");if(!n)return;const a=He.find(o=>o.user_id===n),s=Ye?.id||Ge.project?.id;!a||!s||Al({projectId:s,userId:a.user_id,userName:a.display_name||"",userEmail:a.email||"",avatarUrl:a.avatar_url,currentRole:a.role,currentPermissions:a.permissions,onSave:async()=>{try{He=(await p.get(`/api/projects/${s}/members`)).data.members||[];const i=e.querySelector("#members-list");i&&(i.innerHTML=ya(),xa(e))}catch{}}})})}),e.querySelectorAll(".member-role-select").forEach(t=>{d(t,"change",async()=>{const n=t.getAttribute("data-user-id"),a=t.value,s=Ye?.id||Ge.project?.id;if(!(!n||!s))try{await p.put(`/api/projects/${s}/members/${n}`,{role:a}),u.success("Access level updated")}catch{u.error("Failed to update access level")}})}),e.querySelectorAll(".remove-member-btn").forEach(t=>{d(t,"click",async()=>{const n=t.getAttribute("data-user-id"),a=Ye?.id||Ge.project?.id;if(!n||!a)return;if(await Ln("Remove this member from the project?",{title:"Remove Member",confirmText:"Remove",confirmClass:"btn-danger"}))try{await p.delete(`/api/projects/${a}/members/${n}`),u.success("Member removed"),He=He.filter(i=>i.user_id!==n);const o=e.querySelector("#members-list");o&&(o.innerHTML=ya(),xa(e))}catch{u.error("Failed to remove member")}})})}function ub(e){const t=e.querySelector(".add-role-dialog");t&&t.remove();const n=Ye?.id||Ge.project?.id;if(!n)return;const a=x("div",{className:"add-role-dialog"});a.innerHTML=`
    <style>
      .add-role-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        backdrop-filter: blur(4px);
      }
      
      .add-role-card {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        overflow: hidden;
      }
      
      [data-theme="dark"] .add-role-card {
        background: #1e293b;
      }
      
      .add-role-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 20px 24px;
        color: white;
      }
      
      .add-role-header h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
      }
      
      .add-role-body {
        padding: 24px;
      }
      
      .add-role-field {
        margin-bottom: 20px;
      }
      
      .add-role-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 8px;
      }
      
      .add-role-field input,
      .add-role-field textarea,
      .add-role-field select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        box-sizing: border-box;
        background: #f8fafc;
      }
      
      [data-theme="dark"] .add-role-field input,
      [data-theme="dark"] .add-role-field textarea,
      [data-theme="dark"] .add-role-field select {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .add-role-field input:focus,
      .add-role-field textarea:focus,
      .add-role-field select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
      }
      
      .add-role-field textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .add-role-ai-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: all 0.2s;
      }
      
      .add-role-ai-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139,92,246,0.3);
      }
      
      .add-role-ai-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      .add-role-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
      }
      
      [data-theme="dark"] .add-role-actions {
        border-color: rgba(255,255,255,0.1);
      }
    </style>
    
    <div class="add-role-card">
      <div class="add-role-header">
        <h4>Add New Role</h4>
      </div>
      <div class="add-role-body">
        <form id="add-role-form">
          <div class="add-role-field">
            <label>Role Name *</label>
            <input type="text" id="new-role-name" required placeholder="e.g., Senior Developer, Tech Lead">
          </div>
          
          <div class="add-role-field">
            <label>Category</label>
            <select id="new-role-category">
              <option value="project">üìã Project</option>
              <option value="technical">üíª Technical</option>
              <option value="management">üëî Management</option>
              <option value="stakeholder">ü§ù Stakeholder</option>
              <option value="custom">‚ú® Custom</option>
            </select>
          </div>
          
          <div class="add-role-field">
            <label>Description</label>
            <input type="text" id="new-role-description" placeholder="Brief description of this role">
          </div>
          
          <div class="add-role-field">
            <label>Role Context (for AI)</label>
            <textarea id="new-role-context" placeholder="Describe this role's responsibilities, priorities, and how the AI should adapt responses..."></textarea>
            <button type="button" class="add-role-ai-btn" id="enhance-role-btn">
              ‚ö° Enhance with AI
            </button>
          </div>
          
          <div class="add-role-actions">
            <button type="button" class="btn-sota secondary" id="cancel-add-role">Cancel</button>
            <button type="submit" class="btn-sota primary">Create Role</button>
          </div>
        </form>
      </div>
    </div>
  `,e.appendChild(a);const s=()=>a.remove(),o=a.querySelector("#cancel-add-role");o&&d(o,"click",s),d(a,"click",c=>{c.target===a&&s()});const i=a.querySelector("#enhance-role-btn");i&&d(i,"click",async()=>{const c=a.querySelector("#new-role-name"),l=a.querySelector("#new-role-context"),m=a.querySelector("#new-role-description"),v=c.value.trim();if(!v){u.error("Please enter a role name first");return}i.disabled=!0,i.textContent="‚è≥ Enhancing...";try{const g=await p.post("/api/roles/generate",{title:v,currentContext:l.value});g.data.prompt&&(l.value=g.data.prompt),g.data.description&&!m.value&&(m.value=g.data.description),u.success("Role context enhanced")}catch{u.error("Failed to enhance with AI")}finally{i.disabled=!1,i.textContent="‚ö° Enhance with AI"}});const r=a.querySelector("#add-role-form");r&&d(r,"submit",async c=>{c.preventDefault();const l=a.querySelector("#new-role-name").value.trim(),m=a.querySelector("#new-role-category").value,v=a.querySelector("#new-role-description").value.trim(),g=a.querySelector("#new-role-context").value.trim();if(!l){u.error("Role name is required");return}try{await p.post("/api/role-templates",{name:l.toLowerCase().replace(/\s+/g,"_"),display_name:l,description:v,role_context:g,category:m,color:"#e11d48",is_template:!0}),u.success("Role created"),s(),await vb(n);const f=e.querySelector("#roles-grid");f&&(f.innerHTML=El())}catch{u.error("Failed to create role")}}),setTimeout(()=>{const c=a.querySelector("#new-role-name");c&&c.focus()},100)}function mb(e,t){const n=e.querySelector(".user-role-edit-dialog");n&&n.remove();const a=Ye?.id||Ge.project?.id;if(!a)return;const s=x("div",{className:"user-role-edit-dialog"});s.innerHTML=`
    <style>
      .user-role-edit-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        padding: 24px;
        z-index: 10001;
        width: 400px;
        max-width: 90vw;
      }
      
      [data-theme="dark"] .user-role-edit-dialog {
        background: #1e293b;
      }
      
      .user-role-edit-dialog h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      [data-theme="dark"] .user-role-edit-dialog h3 {
        color: #f1f5f9;
      }
      
      .user-role-edit-dialog h3 svg {
        width: 20px;
        height: 20px;
        color: #e11d48;
      }
      
      .user-role-edit-dialog .form-field {
        margin-bottom: 16px;
      }
      
      .user-role-edit-dialog .form-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 6px;
      }
      
      [data-theme="dark"] .user-role-edit-dialog .form-field label {
        color: #94a3b8;
      }
      
      .user-role-edit-dialog .form-field input,
      .user-role-edit-dialog .form-field textarea,
      .user-role-edit-dialog .form-field select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        background: #f8fafc;
        color: #1e293b;
        box-sizing: border-box;
      }
      
      [data-theme="dark"] .user-role-edit-dialog .form-field input,
      [data-theme="dark"] .user-role-edit-dialog .form-field textarea,
      [data-theme="dark"] .user-role-edit-dialog .form-field select {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .user-role-edit-dialog .form-field input:focus,
      .user-role-edit-dialog .form-field textarea:focus,
      .user-role-edit-dialog .form-field select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .user-role-edit-dialog .form-field textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .user-role-edit-dialog .form-hint {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
      }
      
      .user-role-edit-dialog .linked-contact-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
        border: 1px solid rgba(225,29,72,0.2);
        border-radius: 10px;
        margin-top: 8px;
      }
      
      .user-role-edit-dialog .linked-contact-info svg {
        width: 16px;
        height: 16px;
        color: #e11d48;
        flex-shrink: 0;
      }
      
      .user-role-edit-dialog .linked-contact-info span {
        font-size: 13px;
        color: #1e293b;
      }
      
      [data-theme="dark"] .user-role-edit-dialog .linked-contact-info span {
        color: #f1f5f9;
      }
      
      .user-role-edit-dialog .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      
      .user-role-edit-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 10000;
      }
    </style>
    
    <h3>
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      Edit Project Role
    </h3>
    <p style="color: #64748b; font-size: 14px; margin: 0 0 20px 0;">
      Define <strong>${ge(t.display_name||t.email||"this member")}</strong>'s role in the project
    </p>
    
    <div class="form-field">
      <label>Role Title</label>
      <select id="edit-user-role">
        <option value="">-- Select a role --</option>
        ${an.filter(f=>f.is_active).map(f=>`
          <option value="${ge(f.display_name||f.name)}" 
                  data-prompt="${ge(f.prompt_template||"")}"
                  ${t.user_role===f.display_name||t.user_role===f.name?"selected":""}>
            ${ge(f.display_name||f.name)}
          </option>
        `).join("")}
        <option value="__custom__" ${t.user_role&&!an.some(f=>f.display_name===t.user_role||f.name===t.user_role)?"selected":""}>Custom role...</option>
      </select>
      <div class="form-hint">Select a predefined role or choose "Custom role" for a custom title</div>
      <input type="text" id="edit-user-role-custom" 
             value="${t.user_role&&!an.some(f=>f.display_name===t.user_role||f.name===t.user_role)?ge(t.user_role):""}" 
             placeholder="Enter custom role title"
             style="margin-top: 8px; display: ${t.user_role&&!an.some(f=>f.display_name===t.user_role||f.name===t.user_role)?"block":"none"};">
    </div>
    
    <div class="form-field">
      <label>Role Description</label>
      <textarea id="edit-user-role-prompt" placeholder="e.g., I manage the technical architecture and lead the development team">${ge(t.user_role_prompt||"")}</textarea>
      <div class="form-hint">Brief description of responsibilities (used for AI context)</div>
    </div>
    
    <div class="form-field">
      <label>
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: inline; vertical-align: middle; margin-right: 4px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        Link to Contact
      </label>
      <select id="edit-linked-contact">
        <option value="">-- No linked contact --</option>
        ${oi.map(f=>`
          <option value="${f.id}" ${t.linked_contact_id===f.id?"selected":""}>
            ${ge(f.name)}${f.organization?` (${ge(f.organization)})`:""}${f.email?` - ${ge(f.email)}`:""}
          </option>
        `).join("")}
      </select>
      <div class="form-hint">Associate this team member with a project contact</div>
      ${t.linked_contact?`
        <div class="linked-contact-info">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
          </svg>
          <span>Currently linked to: <strong>${ge(t.linked_contact.name)}</strong></span>
        </div>
      `:""}
    </div>
    
    <div class="dialog-actions">
      <button class="btn-sota secondary" id="cancel-role-edit">Cancel</button>
      <button class="btn-sota primary" id="save-role-edit">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Save Role
      </button>
    </div>
  `;const o=x("div",{className:"user-role-edit-overlay"});document.body.appendChild(o),document.body.appendChild(s);const i=s.querySelector("#edit-user-role"),r=s.querySelector("#edit-user-role-custom"),c=s.querySelector("#edit-user-role-prompt");setTimeout(()=>i?.focus(),100),d(i,"change",()=>{const f=i.options[i.selectedIndex],b=i.value==="__custom__";r.style.display=b?"block":"none",b&&r.focus(),!b&&f.dataset.prompt&&(c.value=f.dataset.prompt)});const l=s.querySelector("#cancel-role-edit"),m=()=>{o.remove(),s.remove()};d(l,"click",m),d(o,"click",m);const v=s.querySelector("#save-role-edit");d(v,"click",async()=>{const f=i.value,b=f==="__custom__"?r.value.trim():f,w=s.querySelector("#edit-user-role-prompt").value.trim(),$=s.querySelector("#edit-linked-contact").value||null;try{await p.put(`/api/projects/${a}/members/${t.user_id}`,{user_role:b,user_role_prompt:w,linked_contact_id:$});const M=He.findIndex(C=>C.user_id===t.user_id);if(M!==-1)if(He[M].user_role=b,He[M].user_role_prompt=w,He[M].linked_contact_id=$||void 0,$){const C=oi.find(S=>S.id===$);C&&(He[M].linked_contact={id:C.id,name:C.name,email:C.email,organization:C.organization,role:C.role})}else He[M].linked_contact=void 0;const q=e.querySelector("#members-list");q&&(q.innerHTML=ya(),xa(e)),u.success("Project role updated"),m()}catch{u.error("Failed to update role")}});const g=f=>{f.key==="Escape"&&(m(),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g)}async function gb(){const{showInviteModal:e}=await Y(async()=>{const{showInviteModal:n}=await Promise.resolve().then(()=>Mx);return{showInviteModal:n}},void 0),t=Ye?.id||Ge.project?.id;t&&e({projectId:t,onInvite:async()=>{try{He=(await p.get(`/api/projects/${t}/members`)).data.members||[];const a=document.querySelector("#members-list");a&&(a.innerHTML=ya(),xa(a.closest(".project-card")))}catch{}}})}async function _l(){try{const e=await p.get("/api/projects");B.setProjects(e.data)}catch{}}async function vb(e){try{an=(await p.get("/api/role-templates")).data.roles||[]}catch{an=[]}}function fb(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function ge(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const hb=Object.freeze(Object.defineProperty({__proto__:null,showProjectModal:ln},Symbol.toStringTag,{value:"Module"}));function bb(e={}){const t=e.containerId?document.getElementById(e.containerId):document.getElementById("project-selector-container");if(!t)return;t.innerHTML=`
    <div class="project-selector-wrapper">
      <select id="project-selector" class="project-selector">
        <option value="">Select Project...</option>
      </select>
      <button id="new-project-btn" class="btn-icon" title="Create new project">+</button>
      <button id="edit-project-btn" class="btn-icon" title="Edit project" style="display: none;">‚úèÔ∏è</button>
    </div>
  `;const n=t.querySelector("#project-selector"),a=t.querySelector("#new-project-btn"),s=t.querySelector("#edit-project-btn");$s(n),d(n,"change",async()=>{const o=n.value;o?(await jl(o,e.onProjectChange),s.style.display=""):s.style.display="none"}),d(a,"click",()=>{ln({mode:"create",onSave:async o=>{await $s(n),o.id&&(n.value=o.id,s.style.display="",e.onProjectChange?.(o.id))}})}),d(s,"click",()=>{const o=P.getState().currentProject;o&&ln({mode:"edit",project:o,onSave:async()=>{await $s(n)},onDelete:async()=>{await $s(n),s.style.display="none"}})}),B.subscribe(o=>{Ns(n,o.projects)}),P.subscribe(o=>{o.currentProjectId&&n.value!==o.currentProjectId&&(n.value=o.currentProjectId,s.style.display="")})}async function $s(e){const t=await Cn.getAll();Ns(e,t);const n=P.getState().currentProjectId;n&&(e.value=n)}function Ns(e,t){const n=e.value;e.innerHTML='<option value="">Select Project...</option>',t.forEach(a=>{const s=document.createElement("option");s.value=a.id,s.textContent=a.name+(a.isDefault?" (default)":""),e.appendChild(s)}),n&&t.some(a=>a.id===n)&&(e.value=n)}async function jl(e,t){try{const n=await Cn.activate(e);n&&(u.success(`Switched to: ${n.name}`),t?.(e))}catch{u.error("Failed to switch project")}}function yb(e={}){const t=x("div",{className:"project-selector-wrapper"}),n=x("select",{className:"project-selector",id:"project-selector"}),a=x("option",{textContent:"Select Project..."});a.value="",n.appendChild(a);const s=x("button",{className:"btn-icon",textContent:"+",title:"Create new project"});return t.appendChild(n),t.appendChild(s),Cn.getAll().then(o=>{Ns(n,o);const i=P.getState().currentProjectId;i&&(n.value=i)}),d(n,"change",async()=>{const o=n.value;o&&await jl(o,e.onProjectChange)}),d(s,"click",()=>{ln({mode:"create",onSave:async o=>{const i=await Cn.getAll();Ns(n,i),o.id&&(n.value=o.id,e.onProjectChange?.(o.id))}})}),t}function Ja(e,t="en-US"){return new Intl.NumberFormat(t).format(e)}function Nn(e,t){return(typeof e=="string"?new Date(e):e).toLocaleDateString(void 0,t)}function Tn(e){return(typeof e=="string"?new Date(e):e).toLocaleString()}function J(e){const t=typeof e=="string"?new Date(e):e,n=new Date,a=n.getTime()-t.getTime(),s=Math.floor(a/1e3),o=Math.floor(s/60),i=Math.floor(o/60),r=Math.floor(i/24);if(a<0){const v=Math.ceil(Math.abs(a)/864e5);return v===0?"today":v===1?"tomorrow":v<7?`in ${v} days`:Nn(t,{month:"short",day:"numeric"})}if(s<60)return"just now";if(o<60)return`${o} min${o===1?"":"s"} ago`;if(i<24)return`${i} hour${i===1?"":"s"} ago`;const c=new Date(n);if(c.setDate(c.getDate()-1),xb(t,c))return"yesterday";const l=wb(n);if(t>=l)return"this week";const m=new Date(l);return m.setDate(m.getDate()-7),t>=m?"last week":r<30?`${r} days ago`:t.getFullYear()===n.getFullYear()?Nn(t,{month:"short",day:"numeric"}):Nn(t,{year:"numeric",month:"short",day:"numeric"})}function xb(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function wb(e){const t=new Date(e),n=t.getDay();return t.setDate(t.getDate()-n),t.setHours(0,0,0,0),t}function xs(e){if(e===0)return"0 B";const t=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,n)).toFixed(n>0?1:0)} ${t[n]}`}function Ht(e,t="USD",n="en-US"){return new Intl.NumberFormat(n,{style:"currency",currency:t}).format(e)}function Fs(e={}){const t=x("div",{className:"dashboard"});return t.innerHTML=`
    <!-- Row 1: Stats Cards -->
    <div class="dashboard-row">
      <div id="dashboard-stats-grid" class="stats-grid"></div>
    </div>

    <!-- Row 2: Insights (horizontal) -->
    <div id="dashboard-insights" class="dashboard-insights-row"></div>

    <!-- Row 3: Alerts if any -->
    <div id="dashboard-overdue" class="dashboard-overdue-section"></div>
    <div id="dashboard-alerts" class="dashboard-alerts-section"></div>

    <!-- Row 4: Daily Briefing (full width) -->
    <div class="dashboard-briefing-section" id="dashboard-briefing"></div>

    <!-- Row 5: Golden Hours (includes Team info) -->
    <div id="dashboard-golden-hours" class="dashboard-golden-hours-section"></div>

    <!-- Row 6: Charts (Questions priority, Facts by category, Trends) -->
    <div class="dashboard-charts-row">
      <div id="questions-chart" class="chart-container"></div>
      <div id="facts-chart" class="chart-container"></div>
      <div id="trends-chart" class="chart-container"></div>
    </div>

    <!-- Row 7: Bottom - Health + Risk Summary -->
    <div class="dashboard-bottom-row">
      <div id="dashboard-health" class="dashboard-health-card"></div>
      <div id="risk-summary-container" class="dashboard-risk-summary-card"></div>
    </div>
  `,kb(t,e),t}async function kb(e,t){const n=e.querySelector("#dashboard-health"),a=e.querySelector("#dashboard-briefing"),s=e.querySelector("#dashboard-stats-grid"),o=e.querySelector("#dashboard-overdue"),i=e.querySelector("#dashboard-alerts"),r=e.querySelector("#dashboard-insights"),c=e.querySelector("#risk-summary-container"),l=e.querySelector("#dashboard-golden-hours"),m=P.getState().currentProject,v=P.getState().currentProjectId;if(!m&&!v){if(s){s.innerHTML=`
        <div class="no-project-state" style="
          grid-column: 1 / -1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 64px 24px;
          text-align: center;
          background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
          border-radius: 16px;
          border: 2px dashed rgba(225,29,72,0.2);
          min-height: 300px;
        ">
          <svg width="80" height="80" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #e11d48; margin-bottom: 20px; opacity: 0.6;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <h2 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700; color: var(--text-primary);">No Project Selected</h2>
          <p style="margin: 0 0 24px 0; font-size: 15px; color: var(--text-secondary); max-width: 450px; line-height: 1.6;">
            Select a project from the dropdown in the header to view your dashboard, or create a new project to get started.
          </p>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary create-project-btn" style="
              padding: 12px 28px;
              font-size: 14px;
              font-weight: 600;
              display: inline-flex;
              align-items: center;
              gap: 8px;
            ">
              <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Create New Project
            </button>
          </div>
        </div>
      `;const g=s.querySelector(".create-project-btn");g&&g.addEventListener("click",async()=>{const{showProjectModal:f}=await Y(async()=>{const{showProjectModal:b}=await Promise.resolve().then(()=>hb);return{showProjectModal:b}},void 0);f({mode:"create",onSave:()=>{window.dispatchEvent(new CustomEvent("godmode:project-created"))}})})}n&&(n.innerHTML=""),a&&(a.innerHTML=""),o&&(o.innerHTML=""),i&&(i.innerHTML=""),r&&(r.innerHTML=""),c&&(c.innerHTML=""),l&&(l.innerHTML="");return}s&&(s.innerHTML='<div class="loading-placeholder">Loading dashboard...</div>'),a&&!a.hasChildNodes()&&Y(async()=>{const{createBriefingPanel:g}=await Promise.resolve().then(()=>H2);return{createBriefingPanel:g}},void 0).then(({createBriefingPanel:g})=>{const f=g();a.appendChild(f)}).catch(g=>console.error("Failed to load BriefingPanel:",g));try{const{dashboard:g,health:f,insights:b,alerts:w}=await Vi.loadAll();if(n&&f&&$b(n,f),s&&g&&Sb(s,g,t.onStatClick),o&&g&&g.overdueActions>0&&Eb(o,g.overdueActions),i&&w.length>0&&Cb(i,w,t.onAlertClick),r&&b.length>0&&Lb(r,b,t.onInsightAction),g&&(Tb(g),qb(g),Ab(g).catch($=>console.error("Failed to render trends chart:",$))),c&&!c.hasChildNodes()&&Ke.getAll().then($=>{Mb(c,$)}).catch($=>console.error("Failed to load Risk Summary:",$)),l&&!l.hasChildNodes()){const $=v||m?.id;$&&jb(l,$)}}catch(g){console.error("Failed to load dashboard:",g),s&&(s.innerHTML='<div class="error-message">Failed to load dashboard data</div>')}}function $b(e,t){if(!t||typeof t.status!="string"){e.innerHTML=`
      <div class="health-indicator unknown">
        <div class="health-gauge">
          <span class="score-value">--</span>
          <span class="score-label">Health</span>
        </div>
        <p class="health-status">Health data unavailable</p>
      </div>
    `;return}const n=t.status.toLowerCase().replace(/\s+/g,"-"),a=t.score??0,s=t.color||"#888",o=t.factors||[];e.innerHTML=`
    <div class="health-indicator ${n}">
      <div class="health-gauge">
        <div class="health-score" style="--score: ${a}%">
          <span class="score-value">${a}</span>
          <span class="score-label">Health</span>
        </div>
        <div class="health-bar">
          <div class="health-fill" style="width: ${a}%; background: ${s}"></div>
        </div>
      </div>
      <div class="health-status">
        <span class="status-text" style="color: ${s}">${t.status}</span>
      </div>
      <div class="health-factors">
        ${o.slice(0,3).map(i=>`
          <div class="factor ${i.type}">
            <span class="factor-icon">${i.type==="positive"?"‚úì":"!"}</span>
            <span class="factor-text">${i.factor}</span>
          </div>
        `).join("")}
      </div>
    </div>
  `}function Sb(e,t,n){t.documents;const a=t.questionsByPriority||{resolved:0},s=t.risksByImpact||{high:0},o=t.factsVerifiedCount??0,i=[{id:"facts",label:"Facts",value:t.totalFacts??0,sub:o>0?`${o} verified`:void 0,icon:"üí°"},{id:"questions",label:"Questions",value:t.totalQuestions??0,sub:`${a.resolved} resolved`,icon:"‚ùì"},{id:"decisions",label:"Decisions",value:t.totalDecisions??0,icon:"üéØ"},{id:"risks",label:"Risks",value:t.totalRisks??0,sub:`${s.high} high`,icon:"‚ö†Ô∏è"},{id:"actions",label:"Actions",value:t.totalActions??0,sub:`${t.overdueActions??0} overdue`,icon:"‚úÖ"}];e.innerHTML=i.map(r=>`
    <div class="stat-card" data-stat-id="${r.id}">
      <div class="stat-value">${r.value}</div>
      <div class="stat-label">${r.label}</div>
      ${r.sub?`<div class="stat-sub">${r.sub}</div>`:""}
    </div>
  `).join(""),n&&e.querySelectorAll(".stat-card[data-stat-id]").forEach(r=>{r.addEventListener("click",()=>{const c=r.getAttribute("data-stat-id");c&&n(c)})})}function Cb(e,t,n){e.innerHTML=`
    <div class="alerts-header">
      <h3>Alerts</h3>
      <span class="alerts-count">${t.length}</span>
    </div>
    <div class="alerts-list">
      ${t.slice(0,5).map((a,s)=>`
        <div class="alert-item ${a.severity}" data-alert-index="${s}">
          <span class="alert-icon">${_b(a.severity)}</span>
          <div class="alert-content">
            <div class="alert-title">${a.title}</div>
            <div class="alert-message">${a.message}</div>
          </div>
        </div>
      `).join("")}
    </div>
  `,n&&e.querySelectorAll(".alert-item").forEach(a=>{a.addEventListener("click",()=>{const s=parseInt(a.getAttribute("data-alert-index")||"0",10);n(t[s])})})}function Lb(e,t,n){e.innerHTML=t.slice(0,4).map((a,s)=>`
    <div class="insight-item ${a.type}" data-insight-index="${s}">
      <span class="insight-icon">${a.icon}</span>
      <div class="insight-content">
        <div class="insight-title">${a.title}</div>
        <div class="insight-message">${a.message}</div>
      </div>
    </div>
  `).join("")}function Mb(e,t){const n=(v,g)=>{const f=["low","medium","high","critical"].indexOf(v?.toLowerCase()||"low"),b=["low","medium","high"].indexOf(g?.toLowerCase()||"low"),w=f+b;return w>=4?"critical":w>=3?"high":w>=2?"medium":"low"},a=t.filter(v=>v.status!=="mitigated"&&v.status!=="closed"),s={critical:0,high:0,medium:0,low:0};a.forEach(v=>{const g=n(v.impact,v.likelihood);s[g]++});const o=a.length,i=t.length-a.length,r=v=>o>0?Math.round(v/o*100):0;let c="",l=0;const m={critical:"#ef4444",high:"#f97316",medium:"#eab308",low:"#22c55e"};["critical","high","medium","low"].forEach(v=>{const f=r(s[v])/100*360;f>0&&(c+=`${m[v]} ${l}deg ${l+f}deg, `,l+=f)}),c?c=c.slice(0,-2):c="var(--color-border) 0deg 360deg",e.innerHTML=`
    <div class="risk-summary">
      <div class="risk-summary-header">
        <h4>Risk Overview</h4>
        <span class="risk-total">${o} active</span>
      </div>
      
      <div class="risk-summary-content">
        <div class="risk-donut-container">
          <div class="risk-donut" style="background: conic-gradient(${c})">
            <div class="risk-donut-center">
              <span class="donut-value">${o}</span>
              <span class="donut-label">Risks</span>
            </div>
          </div>
        </div>
        
        <div class="risk-bars">
          <div class="risk-bar-item critical">
            <span class="bar-icon">üî¥</span>
            <span class="bar-label">Critical</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.critical)}%"></div></div>
            <span class="bar-count">${s.critical}</span>
          </div>
          <div class="risk-bar-item high">
            <span class="bar-icon">üü†</span>
            <span class="bar-label">High</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.high)}%"></div></div>
            <span class="bar-count">${s.high}</span>
          </div>
          <div class="risk-bar-item medium">
            <span class="bar-icon">üü°</span>
            <span class="bar-label">Medium</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.medium)}%"></div></div>
            <span class="bar-count">${s.medium}</span>
          </div>
          <div class="risk-bar-item low">
            <span class="bar-icon">üü¢</span>
            <span class="bar-label">Low</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.low)}%"></div></div>
            <span class="bar-count">${s.low}</span>
          </div>
        </div>
      </div>
      
      ${i>0?`
        <div class="risk-mitigated">
          <span class="mitigated-icon">‚úì</span>
          <span>${i} risk${i>1?"s":""} mitigated</span>
        </div>
      `:""}
    </div>
  `}function qb(e){const t=document.getElementById("facts-chart");if(!t)return;const n=e.factsByCategory||{},a=["technical","process","policy","people","timeline","general"],s=a.reduce((o,i)=>o+(n[i]??0),0);if(s===0){t.innerHTML='<div class="empty-chart">No facts yet</div>';return}t.innerHTML=`
    <div class="facts-chart-title">Facts by category</div>
    <div class="priority-bars">
      ${a.map(o=>{const i=n[o]??0,r=s>0?i/s*100:0;return`
        <div class="priority-bar">
          <div class="bar-label">${o}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${r}%"></div>
          </div>
          <div class="bar-value">${i}</div>
        </div>`}).join("")}
    </div>
  `}function Tb(e){const t=document.getElementById("questions-chart");if(!t)return;const{critical:n,high:a,medium:s,resolved:o}=e.questionsByPriority,i=n+a+s+o;if(i===0){t.innerHTML='<div class="empty-chart">No questions yet</div>';return}t.innerHTML=`
    <div class="priority-bars">
      <div class="priority-bar">
        <div class="bar-label">Critical</div>
        <div class="bar-track">
          <div class="bar-fill critical" style="width: ${n/i*100}%"></div>
        </div>
        <div class="bar-value">${n}</div>
      </div>
      <div class="priority-bar">
        <div class="bar-label">High</div>
        <div class="bar-track">
          <div class="bar-fill high" style="width: ${a/i*100}%"></div>
        </div>
        <div class="bar-value">${a}</div>
      </div>
      <div class="priority-bar">
        <div class="bar-label">Medium</div>
        <div class="bar-track">
          <div class="bar-fill medium" style="width: ${s/i*100}%"></div>
        </div>
        <div class="bar-value">${s}</div>
      </div>
      <div class="priority-bar">
        <div class="bar-label">Resolved</div>
        <div class="bar-track">
          <div class="bar-fill resolved" style="width: ${o/i*100}%"></div>
        </div>
        <div class="bar-value">${o}</div>
      </div>
    </div>
  `}async function Ab(e){const t=document.getElementById("trends-chart");if(t){t.innerHTML='<div class="loading">Loading trends...</div>';try{const n=await Vi.getTrends(7);if(!n||!n.history||n.history.length===0){t.innerHTML='<div class="empty-chart">No trend data available yet</div>';return}const a=n.history,s=[],o={facts:[],questions:[],risks:[],actions:[]};a.forEach(r=>{const c=new Date(r.date);s.push(c.toLocaleDateString(void 0,{weekday:"short"})),o.facts.push(r.facts||0),o.questions.push(r.questions||0),o.risks.push(r.risks||0),o.actions.push(r.actions||0)});const i=Math.max(...o.facts,...o.questions,...o.risks,...o.actions,1);t.innerHTML=`
      <div class="trends-chart">
        <div class="trends-legend">
          <span class="legend-item"><span class="legend-dot facts"></span>Facts</span>
          <span class="legend-item"><span class="legend-dot questions"></span>Questions</span>
          <span class="legend-item"><span class="legend-dot risks"></span>Risks</span>
          <span class="legend-item"><span class="legend-dot actions"></span>Actions</span>
        </div>
        <div class="trends-bars">
          ${s.map((r,c)=>`
            <div class="trend-column">
              <div class="trend-bars-group">
                <div class="trend-bar facts" style="height: ${o.facts[c]/i*100}%" title="Facts: ${o.facts[c]}"></div>
                <div class="trend-bar questions" style="height: ${o.questions[c]/i*100}%" title="Questions: ${o.questions[c]}"></div>
                <div class="trend-bar risks" style="height: ${o.risks[c]/i*100}%" title="Risks: ${o.risks[c]}"></div>
                <div class="trend-bar actions" style="height: ${o.actions[c]/i*100}%" title="Actions: ${o.actions[c]}"></div>
              </div>
              <div class="trend-label">${r}</div>
            </div>
          `).join("")}
        </div>
      </div>
    `}catch(n){console.error("Failed to load trends:",n),t.innerHTML='<div class="error">Failed to load trend data</div>'}}}function Eb(e,t){if(t===0){e.innerHTML="";return}e.innerHTML=`
    <div class="overdue-alert">
      <div class="overdue-icon">‚ö†Ô∏è</div>
      <div class="overdue-content">
        <strong>${t} Overdue Action${t!==1?"s":""}</strong>
        <span>Action items past their due date require immediate attention</span>
      </div>
      <button class="btn btn-sm btn-warning" id="view-overdue-btn">View Actions</button>
    </div>
  `;const n=e.querySelector("#view-overdue-btn");n&&n.addEventListener("click",()=>{window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"sot",view:"actions",filter:"overdue"}}))})}function _b(e){switch(e){case"critical":return"üî¥";case"high":return"üü†";case"warning":return"üü°";default:return"‚ö™"}}function Rr(e){try{const t=new Date,a=new Intl.DateTimeFormat("en-GB",{timeZone:e,hour:"2-digit",minute:"2-digit",hour12:!1}).format(t),s=parseInt(a.split(":")[0],10),o=s>=8&&s<18;return{localTime:a,localHour:s,isOnline:o}}catch{return{localTime:"--:--",localHour:12,isOnline:!1}}}function Mo(e){if(e.length===0)return[];const t=[],n=new Date;for(let a=0;a<24;a++){let s=0,o=0;for(const i of e)try{const r=new Intl.DateTimeFormat("en-US",{timeZone:i.timezone,hour:"numeric",hour12:!1}),c=parseInt(r.format(n),10),l=n.getUTCHours();let m=c-l;m>12&&(m-=24),m<-12&&(m+=24);const v=(a+m+24)%24;v>=9&&v<=17?(s++,v>=10&&v<=12||v>=14&&v<=16?o+=10:o+=7):v>=8&&v<=18&&(s++,o+=4)}catch{}s>0&&t.push({time:`${a.toString().padStart(2,"0")}:00 UTC`,score:o,available:s})}return t.sort((a,s)=>s.available!==a.available?s.available-a.available:s.score-a.score),t.slice(0,3)}async function jb(e,t){try{const[n,a]=await Promise.all([p.get(`/api/projects/${t}/members`).catch(()=>({data:{members:[]}})),p.get("/api/contacts").catch(()=>({data:{contacts:[]}}))]),s=n.data?.members||[],o=a.data?.contacts||[],i=new Set,r=s.map(C=>{const S=C.linked_contact,L=C.timezone||S?.timezone;if(!L)return null;const R=Rr(L),Z=C.avatar_url||S?.avatar_url||S?.photo_url,ee=C.user_role||S?.role||(C.role==="owner"?"Owner":C.role==="admin"?"Admin":void 0),le=C.linked_contact_id||S?.id;return le&&i.add(le),{name:C.display_name||C.username||C.email||"Unknown",timezone:L,type:"member",avatarUrl:Z,role:ee,linkedContactId:le,...R}}).filter(C=>C!==null),c=o.filter(C=>C.timezone).map(C=>{const S=Rr(C.timezone||"UTC"),L=C.id;return{name:C.name,timezone:C.timezone||"UTC",type:"contact",avatarUrl:C.avatarUrl||C.photoUrl||C.photo_url||C.avatar_url,role:C.role,contactId:L,...S}});if(r.length===0&&c.length===0){e.innerHTML="";return}const l=qo(r),m=qo(c),v=c.filter(C=>!C.contactId||!i.has(C.contactId)),g=[...r,...v],f=qo(g),b=Mo(g),w=r.filter(C=>C.isOnline).length,$=c.filter(C=>C.isOnline).length,M=v.filter(C=>C.isOnline).length,q=w+M;e.innerHTML=`
      <style>
        .golden-hours-section {
          background: var(--bg-primary);
          border-radius: 16px;
          padding: 24px;
          border: 1px solid var(--border-color);
          margin-bottom: 24px;
        }
        
        .golden-hours-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 24px;
        }
        
        .golden-hours-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        .golden-hours-header h3 svg {
          color: #f59e0b;
        }
        
        .golden-hours-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 20px;
        }
        
        .golden-card {
          background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 20px;
        }
        
        [data-theme="dark"] .golden-card {
          background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(30,41,59,0.6) 100%);
        }
        
        .golden-card h4 {
          margin: 0 0 16px 0;
          font-size: 14px;
          font-weight: 600;
          color: var(--text-secondary);
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .golden-card h4 .count {
          background: var(--bg-secondary);
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 12px;
        }
        
        .timezone-bars {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 16px;
        }
        
        .timezone-row {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        
        .tz-name {
          width: 100px;
          font-size: 12px;
          color: var(--text-secondary);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .tz-bar-container {
          flex: 1;
          height: 24px;
          background: var(--bg-secondary);
          border-radius: 4px;
          position: relative;
          overflow: hidden;
        }
        
        .tz-bar {
          position: absolute;
          height: 100%;
          border-radius: 2px;
        }
        
        .tz-bar.work-hours {
          background: linear-gradient(90deg, #10b981, #34d399);
          opacity: 0.6;
        }
        
        .tz-bar.golden {
          background: linear-gradient(90deg, #f59e0b, #fbbf24);
          opacity: 0.9;
        }
        
        .hour-labels {
          display: flex;
          justify-content: space-between;
          padding: 0 110px 0 0;
          margin-bottom: 4px;
        }
        
        .hour-label {
          font-size: 10px;
          color: var(--text-muted);
          width: 20px;
          text-align: center;
        }
        
        .golden-summary {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(251,191,36,0.05) 100%);
          border-radius: 8px;
          border: 1px solid rgba(245,158,11,0.2);
        }
        
        .golden-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #f59e0b, #d97706);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 18px;
        }
        
        .golden-text {
          flex: 1;
        }
        
        .golden-text .label {
          font-size: 12px;
          color: var(--text-secondary);
        }
        
        .golden-text .hours {
          font-size: 16px;
          font-weight: 700;
          color: #d97706;
        }
        
        .no-overlap {
          color: var(--text-muted);
          font-size: 13px;
          font-style: italic;
        }
        
        .participants-row {
          display: flex;
          align-items: center;
          gap: 4px;
          margin-top: 12px;
        }
        
        .participant-avatar {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea, #764ba2);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 10px;
          font-weight: 600;
          border: 2px solid var(--bg-primary);
          margin-left: -8px;
        }
        
        .participant-avatar:first-child {
          margin-left: 0;
        }
        
        .participant-avatar img {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
        }
        
        .participant-avatar.more {
          background: var(--bg-secondary);
          color: var(--text-secondary);
        }
        
        .online-status-bar {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 16px;
          background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(52,211,153,0.05) 100%);
          border-radius: 12px;
          border: 1px solid rgba(16,185,129,0.2);
          margin-bottom: 20px;
        }
        
        .online-indicator {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .online-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background: #10b981;
          box-shadow: 0 0 8px rgba(16,185,129,0.6);
          animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.2); opacity: 0.7; }
        }
        
        .online-count {
          font-size: 14px;
          font-weight: 600;
          color: #059669;
        }
        
        .people-list {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          margin-top: 16px;
        }
        
        .person-chip {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          background: var(--bg-secondary);
          border-radius: 20px;
          border: 1px solid var(--border-color);
          transition: all 0.2s ease;
        }
        
        .person-chip.online {
          background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%);
          border-color: rgba(16,185,129,0.3);
        }
        
        .person-chip.offline {
          opacity: 0.6;
        }
        
        .person-avatar-small {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea, #764ba2);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 11px;
          font-weight: 600;
          position: relative;
        }
        
        .person-avatar-small img {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
        }
        
        .person-avatar-small .status-dot {
          position: absolute;
          bottom: -2px;
          right: -2px;
          width: 10px;
          height: 10px;
          border-radius: 50%;
          border: 2px solid var(--bg-primary);
        }
        
        .person-avatar-small .status-dot.online {
          background: #10b981;
        }
        
        .person-avatar-small .status-dot.offline {
          background: #9ca3af;
        }
        
        .person-info {
          display: flex;
          flex-direction: column;
        }
        
        .person-name {
          font-size: 13px;
          font-weight: 500;
          color: var(--text-primary);
        }
        
        .person-time {
          font-size: 11px;
          color: var(--text-secondary);
        }
        
        .person-role {
          font-size: 10px;
          color: #e11d48;
          font-weight: 500;
          margin-top: 2px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 120px;
        }
        
        .meeting-suggestions {
          margin-top: 20px;
          padding: 16px;
          background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.05) 100%);
          border-radius: 12px;
          border: 1px solid rgba(99,102,241,0.2);
        }
        
        .meeting-suggestions h5 {
          margin: 0 0 12px 0;
          font-size: 14px;
          font-weight: 600;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .meeting-suggestions h5 svg {
          color: #6366f1;
        }
        
        .suggestion-list {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
        }
        
        .suggestion-pill {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 14px;
          background: white;
          border-radius: 20px;
          border: 1px solid rgba(99,102,241,0.3);
          font-size: 13px;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        [data-theme="dark"] .suggestion-pill {
          background: rgba(30,41,59,0.8);
        }
        
        .suggestion-pill:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(99,102,241,0.2);
        }
        
        .suggestion-pill .time {
          font-weight: 600;
          color: #6366f1;
        }
        
        .suggestion-pill .availability {
          font-size: 11px;
          color: var(--text-secondary);
          padding: 2px 6px;
          background: rgba(16,185,129,0.1);
          border-radius: 8px;
          color: #059669;
        }
      </style>
      
      <div class="golden-hours-section">
        <div class="golden-hours-header">
          <h3>
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            Golden Hours
          </h3>
          <span style="font-size: 13px; color: var(--text-secondary);">
            ${new Date().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})} your time
          </span>
        </div>
        
        <div class="golden-hours-grid">
          <!-- Team Members Section -->
          ${r.length>0?`
            <div class="golden-card">
              <h4>
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Team Members
                <span class="count">${r.length}</span>
                ${w>0?`<span style="margin-left: auto; font-size: 11px; color: #10b981;">‚óè ${w} online</span>`:""}
              </h4>
              
              <!-- Team People List -->
              <div class="people-list" style="margin-bottom: 16px;">
                ${r.map(C=>{const S=C.name.split(" ").map(L=>L[0]).join("").substring(0,2).toUpperCase();return`
                    <div class="person-chip ${C.isOnline?"online":"offline"}">
                      <div class="person-avatar-small">
                        ${C.avatarUrl?`<img src="${bt(C.avatarUrl)}" alt="${bt(C.name)}">`:S}
                        <span class="status-dot ${C.isOnline?"online":"offline"}"></span>
                      </div>
                      <div class="person-info">
                        <span class="person-name">${bt(C.name)}</span>
                        ${C.role?`<span class="person-role">${bt(C.role)}</span>`:""}
                        <span class="person-time">${C.localTime||"--:--"} ${C.timezone.split("/").pop()?.replace(/_/g," ")||""}</span>
                      </div>
                    </div>
                  `}).join("")}
              </div>
              
              ${Nr(r,l)}
              ${To(l,r)}
              
              <!-- Team Meeting Suggestions -->
              ${(()=>{const C=Mo(r);return C.length>0?`
                  <div class="meeting-suggestions" style="margin-top: 16px;">
                    <h5>
                      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      Best Times for Team
                    </h5>
                    <div class="suggestion-list">
                      ${C.map((S,L)=>`
                        <div class="suggestion-pill">
                          <span style="color: ${L===0?"#f59e0b":"var(--text-muted)"};">${L===0?"‚≠ê":"üïê"}</span>
                          <span class="time">${S.time}</span>
                          <span class="availability">${S.available}/${r.length}</span>
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""})()}
            </div>
          `:""}
          
          <!-- Contacts Section -->
          ${c.length>0?`
            <div class="golden-card">
              <h4>
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                </svg>
                Contacts
                <span class="count">${c.length}</span>
                ${$>0?`<span style="margin-left: auto; font-size: 11px; color: #10b981;">‚óè ${$} online</span>`:""}
              </h4>
              
              <!-- Contacts People List -->
              <div class="people-list" style="margin-bottom: 16px;">
                ${c.map(C=>{const S=C.name.split(" ").map(L=>L[0]).join("").substring(0,2).toUpperCase();return`
                    <div class="person-chip ${C.isOnline?"online":"offline"}">
                      <div class="person-avatar-small">
                        ${C.avatarUrl?`<img src="${bt(C.avatarUrl)}" alt="${bt(C.name)}">`:S}
                        <span class="status-dot ${C.isOnline?"online":"offline"}"></span>
                      </div>
                      <div class="person-info">
                        <span class="person-name">${bt(C.name)}</span>
                        ${C.role?`<span class="person-role">${bt(C.role)}</span>`:""}
                        <span class="person-time">${C.localTime||"--:--"} ${C.timezone.split("/").pop()?.replace(/_/g," ")||""}</span>
                      </div>
                    </div>
                  `}).join("")}
              </div>
              
              ${Nr(c,m)}
              ${To(m,c)}
              
              <!-- Contacts Meeting Suggestions -->
              ${(()=>{const C=Mo(c);return C.length>0?`
                  <div class="meeting-suggestions" style="margin-top: 16px;">
                    <h5>
                      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      Best Times for Contacts
                    </h5>
                    <div class="suggestion-list">
                      ${C.map((S,L)=>`
                        <div class="suggestion-pill">
                          <span style="color: ${L===0?"#f59e0b":"var(--text-muted)"};">${L===0?"‚≠ê":"üïê"}</span>
                          <span class="time">${S.time}</span>
                          <span class="availability">${S.available}/${c.length}</span>
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""})()}
            </div>
          `:""}
        </div>
        
        <!-- Combined Section (only if both exist) -->
        ${r.length>0&&c.length>0?`
          <div class="golden-card" style="margin-top: 20px;">
            <h4>
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Combined: Team + Contacts
              <span class="count">${g.length}</span>
              <span style="margin-left: auto; font-size: 11px; color: #10b981;">‚óè ${q} online</span>
            </h4>
            ${To(f,g)}
            
            <!-- Combined Meeting Suggestions -->
            ${b.length>0?`
              <div class="meeting-suggestions" style="margin-top: 16px;">
                <h5>
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  Best Times for Everyone
                </h5>
                <div class="suggestion-list">
                  ${b.map((C,S)=>`
                    <div class="suggestion-pill">
                      <span style="color: ${S===0?"#f59e0b":"var(--text-muted)"};">${S===0?"‚≠ê":"üïê"}</span>
                      <span class="time">${C.time}</span>
                      <span class="availability">${C.available}/${g.length}</span>
                    </div>
                  `).join("")}
                </div>
              </div>
            `:""}
          </div>
        `:""}
      </div>
    `}catch(n){console.error("Failed to load golden hours:",n)}}function qo(e){if(e.length===0)return null;const t=[...new Set(e.map(r=>r.timezone))];if(t.length===1)return{start:8,end:18};const n=new Date,a=[];for(const r of t)try{const c=new Intl.DateTimeFormat("en-US",{timeZone:r,hour:"numeric",hour12:!1}),l=parseInt(c.format(n),10),m=n.getUTCHours();let v=l-m;v>12&&(v-=24),v<-12&&(v+=24),a.push(v)}catch{a.push(0)}let s=0,o=24;for(const r of a){const c=(8-r+24)%24,l=(18-r+24)%24;c<l&&(s=Math.max(s,c),o=Math.min(o,l))}if(s>=o)return null;const i=a[0];return{start:(s+i+24)%24,end:(o+i+24)%24}}function Nr(e,t){const n=new Map;for(const o of e)n.set(o.timezone,(n.get(o.timezone)||0)+1);const a=[...n.keys()].slice(0,5);if(a.length===0)return'<div class="no-overlap">No timezone data available</div>';const s=new Date;return`
    <div class="hour-labels">
      ${[0,6,12,18,24].map(o=>`<span class="hour-label">${o}</span>`).join("")}
    </div>
    <div class="timezone-bars">
      ${a.map(o=>{let i=0;try{const f=new Intl.DateTimeFormat("en-US",{timeZone:o,hour:"numeric",hour12:!1}),b=parseInt(f.format(s),10),w=s.getUTCHours();i=b-w,i>12&&(i-=24),i<-12&&(i+=24)}catch{}const r=9,c=18,l=r/24*100,m=(c-r)/24*100,v=o.split("/").pop()?.replace(/_/g," ")||o,g=n.get(o)||1;return`
          <div class="timezone-row">
            <span class="tz-name" title="${o}">${v} ${g>1?`(${g})`:""}</span>
            <div class="tz-bar-container">
              <div class="tz-bar work-hours" style="left: ${l}%; width: ${m}%;"></div>
              ${t?`<div class="tz-bar golden" style="left: ${t.start/24*100}%; width: ${(t.end-t.start)/24*100}%;"></div>`:""}
            </div>
          </div>
        `}).join("")}
    </div>
  `}function To(e,t){if(!e)return`
      <div class="golden-summary" style="background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%); border-color: rgba(239,68,68,0.2);">
        <div class="golden-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">‚ö†</div>
        <div class="golden-text">
          <div class="label">No overlap found</div>
          <div class="hours" style="color: #dc2626;">Timezones too far apart</div>
        </div>
      </div>
    `;const n=r=>`${r.toString().padStart(2,"0")}:00`,a=e.end-e.start,s=5,o=t.slice(0,s),i=t.length-s;return`
    <div class="golden-summary">
      <div class="golden-icon">‚òÄÔ∏è</div>
      <div class="golden-text">
        <div class="label">Golden Hours</div>
        <div class="hours">${n(e.start)} - ${n(e.end)} (${a}h overlap)</div>
      </div>
    </div>
    <div class="participants-row">
      ${o.map(r=>{const c=r.name.split(" ").map(l=>l[0]).join("").substring(0,2).toUpperCase();return`
          <div class="participant-avatar" title="${bt(r.name)}">
            ${r.avatarUrl?`<img src="${bt(r.avatarUrl)}" alt="${bt(r.name)}">`:c}
          </div>
        `}).join("")}
      ${i>0?`<div class="participant-avatar more">+${i}</div>`:""}
    </div>
  `}function bt(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function Dl(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Dashboard: Container not found: ${e}`),null;const a=Fs(t);return n.appendChild(a),a}const Db=Object.freeze(Object.defineProperty({__proto__:null,createDashboard:Fs,default:Fs,mountDashboard:Dl},Symbol.toStringTag,{value:"Module"}));function Yi(e={}){const t=e.showSessions!==!1,n=x("div",{className:"chat-layout"});let a=null,s=[],o=[];const i=x("div",{className:"chat-sidebar"}),r=x("button",{className:"chat-new-conversation",innerHTML:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova conversa'}),c=x("div",{className:"chat-new-context-wrap"}),l=x("span",{className:"chat-new-context-label",textContent:"Como quem?"}),m=x("select",{className:"chat-new-context-select"});c.appendChild(l),c.appendChild(m);const v=x("div",{className:"chat-sessions-list"});i.appendChild(r),i.appendChild(c),i.appendChild(v);const g=x("div",{className:"chat-main"}),f=x("div",{className:"chat-container"}),b=x("div",{className:"chat-header"}),w=x("label",{className:"chat-context-label",textContent:"Como quem?"}),$=x("select",{className:"chat-context-select"});b.appendChild(w),b.appendChild($);async function M(){try{o=(await p.get("/api/contacts")).data?.contacts||[],q()}catch{o=[]}}function q(){const ne=s.find(se=>se.id===a)?.context_contact_id||null;$.innerHTML=`<option value="">Sem contexto</option>${o.map(se=>`<option value="${se.id}" ${se.id===ne?"selected":""}>${yt(se.name)}${se.role?` - ${se.role}`:""}${se.organization?` (${se.organization})`:""}</option>`).join("")}`,$.disabled=!a}function C(){m.innerHTML=`<option value="">Sem contexto</option>${o.map(N=>`<option value="${N.id}">${yt(N.name)}${N.role?` - ${N.role}`:""}${N.organization?` (${N.organization})`:""}</option>`).join("")}`}async function S(){if(!a)return;const N=$.value||null;try{await p.put(`/api/chat/sessions/${a}`,{contextContactId:N});const ne=s.findIndex(se=>se.id===a);ne!==-1&&(s[ne]={...s[ne],context_contact_id:N}),u.success("Contexto actualizado")}catch(ne){u.error("Falha ao actualizar contexto"),console.error("[Chat] Update context error:",ne),q()}}const L=x("div",{className:"chat-messages"}),R=x("div",{className:"chat-input-container"}),Z=x("textarea",{className:"chat-input",placeholder:e.placeholder||"Ask a question about your project..."}),ee=x("button",{className:"chat-send-btn",innerHTML:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
    </svg>`});d(Z,"input",()=>{Z.style.height="auto",Z.style.height=Math.min(Z.scrollHeight,120)+"px"}),d(Z,"keydown",N=>{N.key==="Enter"&&!N.shiftKey&&(N.preventDefault(),te())}),d(ee,"click",te);let le=!1;async function ae(){try{s=(await p.get("/api/chat/sessions")).data?.sessions||[],X()}catch{s=[]}}function X(){v.innerHTML=s.map(N=>`
      <button class="chat-session-item ${N.id===a?"active":""}" data-session-id="${N.id}">
        <span class="session-title">${yt(N.title.length>40?N.title.substring(0,37)+"...":N.title)}</span>
        <span class="session-date">${J(N.updated_at)}</span>
      </button>
    `).join(""),v.querySelectorAll(".chat-session-item").forEach(N=>{d(N,"click",()=>U(N.getAttribute("data-session-id")))})}async function ie(N){try{const se=(await p.get(`/api/chat/sessions/${N}/messages`)).data?.messages||[];B.setChatHistory(se.map(I=>({id:I.id,role:I.role,content:I.content,timestamp:I.created_at,sources:I.sources,...I.metadata?.queryType&&{queryType:I.metadata.queryType},...I.metadata?.confidence&&{confidence:I.metadata.confidence}})))}catch{B.setChatHistory([])}}async function U(N){a=N,X(),B.clearChatHistory(),await ie(N),L.innerHTML="",B.getState().chatHistory.forEach(ne=>Ea(ne,L,e.showSources))}async function Q(N){try{const se=(await p.post("/api/chat/sessions",{title:"Nova conversa",contextContactId:N||null})).data?.session;se&&(s.unshift({id:se.id,title:se.title||"Nova conversa",context_contact_id:se.context_contact_id??null,created_at:se.created_at||new Date().toISOString(),updated_at:se.updated_at||new Date().toISOString()}),await U(se.id),X())}catch(ne){u.error("Failed to create new conversation"),console.error("[Chat] Create session error:",ne)}}async function te(){const N=Z.value.trim();if(!N||le)return;Z.value="",Z.style.height="auto",le=!0,ee.setAttribute("disabled","true");const ne={id:`msg-${Date.now()}`,role:"user",content:N,timestamp:new Date().toISOString()};B.addChatMessage(ne),Ea(ne,L);const se=x("div",{className:"chat-loading"});se.innerHTML=`
      <div class="chat-loading-dots">
        <span></span><span></span><span></span>
      </div>
      <span>Thinking...</span>
    `,L.appendChild(se),Pl(L);try{if(e.onSend)await e.onSend(N);else{const I=await p.post("/api/chat",{message:N,history:B.getState().chatHistory.slice(-10),sessionId:a}),O={id:`msg-${Date.now()}`,role:"assistant",content:I.data.response,timestamp:new Date().toISOString(),sources:I.data.sources,queryType:I.data.queryType,confidence:I.data.confidence,contextQuality:I.data.contextQuality,rag:I.data.rag};B.addChatMessage(O),Ea(O,L,e.showSources),I.data.sessionId&&!a&&(a=I.data.sessionId,await ae(),X(),q())}}catch{const O={role:"system",content:"Failed to get response. Please try again.",timestamp:new Date().toISOString()};Ea(O,L)}finally{se.remove(),le=!1,ee.removeAttribute("disabled"),Z.focus()}}R.appendChild(Z),R.appendChild(ee);const de=x("div",{className:"quick-prompts"});return["Summarize key risks","List open questions","What actions are overdue?","Who are the key contacts?"].forEach(N=>{const ne=x("button",{className:"quick-prompt",textContent:N});d(ne,"click",()=>{Z.value=N,te()}),de.appendChild(ne)}),d($,"change",S),f.appendChild(b),f.appendChild(L),f.appendChild(de),f.appendChild(R),g.appendChild(f),t?(n.appendChild(i),d(r,"click",Q),M().then(()=>C()),ae()):b.style.display="none",n.appendChild(g),B.getState().chatHistory.forEach(N=>Ea(N,L,e.showSources)),n}function Ea(e,t,n=!0){const a=x("div",{className:`chat-message ${e.role}`});let s=yt(e.content);if(s=s.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>"),a.innerHTML=`<div class="chat-message-content">${s}</div>`,e.role==="assistant"&&(e.confidence||e.rag)){const o=x("div",{className:"chat-meta"}),i=e.confidence==="high"?"confidence-high":e.confidence==="medium"?"confidence-medium":"confidence-low";let r="";if(e.confidence&&(r+=`<span class="chat-badge ${i}" title="Confidence level">${e.confidence}</span>`),e.queryType&&(r+=`<span class="chat-badge query-type" title="Query classification">${e.queryType}</span>`),e.rag){const c=e.rag.usedHyDE?"HyDE+RRF":e.rag.graphResults>0?"Graph+Vector":"Hybrid";r+=`<span class="chat-badge rag-method" title="RAG method: ${e.rag.method}">${c}</span>`;const l=e.rag.fusedResults||e.rag.vectorResults+e.rag.graphResults;l>0&&(r+=`<span class="chat-badge sources-count" title="Sources found">${l} sources</span>`)}o.innerHTML=r,a.appendChild(o)}if(n&&e.sources&&e.sources.length>0){const o=x("div",{className:"chat-sources"});if(typeof e.sources[0]=="string")o.innerHTML=`
        <span class="sources-label">Sources:</span>
        ${e.sources.map(i=>`<span class="source-link">${yt(i)}</span>`).join("")}
      `;else{const i=e.sources,r=i.filter(m=>m.contactName),l=i.filter(m=>!m.contactName).slice(0,5);if(r.length>0){const m=x("div",{className:"chat-contact-pills"});m.innerHTML=r.map(v=>`
          <div class="contact-pill">
            ${v.avatarUrl?`<img class="contact-pill-avatar" src="${yt(v.avatarUrl)}" alt="" onerror="this.style.display='none'"/>`:`<div class="contact-pill-avatar-placeholder">${yt((v.contactName||v.type||"?")[0])}</div>`}
            <div class="contact-pill-info">
              <span class="contact-pill-name">${yt(v.contactName||v.type||"Contact")}</span>
              ${v.contactRole?`<span class="contact-pill-role">${yt(v.contactRole)}</span>`:""}
            </div>
          </div>
        `).join(""),a.appendChild(m)}o.innerHTML=`
        <details class="sources-details">
          <summary class="sources-label">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            ${i.length} sources used
          </summary>
          <div class="sources-list">
            ${l.map(m=>`
              <div class="source-item">
                <span class="source-type">${yt(m.type||"unknown")}</span>
                <span class="source-score" title="Relevance score">${Math.round((m.rrfScore||m.score||0)*100)}%</span>
                ${m.sourceCount&&m.sourceCount>1?`<span class="source-multi" title="Found in multiple searches">x${m.sourceCount}</span>`:""}
                ${m.source?`<span class="source-from">${yt(m.source)}</span>`:""}
              </div>
            `).join("")}
            ${i.length>5?`<div class="sources-more">+${i.length-5} more</div>`:""}
          </div>
        </details>
      `}a.appendChild(o)}return t.appendChild(a),Pl(t),a}function Pl(e){e.scrollTop=e.scrollHeight}function yt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Hl(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`Chat: Container not found: ${e}`),null;const a=Yi(t);return n.appendChild(a),a}const Pb=Object.freeze(Object.defineProperty({__proto__:null,createChat:Yi,mountChat:Hl},Symbol.toStringTag,{value:"Module"}));let oe=null,it=[];function fo(e){const{question:t,onClose:n,onUpdate:a,onNavigateToQuestion:s}=e;oe=t;const o=x("div",{className:"question-detail-view"});return o.innerHTML=`
    <div class="question-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Questions</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Question #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        ${t.sla_breached?'<span class="sla-badge breached">SLA Breached</span>':""}
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content">
      <!-- Main Question Card -->
      <section class="detail-section question-main">
        <div class="question-badges">
          <span class="priority-badge priority-${t.priority}">${t.priority}</span>
          <span class="status-badge status-${t.status}">${t.status}</span>
          ${t.requester_role?`
            <div class="requester-badge-full" title="Question from the perspective of this role">
              <div class="requester-avatar-sm">${lt(t.requester_name||t.requester_role)}</div>
              <div class="requester-text">
                ${t.requester_name?`<span class="requester-name-sm">${pe(t.requester_name)}</span>`:""}
                <span class="requester-role-sm">${pe(t.requester_role)}</span>
              </div>
            </div>
          `:""}
          <span class="question-date">Created ${J(t.created_at)}</span>
        </div>
        <h2 class="question-text">${pe(t.content)}</h2>
        ${t.context?`<p class="question-context">${pe(t.context)}</p>`:""}
        ${Hb(t)}
      </section>

      <!-- Two-column layout -->
      <div class="detail-columns">
        <div class="detail-column-left">
          <!-- Assignment Section - SOTA Design -->
          <section class="detail-section" id="assignment-section">
            <div class="section-header-sota">
              <h3>
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Assignment
                <span class="section-subtitle">Who should answer this question?</span>
              </h3>
              <button type="button" class="btn-ai-suggest" id="ai-suggest-btn">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                AI Suggest
              </button>
            </div>
            
            <!-- Current Assignment Display -->
            <div id="current-assignment" class="current-assignment-card">
              ${t.assigned_to?`
                <div class="assigned-contact-display">
                  <div class="contact-avatar-lg" id="assigned-avatar">
                    ${lt(t.assigned_to)}
                  </div>
                  <div class="contact-details">
                    <div class="contact-name-lg">${pe(t.assigned_to)}</div>
                    <div class="contact-role-sm" id="assigned-role">Loading...</div>
                  </div>
                  <button class="btn-change-assignment" id="change-assignee-btn">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    Change
                  </button>
                </div>
              `:`
                <div class="no-assignment">
                  <div class="no-assignment-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                    </svg>
                  </div>
                  <span>No one assigned to answer</span>
                  <p class="no-assignment-hint">Use AI Suggest to find the best person</p>
                  <button class="btn-assign-now" id="show-picker-btn">Choose Manually</button>
                </div>
              `}
            </div>
            
            <!-- Contact Picker (hidden by default) -->
            <div id="contact-picker" class="contact-picker-sota" style="display: none;">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="contact-list" class="contact-list-grid">
                <div class="loading">Loading contacts...</div>
              </div>
            </div>
            
            <!-- Hidden select for form submission -->
            <select id="assignee-select" class="form-select" style="display: none;">
              <option value="">Select contact...</option>
            </select>
            
            <!-- AI Suggestions Panel -->
            <div id="suggestions-panel" class="suggestions-panel-sota" style="display: none;"></div>
          </section>

          <!-- Potential Answers Section -->
          <section class="detail-section" id="answers-section">
            <div class="section-header">
              <h3>Potential Answers</h3>
              <button class="btn btn-secondary btn-sm" id="check-answers-btn">
                Check Knowledge Base
              </button>
            </div>
            <div id="potential-answers" class="potential-answers">
              <p class="empty-state">Click "Check Knowledge Base" to find potential answers</p>
            </div>
          </section>

          <!-- Answer Form Section -->
          <section class="detail-section" id="answer-section">
            <h3>${t.answer?"Current Answer":"Your Answer"}</h3>
            ${t.answer?Bb(t):""}
            <div class="answer-form" ${t.status==="resolved"?'style="display:none;"':""}>
              <div class="form-group">
                <textarea id="answer-input" rows="4" 
                  placeholder="Type your answer here...">${t.answer||""}</textarea>
              </div>
              <div class="form-row answer-form-row">
                <div class="form-group source-group">
                  <label>Source</label>
                  <div class="source-options">
                    <label class="source-option ${t.answer_source==="manual"||!t.answer_source?"active":""}">
                      <input type="radio" name="answer-source" value="manual" ${t.answer_source==="manual"||!t.answer_source?"checked":""}>
                      <span class="source-icon">‚úèÔ∏è</span>
                      <span class="source-label">Manual</span>
                    </label>
                    <label class="source-option ${t.answer_source==="document"?"active":""}">
                      <input type="radio" name="answer-source" value="document" ${t.answer_source==="document"?"checked":""}>
                      <span class="source-icon">üìÑ</span>
                      <span class="source-label">Document</span>
                    </label>
                    <label class="source-option ${t.answer_source==="ai"?"active":""}">
                      <input type="radio" name="answer-source" value="ai" ${t.answer_source==="ai"?"checked":""}>
                      <span class="source-icon">ü§ñ</span>
                      <span class="source-label">AI</span>
                    </label>
                  </div>
                </div>
                <div class="form-group answered-by-group">
                  <label>Answered By</label>
                  <div class="answered-by-picker">
                    <div id="answered-by-display" class="answered-by-display">
                      ${t.answered_by_contact_id||t.answered_by_name?`
                        <div class="answered-by-card" id="current-answerer">
                          <div class="answerer-avatar" id="answerer-avatar">${lt(t.answered_by_name||"")}</div>
                          <span class="answerer-name">${pe(t.answered_by_name||"Contact")}</span>
                          <button type="button" class="btn-clear-answerer" id="clear-answerer">√ó</button>
                        </div>
                      `:`
                        <button type="button" class="btn-select-answerer" id="show-answerer-picker">
                          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                          </svg>
                          Select who answered...
                        </button>
                      `}
                    </div>
                    <!-- Hidden select for form -->
                    <select id="answered-by-contact" class="form-select" style="display: none;">
                      <option value="">Select who answered...</option>
                    </select>
                    <!-- Contact picker dropdown -->
                    <div id="answerer-picker-dropdown" class="answerer-picker-dropdown" style="display: none;">
                      <div class="picker-search-sm">
                        <input type="text" id="answerer-search" placeholder="Search contacts...">
                      </div>
                      <div id="answerer-list" class="answerer-list"></div>
                      <div class="answerer-other">
                        <input type="text" id="answerer-other-name" placeholder="Or type a name...">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label>Follow-up Questions (one per line)</label>
                <textarea id="followup-input" rows="2" 
                  placeholder="Add any follow-up questions..."></textarea>
              </div>
              <div class="form-actions">
                <button class="btn btn-primary" id="save-answer-btn">
                  ${t.answer?"Update Answer":"Save Answer"}
                </button>
              </div>
            </div>
          </section>
        </div>

        <div class="detail-column-right">
          <!-- Follow-up Chain Section -->
          <section class="detail-section" id="chain-section">
            <h3>Follow-up Chain</h3>
            <div id="chain-content" class="chain-content">
              <div class="loading">Loading...</div>
            </div>
          </section>

          <!-- Similar Questions Section -->
          <section class="detail-section" id="similar-section">
            <h3>Similar Questions</h3>
            <div id="similar-content" class="similar-content">
              <div class="loading">Loading...</div>
            </div>
          </section>

          <!-- Timeline Section -->
          <section class="detail-section" id="timeline-section">
            <h3>Timeline</h3>
            <div id="timeline-content" class="timeline-content">
              <div class="loading">Loading...</div>
            </div>
          </section>
        </div>
      </div>

    </div>

    <!-- Actions Bar - Outside scrollable content for proper click handling -->
    <div class="detail-actions">
      ${t.status==="resolved"||t.status==="dismissed"?`
        <button class="btn btn-warning" id="reopen-btn">Reopen</button>
      `:""}
      ${t.status==="deferred"?`
        <button class="btn btn-info" id="undefer-btn">Resume Now</button>
      `:`
        <button class="btn btn-secondary" id="defer-btn">Defer</button>
      `}
      ${t.was_useful===void 0&&t.answer?`
        <div class="feedback-buttons">
          <span class="feedback-label">Was this helpful?</span>
          <button class="btn btn-sm btn-success" id="feedback-yes">Yes</button>
          <button class="btn btn-sm btn-secondary" id="feedback-no">No</button>
        </div>
      `:""}
      <button class="btn btn-secondary" id="edit-btn">Edit</button>
      <div class="dropdown dismiss-dropdown">
        <button class="btn btn-danger" id="dismiss-btn">Dismiss ‚ñº</button>
        <div class="dropdown-menu" id="dismiss-menu">
          <a href="#" data-reason="duplicate">Duplicate</a>
          <a href="#" data-reason="not_relevant">Not Relevant</a>
          <a href="#" data-reason="out_of_scope">Out of Scope</a>
          <a href="#" data-reason="answered_elsewhere">Answered Elsewhere</a>
          <a href="#" data-reason="no_longer_needed">No Longer Needed</a>
          <a href="#" data-reason="other">Other...</a>
        </div>
      </div>
    </div>
  `,Rb(o,e),Nb(o),Ob(o,t.id,s),Ub(o,t.id,s),Vb(o,t.id),o}function Hb(e){const t=e.extracted_entities||[],n=e.extracted_topics||[];return t.length===0&&n.length===0?"":`<div class="question-entities">${[...t.map(s=>`<span class="entity-tag entity-${s.type}">@${s.name}</span>`),...n.map(s=>`<span class="entity-tag entity-topic">#${s.name}</span>`)].join("")}</div>`}function lt(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function zb(e){return e>=75?"#10b981":e>=50?"#f59e0b":"#6b7280"}function Bb(e){return e.answer?`
    <div class="existing-answer">
      <div class="answer-text">${pe(e.answer)}</div>
      <div class="answer-meta">
        <span class="answer-source-badge">${e.answer_source||"manual"}</span>
        ${e.answered_by_name?`<span class="answered-by">by ${pe(e.answered_by_name)}</span>`:""}
        ${e.answered_at?`<span class="answered-date">${J(e.answered_at)}</span>`:""}
      </div>
      ${e.answer_provenance?Ib(e.answer_provenance):""}
    </div>
  `:""}function Ib(e){return!e.sources||e.sources.length===0?"":`
    <div class="answer-provenance">
      <div class="provenance-label">Sources:</div>
      ${e.sources.map(n=>`
    <div class="provenance-source">
      <span class="source-type">${n.type}</span>
      <span class="source-content">${pe(n.content.substring(0,100))}...</span>
      <span class="source-confidence">${Math.round(n.confidence*100)}%</span>
    </div>
  `).join("")}
    </div>
  `}function Rb(e,t){const{onClose:n,onUpdate:a}=t,s=e.querySelector("#close-detail");s&&d(s,"click",n);const o=e.querySelector("#back-to-list");o&&d(o,"click",M=>{M.preventDefault(),n()});const i=e.querySelector("#ai-suggest-btn");i&&d(i,"click",()=>Il(e));const r=e.querySelector("#check-answers-btn");r&&d(r,"click",()=>Kb(e));const c=e.querySelector("#save-answer-btn");c&&d(c,"click",()=>Wb(e,a));const l=e.querySelector("#reopen-btn");l&&d(l,"click",()=>Or(e,a));const m=e.querySelector("#dismiss-btn"),v=e.querySelector("#dismiss-menu");if(console.log("[QuestionDetail] Dismiss btn found:",!!m,"Menu found:",!!v),m&&v){d(m,"click",q=>{console.log("[QuestionDetail] Dismiss button clicked"),q.stopPropagation(),v.classList.toggle("show")});const M=v.querySelectorAll("a[data-reason]");console.log("[QuestionDetail] Dismiss reason links:",M.length),M.forEach(q=>{d(q,"click",async C=>{C.preventDefault(),C.stopPropagation();const S=q.getAttribute("data-reason");console.log("[QuestionDetail] Dismiss reason clicked:",S),v.classList.remove("show");let L;if(!(S==="other"&&(L=prompt("Please provide a reason for dismissing this question:")||void 0,!L)))try{console.log("[QuestionDetail] Calling dismissQuestionWithReason..."),await Yb(e,t,S,L),console.log("[QuestionDetail] Dismiss completed")}catch(R){console.error("[QuestionDetail] Dismiss error:",R)}})}),document.addEventListener("click",q=>{q.target.closest(".dismiss-dropdown")||v.classList.remove("show")})}else console.warn("[QuestionDetail] Dismiss button or menu not found!");const g=e.querySelector("#defer-btn");g&&d(g,"click",()=>Jb(e,a));const f=e.querySelector("#undefer-btn");f&&d(f,"click",()=>Or(e,a));const b=e.querySelector("#feedback-yes"),w=e.querySelector("#feedback-no");b&&d(b,"click",()=>Ur(e,!0,a)),w&&d(w,"click",()=>Ur(e,!1,a));const $=e.querySelector("#edit-btn");$&&d($,"click",()=>Zb())}async function Nb(e){try{it=(await ke.getAll())?.contacts||[];const n=e.querySelector("#assignee-select"),a=e.querySelector("#answered-by-contact"),s=e.querySelector("#contact-list"),o=e.querySelector("#contact-search");if(n)for(const i of it){const r=document.createElement("option");r.value=i.id,r.textContent=`${i.name}${i.role?` (${i.role})`:""}`,oe?.assigned_to===i.name&&(r.selected=!0),n.appendChild(r)}if(a){for(const r of it){const c=document.createElement("option");c.value=r.id,c.textContent=`${r.name}${r.role?` (${r.role})`:""}`,oe?.answered_by_contact_id===r.id&&(c.selected=!0),a.appendChild(c)}const i=document.createElement("option");i.value="__other__",i.textContent="+ Other (type name)",a.appendChild(i)}s&&(Fr(e,it),o&&o.addEventListener("input",()=>{const i=o.value.toLowerCase(),r=it.filter(c=>c.name.toLowerCase().includes(i)||c.role&&c.role.toLowerCase().includes(i)||c.organization&&c.organization.toLowerCase().includes(i));Fr(e,r)})),Ji(e),Bl(e),zl(e),Fb(e)}catch(t){console.error("Error loading contacts:",t)}}function zl(e){const t=e.querySelector("#show-answerer-picker"),n=e.querySelector("#answerer-picker-dropdown"),a=e.querySelector("#answerer-list"),s=e.querySelector("#answerer-search"),o=e.querySelector("#answerer-other-name");if(!n||!a)return;const i=(c="")=>{const l=c?it.filter(m=>m.name.toLowerCase().includes(c.toLowerCase())||m.role&&m.role.toLowerCase().includes(c.toLowerCase())):it;a.innerHTML=l.map(m=>{const v=m.photoUrl||m.avatarUrl||m.photo_url||m.avatar_url;return`
        <div class="answerer-item" data-contact-id="${m.id}" data-contact-name="${pe(m.name)}">
          <div class="answerer-avatar-sm">
            ${v?`<img src="${v}" alt="${pe(m.name)}" onerror="this.parentElement.innerHTML='${lt(m.name)}'">`:lt(m.name)}
          </div>
          <div class="answerer-info">
            <span class="answerer-name">${pe(m.name)}</span>
            ${m.role?`<span class="answerer-role">${pe(m.role)}</span>`:""}
          </div>
        </div>
      `}).join(""),a.querySelectorAll(".answerer-item").forEach(m=>{d(m,"click",()=>{const v=m.getAttribute("data-contact-id"),g=m.getAttribute("data-contact-name");Hs(e,v||"",g||""),n.style.display="none"})})};t&&d(t,"click",()=>{n.style.display=n.style.display==="none"?"block":"none",i(),s&&s.focus()}),s&&s.addEventListener("input",()=>{i(s.value)}),o&&o.addEventListener("keypress",c=>{if(c.key==="Enter"){const l=o.value.trim();l&&(Hs(e,"",l),n.style.display="none")}});const r=e.querySelector("#clear-answerer");r&&d(r,"click",()=>{Hs(e,"","")}),document.addEventListener("click",c=>{!c.target.closest(".answered-by-picker")&&n.style.display==="block"&&(n.style.display="none")})}function Hs(e,t,n){const a=e.querySelector("#answered-by-display"),s=e.querySelector("#answered-by-contact");if(s&&(s.value=t),a)if(n){const o=it.find(c=>c.id===t),i=o?.photoUrl||o?.avatarUrl||o?.photo_url||o?.avatar_url;a.innerHTML=`
        <div class="answered-by-card" id="current-answerer">
          <div class="answerer-avatar">
            ${i?`<img src="${i}" alt="${pe(n)}" onerror="this.parentElement.innerHTML='${lt(n)}'">`:lt(n)}
          </div>
          <span class="answerer-name">${pe(n)}</span>
          <button type="button" class="btn-clear-answerer" id="clear-answerer">√ó</button>
        </div>
      `;const r=a.querySelector("#clear-answerer");r&&d(r,"click",c=>{c.stopPropagation(),Hs(e,"","")})}else a.innerHTML=`
        <button type="button" class="btn-select-answerer" id="show-answerer-picker">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          Select who answered...
        </button>
      `,zl(e)}function Fb(e){e.querySelectorAll('.source-option input[type="radio"]').forEach(n=>{n.addEventListener("change",()=>{e.querySelectorAll(".source-option").forEach(a=>a.classList.remove("active")),n.closest(".source-option")?.classList.add("active")})})}function Fr(e,t){const n=e.querySelector("#contact-list");if(n){if(t.length===0){n.innerHTML='<div class="empty-state">No contacts found</div>';return}n.innerHTML=t.map(a=>{const s=a.photoUrl||a.avatarUrl||a.photo_url||a.avatar_url,o=oe?.assigned_to===a.name;return`
      <div class="contact-card-picker ${o?"selected":""}" data-contact-id="${a.id}" data-contact-name="${pe(a.name)}">
        <div class="contact-avatar-picker">
          ${s?`<img src="${s}" alt="${pe(a.name)}" onerror="this.parentElement.innerHTML='${lt(a.name)}'">`:lt(a.name)}
        </div>
        <div class="contact-info-picker">
          <div class="contact-name-picker">${pe(a.name)}</div>
          ${a.role?`<div class="contact-role-picker">${pe(a.role)}</div>`:""}
          ${a.organization?`<div class="contact-org-picker">${pe(a.organization)}</div>`:""}
        </div>
        ${o?'<div class="current-badge">Current</div>':""}
      </div>
    `}).join(""),n.querySelectorAll(".contact-card-picker").forEach(a=>{d(a,"click",async()=>{const s=a.getAttribute("data-contact-id"),o=a.getAttribute("data-contact-name"),i=e.querySelector("#assignee-select"),r=e.querySelector("#contact-picker");if(s&&i&&oe){i.value=s;try{await we.update(oe.id,{assigned_to:o||void 0,status:"assigned"}),oe.assigned_to=o||void 0,oe.status="assigned",Ji(e),r&&(r.style.display="none"),u.success(`Assigned to ${o}`)}catch(c){console.error("[QuestionDetail] Failed to save assignment:",c),u.error("Failed to save assignment")}}})})}}function Ji(e){const t=e.querySelector("#current-assignment");if(!(!t||!oe)){if(oe.assigned_to){const n=it.find(s=>s.name===oe?.assigned_to),a=n?.photoUrl||n?.avatarUrl||n?.photo_url||n?.avatar_url;t.innerHTML=`
      <div class="assigned-contact-display">
        <div class="contact-avatar-lg">
          ${a?`<img src="${a}" alt="${pe(oe.assigned_to)}" onerror="this.parentElement.innerHTML='${lt(oe.assigned_to)}'">`:lt(oe.assigned_to)}
        </div>
        <div class="contact-details">
          <div class="contact-name-lg">${pe(oe.assigned_to)}</div>
          <div class="contact-role-sm">${n?.role||"Team Member"}</div>
          ${n?.organization?`<div class="contact-org-sm">${pe(n.organization)}</div>`:""}
        </div>
        <button class="btn-change-assignment" id="change-assignee-btn">
          <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
          </svg>
          Change
        </button>
      </div>
    `}else t.innerHTML=`
      <div class="no-assignment">
        <div class="no-assignment-icon">
          <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
        </div>
        <span>No one assigned yet</span>
        <button class="btn-assign-now" id="show-picker-btn">Assign Someone</button>
      </div>
    `;Bl(e)}}function Bl(e){const t=e.querySelector("#show-picker-btn"),n=e.querySelector("#change-assignee-btn"),a=e.querySelector("#contact-picker");t&&a&&d(t,"click",()=>{a.style.display=a.style.display==="none"?"block":"none";const s=a.querySelector("#contact-search");s&&s.focus()}),n&&a&&d(n,"click",()=>{a.style.display=a.style.display==="none"?"block":"none";const s=a.querySelector("#contact-search");s&&s.focus()})}async function Ob(e,t,n){const a=e.querySelector("#chain-content");if(a)try{const s=await p.get(`/api/questions/${t}/chain`),{parent:o,children:i}=s.data;if(!o&&i.length===0){a.innerHTML='<p class="empty-state">No follow-up chain</p>';return}let r="";o&&(r+=`
        <div class="chain-item chain-parent" data-id="${o.id}">
          <span class="chain-arrow">‚Üê</span>
          <span class="chain-label">Parent:</span>
          <span class="chain-content">${pe(o.content.substring(0,50))}...</span>
          <span class="status-badge status-${o.status}">${o.status}</span>
        </div>
      `),r+='<div class="chain-item chain-current">This question</div>';for(const c of i)r+=`
        <div class="chain-item chain-child" data-id="${c.id}">
          <span class="chain-arrow">‚Üí</span>
          <span class="chain-content">${pe(c.content.substring(0,50))}...</span>
          <span class="status-badge status-${c.status}">${c.status}</span>
        </div>
      `;a.innerHTML=r,a.querySelectorAll(".chain-item[data-id]").forEach(c=>{d(c,"click",()=>{const l=c.getAttribute("data-id");l&&n&&n(l)})})}catch{a.innerHTML='<p class="error">Failed to load chain</p>'}}async function Ub(e,t,n){const a=e.querySelector("#similar-content");if(a)try{const s=await p.get(`/api/questions/${t}/similar?limit=5`),{similar:o}=s.data;if(!o||o.length===0){a.innerHTML='<p class="empty-state">No similar questions found</p>';return}const i=o.map(r=>`
      <div class="similar-item" data-id="${r.id}">
        <div class="similar-content">${pe(r.content.substring(0,60))}...</div>
        <div class="similar-meta">
          <span class="status-badge status-${r.status}">${r.status}</span>
          <span class="similarity-score">${Math.round(r.similarityScore*100)}%</span>
        </div>
      </div>
    `).join("");a.innerHTML=i,a.querySelectorAll(".similar-item").forEach(r=>{d(r,"click",()=>{const c=r.getAttribute("data-id");c&&n&&n(c)})})}catch{a.innerHTML='<p class="error">Failed to load similar questions</p>'}}async function Vb(e,t){const n=e.querySelector("#timeline-content");if(n)try{const a=await p.get(`/api/questions/${t}/timeline`),{events:s}=a.data;if(!s||s.length===0){n.innerHTML='<p class="empty-state">No events recorded</p>';return}const o=s.map(i=>{const r=Gb(i.event_type),c=Qb(i);return`
        <div class="timeline-item">
          <div class="timeline-icon">${r}</div>
          <div class="timeline-content">
            <div class="timeline-title">${c}</div>
            <div class="timeline-date">${Tn(i.created_at)}</div>
          </div>
        </div>
      `}).join("");n.innerHTML=`<div class="timeline-list">${o}</div>`}catch{n.innerHTML='<p class="error">Failed to load timeline</p>'}}function Gb(e){return{created:"üìù",assigned:"üë§",answered:"‚úÖ",priority_changed:"üî∫",status_changed:"üîÑ",reopened:"üîì",dismissed:"‚ùå",sla_breached:"‚è∞",entity_extracted:"üè∑Ô∏è",similar_linked:"üîó"}[e]||"‚Ä¢"}function Qb(e){const t=e.event_data||{};switch(e.event_type){case"created":return`Created${e.actor_name?` by ${e.actor_name}`:""}`;case"assigned":return`Assigned to ${t.to||"someone"}${e.actor_name?` by ${e.actor_name}`:""}`;case"answered":return`Answered${e.actor_name?` by ${e.actor_name}`:""} (${t.source||"manual"})`;case"priority_changed":return`Priority changed: ${t.from} ‚Üí ${t.to}`;case"status_changed":return`Status changed: ${t.from} ‚Üí ${t.to}`;case"reopened":return`Reopened${e.actor_name?` by ${e.actor_name}`:""}`;case"dismissed":return`Dismissed${e.actor_name?` by ${e.actor_name}`:""}`;case"sla_breached":return"SLA breached";case"entity_extracted":return`Entities extracted: ${t.entities?.length||0}`;default:return e.event_type}}async function Il(e){const t=e.querySelector("#suggestions-panel"),n=e.querySelector("#ai-suggest-btn");if(!(!t||!oe)){n.disabled=!0,n.innerHTML=`
    <svg class="spin" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
    </svg>
    Analyzing...
  `,t.style.display="block",t.innerHTML=`
    <div class="suggestions-loading">
      <div class="ai-thinking-animation">
        <span></span><span></span><span></span>
      </div>
      <div class="loading-text">AI is analyzing question context and team expertise...</div>
    </div>
  `;try{const a=await we.suggestAssignee({id:oe.id,useAI:!0});if(a.suggestions.length===0){t.innerHTML=`
        <div class="no-suggestions">
          <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div class="no-suggestions-text">No matching experts found</div>
          <button class="btn-show-all-contacts" id="show-all-btn">Browse all contacts</button>
        </div>
      `;const s=t.querySelector("#show-all-btn");s&&d(s,"click",()=>{t.style.display="none";const o=e.querySelector("#contact-picker");o&&(o.style.display="block")})}else{t.innerHTML=`
        <div class="suggestions-header-sota">
          <div class="ai-badge">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            AI Recommended
          </div>
          ${a.cached?'<span class="cached-tag">Cached</span>':'<span class="fresh-tag">Fresh</span>'}
        </div>
        <div class="suggestions-list-sota">
          ${a.suggestions.map((o,i)=>{const r=it.find(v=>(v.name||"").trim().toLowerCase()===(o.person||"").trim().toLowerCase())||it.find(v=>(v.aliases||[]).some(g=>String(g).trim().toLowerCase()===(o.person||"").trim().toLowerCase())),c=r?.photoUrl||r?.avatarUrl||r?.photo_url||r?.avatar_url,l=r?.role??o.role??"",m=zb(o.score);return`
              <div class="suggestion-card-sota" data-index="${i}">
                <div class="suggestion-rank">#${i+1}</div>
                <div class="suggestion-avatar-sota">
                  ${c?`<img src="${c}" alt="${pe(o.person)}" onerror="this.parentElement.innerHTML='${lt(o.person)}'">`:lt(o.person)}
                </div>
                <div class="suggestion-info-sota">
                  <div class="suggestion-name-sota">${pe(o.person)}</div>
                  ${l?`<div class="suggestion-role-sota">${pe(l)}</div>`:""}
                  <div class="suggestion-reason-sota">${pe(o.reason)}</div>
                </div>
                <div class="suggestion-score-sota" style="--score-color: ${m}">
                  <div class="score-ring">
                    <svg viewBox="0 0 36 36">
                      <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                      <path class="score-fill" stroke-dasharray="${o.score}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                    </svg>
                    <div class="score-value">${o.score}%</div>
                  </div>
                  <div class="score-label">Match</div>
                </div>
                <button class="btn-select-suggestion">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Assign
                </button>
              </div>
            `}).join("")}
        </div>
        <div class="suggestions-footer">
          <button class="btn-link" id="hide-suggestions-btn">Close suggestions</button>
        </div>
      `,t.querySelectorAll(".suggestion-card-sota").forEach(o=>{const i=o.querySelector(".btn-select-suggestion");i&&d(i,"click",async r=>{r.stopPropagation();const c=parseInt(o.getAttribute("data-index")||"0"),l=a.suggestions[c];if(l&&oe){const m=e.querySelector("#assignee-select"),v=it.find(g=>g.name===l.person);try{await we.update(oe.id,{assigned_to:l.person,status:"assigned"}),v&&m&&(m.value=v.id),oe.assigned_to=l.person,oe.status="assigned",Ji(e),t.style.display="none",u.success(`Assigned to ${l.person}`)}catch(g){console.error("[QuestionDetail] Failed to save AI suggestion assignment:",g),u.error("Failed to save assignment")}}})});const s=t.querySelector("#hide-suggestions-btn");s&&d(s,"click",()=>{t.style.display="none"})}}catch(a){const o=(r=>r.message==="Request timed out"||r.status===0)(a);t.innerHTML=`
      <div class="suggestions-error">
        <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>${o?"This took longer than expected.":"Failed to get AI suggestions."}</div>
        ${o?'<p class="suggestions-error-hint">You can try again (suggestions may be ready) or choose someone manually.</p>':""}
        <button class="btn-retry" id="retry-suggestions-btn">Try Again</button>
      </div>
    `;const i=t.querySelector("#retry-suggestions-btn");i&&d(i,"click",()=>Il(e))}finally{n.disabled=!1,n.innerHTML=`
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
      AI Suggest
    `}}}async function Kb(e){const t=e.querySelector("#potential-answers"),n=e.querySelector("#check-answers-btn");if(!(!t||!oe)){n.disabled=!0,n.textContent="Checking...",t.innerHTML='<div class="loading">Searching knowledge base...</div>';try{const a=await p.post(`/api/questions/${oe.id}/check-answer`,{}),{potentialAnswers:s}=a.data;!s||s.length===0?t.innerHTML='<p class="empty-state">No potential answers found in knowledge base</p>':(t.innerHTML=s.map(o=>`
        <div class="potential-answer" data-content="${pe(o.content)}">
          <div class="answer-header">
            <span class="answer-type">${o.type.toUpperCase()}</span>
            <span class="answer-confidence">${Math.round(o.confidence*100)}%</span>
          </div>
          <div class="answer-content">${pe(o.content.substring(0,200))}...</div>
          ${o.source?`<div class="answer-source">Source: ${pe(o.source)}</div>`:""}
          <button class="btn btn-sm btn-secondary use-answer-btn">Use This</button>
        </div>
      `).join(""),t.querySelectorAll(".use-answer-btn").forEach(o=>{d(o,"click",i=>{i.stopPropagation();const c=o.closest(".potential-answer")?.getAttribute("data-content");if(c){const l=e.querySelector("#answer-input");l&&(l.value=c,u.success("Answer filled from knowledge base"))}})}))}catch{t.innerHTML='<p class="error">Failed to check knowledge base</p>'}finally{n.disabled=!1,n.textContent="Check Knowledge Base"}}}async function Wb(e,t){if(!oe)return;const n=e.querySelector("#answer-input"),a=e.querySelector("#answer-source"),s=e.querySelector("#answered-by-contact"),o=e.querySelector("#followup-input"),i=e.querySelector("#save-answer-btn"),r=n?.value.trim(),c=a?.value||"manual",l=s?.value!=="__other__"?s?.value:void 0,m=o?.value.trim();if(!r||r.length<3){u.warning("Please provide an answer (at least 3 characters)");return}let v;l&&(v=it.find(f=>f.id===l)?.name),i.disabled=!0,i.textContent="Saving...";try{const g=await we.answer(oe.id,{answer:r,source:c,followupQuestions:m,answeredByContactId:l,answeredByName:v});u.success(g.message),t&&g.question&&(oe=g.question,t(g.question))}catch{u.error("Failed to save answer")}finally{i.disabled=!1,i.textContent="Save Answer"}}async function Or(e,t){if(!oe)return;const n=prompt("Why are you reopening this question?");if(n)try{const a=await we.reopen(oe.id,n);u.success("Question reopened"),oe=a,t&&t(a)}catch{u.error("Failed to reopen question")}}async function Yb(e,t,n,a){if(console.log("[QuestionDetail] dismissQuestionWithReason called, reason:",n),!oe){console.error("[QuestionDetail] No current question!"),u.error("No question selected");return}console.log("[QuestionDetail] Dismissing question:",oe.id);try{const s=await we.dismissQuestion(oe.id,n,a);console.log("[QuestionDetail] Dismiss API response:",s),u.success(`Question dismissed: ${n.replace(/_/g," ")}`),oe=s,t.onUpdate&&t.onUpdate(s),t.onClose()}catch(s){console.error("[QuestionDetail] Dismiss API error:",s),u.error("Failed to dismiss question")}}async function Jb(e,t){if(!oe)return;const n=document.createElement("div");n.className="modal open",n.id="defer-modal",n.innerHTML=`
    <div class="modal-backdrop"></div>
    <div class="modal-container" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Defer Question</h3>
        <button class="btn btn-icon modal-close">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Defer until</label>
          <input type="datetime-local" id="defer-until" class="form-input" 
            min="${new Date().toISOString().slice(0,16)}" required>
        </div>
        <div class="form-group">
          <label>Quick options</label>
          <div class="defer-quick-options">
            <button class="btn btn-sm btn-secondary" data-days="1">Tomorrow</button>
            <button class="btn btn-sm btn-secondary" data-days="7">Next Week</button>
            <button class="btn btn-sm btn-secondary" data-days="30">Next Month</button>
          </div>
        </div>
        <div class="form-group">
          <label>Reason (optional)</label>
          <input type="text" id="defer-reason" class="form-input" placeholder="Why are you deferring this?">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-defer">Cancel</button>
        <button class="btn btn-primary" id="confirm-defer">Defer</button>
      </div>
    </div>
  `,document.body.appendChild(n),n.querySelector(".modal-close")?.addEventListener("click",()=>n.remove()),n.querySelector(".modal-backdrop")?.addEventListener("click",()=>n.remove()),n.querySelector("#cancel-defer")?.addEventListener("click",()=>n.remove()),n.querySelectorAll(".defer-quick-options button").forEach(a=>{a.addEventListener("click",()=>{const s=parseInt(a.getAttribute("data-days")||"1"),o=new Date;o.setDate(o.getDate()+s);const i=n.querySelector("#defer-until");i.value=o.toISOString().slice(0,16)})}),n.querySelector("#confirm-defer")?.addEventListener("click",async()=>{const a=n.querySelector("#defer-until"),s=n.querySelector("#defer-reason");if(!a.value){u.warning("Please select a date");return}try{const o=await we.deferQuestion(oe.id,new Date(a.value),s.value||void 0);u.success("Question deferred"),n.remove(),oe=o,t&&t(o)}catch{u.error("Failed to defer question")}})}async function Ur(e,t,n){if(!oe)return;let a;t||(a=prompt("What could be improved about this answer?")||void 0);try{const s=await we.submitAnswerFeedback(oe.id,t,a);u.success("Thank you for your feedback!"),oe=s,n&&n(s);const o=e.querySelector(".feedback-buttons");o&&(o.innerHTML=`<span class="feedback-result">${t?"üëç Helpful":"üëé Not helpful"}</span>`)}catch{u.error("Failed to submit feedback")}}function Zb(e){u.info("Edit mode coming soon")}function pe(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Xb=Object.freeze(Object.defineProperty({__proto__:null,createQuestionDetailView:fo},Symbol.toStringTag,{value:"Module"})),ut="question-modal";let Ia=[];function ws(e){const{mode:t,question:n,onSave:a,onDismiss:s}=e;Ia=[];const o=document.querySelector(`[data-modal-id="${ut}"]`);o&&o.remove();const i=x("div",{className:"question-modal-content"});t==="create"?ny(i):t==="edit"&&n?ay(i,n):n&&sy(i,n,t==="answer");const r=x("div",{className:"modal-footer"});ty(r,t,n,i,e);const c=fe({id:ut,title:ey(t),content:i,size:"lg",footer:r});document.body.appendChild(c),he(ut)}function ey(e){switch(e){case"create":return"New Question";case"edit":return"Edit Question";case"answer":return"Answer Question";default:return"Question Details"}}function ty(e,t,n,a,s){const{onSave:o,onDismiss:i,onDelete:r}=s;if(t==="create"){const c=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=x("button",{className:"btn btn-primary",textContent:"Create Question"});d(c,"click",()=>H(ut)),d(l,"click",()=>iy(a,o)),e.appendChild(c),e.appendChild(l)}else if(t==="edit"&&n){const c=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=x("button",{className:"btn btn-primary",textContent:"Save Changes"});d(c,"click",()=>H(ut)),d(l,"click",()=>ry(a,n,o)),e.appendChild(c),e.appendChild(l)}else if(n){const c=n.status;if(c!=="resolved"&&c!=="dismissed"){const m=x("button",{className:"btn btn-secondary",textContent:"Dismiss"});if(d(m,"click",()=>ly(n.id,i)),e.appendChild(m),t==="answer"){const v=x("button",{className:"btn btn-primary",textContent:"Save Answer"});d(v,"click",()=>cy(a,n,o)),e.appendChild(v)}else{const v=x("button",{className:"btn btn-primary",textContent:"Answer"});d(v,"click",()=>{H(ut),ws({...s,mode:"answer"})}),e.appendChild(v)}}else if(c==="resolved"){const m=x("button",{className:"btn btn-warning",textContent:"Reopen"});d(m,"click",()=>dy(n,o)),e.appendChild(m)}const l=x("button",{className:"btn btn-secondary",textContent:"Close"});d(l,"click",()=>H(ut)),e.appendChild(l)}}function ny(e){e.innerHTML=`
    <form id="question-form" class="question-form">
      <div class="form-group">
        <label for="question-content">Question <span class="required">*</span></label>
        <textarea id="question-content" rows="3" required minlength="5"
                  placeholder="What needs to be clarified? (min 5 characters)"></textarea>
        <div id="duplicate-warning" class="form-warning" style="display: none;"></div>
      </div>
      
      <div class="form-group">
        <label for="question-context">Context</label>
        <textarea id="question-context" rows="2"
                  placeholder="Why is this question important?"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="question-priority">Priority</label>
          <select id="question-priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="question-assignee">Assign To</label>
          <input type="text" id="question-assignee" placeholder="Person name">
          <button type="button" id="suggest-assignee-btn" class="btn btn-sm btn-secondary">
            AI Suggest
          </button>
        </div>
      </div>
      
      <div id="suggestions-container" class="suggestions-container" style="display: none;"></div>
    </form>
  `;const t=e.querySelector("#suggest-assignee-btn");t&&d(t,"click",()=>oy(e))}function ay(e,t){e.innerHTML=`
    <form id="question-form" class="question-form">
      <div class="form-group">
        <label for="question-content">Question <span class="required">*</span></label>
        <textarea id="question-content" rows="3" required minlength="5">${Je(t.content)}</textarea>
      </div>
      
      <div class="form-group">
        <label for="question-context">Context</label>
        <textarea id="question-context" rows="2">${Je(t.context||"")}</textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="question-priority">Priority</label>
          <select id="question-priority">
            <option value="low" ${t.priority==="low"?"selected":""}>Low</option>
            <option value="medium" ${t.priority==="medium"?"selected":""}>Medium</option>
            <option value="high" ${t.priority==="high"?"selected":""}>High</option>
            <option value="critical" ${t.priority==="critical"?"selected":""}>Critical</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="question-status">Status</label>
          <select id="question-status">
            <option value="pending" ${t.status==="pending"?"selected":""}>Pending</option>
            <option value="assigned" ${t.status==="assigned"?"selected":""}>Assigned</option>
            <option value="resolved" ${t.status==="resolved"?"selected":""}>Resolved</option>
            <option value="dismissed" ${t.status==="dismissed"?"selected":""}>Dismissed</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="question-assignee">Assigned To</label>
        <input type="text" id="question-assignee" value="${Je(t.assigned_to||"")}">
      </div>
      
      <div class="form-group">
        <label for="question-category">Category</label>
        <input type="text" id="question-category" value="${Je(t.category||"")}">
      </div>
    </form>
  `}function sy(e,t,n){e.innerHTML=`
    <div class="question-view">
      <div class="question-meta">
        <span class="priority-badge priority-${t.priority}">${t.priority}</span>
        <span class="status-badge status-${t.status}">${t.status}</span>
        <span class="question-date">${J(t.created_at)}</span>
        ${t.assigned_to?`<span class="question-assignee">‚Üí ${Je(t.assigned_to)}</span>`:""}
      </div>
      
      <div class="question-content-large">
        ${Je(t.content)}
      </div>
      
      ${t.context?`<div class="question-context"><strong>Context:</strong> ${Je(t.context)}</div>`:""}
      ${t.category?`<div class="question-category"><strong>Category:</strong> ${Je(t.category)}</div>`:""}
      ${t.source_file?`<div class="question-source"><strong>Source:</strong> ${Je(t.source_file)}</div>`:""}
      
      ${t.answer?`
        <div class="question-answer-section">
          <h4>Answer ${t.answer_source?`<span class="answer-source">(${t.answer_source})</span>`:""}</h4>
          <div class="answer-text">${Je(t.answer)}</div>
          ${t.resolved_at?`<div class="answer-date">Resolved ${J(t.resolved_at)}</div>`:""}
        </div>
      `:""}
      
      ${n&&t.status!=="resolved"?`
        <div class="answer-form">
          <div class="form-group">
            <label for="question-answer">Your Answer <span class="required">*</span></label>
            <textarea id="question-answer" rows="4" required minlength="3"
                      placeholder="Provide an answer (min 3 characters)..."></textarea>
          </div>
          <div class="form-group">
            <label for="answer-source">Source</label>
            <select id="answer-source">
              <option value="manual" selected>Manual</option>
              <option value="document">From Document</option>
              <option value="ai">AI Assisted</option>
            </select>
          </div>
          <div class="form-group">
            <label for="followup-questions">Follow-up Questions (one per line)</label>
            <textarea id="followup-questions" rows="2"
                      placeholder="Add any follow-up questions..."></textarea>
          </div>
        </div>
      `:""}
      
      ${t.reopened_reason?`
        <div class="reopen-reason">
          <strong>Reopen Reason:</strong> ${Je(t.reopened_reason)}
        </div>
      `:""}
    </div>
  `}async function oy(e){const n=e.querySelector("#question-content")?.value.trim();if(!n||n.length<5){u.warning("Please enter at least 5 characters for the question");return}const a=e.querySelector("#suggestions-container"),s=e.querySelector("#suggest-assignee-btn");s.disabled=!0,s.textContent="Loading...",a.style.display="block",a.innerHTML='<div class="loading">Getting AI suggestions...</div>';try{const o=await we.suggestAssignee({content:n,useAI:!0});Ia=o.suggestions,Ia.length===0?a.innerHTML='<div class="no-suggestions">No suggestions available</div>':(a.innerHTML=`
        <h4>AI Suggestions ${o.cached?'<span class="cached">(cached)</span>':""}</h4>
        <div class="suggestions-list">
          ${Ia.map((i,r)=>`
            <div class="suggestion-item" data-index="${r}">
              <div class="suggestion-person">${Je(i.person)}</div>
              <div class="suggestion-score">${i.score}%</div>
              <div class="suggestion-reason">${Je(i.reason)}</div>
              ${i.role?`<div class="suggestion-role">${Je(i.role)}</div>`:""}
            </div>
          `).join("")}
        </div>
      `,a.querySelectorAll(".suggestion-item").forEach(i=>{d(i,"click",()=>{const r=parseInt(i.getAttribute("data-index")||"0",10),c=Ia[r];if(c){const l=e.querySelector("#question-assignee");l&&(l.value=c.person),a.style.display="none",u.success(`Selected: ${c.person}`)}})}))}catch{a.innerHTML='<div class="error">Failed to get suggestions</div>'}finally{s.disabled=!1,s.textContent="AI Suggest"}}async function iy(e,t){const n=e.querySelector("#question-form");if(!n.checkValidity()){n.reportValidity();return}const a=o=>e.querySelector(`#${o}`)?.value.trim()||"",s={content:a("question-content"),priority:a("question-priority"),assigned_to:a("question-assignee")||void 0,context:a("question-context")||void 0};try{const o=await we.create(s);if(o.duplicate){const r=e.querySelector("#duplicate-warning");r&&(r.style.display="block",r.innerHTML=`‚ö†Ô∏è Similar question exists (${o.similarity}% match). <a href="#" id="view-duplicate">View existing</a>`);return}u.success("Question created");const i={id:o.id||Date.now(),content:s.content,priority:s.priority||"medium",status:s.assigned_to?"assigned":"pending",assigned_to:s.assigned_to,context:s.context,created_at:new Date().toISOString()};t?.(i),H(ut)}catch{}}async function ry(e,t,n){const a=s=>e.querySelector(`#${s}`)?.value.trim()||"";try{const s=await we.update(t.id,{content:a("question-content"),context:a("question-context")||void 0,priority:a("question-priority"),status:a("question-status"),assigned_to:a("question-assignee")||void 0,category:a("question-category")||void 0});u.success("Question updated"),n?.(s),H(ut)}catch{}}async function cy(e,t,n){const a=e.querySelector("#question-answer"),s=e.querySelector("#answer-source"),o=e.querySelector("#followup-questions"),i=a?.value.trim(),r=s?.value||"manual",c=o?.value.trim();if(!i||i.length<3){u.warning("Please provide an answer (at least 3 characters)");return}try{const l=await we.answer(t.id,{answer:i,source:r,followupQuestions:c});u.success(l.message),n?.(l.question),H(ut)}catch{}}async function ly(e,t){const{confirm:n}=await Y(async()=>{const{confirm:s}=await Promise.resolve().then(()=>Gt);return{confirm:s}},void 0);if(await n("Are you sure you want to dismiss this question?",{title:"Dismiss Question",confirmText:"Dismiss"}))try{await we.delete(e,"dismissed"),u.success("Question dismissed"),t?.(e),H(ut)}catch{}}async function dy(e,t){const{prompt:n}=await Y(async()=>{const{prompt:s}=await Promise.resolve().then(()=>Gt);return{prompt:s}},void 0),a=await n("Why are you reopening this question?",{title:"Reopen Question",placeholder:"Enter reason..."});if(a)try{const s=await we.reopen(e.id,a);u.success("Question reopened"),t?.(s),H(ut)}catch{}}function Je(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let zn="all",Ra="status";function Zi(e={}){const t=x("div",{className:"sot-panel questions-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Questions</h2>
        <span class="panel-count" id="questions-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="questions-filter" class="filter-select">
          <option value="all">All Active</option>
          <option value="pending">Pending</option>
          <option value="assigned">Assigned</option>
          <option value="critical">Critical Priority</option>
          <option value="overdue">Overdue (SLA)</option>
          <option value="resolved">‚úì Resolved</option>
          <option value="dismissed">‚úó Dismissed</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="status">By Status</button>
          <button class="view-tab" data-view="person">By Person</button>
          <button class="view-tab" data-view="team">By Team</button>
        </div>
        <button class="btn btn-secondary btn-sm" id="generate-team-btn" title="Generate questions for team based on roles">‚ö° Generate</button>
        <button class="btn btn-primary btn-sm" id="add-question-btn">+ Add</button>
      </div>
    </div>
    <div class="panel-content" id="questions-content">
      <div class="loading">Loading questions...</div>
    </div>
  `;const n=t.querySelector("#questions-filter");d(n,"change",()=>{zn=n.value,yn(t,e)});const a=t.querySelectorAll(".view-tab");a.forEach(i=>{d(i,"click",()=>{a.forEach(r=>r.classList.remove("active")),i.classList.add("active"),Ra=i.getAttribute("data-view"),yn(t,e)})});const s=t.querySelector("#add-question-btn");s&&d(s,"click",()=>{ws({mode:"create",onSave:()=>yn(t,e)})});const o=t.querySelector("#generate-team-btn");return o&&d(o,"click",()=>my(t,e)),yn(t,e),B.subscribe(()=>{Ol(t)}),t}async function yn(e,t){const n=e.querySelector("#questions-content");n.innerHTML='<div class="loading">Loading...</div>';try{let a=[];if(Ra==="status")zn==="overdue"?(a=await we.getAll(),a=a.filter(s=>s.sla_breached===!0||s.status!=="resolved"&&s.status!=="dismissed"&&py(s))):zn==="critical"?(a=await we.getAll(),a=a.filter(s=>s.priority==="critical"&&s.status!=="resolved"&&s.status!=="dismissed")):zn==="all"?(a=await we.getAll(),a=a.filter(s=>s.status!=="dismissed"&&s.status!=="resolved"&&s.status!=="closed")):zn==="dismissed"?(a=await we.getAll(),a=a.filter(s=>s.status==="dismissed")):zn==="resolved"?(a=await we.getAll(),a=a.filter(s=>s.status==="resolved"||s.status==="answered")):(a=await we.getAll(),a=a.filter(s=>s.status===zn)),uy(n,a,t);else if(Ra==="person"){const s=await we.getByPerson();Vr(n,s,t)}else if(Ra==="team"){const s=await we.getByTeam();Vr(n,s,t)}Ra==="status"&&B.setQuestions(a),Ol(e)}catch{n.innerHTML='<div class="error">Failed to load questions</div>'}}function py(e){if(!e.created_at)return!1;const t=e.sla_hours||168,n=new Date(e.created_at),a=new Date(n.getTime()+t*60*60*1e3);return new Date>a}function uy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No questions found</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Question</button>
      </div>
    `;const a=e.querySelector("#empty-add-btn");a&&d(a,"click",()=>{ws({mode:"create"})});return}e.innerHTML=t.map(a=>Rl(a)).join(""),Nl(e,t,n)}function Vr(e,t,n){const a=Object.entries(t);if(a.length===0){e.innerHTML='<div class="empty-state"><p>No questions found</p></div>';return}e.innerHTML=a.map(([o,i])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${Nt(o)}</h3>
        <span class="group-count">${i.length}</span>
      </div>
      <div class="group-items">
        ${i.map(r=>Rl(r)).join("")}
      </div>
    </div>
  `).join("");const s=a.flatMap(([,o])=>o);Nl(e,s,n)}function Rl(e){const t=`priority-${e.priority}`,n=`status-${e.status}`,a=e.sla_breached,s=e.answer_source==="auto-detected",o=!!e.answer,i=!!e.requester_role,r=g=>{if(!g)return"?";const f=g.trim().split(/\s+/);return f.length===1?f[0].substring(0,2).toUpperCase():(f[0][0]+f[f.length-1][0]).toUpperCase()};let c=`<div class="question-card-sota${a?" sla-breached":""}${o?" has-answer":""}" data-id="${e.id}">`;c+=`<div class="card-priority-bar ${t}"></div>`,c+='<div class="card-body">',c+='<div class="card-top-row">',c+='<div class="card-badges">',c+=`<span class="priority-pill ${t}">${e.priority}</span>`,c+=`<span class="status-pill ${n}">${e.status}</span>`,a&&(c+='<span class="sla-pill">SLA</span>'),s&&(c+='<span class="auto-pill">Answer Found</span>'),e.follow_up_to&&(c+='<span class="followup-pill">Follow-up</span>'),c+="</div>",c+=`<span class="card-timestamp">${J(e.created_at)}</span>`,c+="</div>",c+=`<div class="card-question-text">${Nt(e.content)}</div>`,c+='<div class="card-bottom-row">';const l=B.getState().contacts||[],m=(g,f)=>{const b=f?l.find(w=>w.id===f):l.find(w=>w.name===g);return b?.photoUrl||b?.avatarUrl||b?.photo_url||b?.avatar_url||null},v=(g,f,b)=>f?`<div class="${b}"><img src="${f}" alt="${Nt(g)}" onerror="this.parentElement.innerHTML='${r(g)}'"></div>`:`<div class="${b}">${r(g)}</div>`;if(c+='<div class="card-requester">',i){const g=e.requester_name||"",f=e.requester_role||"",b=e.requester_contact_id,w=m(g,b);c+='<div class="requester-chip">',c+=v(g||f,w,"requester-avatar"),c+='<div class="requester-info">',g&&(c+=`<span class="requester-name">${Nt(g)}</span>`),c+=`<span class="requester-role">${Nt(f)}</span>`,c+="</div>",c+="</div>"}if(c+="</div>",c+='<div class="card-assignment">',e.assigned_to){const g=m(e.assigned_to);c+='<div class="assignee-chip">',c+=v(e.assigned_to,g,"assignee-avatar"),c+='<div class="assignee-info">',c+=`<span class="assignee-name">${Nt(e.assigned_to)}</span>`,o&&(c+='<span class="answered-badge">Answered</span>'),c+="</div>",c+="</div>"}else c+='<div class="unassigned-chip">',c+="<span>Unassigned</span>",c+="</div>";return c+="</div>",c+="</div>",c+="</div>",c+="</div>",c}function Nl(e,t,n){e.querySelectorAll(".question-card-sota").forEach(a=>{d(a,"click",()=>{const s=a.getAttribute("data-id"),o=t.find(i=>String(i.id)===s);o&&(n.onQuestionClick?n.onQuestionClick(o):n.useDetailView&&n.containerElement?Fl(o,n):ws({mode:"view",question:o,onSave:()=>yn(e.closest(".questions-panel"),n)}))})})}function Fl(e,t){const n=t.containerElement;if(!n)return;const a=n.innerHTML,s=fo({question:e,onClose:()=>{n.innerHTML=a;const o=n.querySelector(".questions-panel");o&&yn(o,t)},onUpdate:o=>{if(o.status==="dismissed"||o.status==="resolved"||o.status==="closed"){n.innerHTML=a;const i=n.querySelector(".questions-panel");i&&yn(i,t),u.info("Question updated - returning to list")}},onNavigateToQuestion:async o=>{try{const r=(await we.getAll()).find(c=>String(c.id)===o);r&&Fl(r,t)}catch{u.error("Failed to load question")}}});n.innerHTML="",n.appendChild(s)}async function my(e,t){const n=document.createElement("div");n.className="modal open",n.id="generate-ai-modal",n.innerHTML=`
    <div class="modal-backdrop"></div>
    <div class="modal-container modal-sota" style="position: relative;">
      <!-- Header -->
      <div class="sota-header header-primary">
        <div class="header-row">
          <div class="header-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
              <circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/>
            </svg>
          </div>
          <div class="header-text">
            <h2>AI Question Generator</h2>
            <p>Generate contextual questions for your project team</p>
          </div>
        </div>
        <button class="header-close" id="close-modal">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <!-- Tabs -->
      <div class="sota-tabs">
        <button class="sota-tab active" data-source="team">
          <span class="tab-icon">üë•</span>
          <span>Team Members</span>
        </button>
        <button class="sota-tab" data-source="contacts">
          <span class="tab-icon">üìá</span>
          <span>Project Contacts</span>
        </button>
      </div>

      <!-- Body -->
      <div class="sota-body">
        <!-- Section: Roles -->
        <div class="sota-section">
          <div class="section-title">
            <span class="title-icon">üé≠</span>
            <span>Select a Role</span>
          </div>
          <div id="roles-grid" class="sota-grid">
            <div class="sota-loading">
              <div class="spinner-ring"></div>
              <p>Loading roles...</p>
            </div>
          </div>
        </div>

        <!-- Section: Configuration (hidden until role selected) -->
        <div class="sota-section" id="config-section" style="display: none;">
          <div id="selected-badge"></div>
          
          <div class="config-row">
            <label>Questions to generate</label>
            <div class="config-buttons">
              <button class="config-btn active" data-count="auto" title="AI determines optimal count">‚ú® Auto</button>
              <button class="config-btn" data-count="3">3</button>
              <button class="config-btn" data-count="5">5</button>
              <button class="config-btn" data-count="8">8</button>
            </div>
          </div>

          <label class="toggle-row">
            <input type="checkbox" id="use-context" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span>Use project context (facts, documents)</span>
          </label>
          
          <label class="toggle-row">
            <input type="checkbox" id="skip-dupes" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span>Skip duplicate questions</span>
          </label>

          <button class="sota-btn-primary" id="btn-generate" style="margin-top: 20px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
            Generate Questions
          </button>
        </div>
      </div>

      <!-- Overlay for generation -->
      <div class="sota-overlay" id="gen-overlay" style="display: none;">
        <div id="gen-content">
          <div class="overlay-spinner"></div>
          <h4 class="overlay-title">Generating questions...</h4>
          <p class="overlay-subtitle">AI is analyzing your project context</p>
        </div>
      </div>
    </div>
  `,document.body.appendChild(n);let a="team",s=null,o=[],i="auto";const r=n.querySelector("#roles-grid"),c=n.querySelector("#config-section"),l=n.querySelector("#selected-badge"),m=n.querySelector("#gen-overlay"),v=n.querySelector("#gen-content"),g=M=>M?M.split(" ").map(q=>q[0]).join("").substring(0,2).toUpperCase():"?",f=M=>{const q=M.toLowerCase();return q.includes("analyst")||q.includes("data")?"üìä":q.includes("manager")||q.includes("lead")?"üëî":q.includes("developer")||q.includes("engineer")?"üíª":q.includes("design")||q.includes("ux")?"üé®":q.includes("product")||q.includes("owner")?"üì¶":q.includes("qa")||q.includes("test")?"üß™":q.includes("support")||q.includes("success")?"ü§ù":q.includes("sales")||q.includes("commercial")?"üí∞":q.includes("marketing")?"üì£":q.includes("security")?"üîí":q.includes("devops")||q.includes("infra")?"üöÄ":q.includes("legal")?"‚öñÔ∏è":"üë§"},b=async M=>{r.innerHTML='<div class="sota-loading"><div class="spinner-ring"></div><p>Loading roles...</p></div>',c.style.display="none",s=null;try{let q=[];if(M==="team")q=(await p.get("/api/questions/team-roles")).data.roles||[];else{const S=(await p.get("/api/contacts")).data.contacts||[],L={};for(const R of S)R.role&&(L[R.role]||(L[R.role]={role:R.role,members:[]}),L[R.role].members.push({id:R.id,name:R.name,photoUrl:R.photo_url,email:R.email}));q=Object.values(L)}if(o=q,q.length===0){r.innerHTML=`
          <div class="sota-empty" style="grid-column: 1 / -1;">
            <div class="empty-icon">${M==="team"?"üë•":"üìá"}</div>
            <h4>No ${M==="team"?"Team Members":"Contacts"} with Roles</h4>
            <p>${M==="team"?"Add team members with roles in Project Settings":"Add contacts with roles to this project"}</p>
          </div>
        `;return}r.innerHTML=q.map((C,S)=>`
        <div class="sota-card" data-idx="${S}">
          <div class="card-icon">${f(C.role)}</div>
          <div class="card-title">${Nt(C.role)}</div>
          <div class="card-avatars">
            ${C.members.slice(0,3).map(L=>`
              <div class="mini-avatar" title="${Nt(L.name)}">
                ${L.photoUrl?`<img src="${L.photoUrl}" alt="" onerror="this.style.display='none';this.nextSibling.style.display='flex'">`:""}
                <span style="${L.photoUrl?"display:none":""}">${g(L.name)}</span>
              </div>
            `).join("")}
            ${C.members.length>3?`<div class="mini-avatar more">+${C.members.length-3}</div>`:""}
          </div>
          <div class="card-subtitle">${C.members.map(L=>L.name).slice(0,2).join(", ")}${C.members.length>2?"...":""}</div>
          <div class="card-badge">${C.members.length}</div>
        </div>
      `).join(""),r.querySelectorAll(".sota-card").forEach(C=>{C.addEventListener("click",()=>{r.querySelectorAll(".sota-card").forEach(L=>L.classList.remove("selected")),C.classList.add("selected");const S=parseInt(C.getAttribute("data-idx")||"0",10);s=o[S],w()})})}catch{r.innerHTML=`
        <div class="sota-empty" style="grid-column: 1 / -1;">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <h4>Failed to Load</h4>
          <p>Could not fetch roles. Please try again.</p>
          <button class="sota-btn-primary" style="max-width: 200px; margin: 16px auto 0;" id="retry-load">Retry</button>
        </div>
      `,n.querySelector("#retry-load")?.addEventListener("click",()=>b(M))}},w=()=>{s&&(c.style.display="block",l.innerHTML=`
      <div class="selected-badge">
        <span class="badge-icon">${f(s.role)}</span>
        <div class="badge-info">
          <strong>${Nt(s.role)}</strong>
          <span>${s.members.map(M=>M.name).join(", ")}</span>
        </div>
        <button class="badge-clear" id="clear-selection">√ó</button>
      </div>
    `,n.querySelector("#clear-selection")?.addEventListener("click",()=>{s=null,c.style.display="none",r.querySelectorAll(".sota-card").forEach(M=>M.classList.remove("selected"))}))},$=async()=>{if(s){m.style.display="flex";try{const M=await p.post("/api/questions/generate-ai",{role:s.role,memberIds:s.members.map(C=>C.id),count:i,includeContext:n.querySelector("#use-context")?.checked??!0,skipDuplicates:n.querySelector("#skip-dupes")?.checked??!0}),q=M.data.questions||[];v.innerHTML=`
        <div class="sota-success">
          <div class="success-icon">‚úì</div>
          <h4>${M.data.generated} Questions Generated</h4>
          <p>${M.data.skipped>0?`${M.data.skipped} duplicates skipped`:"All questions created successfully"}</p>
        </div>
        <div class="results-list">
          ${q.slice(0,5).map(C=>`
            <div class="result-row">
              <span class="result-badge ${C.priority}">${C.priority}</span>
              <span class="result-text">${Nt(C.content.length>70?C.content.substring(0,70)+"...":C.content)}</span>
            </div>
          `).join("")}
          ${q.length>5?`<p style="text-align: center; color: var(--text-muted); margin-top: 8px; font-size: 12px;">+ ${q.length-5} more questions</p>`:""}
        </div>
        <p style="text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 12px;">
          üìã Questions from <strong>${s?.role}</strong> perspective<br>
          <span style="color: var(--text-muted);">Use AI Suggest on each question to find who should answer</span>
        </p>
        <button class="sota-btn-primary" id="btn-done">Done</button>
      `,n.querySelector("#btn-done")?.addEventListener("click",()=>{n.remove(),yn(e,t)})}catch{v.innerHTML=`
        <div class="sota-error">
          <div class="error-icon">‚úó</div>
          <h4>Generation Failed</h4>
          <p>Something went wrong. Please try again.</p>
          <button class="sota-btn-primary" id="retry-gen" style="max-width: 200px; margin: 20px auto 0;">Retry</button>
        </div>
      `,n.querySelector("#retry-gen")?.addEventListener("click",$)}}};n.querySelector("#close-modal")?.addEventListener("click",()=>n.remove()),n.querySelector(".modal-backdrop")?.addEventListener("click",()=>n.remove()),n.querySelectorAll(".sota-tab").forEach(M=>{M.addEventListener("click",()=>{n.querySelectorAll(".sota-tab").forEach(q=>q.classList.remove("active")),M.classList.add("active"),a=M.getAttribute("data-source")||"team",b(a)})}),n.querySelectorAll(".config-btn").forEach(M=>{M.addEventListener("click",()=>{n.querySelectorAll(".config-btn").forEach(C=>C.classList.remove("active")),M.classList.add("active");const q=M.getAttribute("data-count")||"auto";i=q==="auto"?"auto":parseInt(q,10)})}),n.querySelector("#btn-generate")?.addEventListener("click",$),b("team")}function Ol(e){const t=e.querySelector("#questions-count");if(t){const n=B.getState().questions;t.textContent=String(n.length)}}function Nt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ul(e={}){const t=x("div",{className:"source-of-truth"}),n=x("div",{className:"tabs"});[{id:"questions",label:"Questions",icon:"‚ùì"},{id:"risks",label:"Risks",icon:"‚ö†Ô∏è"},{id:"actions",label:"Actions",icon:"‚úÖ"},{id:"decisions",label:"Decisions",icon:"üéØ"}].forEach(g=>{const f=x("button",{className:"tab"});f.setAttribute("data-tab",g.id),f.innerHTML=`${g.icon} ${g.label} <span class="badge" data-count="0">0</span>`,d(f,"click",()=>{ve.setSotView(g.id)}),n.appendChild(f)}),t.appendChild(n);const s=x("div",{className:"tab-panels"}),o=Zi({onQuestionClick:e.onQuestionClick,useDetailView:!0,containerElement:t});o.classList.add("tab-panel");const i=gy(e.onRiskClick),r=fy(e.onActionClick),c=by({onDecisionClick:e.onDecisionClick});o.setAttribute("data-panel","questions"),i.setAttribute("data-panel","risks"),r.setAttribute("data-panel","actions"),c.setAttribute("data-panel","decisions"),s.appendChild(o),s.appendChild(i),s.appendChild(r),s.appendChild(c),t.appendChild(s),ve.subscribe(g=>{n.querySelectorAll(".tab").forEach(f=>{f.getAttribute("data-tab")===g.sotCurrentView?qt(f,"active"):cn(f,"active")}),s.querySelectorAll("[data-panel]").forEach(f=>{f.getAttribute("data-panel")===g.sotCurrentView?qt(f,"active"):cn(f,"active")})}),B.subscribe(g=>{const f=n.querySelector('[data-tab="questions"] .badge'),b=n.querySelector('[data-tab="risks"] .badge'),w=n.querySelector('[data-tab="actions"] .badge'),$=n.querySelector('[data-tab="decisions"] .badge');f&&(f.textContent=String(g.questions.length)),b&&(b.textContent=String(g.risks.length)),w&&(w.textContent=String(g.actions.length)),$&&($.textContent=String(g.decisions.length)),Vl(o,g.questions,e.onQuestionClick),vy(i,g.risks,e.onRiskClick),hy(r,g.actions,e.onActionClick),yy(c,g.decisions,e.onDecisionClick)});const l=ve.getState().sotCurrentView,m=n.querySelector(`[data-tab="${l}"]`),v=s.querySelector(`[data-panel="${l}"]`);return m&&qt(m,"active"),v&&qt(v,"active"),t}function Vl(e,t,n){const a=e.querySelector(".questions-list");if(a){if(t.length===0){a.innerHTML='<div class="empty-state">No questions yet</div>';return}a.innerHTML=t.map(s=>`
    <div class="question-card ${s.status}" data-id="${s.id}">
      <div class="question-header">
        <span class="priority-badge priority-${s.priority}">${s.priority}</span>
        <span class="status-badge ${s.status}">${s.status}</span>
      </div>
      <div class="question-text">${rn(s.content||s.question||"")}</div>
      ${s.answer?`<div class="question-answer">${rn(s.answer)}</div>`:""}
      <div class="question-meta">${J(s.created_at||s.createdAt||new Date().toISOString())}</div>
    </div>
  `).join(""),a.querySelectorAll(".question-card").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-id"),i=t.find(r=>r.id===o||String(r.id)===o);i&&(n&&n(i),Gl(e,i,t))})})}}function Gl(e,t,n){const a=e.innerHTML,s=fo({question:t,onClose:()=>{e.innerHTML=a;const o=B.getState().questions;Vl(e,o)},onUpdate:o=>{const i=B.getState().questions,r=i.findIndex(c=>c.id===o.id||String(c.id)===String(o.id));r>=0&&(i[r]=o,B.setQuestions(i))},onNavigateToQuestion:o=>{const i=n.find(r=>String(r.id)===o);i&&Gl(e,i,n)}});e.innerHTML="",e.appendChild(s)}function gy(e){const t=x("div",{className:"tab-panel risks-panel"});return t.innerHTML='<div class="risks-list"></div>',t}function vy(e,t,n){const a=e.querySelector(".risks-list");if(a){if(t.length===0){a.innerHTML='<div class="empty-state">No risks identified</div>';return}a.innerHTML=t.map(s=>`
    <div class="risk-card ${s.impact}-impact" data-id="${s.id}">
      <div class="risk-header">
        <span class="impact-badge impact-${s.impact}">${s.impact} impact</span>
        <span class="probability-badge">${s.probability} probability</span>
      </div>
      <div class="risk-description">${rn(s.description||s.content||"")}</div>
      ${s.mitigation?`<div class="risk-mitigation">Mitigation: ${rn(s.mitigation)}</div>`:""}
    </div>
  `).join(""),n&&a.querySelectorAll(".risk-card").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-id"),i=t.find(r=>r.id===o);i&&n(i)})})}}function fy(e){const t=x("div",{className:"tab-panel actions-panel"});return t.innerHTML='<div class="actions-list"></div>',t}function hy(e,t,n){const a=e.querySelector(".actions-list");if(a){if(t.length===0){a.innerHTML='<div class="empty-state">No actions defined</div>';return}a.innerHTML=t.map(s=>`
    <div class="action-card ${s.status}" data-id="${s.id}">
      <div class="action-header">
        <span class="priority-badge priority-${s.priority}">${s.priority}</span>
        <span class="status-badge ${s.status}">${s.status.replace("_"," ")}</span>
      </div>
      <div class="action-task">${rn(s.task)}</div>
      <div class="action-meta">
        ${s.assignee?`<span>Assigned to: ${rn(s.assignee)}</span>`:""}
        ${s.dueDate?`<span>Due: ${s.dueDate}</span>`:""}
      </div>
    </div>
  `).join(""),n&&a.querySelectorAll(".action-card").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-id"),i=t.find(r=>r.id===o);i&&n(i)})})}}function by(e){const t=x("div",{className:"tab-panel decisions-panel"});return t.innerHTML='<div class="decisions-list"></div>',t}function yy(e,t,n){const a=e.querySelector(".decisions-list");if(a){if(t.length===0){a.innerHTML='<div class="empty-state">No decisions recorded</div>';return}a.innerHTML=t.map(s=>`
    <div class="decision-card" data-id="${s.id}">
      <div class="decision-header">
        <span class="status-badge ${s.status}">${s.status}</span>
      </div>
      <div class="decision-text">${rn(s.content??s.decision??"")}</div>
      ${s.rationale?`<div class="decision-rationale">Rationale: ${rn(s.rationale)}</div>`:""}
      <div class="decision-meta">
        ${s.made_by??s.madeBy?`<span>By: ${rn(s.made_by??s.madeBy??"")}</span>`:""}
        <span>${J(s.decided_at??s.created_at??s.madeAt??"")}</span>
      </div>
    </div>
  `).join(""),n&&a.querySelectorAll(".decision-card").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-id"),i=t.find(r=>r.id===o);i&&n(i)})})}}function rn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function xy(e,t={}){const n=document.querySelector(e);if(!n)return console.warn(`SourceOfTruth: Container not found: ${e}`),null;const a=Ul(t);return n.appendChild(a),a}const un="risk-modal";function Sa(e){const{mode:t,risk:n,onSave:a,onDelete:s}=e,o=t==="edit"&&n?.id,i=t==="view",r=document.querySelector(`[data-modal-id="${un}"]`);r&&r.remove();const c=x("div",{className:"risk-modal-content"}),l=n?.description??n?.content??"",m=n?.probability??n?.likelihood??"medium",v=n?.createdAt??n?.created_at??"";if(i&&n)c.innerHTML=`
      <div class="risk-view">
        <div class="risk-meta">
          <span class="impact-badge impact-${n.impact}">${n.impact} impact</span>
          <span class="probability-badge">${m} probability</span>
          <span class="status-badge ${n.status}">${n.status}</span>
        </div>
        
        <div class="risk-description-large">
          ${Ao(l)}
        </div>
        
        ${n.mitigation?`
          <div class="risk-mitigation-section">
            <h4>Mitigation Strategy</h4>
            <p>${Ao(n.mitigation)}</p>
          </div>
        `:""}
        
        <div class="risk-date">Created ${J(v)}</div>
      </div>
    `;else{const b=n?.owner??"";c.innerHTML=`
      <form id="risk-form" class="risk-form">
        <div class="form-group" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
          <label for="risk-description" style="margin-bottom: 0;">Risk Description *</label>
          <button type="button" class="btn btn-secondary btn-sm" id="risk-ai-suggest-btn" title="Suggest owner and mitigation from description">‚ú® AI suggest</button>
        </div>
        <div class="form-group">
          <textarea id="risk-description" rows="3" required 
                    placeholder="Describe the risk...">${l}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="risk-impact">Impact</label>
            <select id="risk-impact">
              <option value="low" ${n?.impact==="low"?"selected":""}>Low</option>
              <option value="medium" ${n?.impact==="medium"||!n?"selected":""}>Medium</option>
              <option value="high" ${n?.impact==="high"?"selected":""}>High</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="risk-probability">Probability</label>
            <select id="risk-probability">
              <option value="low" ${m==="low"?"selected":""}>Low</option>
              <option value="medium" ${m==="medium"?"selected":""}>Medium</option>
              <option value="high" ${m==="high"?"selected":""}>High</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="risk-status">Status</label>
          <select id="risk-status">
            <option value="open" ${n?.status==="open"||!n?"selected":""}>Open</option>
            <option value="mitigating" ${n?.status==="mitigating"?"selected":""}>Mitigating</option>
            <option value="mitigated" ${n?.status==="mitigated"?"selected":""}>Mitigated</option>
            <option value="accepted" ${n?.status==="accepted"?"selected":""}>Accepted</option>
            <option value="closed" ${n?.status==="closed"?"selected":""}>Closed</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="risk-owner">Owner</label>
          <input type="text" id="risk-owner" class="form-input" placeholder="Who owns this risk?" value="${Ao(b)}">
        </div>
        
        <div class="form-group">
          <label for="risk-mitigation">Mitigation Strategy</label>
          <textarea id="risk-mitigation" rows="3" 
                    placeholder="How will this risk be mitigated?">${n?.mitigation||""}</textarea>
        </div>
      </form>
    `;const w=c.querySelector("#risk-ai-suggest-btn");w&&d(w,"click",async()=>{const $=c.querySelector("#risk-description"),M=c.querySelector("#risk-impact"),q=c.querySelector("#risk-probability"),C=$?.value?.trim()||"";if(!C){u.error("Enter a risk description first");return}w.disabled=!0,w.textContent="‚Ä¶";try{const S=await Ke.suggest({content:C,impact:M?.value||"medium",likelihood:q?.value||"medium"}),L=c.querySelector("#risk-owner"),R=c.querySelector("#risk-mitigation");L&&S.suggested_owner&&(L.value=S.suggested_owner),R&&S.suggested_mitigation&&(R.value=S.suggested_mitigation),u.success("Owner and mitigation suggested")}catch(S){u.error(S.message||"AI suggest failed")}finally{w.disabled=!1,w.textContent="‚ú® AI suggest"}})}const g=x("div",{className:"modal-footer"});if(i){const b=x("button",{className:"btn btn-primary",textContent:"Edit"}),w=x("button",{className:"btn btn-secondary",textContent:"Close"});d(w,"click",()=>H(un)),d(b,"click",()=>{H(un),Sa({...e,mode:"edit"})}),g.appendChild(w),g.appendChild(b)}else{const b=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),w=x("button",{className:"btn btn-primary",textContent:o?"Save Changes":"Create Risk"});if(d(b,"click",()=>H(un)),d(w,"click",async()=>{const $=c.querySelector("#risk-form");if(!$.checkValidity()){$.reportValidity();return}const M=L=>c.querySelector(`#${L}`)?.value.trim()||"",q=M("risk-description"),C=M("risk-owner")||void 0,S={id:n?.id||`risk-${Date.now()}`,description:q,content:q,impact:M("risk-impact"),probability:M("risk-probability"),likelihood:M("risk-probability"),status:M("risk-status"),mitigation:M("risk-mitigation")||void 0,owner:C,createdAt:n?.createdAt??n?.created_at??new Date().toISOString()};w.disabled=!0,w.textContent="Saving...";try{if(o)await p.put(`/api/risks/${n.id}`,{content:S.content??S.description,impact:S.impact,likelihood:S.likelihood??S.probability,mitigation:S.mitigation,status:S.status,owner:S.owner}),u.success("Risk updated");else{const L=await p.post("/api/risks",{content:S.content??S.description,impact:S.impact,likelihood:S.likelihood??S.probability,mitigation:S.mitigation,status:S.status,owner:S.owner}),R=L.data.risk;R?S.id=R.id:S.id=L.data.id,u.success("Risk created")}a?.({...S,description:S.description??S.content,content:S.content??S.description}),H(un)}catch{}finally{w.disabled=!1,w.textContent=o?"Save Changes":"Create Risk"}}),o){const $=x("button",{className:"btn btn-danger",textContent:"Delete"});d($,"click",async()=>{const{confirm:M}=await Y(async()=>{const{confirm:C}=await Promise.resolve().then(()=>Gt);return{confirm:C}},void 0);if(await M("Are you sure you want to delete this risk?",{title:"Delete Risk",confirmText:"Delete",confirmClass:"btn-danger"}))try{await p.delete(`/api/risks/${n.id}`),u.success("Risk deleted"),s?.(String(n.id)),H(un)}catch{}}),g.appendChild(w),g.appendChild(b),g.appendChild($)}else g.appendChild(w),g.appendChild(b)}const f=fe({id:un,title:i?"Risk Details":o?"Edit Risk":"New Risk",content:c,size:"md",footer:g});document.body.appendChild(f),he(un)}function Ao(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function ce(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Gr(e){if(!e)return"‚Äî";try{return Tn(e)}catch{return e}}function Qr(e){return e>=70?"var(--success, #4ecdc4)":e>=50?"var(--warning, #ffe66d)":"var(--text-muted, #6a6a8a)"}function jt(e){return e.trim().split(/\s+/).map(t=>t[0]).join("").toUpperCase().substring(0,2)}function wy(e){return{created:"üìù",updated:"‚úèÔ∏è",deleted:"üóëÔ∏è",restored:"‚Ü©Ô∏è"}[e]||"‚Ä¢"}function ky(e){const t=e.event_data||{},n=e.actor_name?` by ${e.actor_name}`:"";switch(e.event_type){case"created":return`Created${n}`;case"updated":{const a=t.changes||[];if(a.length===0)return`Updated${n}`;if(a.length===1){const s=a[0],o=String(s.to).trim()?s.to:"‚Äî",i=String(s.from).trim()?s.from:"‚Äî";return`${s.field} changed: ${i} ‚Üí ${o}${n}`}return`${a.map(s=>`${s.field}: ${s.from||"‚Äî"} ‚Üí ${s.to||"‚Äî"}`).join("; ")}${n}`}case"deleted":return`Deleted${t.reason?` (${t.reason})`:""}${n}`;case"restored":return`Restored${n}`;default:return e.event_type}}function Xi(e){const{risk:t,onClose:n,onUpdate:a}=e,s=x("div",{className:"risk-detail-view question-detail-view"});s.innerHTML=`
    <div class="question-detail-header risk-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Risks</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Risk #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        <span class="status-badge status-${(t.status||"open").toLowerCase()}">${ce(String(t.status))}</span>
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content risk-detail-content">
      <div id="risk-view-content">
      <section class="detail-section risk-main">
        <div class="question-badges risk-badges">
          ${t.impact?`<span class="priority-pill impact-${t.impact}">${ce(t.impact)} impact</span>`:""}
          ${t.likelihood?`<span class="priority-pill likelihood-${t.likelihood}">${ce(t.likelihood)} likelihood</span>`:""}
          ${t.generation_source?`<span class="status-pill">${ce(t.generation_source)}</span>`:""}
          <span class="question-date risk-date">Created ${J(t.created_at)}</span>
        </div>
        <h2 class="question-text risk-content-text">${ce(t.content)}</h2>
      </section>

      <div class="detail-columns">
        <div class="detail-column-left">
          <!-- Assignment (Owner) Section - SOTA (aligned with Questions) -->
          <section class="detail-section" id="risk-assignment-section">
            <div class="section-header-sota">
              <h3>
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Assignment
                <span class="section-subtitle">Who should own this risk?</span>
              </h3>
              <button type="button" class="btn-ai-suggest" id="risk-ai-suggest-btn" title="Suggest owner and mitigation from risk content">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Suggest
              </button>
            </div>

            <!-- Current Assignment (Owner) Display -->
            <div id="risk-current-assignment" class="current-assignment-card">
              ${t.owner?`
                <div class="assigned-contact-display">
                  <div class="contact-avatar-lg" id="risk-assigned-avatar">${jt(t.owner)}</div>
                  <div class="contact-details">
                    <div class="contact-name-lg">${ce(t.owner)}</div>
                    <div class="contact-role-sm" id="risk-assigned-role">‚Äî</div>
                  </div>
                  <button class="btn-change-assignment" id="risk-change-owner-btn" type="button">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    Change
                  </button>
                </div>
              `:`
                <div class="no-assignment">
                  <div class="no-assignment-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  </div>
                  <span>No one assigned</span>
                  <p class="no-assignment-hint">Use AI Suggest or choose manually</p>
                  <button class="btn-assign-now" id="risk-show-picker-btn" type="button">Choose Manually</button>
                </div>
              `}
            </div>

            <!-- Contact Picker (hidden by default) -->
            <div id="risk-contact-picker" class="contact-picker-sota" style="display: none;">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="risk-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="risk-contact-list" class="contact-list-grid">Loading...</div>
            </div>

            <!-- AI Suggestions Panel -->
            <div id="risk-suggestions-panel" class="suggestions-panel-sota risk-suggestions-panel" style="display: none;"></div>

            <!-- Mitigation (below assignment) -->
            <div class="risk-mitigation-block">
              <strong>Mitigation</strong>
              <p id="risk-detail-mitigation" class="risk-mitigation">${t.mitigation?ce(t.mitigation):'<span class="text-muted">No mitigation recorded</span>'}</p>
            </div>
          </section>

          <section class="detail-section">
            <div class="section-header">
              <h3>Source</h3>
            </div>
            ${t.source_file?`<p class="source-file">${ce(t.source_file)}</p>`:""}
            ${t.source_document_id?`
              <p class="source-doc">
                <a href="#" class="doc-link" data-document-id="${ce(String(t.source_document_id))}">View source document</a>
              </p>
            `:""}
            ${!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
          </section>
        </div>

        <div class="detail-column-right">
          <section class="detail-section metadata-section">
            <h3>Metadata</h3>
            <dl class="metadata-list">
              <dt>Created</dt>
              <dd>${Gr(t.created_at)}</dd>
              ${t.updated_at?`<dt>Updated</dt><dd>${Gr(t.updated_at)}</dd>`:""}
            </dl>
          </section>

          <section class="detail-section" id="risk-timeline-section">
            <h3>Timeline</h3>
            <div id="timeline-content" class="timeline-content">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>
        </div>
      </div>

      <div class="detail-actions">
        <button type="button" class="btn btn-secondary" id="edit-risk-btn">Edit</button>
        <button type="button" class="btn btn-danger" id="delete-risk-btn">Delete</button>
      </div>
      </div>

      <div id="risk-edit-form" class="risk-detail-edit-form" style="display: none;">
        <form id="risk-inline-form" class="risk-form">
          <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 6px;">
              <label for="risk-edit-content" style="margin-bottom: 0;">Risk description *</label>
              <button type="button" class="btn-ai-suggest btn-sm" id="risk-edit-ai-suggest-btn" title="Suggest owner and mitigation from description">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI suggest
              </button>
            </div>
            <textarea id="risk-edit-content" rows="3" required placeholder="Describe the risk...">${ce(t.content||"")}</textarea>
          </div>
          <div id="risk-edit-suggestions-panel" class="suggestions-panel-sota risk-suggestions-panel" style="display: none; margin-bottom: 16px;"></div>
          <div class="form-row">
            <div class="form-group">
              <label for="risk-edit-impact">Impact</label>
              <select id="risk-edit-impact">
                <option value="low" ${t.impact==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.impact==="medium"||!t.impact?"selected":""}>Medium</option>
                <option value="high" ${t.impact==="high"?"selected":""}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="risk-edit-likelihood">Likelihood</label>
              <select id="risk-edit-likelihood">
                <option value="low" ${t.likelihood==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.likelihood==="medium"||!t.likelihood?"selected":""}>Medium</option>
                <option value="high" ${t.likelihood==="high"?"selected":""}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="risk-edit-status">Status</label>
              <select id="risk-edit-status">
                <option value="open" ${t.status==="open"||!t.status?"selected":""}>Open</option>
                <option value="mitigating" ${t.status==="mitigating"?"selected":""}>Mitigating</option>
                <option value="mitigated" ${t.status==="mitigated"?"selected":""}>Mitigated</option>
                <option value="accepted" ${t.status==="accepted"?"selected":""}>Accepted</option>
                <option value="closed" ${t.status==="closed"?"selected":""}>Closed</option>
              </select>
            </div>
          </div>
          <div class="form-group risk-owner-picker-wrap">
            <label>Owner</label>
            <input type="hidden" id="risk-edit-owner" value="${ce(t.owner||"")}">
            <div class="risk-owner-picker-trigger" id="risk-owner-picker-trigger" title="Click to select from project contacts">
              <span class="risk-owner-picker-value" id="risk-owner-picker-value">${t.owner?ce(t.owner):'<span class="text-muted">Select owner...</span>'}</span>
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </div>
            <div id="risk-owner-picker-dropdown" class="risk-owner-picker-dropdown" style="display: none;">
              <div class="risk-owner-picker-search">
                <input type="text" id="risk-owner-picker-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="risk-owner-picker-list" class="risk-owner-picker-list">Loading...</div>
            </div>
          </div>
          <div class="form-group">
            <label for="risk-edit-mitigation">Mitigation strategy</label>
            <textarea id="risk-edit-mitigation" rows="3" placeholder="How will this risk be mitigated?">${ce(t.mitigation||"")}</textarea>
          </div>
        </form>
        <div class="detail-actions">
          <button type="button" class="btn btn-primary" id="risk-save-btn">Save</button>
          <button type="button" class="btn btn-secondary" id="risk-cancel-edit-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="risk-delete-in-edit-btn">Delete</button>
        </div>
      </div>
    </div>
  `;const o=s.querySelector("#back-to-list");o&&d(o,"click",I=>{I.preventDefault(),n()});const i=s.querySelector("#close-detail");i&&d(i,"click",n);const r=s.querySelector("#risk-view-content"),c=s.querySelector("#risk-edit-form"),l=s.querySelector("#edit-risk-btn");l&&r&&c&&d(l,"click",()=>{r.style.display="none",c.style.display="block"});const m=s.querySelector("#risk-cancel-edit-btn");m&&r&&c&&d(m,"click",()=>{c.style.display="none",r.style.display=""});const v=s.querySelector("#risk-save-btn");v&&c&&a&&d(v,"click",async()=>{const I=s.querySelector("#risk-inline-form");if(!I?.checkValidity()){I.reportValidity();return}const O=s.querySelector("#risk-edit-content"),F=s.querySelector("#risk-edit-impact"),W=s.querySelector("#risk-edit-likelihood"),z=s.querySelector("#risk-edit-status"),E=s.querySelector("#risk-edit-owner"),_=s.querySelector("#risk-edit-mitigation"),A=O?.value?.trim()||"";if(!A){u.error("Risk description is required");return}v.disabled=!0,v.textContent="Saving...";try{const h=await Ke.update(t.id,{content:A,impact:F?.value||"medium",likelihood:W?.value||"medium",status:z?.value||"open",owner:E?.value?.trim()||void 0,mitigation:_?.value?.trim()||void 0});u.success("Risk updated"),a(h)}catch{u.error("Failed to save")}finally{v.disabled=!1,v.textContent="Save"}});const g=s.querySelector("#risk-delete-in-edit-btn");g&&d(g,"click",async()=>{if(confirm("Are you sure you want to delete this risk?"))try{await Ke.delete(t.id),u.success("Risk deleted"),n()}catch{u.error("Failed to delete")}});const f=s.querySelector("#risk-owner-picker-trigger"),b=s.querySelector("#risk-owner-picker-dropdown"),w=s.querySelector("#risk-owner-picker-value"),$=s.querySelector("#risk-edit-owner"),M=s.querySelector("#risk-owner-picker-list"),q=s.querySelector("#risk-owner-picker-search");if(f&&b&&M&&$){let I=[];const O=(F="")=>{const W=F?I.filter(z=>(z.name||"").toLowerCase().includes(F.toLowerCase())||(z.role||"").toLowerCase().includes(F.toLowerCase())):I;if(I.length===0){M.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(W.length===0){M.innerHTML='<div class="empty-state">No contacts match</div>';return}M.innerHTML=W.map(z=>{const E=z.photoUrl||z.avatarUrl;return`
            <div class="risk-owner-card-picker ${($?.value||"").trim()===(z.name||"").trim()?"selected":""}" data-contact-name="${ce(z.name||"")}">
              <div class="risk-owner-card-avatar">${E?`<img src="${ce(E)}" alt="" onerror="this.parentElement.innerHTML='${jt(z.name||"")}'">`:jt(z.name||"")}</div>
              <div class="risk-owner-card-info">
                <div class="risk-owner-card-name">${ce(z.name||"")}</div>
                ${z.role?`<div class="risk-owner-card-role">${ce(z.role)}</div>`:""}
              </div>
            </div>
          `}).join(""),M.querySelectorAll(".risk-owner-card-picker").forEach(z=>{d(z,"click",()=>{const E=z.getAttribute("data-contact-name")||"";$.value=E,w&&(w.innerHTML=E?ce(E):'<span class="text-muted">Select owner...</span>'),b.style.display="none"})})};d(f,"click",async F=>{F.stopPropagation();const W=b.style.display==="block";if(b.style.display=W?"none":"block",!W&&I.length===0){M.innerHTML='<div class="empty-state">Loading...</div>';try{I=(await ke.getAll())?.contacts||[],O(q?.value||"")}catch{M.innerHTML='<div class="empty-state">Failed to load contacts</div>'}}else W||O(q?.value||"")}),q&&q.addEventListener("input",()=>O(q.value)),document.addEventListener("click",F=>{!F.target.closest(".risk-owner-picker-wrap")&&b?.style.display==="block"&&(b.style.display="none")})}const C=s.querySelector("#risk-edit-ai-suggest-btn"),S=s.querySelector("#risk-edit-suggestions-panel");C&&S&&d(C,"click",async()=>{const O=s.querySelector("#risk-edit-content")?.value?.trim()||"";if(!O){u.error("Enter a risk description first");return}const F=C;F.disabled=!0,F.innerHTML='<span class="spin">‚ãØ</span> Analyzing...',S.style.display="block",S.innerHTML='<div class="suggestions-loading"><div class="loading-text">AI is suggesting owners and mitigation...</div></div>';try{const[W,z]=await Promise.all([Ke.suggest({content:O,impact:s.querySelector("#risk-edit-impact")?.value||"medium",likelihood:s.querySelector("#risk-edit-likelihood")?.value||"medium"}),ke.getAll()]),E=z?.contacts||[],_=W.suggested_owners?.length?W.suggested_owners:W.suggested_owner?[{name:W.suggested_owner,reason:"",score:0}]:[],A=W.suggested_mitigation||"";if(_.length===0&&!A)S.innerHTML='<div class="no-suggestions"><div class="no-suggestions-text">No suggestions</div><button type="button" class="btn-link" id="risk-edit-hide-suggest-btn">Close</button></div>';else{S.innerHTML=`
            <div class="suggestions-header-sota"><div class="ai-badge">‚ú® AI Recommended</div></div>
            ${_.length>0?`<div class="suggestions-list-sota">${_.map((k,T)=>{const j=E.find($e=>($e.name||"").trim().toLowerCase()===(k.name||"").trim().toLowerCase()),D=j?.photoUrl||j?.avatarUrl||j?.photo_url||j?.avatar_url,G=j?.role??k.reason??"",V=k.score??0,re=Qr(V);return`<div class="suggestion-card-sota risk-owner-card" data-owner-name="${ce(k.name||"")}">
                <div class="suggestion-rank">#${T+1}</div>
                <div class="suggestion-avatar-sota">${D?`<img src="${ce(D)}" alt="" onerror="this.parentElement.innerHTML='${jt(k.name)}'">`:jt(k.name)}</div>
                <div class="suggestion-info-sota"><div class="suggestion-name-sota">${ce(k.name||"")}</div>${G?`<div class="suggestion-reason-sota">${ce(G)}</div>`:""}</div>
                ${V>0?`<div class="suggestion-score-sota" style="--score-color: ${re}"><div class="score-value">${V}%</div></div>`:""}
                <button type="button" class="btn-select-suggestion">Assign</button>
              </div>`}).join("")}</div>`:""}
            ${A?`<div class="risk-suggestion-card risk-mitigation-suggestion"><strong>Suggested mitigation</strong><p class="risk-suggestion-mitigation">${ce(A)}</p><button type="button" class="btn btn-secondary btn-sm" id="risk-edit-apply-mitigation-btn">Apply mitigation</button></div>`:""}
            <div class="suggestions-footer"><button type="button" class="btn-link" id="risk-edit-hide-suggest-btn">Close suggestions</button></div>
          `,S.querySelectorAll(".risk-owner-card .btn-select-suggestion").forEach(k=>{const j=k.closest(".risk-owner-card")?.getAttribute("data-owner-name")||"";j&&d(k,"click",()=>{$&&($.value=j),w&&(w.innerHTML=ce(j)),S.style.display="none",u.success(`Owner set to ${j}`)})});const y=S.querySelector("#risk-edit-apply-mitigation-btn");y&&A&&d(y,"click",()=>{const k=s.querySelector("#risk-edit-mitigation");k&&(k.value=A),u.success("Mitigation applied")})}const h=S.querySelector("#risk-edit-hide-suggest-btn");h&&d(h,"click",()=>{S.style.display="none"})}catch{S.innerHTML='<div class="suggestions-error">Failed to get suggestions. <button type="button" class="btn-link" id="risk-edit-hide-suggest-btn">Close</button></div>';const W=S.querySelector("#risk-edit-hide-suggest-btn");W&&d(W,"click",()=>{S.style.display="none"})}finally{F.disabled=!1,F.innerHTML='<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> AI suggest'}});const L=s.querySelector("#delete-risk-btn");L&&d(L,"click",async()=>{if(confirm("Are you sure you want to delete this risk?"))try{await Ke.delete(t.id),u.success("Risk deleted"),n()}catch{u.error("Failed to delete risk")}});let R="";const Z=s.querySelector("#risk-ai-suggest-btn"),ee=s.querySelector("#risk-suggestions-panel");Z&&ee&&d(Z,"click",async()=>{const I=Z;I.disabled=!0,I.innerHTML=`
        <svg class="spin" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Analyzing...
      `,ee.style.display="block",ee.innerHTML=`
        <div class="suggestions-loading">
          <div class="ai-thinking-animation"><span></span><span></span><span></span></div>
          <div class="loading-text">AI is suggesting owners and mitigation...</div>
        </div>
      `;try{const[O,F]=await Promise.all([Ke.suggest({content:t.content||"",impact:t.impact||"medium",likelihood:t.likelihood||"medium"}),ke.getAll()]),W=F?.contacts||[];R=O.suggested_mitigation||"";const z=O.suggested_owners?.length?O.suggested_owners:O.suggested_owner?[{name:O.suggested_owner,reason:"",score:0}]:[];if(z.length===0&&!R)ee.innerHTML=`
            <div class="no-suggestions">
              <div class="no-suggestions-text">No owner or mitigation suggestions</div>
              <button type="button" class="btn-link" id="risk-hide-suggestions-btn">Close</button>
            </div>
          `;else{ee.innerHTML=`
            <div class="suggestions-header-sota">
              <div class="ai-badge">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                AI Recommended
              </div>
            </div>
            ${z.length>0?`
            <div class="suggestions-list-sota">
              ${z.map((A,h)=>{const y=A.score??0,k=Qr(y),T=W.find(G=>(G.name||"").trim().toLowerCase()===(A.name||"").trim().toLowerCase()),j=T?.photoUrl||T?.avatarUrl||T?.photo_url||T?.avatar_url,D=T?.role??A.reason??"";return`
                  <div class="suggestion-card-sota risk-owner-card" data-index="${h}">
                    <div class="suggestion-rank">#${h+1}</div>
                    <div class="suggestion-avatar-sota">${j?`<img src="${ce(j)}" alt="${ce(A.name)}" onerror="this.parentElement.innerHTML='${jt(A.name)}'">`:jt(A.name)}</div>
                    <div class="suggestion-info-sota">
                      <div class="suggestion-name-sota">${ce(A.name)}</div>
                      ${D?`<div class="suggestion-reason-sota">${ce(D)}</div>`:""}
                    </div>
                    ${y>0?`
                    <div class="suggestion-score-sota" style="--score-color: ${k}">
                      <div class="score-ring">
                        <svg viewBox="0 0 36 36">
                          <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                          <path class="score-fill" stroke-dasharray="${y}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <div class="score-value">${y}%</div>
                      </div>
                      <div class="score-label">Match</div>
                    </div>
                    `:""}
                    <button type="button" class="btn-select-suggestion">
                      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      Assign
                    </button>
                  </div>
                `}).join("")}
            </div>
            `:""}
            ${R?`
            <div class="risk-suggestion-card risk-mitigation-suggestion">
              <strong>Suggested mitigation</strong>
              <p class="risk-suggestion-mitigation">${ce(R)}</p>
              <button type="button" class="btn btn-secondary btn-sm" id="risk-apply-mitigation-btn">Apply mitigation</button>
            </div>
            `:""}
            <div class="suggestions-footer">
              <button type="button" class="btn-link" id="risk-hide-suggestions-btn">Close suggestions</button>
            </div>
          `,ee.querySelectorAll(".risk-owner-card").forEach(A=>{const h=A.querySelector(".btn-select-suggestion");if(!h)return;const y=parseInt(A.getAttribute("data-index")||"0"),k=z[y];!k||!a||d(h,"click",async T=>{T.stopPropagation();try{const j=await Ke.update(t.id,{owner:k.name});ee.style.display="none",a(j),u.success(`Assigned to ${k.name}`)}catch{u.error("Failed to save")}})});const _=ee.querySelector("#risk-apply-mitigation-btn");_&&R&&a&&d(_,"click",async()=>{try{const A=await Ke.update(t.id,{mitigation:R}),h=s.querySelector("#risk-detail-mitigation");h&&(h.innerHTML=ce(R)),a(A),u.success("Mitigation updated")}catch{u.error("Failed to save")}})}const E=ee.querySelector("#risk-hide-suggestions-btn");E&&d(E,"click",()=>{ee.style.display="none"})}catch{ee.innerHTML=`
          <div class="suggestions-error">
            <div>Failed to get AI suggestions</div>
            <button type="button" class="btn-retry" id="risk-retry-suggest-btn">Try again</button>
          </div>
        `;const O=ee.querySelector("#risk-retry-suggest-btn");O&&d(O,"click",()=>Z.click())}finally{I.disabled=!1,I.innerHTML=`
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          AI suggest
        `}});const le=s.querySelector(".doc-link");le&&t.source_document_id&&d(le,"click",I=>{I.preventDefault(),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:t.source_document_id}}))});const ae=s.querySelector("#timeline-content");ae&&Ke.getEvents(t.id).then(I=>{if(I.length===0){ae.innerHTML='<p class="empty-state">No events recorded</p>';return}const O=I.map(F=>{const W=wy(F.event_type),z=ky(F);return`
          <div class="timeline-item risk-event-${ce(F.event_type)}">
            <div class="timeline-icon">${W}</div>
            <div class="timeline-content">
              <div class="timeline-title">${ce(z)}</div>
              <div class="timeline-date">${Tn(F.created_at)}</div>
            </div>
          </div>`}).join("");ae.innerHTML=`<div class="timeline-list">${O}</div>`}).catch(()=>{ae.innerHTML='<p class="error">Failed to load timeline</p>'});let X=[];const ie=t.owner||"",U=s.querySelector("#risk-contact-picker"),Q=s.querySelector("#risk-contact-list"),te=s.querySelector("#risk-contact-search"),de=(I="")=>{if(!Q)return;const O=I?X.filter(F=>(F.name||"").toLowerCase().includes(I.toLowerCase())||(F.role||"").toLowerCase().includes(I.toLowerCase())||(F.organization||"").toLowerCase().includes(I.toLowerCase())):X;if(X.length===0){Q.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(O.length===0){Q.innerHTML='<div class="empty-state">No contacts match</div>';return}Q.innerHTML=O.map(F=>{const W=se(F);return`
          <div class="contact-card-picker ${(ie||"").trim()===(F.name||"").trim()?"selected":""}" data-contact-name="${ce(F.name||"")}">
            <div class="contact-avatar-picker">${W?`<img src="${ce(W)}" alt="" onerror="this.parentElement.innerHTML='${jt(F.name||"")}'">`:jt(F.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${ce(F.name||"")}</div>
              ${F.role?`<div class="contact-role-picker">${ce(F.role)}</div>`:""}
            </div>
          </div>`}).join(""),Q.querySelectorAll(".contact-card-picker").forEach(F=>{d(F,"click",async()=>{const W=F.getAttribute("data-contact-name")||"";if(W)try{const z=await Ke.update(t.id,{owner:W});u.success(`Owner set to ${W}`),U&&(U.style.display="none"),a?.(z)}catch{u.error("Failed to save")}})})},qe=()=>{U&&(U.style.display=U.style.display==="none"?"block":"none",U.style.display==="block"&&X.length===0?ke.getAll().then(I=>{X=I?.contacts||[],de(te?.value||"")}).catch(()=>{Q&&(Q.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):U.style.display==="block"&&de(te?.value||""),te&&te.focus())},Be=s.querySelector("#risk-change-owner-btn"),N=s.querySelector("#risk-show-picker-btn");Be&&U&&d(Be,"click",qe),N&&U&&d(N,"click",qe),te&&te.addEventListener("input",()=>de(te.value));function ne(I){if(!I||!X.length)return;const O=I.trim().toLowerCase();if(!O)return;const F=X.find(E=>(E.name||"").trim().toLowerCase()===O);if(F)return F;const W=X.find(E=>(E.name||"").trim().toLowerCase().includes(O)||O.includes((E.name||"").trim().toLowerCase()));if(W)return W;const z=X.find(E=>(E.aliases||[]).some(_=>String(_).trim().toLowerCase()===O));return z||X.find(E=>(E.aliases||[]).some(_=>{const A=String(_).trim().toLowerCase();return A.includes(O)||O.includes(A)}))}function se(I){if(!I)return null;const O=I;return O.photoUrl||O.avatarUrl||O.photo_url||O.avatar_url||null}return ke.getAll().then(I=>{X=I?.contacts||[];const O=ne(ie),F=s.querySelector("#risk-assigned-role");F&&(F.textContent=O?.role??"‚Äî");const W=s.querySelector("#risk-assigned-avatar");if(W&&ie){const z=se(O);if(z){W.innerHTML="";const E=document.createElement("img");E.src=z,E.alt="",E.onerror=()=>{W.textContent=jt(ie)},W.appendChild(E)}}}).catch(()=>{}),s}const $y=Object.freeze(Object.defineProperty({__proto__:null,createRiskDetailView:Xi},Symbol.toStringTag,{value:"Module"}));function Ql(e,t,n){return{risk:n,onClose:()=>{e.innerHTML="",e.appendChild(Os(t))},onUpdate:a=>{e.innerHTML="",a?e.appendChild(Xi(Ql(e,t,a))):e.appendChild(Os(t))}}}let Na="all",ho="",Kl="status",Yn=!1,ii=[];function Os(e={}){const t=x("div",{className:"sot-panel risks-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Risks</h2>
        <span class="panel-count" id="risks-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="risks-filter" class="filter-select">
          <option value="all">All</option>
          <option value="open">Open</option>
          <option value="mitigating">Mitigating</option>
          <option value="mitigated">Mitigated</option>
          <option value="high">High Impact</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="status">By Status</button>
          <button class="view-tab" data-view="source">By Source</button>
        </div>
        <input type="search" id="risks-search" class="search-input" placeholder="Search risks..." title="Search">
        <button class="btn btn-secondary btn-sm" id="toggle-matrix-btn">Show Matrix</button>
        <button class="btn btn-primary btn-sm" id="add-risk-btn">+ Add</button>
      </div>
    </div>
    <div id="risk-matrix-container" class="risk-matrix-container" style="display: none;"></div>
    <div class="panel-content" id="risks-content">
      <div class="loading">Loading risks...</div>
    </div>
    <div id="removed-risks-container" class="removed-risks-container" style="display: none;"></div>
  `;const n=t.querySelector("#risks-filter");d(n,"change",()=>{Na=n.value,tn(t,e)});const a=t.querySelectorAll(".view-tab");a.forEach(c=>{d(c,"click",()=>{a.forEach(l=>l.classList.remove("active")),c.classList.add("active"),Kl=c.getAttribute("data-view"),tn(t,e)})});const s=t.querySelector("#risks-search");let o;d(s,"input",()=>{clearTimeout(o),o=window.setTimeout(()=>{ho=s.value.trim(),tn(t,e)},300)});const i=t.querySelector("#toggle-matrix-btn");d(i,"click",()=>{Yn=!Yn,i.textContent=Yn?"Hide Matrix":"Show Matrix";const c=t.querySelector("#risk-matrix-container");if(c.style.display=Yn?"block":"none",Yn){const l=ii.length>0?ii:B.getState().risks||[];Yl(c,Array.isArray(l)?l:[])}});const r=t.querySelector("#add-risk-btn");return r&&d(r,"click",()=>{Sa({mode:"create",onSave:()=>{tn(t,e),ri(t,e)}})}),tn(t,e),ri(t,e),t}async function ri(e,t){const n=e.querySelector("#removed-risks-container");if(n)try{const a=await Ke.getDeleted();if(a.length===0){n.style.display="none",n.innerHTML="";return}n.style.display="block",n.innerHTML=`
      <div class="removed-risks-section">
        <div class="removed-risks-header section-header-sota">
          <h3>Removed risks</h3>
          <span class="panel-count removed-count">${a.length}</span>
        </div>
        <p class="removed-risks-hint">Restore to bring the risk back; it will be synced to the graph.</p>
        <div class="removed-risks-list">
          ${a.map(s=>`
            <div class="removed-risk-item" data-risk-id="${s.id}">
              <div class="removed-risk-content">${ot(ci(s.content??"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(s=>{d(s,"click",async()=>{const o=s.closest(".removed-risk-item")?.getAttribute("data-risk-id");if(o)try{await Ke.restore(o),u.success("Risk restored"),tn(e,t),ri(e,t)}catch{u.error("Failed to restore risk")}})})}catch{n.style.display="none",n.innerHTML=""}}function ci(e,t){return e.length<=t?e:e.substring(0,t)+"‚Ä¶"}function Sy(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(a=>(a.content||"").toLowerCase().includes(n)||(a.mitigation||"").toLowerCase().includes(n)||(a.owner||"").toLowerCase().includes(n)||(a.source_file||"").toLowerCase().includes(n))}async function tn(e,t){const n=e.querySelector("#risks-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=Na==="all"||Na==="high"?void 0:Na;let s=await Ke.getAll(a);if(Na==="high"&&(s=s.filter(o=>o.impact==="high"||o.impact==="critical")),s=Sy(s,ho),Kl==="source"?Ly(n,s,t):Cy(n,s,t),ii=s,B.setRisks(s),Ty(e,s.length),Yn){const o=e.querySelector("#risk-matrix-container");Yl(o,s)}}catch{n.innerHTML='<div class="error">Failed to load risks</div>'}}function Cy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${ho?"No risks match your search":"No risks found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Risk</button>
      </div>
    `;const i=e.querySelector("#empty-add-btn");i&&d(i,"click",()=>{Sa({mode:"create",onSave:()=>tn(e.closest(".risks-panel"),n)})});return}const a=B.getState().contacts||[],s={};t.forEach(i=>{const r=(i.status||"open").toLowerCase();s[r]||(s[r]=[]),s[r].push(i)});const o=Object.keys(s);o.length>1?e.innerHTML=o.map(i=>`
      <div class="question-group">
        <div class="group-header">
          <h3>${ot(i)}</h3>
          <span class="group-count">${s[i].length}</span>
        </div>
        <div class="group-items">
          ${s[i].map(r=>li(r,a)).join("")}
        </div>
      </div>
    `).join(""):e.innerHTML=t.map(i=>li(i,a)).join(""),Wl(e,t,n)}function Ly(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${ho?"No risks match your search":"No risks found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Risk</button>
      </div>
    `;const o=e.querySelector("#empty-add-btn");o&&d(o,"click",()=>{Sa({mode:"create",onSave:()=>tn(e.closest(".risks-panel"),n)})});return}const a=B.getState().contacts||[],s={};t.forEach(o=>{const i=o.source_file||"Unknown source";s[i]||(s[i]=[]),s[i].push(o)}),e.innerHTML=Object.entries(s).map(([o,i])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${ot(o)}</h3>
        <span class="group-count">${i.length}</span>
      </div>
      <div class="group-items">
        ${i.map(r=>li(r,a)).join("")}
      </div>
    </div>
  `).join(""),Wl(e,t,n)}const Kr={critical:"#dc2626",high:"#ea580c",medium:"#ca8a04",low:"#16a34a"};function My(e,t){if(!t||!e.length)return;const n=t.trim().toLowerCase();if(!n)return;const a=e.find(i=>(i.name||"").trim().toLowerCase()===n);if(a)return a;const s=e.find(i=>(i.name||"").trim().toLowerCase().includes(n)||n.includes((i.name||"").trim().toLowerCase()));return s||e.find(i=>(i.aliases||[]).some(r=>String(r).trim().toLowerCase()===n))||e.find(i=>(i.aliases||[]).some(r=>{const c=String(r).trim().toLowerCase();return c.includes(n)||n.includes(c)}))}function qy(e){return e&&(e.photoUrl||e.avatarUrl||e.photo_url||e.avatar_url)||null}function Wr(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function li(e,t){const n=(e.impact||"medium").toLowerCase(),a=Kr[n]??Kr.medium,s=e.content||"",o=e.source_file||"",i=e.owner||"",r=i?My(t,i):void 0,c=qy(r),l=i?`
        <div class="assignee-chip">
          <div class="assignee-avatar">${c?`<img src="${ot(c)}" alt="${ot(i)}" onerror="this.parentElement.innerHTML='${Wr(i)}'">`:Wr(i)}</div>
          <div class="assignee-info">
            <span class="assignee-name">${ot(i)}</span>
            ${r?.role?`<span class="assignee-role">${ot(r.role)}</span>`:""}
          </div>
        </div>
      `:'<span class="card-owner-placeholder text-muted">No owner</span>',m=o?`<span class="card-source-chip">${ot(ci(o,40))}</span>`:'<span class="card-source-chip text-muted">No source</span>';return`
    <div class="risk-card-sota question-card-sota" data-id="${e.id}" style="--risk-impact-bar: ${a}">
      <div class="card-priority-bar risk-impact-bar" style="background: ${a}"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="priority-pill impact-${n}">${ot(e.impact||"medium")}</span>
            <span class="status-pill">L: ${ot(e.likelihood||"medium")}</span>
            <span class="status-pill status-${(e.status||"open").toLowerCase()}">${ot(e.status||"open")}</span>
          </div>
          <span class="card-timestamp">${J(e.created_at)}</span>
        </div>
        <div class="card-question-text">${ot(s)}</div>
        ${e.mitigation?`<div class="card-mitigation text-muted">${ot(ci(e.mitigation,120))}</div>`:""}
        <div class="card-bottom-row">
          <div class="card-requester">
            ${m}
            ${l}
          </div>
          <div class="card-assignment">
            <button type="button" class="btn-link risk-view-link">View</button>
          </div>
        </div>
      </div>
    </div>
  `}function Wl(e,t,n){e.querySelectorAll(".risk-card-sota").forEach(a=>{d(a,"click",s=>{if(s.target.closest(".card-actions"))return;const o=a.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);if(i)if(n.useDetailView&&n.containerElement){const r=n.containerElement;r.innerHTML="",r.appendChild(Xi(Ql(r,n,i)))}else n.onRiskClick?n.onRiskClick(i):Sa({mode:"edit",risk:{...i},onSave:()=>tn(e.closest(".risks-panel"),n)})})})}function Yl(e,t){const n=t.filter(v=>v.status!=="mitigated"&&v.status!=="closed"),a=(v,g)=>{const f=["low","medium","high","critical"].indexOf((v||"").toString().toLowerCase()||"low"),b=["low","medium","high"].indexOf((g||"").toString().toLowerCase()||"low"),w=f+b;return w>=4?"critical":w>=3?"high":w>=2?"medium":"low"},s={critical:0,high:0,medium:0,low:0};n.forEach(v=>{const g=a(v.impact,v.likelihood);s[g]++});const o=n.length,i=t.length-n.length,r=v=>o>0?Math.round(v/o*100):0;let c="",l=0;const m={critical:"#ef4444",high:"#f97316",medium:"#eab308",low:"#22c55e"};["critical","high","medium","low"].forEach(v=>{const f=r(s[v])/100*360;f>0&&(c+=`${m[v]} ${l}deg ${l+f}deg, `,l+=f)}),c?c=c.slice(0,-2):c="var(--color-border) 0deg 360deg",e.innerHTML=`
    <div class="risk-summary">
      <div class="risk-summary-header">
        <h4>Risk Overview</h4>
        <span class="risk-total">${o} active</span>
      </div>
      <div class="risk-summary-content">
        <div class="risk-donut-container">
          <div class="risk-donut" style="background: conic-gradient(${c})">
            <div class="risk-donut-center">
              <span class="donut-value">${o}</span>
              <span class="donut-label">Risks</span>
            </div>
          </div>
        </div>
        <div class="risk-bars">
          <div class="risk-bar-item critical">
            <span class="bar-icon">üî¥</span>
            <span class="bar-label">Critical</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.critical)}%"></div></div>
            <span class="bar-count">${s.critical}</span>
          </div>
          <div class="risk-bar-item high">
            <span class="bar-icon">üü†</span>
            <span class="bar-label">High</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.high)}%"></div></div>
            <span class="bar-count">${s.high}</span>
          </div>
          <div class="risk-bar-item medium">
            <span class="bar-icon">üü°</span>
            <span class="bar-label">Medium</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.medium)}%"></div></div>
            <span class="bar-count">${s.medium}</span>
          </div>
          <div class="risk-bar-item low">
            <span class="bar-icon">üü¢</span>
            <span class="bar-label">Low</span>
            <div class="bar-track"><div class="bar-fill" style="width: ${r(s.low)}%"></div></div>
            <span class="bar-count">${s.low}</span>
          </div>
        </div>
      </div>
      ${i>0?`<div class="risk-mitigated"><span class="mitigated-icon">‚úì</span><span>${i} risk${i>1?"s":""} mitigated</span></div>`:""}
    </div>
  `}function Ty(e,t){const n=e.querySelector("#risks-count");n&&(n.textContent=String(t))}function ot(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Kt="action-modal";function Yr(e){return e?.content??e?.task??""}function Jr(e){return e?.due_date??e?.dueDate??""}function Ay(e){return e?.created_at??e?.createdAt??""}function oa(e){const{mode:t,action:n,onSave:a,onDelete:s}=e,o=t==="edit"&&n?.id,i=t==="view",r=document.querySelector(`[data-modal-id="${Kt}"]`);r&&r.remove();const c=x("div",{className:"action-modal-content"});if(i&&n){const v=Jr(n),g=v&&new Date(v)<new Date&&n.status!=="completed";c.innerHTML=`
      <div class="action-view">
        <div class="action-meta">
          <span class="priority-badge priority-${n.priority||"medium"}">${n.priority||"medium"}</span>
          <span class="status-badge ${n.status}">${n.status.replace("_"," ")}</span>
          ${g?'<span class="status-badge overdue">Overdue</span>':""}
        </div>
        
        <div class="action-task-large ${n.status==="completed"?"completed":""}">
          ${Ss(Yr(n))}
        </div>
        
        <div class="action-details">
          ${n.assignee?`<div class="detail-item"><strong>Assignee:</strong> ${Ss(n.assignee)}</div>`:""}
          ${v?`<div class="detail-item"><strong>Due Date:</strong> ${v}</div>`:""}
          <div class="detail-item"><strong>Created:</strong> ${J(Ay(n))}</div>
        </div>
      </div>
    `}else c.innerHTML=`
      <form id="action-form" class="action-form">
        <div class="form-group">
          <label for="action-task">Task *</label>
          <textarea id="action-task" rows="2" required 
                    placeholder="What needs to be done?">${Ss(Yr(n))}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="action-priority">Priority</label>
            <select id="action-priority">
              <option value="low" ${n?.priority==="low"?"selected":""}>Low</option>
              <option value="medium" ${n?.priority==="medium"||!n?"selected":""}>Medium</option>
              <option value="high" ${n?.priority==="high"?"selected":""}>High</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="action-status">Status</label>
            <select id="action-status">
              <option value="pending" ${n?.status==="pending"||!n?"selected":""}>Pending</option>
              <option value="in_progress" ${n?.status==="in_progress"?"selected":""}>In Progress</option>
              <option value="completed" ${n?.status==="completed"?"selected":""}>Completed</option>
              <option value="cancelled" ${n?.status==="cancelled"?"selected":""}>Cancelled</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="action-assignee">Assignee</label>
            <input type="text" id="action-assignee" 
                   value="${Ss(n?.assignee??n?.owner??"")}" 
                   placeholder="Who is responsible?">
          </div>
          
          <div class="form-group">
            <label for="action-due">Due Date</label>
            <input type="date" id="action-due" 
                   value="${Jr(n)}">
          </div>
        </div>
      </form>
    `;const l=x("div",{className:"modal-footer"});if(i&&n){const v=x("button",{className:"btn btn-primary",textContent:"Edit"}),g=x("button",{className:"btn btn-secondary",textContent:"Close"});if(n.status!=="completed"){const f=x("button",{className:"btn btn-success",textContent:"Mark Complete"});d(f,"click",async()=>{try{const b=await We.update(n.id,{status:"completed"});u.success("Action completed"),a?.(b),H(Kt)}catch{}}),l.appendChild(f)}d(g,"click",()=>H(Kt)),d(v,"click",()=>{H(Kt),oa({...e,mode:"edit"})}),l.appendChild(g),l.appendChild(v)}else{const v=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),g=x("button",{className:"btn btn-primary",textContent:o?"Save Changes":"Create Action"});if(d(v,"click",()=>H(Kt)),d(g,"click",async()=>{const f=c.querySelector("#action-form");if(!f.checkValidity()){f.reportValidity();return}const b=M=>c.querySelector(`#${M}`)?.value.trim()||"",$={content:b("action-task"),status:b("action-status"),priority:b("action-priority"),assignee:b("action-assignee")||void 0,due_date:b("action-due")||void 0};g.disabled=!0,g.textContent="Saving...";try{if(o){const M=await We.update(n.id,$);u.success("Action updated"),a?.(M)}else{const M=await We.create($);u.success("Action created"),a?.(M)}H(Kt)}catch{}finally{g.disabled=!1,g.textContent=o?"Save Changes":"Create Action"}}),o){const f=x("button",{className:"btn btn-danger",textContent:"Delete"});d(f,"click",async()=>{const{confirm:b}=await Y(async()=>{const{confirm:$}=await Promise.resolve().then(()=>Gt);return{confirm:$}},void 0);if(await b("Are you sure you want to delete this action?",{title:"Delete Action",confirmText:"Delete",confirmClass:"btn-danger"}))try{await We.delete(n.id),u.success("Action deleted"),s?.(String(n.id)),H(Kt)}catch{}}),l.appendChild(f)}l.appendChild(v),l.appendChild(g)}const m=fe({id:Kt,title:i?"Action Details":o?"Edit Action":"New Action",content:c,size:"md",footer:l});document.body.appendChild(m),he(Kt)}function Ss(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Dt(e){return e.trim().split(/\s+/).map(t=>t[0]).join("").toUpperCase().substring(0,2)}function me(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Eo(e){if(!e)return"‚Äî";try{return Tn(e)}catch{return e}}function Zr(e){return e.content??e.task??""}function Ey(e){return{created:"üìù",updated:"‚úèÔ∏è",deleted:"üóëÔ∏è",restored:"‚Ü©Ô∏è"}[e]||"‚Ä¢"}function _y(e){const t=e.event_data||{},n=e.actor_name?` by ${e.actor_name}`:"";switch(e.event_type){case"created":return`Created${n}`;case"updated":{const a=t.changes||[];if(a.length===0)return`Updated${n}`;if(a.length===1){const s=a[0],o=String(s.to).trim()?s.to:"‚Äî",i=String(s.from).trim()?s.from:"‚Äî";return`${s.field} changed: ${i} ‚Üí ${o}${n}`}return`${a.map(s=>`${s.field}: ${s.from||"‚Äî"} ‚Üí ${s.to||"‚Äî"}`).join("; ")}${n}`}case"deleted":return`Deleted${t.reason?` (${t.reason})`:""}${n}`;case"restored":return`Restored${n}`;default:return e.event_type}}function Us(e){const{action:t,onClose:n,onUpdate:a}=e,s=x("div",{className:"action-detail-view question-detail-view"}),o=Zr(t),i=t.due_date??t.deadline??"",r=t.assignee??t.owner??"";s.innerHTML=`
    <div class="question-detail-header action-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Actions</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Action #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        <span class="status-badge status-${(t.status||"pending").toLowerCase()}">${me(String(t.status).replace("_"," "))}</span>
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content action-detail-content">
      <div id="action-view-content">
        <section class="detail-section action-main">
          <div class="question-badges action-badges">
            ${t.priority?`<span class="priority-pill priority-${t.priority}">${me(t.priority)}</span>`:""}
            <span class="question-date action-date">Created ${J(t.created_at)}</span>
          </div>
          <h2 class="question-text action-task-text">${me(o)}</h2>
        </section>

        <div class="detail-columns">
          <div class="detail-column-left">
            <!-- Assignment Section - SOTA (aligned with Questions) -->
            <section class="detail-section" id="action-assignment-section">
              <div class="section-header-sota">
                <h3>
                  <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Assignment
                  <span class="section-subtitle">Who should do this?</span>
                </h3>
                <button type="button" class="btn-ai-suggest" id="action-ai-suggest-btn" title="Suggest assignee from task content">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                  AI Suggest
                </button>
              </div>

              <!-- Current Assignment Display -->
              <div id="action-current-assignment" class="current-assignment-card">
                ${r?`
                  <div class="assigned-contact-display">
                    <div class="contact-avatar-lg" id="action-assigned-avatar">${Dt(r)}</div>
                    <div class="contact-details">
                      <div class="contact-name-lg">${me(r)}</div>
                      <div class="contact-role-sm" id="action-assigned-role">‚Äî</div>
                    </div>
                    <button class="btn-change-assignment" id="action-change-assignee-btn" type="button">
                      <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                      Change
                    </button>
                  </div>
                `:`
                  <div class="no-assignment">
                    <div class="no-assignment-icon">
                      <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                    </div>
                    <span>No one assigned</span>
                    <p class="no-assignment-hint">Use AI Suggest or choose manually</p>
                    <button class="btn-assign-now" id="action-show-picker-btn" type="button">Choose Manually</button>
                  </div>
                `}
              </div>

              <!-- Contact Picker (hidden by default) -->
              <div id="action-contact-picker" class="contact-picker-sota" style="display: none;">
                <div class="picker-search">
                  <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                  <input type="text" id="action-contact-search" placeholder="Search contacts..." autocomplete="off">
                </div>
                <div id="action-contact-list" class="contact-list-grid">Loading...</div>
              </div>

              <!-- AI Suggestions Panel -->
              <div id="action-suggestions-panel" class="suggestions-panel-sota action-suggestions-panel" style="display: none; margin-bottom: 12px;"></div>

              <!-- Due date & Status (details) -->
              <dl class="metadata-list action-meta-inline">
                <dt>Due date</dt>
                <dd>${i?Eo(i):"‚Äî"}</dd>
                <dt>Status</dt>
                <dd>${me(String(t.status).replace("_"," "))}</dd>
              </dl>
            </section>

            <section class="detail-section">
              <div class="section-header"><h3>Source</h3></div>
              ${t.source_file?`<p class="source-file">${me(t.source_file)}</p>`:""}
              ${t.source_document_id?`
                <p class="source-doc">
                  <a href="#" class="doc-link" data-document-id="${me(String(t.source_document_id))}">View source document</a>
                </p>
              `:""}
              ${!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
            </section>
          </div>

          <div class="detail-column-right">
            <section class="detail-section metadata-section">
              <h3>Metadata</h3>
              <dl class="metadata-list">
                <dt>Created</dt>
                <dd>${Eo(t.created_at)}</dd>
                ${t.updated_at?`<dt>Updated</dt><dd>${Eo(t.updated_at)}</dd>`:""}
              </dl>
            </section>

            <section class="detail-section" id="action-timeline-section">
              <h3>Timeline</h3>
              <div id="timeline-content" class="timeline-content">
                <span class="text-muted">Loading‚Ä¶</span>
              </div>
            </section>
          </div>
        </div>

        <div class="detail-actions">
          <button type="button" class="btn btn-secondary" id="edit-action-btn">Edit</button>
          <button type="button" class="btn btn-danger" id="delete-action-btn">Delete</button>
        </div>
      </div>

      <div id="action-edit-form" class="action-detail-edit-form" style="display: none;">
        <form id="action-inline-form" class="action-form">
          <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 6px;">
              <label for="action-edit-task" style="margin-bottom: 0;">Task *</label>
              <button type="button" class="btn-ai-suggest btn-sm" id="action-edit-ai-suggest-btn" title="Suggest assignee from task content">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI suggest
              </button>
            </div>
            <textarea id="action-edit-task" rows="3" required placeholder="What needs to be done?">${me(o)}</textarea>
          </div>
          <div id="action-edit-suggestions-panel" class="suggestions-panel-sota action-suggestions-panel" style="display: none; margin-bottom: 16px;"></div>
          <div class="form-row">
            <div class="form-group">
              <label for="action-edit-status">Status</label>
              <select id="action-edit-status">
                <option value="pending" ${t.status==="pending"?"selected":""}>Pending</option>
                <option value="in_progress" ${t.status==="in_progress"?"selected":""}>In Progress</option>
                <option value="completed" ${t.status==="completed"?"selected":""}>Completed</option>
                <option value="cancelled" ${t.status==="cancelled"?"selected":""}>Cancelled</option>
              </select>
            </div>
            <div class="form-group">
              <label for="action-edit-priority">Priority</label>
              <select id="action-edit-priority">
                <option value="low" ${t.priority==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.priority==="medium"||!t.priority?"selected":""}>Medium</option>
                <option value="high" ${t.priority==="high"?"selected":""}>High</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group action-assignee-picker-wrap">
              <label>Assignee</label>
              <input type="hidden" id="action-edit-assignee" value="${me(r)}">
              <div class="action-assignee-picker-trigger" id="action-assignee-picker-trigger" title="Click to select from project contacts">
                <span class="action-assignee-picker-value" id="action-assignee-picker-value">${r?me(r):'<span class="text-muted">Select assignee...</span>'}</span>
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </div>
              <div id="action-assignee-picker-dropdown" class="action-assignee-picker-dropdown" style="display: none;">
                <div class="action-assignee-picker-search">
                  <input type="text" id="action-assignee-picker-search" placeholder="Search contacts..." autocomplete="off">
                </div>
                <div id="action-assignee-picker-list" class="action-assignee-picker-list">Loading...</div>
              </div>
            </div>
            <div class="form-group">
              <label for="action-edit-due">Due date</label>
              <input type="date" id="action-edit-due" value="${i?i.split("T")[0]:""}">
            </div>
          </div>
        </form>
        <div class="detail-actions">
          <button type="button" class="btn btn-primary" id="action-save-btn">Save</button>
          <button type="button" class="btn btn-secondary" id="action-cancel-edit-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="action-delete-in-edit-btn">Delete</button>
        </div>
      </div>
    </div>
  `;const c=s.querySelector("#back-to-list");c&&d(c,"click",z=>{z.preventDefault(),n()});const l=s.querySelector("#close-detail");l&&d(l,"click",n);const m=s.querySelector("#action-view-content"),v=s.querySelector("#action-edit-form"),g=s.querySelector("#edit-action-btn");g&&d(g,"click",()=>{m.style.display="none",v.style.display="block"});const f=s.querySelector("#action-cancel-edit-btn");f&&d(f,"click",()=>{v.style.display="none",m.style.display="block"});const b=s.querySelector("#action-assignee-picker-trigger"),w=s.querySelector("#action-assignee-picker-dropdown"),$=s.querySelector("#action-assignee-picker-value"),M=s.querySelector("#action-edit-assignee"),q=s.querySelector("#action-assignee-picker-list"),C=s.querySelector("#action-assignee-picker-search");if(b&&w&&q&&M){let z=[];const E=(_="")=>{const A=_?z.filter(h=>(h.name||"").toLowerCase().includes(_.toLowerCase())||(h.role||"").toLowerCase().includes(_.toLowerCase())):z;if(z.length===0){q.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(A.length===0){q.innerHTML='<div class="empty-state">No contacts match</div>';return}q.innerHTML=A.map(h=>{const y=h.photoUrl||h.avatarUrl;return`
            <div class="action-assignee-card-picker ${(M?.value||"").trim()===(h.name||"").trim()?"selected":""}" data-contact-name="${me(h.name||"")}">
              <div class="action-assignee-card-avatar">${y?`<img src="${me(y)}" alt="" onerror="this.parentElement.innerHTML='${Dt(h.name||"")}'">`:Dt(h.name||"")}</div>
              <div class="action-assignee-card-info">
                <div class="action-assignee-card-name">${me(h.name||"")}</div>
                ${h.role?`<div class="action-assignee-card-role">${me(h.role)}</div>`:""}
              </div>
            </div>
          `}).join(""),q.querySelectorAll(".action-assignee-card-picker").forEach(h=>{d(h,"click",()=>{const y=h.getAttribute("data-contact-name")||"";M.value=y,$&&($.innerHTML=y?me(y):'<span class="text-muted">Select assignee...</span>'),w.style.display="none"})})};d(b,"click",async _=>{_.stopPropagation();const A=w.style.display==="block";if(w.style.display=A?"none":"block",!A&&z.length===0){q.innerHTML='<div class="empty-state">Loading...</div>';try{z=(await ke.getAll())?.contacts||[],E(C?.value||"")}catch{q.innerHTML='<div class="empty-state">Failed to load contacts</div>'}}else A||E(C?.value||"")}),C&&C.addEventListener("input",()=>E(C.value)),document.addEventListener("click",_=>{!_.target.closest(".action-assignee-picker-wrap")&&w?.style.display==="block"&&(w.style.display="none")})}const S=s.querySelector("#action-edit-ai-suggest-btn"),L=s.querySelector("#action-edit-suggestions-panel"),R=s.querySelector("#action-edit-assignee"),Z=s.querySelector("#action-assignee-picker-value");S&&L&&d(S,"click",async()=>{const E=s.querySelector("#action-edit-task")?.value?.trim()||"";if(!E){u.warning("Enter task content first");return}const _=S;_.disabled=!0,_.innerHTML='<span class="spin">‚ãØ</span> Analyzing...',L.style.display="block",L.innerHTML='<div class="suggestions-loading"><div class="loading-text">AI is suggesting assignees...</div></div>';try{de.length===0&&(de=(await ke.getAll())?.contacts||[]);const{suggested_assignees:A}=await We.suggest({content:E});A?.length?(L.innerHTML=`
            <div class="suggestions-header-sota"><div class="ai-badge">‚ú® AI Recommended</div></div>
            <div class="suggestions-list-sota">
              ${A.map(y=>{const k=W(y.name),T=ne(k),j=k?.role??y.reason??"";return`
                <div class="action-suggestion-card suggestion-card-sota">
                  <div class="suggestion-card-left">
                    <div class="suggestion-avatar-sota">${T?`<img src="${me(T)}" alt="" onerror="this.parentElement.innerHTML='${Dt(y.name)}'">`:Dt(y.name)}</div>
                    <div class="suggestion-score-ring" style="--score-color: ${(y.score??0)>=70?"var(--success)":(y.score??0)>=50?"var(--warning)":"var(--text-muted)"}">${y.score??0}</div>
                    <div>
                      <div class="suggestion-name">${me(y.name)}</div>
                      ${j?`<div class="suggestion-reason">${me(j)}</div>`:""}
                    </div>
                  </div>
                  <button type="button" class="btn-select-suggestion" data-assignee-name="${me(y.name)}">Assign</button>
                </div>
              `}).join("")}
            </div>
            <div class="suggestions-footer"><button type="button" class="btn-link" id="action-edit-hide-suggest-btn">Close suggestions</button></div>
          `,L.querySelectorAll(".btn-select-suggestion").forEach(y=>{const k=y.getAttribute("data-assignee-name")||"";k&&d(y,"click",()=>{R&&(R.value=k),Z&&(Z.innerHTML=me(k)),L.style.display="none",u.success(`Assignee set to ${k}`)})})):L.innerHTML='<div class="no-suggestions"><div class="no-suggestions-text">No suggestions</div><button type="button" class="btn-link" id="action-edit-hide-suggest-btn">Close</button></div>';const h=L.querySelector("#action-edit-hide-suggest-btn");h&&d(h,"click",()=>{L.style.display="none"})}catch{L.innerHTML='<div class="suggestions-error">Failed to get suggestions. <button type="button" class="btn-link" id="action-edit-hide-suggest-btn">Close</button></div>';const A=L.querySelector("#action-edit-hide-suggest-btn");A&&d(A,"click",()=>{L.style.display="none"})}finally{_.disabled=!1,_.innerHTML='<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> AI suggest'}});const ee=s.querySelector("#action-save-btn");ee&&d(ee,"click",async()=>{const z=s.querySelector("#action-edit-task"),E=s.querySelector("#action-edit-status"),_=s.querySelector("#action-edit-priority"),A=s.querySelector("#action-edit-assignee"),h=s.querySelector("#action-edit-due");if(!z?.value.trim()){u.warning("Task is required");return}try{const y=await We.update(t.id,{content:z.value.trim(),status:E?.value,priority:_?.value,assignee:A?.value.trim()||void 0,due_date:h?.value||void 0});u.success("Action updated"),a?.(y)}catch{u.error("Failed to update action")}});const le=s.querySelector("#delete-action-btn"),ae=s.querySelector("#action-delete-in-edit-btn"),X=async()=>{const{confirm:z}=await Y(async()=>{const{confirm:_}=await Promise.resolve().then(()=>Gt);return{confirm:_}},void 0);if(await z("Are you sure you want to delete this action?",{title:"Delete Action",confirmText:"Delete",confirmClass:"btn-danger"}))try{await We.delete(t.id),u.success("Action deleted"),n()}catch{u.error("Failed to delete action")}};le&&d(le,"click",X),ae&&d(ae,"click",X);const ie=s.querySelector(".doc-link[data-document-id]");ie&&d(ie,"click",z=>{z.preventDefault();const E=ie.getAttribute("data-document-id");E&&window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:E}}))});const U=s.querySelector("#action-ai-suggest-btn"),Q=s.querySelector("#action-suggestions-panel");U&&Q&&d(U,"click",async()=>{U.disabled=!0,Q.style.display="block",Q.innerHTML='<div class="suggestions-loading">Loading suggestions...</div>';try{const z=Zr(t);de.length===0&&(de=(await ke.getAll())?.contacts||[]);const{suggested_assignees:E}=await We.suggest({content:z});E?.length?(Q.innerHTML=`
            <div class="suggestions-header-sota">
              <div class="ai-badge">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Recommended
              </div>
            </div>
            <div class="suggestions-list-sota">
              ${E.map((A,h)=>{const y=W(A.name),k=ne(y),T=y?.role??A.reason??"";return`
                <div class="suggestion-card-sota" data-index="${h}">
                  <div class="suggestion-rank">#${h+1}</div>
                  <div class="suggestion-avatar-sota">${k?`<img src="${me(k)}" alt="" onerror="this.parentElement.innerHTML='${Dt(A.name)}'">`:Dt(A.name)}</div>
                  <div class="suggestion-info-sota">
                    <div class="suggestion-name-sota">${me(A.name)}</div>
                    ${T?`<div class="suggestion-reason-sota">${me(T)}</div>`:""}
                  </div>
                  <div class="suggestion-score-sota" style="--score-color: ${(A.score??0)>=70?"var(--success)":(A.score??0)>=50?"var(--warning)":"var(--text-muted)"}">
                    <div class="score-ring">
                      <svg viewBox="0 0 36 36">
                        <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path class="score-fill" stroke-dasharray="${A.score??0}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                      </svg>
                      <div class="score-value">${A.score??0}%</div>
                    </div>
                    <div class="score-label">Match</div>
                  </div>
                  <button type="button" class="btn-select-suggestion" data-assignee-name="${me(A.name)}">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Assign
                  </button>
                </div>
              `}).join("")}
            </div>
            <div class="suggestions-footer"><button type="button" class="btn-link" id="action-hide-suggest-btn">Close suggestions</button></div>
          `,Q.querySelectorAll(".btn-select-suggestion").forEach(A=>{d(A,"click",async()=>{const h=A.getAttribute("data-assignee-name")||"";if(h)try{const y=await We.update(t.id,{assignee:h});u.success(`Assigned to ${h}`),a?.(y),Q.style.display="none"}catch{u.error("Failed to assign")}})})):Q.innerHTML='<div class="no-suggestions">No suggestions. <button type="button" class="btn-link" id="action-hide-suggest-btn">Close suggestions</button></div>';const _=Q.querySelector("#action-hide-suggest-btn");_&&d(_,"click",()=>{Q.style.display="none"})}catch{Q.innerHTML='<div class="suggestions-error">Failed to get suggestions. <button type="button" class="btn-link" id="action-hide-suggest-btn">Close</button></div>';const z=Q.querySelector("#action-hide-suggest-btn");z&&d(z,"click",()=>{Q.style.display="none"})}finally{U.disabled=!1}});const te=s.querySelector("#timeline-content");te&&We.getEvents(t.id).then(z=>{if(z.length===0){te.innerHTML='<p class="empty-state">No events recorded</p>';return}const E=z.map(_=>{const A=Ey(_.event_type),h=_y(_);return`
          <div class="timeline-item action-event-${me(_.event_type)}">
            <div class="timeline-icon">${A}</div>
            <div class="timeline-content">
              <div class="timeline-title">${me(h)}</div>
              <div class="timeline-date">${Tn(_.created_at)}</div>
            </div>
          </div>`}).join("");te.innerHTML=`<div class="timeline-list">${E}</div>`}).catch(()=>{te.innerHTML='<p class="error">Failed to load timeline</p>'});let de=[];const qe=s.querySelector("#action-contact-picker"),Be=s.querySelector("#action-contact-list"),N=s.querySelector("#action-contact-search");function ne(z){if(!z)return null;const E=z;return E.photoUrl||E.avatarUrl||E.photo_url||E.avatar_url||null}const se=(z="")=>{if(!Be)return;const E=z?de.filter(_=>(_.name||"").toLowerCase().includes(z.toLowerCase())||(_.role||"").toLowerCase().includes(z.toLowerCase())||(_.organization||"").toLowerCase().includes(z.toLowerCase())):de;if(de.length===0){Be.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(E.length===0){Be.innerHTML='<div class="empty-state">No contacts match</div>';return}Be.innerHTML=E.map(_=>{const A=ne(_);return`
          <div class="contact-card-picker ${(r||"").trim()===(_.name||"").trim()?"selected":""}" data-contact-name="${me(_.name||"")}">
            <div class="contact-avatar-picker">${A?`<img src="${me(A)}" alt="" onerror="this.parentElement.innerHTML='${Dt(_.name||"")}'">`:Dt(_.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${me(_.name||"")}</div>
              ${_.role?`<div class="contact-role-picker">${me(_.role)}</div>`:""}
            </div>
          </div>`}).join(""),Be.querySelectorAll(".contact-card-picker").forEach(_=>{d(_,"click",async()=>{const A=_.getAttribute("data-contact-name")||"";if(A)try{const h=await We.update(t.id,{assignee:A});u.success(`Assigned to ${A}`),qe&&(qe.style.display="none"),a?.(h)}catch{u.error("Failed to save assignment")}})})},I=()=>{qe&&(qe.style.display=qe.style.display==="none"?"block":"none",qe.style.display==="block"&&de.length===0?ke.getAll().then(z=>{de=z?.contacts||[],se(N?.value||"")}).catch(()=>{Be&&(Be.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):qe.style.display==="block"&&se(N?.value||""),N&&N.focus())},O=s.querySelector("#action-change-assignee-btn"),F=s.querySelector("#action-show-picker-btn");O&&qe&&d(O,"click",I),F&&qe&&d(F,"click",I),N&&N.addEventListener("input",()=>se(N.value));function W(z){if(!z||!de.length)return;const E=z.trim().toLowerCase();if(!E)return;const _=de.find(y=>(y.name||"").trim().toLowerCase()===E);if(_)return _;const A=de.find(y=>(y.name||"").trim().toLowerCase().includes(E)||E.includes((y.name||"").trim().toLowerCase()));if(A)return A;const h=de.find(y=>(y.aliases||[]).some(k=>String(k).trim().toLowerCase()===E));return h||de.find(y=>(y.aliases||[]).some(k=>{const T=String(k).trim().toLowerCase();return T.includes(E)||E.includes(T)}))}return ke.getAll().then(z=>{de=z?.contacts||[];const E=W(r),_=s.querySelector("#action-assigned-role");_&&(_.textContent=E?.role??"‚Äî");const A=s.querySelector("#action-assigned-avatar");if(A&&r){const h=ne(E);if(h){A.innerHTML="";const y=document.createElement("img");y.src=h,y.alt="",y.onerror=()=>{A.textContent=Dt(r)},A.appendChild(y)}}}).catch(()=>{}),s}const jy=Object.freeze(Object.defineProperty({__proto__:null,createActionDetailView:Us},Symbol.toStringTag,{value:"Module"}));function di(e,t,n){return{action:n,onClose:()=>{e.innerHTML="",e.appendChild(Vs(t))},onUpdate:a=>{e.innerHTML="",a?e.appendChild(Us(di(e,t,a))):e.appendChild(Vs(t))}}}let Fa="all";function Vs(e={}){const t=x("div",{className:"sot-panel actions-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Actions</h2>
        <span class="panel-count" id="actions-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="actions-filter" class="filter-select">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
          <option value="overdue">Overdue</option>
        </select>
        <button class="btn btn-primary btn-sm" id="add-action-btn">+ Add</button>
      </div>
    </div>
    <div class="panel-content" id="actions-content">
      <div class="loading">Loading actions...</div>
    </div>
  `;const n=t.querySelector("#actions-filter");d(n,"change",()=>{Fa=n.value,Za(t,e)});const a=t.querySelector("#add-action-btn");return a&&d(a,"click",()=>{oa({mode:"create",onSave:()=>Za(t,e)})}),Za(t,e),t}async function Za(e,t){const n=e.querySelector("#actions-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=Fa==="all"||Fa==="overdue"?void 0:Fa;let s=await We.getAll(a);Fa==="overdue"&&(s=s.filter(o=>We.isOverdue(o))),Hy(n,s,t),B.setActions(s),zy(e,s.length)}catch{n.innerHTML='<div class="error">Failed to load actions</div>'}}function Dy(e,t){if(!t||!e.length)return;const n=t.trim().toLowerCase();if(!n)return;const a=e.find(i=>(i.name||"").trim().toLowerCase()===n);if(a)return a;const s=e.find(i=>(i.name||"").trim().toLowerCase().includes(n)||n.includes((i.name||"").trim().toLowerCase()));return s||e.find(i=>(i.aliases||[]).some(r=>String(r).trim().toLowerCase()===n))||e.find(i=>(i.aliases||[]).some(r=>{const c=String(r).trim().toLowerCase();return c.includes(n)||n.includes(c)}))}function Py(e){return e&&(e.photoUrl||e.avatarUrl||e.photo_url||e.avatar_url)||null}function Xr(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Hy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No actions found</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Action</button>
      </div>
    `;const o=e.querySelector("#empty-add-btn");o&&d(o,"click",()=>{oa({mode:"create"})});return}const a=B.getState().contacts||[],s={high:"#ea580c",medium:"#ca8a04",low:"#16a34a"};e.innerHTML=t.map(o=>{const i=We.isOverdue(o),r=(o.priority||"medium").toLowerCase(),c=s[r]??s.medium,l=(o.content??o.task??"").trim(),m=o.assignee??o.owner??"",v=m?Dy(a,m):void 0,g=Py(v),f=m?`
        <div class="assignee-chip">
          <div class="assignee-avatar">${g?`<img src="${_n(g)}" alt="${_n(m)}" onerror="this.parentElement.innerHTML='${Xr(m)}'">`:Xr(m)}</div>
          <div class="assignee-info">
            <span class="assignee-name">${_n(m)}</span>
            ${v?.role?`<span class="assignee-role">${_n(v.role)}</span>`:""}
          </div>
        </div>
      `:"",b=o.due_date?`<span class="card-source-chip">Due: ${Nn(o.due_date)}</span>`:'<span class="card-source-chip text-muted">No due date</span>';return`
      <div class="action-card-sota question-card-sota ${i?"overdue":""}" data-id="${o.id}" style="--action-priority-bar: ${c}">
        <div class="card-priority-bar action-priority-bar" style="background: ${c}"></div>
        <div class="card-body">
          <div class="card-top-row">
            <div class="card-badges">
              <span class="status-pill status-${(o.status||"pending").toLowerCase()}">${_n(String(o.status).replace("_"," "))}</span>
              ${o.priority?`<span class="priority-pill priority-${o.priority}">${_n(o.priority)}</span>`:""}
              ${i?'<span class="status-pill overdue">OVERDUE</span>':""}
            </div>
            <span class="card-timestamp">${J(o.created_at)}</span>
          </div>
          <div class="card-question-text">${_n(l)}</div>
          <div class="card-bottom-row">
            <div class="card-requester">
              ${f}
              ${b}
            </div>
            <div class="card-assignment">
              <button type="button" class="btn-link action-view-link">View</button>
            </div>
          </div>
        </div>
      </div>
    `}).join(""),e.querySelectorAll(".action-card-sota").forEach(o=>{d(o,"click",r=>{if(r.target.closest(".card-assignment"))return;const c=o.getAttribute("data-id"),l=t.find(m=>String(m.id)===c);if(l)if(n.useDetailView&&n.containerElement){const m=n.containerElement;m.innerHTML="",m.appendChild(Us(di(m,n,l)))}else n.onActionClick?n.onActionClick(l):oa({mode:"edit",action:l,onSave:()=>Za(e.closest(".actions-panel"),n)})});const i=o.querySelector(".action-view-link");i&&d(i,"click",r=>{r.stopPropagation();const c=o.getAttribute("data-id"),l=t.find(m=>String(m.id)===c);if(l)if(n.useDetailView&&n.containerElement){const m=n.containerElement;m.innerHTML="",m.appendChild(Us(di(m,n,l)))}else n.onActionClick?n.onActionClick(l):oa({mode:"edit",action:l,onSave:()=>Za(e.closest(".actions-panel"),n)})})})}function zy(e,t){const n=e.querySelector("#actions-count");n&&(n.textContent=String(t))}function _n(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Cs(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function ec(e){if(!e)return null;const t=e;return t.photoUrl||t.avatarUrl||t.photo_url||t.avatar_url||null}const Yt="decision-modal";function Ca(e){const{mode:t,decision:n,onSave:a,onDelete:s}=e,o=t==="edit"&&n?.id,i=t==="view",r=document.querySelector(`[data-modal-id="${Yt}"]`);r&&r.remove();const c=x("div",{className:"decision-modal-content"});if(i&&n){const v=n.content??n.decision,g=n.impact,f=n.summary;c.innerHTML=`
      <div class="decision-view">
        <div class="decision-meta">
          <span class="status-badge ${n.status}">${n.status}</span>
          ${g?`<span class="impact-badge impact-${g}">${Oe(g)} impact</span>`:""}
          <span class="decision-date">${J(n.madeAt)}</span>
        </div>
        
        <div class="decision-text-large">
          ${Oe(v)}
        </div>
        
        ${f?`
          <div class="decision-section decision-summary">
            <h4>Summary</h4>
            <p>${Oe(f)}</p>
          </div>
        `:""}
        
        ${n.rationale?`
          <div class="decision-section">
            <h4>Rationale</h4>
            <p>${Oe(n.rationale)}</p>
          </div>
        `:""}
        
        ${n.madeBy?`
          <div class="decision-made-by">
            <strong>Decision made by:</strong> ${Oe(n.madeBy)}
          </div>
        `:""}
      </div>
    `}else{let v=function(ae){if(!ae||!S.length)return;const X=ae.trim().toLowerCase();if(!X)return;const ie=S.find(Q=>(Q.name||"").trim().toLowerCase()===X);return ie||S.find(Q=>(Q.aliases||[]).some(te=>String(te).trim().toLowerCase()===X))},g=function(ae){if(!L||!R)return;if(R.value=ae,ae){const U=v(ae),Q=ec(U);L.innerHTML=`
          <div class="assigned-contact-display">
            <div class="contact-avatar-lg">${Q?`<img src="${Oe(Q)}" alt="" onerror="this.parentElement.innerHTML='${Cs(ae)}'">`:Cs(ae)}</div>
            <div class="contact-details">
              <div class="contact-name-lg">${Oe(ae)}</div>
              ${U?.role?`<div class="contact-role-sm">${Oe(U.role)}</div>`:""}
            </div>
            <button type="button" class="btn-change-assignment" id="decision-modal-change-owner-btn">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
              Change
            </button>
          </div>`}else L.innerHTML=`
          <div class="no-assignment">
            <span>No owner</span>
            <button type="button" class="btn-assign-now" id="decision-modal-choose-owner-btn">Choose</button>
          </div>`;const X=L.querySelector("#decision-modal-change-owner-btn"),ie=L.querySelector("#decision-modal-choose-owner-btn");X&&d(X,"click",f),ie&&d(ie,"click",f)},f=function(){Z&&(Z.style.display=Z.style.display==="none"?"block":"none",Z.style.display==="block"&&S.length===0?ke.getAll().then(ae=>{S=ae?.contacts||[],b(le?.value||"")}).catch(()=>{ee&&(ee.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):Z.style.display==="block"&&b(le?.value||""),le&&le.focus())},b=function(ae){if(!ee)return;const X=ae?S.filter(U=>(U.name||"").toLowerCase().includes(ae.toLowerCase())||(U.role||"").toLowerCase().includes(ae.toLowerCase())):S;if(S.length===0){ee.innerHTML='<div class="empty-state">Loading...</div>';return}if(X.length===0){ee.innerHTML='<div class="empty-state">No contacts match</div>';return}const ie=(R?.value||"").trim();ee.innerHTML=X.map(U=>{const Q=ec(U);return`
            <div class="contact-card-picker ${ie===(U.name||"").trim()?"selected":""}" data-contact-name="${Oe(U.name||"")}">
              <div class="contact-avatar-picker">${Q?`<img src="${Oe(Q)}" alt="" onerror="this.parentElement.innerHTML='${Cs(U.name||"")}'">`:Cs(U.name||"")}</div>
              <div class="contact-info-picker">
                <div class="contact-name-picker">${Oe(U.name||"")}</div>
                ${U.role?`<div class="contact-role-picker">${Oe(U.role)}</div>`:""}
              </div>
            </div>`}).join(""),ee.querySelectorAll(".contact-card-picker").forEach(U=>{d(U,"click",()=>{const Q=U.getAttribute("data-contact-name")||"";Q&&(g(Q),Z&&(Z.style.display="none"))})})};const w=n?.content??n?.decision??"",$=n?.impact??"",M=n?.summary??"";c.innerHTML=`
      <form id="decision-form" class="decision-form">
        <div class="form-group">
          <label for="decision-text">Decision *</label>
          <textarea id="decision-text" rows="3" required 
                    placeholder="What was decided?">${Oe(w)}</textarea>
        </div>
        
        <div class="form-group">
          <label for="decision-rationale">Rationale</label>
          <div class="form-group-with-action">
            <textarea id="decision-rationale" rows="2" 
                      placeholder="Why was this decision made?">${Oe(n?.rationale||"")}</textarea>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="decision-impact">Impact</label>
            <select id="decision-impact">
              <option value="">‚Äî</option>
              <option value="low" ${$==="low"?"selected":""}>Low</option>
              <option value="medium" ${$==="medium"||!$?"selected":""}>Medium</option>
              <option value="high" ${$==="high"?"selected":""}>High</option>
            </select>
          </div>
          <div class="form-group">
            <label for="decision-summary">Summary (one line)</label>
            <input type="text" id="decision-summary" 
                   value="${Oe(M)}" 
                   placeholder="One-line summary for lists/reports">
          </div>
        </div>
        
        <div class="form-row form-row-actions">
          <button type="button" class="btn-ai-suggest btn-sm" id="decision-ai-suggest-btn" title="Suggest rationale, impact and summary from decision text">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            AI suggest
          </button>
          <span class="form-hint" id="decision-suggest-hint"></span>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="decision-status">Status</label>
            <select id="decision-status">
              <option value="proposed" ${n?.status==="proposed"||!n?"selected":""}>Proposed</option>
              <option value="approved" ${n?.status==="approved"?"selected":""}>Approved</option>
              <option value="rejected" ${n?.status==="rejected"?"selected":""}>Rejected</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Made By</label>
            <input type="hidden" id="decision-by" value="${Oe(n?.madeBy||"")}">
            <div id="decision-made-by-display" class="current-assignment-card decision-modal-owner-card"></div>
            <div id="decision-modal-contact-picker" class="contact-picker-sota" style="display: none; margin-top: 8px;">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="decision-modal-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="decision-modal-contact-list" class="contact-list-grid">Loading...</div>
            </div>
          </div>
        </div>
      </form>
    `;const q=c.querySelector("#decision-ai-suggest-btn"),C=c.querySelector("#decision-suggest-hint");q&&d(q,"click",async()=>{const ae=ie=>c.querySelector(`#${ie}`)?.value?.trim()||"",X=ae("decision-text");if(!X){u.warning("Enter decision text first");return}q.disabled=!0,C&&(C.textContent="Asking AI‚Ä¶");try{const ie=await Le.suggest(X,ae("decision-rationale"));c.querySelector("#decision-rationale").value=ie.rationale||"",c.querySelector("#decision-impact").value=ie.impact||"medium",c.querySelector("#decision-summary").value=ie.summary||"",C&&(C.textContent=ie.impact_summary?`Impact: ${ie.impact_summary}`:"Done")}catch{C&&(C.textContent=""),u.error("AI suggest failed")}finally{q.disabled=!1}});let S=[];const L=c.querySelector("#decision-made-by-display"),R=c.querySelector("#decision-by"),Z=c.querySelector("#decision-modal-contact-picker"),ee=c.querySelector("#decision-modal-contact-list"),le=c.querySelector("#decision-modal-contact-search");ke.getAll().then(ae=>{S=ae?.contacts||[],g(n?.madeBy||"")}).catch(()=>{g(n?.madeBy||"")}),le&&le.addEventListener("input",()=>b(le.value))}const l=x("div",{className:"modal-footer"});if(i&&n){if(n.status==="proposed"){const f=x("button",{className:"btn btn-success",textContent:"Approve"}),b=x("button",{className:"btn btn-danger",textContent:"Reject"});d(f,"click",()=>tc(String(n.id),"approved")),d(b,"click",()=>tc(String(n.id),"rejected")),l.appendChild(b),l.appendChild(f)}const v=x("button",{className:"btn btn-primary",textContent:"Edit"}),g=x("button",{className:"btn btn-secondary",textContent:"Close"});d(g,"click",()=>H(Yt)),d(v,"click",()=>{H(Yt),Ca({...e,mode:"edit"})}),l.appendChild(g),l.appendChild(v)}else{const v=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),g=x("button",{className:"btn btn-primary",textContent:o?"Save Changes":"Create Decision"});if(d(v,"click",()=>H(Yt)),d(g,"click",async()=>{const f=c.querySelector("#decision-form");if(!f.checkValidity()){f.reportValidity();return}const b=M=>c.querySelector(`#${M}`)?.value.trim()||"",w={id:n?.id||`dec-${Date.now()}`,decision:b("decision-text"),rationale:b("decision-rationale")||void 0,status:b("decision-status"),madeBy:b("decision-by")||void 0,madeAt:n?.madeAt||new Date().toISOString(),impact:b("decision-impact")||void 0,summary:b("decision-summary")||void 0};g.disabled=!0,g.textContent="Saving...";const $={content:w.decision,decision:w.decision,rationale:w.rationale,status:w.status,made_by:w.madeBy,impact:w.impact,summary:w.summary};try{if(o)await p.put(`/api/decisions/${n.id}`,$),u.success("Decision updated");else{const M=await p.post("/api/decisions",$);w.id=M.data.id,u.success("Decision recorded")}a?.(w),H(Yt)}catch{}finally{g.disabled=!1,g.textContent=o?"Save Changes":"Create Decision"}}),o){const f=x("button",{className:"btn btn-danger",textContent:"Delete"});d(f,"click",async()=>{const{confirm:b}=await Y(async()=>{const{confirm:$}=await Promise.resolve().then(()=>Gt);return{confirm:$}},void 0);if(await b("Are you sure you want to delete this decision?",{title:"Delete Decision",confirmText:"Delete",confirmClass:"btn-danger"}))try{await p.delete(`/api/decisions/${n.id}`),u.success("Decision deleted"),s?.(String(n.id)),H(Yt)}catch{}}),l.appendChild(f)}l.appendChild(v),l.appendChild(g)}const m=fe({id:Yt,title:i?"Decision Details":o?"Edit Decision":"Record Decision",content:c,size:"md",footer:l});document.body.appendChild(m),he(Yt)}async function tc(e,t,n){try{await p.patch(`/api/decisions/${e}`,{status:t}),u.success(`Decision ${t}`),H(Yt)}catch{}}function Oe(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ue(e){return e.trim().split(/\s+/).map(t=>t[0]).join("").toUpperCase().substring(0,2)}function K(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function _o(e){if(!e)return"‚Äî";try{return Tn(e)}catch{return e}}function er(e){const{decision:t,onClose:n,onUpdate:a,onDecisionClick:s}=e,o=x("div",{className:"decision-detail-view question-detail-view"});o.innerHTML=`
    <div class="question-detail-header decision-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Decisions</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Decision #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        <span class="status-badge status-${(t.status||"active").toLowerCase()}">${K(String(t.status))}</span>
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content decision-detail-content">
      <div id="decision-view-content">
      <section class="detail-section decision-main">
        <div class="question-badges decision-badges">
          ${t.impact?`<span class="priority-pill impact-${t.impact}">${K(t.impact)} impact</span>`:""}
          ${t.generation_source?`<span class="status-pill">${K(t.generation_source)}</span>`:""}
          <span class="question-date decision-date">Created ${J(t.created_at)}</span>
        </div>
        <h2 class="question-text decision-content-text" id="decision-view-content-text">${K(t.content)}</h2>
      </section>

      <div class="detail-columns">
        <div class="detail-column-left">
          <section class="detail-section">
            <div class="section-header-sota">
              <h3>Rationale / Context</h3>
              <span class="section-subtitle">Why was this decision made?</span>
              <button type="button" class="btn-ai-suggest" id="decision-rationale-ai-suggest-btn" title="Suggest rationale, impact and summary from decision text">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Suggest
              </button>
            </div>
            <div id="decision-view-rationale">${t.rationale||t.context?`<p class="decision-rationale">${K(t.rationale||t.context||"")}</p>`:'<p class="text-muted">No rationale recorded</p>'}</div>
            <div id="decision-suggestions-panel" class="suggestions-panel-sota decision-suggestions-panel" style="display: none; margin-top: 8px;"></div>
          </section>

          <section class="detail-section" id="decision-owner-section">
            <div class="section-header-sota">
              <h3>
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Owner / Made by
                <span class="section-subtitle">Who made this decision?</span>
              </h3>
              <button type="button" class="btn-ai-suggest" id="decision-owner-ai-suggest-btn" title="Suggest owner from decision content">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Suggest
              </button>
            </div>

            <div id="decision-current-owner" class="current-assignment-card">
              ${t.made_by||t.owner?`
                <div class="assigned-contact-display">
                  <div class="contact-avatar-lg" id="decision-owner-avatar">${Ue(t.made_by||t.owner||"")}</div>
                  <div class="contact-details">
                    <div class="contact-name-lg">${K(t.made_by||t.owner||"")}</div>
                    <div class="contact-role-sm" id="decision-owner-role">‚Äî</div>
                  </div>
                  <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    Change
                  </button>
                </div>
              `:`
                <div class="no-assignment">
                  <div class="no-assignment-icon">
                    <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  </div>
                  <span>No owner</span>
                  <p class="no-assignment-hint">Choose from contacts</p>
                  <button class="btn-assign-now" id="decision-show-owner-picker-btn" type="button">Choose</button>
                </div>
              `}
            </div>

            <div id="decision-contact-picker" class="contact-picker-sota" style="display: none;">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="decision-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="decision-contact-list" class="contact-list-grid">Loading...</div>
            </div>

            <div id="decision-owner-suggestions-panel" class="suggestions-panel-sota decision-owner-suggestions-panel" style="display: none; margin-top: 8px;"></div>

            ${t.approved_by?`<p class="text-muted" style="margin-top: 8px;">Approved by: ${K(t.approved_by)}</p>`:""}
            ${t.decided_at?`<p class="text-muted">Decided: ${_o(t.decided_at)}</p>`:""}
          </section>

          <section class="detail-section">
            <div class="section-header">
              <h3>Source</h3>
            </div>
            ${t.source_file?`<p class="source-file">${K(t.source_file)}</p>`:""}
            ${t.source_document_id?`
              <p class="source-doc">
                <a href="#" class="doc-link" data-document-id="${K(String(t.source_document_id))}">View source document</a>
              </p>
            `:""}
            ${!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
          </section>
        </div>

        <div class="detail-column-right">
          <section class="detail-section metadata-section">
            <div class="section-header">
              <h3>Metadata</h3>
            </div>
            <dl class="metadata-list">
              <dt>Created</dt>
              <dd>${_o(t.created_at)}</dd>
              ${t.updated_at?`<dt>Updated</dt><dd>${_o(t.updated_at)}</dd>`:""}
            </dl>
          </section>

          <section class="detail-section decision-timeline-section">
            <div class="section-header">
              <h3>Timeline</h3>
            </div>
            <div id="decision-timeline-list" class="decision-timeline-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>

          <section class="detail-section decision-similar-section">
            <div class="section-header">
              <h3>Similar decisions</h3>
            </div>
            <div id="decision-similar-list" class="decision-similar-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>
        </div>
      </div>

      <div class="detail-actions">
        <button type="button" class="btn btn-secondary" id="edit-decision-btn">Edit</button>
        <button type="button" class="btn btn-danger" id="delete-decision-btn">Delete</button>
      </div>
      </div>

      <div id="decision-edit-form" class="decision-detail-edit-form" style="display: none;">
        <form id="decision-inline-form" class="decision-form">
          <div class="form-group">
            <label for="decision-edit-content">Decision *</label>
            <textarea id="decision-edit-content" rows="3" required placeholder="What was decided?">${K(t.content||"")}</textarea>
          </div>
          <div class="form-group">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; margin-bottom: 6px;">
              <label for="decision-edit-rationale" style="margin-bottom: 0;">Rationale</label>
              <button type="button" class="btn-ai-suggest btn-sm" id="decision-edit-ai-suggest-btn" title="Suggest rationale, impact and summary from decision text">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI suggest
              </button>
            </div>
            <textarea id="decision-edit-rationale" rows="2" placeholder="Why was this decision made?">${K(t.rationale||t.context||"")}</textarea>
          </div>
          <div id="decision-edit-suggestions-panel" class="suggestions-panel-sota" style="display: none; margin-bottom: 12px;"></div>
          <div class="form-row">
            <div class="form-group">
              <label for="decision-edit-impact">Impact</label>
              <select id="decision-edit-impact">
                <option value="low" ${t.impact==="low"?"selected":""}>Low</option>
                <option value="medium" ${t.impact==="medium"||!t.impact?"selected":""}>Medium</option>
                <option value="high" ${t.impact==="high"?"selected":""}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="decision-edit-summary">Summary (one line)</label>
              <input type="text" id="decision-edit-summary" value="${K(t.summary||"")}" placeholder="One-line summary for lists/reports">
            </div>
            <div class="form-group">
              <label for="decision-edit-status">Status</label>
              <select id="decision-edit-status">
                <option value="proposed" ${t.status==="proposed"||!t.status?"selected":""}>Proposed</option>
                <option value="approved" ${t.status==="approved"?"selected":""}>Approved</option>
                <option value="rejected" ${t.status==="rejected"?"selected":""}>Rejected</option>
                <option value="deferred" ${t.status==="deferred"?"selected":""}>Deferred</option>
                <option value="active" ${t.status==="active"?"selected":""}>Active</option>
                <option value="superseded" ${t.status==="superseded"?"selected":""}>Superseded</option>
                <option value="revoked" ${t.status==="revoked"?"selected":""}>Revoked</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Made by</label>
            <input type="hidden" id="decision-edit-made-by" value="${K(t.made_by||t.owner||"")}">
            <div id="decision-edit-owner-display" class="current-assignment-card decision-edit-owner-card"></div>
            <div id="decision-edit-contact-picker" class="contact-picker-sota" style="display: none; margin-top: 8px;">
              <div class="picker-search">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="decision-edit-contact-search" placeholder="Search contacts..." autocomplete="off">
              </div>
              <div id="decision-edit-contact-list" class="contact-list-grid">Loading...</div>
            </div>
          </div>
        </form>
        <div class="detail-actions">
          <button type="button" class="btn btn-primary" id="decision-save-btn">Save</button>
          <button type="button" class="btn btn-secondary" id="decision-cancel-edit-btn">Cancel</button>
          <button type="button" class="btn btn-danger" id="decision-delete-in-edit-btn">Delete</button>
        </div>
      </div>
    </div>
  `;const i=o.querySelector("#back-to-list");i&&d(i,"click",E=>{E.preventDefault(),n()});const r=o.querySelector("#close-detail");r&&d(r,"click",n);const c=o.querySelector("#decision-view-content"),l=o.querySelector("#decision-edit-form"),m=o.querySelector("#edit-decision-btn");m&&c&&l&&d(m,"click",()=>{c.style.display="none",l.style.display="block",de(M)});const v=o.querySelector("#decision-cancel-edit-btn");v&&c&&l&&d(v,"click",()=>{l.style.display="none",c.style.display=""});const g=o.querySelector("#decision-save-btn");g&&l&&a&&d(g,"click",async()=>{const E=o.querySelector("#decision-inline-form");if(!E?.checkValidity()){E.reportValidity();return}const _=o.querySelector("#decision-edit-content"),A=o.querySelector("#decision-edit-rationale"),h=o.querySelector("#decision-edit-impact"),y=o.querySelector("#decision-edit-summary"),k=o.querySelector("#decision-edit-status"),T=o.querySelector("#decision-edit-made-by"),j=_?.value?.trim()||"";if(!j){u.error("Decision text is required");return}g.disabled=!0,g.textContent="Saving...";try{const D=await Le.update(t.id,{content:j,rationale:A?.value?.trim()||void 0,impact:h?.value||void 0,summary:y?.value?.trim()||void 0,status:k?.value||"active",made_by:T?.value?.trim()||void 0});u.success("Decision updated");const G=o.querySelector("#decision-view-content-text");G&&(G.textContent=D.content||j);const V=o.querySelector("#decision-view-rationale");V&&(V.innerHTML=D.rationale||D.context?`<p class="decision-rationale">${K(D.rationale||D.context||"")}</p>`:'<p class="text-muted">No rationale recorded</p>');const re=o.querySelector(".decision-detail-header .status-badge");re&&(re.textContent=String(D.status||"active"),re.className=`status-badge status-${(D.status||"active").toLowerCase()}`);const $e=o.querySelector(".decision-badges");if($e){const je=D.impact?`<span class="priority-pill impact-${D.impact}">${K(D.impact||"")} impact</span>`:"",be=$e.innerHTML;if(je&&!be.includes("impact-"))$e.insertAdjacentHTML("afterbegin",je+" ");else if(je){const Te=$e.querySelector(".priority-pill.impact-");Te&&(Te.outerHTML=je)}}M=D.made_by||D.owner||"";const _e=o.querySelector("#decision-current-owner");if(_e&&M){const je=R(M),be=L(je);_e.innerHTML=`
            <div class="assigned-contact-display">
              <div class="contact-avatar-lg" id="decision-owner-avatar">${be?`<img src="${K(be)}" alt="" onerror="this.parentElement.innerHTML='${Ue(M)}'">`:Ue(M)}</div>
              <div class="contact-details">
                <div class="contact-name-lg">${K(M)}</div>
                <div class="contact-role-sm" id="decision-owner-role">${K(je?.role??"‚Äî")}</div>
              </div>
              <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                Change
              </button>
            </div>`;const Te=_e.querySelector("#decision-change-owner-btn");Te&&d(Te,"click",ee)}else if(_e&&!M){_e.innerHTML=`
            <div class="no-assignment">
              <div class="no-assignment-icon">
                <svg width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
              </div>
              <span>No owner</span>
              <p class="no-assignment-hint">Choose from contacts</p>
              <button class="btn-assign-now" id="decision-show-owner-picker-btn" type="button">Choose</button>
            </div>`;const je=_e.querySelector("#decision-show-owner-picker-btn");je&&d(je,"click",ee)}a(D),l.style.display="none",c.style.display=""}catch{u.error("Failed to save decision")}finally{g.disabled=!1,g.textContent="Save"}});const f=o.querySelector("#decision-delete-in-edit-btn");f&&d(f,"click",async()=>{if(confirm("Are you sure you want to delete this decision?"))try{await Le.delete(t.id),u.success("Decision deleted"),n()}catch{u.error("Failed to delete decision")}});const b=o.querySelector("#delete-decision-btn");b&&d(b,"click",async()=>{if(confirm("Are you sure you want to delete this decision?"))try{await Le.delete(t.id),u.success("Decision deleted"),n()}catch{u.error("Failed to delete decision")}});const w=o.querySelector(".doc-link");w&&t.source_document_id&&d(w,"click",E=>{E.preventDefault(),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:t.source_document_id}}))});let $=[],M=t.made_by||t.owner||"";const q=o.querySelector("#decision-contact-picker"),C=o.querySelector("#decision-contact-list"),S=o.querySelector("#decision-contact-search");function L(E){if(!E)return null;const _=E;return _.photoUrl||_.avatarUrl||_.photo_url||_.avatar_url||null}function R(E){if(!E||!$.length)return;const _=E.trim().toLowerCase();if(!_)return;const A=$.find(k=>(k.name||"").trim().toLowerCase()===_);if(A)return A;const h=$.find(k=>(k.name||"").trim().toLowerCase().includes(_)||_.includes((k.name||"").trim().toLowerCase()));return h||$.find(k=>(k.aliases||[]).some(T=>String(T).trim().toLowerCase()===_))||$.find(k=>(k.aliases||[]).some(T=>{const j=String(T).trim().toLowerCase();return j.includes(_)||_.includes(j)}))}const Z=(E="")=>{if(!C)return;const _=E?$.filter(A=>(A.name||"").toLowerCase().includes(E.toLowerCase())||(A.role||"").toLowerCase().includes(E.toLowerCase())||(A.organization||"").toLowerCase().includes(E.toLowerCase())):$;if($.length===0){C.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(_.length===0){C.innerHTML='<div class="empty-state">No contacts match</div>';return}C.innerHTML=_.map(A=>{const h=L(A);return`
          <div class="contact-card-picker ${(M||"").trim()===(A.name||"").trim()?"selected":""}" data-contact-name="${K(A.name||"")}">
            <div class="contact-avatar-picker">${h?`<img src="${K(h)}" alt="" onerror="this.parentElement.innerHTML='${Ue(A.name||"")}'">`:Ue(A.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${K(A.name||"")}</div>
              ${A.role?`<div class="contact-role-picker">${K(A.role)}</div>`:""}
            </div>
          </div>`}).join(""),C.querySelectorAll(".contact-card-picker").forEach(A=>{d(A,"click",async()=>{const h=A.getAttribute("data-contact-name")||"";if(h)try{const y=await Le.update(t.id,{made_by:h});M=h,u.success(`Owner set to ${h}`),q&&(q.style.display="none"),a&&a({...t,made_by:h,...y});const k=o.querySelector("#decision-current-owner");if(k){const T=R(h),j=L(T);k.innerHTML=`
              <div class="assigned-contact-display">
                <div class="contact-avatar-lg" id="decision-owner-avatar">${j?`<img src="${K(j)}" alt="" onerror="this.parentElement.innerHTML='${Ue(h)}'">`:Ue(h)}</div>
                <div class="contact-details">
                  <div class="contact-name-lg">${K(h)}</div>
                  <div class="contact-role-sm" id="decision-owner-role">${K(T?.role??"‚Äî")}</div>
                </div>
                <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                  <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                  Change
                </button>
              </div>`;const D=k.querySelector("#decision-change-owner-btn");D&&d(D,"click",ee)}}catch{u.error("Failed to save owner")}})})},ee=()=>{q&&(q.style.display=q.style.display==="none"?"block":"none",q.style.display==="block"&&$.length===0?ke.getAll().then(E=>{$=E?.contacts||[],Z(S?.value||"")}).catch(()=>{C&&(C.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):q.style.display==="block"&&Z(S?.value||""),S&&S.focus())},le=o.querySelector("#decision-change-owner-btn"),ae=o.querySelector("#decision-show-owner-picker-btn");le&&q&&d(le,"click",ee),ae&&q&&d(ae,"click",ee),S&&S.addEventListener("input",()=>Z(S.value)),ke.getAll().then(E=>{$=E?.contacts||[];const _=R(M),A=o.querySelector("#decision-owner-role");A&&(A.textContent=_?.role??"‚Äî");const h=o.querySelector("#decision-owner-avatar");if(h&&M){const y=L(_);if(y){h.innerHTML="";const k=document.createElement("img");k.src=y,k.alt="",k.onerror=()=>{h.textContent=Ue(M)},h.appendChild(k)}}}).catch(()=>{});const X=o.querySelector("#decision-edit-owner-display"),ie=o.querySelector("#decision-edit-made-by"),U=o.querySelector("#decision-edit-contact-picker"),Q=o.querySelector("#decision-edit-contact-list"),te=o.querySelector("#decision-edit-contact-search");function de(E){if(!X||!ie)return;if(ie.value=E,E){const h=R(E),y=L(h);X.innerHTML=`
        <div class="assigned-contact-display">
          <div class="contact-avatar-lg">${y?`<img src="${K(y)}" alt="" onerror="this.parentElement.innerHTML='${Ue(E)}'">`:Ue(E)}</div>
          <div class="contact-details">
            <div class="contact-name-lg">${K(E)}</div>
            ${h?.role?`<div class="contact-role-sm">${K(h.role)}</div>`:""}
          </div>
          <button type="button" class="btn-change-assignment" id="decision-edit-change-owner-btn">
            <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            Change
          </button>
        </div>`}else X.innerHTML=`
        <div class="no-assignment">
          <span>No owner</span>
          <button type="button" class="btn-assign-now" id="decision-edit-choose-owner-btn">Choose</button>
        </div>`;const _=X.querySelector("#decision-edit-change-owner-btn"),A=X.querySelector("#decision-edit-choose-owner-btn");_&&d(_,"click",Be),A&&d(A,"click",Be)}function qe(E=""){if(!Q)return;const _=E?$.filter(h=>(h.name||"").toLowerCase().includes(E.toLowerCase())||(h.role||"").toLowerCase().includes(E.toLowerCase())):$;if($.length===0){Q.innerHTML='<div class="empty-state">Loading contacts...</div>';return}if(_.length===0){Q.innerHTML='<div class="empty-state">No contacts match</div>';return}const A=(ie?.value||"").trim();Q.innerHTML=_.map(h=>{const y=L(h);return`
          <div class="contact-card-picker ${A===(h.name||"").trim()?"selected":""}" data-contact-name="${K(h.name||"")}">
            <div class="contact-avatar-picker">${y?`<img src="${K(y)}" alt="" onerror="this.parentElement.innerHTML='${Ue(h.name||"")}'">`:Ue(h.name||"")}</div>
            <div class="contact-info-picker">
              <div class="contact-name-picker">${K(h.name||"")}</div>
              ${h.role?`<div class="contact-role-picker">${K(h.role)}</div>`:""}
            </div>
          </div>`}).join(""),Q.querySelectorAll(".contact-card-picker").forEach(h=>{d(h,"click",()=>{const y=h.getAttribute("data-contact-name")||"";y&&(de(y),U&&(U.style.display="none"))})})}function Be(){U&&(U.style.display=U.style.display==="none"?"block":"none",U.style.display==="block"&&($.length===0?ke.getAll().then(E=>{$=E?.contacts||[],qe(te?.value||"")}).catch(()=>{Q&&(Q.innerHTML='<div class="empty-state">Failed to load contacts</div>')}):qe(te?.value||"")),te&&te.focus())}te&&te.addEventListener("input",()=>qe(te.value)),de(t.made_by||t.owner||"");const N=o.querySelector("#decision-owner-ai-suggest-btn"),ne=o.querySelector("#decision-owner-suggestions-panel");N&&ne&&d(N,"click",async()=>{N.disabled=!0,ne.style.display="block",ne.innerHTML='<div class="loading">Asking AI‚Ä¶</div>';try{$.length===0&&($=(await ke.getAll())?.contacts||[]);const{suggested_owners:E}=await Le.suggestOwner(t.content||"",t.rationale||t.context||"");E?.length?(ne.innerHTML=`
            <div class="suggestions-header-sota">
              <div class="ai-badge">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                AI Recommended
              </div>
            </div>
            <div class="suggestions-list-sota">
              ${E.map((A,h)=>{const y=R(A.name),k=L(y),T=y?.role??A.reason??"",j=A.score??0,D=j>=70?"var(--success)":j>=50?"var(--warning)":"var(--text-muted)";return`
                <div class="suggestion-card-sota decision-owner-card" data-owner-name="${K(A.name)}">
                  <div class="suggestion-rank">#${h+1}</div>
                  <div class="suggestion-avatar-sota">${k?`<img src="${K(k)}" alt="" onerror="this.parentElement.innerHTML='${Ue(A.name)}'">`:Ue(A.name)}</div>
                  <div class="suggestion-info-sota">
                    <div class="suggestion-name-sota">${K(A.name)}</div>
                    ${T?`<div class="suggestion-reason-sota">${K(T)}</div>`:""}
                  </div>
                  ${j>0?`<div class="suggestion-score-sota" style="--score-color: ${D}"><div class="score-value">${j}%</div><div class="score-label">Match</div></div>`:""}
                  <button type="button" class="btn-select-suggestion">Assign</button>
                </div>`}).join("")}
            </div>
            <div class="suggestions-footer"><button type="button" class="btn-link" id="decision-owner-hide-suggest-btn">Close</button></div>
          `,ne.querySelectorAll(".decision-owner-card .btn-select-suggestion").forEach(A=>{const y=A.closest(".decision-owner-card")?.getAttribute("data-owner-name")||"";y&&d(A,"click",async()=>{try{const k=await Le.update(t.id,{made_by:y});M=y,u.success(`Owner set to ${y}`),ne.style.display="none";const T=o.querySelector("#decision-current-owner");if(T){const j=R(y),D=L(j);T.innerHTML=`
                    <div class="assigned-contact-display">
                      <div class="contact-avatar-lg" id="decision-owner-avatar">${D?`<img src="${K(D)}" alt="" onerror="this.parentElement.innerHTML='${Ue(y)}'">`:Ue(y)}</div>
                      <div class="contact-details">
                        <div class="contact-name-lg">${K(y)}</div>
                        <div class="contact-role-sm" id="decision-owner-role">${K(j?.role??"‚Äî")}</div>
                      </div>
                      <button class="btn-change-assignment" id="decision-change-owner-btn" type="button">
                        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        Change
                      </button>
                    </div>`;const G=T.querySelector("#decision-change-owner-btn");G&&d(G,"click",ee)}a&&a(k)}catch{u.error("Failed to save owner")}})})):ne.innerHTML='<div class="no-suggestions">No owner suggestions. <button type="button" class="btn-link" id="decision-owner-hide-suggest-btn">Close</button></div>';const _=ne.querySelector("#decision-owner-hide-suggest-btn");_&&d(_,"click",()=>{ne.style.display="none"})}catch{ne.innerHTML='<div class="error">AI suggest failed. <button type="button" class="btn-link" id="decision-owner-hide-suggest-btn">Close</button></div>';const E=ne.querySelector("#decision-owner-hide-suggest-btn");E&&d(E,"click",()=>{ne.style.display="none"}),u.error("AI suggest failed")}finally{N.disabled=!1}});const se=o.querySelector("#decision-rationale-ai-suggest-btn"),I=o.querySelector("#decision-suggestions-panel");se&&I&&d(se,"click",async()=>{se.disabled=!0,I.style.display="block",I.innerHTML='<div class="loading">Asking AI‚Ä¶</div>';try{const E=await Le.suggest(t.content||"",t.rationale||t.context||"");I.innerHTML=`
          <div class="suggestion-card">
            <p><strong>Rationale:</strong> ${K((E.rationale||"").substring(0,300))}${(E.rationale||"").length>300?"‚Ä¶":""}</p>
            <p><strong>Impact:</strong> ${K(E.impact||"")} ${E.impact_summary?`‚Äì ${K(E.impact_summary)}`:""}</p>
            <p><strong>Summary:</strong> ${K(E.summary||"")}</p>
            <button type="button" class="btn btn-primary btn-sm" id="decision-apply-suggestion-btn">Apply</button>
          </div>`;const _=I.querySelector("#decision-apply-suggestion-btn");_&&d(_,"click",async()=>{try{const A=await Le.update(t.id,{rationale:E.rationale,impact:E.impact,summary:E.summary});u.success("Suggestion applied");const h=o.querySelector("#decision-view-rationale");h&&(h.innerHTML=A.rationale||A.context?`<p class="decision-rationale">${K(A.rationale||A.context||"")}</p>`:'<p class="text-muted">No rationale recorded</p>');const y=o.querySelector(".decision-badges");if(y&&A.impact){const k=y.querySelector(".priority-pill.impact-low, .priority-pill.impact-medium, .priority-pill.impact-high");k?k.outerHTML=`<span class="priority-pill impact-${A.impact}">${K(A.impact||"")} impact</span>`:y.insertAdjacentHTML("afterbegin",`<span class="priority-pill impact-${A.impact}">${K(A.impact||"")} impact</span> `)}a&&a(A),I.style.display="none"}catch{u.error("Failed to apply")}})}catch{I.innerHTML='<div class="error">AI suggest failed</div>',u.error("AI suggest failed")}finally{se.disabled=!1}});const O=o.querySelector("#decision-edit-ai-suggest-btn"),F=o.querySelector("#decision-edit-suggestions-panel");O&&d(O,"click",async()=>{const E=o.querySelector("#decision-edit-content"),_=o.querySelector("#decision-edit-rationale"),A=o.querySelector("#decision-edit-impact"),h=o.querySelector("#decision-edit-summary"),y=E?.value?.trim()||"";if(!y){u.warning("Enter decision text first");return}O.disabled=!0,F&&(F.style.display="block",F.innerHTML='<span class="text-muted">Asking AI‚Ä¶</span>');try{const k=await Le.suggest(y,_?.value?.trim()||"");_&&(_.value=k.rationale||""),A&&(A.value=k.impact||"medium"),h&&(h.value=k.summary||""),F&&(F.style.display="none",F.innerHTML=""),u.success("Suggestion applied")}catch{F&&(F.innerHTML='<span class="error">AI suggest failed</span>'),u.error("AI suggest failed")}finally{O.disabled=!1}});const W=o.querySelector("#decision-timeline-list");W&&Le.getEvents(t.id).then(E=>{const _={created:"Created",updated:"Updated",conflict_detected:"Conflict detected",deleted:"Deleted",restored:"Restored"},A=h=>h.actor_name||(h.event_data?.trigger==="decision_check_flow"?"System":null);if(E.length===0){W.innerHTML='<span class="text-muted">No events yet</span>';return}W.innerHTML=E.map(h=>{const y=A(h);return`<div class="decision-timeline-item decision-event-${K(h.event_type)}">
            <span class="decision-event-type">${K(_[h.event_type]||h.event_type)}</span>
            ${y?`<span class="decision-event-actor">${K(y)}</span>`:""}
            <span class="decision-event-date">${J(h.created_at)}</span>
          </div>`}).join("")}).catch(()=>{W.innerHTML='<span class="text-muted">Could not load timeline</span>'});const z=o.querySelector("#decision-similar-list");return z&&Le.getSimilarDecisions(t.id,10).then(E=>{if(E.length===0){z.innerHTML='<span class="text-muted">No similar decisions</span>';return}z.innerHTML=E.map(_=>`
          <div class="decision-similar-item" data-decision-id="${_.decision.id}" role="${s?"button":"none"}">
            <span class="decision-similar-score">${Math.round(_.similarityScore*100)}%</span>
            <span class="decision-similar-content">${K((_.decision.content||"").substring(0,80))}${(_.decision.content||"").length>80?"‚Ä¶":""}</span>
          </div>
        `).join(""),s&&z.querySelectorAll(".decision-similar-item").forEach(_=>{d(_,"click",()=>{const A=E.find(h=>String(h.decision.id)===_.getAttribute("data-decision-id"));A&&s(A.decision)})})}).catch(()=>{z.innerHTML='<span class="text-muted">Could not load similar decisions</span>'}),o}const By=Object.freeze(Object.defineProperty({__proto__:null,createDecisionDetailView:er},Symbol.toStringTag,{value:"Module"}));function Jl(e,t,n){return{decision:n,onClose:()=>{e.innerHTML="",e.appendChild(Gs(t))},onUpdate:()=>{e.innerHTML="",e.appendChild(Gs(t))},onDecisionClick:a=>{e.innerHTML="",e.appendChild(er(Jl(e,t,a)))}}}let pi="all",bo="",Zl="status";function Gs(e={}){const t=x("div",{className:"sot-panel decisions-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Decisions</h2>
        <span class="panel-count" id="decisions-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="decisions-filter" class="filter-select">
          <option value="all">All</option>
          <option value="proposed">Proposed</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="deferred">Deferred</option>
          <option value="active">Active</option>
          <option value="superseded">Superseded</option>
          <option value="revoked">Revoked</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="status">By Status</button>
          <button class="view-tab" data-view="source">By Source</button>
        </div>
        <input type="search" id="decisions-search" class="search-input" placeholder="Search decisions..." title="Search">
        <button class="btn btn-secondary btn-sm" id="check-conflicts-btn" title="Check for conflicting decisions">Check Conflicts</button>
        <button class="btn btn-primary btn-sm" id="add-decision-btn">+ Add</button>
      </div>
    </div>
    <div id="conflicts-container" class="conflicts-container" style="display: none;"></div>
    <div class="panel-content" id="decisions-content">
      <div class="loading">Loading decisions...</div>
    </div>
    <div id="removed-decisions-container" class="removed-decisions-container" style="display: none;"></div>
  `;const n=t.querySelector("#decisions-filter");d(n,"change",()=>{pi=n.value,pt(t,e)});const a=t.querySelectorAll(".view-tab");a.forEach(c=>{d(c,"click",()=>{a.forEach(l=>l.classList.remove("active")),c.classList.add("active"),Zl=c.getAttribute("data-view"),pt(t,e)})});const s=t.querySelector("#decisions-search");let o;d(s,"input",()=>{clearTimeout(o),o=window.setTimeout(()=>{bo=s.value.trim(),pt(t,e)},300)});const i=t.querySelector("#check-conflicts-btn");i&&d(i,"click",async()=>{const c=t.querySelector("#conflicts-container");await Xl(c,t,e)});const r=t.querySelector("#add-decision-btn");return r&&d(r,"click",()=>{Ca({mode:"create",onSave:()=>{pt(t,e),Qs(t,e)}})}),pt(t,e),Qs(t,e),t}async function Xl(e,t,n){e.style.display="block",e.innerHTML='<div class="loading">Checking for conflicts...</div>';try{const s=(await Le.runDecisionCheck()).conflicts||[];if(s.length===0){e.innerHTML=`
        <div class="no-conflicts">
          <span class="success-icon">‚úì</span>
          <p>No conflicts detected</p>
        </div>
      `;return}e.innerHTML=s.map(o=>Iy(o,t,n)).join(""),Ry(e,t,n)}catch{e.innerHTML='<div class="error">Failed to check conflicts</div>'}}function Iy(e,t,n){const a=e.decision1,s=e.decision2,o=(e.description||e.reason||"Conflict").substring(0,200);return`
    <div class="conflict-card-sota" data-decision-id1="${a.id}" data-decision-id2="${s.id}">
      <div class="conflict-card-priority-bar" style="background: var(--warning);"></div>
      <div class="conflict-card-body">
        <div class="conflict-card-header">
          <span class="conflict-type-badge">Conflict</span>
          <p class="conflict-description">${Ve(o)}</p>
        </div>
        <div class="conflict-pair">
          <div class="conflict-item">
            <div class="conflict-item-content">${Ve((a.content||"").substring(0,120))}${(a.content||"").length>120?"‚Ä¶":""}</div>
            <button type="button" class="btn btn-sm conflict-keep-btn" data-keep-id="${a.id}" data-discard-id="${s.id}">Keep this</button>
          </div>
          <div class="conflict-vs">vs</div>
          <div class="conflict-item">
            <div class="conflict-item-content">${Ve((s.content||"").substring(0,120))}${(s.content||"").length>120?"‚Ä¶":""}</div>
            <button type="button" class="btn btn-sm conflict-keep-btn" data-keep-id="${s.id}" data-discard-id="${a.id}">Keep this</button>
          </div>
        </div>
      </div>
    </div>
  `}function Ry(e,t,n){e.querySelectorAll(".conflict-keep-btn").forEach(a=>{d(a,"click",async s=>{s.stopPropagation();const o=a.getAttribute("data-keep-id"),i=a.getAttribute("data-discard-id");if(!(!o||!i))try{await Le.delete(i),await Le.runDecisionCheck(),await Le.update(o,{status:"approved"}),u.success("Conflict resolved"),pt(t,n),await Xl(e,t,n),Qs(t,n)}catch{u.error("Failed to resolve conflict")}})})}async function Qs(e,t){const n=e.querySelector("#removed-decisions-container");if(n)try{const a=await Le.getDeletedDecisions();if(a.length===0){n.style.display="none",n.innerHTML="";return}n.style.display="block",n.innerHTML=`
      <div class="removed-decisions-section">
        <div class="removed-decisions-header section-header-sota">
          <h3>Removed decisions</h3>
          <span class="panel-count removed-count">${a.length}</span>
        </div>
        <p class="removed-decisions-hint">Restore to undo a conflict resolution; decision will be synced back to the graph.</p>
        <div class="removed-decisions-list">
          ${a.map(s=>`
            <div class="removed-decision-item" data-decision-id="${s.id}">
              <div class="removed-decision-content">${Ve(Ny(s.content??"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(s=>{d(s,"click",async()=>{const o=s.closest(".removed-decision-item")?.getAttribute("data-decision-id");if(o)try{await Le.restore(o),u.success("Decision restored"),pt(e,t),Qs(e,t)}catch{u.error("Failed to restore decision")}})})}catch{n.style.display="none",n.innerHTML=""}}function Ny(e,t){return e.length<=t?e:e.substring(0,t)+"‚Ä¶"}function Fy(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(a=>(a.content||"").toLowerCase().includes(n)||(a.rationale||"").toLowerCase().includes(n)||(a.made_by||"").toLowerCase().includes(n)||(a.source_file||"").toLowerCase().includes(n))}async function pt(e,t){const n=e.querySelector("#decisions-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=pi==="all"?void 0:pi,s=await Le.getAll(a),o=Fy(s,bo);Zl==="source"?Uy(n,o,t):Oy(n,o,t),B.setDecisions(s),Qy(e,o.length)}catch{n.innerHTML='<div class="error">Failed to load decisions</div>'}}function Oy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${bo?"No decisions match your search":"No decisions found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Decision</button>
      </div>
    `;const i=e.querySelector("#empty-add-btn");i&&d(i,"click",()=>{Ca({mode:"create",onSave:()=>pt(e.closest(".decisions-panel"),n)})});return}const a=B.getState().contacts||[],s={};t.forEach(i=>{const r=(i.status||"active").toLowerCase();s[r]||(s[r]=[]),s[r].push(i)});const o=Object.keys(s);o.length>1?e.innerHTML=o.map(i=>`
      <div class="question-group">
        <div class="group-header">
          <h3>${Ve(i)}</h3>
          <span class="group-count">${s[i].length}</span>
        </div>
        <div class="group-items">
          ${s[i].map(r=>ui(r,a)).join("")}
        </div>
      </div>
    `).join(""):e.innerHTML=t.map(i=>ui(i,a)).join(""),ed(e,t,n)}function Uy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${bo?"No decisions match your search":"No decisions found"}</p>
        <button class="btn btn-primary" id="empty-add-btn">Add Decision</button>
      </div>
    `;const o=e.querySelector("#empty-add-btn");o&&d(o,"click",()=>{Ca({mode:"create",onSave:()=>pt(e.closest(".decisions-panel"),n)})});return}const a=B.getState().contacts||[],s={};t.forEach(o=>{const i=o.source_file||o.source||"Unknown source";s[i]||(s[i]=[]),s[i].push(o)}),e.innerHTML=Object.entries(s).map(([o,i])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${Ve(o)}</h3>
        <span class="group-count">${i.length}</span>
      </div>
      <div class="group-items">
        ${i.map(r=>ui(r,a)).join("")}
      </div>
    </div>
  `).join(""),ed(e,t,n)}function ed(e,t,n){e.querySelectorAll(".decision-card-sota").forEach(a=>{d(a,"click",r=>{if(r.target.closest(".card-actions"))return;const c=a.getAttribute("data-id"),l=t.find(m=>String(m.id)===c);if(l)if(n.useDetailView&&n.containerElement){const m=n.containerElement;m.innerHTML="",m.appendChild(er(Jl(m,n,l)))}else n.onDecisionClick?n.onDecisionClick(l):Ca({mode:"edit",decision:{...l,decision:l.content,madeBy:l.made_by,madeAt:l.created_at},onSave:()=>pt(e.closest(".decisions-panel"),n)})});const s=a.querySelector(".approve-btn"),o=a.querySelector(".reject-btn"),i=a.getAttribute("data-id");s&&i&&d(s,"click",async r=>{r.stopPropagation();try{await Le.approve(i,"Current User"),pt(e.closest(".decisions-panel"),n)}catch{}}),o&&i&&d(o,"click",async r=>{r.stopPropagation();try{await Le.reject(i),pt(e.closest(".decisions-panel"),n)}catch{}})})}const nc={proposed:"#f59e0b",approved:"#10b981",rejected:"#ef4444",deferred:"#6b7280",active:"#3b82f6",superseded:"#8b5cf6",revoked:"#6b7280"};function Vy(e,t){if(!t||!e.length)return;const n=t.trim().toLowerCase();if(!n)return;const a=e.find(i=>(i.name||"").trim().toLowerCase()===n);if(a)return a;const s=e.find(i=>(i.name||"").trim().toLowerCase().includes(n)||n.includes((i.name||"").trim().toLowerCase()));return s||e.find(i=>(i.aliases||[]).some(r=>String(r).trim().toLowerCase()===n))||e.find(i=>(i.aliases||[]).some(r=>{const c=String(r).trim().toLowerCase();return c.includes(n)||n.includes(c)}))}function Gy(e){return e&&(e.photoUrl||e.avatarUrl||e.photo_url||e.avatar_url)||null}function ac(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function ui(e,t){const n=(e.status||"active").toLowerCase(),a=n.replace(/\s+/g,"-"),s=nc[n]??nc.active,o=e.content||"",i=e.source_file||e.source||"",r=e.made_by||e.owner||"",c=r?Vy(t,r):void 0,l=Gy(c),m=r?`
        <div class="assignee-chip">
          <div class="assignee-avatar">${l?`<img src="${Ve(l)}" alt="${Ve(r)}" onerror="this.parentElement.innerHTML='${ac(r)}'">`:ac(r)}</div>
          <div class="assignee-info">
            <span class="assignee-name">${Ve(r)}</span>
            ${c?.role?`<span class="assignee-role">${Ve(c.role)}</span>`:""}
          </div>
        </div>
      `:'<span class="card-owner-placeholder text-muted">No owner</span>',v=i?`<span class="card-source-chip">${Ve(i.substring(0,40))}${i.length>40?"‚Ä¶":""}</span>`:'<span class="card-source-chip text-muted">No source</span>';return`
    <div class="decision-card-sota question-card-sota" data-id="${e.id}" style="--decision-status-bar: ${s}">
      <div class="card-priority-bar decision-status-bar" style="background: ${s}"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="priority-pill status-${a}">${Ve(String(e.status))}</span>
            ${e.impact?`<span class="status-pill">${Ve(e.impact)} impact</span>`:""}
          </div>
          <span class="card-timestamp">${J(e.decided_at||e.created_at)}</span>
        </div>
        <div class="card-question-text">${Ve(o)}</div>
        ${e.summary?`<div class="card-summary text-muted">${Ve(e.summary)}</div>`:""}
        ${e.rationale?`<div class="card-rationale text-muted">${Ve((e.rationale||"").substring(0,100))}${(e.rationale||"").length>100?"‚Ä¶":""}</div>`:""}
        <div class="card-bottom-row">
          <div class="card-requester">
            ${v}
            ${m}
          </div>
          <div class="card-assignment">
            ${e.status==="proposed"||e.status==="active"?'<span class="card-actions"><button type="button" class="btn btn-sm btn-success approve-btn">Approve</button><button type="button" class="btn btn-sm btn-danger reject-btn">Reject</button></span>':'<button type="button" class="btn-link decision-view-link">View</button>'}
          </div>
        </div>
      </div>
    </div>
  `}function Qy(e,t){const n=e.querySelector("#decisions-count");n&&(n.textContent=String(t))}function Ve(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Wt(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function jo(e){if(!e)return"‚Äî";try{return Tn(e)}catch{return e}}function yo(e){const{fact:t,onClose:n,onUpdate:a,onFactClick:s}=e,o=x("div",{className:"fact-detail-view question-detail-view"});o.innerHTML=`
    <div class="question-detail-header fact-detail-header">
      <div class="breadcrumb">
        <a href="#" class="breadcrumb-link" id="back-to-list">Facts</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Fact #${String(t.id).substring(0,8)}</span>
      </div>
      <div class="header-actions">
        ${t.verified?'<span class="verified-badge detail sla-badge" style="background:var(--success);color:white">‚úì Verified</span>':""}
        <button class="btn btn-icon" id="close-detail" title="Close">√ó</button>
      </div>
    </div>

    <div class="question-detail-content fact-detail-content">
      <section class="detail-section question-main fact-main">
        <div class="question-badges fact-badges">
          ${t.category?`<span class="priority-pill category-${(t.category||"general").toLowerCase().replace(/\s+/g,"-")}">${Wt(t.category)}</span>`:""}
          ${t.confidence!=null?`<span class="status-pill status-pending">${Math.round((t.confidence??0)*100)}%</span>`:""}
          ${t.verified?'<span class="auto-pill">‚úì Verified</span>':""}
          <span class="question-date fact-date">Created ${J(t.created_at)}</span>
        </div>
        <h2 class="question-text fact-content-text">${Wt(t.content)}</h2>
      </section>

      <div class="detail-columns">
        <div class="detail-column-left">
          <section class="detail-section">
            <div class="section-header">
              <h3>Source</h3>
            </div>
            ${t.source_file?`<p class="source-file">${Wt(t.source_file)}</p>`:""}
            ${t.source?`<p class="source-ref">${Wt(t.source)}</p>`:""}
            ${t.source_document_id?`
              <p class="source-doc">
                <a href="#" class="doc-link" data-document-id="${Wt(String(t.source_document_id))}">View source document</a>
              </p>
            `:""}
            ${!t.source&&!t.source_file&&!t.source_document_id?'<p class="text-muted">No source recorded</p>':""}
          </section>

          <section class="detail-section verification-section">
            <div class="section-header">
              <h3>Verification</h3>
            </div>
            ${t.verified?`
              <div class="verified-info">
                <span class="verified-badge auto-pill">‚úì Verified</span>
                ${t.verified_at?`<span class="text-muted">on ${jo(t.verified_at)}</span>`:""}
              </div>
            `:`
              <div class="unverified-info">
                <p class="text-muted">This fact has not been verified.</p>
                <button type="button" class="btn btn-success btn-sm" id="verify-fact-btn">Verify</button>
              </div>
            `}
          </section>
        </div>

        <div class="detail-column-right">
          <section class="detail-section metadata-section">
            <div class="section-header">
              <h3>Metadata</h3>
            </div>
            <dl class="metadata-list">
              <dt>Created</dt>
              <dd>${jo(t.created_at)}</dd>
              ${t.updated_at?`<dt>Updated</dt><dd>${jo(t.updated_at)}</dd>`:""}
            </dl>
          </section>

          <section class="detail-section fact-timeline-section">
            <div class="section-header">
              <h3>Timeline</h3>
            </div>
            <div id="fact-timeline-list" class="fact-timeline-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>

          <section class="detail-section fact-similar-section">
            <div class="section-header">
              <h3>Similar facts</h3>
            </div>
            <div id="fact-similar-list" class="fact-similar-list">
              <span class="text-muted">Loading‚Ä¶</span>
            </div>
          </section>
        </div>
      </div>

      <div class="detail-actions">
        <button type="button" class="btn btn-secondary" id="edit-fact-btn">Edit</button>
        ${t.verified?"":'<button type="button" class="btn btn-success" id="verify-btn">Verify</button>'}
        <button type="button" class="btn btn-danger" id="delete-fact-btn">Delete</button>
      </div>
    </div>
  `;const i=o.querySelector("#back-to-list");i&&d(i,"click",w=>{w.preventDefault(),n()});const r=o.querySelector("#close-detail");r&&d(r,"click",n);const c=o.querySelector("#verify-fact-btn");c&&d(c,"click",async()=>{try{const w=await Ee.verify(t.id);u.success("Fact verified"),a&&a(w),n()}catch{u.error("Failed to verify fact")}});const l=o.querySelector("#verify-btn");l&&d(l,"click",async()=>{try{const w=await Ee.verify(t.id);u.success("Fact verified"),a&&a(w),n()}catch{u.error("Failed to verify fact")}});const m=o.querySelector("#edit-fact-btn");m&&d(m,"click",()=>{Y(async()=>{const{showFactModal:w}=await Promise.resolve().then(()=>So);return{showFactModal:w}},void 0).then(({showFactModal:w})=>{w({mode:"edit",fact:t,onSave:$=>{a&&a($),n()}})})});const v=o.querySelector("#delete-fact-btn");v&&d(v,"click",async()=>{if(confirm("Are you sure you want to delete this fact?"))try{await Ee.delete(t.id),u.success("Fact deleted"),n()}catch{u.error("Failed to delete fact")}});const g=o.querySelector(".doc-link");g&&t.source_document_id&&d(g,"click",w=>{w.preventDefault(),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{tab:"files",documentId:t.source_document_id}}))});const f=o.querySelector("#fact-timeline-list");f&&Ee.getEvents(t.id).then(w=>{const $={created:"Created",verified:"Verified",updated:"Updated",conflict_detected:"Conflict detected",deleted:"Deleted",restored:"Restored"},M=q=>q.actor_name||(q.event_data?.trigger==="fact_check_flow"?"System":null);if(w.length===0){f.innerHTML='<span class="text-muted">No events yet</span>';return}f.innerHTML=w.map(q=>{const C=M(q);return`<div class="fact-timeline-item fact-event-${Wt(q.event_type)}">
              <span class="fact-event-type">${Wt($[q.event_type]||q.event_type)}</span>
              ${C?`<span class="fact-event-actor">${Wt(C)}</span>`:""}
              <span class="fact-event-date">${J(q.created_at)}</span>
            </div>`}).join("")}).catch(()=>{f.innerHTML='<span class="text-muted">Could not load timeline</span>'});const b=o.querySelector("#fact-similar-list");return b&&Ee.getSimilarFacts(t.id,10).then(w=>{if(w.length===0){b.innerHTML='<span class="text-muted">No similar facts</span>';return}b.innerHTML=w.map($=>`
            <div class="fact-similar-item" data-fact-id="${$.fact.id}" role="${s?"button":"none"}">
              <span class="fact-similar-score">${Math.round($.similarityScore*100)}%</span>
              <span class="fact-similar-content">${Wt(($.fact.content||"").substring(0,80))}${($.fact.content||"").length>80?"‚Ä¶":""}</span>
            </div>
          `).join(""),s&&b.querySelectorAll(".fact-similar-item").forEach($=>{d($,"click",()=>{const M=w.find(q=>String(q.fact.id)===$.getAttribute("data-fact-id"));M&&s(M.fact)})})}).catch(()=>{b.innerHTML='<span class="text-muted">Could not load similar facts</span>'}),o}const Ky=Object.freeze(Object.defineProperty({__proto__:null,createFactDetailView:yo},Symbol.toStringTag,{value:"Module"})),Wy=["technical","process","policy","people","timeline","general"];function td(e,t,n){return{fact:n,onClose:()=>{e.innerHTML="",e.appendChild(wa(t))},onUpdate:()=>{e.innerHTML="",e.appendChild(wa(t))},onFactClick:a=>{e.innerHTML="",e.appendChild(yo(td(e,t,a)))}}}let xo="",Oa="all",nd="category";function wa(e={}){const t=x("div",{className:"sot-panel facts-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Facts</h2>
        <span class="panel-count" id="facts-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="facts-filter" class="filter-select">
          <option value="all">All</option>
          <option value="verified">‚úì Verified</option>
          <option value="unverified">Unverified</option>
          <option value="technical">Technical</option>
          <option value="process">Process</option>
          <option value="policy">Policy</option>
          <option value="people">People</option>
          <option value="timeline">Timeline</option>
          <option value="general">General</option>
        </select>
        <div class="view-tabs">
          <button class="view-tab active" data-view="category">By Category</button>
          <button class="view-tab" data-view="source">By Source</button>
        </div>
        <input type="search" id="facts-search" class="search-input" placeholder="Search facts..." title="Search">
        <button class="btn btn-secondary btn-sm" id="check-conflicts-btn" title="Check for conflicting facts">Check Conflicts</button>
        <button class="btn btn-primary btn-sm" id="add-fact-btn">+ Add</button>
      </div>
    </div>
    <div id="conflicts-container" class="conflicts-container" style="display: none;"></div>
    <div class="panel-content" id="facts-content">
      <div class="loading">Loading facts...</div>
    </div>
    <div id="removed-facts-container" class="removed-facts-container" style="display: none;"></div>
  `;const n=t.querySelector("#facts-filter");n&&d(n,"change",()=>{Oa=n.value,sn(t,e)});const a=t.querySelectorAll(".view-tab");a.forEach(c=>{d(c,"click",()=>{a.forEach(l=>l.classList.remove("active")),c.classList.add("active"),nd=c.getAttribute("data-view"),sn(t,e)})});const s=t.querySelector("#facts-search");let o;d(s,"input",()=>{clearTimeout(o),o=window.setTimeout(()=>{xo=s.value,sn(t,e)},300)});const i=t.querySelector("#check-conflicts-btn");i&&d(i,"click",async()=>{const c=t.querySelector("#conflicts-container");await nr(c,t,e)});const r=t.querySelector("#add-fact-btn");return r&&d(r,"click",()=>{ar(t,e)}),sn(t,e),t}async function sn(e,t){const n=e.querySelector("#facts-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=Wy.includes(Oa)?Oa:void 0,{facts:s,total:o}=await Ee.getAll({search:xo||void 0,limit:500,category:a}),i=Oa==="verified"?s.filter(r=>r.verified):Oa==="unverified"?s.filter(r=>!r.verified):s;nd==="source"?Jy(n,i,t):Yy(n,i,t),Xy(e,i.length)}catch{n.innerHTML='<div class="error">Failed to load facts</div>'}await tr(e,t)}async function tr(e,t){const n=e.querySelector("#removed-facts-container");if(n)try{const a=await Ee.getDeletedFacts();if(a.length===0){n.style.display="none",n.innerHTML="";return}n.style.display="block",n.innerHTML=`
      <div class="removed-facts-section">
        <div class="removed-facts-header section-header-sota">
          <h3>Removed facts</h3>
          <span class="panel-count removed-count">${a.length}</span>
        </div>
        <p class="removed-facts-hint">Restore to undo a conflict resolution; fact will be synced back to the graph.</p>
        <div class="removed-facts-list">
          ${a.map(s=>`
            <div class="removed-fact-item" data-fact-id="${s.id}">
              <div class="removed-fact-content">${Ot(Ks(s.content??"",100))}</div>
              <button type="button" class="btn btn-sm conflict-resolve-restore">Restore</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".conflict-resolve-restore").forEach(s=>{const i=s.closest(".removed-fact-item")?.getAttribute("data-fact-id");i&&d(s,"click",async()=>{try{await Ee.restoreFact(i),u.success("Fact restored"),await sn(e,t),tr(e,t);const r=e.querySelector("#conflicts-container");r?.style.display!=="none"&&await nr(r,e,t)}catch{u.error("Failed to restore fact")}})})}catch{n.style.display="none",n.innerHTML=""}}function Yy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${xo?"No facts match your search":"No facts found"}</p>
        <button class="btn btn-primary" id="empty-add-fact-btn">Add Fact</button>
      </div>
    `;const o=e.querySelector("#empty-add-fact-btn");o&&d(o,"click",()=>{const i=e.closest(".facts-panel");i&&ar(i,n)});return}const a={};t.forEach(o=>{const i=o.category||"Uncategorized";a[i]||(a[i]=[]),a[i].push(o)}),Object.keys(a).length>1?e.innerHTML=Object.entries(a).map(([o,i])=>`
      <div class="question-group">
        <div class="group-header">
          <h3>${Ot(o)}</h3>
          <span class="group-count">${i.length}</span>
        </div>
        <div class="group-items">
          ${i.map(r=>mi(r)).join("")}
        </div>
      </div>
    `).join(""):e.innerHTML=t.map(o=>mi(o)).join(""),e.querySelectorAll(".fact-card-sota").forEach(o=>{d(o,"click",()=>{const r=o.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);if(c)if(n.useDetailView&&n.containerElement){const l=n.containerElement;l.innerHTML="",l.appendChild(yo(td(l,n,c)))}else n.onFactClick?n.onFactClick(c):Y(async()=>{const{showFactModal:l}=await Promise.resolve().then(()=>So);return{showFactModal:l}},void 0).then(({showFactModal:l})=>{l({mode:"view",fact:c})})});const i=o.querySelector(".fact-verify-btn");i&&d(i,"click",async r=>{r.stopPropagation();const c=o.getAttribute("data-id");if(c)try{await Ee.verify(c),u.success("Fact verified"),sn(e.closest(".facts-panel"),n)}catch{}})})}function Jy(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>${xo?"No facts match your search":"No facts found"}</p>
        <button class="btn btn-primary" id="empty-add-fact-btn">Add Fact</button>
      </div>
    `;const s=e.querySelector("#empty-add-fact-btn");s&&d(s,"click",()=>{const o=e.closest(".facts-panel");o&&ar(o,n)});return}const a={};t.forEach(s=>{const o=s.source_file||s.source||"Unknown source";a[o]||(a[o]=[]),a[o].push(s)}),e.innerHTML=Object.entries(a).map(([s,o])=>`
    <div class="question-group">
      <div class="group-header">
        <h3>${Ot(s)}</h3>
        <span class="group-count">${o.length}</span>
      </div>
      <div class="group-items">
        ${o.map(i=>mi(i)).join("")}
      </div>
    </div>
  `).join(""),e.querySelectorAll(".fact-card-sota").forEach(s=>{d(s,"click",()=>{const i=s.getAttribute("data-id"),r=t.find(c=>String(c.id)===i);if(r)if(n.useDetailView&&n.containerElement){const c=n.containerElement,l=yo({fact:r,onClose:()=>{c.innerHTML="";const m=wa(n);c.appendChild(m)},onUpdate:()=>{c.innerHTML="";const m=wa(n);c.appendChild(m)}});c.innerHTML="",c.appendChild(l)}else n.onFactClick?n.onFactClick(r):Y(async()=>{const{showFactModal:c}=await Promise.resolve().then(()=>So);return{showFactModal:c}},void 0).then(({showFactModal:c})=>{c({mode:"view",fact:r})})});const o=s.querySelector(".fact-verify-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=s.getAttribute("data-id");if(r)try{await Ee.verify(r),u.success("Fact verified"),sn(e.closest(".facts-panel"),n)}catch{}})})}const sc={technical:"#3b82f6",process:"#8b5cf6",policy:"#ec4899",people:"#10b981",timeline:"#f59e0b",general:"#6b7280"};function mi(e){const t=(e.category||"general").toLowerCase(),n=t.replace(/\s+/g,"-"),a=sc[t]||sc.general,s=e.confidence!=null?Math.round(e.confidence*100):null;return`
    <div class="fact-card-sota question-card-sota ${e.verified?"has-answer":""}" data-id="${e.id}" style="--fact-category-bar: ${a}">
      <div class="card-priority-bar fact-category-bar" style="background: ${a}"></div>
      <div class="card-body">
        <div class="card-top-row">
          <div class="card-badges">
            <span class="priority-pill fact-category-pill category-${n}">${Ot(e.category||"general")}</span>
            ${s!=null?`<span class="status-pill status-pending">${s}%</span>`:""}
            ${e.verified?'<span class="auto-pill">‚úì Verified</span>':""}
          </div>
          <span class="card-timestamp">${J(e.created_at)}</span>
        </div>
        <div class="card-question-text">${Ot(e.content)}</div>
        <div class="card-bottom-row">
          <div class="card-requester">
            ${e.source_file||e.source?`<span class="card-source-chip">${Ot((e.source_file||e.source||"").substring(0,40))}${(e.source_file||e.source||"").length>40?"‚Ä¶":""}</span>`:'<span class="card-source-chip text-muted">No source</span>'}
          </div>
          <div class="card-assignment">
            ${e.verified?'<span class="answered-badge">Verified</span>':'<button type="button" class="btn-link fact-verify-btn">Verify</button>'}
          </div>
        </div>
      </div>
    </div>
  `}async function nr(e,t,n){e.style.display="block",e.innerHTML='<div class="loading">Checking for conflicts...</div>';try{const a=await Ee.detectConflicts();a.length===0?(e.innerHTML=`
        <div class="no-conflicts">
          <span class="success-icon">‚úì</span>
          <p>No conflicts detected</p>
        </div>
      `,setTimeout(()=>{e.style.display="none"},3e3)):ad(e,a,t,n)}catch{e.innerHTML='<div class="error">Failed to check conflicts</div>'}}function ad(e,t,n,a){e.innerHTML=`
    <div class="conflicts-section">
      <div class="conflicts-header section-header-sota">
        <h3>Conflicts Detected</h3>
        <span class="conflicts-count panel-count">${t.length}</span>
        <button type="button" class="btn-icon close-conflicts" title="Close">√ó</button>
      </div>
      <div class="conflicts-list question-group">
        ${t.map((o,i)=>Zy(o,i)).join("")}
      </div>
    </div>
  `;const s=e.querySelector(".close-conflicts");s&&d(s,"click",()=>{e.style.display="none"}),t.forEach((o,i)=>{const r=e.querySelector(`[data-conflict-index="${i}"]`);if(!r)return;const c=r.querySelector(".conflict-resolve-keep-left"),l=r.querySelector(".conflict-resolve-keep-right");c&&d(c,"click",m=>{m.stopPropagation(),oc(o,"left",n,a,e)}),l&&d(l,"click",m=>{m.stopPropagation(),oc(o,"right",n,a,e)})})}async function oc(e,t,n,a,s){const o=t==="left"?e.fact2:e.fact1,i=t==="left"?e.fact1:e.fact2;if(o?.id)try{await Ee.deleteFact(o.id),u.success(`Removed conflicting fact; kept: "${Ks(i?.content??"",50)}"`),await sn(n,a);try{await Ee.runFactCheck()}catch{}if(i?.id)try{await Ee.verifyFact(i.id)}catch{}await nr(s,n,a);const r=await Ee.detectConflicts();r.length===0?(s.style.display="none",s.innerHTML=""):ad(s,r,n,a),tr(n,a)}catch{u.error("Failed to resolve conflict")}}function Zy(e,t){const n=(e.conflictType||"contradiction").toLowerCase(),a=e.description||e.reason||"Conflict detected";return`
    <div class="conflict-card-sota" data-conflict-index="${t}">
      <div class="conflict-type-bar ${n==="contradiction"?"conflict-bar-contradiction":n==="inconsistency"?"conflict-bar-inconsistency":"conflict-bar-process"}"></div>
      <div class="conflict-card-body">
        <div class="conflict-card-top">
          <span class="conflict-type-pill conflict-type-${n}">${Ot(n)}</span>
          ${e.confidence!=null?`<span class="conflict-confidence-pill">${Math.round(e.confidence*100)}%</span>`:""}
        </div>
        <div class="conflict-facts-row">
          <div class="conflict-fact-cell">
            <div class="conflict-fact-snippet">${Ot(Ks(e.fact1?.content??"",120))}</div>
            <button type="button" class="btn btn-sm conflict-resolve-keep-left">Keep this</button>
          </div>
          <span class="conflict-vs">vs</span>
          <div class="conflict-fact-cell">
            <div class="conflict-fact-snippet">${Ot(Ks(e.fact2?.content??"",120))}</div>
            <button type="button" class="btn btn-sm conflict-resolve-keep-right">Keep this</button>
          </div>
        </div>
        <div class="conflict-description-row">
          <div class="conflict-description">${Ot(a)}</div>
        </div>
      </div>
    </div>
  `}function Ks(e,t){return e.length<=t?e:e.slice(0,t).trim()+"‚Ä¶"}async function ar(e,t){const{showFactModal:n}=await Y(async()=>{const{showFactModal:a}=await Promise.resolve().then(()=>So);return{showFactModal:a}},void 0);n({mode:"create",onSave:()=>sn(e,t)})}function Xy(e,t){const n=e.querySelector("#facts-count");n&&(n.textContent=String(t))}function Ot(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function sd(e){const t=x("div",{className:`stats-card ${e.onClick?"clickable":""} ${e.color?`color-${e.color}`:""}`});t.setAttribute("data-stat-id",e.id);const n=e.trend?`
    <div class="stat-trend ${e.trend.direction} ${e.trend.sentiment}">
      <span class="trend-arrow">${e0(e.trend.direction)}</span>
      <span class="trend-value">${e.trend.value}%</span>
    </div>
  `:"";return t.innerHTML=`
    ${e.icon?`<div class="stat-icon">${e.icon}</div>`:""}
    <div class="stat-value">${typeof e.value=="number"?Ja(e.value):e.value}</div>
    <div class="stat-label">${e.label}</div>
    ${e.subValue?`<div class="stat-sub">${e.subValue}</div>`:""}
    ${n}
  `,e.onClick&&d(t,"click",e.onClick),t}function e0(e){switch(e){case"up":return"‚Üë";case"down":return"‚Üì";case"stable":return"‚Üí"}}function t0(e,t,n){const a=e.querySelector(".stat-value"),s=e.querySelector(".stat-sub");a&&(a.textContent=typeof t=="number"?Ja(t):t),s&&n!==void 0&&(s.textContent=n)}function n0(e){const t=x("div",{className:"stats-grid"});return e.forEach(n=>{const a=sd(n);t.appendChild(a)}),t}function a0(e){const{health:t,showFactors:n=!0,size:a="md"}=e,s=t.status.toLowerCase().replace(/\s+/g,"-"),o=x("div",{className:`health-indicator ${s} size-${a}`});return o.innerHTML=`
    <div class="health-gauge">
      <svg class="gauge-svg" viewBox="0 0 100 50">
        <path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50" />
        <path class="gauge-fill" d="M 10 50 A 40 40 0 0 1 90 50" 
              style="stroke-dasharray: ${t.score/100*126} 126; stroke: ${t.color};" />
      </svg>
      <div class="gauge-center">
        <span class="score-value">${t.score}</span>
        <span class="score-label">Health</span>
      </div>
    </div>
    <div class="health-status" style="color: ${t.color}">${t.status}</div>
    ${n&&t.factors.length>0?`
      <div class="health-factors">
        ${t.factors.slice(0,4).map(i=>`
          <div class="factor ${i.type}">
            <span class="factor-icon">${i.type==="positive"?"‚úì":"!"}</span>
            <span class="factor-text">${i.factor}</span>
          </div>
        `).join("")}
      </div>
    `:""}
  `,o}function s0(e,t,n){const a=x("div",{className:"health-badge"});return a.innerHTML=`
    <span class="badge-score" style="background: ${n}">${e}</span>
    <span class="badge-status">${t}</span>
  `,a}function o0(e){return e>=80?"#22c55e":e>=60?"#84cc16":e>=40?"#eab308":e>=20?"#f97316":"#ef4444"}function i0(e){return e>=80?"Healthy":e>=60?"Good":e>=40?"Needs Attention":e>=20?"At Risk":"Critical"}const Ws={facts:{line:"#6366f1",fill:"rgba(99, 102, 241, 0.1)"},questions:{line:"#f59e0b",fill:"rgba(245, 158, 11, 0.1)"},risks:{line:"#ef4444",fill:"rgba(239, 68, 68, 0.1)"},actions:{line:"#22c55e",fill:"rgba(34, 197, 94, 0.1)"},decisions:{line:"#8b5cf6",fill:"rgba(139, 92, 246, 0.1)"}};function r0(e){const{data:t,metrics:n=["facts","questions","risks"],height:a=200}=e,s=x("div",{className:"trend-chart-container"});if(s.style.height=`${a}px`,t.length===0)return s.innerHTML='<div class="empty-chart">No trend data available</div>',s;const o=x("canvas",{id:`trend-chart-${Date.now()}`});return s.appendChild(o),c0(o,t,n),s}function c0(e,t,n){if(typeof window.Chart>"u"){console.warn("Chart.js not loaded, using fallback"),l0(e.parentElement,t,n);return}const a=window.Chart,s=t.map(i=>od(i.date)),o=n.map(i=>({label:gi(i),data:t.map(r=>r[i]||0),borderColor:Ws[i]?.line||"#6366f1",backgroundColor:Ws[i]?.fill||"rgba(99, 102, 241, 0.1)",fill:!0,tension:.3}));new a(e,{type:"line",data:{labels:s,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}},scales:{y:{beginAtZero:!0}}}})}function l0(e,t,n){const a=Math.max(...t.flatMap(s=>n.map(o=>s[o]||0)));e.innerHTML=`
    <div class="fallback-chart">
      <div class="chart-legend">
        ${n.map(s=>`
          <span class="legend-item">
            <span class="legend-color" style="background: ${Ws[s]?.line||"#6366f1"}"></span>
            ${gi(s)}
          </span>
        `).join("")}
      </div>
      <div class="chart-bars">
        ${t.slice(-7).map(s=>`
          <div class="bar-group">
            ${n.map(o=>{const i=s[o]||0;return`<div class="bar" style="height: ${a>0?i/a*100:0}%; background: ${Ws[o]?.line||"#6366f1"}" title="${gi(o)}: ${i}"></div>`}).join("")}
            <div class="bar-label">${od(s.date)}</div>
          </div>
        `).join("")}
      </div>
    </div>
  `}function od(e){return new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric"})}function gi(e){return e.charAt(0).toUpperCase()+e.slice(1)}const d0=["critical","high","medium","low"],ic=["high","medium","low"],p0={"critical-high":"#dc2626","critical-medium":"#ef4444","critical-low":"#f87171","high-high":"#ef4444","high-medium":"#f97316","high-low":"#fb923c","medium-high":"#f97316","medium-medium":"#eab308","medium-low":"#facc15","low-high":"#eab308","low-medium":"#84cc16","low-low":"#22c55e"};function u0(e){const{risks:t,onCellClick:n,size:a="md"}=e,s=x("div",{className:`risk-matrix size-${a}`}),o=m0(t);return s.innerHTML=`
    <div class="matrix-container">
      <div class="matrix-y-label">Impact</div>
      <div class="matrix-grid">
        <div class="matrix-header">
          <div class="matrix-corner"></div>
          ${ic.map(i=>`<div class="matrix-col-header">${vi(i)}</div>`).join("")}
        </div>
        ${d0.map(i=>`
          <div class="matrix-row">
            <div class="matrix-row-header">${vi(i)}</div>
            ${ic.map(r=>{const c=`${i}-${r}`,l=o[c]||[],m=p0[c]||"#e5e7eb",v=l.length;return`
                <div class="matrix-cell ${v>0?"has-risks":""}" 
                     data-impact="${i}" 
                     data-likelihood="${r}"
                     style="background-color: ${v>0?m:"var(--color-surface-hover)"}">
                  ${v>0?`<span class="cell-count">${v}</span>`:""}
                </div>
              `}).join("")}
          </div>
        `).join("")}
      </div>
      <div class="matrix-x-label">Likelihood</div>
    </div>
    <div class="matrix-legend">
      <span class="legend-item"><span class="legend-color" style="background: #22c55e"></span> Low</span>
      <span class="legend-item"><span class="legend-color" style="background: #eab308"></span> Medium</span>
      <span class="legend-item"><span class="legend-color" style="background: #f97316"></span> High</span>
      <span class="legend-item"><span class="legend-color" style="background: #ef4444"></span> Critical</span>
    </div>
  `,n&&s.querySelectorAll(".matrix-cell.has-risks").forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-impact")||"",c=i.getAttribute("data-likelihood")||"",l=`${r}-${c}`,m=o[l]||[];n(m,r,c)})}),s}function m0(e){const t={};return e.filter(n=>n.status!=="mitigated"&&n.status!=="closed").forEach(n=>{const a=`${n.impact}-${n.likelihood}`;t[a]||(t[a]=[]),t[a].push(n)}),t}function vi(e){return e.charAt(0).toUpperCase()+e.slice(1)}function g0(e){const t=x("div",{className:"risk-summary"}),n={critical:e.filter(a=>a.impact==="critical"&&a.status==="open").length,high:e.filter(a=>a.impact==="high"&&a.status==="open").length,medium:e.filter(a=>a.impact==="medium"&&a.status==="open").length,low:e.filter(a=>a.impact==="low"&&a.status==="open").length};return t.innerHTML=`
    <div class="summary-bars">
      ${Object.entries(n).map(([a,s])=>`
        <div class="summary-bar">
          <span class="bar-label">${vi(a)}</span>
          <div class="bar-track">
            <div class="bar-fill impact-${a}" style="width: ${Math.min(s*20,100)}%"></div>
          </div>
          <span class="bar-count">${s}</span>
        </div>
      `).join("")}
    </div>
  `,t}let Ut=[];function v0(e={}){const{allowedTypes:t,maxFileSize:n=50*1024*1024,multiple:a=!0}=e,s=x("div",{className:"file-uploader"});s.innerHTML=`
    <div class="dropzone" id="dropzone">
      <div class="dropzone-content">
        <div class="dropzone-icon">üì§</div>
        <div class="dropzone-text">
          <p>Drag & drop files here</p>
          <p class="dropzone-subtext">or click to browse</p>
        </div>
        <input type="file" id="file-input" ${a?"multiple":""} 
               ${t?`accept="${t.join(",")}"`:""} hidden>
      </div>
    </div>
    <div class="file-queue" id="file-queue" style="display: none;"></div>
    <div class="upload-actions" id="upload-actions" style="display: none;">
      <button class="btn btn-secondary" id="clear-queue-btn">Clear</button>
      <button class="btn btn-primary" id="upload-btn">Upload Files</button>
    </div>
    <div class="processing-status" id="processing-status" style="display: none;"></div>
  `;const o=s.querySelector("#dropzone"),i=s.querySelector("#file-input"),r=s.querySelector("#file-queue"),c=s.querySelector("#upload-actions"),l=s.querySelector("#processing-status");d(o,"click",()=>i.click()),d(i,"change",()=>{i.files&&(rc(Array.from(i.files),n),nn(r,c)),i.value=""}),d(o,"dragover",g=>{g.preventDefault(),o.classList.add("dragover")}),d(o,"dragleave",()=>{o.classList.remove("dragover")}),d(o,"drop",g=>{g.preventDefault(),o.classList.remove("dragover");const f=Array.from(g.dataTransfer?.files||[]);f.length>0&&(rc(f,n),nn(r,c))});const m=s.querySelector("#clear-queue-btn");m&&d(m,"click",()=>{Ut=[],nn(r,c)});const v=s.querySelector("#upload-btn");return v&&d(v,"click",async()=>{await f0(r,c,l,e)}),h0(l),s}function rc(e,t){e.forEach(n=>{if(n.size>t){u.warning(`${n.name} is too large (max ${xs(t)})`);return}Ut.some(a=>a.file.name===n.name&&a.file.size===n.size)||Ut.push({file:n,id:`file-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,progress:0,status:"pending"})})}function nn(e,t){if(Ut.length===0){e.style.display="none",t.style.display="none";return}e.style.display="block",t.style.display="flex",e.innerHTML=Ut.map(n=>`
    <div class="queued-file ${n.status}" data-id="${n.id}">
      <div class="file-info">
        <span class="file-icon">${b0(n.file.type)}</span>
        <span class="file-name">${fi(n.file.name)}</span>
        <span class="file-size">${xs(n.file.size)}</span>
      </div>
      <div class="file-status">
        ${n.status==="uploading"?`
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${n.progress}%"></div>
          </div>
          <span class="progress-text">${n.progress}%</span>
        `:n.status==="complete"?`
          <span class="status-icon success">‚úì</span>
        `:n.status==="error"?`
          <span class="status-icon error">‚úï</span>
          <span class="error-text">${fi(n.error||"Error")}</span>
        `:`
          <button class="btn-icon remove-file" data-id="${n.id}">√ó</button>
        `}
      </div>
    </div>
  `).join(""),e.querySelectorAll(".remove-file").forEach(n=>{d(n,"click",a=>{a.stopPropagation();const s=n.getAttribute("data-id");Ut=Ut.filter(o=>o.id!==s),nn(e,t)})})}async function f0(e,t,n,a){const s=Ut.filter(i=>i.status==="pending");if(s.length===0)return;const o=t.querySelector("#upload-btn");o&&(o.disabled=!0);try{s.forEach(r=>{r.status="uploading",r.progress=0}),nn(e,t);const i=await qn.upload(s.map(r=>r.file),r=>{s.forEach(c=>{c.progress=r}),nn(e,t)});s.forEach(r=>{r.status="complete",r.progress=100}),nn(e,t),u.success(`Uploaded ${i.files.length} file(s)`),a.onUploadComplete?.(i),setTimeout(()=>{Ut=Ut.filter(r=>r.status!=="complete"),nn(e,t)},2e3),i.processingStarted&&(a.onProcessingStart?.(),id(n))}catch(i){s.forEach(r=>{r.status="error",r.error=i instanceof Error?i.message:"Upload failed"}),nn(e,t)}finally{o&&(o.disabled=!1)}}async function h0(e){try{const t=await qn.getProcessingStatus();(t.isProcessing||t.queueLength>0)&&(rd(e,t),id(e))}catch{}}let mn=null;function id(e){mn||(mn=window.setInterval(async()=>{try{const t=await qn.getProcessingStatus();rd(e,t),!t.isProcessing&&t.queueLength===0&&(mn&&(clearInterval(mn),mn=null),setTimeout(()=>{e.style.display="none"},3e3))}catch{mn&&(clearInterval(mn),mn=null)}},2e3))}function rd(e,t){e.style.display="block",e.innerHTML=`
    <div class="processing-header">
      <span class="processing-icon">${t.isProcessing?"‚è≥":"‚úì"}</span>
      <span class="processing-title">${t.isProcessing?"Processing...":"Complete"}</span>
    </div>
    <div class="processing-stats">
      <span>Completed: ${t.completedCount}</span>
      <span>Pending: ${t.queueLength}</span>
      ${t.errorCount>0?`<span class="error">Errors: ${t.errorCount}</span>`:""}
    </div>
    ${t.processingFile?`<div class="current-file">Current: ${fi(t.processingFile)}</div>`:""}
    ${t.isProcessing?`
      <div class="processing-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${t.completedCount/(t.completedCount+t.queueLength+1)*100}%"></div>
        </div>
      </div>
    `:""}
  `}function b0(e){return e.startsWith("image/")?"üñºÔ∏è":e.startsWith("video/")?"üé¨":e.startsWith("audio/")?"üéµ":e==="application/pdf"?"üìÑ":e.includes("spreadsheet")||e.includes("excel")?"üìä":e.includes("document")||e.includes("word")?"üìù":e.includes("presentation")||e.includes("powerpoint")?"üìΩÔ∏è":e.includes("text")?"üìÉ":"üìÅ"}function fi(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ys={Person:"#6366f1",Document:"#22c55e",Question:"#f59e0b",Risk:"#ef4444",Action:"#8b5cf6",Decision:"#06b6d4",Fact:"#84cc16",Email:"#ec4899",default:"#9ca3af"};function y0(e={}){const{height:t=500}=e,n=x("div",{className:"knowledge-graph"});return n.innerHTML=`
    <div class="graph-toolbar">
      <div class="graph-filters">
        <label class="filter-item">
          <input type="checkbox" checked data-type="Person"> People
        </label>
        <label class="filter-item">
          <input type="checkbox" checked data-type="Document"> Documents
        </label>
        <label class="filter-item">
          <input type="checkbox" checked data-type="Question"> Questions
        </label>
        <label class="filter-item">
          <input type="checkbox" checked data-type="Risk"> Risks
        </label>
      </div>
      <div class="graph-actions">
        <input type="search" id="graph-search" class="search-input" placeholder="Search nodes...">
        <button class="btn btn-sm" id="graph-refresh">Refresh</button>
        <button class="btn btn-sm" id="graph-fit">Fit</button>
      </div>
    </div>
    <div class="graph-container" id="graph-container" style="height: ${t}px;">
      <div class="graph-loading">Loading graph...</div>
    </div>
    <div class="graph-stats" id="graph-stats"></div>
    <div class="node-details" id="node-details" style="display: none;"></div>
  `,sr(n,e),n}async function sr(e,t){const n=e.querySelector("#graph-container"),a=e.querySelector("#graph-stats");if(!window.vis){n.innerHTML=`
      <div class="graph-fallback">
        <p>Graph visualization requires vis-network library</p>
        <p class="text-muted">Add vis-network to enable interactive graph</p>
      </div>
    `,await cc(a);return}try{const{nodes:s,edges:o}=await Ki.getVisualizationData();if(s.length===0){n.innerHTML=`
        <div class="graph-empty">
          <p>No graph data available</p>
          <p class="text-muted">Process some documents to populate the knowledge graph</p>
        </div>
      `;return}const i=x0(n,s,o,t);k0(e,i,s,t),await cc(a)}catch{n.innerHTML=`
      <div class="graph-error">
        <p>Failed to load graph</p>
        <button class="btn btn-sm" id="retry-graph">Retry</button>
      </div>
    `;const o=n.querySelector("#retry-graph");o&&d(o,"click",()=>sr(e,t))}}function x0(e,t,n,a){e.innerHTML="";const s=t.map(c=>({id:c.id,label:c.label||c.name||c.id,color:Ys[c.type]||Ys.default,title:`${c.type}: ${c.label||c.name||c.id}`,shape:"dot",size:w0(c)})),o=n.map(c=>({from:c.source,to:c.target,label:c.type,arrows:"to",color:{color:"#9ca3af",opacity:.6}})),i={nodes:{borderWidth:2,shadow:!0,font:{size:12,color:getComputedStyle(document.documentElement).getPropertyValue("--color-text").trim()||"#333"}},edges:{width:1,shadow:!1,smooth:{type:"continuous"},font:{size:10,color:"#9ca3af"}},physics:{stabilization:{iterations:100},barnesHut:{gravitationalConstant:-5e3,springLength:150}},interaction:{hover:!0,tooltipDelay:200}},r=new window.vis.Network(e,{nodes:new window.vis.DataSet(s),edges:new window.vis.DataSet(o)},i);return r.on("click",c=>{if(c.nodes&&c.nodes.length>0){const l=c.nodes[0],m=t.find(v=>v.id===l);m&&a.onNodeClick&&a.onNodeClick(m),$0(e,m)}}),r}function w0(e){const t=e.connections||1;return Math.min(10+t*2,30)}function k0(e,t,n,a){const s=e.querySelector("#graph-search");d(s,"input",()=>{const r=s.value.toLowerCase(),c=n.find(l=>(l.label||l.name||l.id).toLowerCase().includes(r));c&&t.focus(c.id,{scale:1.5})});const o=e.querySelector("#graph-refresh");o&&d(o,"click",()=>{sr(e,a)});const i=e.querySelector("#graph-fit");i&&d(i,"click",()=>{t.fit()}),e.querySelectorAll(".filter-item input").forEach(r=>{d(r,"change",()=>{u.info("Filtering not yet implemented")})})}function $0(e,t){const n=e.querySelector("#node-details");if(!t){n.style.display="none";return}n.style.display="block",n.innerHTML=`
    <div class="details-header">
      <span class="node-type" style="background: ${Ys[t.type]||Ys.default}">${t.type}</span>
      <span class="node-label">${Do(t.label||t.name||t.id)}</span>
      <button class="btn-icon close-details">√ó</button>
    </div>
    ${t.properties?`
      <div class="details-properties">
        ${Object.entries(t.properties).map(([s,o])=>`
          <div class="property">
            <span class="property-key">${Do(s)}:</span>
            <span class="property-value">${Do(String(o))}</span>
          </div>
        `).join("")}
      </div>
    `:""}
  `;const a=n.querySelector(".close-details");a&&d(a,"click",()=>{n.style.display="none"})}async function cc(e){try{const t=await Ki.getStats();S0(e,t)}catch{e.innerHTML=""}}function S0(e,t){e.innerHTML=`
    <div class="stat-item">
      <span class="stat-value">${t.nodeCount}</span>
      <span class="stat-label">Nodes</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">${t.edgeCount}</span>
      <span class="stat-label">Edges</span>
    </div>
    ${t.nodeTypes?Object.entries(t.nodeTypes).map(([n,a])=>`
      <div class="stat-item type-${n.toLowerCase()}">
        <span class="stat-value">${a}</span>
        <span class="stat-label">${n}</span>
      </div>
    `).join(""):""}
  `}function Do(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function C0(e={}){const{days:t=30}=e,n=x("div",{className:"timeline-container"});n.innerHTML=`
    <div class="timeline-header">
      <h3>Timeline</h3>
      <select id="timeline-days" class="filter-select">
        <option value="7" ${t===7?"selected":""}>Last 7 days</option>
        <option value="14" ${t===14?"selected":""}>Last 14 days</option>
        <option value="30" ${t===30?"selected":""}>Last 30 days</option>
        <option value="90" ${t===90?"selected":""}>Last 90 days</option>
      </select>
    </div>
    <div class="timeline-filters">
      <button class="filter-btn active" data-type="all">All</button>
      <button class="filter-btn" data-type="document">Documents</button>
      <button class="filter-btn" data-type="question">Questions</button>
      <button class="filter-btn" data-type="decision">Decisions</button>
      <button class="filter-btn" data-type="risk">Risks</button>
    </div>
    <div class="timeline-content" id="timeline-content">
      <div class="loading">Loading timeline...</div>
    </div>
  `;const a=n.querySelector("#timeline-days");d(a,"change",()=>{lc(n,parseInt(a.value),e)});const s=n.querySelectorAll(".filter-btn");return s.forEach(o=>{d(o,"click",()=>{s.forEach(i=>i.classList.remove("active")),o.classList.add("active"),q0(n,o.getAttribute("data-type")||"all")})}),lc(n,t,e),n}async function lc(e,t,n){const a=e.querySelector("#timeline-content");a.innerHTML='<div class="loading">Loading...</div>';try{const s=await hl.getAll({limit:t*10});L0(a,s.events||[],n)}catch{a.innerHTML='<div class="error">Failed to load timeline</div>'}}function L0(e,t,n){if(t.length===0){e.innerHTML='<div class="empty-state">No events in this period</div>';return}const a=M0(t);e.innerHTML=`
    <div class="timeline">
      ${Object.entries(a).map(([s,o])=>`
        <div class="timeline-day">
          <div class="timeline-date">${Nn(s)}</div>
          ${o.map(i=>`
            <div class="timeline-event" data-type="${i.type}" data-id="${i.id}">
              <div class="event-marker ${i.type}"></div>
              <div class="event-content">
                <div class="event-header">
                  <span class="event-type">${i.type}</span>
                  <span class="event-time">${T0(i.date)}</span>
                </div>
                <div class="event-title">${Po(i.title)}</div>
                ${i.description?`<div class="event-description">${Po(i.description)}</div>`:""}
                ${i.user?`<div class="event-user">by ${Po(i.user)}</div>`:""}
              </div>
            </div>
          `).join("")}
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".timeline-event").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);i&&n.onEventClick&&n.onEventClick(i)})})}function M0(e){const t={};return e.forEach(n=>{const a=n.date.split("T")[0];t[a]||(t[a]=[]),t[a].push(n)}),Object.fromEntries(Object.entries(t).sort(([n],[a])=>a.localeCompare(n)))}function q0(e,t){e.querySelectorAll(".timeline-event").forEach(a=>{t==="all"||a.getAttribute("data-type")===t?a.style.display="":a.style.display="none"}),e.querySelectorAll(".timeline-day").forEach(a=>{const s=a.querySelectorAll('.timeline-event:not([style*="display: none"])');a.style.display=s.length>0?"":"none"})}function T0(e){return new Date(e).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}function Po(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const cd={document:{label:"Documents",icon:"üìÑ",color:"#1abc9c"},transcript:{label:"Transcripts",icon:"üéôÔ∏è",color:"#8b5cf6"},email:{label:"Emails",icon:"üìß",color:"#6366f1"},conversation:{label:"Conversations",icon:"üí¨",color:"#ec4899"},chat_session:{label:"Chat Sessions",icon:"ü§ñ",color:"#0ea5e9"},fact:{label:"Facts",icon:"üìå",color:"#3b82f6"},question:{label:"Questions",icon:"‚ùì",color:"#f59e0b"},question_answered:{label:"Answered",icon:"‚úÖ",color:"#10b981"},decision:{label:"Decisions",icon:"üìã",color:"#3498db"},risk:{label:"Risks",icon:"‚ö†Ô∏è",color:"#f39c12"},action:{label:"Actions",icon:"üìå",color:"#9b59b6"},action_completed:{label:"Completed",icon:"‚úÖ",color:"#2ecc71"},deadline:{label:"Deadlines",icon:"üìÖ",color:"#9b59b6"}},A0=[{label:"Last 7 days",days:7},{label:"Last 14 days",days:14},{label:"Last 30 days",days:30},{label:"Last 90 days",days:90},{label:"All time",days:365}];let or=30,ia="comfortable",xt=[],ea="",ra=[],kn=-1;function ld(e={}){const t=x("div",{className:"timeline-panel sot-panel"});return t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Timeline</h2>
        <span class="panel-count" id="timeline-count">0</span>
      </div>
      <div class="panel-actions">
        <div class="timeline-search-wrapper">
          <input type="text" id="timeline-search" class="timeline-search" placeholder="Search events..." />
        </div>
        <select id="timeline-period" class="filter-select">
          ${A0.map(n=>`<option value="${n.days}" ${n.days===or?"selected":""}>${n.label}</option>`).join("")}
        </select>
        <div class="density-toggle" title="View density">
          <button class="density-btn ${ia==="compact"?"active":""}" data-density="compact" title="Compact">‚îÅ</button>
          <button class="density-btn ${ia==="comfortable"?"active":""}" data-density="comfortable" title="Comfortable">‚â°</button>
          <button class="density-btn ${ia==="spacious"?"active":""}" data-density="spacious" title="Spacious">‚ò∞</button>
        </div>
        <div class="timeline-actions-menu">
          <button class="btn btn-secondary btn-sm timeline-export-btn" title="Export">üì•</button>
        </div>
      </div>
    </div>
    <div class="timeline-filters" id="timeline-type-filters">
      <button class="filter-chip active" data-type="">All</button>
    </div>
    <div class="timeline-content" id="timeline-content">
      ${dd()}
    </div>
    <div class="timeline-footer" id="timeline-footer" style="display:none;">
      <button class="btn btn-secondary btn-sm" id="timeline-load-more">Load more</button>
    </div>
  `,E0(t,e),ir(t,e),t}function E0(e,t){const n=e.querySelector("#timeline-period");d(n,"change",()=>{or=parseInt(n.value),ir(e,t)});const a=e.querySelectorAll(".density-btn");a.forEach(r=>{d(r,"click",()=>{a.forEach(c=>c.classList.remove("active")),r.classList.add("active"),ia=r.getAttribute("data-density"),z0(e)})});const s=e.querySelector("#timeline-search");let o;d(s,"input",()=>{clearTimeout(o),o=setTimeout(()=>{ea=s.value.toLowerCase(),wo(e,t)},200)});const i=e.querySelector(".timeline-export-btn");i&&d(i,"click",()=>I0(e)),d(e,"keydown",r=>{e.querySelector("#timeline-content")&&(r.key==="j"||r.key==="ArrowDown"?(r.preventDefault(),dc(e,1)):r.key==="k"||r.key==="ArrowUp"?(r.preventDefault(),dc(e,-1)):r.key==="Enter"?(r.preventDefault(),H0(e)):r.key==="/"?(r.preventDefault(),s.focus()):r.key==="Escape"&&(s.blur(),kn=-1,ud(e)))}),e.setAttribute("tabindex","0")}async function ir(e,t){const n=e.querySelector("#timeline-content");n.innerHTML=dd();try{const a=new Date,s=new Date;s.setDate(s.getDate()-or),ra=(await ti({startDate:s.toISOString().split("T")[0],endDate:a.toISOString().split("T")[0],limit:500})).events||[],pd(e,ra),wo(e,t),B0(e,ra.length)}catch(a){console.error("Failed to load timeline:",a),n.innerHTML=D0()}}function wo(e,t){let n=[...ra];xt.length>0&&(n=n.filter(i=>xt.includes(i.type))),ea&&(n=n.filter(i=>{const r=(i.title||"").toLowerCase(),c=(i.content||i.description||"").toLowerCase(),l=(i.owner||i.user||i.actor||"").toLowerCase();return r.includes(ea)||c.includes(ea)||l.includes(ea)}));const a=e.querySelector("#timeline-content");if(n.length===0){a.innerHTML=j0();return}const s=N0(n),o=new Date().toISOString().split("T")[0];a.innerHTML=`
    <div class="timeline-list density-${ia}">
      ${Object.entries(s).map(([i,r])=>`
        <div class="timeline-day" data-date="${i}">
          <div class="timeline-date-header sticky">
            <span class="date-label">${F0(i)}</span>
            <span class="event-count">${r.length} event${r.length===1?"":"s"}</span>
          </div>
          ${i===o?'<div class="today-marker"><span>Today</span></div>':""}
          <div class="timeline-day-events">
            ${r.map((c,l)=>_0(c,l)).join("")}
          </div>
        </div>
      `).join("")}
    </div>
  `,P0(e,n,t),kn=-1}function _0(e,t){const n=cd[e.type]||{label:e.type,icon:"üìé",color:"#888"},a=e.icon||n.icon,s=e.color||n.color,o=e.owner||e.user||e.actor,i=o?U0(o):"",r=e.status?`<span class="status-badge status-${e.status}">${e.status}</span>`:"",c=e.date?O0(e.date):"",l=e.date?J(e.date):"",m=e.date?Tn(e.date):"";return`
    <div class="timeline-event" data-id="${e.id}" data-index="${t}" tabindex="0">
      <div class="event-avatar" style="background: ${s}20; color: ${s};">
        ${i||a}
      </div>
      <div class="event-body">
        <div class="event-header">
          <span class="event-type-badge" style="background: ${s}20; color: ${s};">
            <span class="type-icon">${a}</span>
            ${n.label}
          </span>
          ${r}
          <span class="event-time" title="${m}">${l}</span>
        </div>
        <div class="event-title">${Ho(e.title)}</div>
        ${e.content||e.description?`<div class="event-content">${Ho(V0(e.content||e.description||"",150))}</div>`:""}
        ${o?`<div class="event-owner"><span class="owner-name">by ${Ho(o)}</span></div>`:""}
      </div>
      <div class="event-meta">
        <span class="meta-time">${c}</span>
      </div>
    </div>
  `}function dd(){return`
    <div class="timeline-skeletons">
      ${Array(8).fill(0).map(()=>`
        <div class="skeleton-event">
          <div class="skeleton-avatar shimmer"></div>
          <div class="skeleton-body">
            <div class="skeleton-line short shimmer"></div>
            <div class="skeleton-line long shimmer"></div>
            <div class="skeleton-line medium shimmer"></div>
          </div>
        </div>
      `).join("")}
    </div>
  `}function j0(){return`
    <div class="timeline-empty">
      <div class="empty-illustration">
        <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
          <circle cx="60" cy="60" r="50" fill="var(--bg-card)" stroke="var(--border)" stroke-width="2"/>
          <path d="M60 30V60L80 75" stroke="var(--accent)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="60" cy="60" r="6" fill="var(--accent)"/>
        </svg>
      </div>
      <h3>No events found</h3>
      <p>Try adjusting your filters or date range</p>
      <div class="empty-actions">
        <button class="btn btn-primary btn-sm" id="empty-clear-filters">Clear Filters</button>
      </div>
    </div>
  `}function D0(){return`
    <div class="timeline-error">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Failed to load timeline</h3>
      <p>Please try again later</p>
      <button class="btn btn-primary btn-sm" id="timeline-retry">Retry</button>
    </div>
  `}function pd(e,t){const n={};t.forEach(i=>{n[i.type]=(n[i.type]||0)+1});const a=e.querySelector("#timeline-type-filters"),s=Object.keys(n).filter(i=>n[i]>0);a.innerHTML=`
    <button class="filter-chip ${xt.length===0?"active":""}" data-type="">All (${t.length})</button>
    ${s.map(i=>{const r=cd[i]||{label:i,icon:"üìé",color:"#888"};return`
        <button class="filter-chip ${xt.includes(i)?"active":""}" data-type="${i}" style="--chip-color: ${r.color}">
          ${r.icon} ${r.label} (${n[i]})
        </button>
      `}).join("")}
  `;const o=a.querySelectorAll(".filter-chip");o.forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-type")||"";if(!r)xt=[],o.forEach(c=>c.classList.remove("active")),i.classList.add("active");else{const c=a.querySelector('[data-type=""]');c?.classList.remove("active"),xt.includes(r)?(xt=xt.filter(l=>l!==r),i.classList.remove("active")):(xt.push(r),i.classList.add("active")),xt.length===0&&c?.classList.add("active")}wo(e,{})})})}function P0(e,t,n){e.querySelectorAll(".timeline-event").forEach(i=>{d(i,"click",()=>{const r=i.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);c&&n.onEventClick&&n.onEventClick(c)})});const s=e.querySelector("#empty-clear-filters");s&&d(s,"click",()=>{xt=[],ea="";const i=e.querySelector("#timeline-search");i&&(i.value=""),pd(e,ra),wo(e,n)});const o=e.querySelector("#timeline-retry");o&&d(o,"click",()=>ir(e,n))}function dc(e,t,n){const a=e.querySelectorAll(".timeline-event");if(a.length===0)return;ud(e),kn=Math.max(0,Math.min(a.length-1,kn+t));const s=a[kn];s&&(s.classList.add("focused"),s.scrollIntoView({behavior:"smooth",block:"nearest"}),s.focus())}function H0(e,t){const n=e.querySelectorAll(".timeline-event");kn>=0&&kn<n.length&&n[kn].click()}function ud(e){e.querySelectorAll(".timeline-event.focused").forEach(t=>t.classList.remove("focused"))}function z0(e){const t=e.querySelector(".timeline-list");t&&(t.className=`timeline-list density-${ia}`)}function B0(e,t){const n=e.querySelector("#timeline-count");n&&(n.textContent=String(t))}function I0(e){const t=e.querySelector(".export-menu");if(t){t.remove();return}const n=x("div",{className:"export-menu dropdown-menu"});n.innerHTML=`
    <button class="dropdown-item" data-format="csv">üìä Export CSV</button>
    <button class="dropdown-item" data-format="json">üì¶ Export JSON</button>
  `;const a=e.querySelector(".timeline-export-btn");a&&a.appendChild(n),n.querySelectorAll(".dropdown-item").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-format");R0(o||"csv"),n.remove()})}),setTimeout(()=>{const s=o=>{n.contains(o.target)||(n.remove(),document.removeEventListener("click",s))};document.addEventListener("click",s)},0)}function R0(e){const t=ra.map(c=>({date:c.date,type:c.type,title:c.title,content:c.content||c.description,owner:c.owner||c.user||c.actor,status:c.status}));let n,a,s;if(e==="csv"){const c=["Date","Type","Title","Content","Owner","Status"],l=t.map(m=>[m.date,m.type,`"${(m.title||"").replace(/"/g,'""')}"`,`"${(m.content||"").replace(/"/g,'""')}"`,`"${(m.owner||"").replace(/"/g,'""')}"`,m.status||""].join(","));n=[c.join(","),...l].join(`
`),a=`timeline-${new Date().toISOString().split("T")[0]}.csv`,s="text/csv"}else n=JSON.stringify(t,null,2),a=`timeline-${new Date().toISOString().split("T")[0]}.json`,s="application/json";const o=new Blob([n],{type:s}),i=URL.createObjectURL(o),r=document.createElement("a");r.href=i,r.download=a,r.click(),URL.revokeObjectURL(i)}function N0(e){const t={};return e.forEach(n=>{const a=n.date?n.date.split("T")[0]:"unknown";t[a]||(t[a]=[]),t[a].push(n)}),Object.fromEntries(Object.entries(t).sort(([n],[a])=>a.localeCompare(n)))}function F0(e){const t=new Date(e+"T00:00:00"),n=new Date,a=new Date(n);a.setDate(a.getDate()-1);const s=new Date(n);s.setDate(n.getDate()-n.getDay());const o=n.toISOString().split("T")[0],i=a.toISOString().split("T")[0];return e===o?"Today":e===i?"Yesterday":t>=s?"This week - "+Nn(t,{weekday:"long"}):Nn(t,{weekday:"short",month:"short",day:"numeric"})}function O0(e){return new Date(e).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}function U0(e){return e.split(/\s+/).map(t=>t.charAt(0).toUpperCase()).slice(0,2).join("")}function V0(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function Ho(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const G0=Object.freeze(Object.defineProperty({__proto__:null,createTimelinePanel:ld},Symbol.toStringTag,{value:"Module"}));async function Q0(){try{return(await p.get("/api/admin/billing/projects")).data?.projects||[]}catch(e){return console.error("[Billing] Error getting all projects billing:",e),[]}}async function K0(){try{return(await p.get("/api/admin/billing/pricing")).data?.config||null}catch(e){return console.error("[Billing] Error getting global pricing config:",e),null}}async function W0(e){try{return(await p.post("/api/admin/billing/pricing",e)).data||{success:!1}}catch(t){return console.error("[Billing] Error setting global pricing config:",t),{success:!1,error:String(t)}}}async function Y0(){try{const e=await p.get("/api/admin/billing/pricing/tiers");return{tiers:e.data?.tiers||[],config_id:e.data?.config_id||null}}catch(e){return console.error("[Billing] Error getting global pricing tiers:",e),{tiers:[],config_id:null}}}async function J0(e){try{return(await p.post("/api/admin/billing/pricing/tiers",{tiers:e})).data||{success:!1}}catch(t){return console.error("[Billing] Error setting global pricing tiers:",t),{success:!1,error:String(t)}}}async function Z0(e){try{return(await p.get(`/api/admin/billing/projects/${e}`)).data?.summary||null}catch(t){return console.error("[Billing] Error getting project billing summary:",t),null}}async function X0(e){try{const t=await p.get(`/api/admin/billing/projects/${e}/balance`);return t.data?.success?t.data:null}catch(t){return console.error("[Billing] Error getting project balance:",t),null}}async function e1(e,t,n){try{const a=await p.post(`/api/admin/billing/projects/${e}/balance`,{amount:t,description:n});return{success:a.data?.success||!1,new_balance:a.data?.new_balance,error:a.data?.reason}}catch(a){return console.error("[Billing] Error crediting project balance:",a),{success:!1,error:String(a)}}}async function t1(e,t){try{return{success:(await p.post(`/api/admin/billing/projects/${e}/balance`,{unlimited:t})).data?.success||!1}}catch(n){return console.error("[Billing] Error setting project unlimited:",n),{success:!1,error:String(n)}}}async function n1(e,t=50){try{return(await p.get(`/api/admin/billing/projects/${e}/transactions?limit=${t}`)).data?.transactions||[]}catch(n){return console.error("[Billing] Error getting balance transactions:",n),[]}}async function a1(e){try{const t=await p.get(`/api/admin/billing/projects/${e}/pricing`);return{override:t.data?.override||null,using_global:t.data?.using_global??!0,global_config:t.data?.global_config||null}}catch(t){return console.error("[Billing] Error getting project pricing override:",t),{override:null,using_global:!0,global_config:null}}}async function s1(e,t){try{return(await p.post(`/api/admin/billing/projects/${e}/pricing`,t)).data||{success:!1}}catch(n){return console.error("[Billing] Error setting project pricing override:",n),{success:!1,error:String(n)}}}async function o1(e){try{return(await p.delete(`/api/admin/billing/projects/${e}/pricing`)).data?.success||!1}catch(t){return console.error("[Billing] Error deleting project pricing override:",t),!1}}async function i1(e){try{return(await p.get(`/api/projects/${e}/billing`)).data?.summary||null}catch(t){return console.error("[Billing] Error getting project billing summary:",t),null}}function gs(e){return new Intl.NumberFormat("pt-PT",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}function Fn(e){return e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString()}function r1(e){return!e||e.length===0?"No tiers configured":e.map((t,n)=>{const a=n>0?e[n-1].token_limit:0,s=Fn(a||0),o=t.token_limit?Fn(t.token_limit):"‚àû";return`${s}-${o}: +${t.markup_percent}%`}).join(" | ")}async function c1(){try{const e=await p.get("/api/admin/billing/exchange-rate");return e.data?.success?{auto:e.data.auto,manualRate:e.data.manualRate,currentRate:e.data.currentRate,source:e.data.source,lastUpdated:e.data.lastUpdated,defaultRate:e.data.defaultRate}:null}catch(e){return console.error("[Billing] Error getting exchange rate config:",e),null}}async function l1(e,t){try{return(await p.post("/api/admin/billing/exchange-rate",{auto:e,manualRate:t})).data||{success:!1}}catch(n){return console.error("[Billing] Error setting exchange rate mode:",n),{success:!1,error:String(n)}}}async function d1(){try{return(await p.post("/api/admin/billing/exchange-rate/refresh",{})).data||{success:!1}}catch(e){return console.error("[Billing] Error refreshing exchange rate:",e),{success:!1,error:String(e)}}}const kt={getAllProjectsBilling:Q0,getGlobalPricingConfig:K0,setGlobalPricingConfig:W0,getGlobalPricingTiers:Y0,setGlobalPricingTiers:J0,getProjectBillingSummaryAdmin:Z0,getProjectBalance:X0,creditProjectBalance:e1,setProjectUnlimited:t1,getBalanceTransactions:n1,getProjectPricingOverride:a1,setProjectPricingOverride:s1,deleteProjectPricingOverride:o1,getExchangeRateConfig:c1,setExchangeRateMode:l1,refreshExchangeRate:d1,getProjectBillingSummary:i1,formatEur:gs,formatTokens:Fn,getTierDisplayInfo:r1};let at=null;const _a="costs-budget-modal";function md(e={}){const{period:t="month"}=e,n=x("div",{className:"costs-dashboard"});n.innerHTML=`
    <div class="costs-header">
      <div class="costs-header-title">
        <h3>LLM Costs</h3>
        <span class="costs-period-range" id="costs-period-range" aria-live="polite"></span>
      </div>
      <div class="costs-header-actions">
        <select id="costs-period" class="filter-select" aria-label="Time period">
          <option value="day" ${t==="day"?"selected":""}>Today</option>
          <option value="week" ${t==="week"?"selected":""}>This Week</option>
          <option value="month" ${t==="month"?"selected":""}>This Month</option>
          <option value="all" ${t==="all"?"selected":""}>All Time</option>
        </select>
        <button type="button" class="btn btn-secondary btn-sm" id="costs-export-btn" title="Export CSV or JSON">Export</button>
        <button type="button" class="btn btn-secondary btn-sm" id="costs-pricing-btn" title="View pricing table">Pricing</button>
        <button type="button" class="btn btn-secondary btn-sm" id="costs-budget-btn" title="Set budget and alert">Budget</button>
      </div>
    </div>
    <div class="costs-content" id="costs-content">
      <div class="loading">Loading costs...</div>
    </div>
    <div id="costs-pricing-panel" class="costs-pricing-panel hidden" aria-hidden="true"></div>
  `;const a=n.querySelector("#costs-period");d(a,"change",()=>{hi(n,a.value)});const s=n.querySelector("#costs-export-btn");s&&d(s,"click",()=>g1(a.value));const o=n.querySelector("#costs-pricing-btn"),i=n.querySelector("#costs-pricing-panel");o&&i&&d(o,"click",()=>v1(i)),d(n,"click",c=>{c.target.id==="costs-pricing-close"&&(i?.classList.add("hidden"),i?.setAttribute("aria-hidden","true"))});const r=n.querySelector("#costs-budget-btn");return r&&d(r,"click",()=>f1(n,a)),hi(n,t),n}async function hi(e,t){const n=e.querySelector("#costs-content");n.innerHTML='<div class="loading">Loading...</div>';try{const s=P.getState().currentProject?.id,[o,i,r]=await Promise.all([ha.getSummary(t),ha.getRecentRequests(20),s?kt.getProjectBillingSummary(s):Promise.resolve(null)]);at=r,p1(n,o,i);const c=e.querySelector("#costs-period-range");c&&(c.textContent=x1(o.period??{start:"",end:""}))}catch{n.innerHTML='<div class="error">Failed to load costs</div>'}}function p1(e,t,n=[]){const a=t.dailyBreakdown??[],s=t.byProvider??{},o=t.byModel??{},i=a.reduce((S,L)=>S+(L.calls??0),0),r=i>0?t.total/i:0,c=Object.entries(s).map(([S,L])=>({provider:S,cost:L})).sort((S,L)=>L.cost-S.cost),l=Object.entries(o).map(([S,L])=>({model:S,cost:L})).sort((S,L)=>L.cost-S.cost),m=new Map;for(const[S,L]of Object.entries(t.byOperation||{})){const R=S&&String(S).trim()?String(S).trim():"other";m.set(R,(m.get(R)??0)+L)}const v=Array.from(m.entries()).map(([S,L])=>({operation:S,cost:L})).sort((S,L)=>L.cost-S.cost),g=Object.entries(t.byContext||{}).map(([S,L])=>({context:S==="unknown"||!S?.trim()?"Other":S,cost:L})).sort((S,L)=>L.cost-S.cost),f=t.totalInputTokens??0,b=t.totalOutputTokens??0,w=(t.total??0)===0&&a.length===0&&Object.keys(s).length===0&&Object.keys(o).length===0,$=t.previousPeriodCost!=null&&t.percentChange!=null?`<div class="card-sub period-change ${t.percentChange>=0?"up":"down"}">vs previous period: ${t.percentChange>=0?"+":""}${t.percentChange.toFixed(1)}%</div>`:"",M=t.budgetLimit!=null&&t.budgetUsedPercent!=null?`
    <div class="costs-budget-bar ${t.budgetAlertTriggered?"alert":""}">
      <div class="costs-budget-bar-fill" style="width: ${Math.min(100,t.budgetUsedPercent)}%"></div>
      <span class="costs-budget-label">${Ht(t.total)} / ${Ht(t.budgetLimit)} (${t.budgetUsedPercent}%)</span>
      ${t.budgetAlertTriggered?'<span class="costs-budget-alert">Alert threshold reached</span>':""}
    </div>`:w?"":'<div class="costs-budget-bar costs-budget-bar-empty"><span class="costs-budget-label">No budget set</span><span class="costs-budget-set-hint">Use the Budget button above to set a limit.</span></div>',q=w?'<div class="costs-empty-state">No cost data for this period. LLM usage from Chat, document processing, and other features will appear here.</div>':"";let C="";if(at){const S=at.unlimited_balance?'<span style="color: var(--success-color); font-weight: 600;">‚àû Unlimited</span>':gs(at.balance_eur),L=at.unlimited_balance?'<span class="badge badge-success" style="font-size: 11px;">Unlimited</span>':at.balance_eur<=0?'<span class="badge badge-danger" style="font-size: 11px;">Blocked</span>':at.balance_percent_used>=80?'<span class="badge badge-warning" style="font-size: 11px;">Low Balance</span>':'<span class="badge badge-primary" style="font-size: 11px;">Active</span>';C=`
      <div class="billing-summary-banner" style="background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div style="display: flex; align-items: center; gap: 24px;">
          <div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Project Balance</div>
            <div style="font-size: 18px; font-weight: 600;">${S}</div>
          </div>
          <div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Status</div>
            <div>${L}</div>
          </div>
          ${at.current_tier_name?`
          <div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Current Tier</div>
            <div style="font-size: 14px;">${at.current_tier_name} (+${at.current_markup_percent}%)</div>
          </div>
          `:""}
        </div>
        <div style="display: flex; align-items: center; gap: 24px; color: var(--text-secondary); font-size: 13px;">
          <div>
            <strong>${Fn(at.tokens_this_period)}</strong> tokens this period
          </div>
          <div>
            <strong>${gs(at.billable_cost_this_period)}</strong> billed (${at.period_key})
          </div>
        </div>
      </div>
    `}e.innerHTML=`
    ${C}
    <div class="costs-dashboard-row">
      <div class="costs-stats-grid stats-grid">
        <div class="costs-stat-card stat-card" data-stat-id="cost-total">
          <div class="stat-value">${Ht(t.total)}</div>
          <div class="stat-label">Total Cost</div>
          ${$}
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-calls">
          <div class="stat-value">${Ja(i)}</div>
          <div class="stat-label">API Calls</div>
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-avg">
          <div class="stat-value">${Ht(r)}</div>
          <div class="stat-label">Avg per Call</div>
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-input">
          <div class="stat-value">${Ja(f)}</div>
          <div class="stat-label">Input Tokens</div>
        </div>
        <div class="costs-stat-card stat-card" data-stat-id="cost-output">
          <div class="stat-value">${Ja(b)}</div>
          <div class="stat-label">Output Tokens</div>
        </div>
      </div>
    </div>
    ${M}
    ${q}

    <div class="costs-chart-section chart-container">
      <h4 class="costs-chart-title">Daily Costs</h4>
      <div class="costs-chart-inner">
        ${y1(a,t.period??{})}
      </div>
    </div>

    <div class="costs-breakdown">
      <div class="breakdown-section">
        <h4>By Provider</h4>
        <div class="breakdown-list">
          ${c.length>0?c.map(S=>`
            <div class="breakdown-item">
              <span class="item-name">${xn(S.provider)}</span>
              <span class="item-value">${Ht(S.cost)}</span>
            </div>
          `).join(""):'<div class="empty">No data</div>'}
        </div>
      </div>

      <div class="breakdown-section">
        <h4>By Model</h4>
        <div class="breakdown-list">
          ${l.length>0?l.map(S=>`
            <div class="breakdown-item">
              <span class="item-name">${xn(S.model)}</span>
              <span class="item-value">${Ht(S.cost)}</span>
            </div>
          `).join(""):'<div class="empty">No data</div>'}
        </div>
      </div>

      <div class="breakdown-section">
        <h4>By Operation</h4>
        <div class="breakdown-list">
          ${v.length>0?v.map(S=>`
            <div class="breakdown-item">
              <span class="item-name">${xn(S.operation)}</span>
              <span class="item-value">${Ht(S.cost)}</span>
            </div>
          `).join(""):'<div class="empty">No data</div>'}
        </div>
      </div>

      ${g.length>0?`
      <div class="breakdown-section">
        <h4>By Context</h4>
        <div class="breakdown-list">
          ${g.map(S=>`
            <div class="breakdown-item">
              <span class="item-name">${xn(S.context)}</span>
              <span class="item-value">${Ht(S.cost)}</span>
            </div>
          `).join("")}
        </div>
      </div>
      `:""}
    </div>

    <div class="costs-recent-section">
      <h4>Recent Requests <span class="costs-recent-caption">(last 20, all time)</span></h4>
      ${u1(n)}
    </div>
  `}function u1(e){return e.length?`
    <div class="costs-recent-table-wrap">
      <table class="costs-recent-table" aria-label="Recent LLM requests">
        <thead>
          <tr>
            <th>Time</th>
            <th>Provider / Model</th>
            <th>Operation</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>Latency</th>
          </tr>
        </thead>
        <tbody>
          ${e.slice(0,20).map(t=>`
            <tr>
              <td>${m1(t.timestamp)}</td>
              <td>${xn(t.provider)} / ${xn(t.model)}</td>
              <td>${xn(t.request_type||t.operation||"‚Äî")}</td>
              <td>${t.input_tokens??0}+${t.output_tokens??0}</td>
              <td>${t.cost!=null?Ht(t.cost):"‚Äî"}</td>
              <td>${t.latency_ms!=null?`${t.latency_ms}ms`:"‚Äî"}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `:'<div class="empty-recent">No recent requests</div>'}function m1(e){const t=new Date(e),a=new Date().getTime()-t.getTime();return a<6e4?"Just now":a<36e5?`${Math.floor(a/6e4)}m ago`:a<864e5?`${Math.floor(a/36e5)}h ago`:t.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}async function g1(e){const t=window.confirm(`Download as JSON?

Cancel = CSV, OK = JSON`)?"json":"csv",n=t==="json"?"json":"csv",a=`/api/costs/export?period=${e}&format=${t}`;try{const s=await fetch(a,{credentials:"include"});if(!s.ok)throw new Error(s.statusText);const o=await s.blob(),i=`llm-costs-${e}-${new Date().toISOString().split("T")[0]}.${n}`,r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=i,r.click(),URL.revokeObjectURL(r.href)}catch(s){console.error("Export failed:",s),alert("Export failed. Try again.")}}async function v1(e){if(e.classList.contains("hidden")&&!e.innerHTML.trim()){e.innerHTML='<div class="loading">Loading pricing...</div>',e.classList.remove("hidden"),e.setAttribute("aria-hidden","false");try{const n=await ha.getPricing();e.innerHTML=h1(n)}catch{e.innerHTML='<div class="error">Failed to load pricing</div>'}}else e.classList.toggle("hidden"),e.setAttribute("aria-hidden",String(e.classList.contains("hidden")))}async function f1(e,t){const n=t.value,a=n==="week"?"week":"month",s=document.querySelector(`[data-modal-id="${_a}"]`);s&&s.remove();let o=100,i=80;try{const f=await ha.getBudget(a);f?.limitUsd!=null&&f.limitUsd>0&&(o=f.limitUsd),f?.alertThresholdPercent!=null&&(i=Math.min(100,Math.max(0,f.alertThresholdPercent)))}catch{}const r=x("div",{className:"costs-budget-modal-body"});r.innerHTML=`
    <p class="costs-budget-modal-desc">Set a ${a}ly spending limit and get an alert when usage reaches a percentage of that limit.</p>
    <div class="form-group">
      <label for="costs-budget-limit">Budget limit (USD)</label>
      <input type="number" id="costs-budget-limit" class="form-input" min="1" max="999999" step="0.01" value="${o}" placeholder="e.g. 100" aria-label="Budget limit in USD">
      <span class="form-hint">Min 1 USD</span>
    </div>
    <div class="form-group">
      <label for="costs-budget-threshold">Alert when usage reaches (%)</label>
      <input type="number" id="costs-budget-threshold" class="form-input" min="0" max="100" value="${i}" placeholder="e.g. 80" aria-label="Alert threshold percentage">
      <span class="form-hint">0‚Äì100%</span>
    </div>
    <p class="costs-budget-modal-hint" role="status">You will be notified when LLM costs reach this percentage of your budget.</p>
  `;const c=x("div",{className:"modal-footer"}),l=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),m=x("button",{className:"btn btn-primary",textContent:"Save budget"}),v=fe({id:_a,title:`Set ${a==="week"?"weekly":"monthly"} budget`,content:r,size:"md",closable:!0,footer:c});v.classList.add("costs-budget-modal");const g=r.querySelector(".costs-budget-modal-hint");d(l,"click",()=>H(_a)),d(m,"click",async()=>{const f=r.querySelector("#costs-budget-limit"),b=r.querySelector("#costs-budget-threshold"),w=f?parseFloat(f.value):NaN,$=b!=null?parseInt(b.value,10):NaN,M=Number.isFinite($)?Math.min(100,Math.max(0,$)):80;if(g.textContent="You will be notified when LLM costs reach this percentage of your budget.",!Number.isFinite(w)||w<1){g.textContent="Enter a valid budget (min 1 USD).",g.classList.add("costs-budget-modal-hint-error"),f?.focus();return}if(!Number.isFinite($)||$<0||$>100){g.textContent="Alert threshold must be between 0 and 100%.",g.classList.add("costs-budget-modal-hint-error"),b?.focus();return}g.classList.remove("costs-budget-modal-hint-error"),m.setAttribute("disabled","true"),m.textContent="Saving‚Ä¶";try{await ha.setBudget(a,w,M),H(_a),hi(e,t.value),u.success("Budget saved")}catch(q){console.error("Set budget failed:",q),g.textContent="Failed to save. Please try again.",g.classList.add("costs-budget-modal-hint-error"),u.error("Failed to save budget")}finally{m.removeAttribute("disabled"),m.textContent="Save budget"}}),c.append(l,m),document.body.appendChild(v),he(_a)}function h1(e){return e.length?`
    <div class="costs-pricing-header">
      <h4>Model pricing (USD per 1M tokens)</h4>
      <button type="button" class="btn btn-sm" id="costs-pricing-close" aria-label="Close">√ó</button>
    </div>
    <div class="costs-pricing-table-wrap">
      <table class="costs-pricing-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>Input</th>
            <th>Output</th>
          </tr>
        </thead>
        <tbody>
          ${e.map(t=>`
            <tr>
              <td>${xn(t.model)}</td>
              <td>$${t.inputPer1M.toFixed(2)}</td>
              <td>$${t.outputPer1M.toFixed(2)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `:'<div class="empty">No pricing data</div>'}function b1(e){const n=[],a=new Date;for(let s=13;s>=0;s--){const o=new Date(a);o.setDate(o.getDate()-s),n.push({date:o.toISOString().split("T")[0],cost:0,calls:0})}return n}function y1(e,t){const n=e.length>0?e:b1(),a=Math.max(1e-9,...n.map(o=>o.cost)),s=e.length===0;return`
    <div class="daily-chart">
      <div class="chart-bars">
        ${n.map(o=>{const i=a>0?Math.max(2,o.cost/a*100):2;return`
            <div class="bar-column" title="${o.date}: ${Ht(o.cost)} (${o.calls} calls)">
              <div class="bar ${s&&o.cost===0?"bar-placeholder":""}" style="height: ${i}%"></div>
              <div class="bar-label">${w1(o.date)}</div>
            </div>
          `}).join("")}
      </div>
      ${s?'<p class="chart-placeholder-hint">No cost data for this period. Usage will appear here as you use LLM features.</p>':""}
    </div>
  `}function x1(e){if(!e.start||!e.end)return"All time";const t=new Date(e.start),n=new Date(e.end),a=s=>s.toLocaleDateString(void 0,{month:"short",day:"numeric"});return`${a(t)} - ${a(n)}`}function w1(e){return new Date(e).toLocaleDateString(void 0,{month:"short",day:"numeric"})}function xn(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const k1=Object.freeze(Object.defineProperty({__proto__:null,createCostsDashboard:md},Symbol.toStringTag,{value:"Module"}));let rr=!1,vs="",Lt=0,fn=[];const $1={question:"‚ùì",risk:"‚ö†Ô∏è",action:"‚úì",decision:"‚öñÔ∏è",contact:"üë§",document:"üìÑ",email:"üìß",fact:"üí°"};function gd(e={}){let t=document.getElementById("global-search-modal");t||(t=S1(e),document.body.appendChild(t)),Ct.register("mod+k",n=>{n.preventDefault(),bi()}),Ct.register("/",n=>{document.activeElement?.tagName!=="INPUT"&&document.activeElement?.tagName!=="TEXTAREA"&&(n.preventDefault(),bi())})}function S1(e){const t=x("div",{id:"global-search-modal",className:"global-search-modal"});t.style.display="none",t.innerHTML=`
    <div class="search-backdrop"></div>
    <div class="search-dialog">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input type="text" id="global-search-input" class="search-input" 
               placeholder="Search questions, risks, contacts..." autocomplete="off">
        <kbd class="search-shortcut">ESC</kbd>
      </div>
      <div class="search-results" id="search-results">
        <div class="search-hint">
          <p>Start typing to search...</p>
          <div class="search-tips">
            <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
            <span><kbd>Enter</kbd> Select</span>
            <span><kbd>ESC</kbd> Close</span>
          </div>
        </div>
      </div>
      <div class="search-footer">
        <span>Type to search</span>
        <span>Press <kbd>?</kbd> for more shortcuts</span>
      </div>
    </div>
  `;const n=t.querySelector(".search-backdrop"),a=t.querySelector("#global-search-input"),s=t.querySelector("#search-results");return d(n,"click",La),d(a,"input",()=>{vs=a.value,Lt=0,L1(s,e)}),d(a,"keydown",o=>{C1(o,s,e)}),t}function bi(){rr?La():vd()}function vd(){const e=document.getElementById("global-search-modal");if(!e)return;rr=!0,e.style.display="block";const t=e.querySelector("#global-search-input");t.value="",t.focus(),vs="",fn=[],Lt=0;const n=e.querySelector("#search-results");n.innerHTML=`
    <div class="search-hint">
      <p>Start typing to search...</p>
      <div class="search-tips">
        <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
        <span><kbd>Enter</kbd> Select</span>
        <span><kbd>ESC</kbd> Close</span>
      </div>
    </div>
  `,document.addEventListener("keydown",fd)}function La(){const e=document.getElementById("global-search-modal");e&&(rr=!1,e.style.display="none",document.removeEventListener("keydown",fd))}function fd(e){e.key==="Escape"&&La()}function C1(e,t,n){switch(e.key){case"ArrowDown":e.preventDefault(),Lt=Math.min(Lt+1,fn.length-1),yi(t);break;case"ArrowUp":e.preventDefault(),Lt=Math.max(Lt-1,0),yi(t);break;case"Enter":e.preventDefault();const a=fn[Lt];a&&hd(a,n);break;case"Escape":La();break}}function yi(e){e.querySelectorAll(".search-result").forEach((n,a)=>{n.classList.toggle("selected",a===Lt),a===Lt&&n.scrollIntoView({block:"nearest"})})}let pc;function L1(e,t){clearTimeout(pc),pc=window.setTimeout(()=>{M1(e,t)},200)}async function M1(e,t){if(!vs.trim()){e.innerHTML=`
      <div class="search-hint">
        <p>Start typing to search...</p>
        <div class="search-tips">
          <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
          <span><kbd>Enter</kbd> Select</span>
          <span><kbd>ESC</kbd> Close</span>
        </div>
      </div>
    `,fn=[];return}e.innerHTML='<div class="search-loading">Searching...</div>';try{fn=(await p.get(`/api/search?q=${encodeURIComponent(vs)}&limit=10`)).data.results||[],uc(e,fn,t)}catch{fn=q1(),uc(e,fn,t)}}function q1(e){return[]}function uc(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="search-empty">
        <p>No results found for "${zo(vs)}"</p>
      </div>
    `;return}const a=A1(t);e.innerHTML=Object.entries(a).map(([s,o])=>`
    <div class="search-group">
      <div class="group-label">${E1(s)}s</div>
      ${o.map((i,r)=>`
        <div class="search-result ${r===Lt?"selected":""}" data-index="${t.indexOf(i)}">
          <span class="result-icon">${$1[i.type]||"üìã"}</span>
          <div class="result-content">
            <div class="result-title">${zo(i.title)}</div>
            ${i.subtitle?`<div class="result-subtitle">${zo(i.subtitle)}</div>`:""}
          </div>
          <span class="result-type">${i.type}</span>
        </div>
      `).join("")}
    </div>
  `).join(""),e.querySelectorAll(".search-result").forEach(s=>{d(s,"click",()=>{const o=parseInt(s.getAttribute("data-index")||"0"),i=t[o];i&&hd(i,n)}),d(s,"mouseenter",()=>{Lt=parseInt(s.getAttribute("data-index")||"0"),yi(e)})})}function hd(e,t){La(),t.onResultClick?t.onResultClick(e):T1(e)}function T1(e){window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{type:e.type,id:e.id}}))}function A1(e){const t={};return e.forEach(n=>{t[n.type]||(t[n.type]=[]),t[n.type].push(n)}),t}function E1(e){return e.charAt(0).toUpperCase()+e.slice(1)}function zo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let rt=new Set;function _1(e){const t=x("div",{className:"bulk-actions-bar"});t.style.display="none",t.innerHTML=`
    <div class="bulk-info">
      <span class="bulk-count">0</span> selected
    </div>
    <div class="bulk-buttons">
      ${j1(e.type)}
      <button class="btn btn-sm btn-secondary" id="bulk-clear">Clear</button>
    </div>
  `;const n=t.querySelector("#bulk-clear");return n&&d(n,"click",()=>{cr(),ko(t)}),D1(t,e),t}function j1(e){const t=`
    <button class="btn btn-sm btn-danger" id="bulk-delete">Delete</button>
  `;switch(e){case"questions":return`
        <button class="btn btn-sm" id="bulk-status" data-status="resolved">Mark Resolved</button>
        <button class="btn btn-sm" id="bulk-assign">Assign To...</button>
        ${t}
      `;case"actions":return`
        <button class="btn btn-sm" id="bulk-status" data-status="completed">Mark Complete</button>
        <button class="btn btn-sm" id="bulk-assign">Assign To...</button>
        ${t}
      `;case"risks":return`
        <button class="btn btn-sm" id="bulk-status" data-status="mitigated">Mark Mitigated</button>
        ${t}
      `;case"decisions":return`
        <button class="btn btn-sm" id="bulk-status" data-status="approved">Approve</button>
        <button class="btn btn-sm" id="bulk-status" data-status="rejected">Reject</button>
        ${t}
      `;default:return t}}function D1(e,t){const n=e.querySelector("#bulk-delete");n&&d(n,"click",async()=>{confirm(`Delete ${rt.size} items?`)&&await Bo({type:t.type,ids:Array.from(rt),action:"delete"},t)}),e.querySelectorAll('[id^="bulk-status"]').forEach(o=>{d(o,"click",async()=>{const i=o.getAttribute("data-status");i&&await Bo({type:t.type,ids:Array.from(rt),action:"status",data:{status:i}},t)})});const s=e.querySelector("#bulk-assign");s&&d(s,"click",()=>{const o=prompt("Assign to:");o&&Bo({type:t.type,ids:Array.from(rt),action:"assign",data:{assignee:o}},t)})}async function Bo(e,t){try{let n="",a={type:e.type,ids:e.ids};switch(e.action){case"delete":n="/api/bulk/delete";break;case"status":n="/api/bulk/status",a={...a,status:e.data?.status};break;case"assign":n="/api/bulk/assign",a={...a,assignee:e.data?.assignee};break}const s=await p.post(n,a);s.data.actionId&&wt.push({type:`bulk-${e.action}`,description:`${e.action} ${e.ids.length} items`,undo:async()=>{await p.post(`/api/undo/${s.data.actionId}`),t.onComplete?.()}}),u.success(`Updated ${s.data.affected||e.ids.length} items`),cr(),t.onComplete?.()}catch{u.error("Bulk operation failed")}}function bd(e,t){rt.has(e)?rt.delete(e):rt.add(e),ko(t)}function P1(e,t){rt.add(e),ko(t)}function H1(e,t){rt.delete(e),ko(t)}function cr(){rt.clear(),document.querySelectorAll(".bulk-checkbox:checked").forEach(e=>{e.checked=!1})}function z1(){return Array.from(rt)}function xi(e){return rt.has(e)}function ko(e){const t=rt.size;e.style.display=t>0?"flex":"none";const n=e.querySelector(".bulk-count");n&&(n.textContent=String(t))}function B1(e,t){const n=x("input",{type:"checkbox",className:"bulk-checkbox"});return n.setAttribute("data-id",e),n.checked=xi(e),d(n,"change",a=>{a.stopPropagation(),bd(e,t),n.checked=xi(e)}),n}function I1(e={}){const t=x("div",{className:"sync-status"});t.innerHTML=`
    <div class="sync-indicator" id="sync-indicator">
      <span class="sync-icon">‚ü≥</span>
      <span class="sync-text">Checking...</span>
    </div>
    ${e.showDetails?`
      <div class="sync-details" id="sync-details" style="display: none;">
        <div class="sync-info"></div>
        <div class="dead-letters"></div>
      </div>
    `:""}
  `;const n=t.querySelector("#sync-indicator");return e.showDetails&&d(n,"click",()=>{const a=t.querySelector("#sync-details"),s=a.style.display!=="none";a.style.display=s?"none":"block",s||yd(t)}),mc(t),setInterval(()=>mc(t),3e4),t}async function mc(e){try{const t=await p.get("/api/sync/status");gc(e,t.data)}catch{gc(e,{connected:!1,lastSync:null,pendingCount:0,errorCount:0})}}function gc(e,t){const n=e.querySelector(".sync-icon"),a=e.querySelector(".sync-text"),s=e.querySelector(".sync-indicator");t.connected?t.pendingCount>0?(n.textContent="‚ü≥",a.textContent=`Syncing (${t.pendingCount})`,s.classList.remove("synced","error"),s.classList.add("syncing")):t.errorCount>0?(n.textContent="!",a.textContent=`${t.errorCount} errors`,s.classList.remove("synced","syncing"),s.classList.add("error")):(n.textContent="‚úì",a.textContent=t.lastSync?J(t.lastSync):"Synced",s.classList.remove("syncing","error"),s.classList.add("synced")):(n.textContent="‚ö†",a.textContent="Disconnected",s.classList.remove("synced","syncing"),s.classList.add("error"))}async function yd(e){const t=e.querySelector(".sync-info"),n=e.querySelector(".dead-letters");t.innerHTML='<div class="loading">Loading...</div>';try{const s=(await p.get("/api/sync/status")).data;t.innerHTML=`
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Status</span>
          <span class="info-value ${s.connected?"success":"error"}">
            ${s.connected?"Connected":"Disconnected"}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">Last Sync</span>
          <span class="info-value">${s.lastSync?J(s.lastSync):"Never"}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Pending</span>
          <span class="info-value">${s.pendingCount}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Errors</span>
          <span class="info-value ${s.errorCount>0?"error":""}">${s.errorCount}</span>
        </div>
      </div>
    `;const i=(await p.get("/api/sync/dead-letters")).data.deadLetters||[];i.length>0?(n.innerHTML=`
        <h4>Failed Operations</h4>
        <div class="dead-letters-list">
          ${i.map(r=>`
            <div class="dead-letter" data-id="${r.id}">
              <div class="dl-header">
                <span class="dl-type">${r.type}</span>
                <span class="dl-time">${J(r.failedAt)}</span>
              </div>
              <div class="dl-error">${N1(r.error)}</div>
              <div class="dl-actions">
                <button class="btn btn-sm retry-btn" data-id="${r.id}">Retry</button>
                <span class="dl-retries">${r.retryCount} attempts</span>
              </div>
            </div>
          `).join("")}
        </div>
      `,n.querySelectorAll(".retry-btn").forEach(r=>{d(r,"click",async()=>{const c=r.getAttribute("data-id");if(c)try{await p.post(`/api/sync/retry/${c}`),u.success("Retry scheduled"),yd(e)}catch{u.error("Retry failed")}})})):n.innerHTML=""}catch{t.innerHTML='<div class="error">Failed to load details</div>'}}function R1(){const e=x("div",{className:"sync-indicator-mini"});return e.innerHTML='<span class="sync-dot"></span>',vc(e),setInterval(()=>vc(e),3e4),e}async function vc(e){try{const t=await p.get("/api/sync/status"),n=e.querySelector(".sync-dot");t.data.connected?t.data.errorCount>0?(n.className="sync-dot warning",e.title=`${t.data.errorCount} sync errors`):(n.className="sync-dot success",e.title="Synced"):(n.className="sync-dot error",e.title="Disconnected")}catch{const t=e.querySelector(".sync-dot");t.className="sync-dot error",e.title="Connection error"}}function N1(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const fc="settings-modal";function xd(e={}){const t=document.querySelector(`[data-modal-id="${fc}"]`);t&&t.remove();const n=P.getState(),a=Ae.getMode(),s=e.initialTab||"general",o=x("div",{className:"settings-modal-overlay"});o.setAttribute("data-modal-id",fc);const i=x("div",{className:"settings-modal-container"});i.innerHTML=`
    <style>
      .settings-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      
      .settings-modal-container {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        width: 100%;
        max-width: 520px;
      }
      
      .settings-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248,250,252,0.98) 100%);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8);
        overflow: hidden;
      }
      
      [data-theme="dark"] .settings-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(15,23,42,0.98) 100%);
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1);
      }
      
      .settings-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 24px 28px;
        position: relative;
        overflow: hidden;
      }
      
      .settings-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
      }
      
      .settings-header-content {
        display: flex;
        align-items: center;
        gap: 14px;
        position: relative;
        z-index: 1;
      }
      
      .settings-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255,255,255,0.3);
      }
      
      .settings-icon svg {
        width: 28px;
        height: 28px;
        stroke: white;
        fill: none;
      }
      
      .settings-title {
        flex: 1;
      }
      
      .settings-title h2 {
        color: white;
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      .settings-title p {
        color: rgba(255,255,255,0.85);
        font-size: 0.85rem;
        margin: 4px 0 0;
      }
      
      .settings-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        z-index: 2;
      }
      
      .settings-close:hover {
        background: rgba(255,255,255,0.3);
      }
      
      .settings-close svg {
        width: 18px;
        height: 18px;
        stroke: white;
      }
      
      .settings-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 24px;
        background: var(--bg-secondary, #f8fafc);
        border-bottom: 1px solid var(--border-color, #e2e8f0);
      }
      
      [data-theme="dark"] .settings-tabs {
        background: rgba(30,41,59,0.5);
        border-bottom-color: rgba(255,255,255,0.1);
      }
      
      .settings-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border: none;
        background: transparent;
        color: var(--text-secondary, #64748b);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.2s;
      }
      
      .settings-tab:hover {
        background: var(--bg-hover, rgba(0,0,0,0.05));
        color: var(--text-primary, #1e293b);
      }
      
      .settings-tab.active {
        background: white;
        color: #e11d48;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      
      [data-theme="dark"] .settings-tab.active {
        background: rgba(225,29,72,0.15);
        color: #fb7185;
      }
      
      .settings-tab svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
      }
      
      .settings-body {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .settings-section {
        display: none;
      }
      
      .settings-section.active {
        display: block;
      }
      
      .settings-section h3 {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary, #64748b);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0 0 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .settings-section h3 svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group:last-child {
        margin-bottom: 0;
      }
      
      .form-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-primary, #1e293b);
        margin-bottom: 8px;
      }
      
      .form-group p.hint {
        font-size: 0.8rem;
        color: var(--text-secondary, #64748b);
        margin: 6px 0 0;
      }
      
      .form-select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 10px;
        background: var(--bg-primary, white);
        color: var(--text-primary, #1e293b);
        font-size: 0.9rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        cursor: pointer;
      }
      
      .form-select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
      }
      
      [data-theme="dark"] .form-select {
        background-color: rgba(30,41,59,0.8);
        border-color: rgba(255,255,255,0.1);
      }
      
      .toggle-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: var(--bg-secondary, #f8fafc);
        border-radius: 10px;
        margin-bottom: 12px;
      }
      
      [data-theme="dark"] .toggle-group {
        background: rgba(30,41,59,0.5);
      }
      
      .toggle-group:last-child {
        margin-bottom: 0;
      }
      
      .toggle-info {
        flex: 1;
      }
      
      .toggle-info strong {
        display: block;
        font-size: 0.9rem;
        color: var(--text-primary, #1e293b);
        margin-bottom: 2px;
      }
      
      .toggle-info span {
        font-size: 0.8rem;
        color: var(--text-secondary, #64748b);
      }
      
      .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
        flex-shrink: 0;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--bg-tertiary, #cbd5e1);
        border-radius: 26px;
        transition: 0.3s;
      }
      
      .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .toggle-switch input:checked + .toggle-slider {
        background: #e11d48;
      }
      
      .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(22px);
      }
      
      .settings-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 24px;
        background: var(--bg-secondary, #f8fafc);
        border-top: 1px solid var(--border-color, #e2e8f0);
      }
      
      [data-theme="dark"] .settings-footer {
        background: rgba(30,41,59,0.5);
        border-top-color: rgba(255,255,255,0.1);
      }
      
      .btn-cancel {
        padding: 10px 20px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 10px;
        background: var(--bg-primary, white);
        color: var(--text-primary, #1e293b);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      .btn-cancel:hover {
        background: var(--bg-hover, #f1f5f9);
      }
      
      .btn-save {
        padding: 10px 24px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .btn-save:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }
      
      .btn-save svg {
        width: 18px;
        height: 18px;
        stroke: white;
      }
      
      .admin-notice {
        background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(37,99,235,0.1) 100%);
        border: 1px solid rgba(59,130,246,0.3);
        border-radius: 10px;
        padding: 14px 16px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .admin-notice svg {
        width: 20px;
        height: 20px;
        stroke: #3b82f6;
        flex-shrink: 0;
      }
      
      .admin-notice p {
        font-size: 0.85rem;
        color: var(--text-secondary, #64748b);
        margin: 0;
      }
      
      .admin-notice strong {
        color: #3b82f6;
      }
    </style>
    
    <div class="settings-card">
      <!-- Header -->
      <div class="settings-header">
        <button class="settings-close" id="close-settings-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        <div class="settings-header-content">
          <div class="settings-icon">
            <svg viewBox="0 0 24 24" stroke-width="2">
              <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </div>
          <div class="settings-title">
            <h2>Settings</h2>
            <p>Your personal preferences</p>
          </div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="settings-tabs">
        <button class="settings-tab ${s==="general"?"active":""}" data-tab="general">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
          </svg>
          General
        </button>
        <button class="settings-tab ${s==="data"?"active":""}" data-tab="data">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          Data & Privacy
        </button>
      </div>
      
      <!-- Body -->
      <div class="settings-body">
        <!-- General Section -->
        <div class="settings-section ${s==="general"?"active":""}" id="section-general">
          <h3>
            <svg viewBox="0 0 24 24" stroke-width="2">
              <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/>
            </svg>
            Appearance
          </h3>
          
          <div class="form-group">
            <label>Theme</label>
            <select class="form-select" id="setting-theme">
              <option value="system" ${a==="system"?"selected":""}>System (Auto)</option>
              <option value="light" ${a==="light"?"selected":""}>Light</option>
              <option value="dark" ${a==="dark"?"selected":""}>Dark</option>
            </select>
            <p class="hint">Choose your preferred color scheme</p>
          </div>
          
          <div class="form-group">
            <label>Language</label>
            <select class="form-select" id="setting-language">
              <option value="en" ${n.config.language==="en"?"selected":""}>English</option>
              <option value="pt" ${n.config.language==="pt"?"selected":""}>Portugues</option>
              <option value="es" ${n.config.language==="es"?"selected":""}>Espanol</option>
            </select>
            <p class="hint">Interface language preference</p>
          </div>
          
          ${n.currentUser?.role==="superadmin"?`
            <div class="admin-notice">
              <svg viewBox="0 0 24 24" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <p>For <strong>LLM configuration</strong>, <strong>Graph</strong>, and other platform settings, use the <strong>Admin</strong> section in the sidebar menu.</p>
            </div>
          `:""}
        </div>
        
        <!-- Data & Privacy Section -->
        <div class="settings-section ${s==="data"?"active":""}" id="section-data">
          <h3>
            <svg viewBox="0 0 24 24" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Privacy Settings
          </h3>
          
          <div class="toggle-group">
            <div class="toggle-info">
              <strong>Analytics</strong>
              <span>Help improve GodMode with anonymous usage data</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="setting-analytics" ${n.config.analyticsEnabled!==!1?"checked":""}>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="toggle-group">
            <div class="toggle-info">
              <strong>Error Reporting</strong>
              <span>Automatically report errors to help fix bugs</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="setting-error-reporting" ${n.config.errorReportingEnabled!==!1?"checked":""}>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="toggle-group">
            <div class="toggle-info">
              <strong>AI Data Improvement</strong>
              <span>Allow anonymized data to improve AI responses</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="setting-ai-improvement" ${n.config.aiImprovementEnabled===!0?"checked":""}>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="settings-footer">
        <button class="btn-cancel" id="cancel-settings-btn">Cancel</button>
        <button class="btn-save" id="save-settings-btn">
          <svg viewBox="0 0 24 24" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Save Settings
        </button>
      </div>
    </div>
  `,o.appendChild(i),document.body.appendChild(o),F1(o,e)}function F1(e,t){const n=e.querySelector("#close-settings-btn"),a=e.querySelector("#cancel-settings-btn"),s=()=>e.remove();n&&d(n,"click",s),a&&d(a,"click",s),d(e,"click",c=>{c.target===e&&s()});const o=e.querySelectorAll(".settings-tab");o.forEach(c=>{d(c,"click",()=>{const l=c.getAttribute("data-tab");o.forEach(v=>v.classList.remove("active")),c.classList.add("active"),e.querySelectorAll(".settings-section").forEach(v=>{v.classList.remove("active")});const m=e.querySelector(`#section-${l}`);m&&m.classList.add("active")})});const i=e.querySelector("#setting-theme");i&&d(i,"change",()=>{Ae.set(i.value)});const r=e.querySelector("#save-settings-btn");r&&d(r,"click",()=>{const c={theme:e.querySelector("#setting-theme")?.value,language:e.querySelector("#setting-language")?.value,analyticsEnabled:e.querySelector("#setting-analytics")?.checked,errorReportingEnabled:e.querySelector("#setting-error-reporting")?.checked,aiImprovementEnabled:e.querySelector("#setting-ai-improvement")?.checked};P.setConfig({...P.getState().config,...c}),t.onSave?.(c),u.success("Settings saved"),s()})}const $n="processing-modal";let mt=[],lr;function O1(e={}){const{title:t="Processing",steps:n=[],onCancel:a,allowCancel:s=!0}=e;mt=n,lr=a;const o=document.querySelector(`[data-modal-id="${$n}"]`);o&&o.remove();const i=x("div",{className:"processing-content"});$o(i);const r=s?V1():null,c=fe({id:$n,title:t,content:i,size:"md",closable:!1,footer:r});document.body.appendChild(c),he($n)}function $o(e){e.innerHTML=`
    <div class="processing-steps">
      ${mt.map(t=>U1(t)).join("")}
    </div>
    <div class="processing-overall">
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${hc()}%"></div>
      </div>
      <div class="progress-text">${hc()}% complete</div>
    </div>
  `}function U1(e){const t={pending:"‚è≥",running:"üîÑ",completed:"‚úÖ",error:"‚ùå"}[e.status];return`
    <div class="processing-step ${e.status}" data-step-id="${e.id}">
      <span class="step-icon">${t}</span>
      <div class="step-content">
        <div class="step-label">${e.label}</div>
        ${e.message?`<div class="step-message">${e.message}</div>`:""}
        ${e.status==="running"&&e.progress!==void 0?`
          <div class="step-progress">
            <div class="progress-bar small">
              <div class="progress-fill" style="width: ${e.progress}%"></div>
            </div>
          </div>
        `:""}
      </div>
    </div>
  `}function hc(){if(mt.length===0)return 0;const e=mt.filter(a=>a.status==="completed").length,t=mt.find(a=>a.status==="running"),n=t?.progress||0;return Math.round((e+(t?n/100:0))/mt.length*100)}function V1(){const e=x("div",{className:"modal-footer"}),t=x("button",{className:"btn btn-secondary",textContent:"Cancel"});return d(t,"click",()=>{lr?.(),wd()}),e.appendChild(t),e}function G1(e,t){const n=mt.findIndex(s=>s.id===e);if(n===-1)return;mt[n]={...mt[n],...t};const a=document.querySelector(`[data-modal-id="${$n}"]`);if(a){const s=a.querySelector(".processing-content");s&&$o(s)}}function Q1(e){mt.push(e);const t=document.querySelector(`[data-modal-id="${$n}"]`);if(t){const n=t.querySelector(".processing-content");n&&$o(n)}}function K1(e){mt=e;const t=document.querySelector(`[data-modal-id="${$n}"]`);if(t){const n=t.querySelector(".processing-content");n&&$o(n)}}function wd(){H($n),mt=[],lr=void 0}function W1(){return document.querySelector(`[data-modal-id="${$n}"]`)?.classList.contains("open")||!1}const et="auth-modal";let Qt="login",Mn={},dn="",Tt=0,Xt=null;function dr(e={}){Qt=e.initialMode||"login",Mn=e;const t=document.querySelector(`[data-modal-id="${et}"]`);t&&t.remove();const n=x("div",{className:"auth-content"});En(n);const a=fe({id:et,title:An(),content:n,size:"sm",closable:!e.required,onClose:e.onClose,footer:null});document.body.appendChild(a),he(et),setTimeout(()=>{const s=n.querySelector("input");s&&s.focus()},100)}function An(){switch(Qt){case"login":return"Sign In";case"register":return"Create Account";case"forgot":return"Reset Password";case"reset":return"Set New Password";case"otp-request":return"Sign In with Code";case"otp-verify":return"Enter Code";case"email-confirm":return"Confirm Email"}}function En(e){switch(Xt&&(clearInterval(Xt),Xt=null),Qt){case"login":Y1(e);break;case"register":J1(e);break;case"forgot":Z1(e);break;case"reset":X1(e);break;case"otp-request":ex(e);break;case"otp-verify":tx(e);break;case"email-confirm":nx(e);break}}function Y1(e){e.innerHTML=`
    <form id="login-form" class="auth-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-error" id="login-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Sign In</span>
          <span class="btn-loading" style="display: none;">Signing in...</span>
        </button>
      </div>
      <div class="auth-divider">
        <span>or</span>
      </div>
      <div class="form-group">
        <button type="button" class="btn btn-secondary btn-block" data-action="otp-request">
          Sign in with email code
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="forgot">Forgot password?</button>
        <span class="separator">|</span>
        <button type="button" class="btn-link" data-action="register">Create account</button>
      </div>
    </form>
  `;const t=e.querySelector("#login-form");d(t,"submit",async n=>{n.preventDefault(),await rx(t)}),Ma(e)}function J1(e){e.innerHTML=`
    <form id="register-form" class="auth-form">
      <div class="form-group">
        <label for="register-email">Email <span class="required">*</span></label>
        <input type="email" id="register-email" required autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label for="register-username">Username</label>
        <input type="text" id="register-username" autocomplete="username" placeholder="username (optional)" 
               pattern="^[a-zA-Z0-9_]+$" minlength="3">
        <small class="form-hint">Letters, numbers, and underscores only. Min 3 characters.</small>
      </div>
      <div class="form-group">
        <label for="register-display-name">Display Name</label>
        <input type="text" id="register-display-name" autocomplete="name" placeholder="Your Name (optional)">
      </div>
      <div class="form-group">
        <label for="register-password">Password <span class="required">*</span></label>
        <input type="password" id="register-password" required autocomplete="new-password" 
               minlength="12" placeholder="Min. 12 characters">
        <div class="password-strength" id="password-strength"></div>
      </div>
      <div class="form-group">
        <label for="register-confirm">Confirm Password <span class="required">*</span></label>
        <input type="password" id="register-confirm" required autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-error" id="register-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Create Account</span>
          <span class="btn-loading" style="display: none;">Creating account...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Already have an account? Sign in</button>
      </div>
    </form>
  `;const t=e.querySelector("#register-form"),n=t.querySelector("#register-password");d(n,"input",()=>{Sd(n.value)}),d(t,"submit",async a=>{a.preventDefault(),await cx(t)}),Ma(e)}function Z1(e){e.innerHTML=`
    <form id="forgot-form" class="auth-form">
      <p class="form-description">
        Enter your email address and we'll send you a link to reset your password.
      </p>
      <div class="form-group">
        <label for="forgot-email">Email</label>
        <input type="email" id="forgot-email" required autocomplete="email" placeholder="your@email.com">
      </div>
      <div class="form-error" id="forgot-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Send Reset Link</span>
          <span class="btn-loading" style="display: none;">Sending...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Back to sign in</button>
      </div>
    </form>
  `;const t=e.querySelector("#forgot-form");d(t,"submit",async n=>{n.preventDefault(),await lx(t)}),Ma(e)}function X1(e){e.innerHTML=`
    <form id="reset-form" class="auth-form">
      <p class="form-description">
        Enter your new password below.
      </p>
      <div class="form-group">
        <label for="reset-password">New Password</label>
        <input type="password" id="reset-password" required autocomplete="new-password" 
               minlength="12" placeholder="Min. 12 characters">
        <div class="password-strength" id="reset-password-strength"></div>
      </div>
      <div class="form-group">
        <label for="reset-confirm">Confirm Password</label>
        <input type="password" id="reset-confirm" required autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-error" id="reset-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Reset Password</span>
          <span class="btn-loading" style="display: none;">Resetting...</span>
        </button>
      </div>
    </form>
  `;const t=e.querySelector("#reset-form"),n=t.querySelector("#reset-password");d(n,"input",()=>{Sd(n.value,"reset-password-strength")}),d(t,"submit",async a=>{a.preventDefault(),await dx(t)})}function ex(e){e.innerHTML=`
    <form id="otp-request-form" class="auth-form">
      <p class="form-description">
        Enter your email address and we'll send you a one-time code to sign in.
      </p>
      <div class="form-group">
        <label for="otp-email">Email</label>
        <input type="email" id="otp-email" required autocomplete="email" placeholder="your@email.com" value="${dn}">
      </div>
      <div class="form-error" id="otp-request-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">
          <span class="btn-text">Send Code</span>
          <span class="btn-loading" style="display: none;">Sending...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Sign in with password</button>
        <span class="separator">|</span>
        <button type="button" class="btn-link" data-action="register">Create account</button>
      </div>
    </form>
  `;const t=e.querySelector("#otp-request-form");d(t,"submit",async n=>{n.preventDefault(),await ax(t,e)}),Ma(e)}function tx(e){const t=dn?dn.replace(/(.{2})(.*)(@.*)/,"$1***$3"):"your email";e.innerHTML=`
    <form id="otp-verify-form" class="auth-form">
      <p class="form-description">
        Enter the 6-digit code sent to <strong>${t}</strong>
      </p>
      <div class="form-group otp-input-group">
        <div class="otp-inputs">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="one-time-code" data-index="0">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="1">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="2">
          <span class="otp-separator">-</span>
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="3">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="4">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="5">
        </div>
        <input type="hidden" id="otp-code" name="code">
      </div>
      <div class="form-error" id="otp-verify-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block" id="otp-verify-btn" disabled>
          <span class="btn-text">Verify Code</span>
          <span class="btn-loading" style="display: none;">Verifying...</span>
        </button>
      </div>
      <div class="otp-resend">
        <button type="button" class="btn-link" id="resend-code-btn" ${Tt>0?"disabled":""}>
          ${Tt>0?`Resend code in ${Tt}s`:"Resend code"}
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="otp-request">Use different email</button>
        <span class="separator">|</span>
        <button type="button" class="btn-link" data-action="login">Sign in with password</button>
      </div>
    </form>
  `;const n=e.querySelector("#otp-verify-form"),a=e.querySelectorAll(".otp-digit"),s=e.querySelector("#otp-code"),o=e.querySelector("#otp-verify-btn"),i=e.querySelector("#resend-code-btn");kd(a,s,o),Tt>0&&$d(i),d(i,"click",async()=>{await ox(e)}),d(n,"submit",async r=>{r.preventDefault(),await sx(n)}),Ma(e),setTimeout(()=>a[0]?.focus(),100)}function nx(e){const t=Mn.email||dn||"";e.innerHTML=`
    <form id="email-confirm-form" class="auth-form">
      <div class="confirm-icon">‚úâÔ∏è</div>
      <p class="form-description">
        Enter the confirmation code sent to <strong>${t||"your email"}</strong>
      </p>
      <div class="form-group otp-input-group">
        <div class="otp-inputs">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="0">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="1">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="2">
          <span class="otp-separator">-</span>
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="3">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="4">
          <input type="text" class="otp-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="5">
        </div>
        <input type="hidden" id="confirm-code" name="code">
      </div>
      <div class="form-error" id="email-confirm-error" style="display: none;"></div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block" id="confirm-btn" disabled>
          <span class="btn-text">Confirm Email</span>
          <span class="btn-loading" style="display: none;">Confirming...</span>
        </button>
      </div>
      <div class="auth-links">
        <button type="button" class="btn-link" data-action="login">Back to sign in</button>
      </div>
    </form>
  `;const n=e.querySelector("#email-confirm-form"),a=e.querySelectorAll(".otp-digit"),s=e.querySelector("#confirm-code"),o=e.querySelector("#confirm-btn");kd(a,s,o),d(n,"submit",async i=>{i.preventDefault(),await ix(n,e,t)}),Ma(e),setTimeout(()=>a[0]?.focus(),100)}function kd(e,t,n){const a=()=>{const s=Array.from(e).map(o=>o.value).join("");t.value=s,n.disabled=s.length!==6||!/^\d{6}$/.test(s)};e.forEach((s,o)=>{d(s,"input",i=>{const r=i.target.value;if(!/^\d*$/.test(r)){s.value=r.replace(/\D/g,"");return}if(r.length>1){const c=r.split("");e.forEach((m,v)=>{m.value=c[v]||""});const l=Math.min(c.length,5);e[l]?.focus(),a();return}r&&o<e.length-1&&e[o+1].focus(),a()}),d(s,"keydown",i=>{const r=i.key;r==="Backspace"&&!s.value&&o>0&&(e[o-1].focus(),e[o-1].value="",a()),r==="ArrowLeft"&&o>0&&e[o-1].focus(),r==="ArrowRight"&&o<e.length-1&&e[o+1].focus()}),d(s,"paste",i=>{i.preventDefault();const c=(i.clipboardData?.getData("text")||"").replace(/\D/g,"").slice(0,6);if(c){c.split("").forEach((m,v)=>{e[v]&&(e[v].value=m)});const l=Math.min(c.length,5);e[l]?.focus(),a()}}),d(s,"focus",()=>s.select())})}function $d(e){Xt&&clearInterval(Xt);const t=()=>{Tt>0?(e.disabled=!0,e.textContent=`Resend code in ${Tt}s`,Tt--):(e.disabled=!1,e.textContent="Resend code",Xt&&(clearInterval(Xt),Xt=null))};t(),Xt=setInterval(t,1e3)}async function ax(e,t){const n=e.querySelector("#otp-email").value.trim(),a=e.querySelector("#otp-request-error");nt(e,!0),Qn(a);try{const s=await tt.requestLoginCode(n);dn=n,Tt=60,u.success(s.message||"Code sent! Check your email."),Qt="otp-verify";const o=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);o&&(o.textContent=An()),En(t)}catch(s){const i=s.message||"Failed to send code";ct(a,i)}finally{nt(e,!1)}}async function sx(e,t){const n=e.querySelector("#otp-code").value,a=e.querySelector("#otp-verify-error");if(!n||n.length!==6){ct(a,"Please enter the 6-digit code");return}nt(e,!0),Qn(a);try{const s=await tt.verifyLoginCode(dn,n);u.success("Signed in successfully"),Mn.onSuccess?.(s),H(et),window.dispatchEvent(new CustomEvent("godmode:auth-success"))}catch(s){const o=s;let i=o.message||"Verification failed";o.attemptsRemaining!==void 0&&o.attemptsRemaining>0&&(i+=` (${o.attemptsRemaining} attempts remaining)`),o.needsEmailVerification&&(i="Please confirm your email address first."),o.fallbackToPassword&&(i="Please sign in with your password instead."),ct(a,i);const r=e.querySelectorAll(".otp-digit");r.forEach(c=>c.value=""),r[0]?.focus()}finally{nt(e,!1)}}async function ox(e){if(Tt>0)return;const t=e.querySelector("#resend-code-btn");t.disabled=!0,t.textContent="Sending...";try{await tt.requestLoginCode(dn),u.success("New code sent!"),Tt=60,$d(t)}catch(n){const a=n;u.error(a.message||"Failed to resend code"),t.disabled=!1,t.textContent="Resend code"}}async function ix(e,t,n){const a=e.querySelector("#confirm-code").value,s=e.querySelector("#email-confirm-error");if(!a||a.length!==6){ct(s,"Please enter the 6-digit code");return}nt(e,!0),Qn(s);try{await tt.confirmEmail(n,a),u.success("Email confirmed! You can now sign in."),Qt="login";const o=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);o&&(o.textContent=An()),En(t)}catch(o){ct(s,o.message||"Confirmation failed");const r=e.querySelectorAll(".otp-digit");r.forEach(c=>c.value=""),r[0]?.focus()}finally{nt(e,!1)}}function Ma(e){e.querySelectorAll("[data-action]").forEach(n=>{d(n,"click",()=>{Qt=n.getAttribute("data-action");const s=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);s&&(s.textContent=An()),En(e)})})}async function rx(e){const t=e.querySelector("#login-email").value.trim(),n=e.querySelector("#login-password").value,a=e.querySelector("#login-error");nt(e,!0),Qn(a);try{const s=await tt.login({email:t,password:n});u.success("Signed in successfully"),Mn.onSuccess?.(s),H(et),window.dispatchEvent(new CustomEvent("godmode:auth-success"))}catch(s){const o=s,i=o.response?.data;if(i?.needsEmailVerification){dn=i.email||t,Mn.email=dn,Tt=60,u.info("Please verify your email to continue."),Qt="email-confirm";const c=e.parentElement,l=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);l&&(l.textContent=An()),En(c);return}const r=o.message||"Login failed";ct(a,r)}finally{nt(e,!1)}}async function cx(e){const t=e.querySelector("#register-email").value.trim(),n=e.querySelector("#register-username").value.trim(),a=e.querySelector("#register-display-name").value.trim(),s=e.querySelector("#register-password").value,o=e.querySelector("#register-confirm").value,i=e.querySelector("#register-error");if(s!==o){ct(i,"Passwords do not match");return}if(s.length<12){ct(i,"Password must be at least 12 characters");return}nt(e,!0),Qn(i);try{const r=await tt.register({email:t,password:s,username:n||void 0,display_name:a||void 0});if(r.needsEmailVerification){u.success("Account created! Please check your email to verify."),Qt="login";const c=e.parentElement,l=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);l&&(l.textContent=An()),En(c)}else u.success("Account created successfully"),Mn.onSuccess?.(r.user),H(et),window.dispatchEvent(new CustomEvent("godmode:auth-success"))}catch(r){const c=r instanceof Error?r.message:"Registration failed";ct(i,c)}finally{nt(e,!1)}}async function lx(e){const t=e.querySelector("#forgot-email").value.trim(),n=e.querySelector("#forgot-error");nt(e,!0),Qn(n);try{await tt.forgotPassword(t),u.success("If an account exists with this email, you will receive a reset link."),Qt="login";const a=e.parentElement,s=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);s&&(s.textContent=An()),En(a)}catch{u.success("If an account exists with this email, you will receive a reset link.")}finally{nt(e,!1)}}async function dx(e){const t=e.querySelector("#reset-password").value,n=e.querySelector("#reset-confirm").value,a=e.querySelector("#reset-error");if(t!==n){ct(a,"Passwords do not match");return}if(t.length<12){ct(a,"Password must be at least 12 characters");return}if(!Mn.resetToken){ct(a,"Invalid reset token. Please request a new reset link.");return}nt(e,!0),Qn(a);try{await tt.resetPassword(t,Mn.resetToken),u.success("Password reset successfully. You can now sign in."),Qt="login";const s=e.parentElement,o=document.querySelector(`[data-modal-id="${et}"] .modal-header h3`);o&&(o.textContent=An()),En(s)}catch(s){const o=s instanceof Error?s.message:"Password reset failed";ct(a,o)}finally{nt(e,!1)}}function nt(e,t){const n=e.querySelector('button[type="submit"]'),a=e.querySelectorAll("input"),s=n.querySelector(".btn-text"),o=n.querySelector(".btn-loading");n.disabled=t,a.forEach(i=>i.disabled=t),s&&o&&(s.style.display=t?"none":"",o.style.display=t?"":"none")}function ct(e,t){e.textContent=t,e.style.display="block"}function Qn(e){e.style.display="none",e.textContent=""}function Sd(e,t="password-strength"){const n=document.getElementById(t);if(!n)return;const a=px(e);n.className=`password-strength strength-${a.level}`,n.innerHTML=`
    <div class="strength-bar">
      <div class="strength-fill" style="width: ${a.score}%"></div>
    </div>
    <span class="strength-label">${a.label}</span>
  `}function px(e){let t=0;return e.length>=12&&(t+=25),e.length>=16&&(t+=15),/[a-z]/.test(e)&&(t+=15),/[A-Z]/.test(e)&&(t+=15),/[0-9]/.test(e)&&(t+=15),/[^a-zA-Z0-9]/.test(e)&&(t+=15),t<30?{level:"weak",score:t,label:"Weak"}:t<60?{level:"fair",score:t,label:"Fair"}:t<80?{level:"good",score:t,label:"Good"}:{level:"strong",score:Math.min(t,100),label:"Strong"}}function ux(){H(et)}const hn="contact-modal";let Cd=null,Js=[],ca=[],wi=[],fs=[],ka=[];function Vt(e){const{mode:t,contact:n}=e;Cd=n||null;const a=document.querySelector(`[data-modal-id="${hn}"]`);a&&a.remove();const s=mx(t,n),o=fe({id:hn,title:"",content:s,size:"lg"}),i=o.querySelector(".modal-content");i&&(i.style.cssText="background: transparent; box-shadow: none; padding: 0; max-width: 900px;");const r=o.querySelector(".modal-header");r&&(r.style.display="none"),document.body.appendChild(o),he(hn),t==="edit"&&n?.id?gx(s,n.id):(vx(s),hx(s),fx(s)),yx(s,e)}function mx(e,t){const n=x("div",{className:"contact-modal-sota"}),a=e==="edit",s=t?Xa(t.name):"?",o=!!(t?.photoUrl||t?.avatarUrl),i=t?.photoUrl||t?.avatarUrl;return n.innerHTML=`
    <style>
      .contact-modal-sota {
        background: var(--bg-primary);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      }

      /* Header */
      .contact-modal-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 50%, #9f1239 100%);
        padding: 32px 32px 24px;
        position: relative;
      }

      .contact-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.2s;
      }

      .contact-modal-close:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
      }

      .contact-modal-close svg {
        width: 20px;
        height: 20px;
      }

      .contact-header-content {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .contact-avatar-large {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 700;
        color: white;
        border: 4px solid rgba(255,255,255,0.3);
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .contact-avatar-large:hover {
        border-color: rgba(255,255,255,0.5);
      }

      .contact-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .contact-avatar-large .avatar-upload-hint {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .contact-avatar-large:hover .avatar-upload-hint {
        opacity: 1;
      }

      .contact-avatar-large .avatar-upload-hint svg {
        width: 28px;
        height: 28px;
        color: white;
      }

      .contact-header-info {
        flex: 1;
        color: white;
      }

      .contact-header-info h2 {
        margin: 0 0 4px 0;
        font-size: 26px;
        font-weight: 700;
      }

      .contact-header-info p {
        margin: 0;
        font-size: 15px;
        opacity: 0.85;
      }

      .contact-header-actions {
        display: flex;
        gap: 10px;
      }

      .header-action-btn {
        padding: 10px 16px;
        border-radius: 10px;
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .header-action-btn:hover {
        background: rgba(255,255,255,0.25);
      }

      .header-action-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Tabs */
      .contact-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        padding: 0 32px;
        background: var(--bg-secondary);
      }

      .contact-tab-btn {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        transition: color 0.2s;
      }

      .contact-tab-btn:hover {
        color: var(--text-primary);
      }

      .contact-tab-btn.active {
        color: #e11d48;
      }

      .contact-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #e11d48, #f59e0b);
        border-radius: 3px 3px 0 0;
      }

      .contact-tab-btn svg {
        width: 16px;
        height: 16px;
      }

      .contact-tab-btn .tab-count {
        background: rgba(225,29,72,0.1);
        color: #e11d48;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
      }

      /* Tab Content */
      .contact-tab-content {
        padding: 28px 32px;
        min-height: 400px;
        max-height: 500px;
        overflow-y: auto;
      }

      .contact-section {
        display: none;
      }

      .contact-section.active {
        display: block;
      }

      /* Form Styles */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .form-grid.full {
        grid-template-columns: 1fr;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-field.full-width {
        grid-column: 1 / -1;
      }

      .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .form-field label svg {
        width: 14px;
        height: 14px;
        color: #e11d48;
      }

      .form-field input,
      .form-field textarea,
      .form-field select {
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s;
      }

      .form-field input:focus,
      .form-field textarea:focus,
      .form-field select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
      }

      .form-field textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-hint {
        font-size: 12px;
        color: var(--text-tertiary);
      }

      /* Projects Section */
      .projects-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .project-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        transition: all 0.2s;
      }

      .project-item:hover {
        border-color: rgba(225,29,72,0.3);
      }

      .project-checkbox {
        width: 20px;
        height: 20px;
        accent-color: #e11d48;
      }

      .project-item label {
        flex: 1;
        font-size: 14px;
        color: var(--text-primary);
        cursor: pointer;
      }

      .project-item .primary-badge {
        padding: 3px 8px;
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
      }

      /* Relations Section */
      .relations-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .relation-card {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        transition: all 0.2s;
      }

      .relation-card:hover {
        border-color: rgba(225,29,72,0.3);
        transform: translateX(4px);
      }

      .relation-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: white;
        overflow: hidden;
      }

      .relation-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .relation-info {
        flex: 1;
      }

      .relation-info h4 {
        margin: 0 0 2px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .relation-info p {
        margin: 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .relation-type {
        padding: 4px 10px;
        background: rgba(99,102,241,0.1);
        color: #6366f1;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
      }

      .add-relation-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        background: var(--bg-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .add-relation-btn:hover {
        border-color: #e11d48;
        color: #e11d48;
      }

      .add-relation-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Activity Section */
      .activity-timeline {
        position: relative;
        padding-left: 28px;
      }

      .activity-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
      }

      .activity-item {
        position: relative;
        padding-bottom: 20px;
      }

      .activity-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e11d48;
        border: 2px solid var(--bg-primary);
      }

      .activity-item.email::before { background: #3b82f6; }
      .activity-item.meeting::before { background: #10b981; }
      .activity-item.note::before { background: #f59e0b; }

      .activity-time {
        font-size: 11px;
        color: var(--text-tertiary);
        margin-bottom: 4px;
      }

      .activity-content {
        font-size: 14px;
        color: var(--text-primary);
        line-height: 1.5;
      }

      .activity-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .activity-empty svg {
        width: 48px;
        height: 48px;
        opacity: 0.4;
        margin-bottom: 12px;
      }

      /* Footer */
      .contact-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 32px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }

      .footer-left {
        display: flex;
        gap: 10px;
      }

      .footer-right {
        display: flex;
        gap: 10px;
      }

      .btn-sota {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }

      .btn-sota.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(225,29,72,0.4);
      }

      .btn-sota.secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-sota.secondary:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
      }

      .btn-sota.danger {
        background: transparent;
        color: #dc2626;
        border: 1px solid #dc2626;
      }

      .btn-sota.danger:hover {
        background: #dc2626;
        color: white;
      }

      .btn-sota svg {
        width: 16px;
        height: 16px;
      }

      .btn-sota:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Loading */
      .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .loading-spinner::after {
        content: '';
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 12px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>

    <!-- Header -->
    <div class="contact-modal-header">
      <button class="contact-modal-close" id="close-contact-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <div class="contact-header-content">
        <div class="contact-avatar-large" id="contact-avatar-upload">
          ${o?`<img src="${i}" alt="">`:`<span>${s}</span>`}
          <div class="avatar-upload-hint">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
        </div>

        <div class="contact-header-info">
          <h2 id="header-contact-name">${a?Se(t?.name||""):"New Contact"}</h2>
          <p id="header-contact-org">${a&&t?.organization?Se(t.organization):"Add organization"}</p>
        </div>

        ${a?`
          <div class="contact-header-actions">
            <button class="header-action-btn" id="enrich-ai-btn" title="Enrich with AI">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Enrich with AI
            </button>
          </div>
        `:""}
      </div>
    </div>

    <!-- Tabs -->
    <div class="contact-tabs">
      <button class="contact-tab-btn active" data-tab="info">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        Info
      </button>
      <button class="contact-tab-btn" data-tab="projects">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        Projects
        <span class="tab-count" id="projects-count">0</span>
      </button>
      <button class="contact-tab-btn" data-tab="relations">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        Relations
        <span class="tab-count" id="relations-count">0</span>
      </button>
      <button class="contact-tab-btn" data-tab="activity">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Activity
      </button>
    </div>

    <!-- Tab Content -->
    <div class="contact-tab-content">
      <!-- Info Section -->
      <div class="contact-section active" id="section-info">
        <form id="contact-form">
          <div class="form-grid">
            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Name *
              </label>
              <input type="text" id="contact-name" required value="${Se(t?.name||"")}" placeholder="Full name">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Role
              </label>
              <select id="contact-role">
                <option value="">-- Select role --</option>
                <option value="__custom__">Custom role...</option>
              </select>
              <input type="text" id="contact-role-custom" placeholder="Enter custom role" style="display: none; margin-top: 8px;" value="${t?.role&&!ka.some(r=>r.display_name===t.role)?Se(t.role):""}">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Email
              </label>
              <input type="email" id="contact-email" value="${Se(t?.email||"")}" placeholder="email@example.com">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                Phone
              </label>
              <input type="tel" id="contact-phone" value="${Se(t?.phone||"")}" placeholder="+1 234 567 890">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Organization
              </label>
              <input type="text" id="contact-organization" value="${Se(t?.organization||t?.company||"")}" placeholder="Company name">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                </svg>
                LinkedIn
              </label>
              <input type="url" id="contact-linkedin" value="${Se(t?.linkedin||"")}" placeholder="https://linkedin.com/in/...">
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Avatar URL
              </label>
              <input type="url" id="contact-avatar-url" value="${Se(t?.photoUrl||t?.avatarUrl||t?.photo_url||t?.avatar_url||"")}" placeholder="https://example.com/photo.jpg">
              <div class="form-hint">Enter a URL to set the contact's profile picture</div>
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Department
              </label>
              <input type="text" id="contact-department" value="${Se(t?.department||"")}" placeholder="Engineering, Sales, etc.">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Location
              </label>
              <input type="text" id="contact-location" value="${Se(t?.location||"")}" placeholder="City, Country">
            </div>

            <div class="form-field">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Timezone
              </label>
              <select id="contact-timezone" data-current="${Se(t?.timezone||"")}">
                <option value="">Select timezone...</option>
              </select>
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Aliases
              </label>
              <input type="text" id="contact-aliases" value="${t?.aliases?.join(", ")||""}" placeholder="Alternative names (comma separated)">
              <div class="form-hint">Names used to identify this person in documents (e.g., "Luuc" for "Luuk")</div>
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Notes
              </label>
              <textarea id="contact-notes" placeholder="Additional notes about this contact...">${Se(t?.notes||"")}</textarea>
            </div>

            <div class="form-field full-width">
              <label>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                Tags
              </label>
              <input type="text" id="contact-tags" value="${t?.tags?.join(", ")||""}" placeholder="client, vip, technical (comma separated)">
              <div class="form-hint">Separate tags with commas</div>
            </div>
          </div>
        </form>
      </div>

      <!-- Projects Section -->
      <div class="contact-section" id="section-projects">
        <div class="projects-list" id="projects-list">
          <div class="loading-spinner">Loading projects</div>
        </div>
      </div>

      <!-- Relations Section -->
      <div class="contact-section" id="section-relations">
        <div class="relations-list" id="relations-list">
          <div class="loading-spinner">Loading relations</div>
        </div>
        <button class="add-relation-btn" id="add-relation-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Relationship
        </button>
      </div>

      <!-- Activity Section -->
      <div class="contact-section" id="section-activity">
        <div class="activity-timeline" id="activity-timeline">
          <div class="loading-spinner">Loading activity</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="contact-modal-footer">
      <div class="footer-left">
        ${a?`
          <button class="btn-sota danger" id="delete-contact-btn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete
          </button>
        `:""}
      </div>
      <div class="footer-right">
        <button class="btn-sota secondary" id="cancel-contact-btn">Cancel</button>
        <button class="btn-sota primary" id="save-contact-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          ${a?"Save Changes":"Create Contact"}
        </button>
      </div>
    </div>
  `,n}async function gx(e,t){try{const[n,a,s,o,i,r]=await Promise.all([p.get(`/api/contacts/${t}/projects`).catch(()=>({data:{projects:[]}})),p.get(`/api/contacts/${t}/relationships`).catch(()=>({data:{relationships:[]}})),p.get(`/api/contacts/${t}/activity`).catch(()=>({data:{activities:[]}})),p.get("/api/role-templates").catch(()=>({data:{roles:[]}})),p.get("/api/projects").catch(()=>({data:{projects:[]}})),p.get("/api/timezones").catch(()=>({data:{timezones:[]}}))]);Js=n.data?.projects||[],ca=a.data?.relationships||[],wi=s.data?.activities||[],ka=o.data?.roles||[],fs=i.data?.projects||[];const c=r.data?.timezones||[];Ld(e,c),Md(e),qd(e),Td(e),bx(e),Ad(e)}catch(n){console.error("Failed to load contact data:",n)}}async function vx(e){try{ka=(await p.get("/api/role-templates")).data?.roles||[],Md(e)}catch{ka=[]}}async function fx(e){try{const n=(await p.get("/api/timezones")).data?.timezones||[];Ld(e,n)}catch{}}async function hx(e){try{fs=(await p.get("/api/projects")).data?.projects||[],qd(e)}catch{fs=[]}}function Ld(e,t){const n=e.querySelector("#contact-timezone");if(!n)return;const a=n.dataset.current||"",s={};for(const i of t){const r=i.code.includes("/")?i.code.split("/")[0]:"Other";s[r]||(s[r]=[]),s[r].push(i)}const o=Object.keys(s).sort();n.innerHTML=`
    <option value="">Select timezone...</option>
    ${o.map(i=>`
      <optgroup label="${i}">
        ${s[i].map(r=>`
          <option value="${Se(r.code)}" ${a===r.code?"selected":""}>
            ${Se(r.name||r.code)} (${r.utc_offset})
          </option>
        `).join("")}
      </optgroup>
    `).join("")}
  `}function Md(e){const t=e.querySelector("#contact-role"),n=e.querySelector("#contact-role-custom");if(!t)return;const a=Cd?.role,s=a&&!ka.some(o=>o.display_name===a||o.name===a);t.innerHTML=`
    <option value="">-- Select role --</option>
    ${ka.filter(o=>o.is_active).map(o=>`
      <option value="${Se(o.display_name||o.name)}" ${a===o.display_name||a===o.name?"selected":""}>
        ${Se(o.display_name||o.name)}
      </option>
    `).join("")}
    <option value="__custom__" ${s?"selected":""}>Custom role...</option>
  `,s&&n&&(n.style.display="block",n.value=a),d(t,"change",()=>{const o=t.value==="__custom__";n.style.display=o?"block":"none",o&&n.focus()})}function qd(e){const t=e.querySelector("#projects-list");if(!t)return;if(fs.length===0){t.innerHTML='<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No projects available</p>';return}const n=new Set(Js.map(a=>a.id));t.innerHTML=fs.map(a=>`
    <div class="project-item">
      <input type="checkbox" class="project-checkbox" name="contact-project" value="${a.id}" 
             ${n.has(a.id)?"checked":""}>
      <label>${Se(a.name)}</label>
      ${Js.find(s=>s.id===a.id)?.is_primary?'<span class="primary-badge">Primary</span>':""}
    </div>
  `).join(""),e.querySelector("#projects-count").textContent=String(n.size)}function Td(e){const t=e.querySelector("#relations-list");if(t){if(ca.length===0){t.innerHTML=`
      <div class="activity-empty">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <p>No relationships yet</p>
      </div>
    `;return}t.innerHTML=ca.map(n=>{const a=n.to_contact,s=a?Xa(a.name):"?";return`
      <div class="relation-card" data-id="${n.id}">
        <div class="relation-avatar">
          ${a?.avatar_url?`<img src="${a.avatar_url}" alt="">`:s}
        </div>
        <div class="relation-info">
          <h4>${Se(a?.name||"Unknown")}</h4>
          <p>${Se(a?.organization||a?.role||"")}</p>
        </div>
        <span class="relation-type">${wx(n.relationship_type)}</span>
      </div>
    `}).join(""),e.querySelector("#relations-count").textContent=String(ca.length)}}function bx(e){const t=e.querySelector("#activity-timeline");if(t){if(wi.length===0){t.innerHTML=`
      <div class="activity-empty">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No activity recorded yet</p>
      </div>
    `;return}t.innerHTML=wi.map(n=>`
    <div class="activity-item ${n.activity_type}">
      <div class="activity-time">${kx(n.occurred_at)}</div>
      <div class="activity-content">${Se(n.description)}</div>
    </div>
  `).join("")}}function Ad(e){const t=e.querySelector("#projects-count"),n=e.querySelector("#relations-count");t&&(t.textContent=String(Js.length)),n&&(n.textContent=String(ca.length))}function yx(e,t){const{mode:n,contact:a,onSave:s,onDelete:o}=t,i=n==="edit",r=e.querySelector("#close-contact-btn");r&&d(r,"click",()=>H(hn));const c=e.querySelector("#cancel-contact-btn");c&&d(c,"click",()=>H(hn));const l=e.querySelectorAll(".contact-tab-btn");l.forEach(S=>{d(S,"click",()=>{l.forEach(R=>R.classList.remove("active")),S.classList.add("active");const L=S.getAttribute("data-tab");e.querySelectorAll(".contact-section").forEach(R=>{R.classList.toggle("active",R.id===`section-${L}`)})})});const m=e.querySelector("#save-contact-btn");m&&d(m,"click",async()=>{const S=e.querySelector("#contact-form");if(!S.checkValidity()){S.reportValidity();return}const L=te=>e.querySelector(`#${te}`)?.value.trim()||"",R=e.querySelector("#contact-role"),Z=e.querySelector("#contact-role-custom"),ee=R.value==="__custom__"?Z.value.trim():R.value,le=L("contact-tags"),ae=le?le.split(",").map(te=>te.trim()).filter(Boolean):[],X=L("contact-aliases"),ie=X?X.split(",").map(te=>te.trim()).filter(Boolean):[],U={id:a?.id||`contact-${Date.now()}`,name:L("contact-name"),email:L("contact-email")||void 0,phone:L("contact-phone")||void 0,organization:L("contact-organization")||void 0,company:L("contact-organization")||void 0,role:ee||void 0,department:L("contact-department")||void 0,linkedin:L("contact-linkedin")||void 0,location:L("contact-location")||void 0,timezone:L("contact-timezone")||void 0,photoUrl:L("contact-avatar-url")||void 0,avatarUrl:L("contact-avatar-url")||void 0,aliases:ie.length>0?ie:void 0,notes:L("contact-notes")||void 0,tags:ae.length>0?ae:void 0},Q=[];e.querySelectorAll('input[name="contact-project"]:checked').forEach(te=>{Q.push(te.value)}),m.disabled=!0,m.textContent="Saving...";try{let te=a?.id;if(i)await p.put(`/api/contacts/${a.id}`,U),u.success("Contact updated");else{const de=await p.post("/api/contacts",U);U.id=de.data.id,te=de.data.id,u.success("Contact created")}if(te&&Q.length>=0)try{await p.post(`/api/contacts/${te}/projects/sync`,{projectIds:Q})}catch(de){console.warn("Failed to sync project associations:",de)}s?.(U),H(hn)}catch{u.error("Failed to save contact")}finally{m.disabled=!1,m.innerHTML=`
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          ${i?"Save Changes":"Create Contact"}
        `}});const v=e.querySelector("#delete-contact-btn");v&&i&&d(v,"click",async()=>{if(await Ln(`Are you sure you want to delete "${a.name}"?`,{title:"Delete Contact",confirmText:"Delete",confirmClass:"btn-danger"}))try{await p.delete(`/api/contacts/${a.id}`),u.success("Contact deleted"),o?.(a.id),H(hn)}catch{u.error("Failed to delete contact")}});const g=e.querySelector("#enrich-ai-btn");g&&i&&d(g,"click",async()=>{u.info("AI enrichment is processing...");try{await p.post(`/api/contacts/${a.id}/enrich`),u.success("Contact enriched! Refreshing..."),H(hn);const S=await p.get(`/api/contacts/${a.id}`);Vt({...t,contact:S.data.contact})}catch{u.error("AI enrichment failed")}});const f=e.querySelector("#add-relation-btn");f&&a?.id&&d(f,"click",()=>{xx(e,a.id)});const b=e.querySelector("#contact-name"),w=e.querySelector("#contact-organization"),$=e.querySelector("#header-contact-name"),M=e.querySelector("#header-contact-org");b&&$&&d(b,"input",()=>{$.textContent=b.value||"New Contact";const S=e.querySelector(".contact-avatar-large");if(S&&!S.querySelector("img")){const L=S.querySelector("span");L&&(L.textContent=Xa(b.value||"?"))}}),w&&M&&d(w,"input",()=>{M.textContent=w.value||"Add organization"});const q=e.querySelector("#contact-avatar-url"),C=e.querySelector(".contact-avatar-large");q&&C&&d(q,"input",()=>{const S=q.value.trim();if(S){const L=new Image;L.onload=()=>{C.innerHTML=`
            <img src="${S}" alt="">
            <div class="avatar-upload-hint">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
          `},L.onerror=()=>{const R=e.querySelector("#contact-name")?.value||"?";C.innerHTML=`
            <span>${Xa(R)}</span>
            <div class="avatar-upload-hint">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
          `},L.src=S}else{const L=e.querySelector("#contact-name")?.value||"?";C.innerHTML=`
          <span>${Xa(L)}</span>
          <div class="avatar-upload-hint">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
        `}})}async function xx(e,t,n){let a=[];try{a=((await p.get("/api/contacts")).data?.contacts||[]).filter(v=>v.id!==t)}catch{u.error("Failed to load contacts");return}if(a.length===0){u.info("No other contacts available to create a relationship");return}const s=x("div",{className:"relation-dialog-overlay"});s.innerHTML=`
    <style>
      .relation-dialog-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .relation-dialog {
        background: var(--bg-primary);
        border-radius: 16px;
        padding: 24px;
        width: 400px;
        max-width: 90vw;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        animation: slideUp 0.2s ease;
      }
      
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .relation-dialog h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .relation-dialog h3 svg {
        width: 22px;
        height: 22px;
        color: #e11d48;
      }
      
      .relation-dialog-field {
        margin-bottom: 16px;
      }
      
      .relation-dialog-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }
      
      .relation-dialog-field select {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
      }
      
      .relation-dialog-field select:focus {
        outline: none;
        border-color: #e11d48;
      }
      
      .relation-dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 24px;
      }
      
      .relation-dialog-actions button {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .relation-dialog-actions .cancel-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }
      
      .relation-dialog-actions .cancel-btn:hover {
        background: var(--bg-tertiary);
      }
      
      .relation-dialog-actions .save-btn {
        background: linear-gradient(135deg, #e11d48, #be123c);
        border: none;
        color: white;
      }
      
      .relation-dialog-actions .save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }
      
      .relation-dialog-actions .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
    </style>
    
    <div class="relation-dialog">
      <h3>
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        Add Relationship
      </h3>
      
      <div class="relation-dialog-field">
        <label>Related Contact</label>
        <select id="rel-contact-select">
          <option value="">-- Select contact --</option>
          ${a.map(m=>`
            <option value="${m.id}">${Se(m.name)}${m.organization?` (${Se(m.organization)})`:""}</option>
          `).join("")}
        </select>
      </div>
      
      <div class="relation-dialog-field">
        <label>Relationship Type</label>
        <select id="rel-type-select">
          <option value="">-- Select type --</option>
          <option value="reports_to">Reports to</option>
          <option value="manages">Manages</option>
          <option value="works_with">Works with</option>
          <option value="knows">Knows</option>
          <option value="referred_by">Referred by</option>
        </select>
      </div>
      
      <div class="relation-dialog-actions">
        <button class="cancel-btn" id="rel-cancel-btn">Cancel</button>
        <button class="save-btn" id="rel-save-btn">Add Relationship</button>
      </div>
    </div>
  `,document.body.appendChild(s);const o=s.querySelector("#rel-cancel-btn"),i=s.querySelector("#rel-save-btn"),r=s.querySelector("#rel-contact-select"),c=s.querySelector("#rel-type-select"),l=()=>s.remove();d(o,"click",l),d(s,"click",m=>{m.target===s&&l()}),d(i,"click",async()=>{const m=r.value,v=c.value;if(!m||!v){u.error("Please select both a contact and relationship type");return}i.disabled=!0,i.textContent="Saving...";try{await p.post(`/api/contacts/${t}/relationships`,{toContactId:m,type:v}),u.success("Relationship added"),l(),ca=(await p.get(`/api/contacts/${t}/relationships`)).data?.relationships||[],Td(e),Ad(e)}catch(g){const f=g instanceof Error?g.message:"Failed to add relationship";u.error(f),i.disabled=!1,i.textContent="Add Relationship"}})}function Xa(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)||"?"}function Se(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function wx(e){return{reports_to:"Reports to",manages:"Manages",works_with:"Works with",knows:"Knows",referred_by:"Referred by"}[e]||e.replace(/_/g," ")}function kx(e){const t=new Date(e),a=new Date().getTime()-t.getTime(),s=Math.floor(a/(1e3*60*60*24));return s===0?"Today":s===1?"Yesterday":s<7?`${s} days ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}const ja="team-modal";let Jn=[];async function Zs(e){const{projectId:t,onInvite:n,onRemove:a,onRoleChange:s}=e,o=document.querySelector(`[data-modal-id="${ja}"]`);o&&o.remove();const i=x("div",{className:"team-modal-content"});i.innerHTML='<div class="loading">Loading team members...</div>';const r=x("div",{className:"modal-footer"}),c=x("button",{className:"btn btn-primary",textContent:"Invite Member"}),l=x("button",{className:"btn btn-secondary",textContent:"Close"});d(l,"click",()=>H(ja)),d(c,"click",()=>{H(ja),n?.()}),r.appendChild(l),r.appendChild(c);const m=fe({id:ja,title:"Team Members",content:i,size:"lg",footer:r});document.body.appendChild(m),he(ja);try{Jn=(await p.get(`/api/projects/${t}/members`)).data,Ed(i,e)}catch{i.innerHTML='<div class="error">Failed to load team members</div>'}}function Ed(e,t){if(Jn.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No team members yet</p>
        <p class="text-muted">Invite members to collaborate on this project</p>
      </div>
    `;return}e.innerHTML=`
    <div class="team-list">
      ${Jn.map(n=>$x(n)).join("")}
    </div>
  `,e.querySelectorAll(".member-card").forEach(n=>{const a=n.getAttribute("data-member-id");if(!a)return;const s=Jn.find(r=>r.id===a);if(!s)return;const o=n.querySelector(".role-select");o&&d(o,"change",async()=>{const r=o.value;try{await p.patch(`/api/projects/${t.projectId}/members/${a}`,{role:r}),s.role=r,u.success("Role updated"),t.onRoleChange?.(a,r)}catch{o.value=s.role}});const i=n.querySelector(".btn-remove");i&&d(i,"click",async()=>{const{confirm:r}=await Y(async()=>{const{confirm:l}=await Promise.resolve().then(()=>Gt);return{confirm:l}},void 0);if(await r(`Remove ${s.name} from this project?`,{title:"Remove Member",confirmText:"Remove",confirmClass:"btn-danger"}))try{await p.delete(`/api/projects/${t.projectId}/members/${a}`),Jn=Jn.filter(l=>l.id!==a),Ed(e,t),u.success("Member removed"),t.onRemove?.(a)}catch{}})})}function $x(e){const t=e.name.split(" ").map(a=>a[0]).join("").toUpperCase().slice(0,2),n=e.role==="superadmin";return`
    <div class="member-card" data-member-id="${e.id}">
      <div class="member-avatar">
        ${e.avatarUrl?`<img src="${e.avatarUrl}" alt="${Io(e.name)}">`:t}
      </div>
      <div class="member-info">
        <div class="member-name">${Io(e.name)}</div>
        <div class="member-email">${Io(e.email)}</div>
      </div>
      <div class="member-role">
        ${n?'<span class="role-badge superadmin">Owner</span>':`<select class="role-select form-control">
              <option value="admin" ${e.role==="admin"?"selected":""}>Admin</option>
              <option value="member" ${e.role==="member"?"selected":""}>Member</option>
            </select>`}
      </div>
      <div class="member-actions">
        ${n?"":'<button class="btn btn-sm btn-danger btn-remove" title="Remove member">‚úï</button>'}
      </div>
    </div>
  `}function Io(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const jn="invite-modal";let ki=[];function pr(e){const{projectId:t,onInviteSent:n}=e,a=document.querySelector(`[data-modal-id="${jn}"]`);a&&a.remove();const s=x("div",{className:"invite-modal-content"});s.innerHTML=`
    <style>
      .invite-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color, #e2e8f0);
      }
      
      .invite-tab-btn {
        flex: 1;
        padding: 12px 16px;
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary, #64748b);
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }
      
      .invite-tab-btn:hover {
        color: var(--text-primary, #1e293b);
      }
      
      .invite-tab-btn.active {
        color: #e11d48;
      }
      
      .invite-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e11d48;
      }
      
      .invite-tab-content {
        display: none;
      }
      
      .invite-tab-content.active {
        display: block;
      }
      
      .contacts-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        margin-bottom: 16px;
      }
      
      .contact-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid var(--border-color, #e2e8f0);
      }
      
      .contact-option:last-child {
        border-bottom: none;
      }
      
      .contact-option:hover {
        background: var(--bg-secondary, #f8fafc);
      }
      
      .contact-option.selected {
        background: linear-gradient(135deg, rgba(225,29,72,0.08) 0%, rgba(225,29,72,0.04) 100%);
      }
      
      .contact-option input[type="radio"] {
        display: none;
      }
      
      .contact-option .radio-circle {
        width: 18px;
        height: 18px;
        border: 2px solid var(--border-color, #cbd5e1);
        border-radius: 50%;
        flex-shrink: 0;
        position: relative;
        transition: all 0.2s;
      }
      
      .contact-option.selected .radio-circle {
        border-color: #e11d48;
      }
      
      .contact-option.selected .radio-circle::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 8px;
        height: 8px;
        background: #e11d48;
        border-radius: 50%;
      }
      
      .contact-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
        overflow: hidden;
      }
      
      .contact-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      
      .contact-name {
        font-weight: 500;
        color: var(--text-primary, #1e293b);
        margin-bottom: 2px;
      }
      
      .contact-email {
        font-size: 12px;
        color: var(--text-secondary, #64748b);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .no-contacts-msg {
        padding: 24px;
        text-align: center;
        color: var(--text-secondary, #64748b);
      }
      
      .email-status {
        margin-top: 8px;
        padding: 8px 12px;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        font-size: 12px;
        color: #166534;
        display: none;
      }
      
      .email-status.show {
        display: block;
      }
      
      .email-status.error {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }
    </style>
    
    <!-- Tabs -->
    <div class="invite-tabs">
      <button type="button" class="invite-tab-btn active" data-tab="new">
        New Email
      </button>
      <button type="button" class="invite-tab-btn" data-tab="contacts">
        Existing Contacts
      </button>
    </div>
    
    <!-- Tab: New Email -->
    <div class="invite-tab-content active" id="tab-new">
      <form id="invite-form" class="invite-form">
        <div class="form-group">
          <label for="invite-email">Email Address *</label>
          <input type="email" id="invite-email" required 
                 placeholder="colleague@example.com">
          <div class="form-hint">They will receive an email invitation to join this project</div>
        </div>
        
        <div class="form-group">
          <label for="invite-role">Access Level</label>
          <select id="invite-role">
            <option value="read">Viewer - Can view data only</option>
            <option value="write" selected>Member - Can view and edit data</option>
            <option value="admin">Admin - Can manage team and settings</option>
          </select>
          <div class="form-hint" style="margin-top: 4px;">You can assign a project role after they join.</div>
        </div>
        
        <div class="form-group">
          <label for="invite-message">Personal Message (optional)</label>
          <textarea id="invite-message" rows="2" 
                    placeholder="Add a personal note to the invitation..."></textarea>
        </div>
        
        <div class="email-status" id="email-status"></div>
      </form>
    </div>
    
    <!-- Tab: Existing Contacts -->
    <div class="invite-tab-content" id="tab-contacts">
      <div id="contacts-list" class="contacts-list">
        <div class="no-contacts-msg">Loading contacts...</div>
      </div>
      
      <div class="form-group">
        <label for="invite-role-contact">Access Level</label>
        <select id="invite-role-contact">
          <option value="read">Viewer - Can view data only</option>
          <option value="write" selected>Member - Can view and edit data</option>
          <option value="admin">Admin - Can manage team and settings</option>
        </select>
      </div>
      
      <div class="add-options" style="display: flex; gap: 12px; margin-top: 16px;">
        <button type="button" id="btn-add-direct" class="btn btn-primary" style="flex: 1;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <line x1="20" y1="8" x2="20" y2="14"/>
            <line x1="23" y1="11" x2="17" y2="11"/>
          </svg>
          Add to Team
        </button>
        <button type="button" id="btn-send-invite" class="btn btn-secondary" style="flex: 1;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          Send Invitation
        </button>
      </div>
      <div class="form-hint" style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        <strong>Add to Team:</strong> Adds contact as team member directly (no email sent)<br>
        <strong>Send Invitation:</strong> Sends an email invitation to join
      </div>
      
      <div class="email-status" id="email-status-contact"></div>
    </div>
    
    <div class="invite-link-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color, #e2e8f0);">
      <h4 style="margin: 0 0 8px; font-size: 13px; color: var(--text-secondary, #64748b);">Or share invite link</h4>
      <div class="input-group" style="display: flex; gap: 8px;">
        <input type="text" id="invite-link" readonly 
               value="Generating link..." class="form-control" style="flex: 1;">
        <button type="button" id="btn-copy-link" class="btn btn-secondary">Copy</button>
      </div>
    </div>
  `;let o="new",i=null;const r=x("div",{className:"modal-footer"}),c=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=x("button",{className:"btn btn-primary",textContent:"Send Invitation"});d(c,"click",()=>H(jn)),d(l,"click",async()=>{if(o!=="new")return;const g=s.querySelector("#invite-form");if(!g.checkValidity()){g.reportValidity();return}const f=s.querySelector("#invite-email").value.trim(),b=s.querySelector("#invite-role").value,w=s.querySelector("#invite-message").value.trim();l.disabled=!0,l.textContent="Sending...";const $=s.querySelector("#email-status");try{(await p.post(`/api/projects/${t}/invites`,{email:f,role:b,message:w||void 0})).data.email_sent?($.textContent=`‚úì Invitation email sent to ${f}`,$.classList.remove("error"),$.classList.add("show")):($.textContent="Invitation created, but email could not be sent. Share the link manually.",$.classList.add("error","show")),u.success(`Invitation sent to ${f}`),n?.(f),setTimeout(()=>H(jn),1500)}catch{$.textContent="Failed to create invitation",$.classList.add("error","show")}finally{l.disabled=!1,l.textContent="Send Invitation"}}),r.appendChild(c),r.appendChild(l),setTimeout(()=>{const g=s.querySelector("#btn-add-direct"),f=s.querySelector("#btn-send-invite"),b=s.querySelector("#email-status-contact");g&&d(g,"click",async()=>{if(!i){u.error("Please select a contact");return}const w=s.querySelector("#invite-role-contact").value;g.disabled=!0,g.innerHTML='<span class="spinner"></span> Adding...';try{await p.post(`/api/projects/${t}/members/add-contact`,{contact_id:i.id,role:w}),b.textContent=`‚úì ${i.name} added to team`,b.classList.remove("error"),b.classList.add("show"),u.success(`${i.name} added to team`),n?.(i.email||i.name),setTimeout(()=>H(jn),1e3)}catch($){const M=$?.response?.data?.error||"Failed to add member";b.textContent=M,b.classList.add("error","show"),u.error(M)}finally{g.disabled=!1,g.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Add to Team
          `}}),f&&d(f,"click",async()=>{if(!i||!i.email){u.error("Please select a contact with an email address");return}const w=s.querySelector("#invite-role-contact").value;f.disabled=!0,f.innerHTML='<span class="spinner"></span> Sending...';try{(await p.post(`/api/projects/${t}/invites`,{email:i.email,role:w})).data.email_sent?(b.textContent=`‚úì Invitation email sent to ${i.email}`,b.classList.remove("error"),b.classList.add("show")):(b.textContent="Invitation created, but email could not be sent.",b.classList.add("error","show")),u.success(`Invitation sent to ${i.name}`),n?.(i.email),setTimeout(()=>H(jn),1500)}catch{b.textContent="Failed to send invitation",b.classList.add("error","show")}finally{f.disabled=!1,f.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            Send Invitation
          `}})},0);const m=fe({id:jn,title:"Invite Team Member",content:s,size:"md",footer:r});document.body.appendChild(m),he(jn),Sx(s,t);const v=s.querySelectorAll(".invite-tab-btn");v.forEach(g=>{d(g,"click",()=>{const f=g.getAttribute("data-tab")||"new";o=f,v.forEach(b=>b.classList.remove("active")),g.classList.add("active"),s.querySelectorAll(".invite-tab-content").forEach(b=>{b.classList.toggle("active",b.id===`tab-${f}`)})})}),Lx(s,t,g=>{i=g}),setTimeout(()=>{const g=s.querySelector("#btn-copy-link");g&&d(g,"click",()=>{const f=s.querySelector("#invite-link");navigator.clipboard.writeText(f.value).then(()=>{u.success("Link copied to clipboard")}).catch(()=>{f.select(),document.execCommand("copy"),u.success("Link copied")})})},0)}async function Sx(e,t){const n=e.querySelector("#invite-link");try{const a=await p.get(`/api/projects/${t}/invites/link`);n.value=a.data.link||a.data.invite_url||"Link not available"}catch{try{const a=await p.post(`/api/projects/${t}/invites`,{email:"",role:"member",generate_link_only:!0});a.data.invite_url?n.value=a.data.invite_url:n.value="Use email invitation instead"}catch{n.value="Use email invitation instead"}}}async function Cx(e){try{ki=(await p.get(`/api/projects/${e}/members`)).data.members||[]}catch(t){console.warn("[InviteModal] Failed to load project members:",t),ki=[]}}async function Lx(e,t,n){const a=e.querySelector("#contacts-list");if(a)try{await Cx(t);const o=(await p.get("/api/contacts")).data.contacts||[],i=new Set(ki.filter(l=>l.linked_contact_id).map(l=>l.linked_contact_id)),r=o.filter(l=>!i.has(l.id));if(r.length===0){a.innerHTML=`
        <div class="no-contacts-msg">
          ${i.size>0?"All contacts are already team members.":"No contacts found."}
          <br>
          <small style="opacity: 0.7;">Add contacts in the Contacts panel.</small>
        </div>
      `;return}a.innerHTML=r.map(l=>{const m=l.name.split(" ").map(b=>b[0]).join("").substring(0,2).toUpperCase(),v=l.avatar_url||l.photo_url,g=!!l.email,f=[l.email,l.organization].filter(Boolean).join(" ‚Ä¢ ")||l.role||"No email";return`
        <label class="contact-option" data-id="${l.id}" data-has-email="${g}">
          <input type="radio" name="contact-select" value="${l.id}">
          <span class="radio-circle"></span>
          <div class="contact-avatar">
            ${v?`<img src="${v}" alt="${Ro(l.name)}">`:m}
          </div>
          <div class="contact-info">
            <div class="contact-name">${Ro(l.name)}</div>
            <div class="contact-email">${Ro(f)}${g?"":' <span style="color: #f59e0b; font-size: 10px;">(no email)</span>'}</div>
          </div>
        </label>
      `}).join("");const c=a.querySelectorAll(".contact-option");c.forEach(l=>{d(l,"click",()=>{c.forEach(g=>g.classList.remove("selected")),l.classList.add("selected");const m=l.getAttribute("data-id"),v=r.find(g=>g.id===m)||null;n(v)})})}catch{a.innerHTML=`
      <div class="no-contacts-msg">
        Failed to load contacts
      </div>
    `}}function Ro(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Mx=Object.freeze(Object.defineProperty({__proto__:null,showInviteModal:pr},Symbol.toStringTag,{value:"Module"})),gn="role-modal",qx=["view:dashboard","view:chat","view:sot","view:contacts","edit:questions","edit:risks","edit:actions","edit:decisions","edit:contacts","manage:team","manage:settings","manage:roles","delete:data","export:data"];function _d(e){const{mode:t,role:n,availablePermissions:a=qx,onSave:s,onDelete:o}=e,i=t==="edit"&&n?.id,r=t==="view",c=document.querySelector(`[data-modal-id="${gn}"]`);c&&c.remove();const l=x("div",{className:"role-modal-content"});if(r&&n)l.innerHTML=`
      <div class="role-view">
        <div class="role-header-info">
          <div class="role-color-badge" style="background: ${n.color||"#e94560"}"></div>
          <div>
            <h3>${yc(n.name)}</h3>
            ${n.description?`<p class="text-muted">${yc(n.description)}</p>`:""}
          </div>
        </div>
        
        <div class="role-permissions">
          <h4>Permissions (${n.permissions.length})</h4>
          <div class="permissions-list">
            ${n.permissions.map(g=>`
              <span class="permission-tag">${bc(g)}</span>
            `).join("")}
          </div>
        </div>
        
        ${n.isDefault?'<p class="text-muted"><em>This is a system role and cannot be modified.</em></p>':""}
      </div>
    `;else{const g=n?.permissions||[];l.innerHTML=`
      <form id="role-form" class="role-form">
        <div class="form-row">
          <div class="form-group" style="flex: 1">
            <label for="role-name">Role Name *</label>
            <input type="text" id="role-name" required 
                   value="${n?.name||""}" 
                   placeholder="e.g., Project Manager">
          </div>
          <div class="form-group" style="width: 80px">
            <label for="role-color">Color</label>
            <input type="color" id="role-color" 
                   value="${n?.color||"#e94560"}">
          </div>
        </div>
        
        <div class="form-group">
          <label for="role-description">Description</label>
          <textarea id="role-description" rows="2" 
                    placeholder="Brief description of this role...">${n?.description||""}</textarea>
        </div>
        
        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-grid">
            ${a.map(f=>`
              <label class="permission-checkbox">
                <input type="checkbox" name="permissions" value="${f}" 
                       ${g.includes(f)?"checked":""}>
                <span>${bc(f)}</span>
              </label>
            `).join("")}
          </div>
        </div>
        
        <div class="form-group">
          <button type="button" class="btn btn-sm btn-secondary" data-action="select-all">Select All</button>
          <button type="button" class="btn btn-sm btn-secondary" data-action="select-none">Select None</button>
        </div>
      </form>
    `,setTimeout(()=>{const f=l.querySelector('[data-action="select-all"]'),b=l.querySelector('[data-action="select-none"]');f&&d(f,"click",()=>{l.querySelectorAll('[name="permissions"]').forEach(w=>{w.checked=!0})}),b&&d(b,"click",()=>{l.querySelectorAll('[name="permissions"]').forEach(w=>{w.checked=!1})})},0)}const m=x("div",{className:"modal-footer"});if(r){const g=x("button",{className:"btn btn-primary",textContent:"Edit"}),f=x("button",{className:"btn btn-secondary",textContent:"Close"});d(f,"click",()=>H(gn)),n?.isDefault||(d(g,"click",()=>{H(gn),_d({...e,mode:"edit"})}),m.appendChild(g)),m.appendChild(f)}else{const g=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),f=x("button",{className:"btn btn-primary",textContent:i?"Save Changes":"Create Role"});if(d(g,"click",()=>H(gn)),d(f,"click",async()=>{const b=l.querySelector("#role-form");if(!b.checkValidity()){b.reportValidity();return}const w=l.querySelector("#role-name").value.trim(),$=l.querySelector("#role-description").value.trim(),M=l.querySelector("#role-color").value,q=[];l.querySelectorAll('[name="permissions"]:checked').forEach(S=>{q.push(S.value)});const C={id:n?.id||`role-${Date.now()}`,name:w,description:$||void 0,color:M,permissions:q};f.disabled=!0,f.textContent="Saving...";try{if(i)await p.put(`/api/roles/${n.id}`,C),u.success("Role updated");else{const S=await p.post("/api/roles",C);C.id=S.data.id,u.success("Role created")}s?.(C),H(gn)}catch{}finally{f.disabled=!1,f.textContent=i?"Save Changes":"Create Role"}}),i&&!n?.isDefault){const b=x("button",{className:"btn btn-danger",textContent:"Delete"});d(b,"click",async()=>{const{confirm:w}=await Y(async()=>{const{confirm:M}=await Promise.resolve().then(()=>Gt);return{confirm:M}},void 0);if(await w(`Are you sure you want to delete the "${n.name}" role?`,{title:"Delete Role",confirmText:"Delete",confirmClass:"btn-danger"}))try{await p.delete(`/api/roles/${n.id}`),u.success("Role deleted"),o?.(n.id),H(gn)}catch{}}),m.appendChild(b)}m.appendChild(g),m.appendChild(f)}const v=fe({id:gn,title:r?"Role Details":i?"Edit Role":"New Role",content:l,size:"md",footer:m});document.body.appendChild(v),he(gn)}function bc(e){return e.replace(":",": ").split(/[_:]/).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}function yc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Da="export-modal";function Tx(e={}){const{defaultFormat:t="json",defaultScope:n="all"}=e,a=document.querySelector(`[data-modal-id="${Da}"]`);a&&a.remove();const s=x("div",{className:"export-modal-content"});s.innerHTML=`
    <div class="export-options">
      <div class="form-group">
        <label>What to Export</label>
        <div class="scope-options">
          <label class="radio-card ${n==="all"?"selected":""}">
            <input type="radio" name="export-scope" value="all" ${n==="all"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üì¶</span>
              <span class="label">Everything</span>
            </div>
          </label>
          <label class="radio-card ${n==="questions"?"selected":""}">
            <input type="radio" name="export-scope" value="questions" ${n==="questions"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">‚ùì</span>
              <span class="label">Questions</span>
            </div>
          </label>
          <label class="radio-card ${n==="risks"?"selected":""}">
            <input type="radio" name="export-scope" value="risks" ${n==="risks"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">‚ö†Ô∏è</span>
              <span class="label">Risks</span>
            </div>
          </label>
          <label class="radio-card ${n==="actions"?"selected":""}">
            <input type="radio" name="export-scope" value="actions" ${n==="actions"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">‚úÖ</span>
              <span class="label">Actions</span>
            </div>
          </label>
          <label class="radio-card ${n==="decisions"?"selected":""}">
            <input type="radio" name="export-scope" value="decisions" ${n==="decisions"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üéØ</span>
              <span class="label">Decisions</span>
            </div>
          </label>
          <label class="radio-card ${n==="contacts"?"selected":""}">
            <input type="radio" name="export-scope" value="contacts" ${n==="contacts"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üë•</span>
              <span class="label">Contacts</span>
            </div>
          </label>
        </div>
      </div>
      
      <div class="form-group">
        <label>Format</label>
        <div class="format-options">
          <label class="radio-card ${t==="json"?"selected":""}">
            <input type="radio" name="export-format" value="json" ${t==="json"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">{ }</span>
              <span class="label">JSON</span>
              <span class="hint">Full data backup</span>
            </div>
          </label>
          <label class="radio-card ${t==="csv"?"selected":""}">
            <input type="radio" name="export-format" value="csv" ${t==="csv"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üìä</span>
              <span class="label">CSV</span>
              <span class="hint">Spreadsheet</span>
            </div>
          </label>
          <label class="radio-card ${t==="markdown"?"selected":""}">
            <input type="radio" name="export-format" value="markdown" ${t==="markdown"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üìù</span>
              <span class="label">Markdown</span>
              <span class="hint">Documentation</span>
            </div>
          </label>
          <label class="radio-card ${t==="pdf"?"selected":""}">
            <input type="radio" name="export-format" value="pdf" ${t==="pdf"?"checked":""}>
            <div class="radio-card-content">
              <span class="icon">üìÑ</span>
              <span class="label">PDF</span>
              <span class="hint">Report</span>
            </div>
          </label>
        </div>
      </div>
    </div>
  `,s.querySelectorAll(".radio-card input").forEach(l=>{d(l,"change",()=>{const m=l.name;s.querySelectorAll(`[name="${m}"]`).forEach(v=>{const g=v.closest(".radio-card");g&&(v.checked?qt(g,"selected"):cn(g,"selected"))})})});const o=x("div",{className:"modal-footer"}),i=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),r=x("button",{className:"btn btn-primary",textContent:"Export"});d(i,"click",()=>H(Da)),d(r,"click",async()=>{const l=s.querySelector('[name="export-format"]:checked')?.value,m=s.querySelector('[name="export-scope"]:checked')?.value;r.disabled=!0,r.textContent="Exporting...";try{await Ax(l,m),e.onExport?.(l,m),H(Da)}catch{}finally{r.disabled=!1,r.textContent="Export"}}),o.appendChild(i),o.appendChild(r);const c=fe({id:Da,title:"Export Data",content:s,size:"md",footer:o});document.body.appendChild(c),he(Da)}async function Ax(e,t){const n=P.getState().currentProjectId;if(!n){u.error("No project selected");return}try{const a=await p.get(`/api/projects/${n}/export`,{headers:{Accept:Ex(e)}}),s=jx(a.data,e),o=URL.createObjectURL(s),i=document.createElement("a");i.href=o,i.download=`godmode-${t}-${new Date().toISOString().split("T")[0]}.${_x(e)}`,i.click(),URL.revokeObjectURL(o),u.success("Export completed")}catch{throw u.error("Export failed"),new Error("Export failed")}}function Ex(e){switch(e){case"json":return"application/json";case"csv":return"text/csv";case"markdown":return"text/markdown";case"pdf":return"application/pdf"}}function _x(e){switch(e){case"json":return"json";case"csv":return"csv";case"markdown":return"md";case"pdf":return"pdf"}}function jx(e,t){let n,a;switch(t){case"json":n=JSON.stringify(e,null,2),a="application/json";break;case"csv":n=typeof e=="string"?e:JSON.stringify(e),a="text/csv";break;case"markdown":n=typeof e=="string"?e:JSON.stringify(e,null,2),a="text/markdown";break;case"pdf":n=typeof e=="string"?e:"",a="application/pdf";break}return new Blob([n],{type:a})}const Pa="file-upload-modal";let st=[],Ha=!1;function ur(e={}){const{accept:t="*/*",multiple:n=!0,maxSize:a=50*1024*1024,onUpload:s,onComplete:o}=e;st=[],Ha=!1;const i=document.querySelector(`[data-modal-id="${Pa}"]`);i&&i.remove();const r=x("div",{className:"file-upload-modal-content"});function c(){r.innerHTML=`
      <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-icon">üìÅ</div>
        <div class="drop-zone-text">
          <strong>Drop files here</strong> or click to browse
        </div>
        <div class="drop-zone-hint">
          ${n?"You can upload multiple files":"Single file only"}
          ${a?` ‚Ä¢ Max ${xs(a)}`:""}
        </div>
        <input type="file" id="file-input" ${t!=="*/*"?`accept="${t}"`:""} ${n?"multiple":""} hidden>
      </div>
      
      ${st.length>0?`
        <div class="upload-list">
          <h4>Files (${st.length})</h4>
          ${st.map(w=>Dx(w)).join("")}
        </div>
      `:""}
    `,l(),m()}function l(){const w=r.querySelector("#drop-zone"),$=r.querySelector("#file-input");!w||!$||(d(w,"click",()=>$.click()),d($,"change",()=>{$.files&&(xc(Array.from($.files),a),c())}),d(w,"dragover",M=>{M.preventDefault(),qt(w,"drag-over")}),d(w,"dragleave",()=>{cn(w,"drag-over")}),d(w,"drop",M=>{M.preventDefault(),cn(w,"drag-over");const q=M.dataTransfer;q?.files&&(xc(Array.from(q.files),a),c())}))}function m(){r.querySelectorAll('[data-action="remove"]').forEach(w=>{d(w,"click",()=>{const $=w.getAttribute("data-file-id");$&&(st=st.filter(M=>M.id!==$),c())})})}c();const v=x("div",{className:"modal-footer"}),g=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),f=x("button",{className:"btn btn-primary",textContent:"Upload"});d(g,"click",()=>{if(Ha){u.warning("Upload in progress");return}H(Pa)}),d(f,"click",async()=>{if(st.length===0){u.warning("No files selected");return}if(!Ha){Ha=!0,f.disabled=!0,f.textContent="Uploading...";try{if(s){const w=st.map($=>$.file);await s(w),st.forEach($=>{$.status="completed",$.progress=100})}else await Px(st,c);u.success("Upload complete"),o?.(st),H(Pa)}catch{u.error("Upload failed")}finally{Ha=!1,f.disabled=!1,f.textContent="Upload",c()}}}),v.appendChild(g),v.appendChild(f);const b=fe({id:Pa,title:"Upload Files",content:r,size:"md",footer:v});document.body.appendChild(b),he(Pa)}function xc(e,t){e.forEach(n=>{if(n.size>t){u.error(`${n.name} exceeds max size`);return}st.some(a=>a.file.name===n.name&&a.file.size===n.size)||st.push({id:`file-${Date.now()}-${Math.random().toString(36).slice(2)}`,file:n,progress:0,status:"pending"})})}function Dx(e){const t=Hx(e.file.type);return`
    <div class="upload-item ${e.status}" data-file-id="${e.id}">
      <span class="file-icon">${t}</span>
      <div class="file-info">
        <div class="file-name">${wc(e.file.name)}</div>
        <div class="file-size">${xs(e.file.size)}</div>
        ${e.status==="uploading"?`
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${e.progress}%"></div>
          </div>
        `:""}
        ${e.error?`<div class="file-error">${wc(e.error)}</div>`:""}
      </div>
      <div class="file-status">
        ${e.status==="completed"?"‚úì":""}
        ${e.status==="error"?"‚úï":""}
        ${e.status==="pending"?`
          <button class="btn-sm btn-danger" data-action="remove" data-file-id="${e.id}">√ó</button>
        `:""}
      </div>
    </div>
  `}async function Px(e,t){for(const n of e){n.status="uploading",t();try{const a=new FormData;a.append("file",n.file);const s=new XMLHttpRequest;await new Promise((o,i)=>{s.upload.addEventListener("progress",r=>{r.lengthComputable&&(n.progress=Math.round(r.loaded/r.total*100),t())}),s.addEventListener("load",()=>{s.status>=200&&s.status<300?(n.status="completed",n.progress=100,o()):(n.status="error",n.error="Upload failed",i(new Error("Upload failed")))}),s.addEventListener("error",()=>{n.status="error",n.error="Network error",i(new Error("Network error"))}),s.open("POST","/api/upload"),s.send(a)})}catch{n.status="error"}t()}}function Hx(e){return e.startsWith("image/")?"üñºÔ∏è":e.startsWith("video/")?"üé•":e.startsWith("audio/")?"üéµ":e.includes("pdf")?"üìÑ":e.includes("word")||e.includes("document")?"üìù":e.includes("sheet")||e.includes("excel")?"üìä":e.includes("presentation")||e.includes("powerpoint")?"üìΩÔ∏è":e.includes("zip")||e.includes("archive")?"üì¶":e.includes("text")?"üìÉ":"üìÅ"}function wc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const jd=Object.freeze(Object.defineProperty({__proto__:null,showFileUploadModal:ur},Symbol.toStringTag,{value:"Module"})),Ls="developer-modal";function mr(){const e=document.querySelector(`[data-modal-id="${Ls}"]`);e&&e.remove();const t=x("div",{className:"developer-modal-content"});let n="info";function a(){t.innerHTML=`
      <div class="dev-tabs">
        <button class="dev-tab ${n==="info"?"active":""}" data-tab="info">Info</button>
        <button class="dev-tab ${n==="logs"?"active":""}" data-tab="logs">Logs</button>
        <button class="dev-tab ${n==="cache"?"active":""}" data-tab="cache">Cache</button>
        <button class="dev-tab ${n==="api"?"active":""}" data-tab="api">API Test</button>
      </div>
      <div class="dev-content">
        ${zx(n)}
      </div>
    `,t.querySelectorAll(".dev-tab").forEach(r=>{d(r,"click",()=>{n=r.getAttribute("data-tab"),a()})}),Fx(t)}a();const s=x("div",{className:"modal-footer"}),o=x("button",{className:"btn btn-secondary",textContent:"Close"});d(o,"click",()=>H(Ls)),s.appendChild(o);const i=fe({id:Ls,title:"Developer Tools",content:t,size:"lg",footer:s});document.body.appendChild(i),he(Ls)}function zx(e){switch(e){case"info":return Bx();case"logs":return Ix();case"cache":return Rx();case"api":return Nx()}}function Bx(){const e=P.getState(),t=B.getState(),n=ve.getState();return`
    <div class="dev-section">
      <h4>Application State</h4>
      <pre class="code-block">${JSON.stringify({projectId:e.currentProjectId,user:e.currentUser?.email,authConfigured:e.authConfigured},null,2)}</pre>
    </div>
    
    <div class="dev-section">
      <h4>Data Counts</h4>
      <table class="dev-table">
        <tr><td>Questions</td><td>${t.questions.length}</td></tr>
        <tr><td>Risks</td><td>${t.risks.length}</td></tr>
        <tr><td>Actions</td><td>${t.actions.length}</td></tr>
        <tr><td>Decisions</td><td>${t.decisions.length}</td></tr>
        <tr><td>Contacts</td><td>${t.contacts.length}</td></tr>
        <tr><td>Chat Messages</td><td>${t.chatHistory.length}</td></tr>
      </table>
    </div>
    
    <div class="dev-section">
      <h4>UI State</h4>
      <pre class="code-block">${JSON.stringify({currentTab:n.currentTab,sotView:n.sotCurrentView,sidebarOpen:n.sidebarOpen,modalOpen:n.modalOpen},null,2)}</pre>
    </div>
    
    <div class="dev-section">
      <h4>Environment</h4>
      <table class="dev-table">
        <tr><td>User Agent</td><td>${navigator.userAgent.slice(0,50)}...</td></tr>
        <tr><td>Screen</td><td>${window.innerWidth}x${window.innerHeight}</td></tr>
        <tr><td>Theme</td><td>${document.documentElement.getAttribute("data-theme")}</td></tr>
      </table>
    </div>
  `}function Ix(){return`
    <div class="dev-section">
      <h4>Console Logs</h4>
      <p class="text-muted">Open browser DevTools (F12) to view console logs.</p>
      <div class="dev-actions">
        <button class="btn btn-secondary btn-sm" data-action="clear-console">Clear Console</button>
        <button class="btn btn-secondary btn-sm" data-action="log-state">Log State</button>
      </div>
    </div>
    
    <div class="dev-section">
      <h4>Performance</h4>
      <table class="dev-table">
        <tr><td>Page Load</td><td>${Math.round(performance.now())}ms</td></tr>
        <tr><td>Memory</td><td>${Ux()}</td></tr>
      </table>
    </div>
  `}function Rx(){const e=Object.keys(localStorage),t=e.reduce((n,a)=>n+(localStorage.getItem(a)?.length||0),0);return`
    <div class="dev-section">
      <h4>LocalStorage</h4>
      <p>Items: ${e.length} | Size: ${$i(t*2)}</p>
      <div class="dev-actions">
        <button class="btn btn-danger btn-sm" data-action="clear-storage">Clear All Storage</button>
        <button class="btn btn-secondary btn-sm" data-action="export-storage">Export Storage</button>
      </div>
      <div class="storage-list">
        ${e.map(n=>`
          <div class="storage-item">
            <span class="storage-key">${n}</span>
            <span class="storage-size">${$i((localStorage.getItem(n)?.length||0)*2)}</span>
            <button class="btn-sm btn-danger" data-action="delete-key" data-key="${n}">√ó</button>
          </div>
        `).join("")}
      </div>
    </div>
  `}function Nx(){return`
    <div class="dev-section">
      <h4>API Test</h4>
      <div class="form-group">
        <label>Endpoint</label>
        <div class="input-group">
          <select id="api-method" class="form-control" style="width: 100px">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input type="text" id="api-endpoint" class="form-control" value="/api/health" placeholder="/api/...">
        </div>
      </div>
      <div class="form-group">
        <label>Body (JSON)</label>
        <textarea id="api-body" class="form-control" rows="3" placeholder='{"key": "value"}'></textarea>
      </div>
      <button class="btn btn-primary" data-action="test-api">Send Request</button>
    </div>
    
    <div class="dev-section">
      <h4>Response</h4>
      <pre id="api-response" class="code-block">No request sent yet</pre>
    </div>
  `}function Fx(e){e.querySelectorAll("[data-action]").forEach(t=>{const n=t.getAttribute("data-action");d(t,"click",async()=>{switch(n){case"clear-console":console.clear(),u.success("Console cleared");break;case"log-state":console.group("Application State"),console.log("App:",P.getState()),console.log("Data:",B.getState()),console.log("UI:",ve.getState()),console.groupEnd(),u.success("State logged to console");break;case"clear-storage":localStorage.clear(),u.success("Storage cleared"),location.reload();break;case"export-storage":const a={...localStorage},s=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),o=URL.createObjectURL(s),i=document.createElement("a");i.href=o,i.download="localstorage-backup.json",i.click(),u.success("Storage exported");break;case"delete-key":const r=t.getAttribute("data-key");r&&(localStorage.removeItem(r),u.success(`Removed: ${r}`),mr());break;case"test-api":await Ox(e);break}})})}async function Ox(e){const t=e.querySelector("#api-method").value,n=e.querySelector("#api-endpoint").value,a=e.querySelector("#api-body").value,s=e.querySelector("#api-response");s.textContent="Loading...";try{const o={method:t};a&&t!=="GET"&&(o.body=a,o.headers={"Content-Type":"application/json"});const i=performance.now(),r=await fetch(n,o),c=Math.round(performance.now()-i),l=await r.json().catch(()=>r.text());s.textContent=`Status: ${r.status} (${c}ms)

${JSON.stringify(l,null,2)}`}catch(o){s.textContent=`Error: ${o instanceof Error?o.message:"Unknown error"}`}}function Ux(){const e=performance;return e.memory?$i(e.memory.usedJSHeapSize):"N/A"}function $i(e){if(e===0)return"0 B";const t=1024,n=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(1))+" "+n[a]}const Ms="shortcuts-modal",Vx=[{title:"General",shortcuts:[{keys:["Ctrl","Z"],description:"Undo last action"},{keys:["Ctrl","Shift","Z"],description:"Redo"},{keys:["Ctrl","S"],description:"Save current item"},{keys:["Esc"],description:"Close modal / Cancel"},{keys:["?"],description:"Show this help"}]},{title:"Navigation",shortcuts:[{keys:["Ctrl","1"],description:"Go to Dashboard"},{keys:["Ctrl","2"],description:"Go to Chat"},{keys:["Ctrl","3"],description:"Go to Source of Truth"},{keys:["Ctrl","4"],description:"Go to Timeline"},{keys:["Ctrl","5"],description:"Go to Contacts"}]},{title:"Actions",shortcuts:[{keys:["Ctrl","K"],description:"Quick search"},{keys:["Ctrl","N"],description:"New item"},{keys:["Ctrl","E"],description:"Export data"},{keys:["Ctrl","Shift","T"],description:"Toggle theme"}]},{title:"Chat",shortcuts:[{keys:["Enter"],description:"Send message"},{keys:["Shift","Enter"],description:"New line"},{keys:["‚Üë"],description:"Previous message"}]}];function Dd(){const e=document.querySelector(`[data-modal-id="${Ms}"]`);e&&e.remove();const t=x("div",{className:"shortcuts-modal-content"}),n=Ct.getAll();t.innerHTML=`
    <div class="shortcuts-grid">
      ${Vx.map(i=>`
        <div class="shortcut-group">
          <h4>${i.title}</h4>
          <div class="shortcut-list">
            ${i.shortcuts.map(r=>`
              <div class="shortcut-item">
                <div class="shortcut-keys">
                  ${r.keys.map(c=>`<kbd>${c}</kbd>`).join(" + ")}
                </div>
                <div class="shortcut-desc">${r.description}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
    
    ${n.length>0?`
      <div class="shortcuts-custom">
        <h4>Active Shortcuts</h4>
        <div class="shortcut-list">
          ${n.map(i=>{const r=[];return i.ctrl&&r.push("Ctrl"),i.shift&&r.push("Shift"),i.alt&&r.push("Alt"),i.meta&&r.push("Cmd"),r.push(i.key.toUpperCase()),`
              <div class="shortcut-item">
                <div class="shortcut-keys">
                  ${r.map(c=>`<kbd>${c}</kbd>`).join(" + ")}
                </div>
                <div class="shortcut-desc">${i.description}</div>
              </div>
            `}).join("")}
        </div>
      </div>
    `:""}
    
    <div class="shortcuts-tip">
      <p class="text-muted">
        üí° Tip: Most shortcuts use Ctrl on Windows/Linux or Cmd on Mac.
      </p>
    </div>
  `;const a=x("div",{className:"modal-footer"}),s=x("button",{className:"btn btn-primary",textContent:"Got it"});d(s,"click",()=>H(Ms)),a.appendChild(s);const o=fe({id:Ms,title:"Keyboard Shortcuts",content:t,size:"lg",footer:a});document.body.appendChild(o),he(Ms)}const za="notifications-modal";let Dn=[],Wn="all";async function Gx(e={}){Wn="all";const t=document.querySelector(`[data-modal-id="${za}"]`);t&&t.remove();const n=x("div",{className:"notifications-modal-content"});n.innerHTML='<div class="loading">Loading notifications...</div>';const a=x("div",{className:"modal-footer"}),s=x("button",{className:"btn btn-secondary",textContent:"Mark All Read"}),o=x("button",{className:"btn btn-primary",textContent:"Close"});d(s,"click",async()=>{try{await p.post("/api/notifications/mark-all-read"),Dn.forEach(c=>c.read=!0),r(),u.success("All marked as read"),e.onMarkAllRead?.()}catch{}}),d(o,"click",()=>H(za)),a.appendChild(s),a.appendChild(o);const i=fe({id:za,title:"Notifications",content:n,size:"md",footer:a});document.body.appendChild(i),he(za);try{Dn=(await p.get("/api/notifications")).data,r()}catch{n.innerHTML='<div class="error">Failed to load notifications</div>'}function r(){const c=Wn==="unread"?Dn.filter(m=>!m.read):Dn,l=Dn.filter(m=>!m.read).length;n.innerHTML=`
      <div class="notifications-header">
        <div class="filter-tabs">
          <button class="filter-tab ${Wn==="all"?"active":""}" data-filter="all">
            All (${Dn.length})
          </button>
          <button class="filter-tab ${Wn==="unread"?"active":""}" data-filter="unread">
            Unread (${l})
          </button>
        </div>
      </div>
      
      ${c.length===0?`
        <div class="empty-state">
          <span class="empty-icon">üîî</span>
          <p>${Wn==="unread"?"No unread notifications":"No notifications yet"}</p>
        </div>
      `:`
        <div class="notifications-list">
          ${c.map(m=>Qx(m)).join("")}
        </div>
      `}
    `,n.querySelectorAll(".filter-tab").forEach(m=>{d(m,"click",()=>{Wn=m.getAttribute("data-filter"),r()})}),n.querySelectorAll(".notification-item").forEach(m=>{const v=m.getAttribute("data-notification-id"),g=Dn.find(f=>f.id===v);g&&d(m,"click",async()=>{if(!g.read)try{await p.patch(`/api/notifications/${v}/read`),g.read=!0,cn(m,"unread")}catch{}e.onNotificationClick?.(g),g.link&&H(za)})})}}function Qx(e){const t=Kx(e.type);return`
    <div class="notification-item ${e.read?"":"unread"}" 
         data-notification-id="${e.id}">
      <div class="notification-icon ${e.type}">${t}</div>
      <div class="notification-content">
        <div class="notification-title">${No(e.title)}</div>
        <div class="notification-message">${No(e.message)}</div>
        <div class="notification-meta">
          ${e.actor?`<span class="notification-actor">${No(e.actor.name)}</span> ‚Ä¢ `:""}
          <span class="notification-time">${J(e.createdAt)}</span>
        </div>
      </div>
      ${e.read?"":'<div class="notification-dot"></div>'}
    </div>
  `}function Kx(e){switch(e){case"info":return"‚ÑπÔ∏è";case"success":return"‚úÖ";case"warning":return"‚ö†Ô∏è";case"error":return"‚ùå";case"mention":return"üí¨";case"update":return"üîÑ";default:return"üîî"}}function No(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Pn="email-modal";function gr(e){const{mode:t,email:n,onSend:a}=e,s=document.querySelector(`[data-modal-id="${Pn}"]`);s&&s.remove();const o=x("div",{className:"email-modal-content"});if(t==="view"&&n)o.innerHTML=`
      <div class="email-view">
        <div class="email-header">
          <div class="email-subject">${ft(n.subject)}</div>
          <div class="email-meta">
            <div class="email-from">
              <strong>${ft(n.from.name)}</strong>
              <span class="text-muted">&lt;${ft(n.from.email)}&gt;</span>
            </div>
            <div class="email-to">
              To: ${n.to.map(c=>ft(c.name||c.email)).join(", ")}
            </div>
            ${n.cc?.length?`
              <div class="email-cc">
                Cc: ${n.cc.map(c=>ft(c.name||c.email)).join(", ")}
              </div>
            `:""}
            <div class="email-date">${J(n.date)}</div>
          </div>
        </div>
        
        <div class="email-body">
          ${n.bodyHtml||ft(n.body).replace(/\n/g,"<br>")}
        </div>
        
        ${n.attachments?.length?`
          <div class="email-attachments">
            <h4>Attachments (${n.attachments.length})</h4>
            <div class="attachments-list">
              ${n.attachments.map(c=>`
                <div class="attachment-item">
                  <span class="attachment-icon">üìé</span>
                  <span class="attachment-name">${ft(c.name)}</span>
                  <span class="attachment-size">${Wx(c.size)}</span>
                </div>
              `).join("")}
            </div>
          </div>
        `:""}
        
        ${n.thread?.length?`
          <div class="email-thread">
            <h4>Thread (${n.thread.length} messages)</h4>
            ${n.thread.map(c=>`
              <div class="thread-message">
                <div class="thread-header">
                  <strong>${ft(c.from.name)}</strong>
                  <span>${J(c.date)}</span>
                </div>
                <div class="thread-preview">${ft(c.body.slice(0,100))}...</div>
              </div>
            `).join("")}
          </div>
        `:""}
      </div>
    `;else{const c=t==="reply"&&n,l=c?n.from.email:"",m=c?`Re: ${n.subject}`:"";o.innerHTML=`
      <form id="email-form" class="email-form">
        <div class="form-group">
          <label for="email-to">To *</label>
          <input type="text" id="email-to" required 
                 value="${l}" 
                 placeholder="recipient@example.com">
        </div>
        
        <div class="form-group">
          <label for="email-cc">Cc</label>
          <input type="text" id="email-cc" 
                 placeholder="cc@example.com">
        </div>
        
        <div class="form-group">
          <label for="email-subject">Subject *</label>
          <input type="text" id="email-subject" required 
                 value="${ft(m)}" 
                 placeholder="Email subject">
        </div>
        
        <div class="form-group">
          <label for="email-body">Message *</label>
          <textarea id="email-body" rows="10" required 
                    placeholder="Write your message...">${c?`

---
On ${n.date}, ${n.from.name} wrote:
${n.body}`:""}</textarea>
        </div>
        
        <div class="form-group">
          <label>Attachments</label>
          <div class="attachment-dropzone" id="attachment-zone">
            <span>Drop files here or click to attach</span>
            <input type="file" id="attachment-input" multiple hidden>
          </div>
          <div id="attachments-preview"></div>
        </div>
      </form>
    `,setTimeout(()=>{const v=o.querySelector("#attachment-zone"),g=o.querySelector("#attachment-input");v&&g&&(d(v,"click",()=>g.click()),d(g,"change",()=>{if(g.files){const f=o.querySelector("#attachments-preview");f.innerHTML=Array.from(g.files).map(b=>`<div class="attachment-item">${ft(b.name)}</div>`).join("")}}))},0)}const i=x("div",{className:"modal-footer"});if(t==="view"){const c=x("button",{className:"btn btn-primary",textContent:"Reply"}),l=x("button",{className:"btn btn-secondary",textContent:"Forward"}),m=x("button",{className:"btn btn-secondary",textContent:"Close"});d(c,"click",()=>{H(Pn),gr({...e,mode:"reply"})}),d(l,"click",()=>{u.info("Forward not implemented")}),d(m,"click",()=>H(Pn)),i.appendChild(m),i.appendChild(l),i.appendChild(c)}else{const c=x("button",{className:"btn btn-secondary",textContent:"Cancel"}),l=x("button",{className:"btn btn-primary",textContent:"Send"});d(c,"click",()=>H(Pn)),d(l,"click",async()=>{const m=o.querySelector("#email-form");if(!m.checkValidity()){m.reportValidity();return}const v=o.querySelector("#email-to").value,g=o.querySelector("#email-cc").value,f=o.querySelector("#email-subject").value,b=o.querySelector("#email-body").value,w={to:v.split(",").map($=>({name:"",email:$.trim()})),cc:g?g.split(",").map($=>({name:"",email:$.trim()})):void 0,subject:f,body:b};l.disabled=!0,l.textContent="Sending...";try{a?await a(w):await p.post("/api/emails/send",w),u.success("Email sent"),H(Pn)}catch{}finally{l.disabled=!1,l.textContent="Send"}}),i.appendChild(c),i.appendChild(l)}const r=fe({id:Pn,title:t==="view"?"Email":t==="reply"?"Reply":"Compose Email",content:o,size:"lg",footer:i});document.body.appendChild(r),he(Pn)}function Wx(e){if(e===0)return"0 B";const t=1024,n=["B","KB","MB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(1))+" "+n[a]}function ft(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Fe={charts:new Map,networks:new Map,activeChart:null},Si=new Set;function qa(){Si.forEach(e=>e())}function Yx(e,t,n,a){Fe.charts.set(e,{id:e,chart:t,container:n,type:a}),qa()}function Jx(e){return Fe.charts.get(e)?.chart??null}function Zx(e){const t=Fe.charts.get(e);t?.chart&&t.chart.destroy(),Fe.charts.delete(e),qa()}function Xx(e,t){const n=Fe.charts.get(e);n?.chart&&(n.chart.data=t,n.chart.update())}function e2(e,t,n){Fe.networks.set(e,{id:e,network:t,container:n}),qa()}function t2(e){return Fe.networks.get(e)?.network??null}function n2(e){const t=Fe.networks.get(e);t?.network&&typeof t.network.destroy=="function"&&t.network.destroy(),Fe.networks.delete(e),qa()}function a2(e){Fe.activeChart=e,qa()}function s2(){return Array.from(Fe.charts.keys())}function o2(){return Array.from(Fe.networks.keys())}function i2(){Fe.charts.forEach(e=>{e.chart&&e.chart.destroy()}),Fe.networks.forEach(e=>{e.network&&typeof e.network.destroy=="function"&&e.network.destroy()}),Fe.charts.clear(),Fe.networks.clear(),Fe.activeChart=null,qa()}function r2(e){return Si.add(e),()=>Si.delete(e)}const Kn={registerChart:Yx,getChart:Jx,destroyChart:Zx,updateChartData:Xx,registerNetwork:e2,getNetwork:t2,destroyNetwork:n2,setActiveChart:a2,getChartIds:s2,getNetworkIds:o2,destroyAll:i2,subscribe:r2},qs="graph-modal";function c2(e){const{title:t="Graph View",nodes:n,edges:a,onNodeClick:s,onEdgeClick:o}=e,i=document.querySelector(`[data-modal-id="${qs}"]`);i&&i.remove();const r=x("div",{className:"graph-modal-content"});r.innerHTML=`
    <div class="graph-toolbar">
      <div class="graph-info">
        <span>Nodes: ${n.length}</span>
        <span>Edges: ${a.length}</span>
      </div>
      <div class="graph-controls">
        <button class="btn btn-sm btn-secondary" data-action="zoom-in" title="Zoom In">+</button>
        <button class="btn btn-sm btn-secondary" data-action="zoom-out" title="Zoom Out">‚àí</button>
        <button class="btn btn-sm btn-secondary" data-action="fit" title="Fit to View">‚ä°</button>
        <button class="btn btn-sm btn-secondary" data-action="fullscreen" title="Fullscreen">‚õ∂</button>
      </div>
    </div>
    <div id="graph-container" class="graph-container">
      <div class="graph-placeholder">
        <p>Loading graph visualization...</p>
        <p class="text-muted">Requires vis-network library</p>
      </div>
    </div>
    <div class="graph-legend">
      ${p2(n).map(g=>`
        <span class="legend-item">
          <span class="legend-color" style="background: ${Pd(g)}"></span>
          ${g}
        </span>
      `).join("")}
    </div>
  `;const c=x("div",{className:"modal-footer"}),l=x("button",{className:"btn btn-secondary",textContent:"Export Image"}),m=x("button",{className:"btn btn-primary",textContent:"Close"});d(l,"click",()=>{const g=r.querySelector("canvas");if(g){const f=document.createElement("a");f.download="graph.png",f.href=g.toDataURL(),f.click()}else u.warning("Graph not rendered")}),d(m,"click",()=>{Kn.destroyNetwork("modal-graph"),H(qs)}),c.appendChild(l),c.appendChild(m);const v=fe({id:qs,title:t,content:r,size:"xl",footer:c});document.body.appendChild(v),he(qs),setTimeout(()=>{l2(r,n,a,s,o),d2(r)},100)}function l2(e,t,n,a,s){const o=e.querySelector("#graph-container");if(typeof window.vis>"u"){o.innerHTML=`
      <div class="graph-fallback">
        <h4>Graph Data</h4>
        <div class="graph-data">
          <strong>Nodes (${t.length}):</strong>
          <ul>${t.slice(0,10).map(v=>`<li>${v.label} (${v.type||"default"})</li>`).join("")}</ul>
          ${t.length>10?`<p class="text-muted">...and ${t.length-10} more</p>`:""}
        </div>
        <div class="graph-data">
          <strong>Edges (${n.length}):</strong>
          <ul>${n.slice(0,10).map(v=>`<li>${v.from} ‚Üí ${v.to}${v.label?` (${v.label})`:""}</li>`).join("")}</ul>
          ${n.length>10?`<p class="text-muted">...and ${n.length-10} more</p>`:""}
        </div>
        <p class="text-muted"><em>vis-network library not loaded</em></p>
      </div>
    `;return}const i=window.vis,r=new i.DataSet(t.map(v=>({id:v.id,label:v.label,color:v.color||Pd(v.type),size:v.size||20}))),c=new i.DataSet(n.map(v=>({id:v.id,from:v.from,to:v.to,label:v.label,color:v.color}))),l={nodes:{shape:"dot",font:{color:"#eaeaea",size:12},borderWidth:2},edges:{arrows:"to",color:{color:"#2a2a4a",highlight:"#e94560"},font:{color:"#a0a0a0",size:10}},physics:{enabled:!0,stabilization:{iterations:100}},interaction:{hover:!0,tooltipDelay:200}};o.innerHTML="";const m=new i.Network(o,{nodes:r,edges:c},l);Kn.registerNetwork("modal-graph",m,"#graph-container"),a&&m.on("click",v=>{if(v.nodes.length>0){const g=t.find(f=>f.id===v.nodes[0]);g&&a(g)}}),s&&m.on("click",v=>{if(v.edges.length>0){const g=n.find(f=>f.id===v.edges[0]);g&&s(g)}})}function d2(e){const t=Kn.getNetwork("modal-graph");t&&e.querySelectorAll("[data-action]").forEach(n=>{d(n,"click",()=>{switch(n.getAttribute("data-action")){case"zoom-in":t.moveTo?.({scale:1.2});break;case"zoom-out":t.moveTo?.({scale:.8});break;case"fit":t.fit?.();break;case"fullscreen":const s=e.querySelector(".graph-container");s&&s.requestFullscreen?.();break}})})}function p2(e){const t=new Set(e.map(n=>n.type||"default"));return Array.from(t)}function Pd(e){const t={person:"#4ecdc4",organization:"#e94560",document:"#ffe66d",event:"#ff6b6b",location:"#45b7d1",default:"#a0a0a0"};return t[e||"default"]||t.default}const Ts="history-modal";let la=[],Ci=1,Xs=!0,Fo=!1;async function u2(e={}){const{entityType:t,entityId:n,title:a="History",onRestore:s}=e;la=[],Ci=1,Xs=!0;const o=document.querySelector(`[data-modal-id="${Ts}"]`);o&&o.remove();const i=x("div",{className:"history-modal-content"});i.innerHTML='<div class="loading">Loading history...</div>';const r=x("div",{className:"modal-footer"}),c=x("button",{className:"btn btn-primary",textContent:"Close"});d(c,"click",()=>H(Ts)),r.appendChild(c);const l=fe({id:Ts,title:a,content:i,size:"lg",footer:r});document.body.appendChild(l),he(Ts),await Hd(i,t,n,s)}async function Hd(e,t,n,a){if(!(Fo||!Xs)){Fo=!0;try{const s=new URLSearchParams({page:String(Ci),limit:"20"});t&&s.set("entityType",t),n&&s.set("entityId",n);const o=await p.get(`/api/history?${s}`);la=[...la,...o.data.entries],Xs=o.data.hasMore,Ci++,m2(e,a)}catch{e.innerHTML='<div class="error">Failed to load history</div>'}finally{Fo=!1}}}function m2(e,t){if(la.length===0){e.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">üìú</span>
        <p>No history entries</p>
      </div>
    `;return}const n=v2(la);e.innerHTML=`
    <div class="history-timeline">
      ${Object.entries(n).map(([s,o])=>`
        <div class="history-date-group">
          <div class="history-date">${s}</div>
          ${o.map(i=>g2(i)).join("")}
        </div>
      `).join("")}
    </div>
    ${Xs?`
      <div class="history-load-more">
        <button class="btn btn-secondary" data-action="load-more">Load More</button>
      </div>
    `:""}
  `;const a=e.querySelector('[data-action="load-more"]');a&&d(a,"click",async()=>{await Hd(e,void 0,void 0,t)}),t&&e.querySelectorAll('[data-action="restore"]').forEach(s=>{d(s,"click",async()=>{const o=s.getAttribute("data-entry-id"),i=la.find(r=>r.id===o);if(i){const{confirm:r}=await Y(async()=>{const{confirm:l}=await Promise.resolve().then(()=>Gt);return{confirm:l}},void 0);await r("Are you sure you want to restore this version?",{title:"Restore",confirmText:"Restore"})&&t(i)}})}),e.querySelectorAll('[data-action="expand"]').forEach(s=>{d(s,"click",()=>{const o=s.closest(".history-entry")?.querySelector(".history-changes");o&&(o.classList.toggle("expanded"),s.textContent=o.classList.contains("expanded")?"Hide details":"Show details")})})}function g2(e){const t={create:"‚ûï",update:"‚úèÔ∏è",delete:"üóëÔ∏è",restore:"‚Ü©Ô∏è"},n={create:"success",update:"info",delete:"danger",restore:"warning"},a=e.changes&&Object.keys(e.changes).length>0;return`
    <div class="history-entry ${n[e.action]}" data-entry-id="${e.id}">
      <div class="history-icon">${t[e.action]}</div>
      <div class="history-content">
        <div class="history-summary">
          <strong>${e.actor.name}</strong>
          ${e.action}d
          <span class="entity-type">${e.entityType}</span>
          ${e.entityName?`"${f2(e.entityName)}"`:""}
        </div>
        <div class="history-time">${J(e.timestamp)}</div>
        
        ${a?`
          <div class="history-changes">
            ${Object.entries(e.changes).map(([s,o])=>`
              <div class="change-item">
                <span class="change-field">${s}:</span>
                <span class="change-old">${kc(o.old)}</span>
                <span class="change-arrow">‚Üí</span>
                <span class="change-new">${kc(o.new)}</span>
              </div>
            `).join("")}
          </div>
          <button class="btn-link" data-action="expand">Show details</button>
        `:""}
        
        ${e.action==="delete"?`
          <button class="btn btn-sm btn-secondary" data-action="restore" data-entry-id="${e.id}">
            Restore
          </button>
        `:""}
      </div>
    </div>
  `}function v2(e){const t={};return e.forEach(n=>{const a=new Date(n.timestamp).toLocaleDateString();t[a]||(t[a]=[]),t[a].push(n)}),t}function kc(e){return e==null?"(empty)":typeof e=="object"?JSON.stringify(e):String(e)}function f2(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Oo="comment-modal";let On=[];async function h2(e){const{entityType:t,entityId:n,entityName:a,onCommentAdded:s}=e;On=[];const o=document.querySelector(`[data-modal-id="${Oo}"]`);o&&o.remove();const i=x("div",{className:"comment-modal-content"});i.innerHTML='<div class="loading">Loading comments...</div>';const r=x("div",{className:"modal-footer comment-footer"});r.innerHTML=`
    <div class="comment-input-wrapper">
      <textarea id="comment-input" placeholder="Write a comment..." rows="2"></textarea>
      <button id="submit-comment" class="btn btn-primary">Post</button>
    </div>
  `;const c=fe({id:Oo,title:a?`Comments on "${a}"`:"Comments",content:i,size:"md",footer:r});document.body.appendChild(c),he(Oo);const l=r.querySelector("#submit-comment"),m=r.querySelector("#comment-input");d(l,"click",async()=>{const v=m.value.trim();if(!v){u.warning("Please write a comment");return}l.disabled=!0,l.textContent="Posting...";try{const g=await p.post(`/api/${t}/${n}/comments`,{content:v});On.unshift(g.data),m.value="",es(i,e),s?.(g.data),u.success("Comment added")}catch{}finally{l.disabled=!1,l.textContent="Post"}}),d(m,"keydown",v=>{v.key==="Enter"&&v.ctrlKey&&l.click()});try{On=(await p.get(`/api/${t}/${n}/comments`)).data,es(i,e)}catch{i.innerHTML='<div class="error">Failed to load comments</div>'}}function es(e,t){if(On.length===0){e.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">üí¨</span>
        <p>No comments yet</p>
        <p class="text-muted">Be the first to comment!</p>
      </div>
    `;return}e.innerHTML=`
    <div class="comments-list">
      ${On.map(n=>zd(n,t)).join("")}
    </div>
  `,b2(e,t)}function zd(e,t,n=0){const s=P.getState().currentUser?.id===e.author.id,o=e.author.name.split(" ").map(i=>i[0]).join("").toUpperCase().slice(0,2);return`
    <div class="comment ${n>0?"reply":""}" data-comment-id="${e.id}" style="margin-left: ${n*20}px">
      <div class="comment-avatar">
        ${e.author.avatar?`<img src="${e.author.avatar}" alt="${zs(e.author.name)}">`:o}
      </div>
      <div class="comment-body">
        <div class="comment-header">
          <strong class="comment-author">${zs(e.author.name)}</strong>
          <span class="comment-time">${J(e.createdAt)}</span>
          ${e.edited?'<span class="comment-edited">(edited)</span>':""}
        </div>
        <div class="comment-content">${zs(e.content)}</div>
        <div class="comment-actions">
          <button class="btn-link" data-action="reply" data-comment-id="${e.id}">Reply</button>
          ${s?`
            <button class="btn-link" data-action="edit" data-comment-id="${e.id}">Edit</button>
            <button class="btn-link text-danger" data-action="delete" data-comment-id="${e.id}">Delete</button>
          `:""}
        </div>
      </div>
    </div>
    ${e.replies?.map(i=>zd(i,t,n+1)).join("")||""}
  `}function b2(e,t){e.querySelectorAll("[data-action]").forEach(n=>{const a=n.getAttribute("data-action"),s=n.getAttribute("data-comment-id");d(n,"click",async()=>{const o=Bd(On,s);if(o)switch(a){case"reply":const i=n.closest(".comment")?.querySelector(".comment-body");if(i&&!i.querySelector(".reply-input")){const m=x("div",{className:"reply-input"});m.innerHTML=`
              <textarea placeholder="Write a reply..." rows="2"></textarea>
              <div class="reply-actions">
                <button class="btn btn-sm btn-secondary cancel-reply">Cancel</button>
                <button class="btn btn-sm btn-primary submit-reply">Reply</button>
              </div>
            `,i.appendChild(m);const v=m.querySelector(".cancel-reply"),g=m.querySelector(".submit-reply"),f=m.querySelector("textarea");d(v,"click",()=>m.remove()),d(g,"click",async()=>{const b=f.value.trim();if(b)try{const w=await p.post(`/api/${t.entityType}/${t.entityId}/comments/${s}/replies`,{content:b});o.replies||(o.replies=[]),o.replies.push(w.data),es(e,t)}catch{}}),f.focus()}break;case"edit":const r=n.closest(".comment")?.querySelector(".comment-content");if(r){const m=o.content;r.innerHTML=`
              <textarea class="edit-textarea">${zs(m)}</textarea>
              <div class="edit-actions">
                <button class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
                <button class="btn btn-sm btn-primary save-edit">Save</button>
              </div>
            `;const v=r.querySelector("textarea"),g=r.querySelector(".cancel-edit"),f=r.querySelector(".save-edit");d(g,"click",()=>{r.textContent=m}),d(f,"click",async()=>{const b=v.value.trim();if(b)try{await p.patch(`/api/${t.entityType}/${t.entityId}/comments/${s}`,{content:b}),o.content=b,o.edited=!0,es(e,t)}catch{}}),v.focus()}break;case"delete":const{confirm:c}=await Y(async()=>{const{confirm:m}=await Promise.resolve().then(()=>Gt);return{confirm:m}},void 0);if(await c("Delete this comment?",{title:"Delete Comment",confirmText:"Delete",confirmClass:"btn-danger"}))try{await p.delete(`/api/${t.entityType}/${t.entityId}/comments/${s}`),Id(On,s),es(e,t),u.success("Comment deleted")}catch{}break}})})}function Bd(e,t){for(const n of e){if(n.id===t)return n;if(n.replies){const a=Bd(n.replies,t);if(a)return a}}}function Id(e,t){const n=e.findIndex(a=>a.id===t);if(n!==-1)return e.splice(n,1),!0;for(const a of e)if(a.replies&&Id(a.replies,t))return!0;return!1}function zs(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Vn="profile-modal";let Li={},It=null,Ua=null;function Rd(e={}){Li=e;const t=y2(),n=fe({id:Vn,title:"",size:"lg",content:t,onClose:e.onClose});n.style.cssText=`
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    background: rgba(0, 0, 0, 0.75) !important;
    z-index: 9999 !important;
    padding: 24px !important;
    margin: 0 !important;
  `;const a=n.querySelector(".modal-content");a&&(a.style.cssText=`
      background: transparent;
      box-shadow: none;
      padding: 0;
      max-width: 720px;
      width: 95%;
      margin: 0 !important;
      position: relative !important;
    `);const s=n.querySelector(".modal-header");s&&(s.style.display="none"),document.body.appendChild(n),he(Vn),x2(t)}function y2(){const e=x("div",{className:"profile-modal-sota"});return e.innerHTML=`
    <style>
      .profile-modal-sota {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      .profile-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.9);
        overflow: hidden;
      }
      
      [data-theme="dark"] .profile-card {
        background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(15,23,42,0.95) 100%);
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      
      .profile-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 32px;
        position: relative;
        overflow: hidden;
      }
      
      .profile-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        pointer-events: none;
      }
      
      .profile-header-content {
        display: flex;
        align-items: center;
        gap: 24px;
        position: relative;
        z-index: 1;
      }
      
      .profile-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: 600;
        color: white;
        border: 4px solid rgba(255,255,255,0.3);
        overflow: hidden;
        flex-shrink: 0;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
      
      .profile-avatar-large:hover {
        border-color: rgba(255,255,255,0.5);
        transform: scale(1.05);
      }
      
      .profile-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .avatar-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        border-radius: 50%;
      }
      
      .profile-avatar-large:hover .avatar-overlay {
        opacity: 1;
      }
      
      .avatar-overlay svg {
        width: 28px;
        height: 28px;
        color: white;
      }
      
      .profile-user-info h2 {
        margin: 0 0 4px 0;
        font-size: 28px;
        font-weight: 700;
        color: white;
      }
      
      .profile-user-info .email {
        color: rgba(255,255,255,0.8);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .profile-user-info .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(255,255,255,0.2);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
      }
      
      .profile-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
      }
      
      .profile-close-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
      }
      
      .profile-close-btn svg {
        width: 20px;
        height: 20px;
        color: white;
      }
      
      .profile-tabs-nav {
        display: flex;
        gap: 0;
        padding: 0 24px;
        background: rgba(0,0,0,0.02);
        border-bottom: 1px solid rgba(0,0,0,0.06);
      }
      
      [data-theme="dark"] .profile-tabs-nav {
        background: rgba(255,255,255,0.02);
        border-bottom-color: rgba(255,255,255,0.06);
      }
      
      .profile-tab-btn {
        padding: 16px 24px;
        background: transparent;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }
      
      .profile-tab-btn:hover {
        color: #1e293b;
      }
      
      [data-theme="dark"] .profile-tab-btn:hover {
        color: #e2e8f0;
      }
      
      .profile-tab-btn.active {
        color: #e11d48;
      }
      
      .profile-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 24px;
        right: 24px;
        height: 2px;
        background: #e11d48;
        border-radius: 2px 2px 0 0;
      }
      
      .profile-tab-icon {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        vertical-align: middle;
      }
      
      .profile-body {
        padding: 32px;
      }
      
      .profile-section {
        display: none;
      }
      
      .profile-section.active {
        display: block;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .form-grid .full-width {
        grid-column: 1 / -1;
      }
      
      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      [data-theme="dark"] .form-field label {
        color: #94a3b8;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s;
        outline: none;
      }
      
      [data-theme="dark"] .form-field input,
      [data-theme="dark"] .form-field select,
      [data-theme="dark"] .form-field textarea {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
        color: #f1f5f9;
      }
      
      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .form-field input:disabled {
        background: #f1f5f9;
        color: #94a3b8;
        cursor: not-allowed;
      }
      
      [data-theme="dark"] .form-field input:disabled {
        background: rgba(255,255,255,0.02);
        color: #64748b;
      }
      
      .form-field textarea {
        resize: vertical;
        min-height: 100px;
      }
      
      .form-hint {
        font-size: 12px;
        color: #94a3b8;
      }
      
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(0,0,0,0.06);
      }
      
      [data-theme="dark"] .form-actions {
        border-top-color: rgba(255,255,255,0.06);
      }
      
      .btn-sota {
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-sota.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .btn-sota.secondary {
        background: #f1f5f9;
        color: #475569;
      }
      
      [data-theme="dark"] .btn-sota.secondary {
        background: rgba(255,255,255,0.1);
        color: #e2e8f0;
      }
      
      .btn-sota.secondary:hover {
        background: #e2e8f0;
      }
      
      [data-theme="dark"] .btn-sota.secondary:hover {
        background: rgba(255,255,255,0.15);
      }
      
      .btn-sota.danger {
        background: transparent;
        color: #dc2626;
        border: 1px solid #fecaca;
      }
      
      .btn-sota.danger:hover {
        background: #fef2f2;
        border-color: #dc2626;
      }
      
      /* Security Section */
      .security-section {
        margin-bottom: 32px;
      }
      
      .security-section h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      [data-theme="dark"] .security-section h3 {
        color: #f1f5f9;
      }
      
      .danger-zone {
        background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
        border: 1px solid #fecaca;
        border-radius: 16px;
        padding: 24px;
      }
      
      [data-theme="dark"] .danger-zone {
        background: linear-gradient(135deg, rgba(220,38,38,0.1) 0%, rgba(220,38,38,0.05) 100%);
        border-color: rgba(220,38,38,0.3);
      }
      
      .danger-zone h3 {
        color: #dc2626 !important;
      }
      
      .danger-zone p {
        color: #991b1b;
        font-size: 14px;
        margin: 0 0 16px 0;
      }
      
      [data-theme="dark"] .danger-zone p {
        color: #fca5a5;
      }
      
      /* Sessions */
      .sessions-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .session-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid transparent;
      }
      
      [data-theme="dark"] .session-card {
        background: rgba(255,255,255,0.03);
      }
      
      .session-card.current {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
      }
      
      .session-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .session-icon {
        width: 44px;
        height: 44px;
        background: #e2e8f0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      [data-theme="dark"] .session-icon {
        background: rgba(255,255,255,0.1);
      }
      
      .session-icon svg {
        width: 22px;
        height: 22px;
        color: #64748b;
      }
      
      .session-details h4 {
        margin: 0 0 4px 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
      }
      
      [data-theme="dark"] .session-details h4 {
        color: #f1f5f9;
      }
      
      .session-details p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
      }
      
      .session-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
        background: #e11d48;
        color: white;
      }
      
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: #94a3b8;
      }
      
      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 48px;
      }
      
      .loading-spinner::after {
        content: '';
        width: 32px;
        height: 32px;
        border: 3px solid #e2e8f0;
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
    
    <div class="profile-card">
      <div class="loading-spinner"></div>
    </div>
  `,e}async function x2(e){const t=e.querySelector(".profile-card");if(t)try{const[n,a]=await Promise.all([en.get(),$2()]);if(n)It=n,Uo(t,It,a);else{const s=P.getState().currentUser;s?(It={id:s.id,email:s.email,display_name:s.name||s.email?.split("@")[0]||"User",avatar_url:s.avatar,created_at:new Date().toISOString()},Uo(t,It,a)):t.innerHTML='<div class="empty-state">Please log in to view your profile</div>'}}catch{const n=P.getState().currentUser;n?(It={id:n.id,email:n.email,display_name:n.name||"User",avatar_url:n.avatar,created_at:new Date().toISOString()},Uo(t,It)):t.innerHTML='<div class="empty-state">Failed to load profile</div>'}}function Uo(e,t,n){k2(t.display_name||t.email);const s=P.getState().currentUser?.role||t.role||"user";e.innerHTML=`
    <!-- Header -->
    <div class="profile-header">
      <button class="profile-close-btn" id="close-profile-btn">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
      <div class="profile-header-content">
        <label class="profile-avatar-large" for="avatar-input-hidden" id="profile-avatar-display">
          <img src="${t.avatar_url||ts(t.display_name||t.email)}" alt="Avatar" onerror="this.src='${ts(t.display_name||t.email)}'">
          <div class="avatar-overlay">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <input type="file" id="avatar-input-hidden" accept="image/*" hidden>
        </label>
        
        <div class="profile-user-info">
          <h2>${Ze(t.display_name||t.username||"User")}</h2>
          <div class="email">
            ${Ze(t.email)}
            <span class="role-badge">
              <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                ${s==="superadmin"?'<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>':'<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>'}
              </svg>
              ${s==="superadmin"?"Super Admin":"User"}
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <nav class="profile-tabs-nav">
      <button class="profile-tab-btn active" data-tab="general">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        General
      </button>
      <button class="profile-tab-btn" data-tab="security">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        Security
      </button>
      <button class="profile-tab-btn" data-tab="sessions">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        Sessions
      </button>
      <button class="profile-tab-btn" data-tab="integrations">
        <svg class="profile-tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
        </svg>
        Integrations
      </button>
    </nav>
    
    <!-- Tab Content -->
    <div class="profile-body">
      <!-- General Tab -->
      <div class="profile-section active" id="section-general">
        <form id="profile-form">
          <div class="form-grid">
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Email
              </label>
              <input type="email" value="${Ze(t.email)}" disabled>
              <span class="form-hint">Email cannot be changed</span>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"/>
                </svg>
                Username
              </label>
              <input type="text" name="username" value="${Ze(t.username||"")}" placeholder="Enter username">
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Display Name
              </label>
              <input type="text" name="display_name" value="${Ze(t.display_name||"")}" placeholder="Your display name">
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                </svg>
                Bio
              </label>
              <textarea name="bio" placeholder="Tell us a bit about yourself">${Ze(t.bio||"")}</textarea>
            </div>
            
            <div class="form-field full-width">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Avatar URL
              </label>
              <input type="url" name="avatar_url" id="avatar-url-input" value="${Ze(t.avatar_url||"")}" placeholder="https://example.com/avatar.jpg">
              <span class="form-hint">Enter an image URL or upload using the avatar above. Leave empty for auto-generated avatar.</span>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Timezone
              </label>
              <select name="timezone">
                ${S2(t.timezone,n)}
              </select>
            </div>
            
            <div class="form-field">
              <label>
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                </svg>
                Language
              </label>
              <select name="locale">
                <option value="en" ${t.locale==="en"?"selected":""}>English</option>
                <option value="pt" ${t.locale==="pt"?"selected":""}>Portugu√™s</option>
                <option value="es" ${t.locale==="es"?"selected":""}>Espa√±ol</option>
                <option value="fr" ${t.locale==="fr"?"selected":""}>Fran√ßais</option>
              </select>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-sota primary">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Save Changes
            </button>
          </div>
        </form>
      </div>
      
      <!-- Security Tab -->
      <div class="profile-section" id="section-security">
        <div class="security-section">
          <h3>
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
            Change Password
          </h3>
          
          <form id="password-form">
            <div class="form-grid">
              <div class="form-field full-width">
                <label>Current Password</label>
                <input type="password" name="current_password" required>
              </div>
              
              <div class="form-field">
                <label>New Password</label>
                <input type="password" name="new_password" minlength="12" required>
                <span class="form-hint">Minimum 12 characters</span>
              </div>
              
              <div class="form-field">
                <label>Confirm Password</label>
                <input type="password" name="confirm_password" required>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn-sota primary">Update Password</button>
            </div>
          </form>
        </div>
        
        <div class="danger-zone">
          <h3>
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Danger Zone
          </h3>
          <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
          <button type="button" class="btn-sota danger" id="delete-account-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Account
          </button>
        </div>
      </div>
      
      <!-- Sessions Tab -->
      <div class="profile-section" id="section-sessions">
        <div id="sessions-list" class="sessions-list">
          <div class="loading-spinner"></div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-sota secondary" id="revoke-all-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            Sign out all other sessions
          </button>
        </div>
      </div>
      
      <!-- Integrations Tab -->
      <div class="profile-section" id="section-integrations">
        <div class="security-section">
          <h3>
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
            </svg>
            Krisp AI Meeting Assistant
          </h3>
          <p class="form-hint" style="margin-bottom: 16px;">
            Connect your Krisp account to automatically import meeting transcriptions into GodMode.
          </p>
          
          <div id="krisp-integration-content">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </div>
  `,w2(e)}function w2(e){const t=e.querySelector("#close-profile-btn");t&&d(t,"click",()=>{H(Vn),Li.onClose?.()});const n=e.querySelectorAll(".profile-tab-btn");n.forEach(m=>{d(m,"click",()=>{n.forEach(g=>g.classList.remove("active")),m.classList.add("active");const v=m.getAttribute("data-tab");e.querySelectorAll(".profile-section").forEach(g=>{g.classList.toggle("active",g.id===`section-${v}`)}),v==="sessions"&&Mi(),v==="integrations"&&Va(e)})});const a=e.querySelector("#avatar-input-hidden");a&&d(a,"change",async()=>{const m=a.files?.[0];if(m)try{const v=await en.uploadAvatar(m),g=e.querySelector(".profile-avatar-large");if(g){const f=g.querySelector("img");f?f.src=v:g.innerHTML=`
                <img src="${v}" alt="Avatar">
                <div class="avatar-overlay">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </div>
                <input type="file" id="avatar-input-hidden" accept="image/*" hidden>
              `}u.success("Avatar updated")}catch{u.error("Failed to upload avatar")}});const s=e.querySelector("#avatar-url-input"),o=e.querySelector("#profile-avatar-display img");s&&o&&d(s,"input",()=>{const m=s.value.trim();m?o.src=m:It&&(o.src=ts(It.display_name||It.email))});const i=e.querySelector("#profile-form");i&&d(i,"submit",async m=>{m.preventDefault();const v=new FormData(i),g=v.get("avatar_url")?.trim(),f=v.get("display_name")||void 0,b={username:v.get("username")||void 0,display_name:f,bio:v.get("bio")||void 0,timezone:v.get("timezone")||void 0,locale:v.get("locale")||void 0,avatar_url:g||(f?ts(f):void 0)};try{const w=await en.update(b);It=w,u.success("Profile updated"),Li.onUpdate?.(w),o&&(o.src=w.avatar_url||ts(w.display_name||w.email))}catch{u.error("Failed to update profile")}});const r=e.querySelector("#password-form");r&&d(r,"submit",async m=>{m.preventDefault();const v=new FormData(r),g=v.get("current_password"),f=v.get("new_password"),b=v.get("confirm_password");if(f!==b){u.error("Passwords do not match");return}try{await en.changePassword({current_password:g,new_password:f}),u.success("Password changed"),r.reset()}catch(w){u.error(w instanceof Error?w.message:"Failed to change password")}});const c=e.querySelector("#delete-account-btn");c&&d(c,"click",async()=>{const m=prompt("Enter your password to confirm account deletion:");if(m&&confirm("Are you sure? This action cannot be undone."))try{await en.deleteAccount(m),H(Vn),u.success("Account deleted"),window.location.reload()}catch{u.error("Failed to delete account")}});const l=e.querySelector("#revoke-all-btn");l&&d(l,"click",async()=>{if(confirm("Sign out from all other devices?"))try{await en.revokeAllSessions(),u.success("All other sessions signed out"),Mi()}catch{u.error("Failed to revoke sessions")}})}async function Mi(){const e=document.querySelector("#sessions-list");if(e)try{const t=await en.getSessions();if(!t||t.length===0){e.innerHTML=`
        <div class="empty-state">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <p>No active sessions found</p>
        </div>
      `;return}e.innerHTML=t.map(n=>`
      <div class="session-card ${n.is_current?"current":""}">
        <div class="session-info">
          <div class="session-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              ${n.device?.toLowerCase().includes("mobile")?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>'}
            </svg>
          </div>
          <div class="session-details">
            <h4>${Ze(n.device||"Unknown device")}</h4>
            <p>${n.location?`${Ze(n.location)} ‚Ä¢ `:""}${Ze(n.ip_address||"Unknown IP")} ‚Ä¢ Last active: ${C2(n.last_active)}</p>
          </div>
        </div>
        ${n.is_current?'<span class="session-badge">Current</span>':`<button class="btn-sota secondary revoke-session-btn" data-id="${n.id}">Revoke</button>`}
      </div>
    `).join(""),e.querySelectorAll(".revoke-session-btn").forEach(n=>{d(n,"click",async()=>{const a=n.getAttribute("data-id");if(a)try{await en.revokeSession(a),u.success("Session revoked"),Mi()}catch{u.error("Failed to revoke session")}})})}catch{e.innerHTML=`
      <div class="empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>Session management requires authentication</p>
      </div>
    `}}function k2(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function ts(e){return`https://ui-avatars.com/api/?name=${encodeURIComponent(e||"User")}&background=e11d48&color=fff&size=200&font-size=0.4&bold=true`}async function $2(){if(Ua)return Ua;try{return Ua=(await p.get("/api/timezones")).data.timezones,Ua}catch{return[{code:"UTC",name:"Coordinated Universal Time",utc_offset:"+00:00"},{code:"Europe/Lisbon",name:"Lisbon, Portugal",utc_offset:"+00:00"},{code:"Europe/London",name:"London, United Kingdom",utc_offset:"+00:00"}]}}function S2(e,t){const a=(t||Ua||[{code:"UTC",name:"Coordinated Universal Time",utc_offset:"+00:00"}]).reduce((r,c)=>{const l=c.region||"Other";return r[l]||(r[l]=[]),r[l].push(c),r},{}),s=["Europe","Americas","Asia","Oceania","Africa","Atlantic","UTC","Other"],o=Object.keys(a).sort((r,c)=>{const l=s.indexOf(r),m=s.indexOf(c);return(l===-1?999:l)-(m===-1?999:m)});let i="";for(const r of o){i+=`<optgroup label="${r}">`;for(const c of a[r]){const l=`${c.name} (${c.utc_offset})`;i+=`<option value="${c.code}" ${e===c.code?"selected":""}>${l}</option>`}i+="</optgroup>"}return i}function C2(e){const t=new Date(e),a=new Date().getTime()-t.getTime();return a<6e4?"Just now":a<36e5?`${Math.floor(a/6e4)} min ago`:a<864e5?`${Math.floor(a/36e5)} hours ago`:a<6048e5?`${Math.floor(a/864e5)} days ago`:t.toLocaleDateString()}function Ze(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function Va(e){const t=e.querySelector("#krisp-integration-content");if(!t)return;const a=P.getState().currentUser?.role==="superadmin";try{const s=await jr(),o=await jh();if(!s){t.innerHTML=`
        <div class="krisp-not-configured">
          <p>Krisp integration is not configured yet.</p>
          <button type="button" class="btn-sota primary" id="enable-krisp-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Enable Krisp Integration
          </button>
        </div>
      `;const g=t.querySelector("#enable-krisp-btn");g&&d(g,"click",async()=>{try{await jr(),Va(e),u.success("Krisp integration enabled")}catch{u.error("Failed to enable Krisp integration")}});return}t.innerHTML=`
      <div class="krisp-config">
        ${a?`
        <div class="krisp-mcp-banner">
          <div class="mcp-icon">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <div class="mcp-info">
            <strong>MCP Direct Access</strong>
            <span>As a Super Admin, you can import meetings directly via MCP without webhook configuration.</span>
          </div>
          <button type="button" class="btn-sota primary" id="mcp-import-btn">
            Import via MCP
          </button>
        </div>
        `:""}
        
        <div class="krisp-status">
          <span class="status-indicator ${s.is_active?"active":"inactive"}"></span>
          <span>${s.is_active?"Active":"Inactive"}</span>
          <button type="button" class="btn-sota small ${s.is_active?"secondary":"primary"}" id="toggle-krisp-btn">
            ${s.is_active?"Disable":"Enable"}
          </button>
        </div>

        <div class="form-field">
          <label>Webhook URL</label>
          <div class="input-with-copy">
            <input type="text" value="${Ze(s.webhook_url)}" readonly>
            <button type="button" class="btn-copy" data-copy="${Ze(s.webhook_url)}" title="Copy URL">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-field">
          <label>Authorization Token</label>
          <div class="input-with-copy">
            <input type="password" value="${Ze(s.webhook_secret)}" readonly id="krisp-secret-input">
            <button type="button" class="btn-toggle-visibility" id="toggle-secret-btn" title="Show/Hide">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
            <button type="button" class="btn-copy" data-copy="${Ze(s.webhook_secret)}" title="Copy Token">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
          </div>
          <span class="form-hint">Use this token in the Authorization header when configuring Krisp webhook.</span>
        </div>

        <div class="krisp-stats">
          <div class="stat">
            <span class="stat-value">${o?.total_count||0}</span>
            <span class="stat-label">Total Transcripts</span>
          </div>
          <div class="stat">
            <span class="stat-value">${o?.processed_count||0}</span>
            <span class="stat-label">Processed</span>
          </div>
          <div class="stat ${(o?.quarantine_count||0)+(o?.ambiguous_count||0)>0?"warning":""}">
            <span class="stat-value">${(o?.quarantine_count||0)+(o?.ambiguous_count||0)}</span>
            <span class="stat-label">Need Attention</span>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-sota secondary" id="regenerate-krisp-btn">
            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Regenerate Credentials
          </button>
          <a href="#" class="btn-sota primary" id="view-transcripts-btn">
            View Transcripts
          </a>
        </div>
      </div>
      
      <style>
        .krisp-config { padding: 16px 0; }
        .krisp-status { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .status-indicator.active { background: #22c55e; }
        .status-indicator.inactive { background: #94a3b8; }
        .input-with-copy { display: flex; gap: 8px; }
        .input-with-copy input { flex: 1; }
        .btn-copy, .btn-toggle-visibility { padding: 8px; background: var(--bg-secondary, #f1f5f9); border: 1px solid var(--border-color, #e2e8f0); border-radius: 6px; cursor: pointer; }
        .btn-copy:hover, .btn-toggle-visibility:hover { background: var(--bg-tertiary, #e2e8f0); }
        .krisp-stats { display: flex; gap: 16px; margin: 24px 0; padding: 16px; background: var(--bg-secondary, #f8fafc); border-radius: 12px; }
        .stat { flex: 1; text-align: center; }
        .stat-value { display: block; font-size: 24px; font-weight: 600; color: var(--text-primary, #1e293b); }
        .stat-label { font-size: 12px; color: var(--text-secondary, #64748b); }
        .stat.warning .stat-value { color: #f59e0b; }
        .btn-sota.small { padding: 4px 12px; font-size: 12px; }
        .krisp-not-configured { text-align: center; padding: 32px; }
        .krisp-not-configured p { margin-bottom: 16px; color: var(--text-secondary, #64748b); }
        .krisp-mcp-banner {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px;
          background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
          border: 1px solid #93c5fd;
          border-radius: 12px;
          margin-bottom: 20px;
        }
        .mcp-icon {
          width: 40px;
          height: 40px;
          background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }
        .mcp-icon svg { color: white; }
        .mcp-info {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }
        .mcp-info strong {
          font-size: 14px;
          color: #1e40af;
        }
        .mcp-info span {
          font-size: 12px;
          color: #3b82f6;
        }
        .krisp-mcp-banner .btn-sota {
          flex-shrink: 0;
        }
        [data-theme="dark"] .krisp-mcp-banner {
          background: linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(29,78,216,0.1) 100%);
          border-color: rgba(59,130,246,0.3);
        }
        [data-theme="dark"] .mcp-info strong { color: #93c5fd; }
        [data-theme="dark"] .mcp-info span { color: #60a5fa; }
        [data-theme="dark"] .krisp-stats { background: rgba(30,41,59,0.5); }
        [data-theme="dark"] .btn-copy, [data-theme="dark"] .btn-toggle-visibility { background: rgba(30,41,59,0.8); border-color: rgba(255,255,255,0.1); }
      </style>
    `,t.querySelectorAll(".btn-copy").forEach(g=>{d(g,"click",()=>{const f=g.getAttribute("data-copy")||"";navigator.clipboard.writeText(f),u.success("Copied to clipboard")})});const i=t.querySelector("#toggle-secret-btn"),r=t.querySelector("#krisp-secret-input");i&&r&&d(i,"click",()=>{r.type=r.type==="password"?"text":"password"});const c=t.querySelector("#mcp-import-btn");c&&d(c,"click",async()=>{H(Vn);const{showKrispManager:g}=await Y(async()=>{const{showKrispManager:f}=await import("./KrispManager-Ch5caStR.js");return{showKrispManager:f}},__vite__mapDeps([0,1]));g("import")});const l=t.querySelector("#toggle-krisp-btn");l&&d(l,"click",async()=>{const g=!s.is_active;await Eh(g)?(u.success(g?"Krisp integration enabled":"Krisp integration disabled"),Va(e)):u.error("Failed to update integration")});const m=t.querySelector("#regenerate-krisp-btn");m&&d(m,"click",async()=>{if(!confirm("Are you sure? You will need to update the webhook URL in Krisp."))return;await Ah()?(u.success("Credentials regenerated"),Va(e)):u.error("Failed to regenerate credentials")});const v=t.querySelector("#view-transcripts-btn");v&&d(v,"click",async g=>{g.preventDefault(),H(Vn);const{showKrispManager:f}=await Y(async()=>{const{showKrispManager:b}=await import("./KrispManager-Ch5caStR.js");return{showKrispManager:b}},__vite__mapDeps([0,1]));f()})}catch(s){console.error("[ProfileModal] Krisp integration error:",s),t.innerHTML=`
      <div class="error-message">
        <p>Failed to load Krisp integration. Please try again.</p>
        <button type="button" class="btn-sota secondary" id="retry-krisp-btn">Retry</button>
      </div>
    `;const o=t.querySelector("#retry-krisp-btn");o&&d(o,"click",()=>Va(e))}}function L2(){H(Vn)}const bn="fact-modal";function vr(e){const t=e.mode==="create"?"Add Fact":e.mode==="edit"?"Edit Fact":"View Fact",n=fe({id:bn,title:t,size:"md",content:M2(e),onClose:e.onClose});document.body.appendChild(n),he(bn)}function M2(e){const t=x("div",{className:"fact-modal-content"}),n=e.fact,a=e.mode==="view";return t.innerHTML=`
    <form id="fact-form" class="fact-form">
      <div class="form-group">
        <label for="content">Fact Content *</label>
        <textarea id="content" name="content" rows="4" required 
                  ${a?"disabled":""}
                  placeholder="Enter the fact...">${Ba(n?.content||"")}</textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="source">Source</label>
          <input type="text" id="source" name="source" 
                 ${a?"disabled":""}
                 value="${Ba(n?.source||"")}"
                 placeholder="Document, conversation, etc.">
        </div>
        <div class="form-group">
          <label for="category">Category</label>
          <input type="text" id="category" name="category" 
                 ${a?"disabled":""}
                 value="${Ba(n?.category||"")}"
                 placeholder="Technical, Business, etc.">
        </div>
      </div>

      ${n?.verified?`
        <div class="verified-info">
          <span class="verified-badge">‚úì Verified</span>
          ${n.verified_by?`<span>by ${Ba(n.verified_by)}</span>`:""}
          ${n.verified_at?`<span>on ${Vo(n.verified_at)}</span>`:""}
        </div>
      `:""}

      ${n?.source_file?`
        <div class="source-file">
          <span class="label">Source File:</span>
          <span class="value">${Ba(n.source_file)}</span>
        </div>
      `:""}

      ${n?`
        <div class="metadata">
          <span>Created: ${Vo(n.created_at)}</span>
          ${n.updated_at?`<span>Updated: ${Vo(n.updated_at)}</span>`:""}
        </div>
      `:""}

      <div class="form-actions">
        ${e.mode==="view"?`
          <button type="button" class="btn btn-secondary" id="edit-btn">Edit</button>
          ${n?.verified?"":'<button type="button" class="btn btn-success" id="verify-btn">Verify</button>'}
          <button type="button" class="btn btn-danger" id="delete-btn">Delete</button>
        `:`
          <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn btn-primary">
            ${e.mode==="create"?"Add Fact":"Save Changes"}
          </button>
        `}
      </div>
    </form>
  `,q2(t,e),t}function q2(e,t){const n=e.querySelector("#fact-form");n&&d(n,"submit",async r=>{r.preventDefault();const c=new FormData(n),l={content:c.get("content"),source:c.get("source")||void 0,category:c.get("category")||void 0};if(!l.content.trim()){u.error("Fact content is required");return}try{let m;t.mode==="create"?(m=await Ee.create(l),u.success("Fact added")):(m=await Ee.update(t.fact.id,l),u.success("Fact updated")),H(bn),t.onSave?.(m)}catch{u.error("Failed to save fact")}});const a=e.querySelector("#cancel-btn");a&&d(a,"click",()=>{H(bn)});const s=e.querySelector("#edit-btn");s&&d(s,"click",()=>{H(bn),vr({...t,mode:"edit"})});const o=e.querySelector("#verify-btn");o&&t.fact&&d(o,"click",async()=>{try{const r=await Ee.verify(t.fact.id);u.success("Fact verified"),H(bn),t.onSave?.(r)}catch{u.error("Failed to verify fact")}});const i=e.querySelector("#delete-btn");i&&t.fact&&d(i,"click",async()=>{if(confirm("Are you sure you want to delete this fact?"))try{await Ee.delete(t.fact.id),u.success("Fact deleted"),H(bn),t.onDelete?.(t.fact.id)}catch{u.error("Failed to delete fact")}})}function Vo(e){return new Date(e).toLocaleDateString()}function Ba(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Nd(){H(bn)}const So=Object.freeze(Object.defineProperty({__proto__:null,closeFactModal:Nd,showFactModal:vr},Symbol.toStringTag,{value:"Module"}));function $c(e,t){const n=document.querySelector(".conversation-preview-overlay");n&&n.remove();const a=document.createElement("div");a.className="conversation-preview-modal",a.innerHTML=`
    <style>
      .conversation-preview-modal {
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-height: 800px;
        width: 900px;
        max-width: 95vw;
      }
      .conv-preview-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), transparent);
      }
      .conv-preview-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: rgba(var(--primary-rgb), 0.1);
        border-radius: 12px;
      }
      .conv-preview-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 4px 0;
      }
      .conv-preview-meta {
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        gap: 16px;
      }
      .conv-preview-tabs {
        display: flex;
        gap: 4px;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .conv-preview-tab {
        padding: 12px 16px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s ease;
      }
      .conv-preview-tab:hover {
        color: var(--text-primary);
      }
      .conv-preview-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .conv-preview-tab-badge {
        background: var(--bg-tertiary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 6px;
      }
      .conv-preview-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
      }
      .conv-preview-section {
        display: none;
      }
      .conv-preview-section.active {
        display: block;
      }
      .messages-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .message-item {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
      }
      .message-speaker {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 4px;
      }
      .message-text {
        color: var(--text-primary);
        line-height: 1.5;
      }
      .message-time {
        font-size: 11px;
        color: var(--text-tertiary);
        margin-top: 4px;
      }
      .entity-card {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .entity-type {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }
      .entity-content {
        color: var(--text-primary);
      }
      .entity-meta {
        font-size: 12px;
        color: var(--text-tertiary);
        margin-top: 4px;
      }
      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
      }
      .empty-section {
        text-align: center;
        padding: 40px;
        color: var(--text-tertiary);
      }
      .notes-rendered {
        padding: 20px;
        background: var(--bg-secondary);
        border-radius: 12px;
        line-height: 1.7;
      }
      .notes-header {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .notes-meta {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
      }
      .notes-topic {
        margin-bottom: 20px;
      }
      .notes-topic-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 10px;
        padding-left: 8px;
        border-left: 3px solid var(--primary);
      }
      .notes-bullet {
        padding: 10px 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 14px;
        line-height: 1.6;
      }
    </style>
    
    <div class="conv-preview-header">
      <div class="conv-preview-icon">üí¨</div>
      <div style="flex: 1;">
        <h2 class="conv-preview-title">${Ie(e.title||"Untitled Conversation")}</h2>
        <div class="conv-preview-meta">
          <span>${e.participants?.length||0} participants</span>
          <span>${e.messages?.length||0} messages</span>
          <span>${J(e.created_at)}</span>
        </div>
      </div>
      <button class="btn btn-sm close-btn" style="font-size: 20px; padding: 4px 12px;">√ó</button>
    </div>
    
    <div class="conv-preview-tabs">
      <button class="conv-preview-tab active" data-tab="messages">Messages</button>
      <button class="conv-preview-tab" data-tab="entities">
        Entities
        <span class="conv-preview-tab-badge" id="entities-count">0</span>
      </button>
      <button class="conv-preview-tab" data-tab="extraction">
        Extraction
        <span class="conv-preview-tab-badge" id="extraction-count">0</span>
      </button>
      <button class="conv-preview-tab" data-tab="notes" id="notes-tab" style="display:none">
        Notes
      </button>
    </div>
    
    <div class="conv-preview-body">
      <div class="conv-preview-section active" data-section="messages" id="messages-container">
        <div class="messages-list">
          ${(e.messages||[]).map(r=>`
            <div class="message-item">
              <div class="message-speaker">${Ie(r.speaker||"Unknown")}</div>
              <div class="message-text">${Ie(r.text||"")}</div>
              ${r.timestamp?`<div class="message-time">${r.timestamp}</div>`:""}
            </div>
          `).join("")}
        </div>
      </div>
      
      <div class="conv-preview-section" data-section="entities" id="entities-container">
        <div class="empty-section">Loading entities...</div>
      </div>
      
      <div class="conv-preview-section" data-section="extraction" id="extraction-container">
        <div class="empty-section">Loading extraction results...</div>
      </div>
      
      <div class="conv-preview-section" data-section="notes" id="notes-container">
        <div class="empty-section">No notes available</div>
      </div>
    </div>
  `,a.querySelectorAll(".conv-preview-tab").forEach(r=>{r.addEventListener("click",()=>{const c=r.dataset.tab;a.querySelectorAll(".conv-preview-tab").forEach(l=>l.classList.remove("active")),r.classList.add("active"),a.querySelectorAll(".conv-preview-section").forEach(l=>l.classList.remove("active")),a.querySelector(`[data-section="${c}"]`)?.classList.add("active")})}),a.querySelector(".close-btn")?.addEventListener("click",()=>{s.remove()}),T2(a,e);const s=document.createElement("div");s.className="modal-overlay conversation-preview-overlay",s.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;const o=document.createElement("div");o.style.cssText=`
    background: var(--bg-primary);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden;
  `,o.appendChild(a),s.appendChild(o),s.addEventListener("click",r=>{r.target===s&&s.remove()});const i=r=>{r.key==="Escape"&&(s.remove(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i),document.body.appendChild(s)}function T2(e,t){const n=t.metadata,a=n?.extraction_result,s=n?.extractedEntities||a?.entities||[],o=e.querySelector("#entities-container"),i=e.querySelector("#entities-count");i&&(i.textContent=String(s.length)),s.length>0?o.innerHTML=s.map(M=>`
      <div class="entity-card">
        <div class="entity-type">${Ie(M.type)}</div>
        <div class="entity-content">${Ie(M.name)}</div>
        ${M.confidence?`<div class="entity-meta">Confidence: ${Math.round(M.confidence*100)}%</div>`:""}
      </div>
    `).join(""):o.innerHTML='<div class="empty-section">No entities extracted</div>';const r=e.querySelector("#extraction-container"),c=a?.facts||[],l=a?.decisions||[],m=a?.action_items||[],v=a?.questions||[],g=e.querySelector("#extraction-count"),f=c.length+l.length+m.length+v.length;if(g&&(g.textContent=String(f)),f>0){let M="";c.length>0&&(M+=`<div class="section-title">Facts (${c.length})</div>`,M+=c.map(q=>`
        <div class="entity-card">
          <div class="entity-type">${q.category||"fact"}</div>
          <div class="entity-content">${Ie(q.content)}</div>
        </div>
      `).join("")),l.length>0&&(M+=`<div class="section-title" style="margin-top: 20px;">Decisions (${l.length})</div>`,M+=l.map(q=>`
        <div class="entity-card">
          <div class="entity-content">${Ie(q.content)}</div>
        </div>
      `).join("")),m.length>0&&(M+=`<div class="section-title" style="margin-top: 20px;">Action Items (${m.length})</div>`,M+=m.map(q=>`
        <div class="entity-card">
          <div class="entity-content">${Ie(q.task)}</div>
          ${q.owner?`<div class="entity-meta">Owner: ${Ie(q.owner)}</div>`:""}
        </div>
      `).join("")),v.length>0&&(M+=`<div class="section-title" style="margin-top: 20px;">Questions (${v.length})</div>`,M+=v.map(q=>`
        <div class="entity-card">
          <div class="entity-content">${Ie(q.content)}</div>
        </div>
      `).join("")),r.innerHTML=M}else r.innerHTML='<div class="empty-section">No extraction results available</div>';const b=e.querySelector("#notes-container"),w=e.querySelector("#notes-tab"),$=a?.notes_rendered_text;if($)w&&(w.style.display=""),b.innerHTML=`
      <div class="notes-rendered">
        ${A2($)}
        <div style="margin-top: 16px;">
          <button class="btn btn-secondary btn-sm" id="copy-notes-btn">üìã Copy Notes</button>
        </div>
      </div>
    `,e.querySelector("#copy-notes-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText($),u.success("Notes copied to clipboard")});else if(a?.notes?.outline?.length){w&&(w.style.display="");const M=a.notes.outline;b.innerHTML=`
      <div class="notes-rendered">
        ${M.map(q=>`
          <div class="notes-topic">
            <div class="notes-topic-title">${Ie(q.topic)}</div>
            ${q.bullets?.map(C=>`<div class="notes-bullet">${Ie(C.text)}</div>`).join("")||""}
          </div>
        `).join("")}
      </div>
    `}}function A2(e){const t=e.split(`
`);let n="",a="",s="",o=!1,i=!1;const r=()=>{a&&s&&(n+=`
        <div class="notes-topic">
          <div class="notes-topic-title">${Ie(a)}</div>
          ${s}
        </div>
      `),a="",s=""};for(const c of t){const l=c.trim();if(l){if(!o&&l.startsWith("üìù")){n+=`<div class="notes-header">${Ie(l)}</div>`,o=!0;continue}if(!i&&l.startsWith("üïû")){n+=`<div class="notes-meta">${Ie(l)}</div>`,i=!0;continue}if(l.startsWith("-")){const m=l.substring(1).trim();s+=`<div class="notes-bullet">${Ie(m)}</div>`;continue}r(),a=l}}return r(),n.includes("notes-topic")?n:`<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; line-height: 1.6;">${Ie(e)}</pre>`}function Ie(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Sc(e,t){const n=document.querySelector(".email-preview-overlay");n&&n.remove();const a=e.extracted_entities,s=a&&(a.key_points?.length||a.action_items?.length||a.entities?.length),o=document.createElement("div");o.className="email-preview-modal",o.innerHTML=`
    <style>
      .email-preview-modal {
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-height: 800px;
        width: 900px;
        max-width: 95vw;
      }
      .email-preview-header {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), transparent);
      }
      .email-preview-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: rgba(var(--primary-rgb), 0.1);
        border-radius: 12px;
        flex-shrink: 0;
      }
      .email-preview-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 8px 0;
        line-height: 1.3;
      }
      .email-preview-meta {
        font-size: 13px;
        color: var(--text-secondary);
      }
      .email-preview-meta-row {
        display: flex;
        gap: 8px;
        margin-bottom: 4px;
      }
      .email-preview-meta-label {
        color: var(--text-tertiary);
        min-width: 40px;
      }
      .email-preview-badges {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }
      .email-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }
      .email-badge.intent {
        background: rgba(var(--primary-rgb), 0.1);
        color: var(--primary);
      }
      .email-badge.sentiment-positive {
        background: rgba(46, 160, 67, 0.1);
        color: #2ea043;
      }
      .email-badge.sentiment-negative {
        background: rgba(248, 81, 73, 0.1);
        color: #f85149;
      }
      .email-badge.sentiment-neutral {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }
      .email-badge.response-needed {
        background: rgba(248, 81, 73, 0.1);
        color: #f85149;
      }
      .email-preview-tabs {
        display: flex;
        gap: 4px;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .email-preview-tab {
        padding: 12px 16px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s ease;
      }
      .email-preview-tab:hover {
        color: var(--text-primary);
      }
      .email-preview-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .email-preview-tab-badge {
        background: var(--bg-tertiary);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 6px;
      }
      .email-preview-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
      }
      .email-preview-section {
        display: none;
      }
      .email-preview-section.active {
        display: block;
      }
      .email-content-body {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 12px;
        line-height: 1.7;
      }
      .extraction-card {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .extraction-type {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }
      .extraction-content {
        color: var(--text-primary);
      }
      .extraction-meta {
        font-size: 12px;
        color: var(--text-tertiary);
        margin-top: 4px;
      }
      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
      }
      .empty-section {
        text-align: center;
        padding: 40px;
        color: var(--text-tertiary);
      }
      .ai-summary-box {
        padding: 16px;
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), transparent);
        border-left: 3px solid var(--primary);
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .ai-summary-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .key-points-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .key-points-list li {
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        gap: 8px;
      }
      .key-points-list li:last-child {
        border-bottom: none;
      }
      .key-points-list li::before {
        content: "‚Ä¢";
        color: var(--primary);
      }
      .contact-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .contact-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--text-secondary);
      }
      .contact-info {
        flex: 1;
      }
      .contact-name {
        font-weight: 600;
      }
      .contact-details {
        font-size: 12px;
        color: var(--text-secondary);
      }
    </style>
    
    <div class="email-preview-header">
      <div class="email-preview-icon">üìß</div>
      <div style="flex: 1;">
        <h2 class="email-preview-title">${De(e.subject||"No Subject")}</h2>
        <div class="email-preview-meta">
          <div class="email-preview-meta-row">
            <span class="email-preview-meta-label">From:</span>
            <span><strong>${De(e.from?.name||"")}</strong> &lt;${De(e.from?.email||"")}&gt;</span>
          </div>
          <div class="email-preview-meta-row">
            <span class="email-preview-meta-label">To:</span>
            <span>${(e.to||[]).map(l=>De(l.name||l.email)).join(", ")}</span>
          </div>
          <div class="email-preview-meta-row">
            <span class="email-preview-meta-label">Date:</span>
            <span>${J(e.date)}</span>
          </div>
        </div>
        <div class="email-preview-badges">
          ${a?.intent?`<span class="email-badge intent">üìã ${De(a.intent)}</span>`:""}
          ${a?.sentiment?`<span class="email-badge sentiment-${a.sentiment}">${E2(a.sentiment)} ${De(a.sentiment)}</span>`:""}
          ${e.requires_response?'<span class="email-badge response-needed">‚ö†Ô∏è Response Needed</span>':""}
        </div>
      </div>
      <button class="btn btn-sm close-btn" style="font-size: 20px; padding: 4px 12px;">√ó</button>
    </div>
    
    <div class="email-preview-tabs">
      <button class="email-preview-tab active" data-tab="content">Content</button>
      <button class="email-preview-tab" data-tab="analysis" ${s?"":'style="display:none"'}>
        Analysis
      </button>
      <button class="email-preview-tab" data-tab="entities" ${a?.entities?.length?"":'style="display:none"'}>
        Entities
        <span class="email-preview-tab-badge">${a?.entities?.length||0}</span>
      </button>
      <button class="email-preview-tab" data-tab="contacts" ${a?.contacts?.length?"":'style="display:none"'}>
        Contacts
        <span class="email-preview-tab-badge">${a?.contacts?.length||0}</span>
      </button>
    </div>
    
    <div class="email-preview-body">
      <div class="email-preview-section active" data-section="content">
        ${a?.summary||e.ai_summary?`
          <div class="ai-summary-box">
            <div class="ai-summary-label">ü§ñ AI Summary</div>
            <div>${De(a?.summary||e.ai_summary||"")}</div>
          </div>
        `:""}
        <div class="email-content-body">
          ${e.body_html||De(e.body||"").replace(/\n/g,"<br>")}
        </div>
      </div>
      
      <div class="email-preview-section" data-section="analysis">
        ${a?.key_points?.length?`
          <div class="section-title">Key Points</div>
          <ul class="key-points-list">
            ${a.key_points.map(l=>`<li>${De(l)}</li>`).join("")}
          </ul>
        `:""}
        
        ${a?.action_items?.length?`
          <div class="section-title" style="margin-top: 20px;">Action Items</div>
          ${a.action_items.map(l=>`
            <div class="extraction-card">
              <div class="extraction-content">‚òê ${De(l.task)}</div>
              ${l.owner?`<div class="extraction-meta">Owner: ${De(l.owner)}</div>`:""}
            </div>
          `).join("")}
        `:""}
        
        ${a?.questions?.length?`
          <div class="section-title" style="margin-top: 20px;">Questions</div>
          ${a.questions.map(l=>`
            <div class="extraction-card">
              <div class="extraction-content">‚ùì ${De(l)}</div>
            </div>
          `).join("")}
        `:""}
        
        ${!a?.key_points?.length&&!a?.action_items?.length&&!a?.questions?.length?`
          <div class="empty-section">No analysis available</div>
        `:""}
      </div>
      
      <div class="email-preview-section" data-section="entities">
        ${a?.entities?.length?a.entities.map(l=>`
          <div class="extraction-card">
            <div class="extraction-type">${De(l.type)}</div>
            <div class="extraction-content">${De(l.name)}</div>
            ${l.confidence?`<div class="extraction-meta">Confidence: ${Math.round(l.confidence*100)}%</div>`:""}
          </div>
        `).join(""):'<div class="empty-section">No entities extracted</div>'}
      </div>
      
      <div class="email-preview-section" data-section="contacts">
        ${a?.contacts?.length?a.contacts.map(l=>`
          <div class="contact-card">
            <div class="contact-avatar">${_2(l.name)}</div>
            <div class="contact-info">
              <div class="contact-name">${De(l.name)}</div>
              <div class="contact-details">
                ${l.title?De(l.title)+(l.organization?" at ":""):""}
                ${l.organization?De(l.organization):""}
                ${l.email?`<br>${De(l.email)}`:""}
              </div>
            </div>
          </div>
        `).join(""):'<div class="empty-section">No contacts extracted</div>'}
      </div>
    </div>
  `,o.querySelectorAll(".email-preview-tab").forEach(l=>{l.addEventListener("click",()=>{const m=l.dataset.tab;o.querySelectorAll(".email-preview-tab").forEach(v=>v.classList.remove("active")),l.classList.add("active"),o.querySelectorAll(".email-preview-section").forEach(v=>v.classList.remove("active")),o.querySelector(`[data-section="${m}"]`)?.classList.add("active")})}),o.querySelector(".close-btn")?.addEventListener("click",()=>{i.remove()});const i=document.createElement("div");i.className="modal-overlay email-preview-overlay",i.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;const r=document.createElement("div");r.style.cssText=`
    background: var(--bg-primary);
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden;
  `,r.appendChild(o),i.appendChild(r),i.addEventListener("click",l=>{l.target===i&&i.remove()});const c=l=>{l.key==="Escape"&&(i.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),document.body.appendChild(i)}function E2(e){switch(e?.toLowerCase()){case"positive":return"üòä";case"negative":return"üòü";default:return"üòê"}}function _2(e){return e.split(" ").map(t=>t[0]).slice(0,2).join("").toUpperCase()}function De(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let qi=null,As=!1;function Fd(e={}){const t=x("div",{className:"briefing-panel"});t.innerHTML=`
    <div class="briefing-header">
      <h2>Daily Briefing</h2>
      <div class="briefing-actions">
        <button class="btn btn-sm" id="toggle-history-btn">History</button>
        <button class="btn btn-sm btn-primary" id="refresh-briefing-btn">Refresh</button>
      </div>
    </div>
    <div class="briefing-content" id="briefing-content">
      <div class="loading">Generating briefing...</div>
    </div>
    <div class="briefing-history hidden" id="briefing-history"></div>
  `;const n=t.querySelector("#refresh-briefing-btn");n&&d(n,"click",()=>Cc(t,!0,e));const a=t.querySelector("#toggle-history-btn");return a&&d(a,"click",()=>{As=!As;const s=t.querySelector("#briefing-history");s.classList.toggle("hidden",!As),As&&j2(s)}),Cc(t,!1,e),t}async function Cc(e,t,n){const a=e.querySelector("#briefing-content");a.innerHTML='<div class="loading">Generating briefing...</div>';try{const s=await us.getBriefing(t);qi=s,Od(a,s,n)}catch{a.innerHTML='<div class="error">Failed to generate briefing</div>'}}function Od(e,t,n){e.innerHTML=`
    <div class="briefing-meta">
      <span class="briefing-date">${fr(t.generated_at)}</span>
      ${t.cached?'<span class="cached-badge">Cached</span>':""}
    </div>

    <div class="briefing-text">
      ${Ti(t.briefing)}
    </div>

    ${t.analysis?`
      <div class="briefing-analysis">
        <h4>Analysis</h4>
        <div class="analysis-content">${Ti(t.analysis)}</div>
      </div>
    `:""}

  `}async function j2(e){e.innerHTML='<div class="loading">Loading history...</div>';try{const t=await us.getBriefingHistory(10);if(!t||t.length===0){e.innerHTML='<p class="empty">No previous briefings</p>';return}e.innerHTML=`
      <h4>Previous Briefings</h4>
      <div class="history-list">
        ${t.map(n=>`
          <div class="history-item" data-id="${n.id}">
            <div class="history-date">${fr(n.generated_at)}</div>
            <div class="history-preview">${P2(n.briefing.substring(0,150))}...</div>
          </div>
        `).join("")}
      </div>
    `,e.querySelectorAll(".history-item").forEach(n=>{d(n,"click",()=>{const a=n.getAttribute("data-id"),s=t.find(o=>o.id===a);s&&D2(e.closest(".briefing-panel"),s)})})}catch{e.innerHTML='<div class="error">Failed to load history</div>'}}function D2(e,t){const n=e.querySelector("#briefing-content");n.innerHTML=`
    <div class="history-detail">
      <button class="btn btn-sm back-btn" id="back-to-current">‚Üê Back to current</button>
      <div class="briefing-meta">
        <span class="briefing-date">${fr(t.generated_at)}</span>
        <span class="history-badge">Historical</span>
      </div>
      <div class="briefing-text">${Ti(t.briefing)}</div>
    </div>
  `;const a=n.querySelector("#back-to-current");a&&qi&&d(a,"click",()=>{Od(n,qi)})}function Ti(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*$)/gm,"<h5>$1</h5>").replace(/^## (.*$)/gm,"<h4>$1</h4>").replace(/^# (.*$)/gm,"<h3>$1</h3>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/gs,"<ul>$1</ul>").replace(/\n\n/g,"</p><p>").replace(/^(.+)$/gm,"<p>$1</p>").replace(/<p><\/p>/g,"").replace(/<p>(<[hul])/g,"$1").replace(/(<\/[hul][^>]*>)<\/p>/g,"$1")}function fr(e){return new Date(e).toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}function P2(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const H2=Object.freeze(Object.defineProperty({__proto__:null,createBriefingPanel:Fd},Symbol.toStringTag,{value:"Module"}));let Ga="",eo="weekly";function z2(e={}){const t=x("div",{className:"reports-panel"});t.innerHTML=`
    <div class="reports-header">
      <h2>Reports</h2>
      <div class="reports-actions">
        <button class="btn btn-sm" id="export-md-btn">Export MD</button>
        <button class="btn btn-sm btn-primary" id="export-pdf-btn">Export PDF</button>
      </div>
    </div>
    <div class="reports-tabs">
      <button class="report-tab active" data-type="weekly">Weekly Report</button>
      <button class="report-tab" data-type="executive">Executive Summary</button>
    </div>
    <div class="reports-content" id="reports-content">
      <div class="loading">Generating report...</div>
    </div>
  `;const n=t.querySelectorAll(".report-tab");n.forEach(o=>{d(o,"click",()=>{n.forEach(i=>i.classList.remove("active")),o.classList.add("active"),eo=o.getAttribute("data-type"),Lc(t,eo)})});const a=t.querySelector("#export-md-btn");a&&d(a,"click",()=>Mc("md",e));const s=t.querySelector("#export-pdf-btn");return s&&d(s,"click",()=>Mc("pdf",e)),Lc(t,"weekly"),t}async function Lc(e,t){const n=e.querySelector("#reports-content");n.innerHTML='<div class="loading">Generating report...</div>';try{let a;t==="weekly"?a=await us.getWeeklyReport():a=await us.generateExecutiveSummary(),Ga=a,B2(n,a)}catch{n.innerHTML='<div class="error">Failed to generate report</div>'}}function B2(e,t){e.innerHTML=`
    <div class="report-preview">
      ${Ai(t)}
    </div>
  `}async function Mc(e,t){if(!Ga){u.error("No report to export");return}if(t.onExport){t.onExport(e,Ga);return}e==="md"?(Ud(`${eo}-report.md`,Ga,"text/markdown"),u.success("Report downloaded")):e==="pdf"&&await I2(Ga,`${eo}-report`)}function Ud(e,t,n){const a=new Blob([t],{type:n}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}async function I2(e,t){const n=window.html2pdf;if(!n){const s=`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>${t}</title>
        <style>
          body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; }
          h1 { color: #1a1a2e; }
          h2 { color: #16213e; border-bottom: 1px solid #eee; padding-bottom: 10px; }
          h3 { color: #0f3460; }
          ul { padding-left: 20px; }
          li { margin: 5px 0; }
        </style>
      </head>
      <body>
        ${Ai(e)}
      </body>
      </html>
    `;Ud(`${t}.html`,s,"text/html"),u.info("Downloaded as HTML (PDF library not available)");return}const a=document.createElement("div");a.innerHTML=Ai(e),a.style.cssText="font-family: system-ui, sans-serif; padding: 40px; max-width: 800px;",document.body.appendChild(a);try{await n(a).save(`${t}.pdf`),u.success("PDF exported")}catch{u.error("Failed to export PDF")}finally{document.body.removeChild(a)}}function Ai(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/^- (.*$)/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/gs,"<ul>$1</ul>").replace(/\n\n/g,"</p><p>").replace(/^(.+)$/gm,"<p>$1</p>").replace(/<p><\/p>/g,"").replace(/<p>(<[hul])/g,"$1").replace(/(<\/[hul][^>]*>)<\/p>/g,"$1")}let to="",da={},Vd=[],on=new Set;function Gd(e={}){const t=x("div",{className:"contacts-panel-sota"});return t.innerHTML=`
    <style>
      .contacts-panel-sota {
        padding: 24px;
        min-height: 100%;
      }

      /* Header */
      .contacts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .contacts-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .contacts-title-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
      }

      .contacts-title-icon svg {
        width: 26px;
        height: 26px;
        color: white;
      }

      .contacts-title h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .contacts-count {
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      .contacts-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Search Bar */
      .contacts-search-wrapper {
        position: relative;
        flex: 1;
        max-width: 400px;
        min-width: 200px;
      }

      .contacts-search-wrapper svg {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: var(--text-tertiary);
        pointer-events: none;
        transition: color 0.2s;
      }

      .contacts-search {
        width: 100%;
        padding: 12px 14px 12px 44px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s;
      }

      .contacts-search:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }

      .contacts-search:focus + svg {
        color: #e11d48;
      }

      /* SOTA Buttons */
      .btn-sota {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-sota.primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(225, 29, 72, 0.3);
      }

      .btn-sota.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(225, 29, 72, 0.4);
      }

      .btn-sota.secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-sota.secondary:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
      }

      .btn-sota svg {
        width: 16px;
        height: 16px;
      }

      /* Filters */
      .contacts-filters {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .filter-chip:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
        color: #e11d48;
      }

      .filter-chip.active {
        background: linear-gradient(135deg, rgba(225,29,72,0.1) 0%, rgba(225,29,72,0.05) 100%);
        border-color: #e11d48;
        color: #e11d48;
      }

      .filter-chip svg {
        width: 14px;
        height: 14px;
      }

      .filter-select {
        padding: 8px 32px 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 13px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
      }

      .filter-select:focus {
        outline: none;
        border-color: #e11d48;
      }

      /* Alerts */
      .contacts-alerts {
        margin-bottom: 20px;
      }

      .alert-sota {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(245,158,11,0.05) 100%);
        border: 1px solid rgba(245,158,11,0.3);
        border-radius: 12px;
        color: #d97706;
      }

      .alert-sota svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .alert-sota span {
        flex: 1;
        font-size: 14px;
      }

      .alert-sota .btn-sota {
        padding: 6px 12px;
        font-size: 12px;
      }

      /* Favorites Section */
      .favorites-section {
        margin-bottom: 28px;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 14px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .section-header svg {
        width: 16px;
        height: 16px;
        color: #f59e0b;
      }

      .favorites-grid {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
      }

      .favorite-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(245,158,11,0.02) 100%);
        border: 1px solid rgba(245,158,11,0.2);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .favorite-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245,158,11,0.15);
        border-color: #f59e0b;
      }

      .favorite-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .favorite-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .favorite-info h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .favorite-info p {
        margin: 2px 0 0 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Contacts Grid */
      .contacts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      .contact-card-sota {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.5) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
      }

      [data-theme="dark"] .contact-card-sota {
        background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(30,41,59,0.5) 100%);
      }

      .contact-card-sota:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0,0,0,0.1);
        border-color: rgba(225,29,72,0.3);
      }

      .contact-card-sota::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #e11d48, #f59e0b);
        opacity: 0;
        transition: opacity 0.2s;
      }

      .contact-card-sota:hover::before {
        opacity: 1;
      }

      .contact-card-header {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        margin-bottom: 14px;
      }

      .contact-avatar-sota {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(225,29,72,0.25);
      }

      .contact-avatar-sota img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .contact-main-info {
        flex: 1;
        min-width: 0;
      }

      .contact-name-sota {
        margin: 0 0 4px 0;
        font-size: 17px;
        font-weight: 700;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .contact-role-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: linear-gradient(135deg, rgba(225,29,72,0.1) 0%, rgba(225,29,72,0.05) 100%);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        color: #e11d48;
        margin-bottom: 4px;
      }

      .contact-org-sota {
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .contact-org-sota svg {
        width: 14px;
        height: 14px;
        opacity: 0.6;
      }

      .contact-details-sota {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
      }

      .contact-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .contact-detail-item svg {
        width: 14px;
        height: 14px;
        color: #e11d48;
        flex-shrink: 0;
      }

      .contact-detail-item span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .contact-tags-sota {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
      }

      .contact-tag {
        padding: 3px 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .contact-quick-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .contact-card-sota:hover .contact-quick-actions {
        opacity: 1;
      }

      .quick-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quick-action-btn:hover {
        background: #e11d48;
        border-color: #e11d48;
        color: white;
      }

      .quick-action-btn.favorite {
        color: #f59e0b;
      }

      .quick-action-btn.favorite.active {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
      }

      .quick-action-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Selection Checkbox */
      .contact-select-checkbox {
        position: absolute;
        top: 12px;
        left: 12px;
        width: 22px;
        height: 22px;
        border-radius: 6px;
        border: 2px solid var(--border-color);
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 5;
        opacity: 0;
      }

      .contact-card-sota:hover .contact-select-checkbox,
      .contact-card-sota.selected .contact-select-checkbox {
        opacity: 1;
      }

      .contact-select-checkbox:hover {
        border-color: #e11d48;
      }

      .contact-select-checkbox.checked {
        background: linear-gradient(135deg, #e11d48, #be123c);
        border-color: #e11d48;
      }

      .contact-select-checkbox svg {
        width: 14px;
        height: 14px;
        color: white;
        display: none;
      }

      .contact-select-checkbox.checked svg {
        display: block;
      }

      .contact-card-sota.selected {
        border-color: #e11d48;
        box-shadow: 0 0 0 2px rgba(225,29,72,0.2);
      }

      /* Selection Bar */
      .selection-bar {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #1e293b, #0f172a);
        padding: 12px 24px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }

      .selection-bar-count {
        color: white;
        font-size: 14px;
        font-weight: 600;
      }

      .selection-bar-count span {
        color: #f59e0b;
      }

      .selection-bar-btn {
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border: none;
      }

      .selection-bar-btn.merge {
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
      }

      .selection-bar-btn.merge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(225,29,72,0.4);
      }

      .selection-bar-btn.cancel {
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
      }

      .selection-bar-btn.cancel:hover {
        background: rgba(255,255,255,0.2);
      }

      .selection-bar-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Empty State */
      .contacts-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 24px;
        text-align: center;
      }

      .contacts-empty-state svg {
        width: 80px;
        height: 80px;
        color: #e11d48;
        opacity: 0.4;
        margin-bottom: 24px;
      }

      .contacts-empty-state h3 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .contacts-empty-state p {
        margin: 0 0 24px 0;
        font-size: 14px;
        color: var(--text-secondary);
      }

      /* Loading */
      .contacts-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: var(--text-secondary);
      }

      .contacts-loading::after {
        content: '';
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top-color: #e11d48;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 12px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Projects indicator */
      .contact-projects-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-tertiary);
      }

      .contact-projects-indicator svg {
        width: 14px;
        height: 14px;
      }

      .project-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e11d48;
      }
    </style>

    <!-- Header -->
    <div class="contacts-header">
      <div class="contacts-title">
        <div class="contacts-title-icon">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
        </div>
        <h1>Contacts</h1>
        <span class="contacts-count" id="contacts-count">0</span>
      </div>

      <div class="contacts-actions">
        <div class="contacts-search-wrapper">
          <input type="search" class="contacts-search" id="contacts-search" placeholder="Search contacts...">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <button class="btn-sota secondary" id="import-contacts-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          Import
        </button>
        <button class="btn-sota secondary" id="export-contacts-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Export
        </button>
        <button class="btn-sota primary" id="add-contact-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Contact
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="contacts-filters">
      <div class="filter-chip" id="filter-favorites" data-filter="favorites">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
        </svg>
        Favorites
      </div>
      <select class="filter-select" id="org-filter">
        <option value="">All Organizations</option>
      </select>
      <select class="filter-select" id="tag-filter">
        <option value="">All Tags</option>
      </select>
    </div>

    <!-- Alerts -->
    <div class="contacts-alerts" id="contacts-alerts"></div>

    <!-- Favorites Section -->
    <div class="favorites-section" id="favorites-section" style="display: none;">
      <div class="section-header">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
        </svg>
        Favorites
      </div>
      <div class="favorites-grid" id="favorites-grid"></div>
    </div>

    <!-- Main Content -->
    <div id="contacts-content">
      <div class="contacts-loading">Loading contacts</div>
    </div>
  `,R2(t,e),Mt(t,e),Q2(t),t}function R2(e,t){const n=e.querySelector("#contacts-search");let a;d(n,"input",()=>{clearTimeout(a),a=window.setTimeout(()=>{to=n.value,Mt(e,t)},300)});const s=e.querySelector("#org-filter");d(s,"change",()=>{da.organization=s.value||void 0,Mt(e,t)});const o=e.querySelector("#tag-filter");d(o,"change",()=>{da.tag=o.value||void 0,Mt(e,t)});const i=e.querySelector("#filter-favorites");i&&d(i,"click",()=>{i.classList.toggle("active"),da.favorites=i.classList.contains("active"),Mt(e,t)});const r=e.querySelector("#add-contact-btn");r&&d(r,"click",()=>{Vt({mode:"create",onSave:()=>Mt(e,t)})});const c=e.querySelector("#export-contacts-btn");c&&d(c,"click",()=>Y2());const l=e.querySelector("#import-contacts-btn");l&&d(l,"click",()=>{u.info("Import functionality coming soon")})}async function Mt(e,t){const n=e.querySelector("#contacts-content");n.innerHTML='<div class="contacts-loading">Loading contacts</div>';try{const{contacts:a,total:s}=await ke.getAll({search:to||void 0,organization:da.organization,tag:da.tag});let o=a;da.favorites&&(o=a.filter(i=>i.isFavorite)),Vd=a,N2(n,o,t),Qd(e,a.filter(i=>i.isFavorite),t),J2(e,s),W2(e,a)}catch{n.innerHTML=`
      <div class="contacts-empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <h3>Failed to load contacts</h3>
        <p>Please try again later</p>
      </div>
    `}}function N2(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="contacts-empty-state">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        <h3>${to?"No contacts match your search":"No contacts yet"}</h3>
        <p>${to?"Try a different search term":"Add your first contact to get started"}</p>
        <button class="btn-sota primary" id="empty-add-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Contact
        </button>
      </div>
    `;const a=e.querySelector("#empty-add-btn");a&&d(a,"click",()=>{Vt({mode:"create"})});return}e.innerHTML=`
    <div class="contacts-grid">
      ${t.map(a=>F2(a)).join("")}
    </div>
  `,O2(e,t,n)}function F2(e){const t=hr(e.name),n=!!(e.photoUrl||e.avatarUrl),a=e.photoUrl||e.avatarUrl,s=on.has(e.id);return`
    <div class="contact-card-sota ${s?"selected":""}" data-id="${e.id}">
      <div class="contact-select-checkbox ${s?"checked":""}" data-action="select" data-id="${e.id}">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      <div class="contact-quick-actions">
        <button class="quick-action-btn favorite ${e.isFavorite?"active":""}" data-action="favorite" data-id="${e.id}" title="Toggle favorite">
          <svg fill="${e.isFavorite?"currentColor":"none"}" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
        </button>
        <button class="quick-action-btn" data-action="edit" data-id="${e.id}" title="Edit contact">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
        </button>
      </div>

      <div class="contact-card-header">
        <div class="contact-avatar-sota">
          ${n?`<img src="${a}" alt="${Pe(e.name)}">`:t}
        </div>
        <div class="contact-main-info">
          <h3 class="contact-name-sota">${Pe(e.name)}</h3>
          ${e.role?`<span class="contact-role-badge">${Pe(e.role)}</span>`:""}
          ${e.organization?`
            <div class="contact-org-sota">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              ${Pe(e.organization)}
            </div>
          `:""}
        </div>
      </div>

      <div class="contact-details-sota">
        ${e.email?`
          <div class="contact-detail-item">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <span>${Pe(e.email)}</span>
          </div>
        `:""}
        ${e.phone?`
          <div class="contact-detail-item">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
            <span>${Pe(e.phone)}</span>
          </div>
        `:""}
      </div>

      ${e.tags&&e.tags.length>0?`
        <div class="contact-tags-sota">
          ${e.tags.slice(0,4).map(o=>`<span class="contact-tag">${Pe(o)}</span>`).join("")}
          ${e.tags.length>4?`<span class="contact-tag">+${e.tags.length-4}</span>`:""}
        </div>
      `:""}
    </div>
  `}function O2(e,t,n){const a=e.closest(".contacts-panel-sota");e.querySelectorAll(".contact-select-checkbox").forEach(s=>{d(s,"click",o=>{o.stopPropagation();const i=s.getAttribute("data-id");if(!i)return;const r=s.closest(".contact-card-sota");on.has(i)?(on.delete(i),s.classList.remove("checked"),r.classList.remove("selected")):(on.add(i),s.classList.add("checked"),r.classList.add("selected")),n&&U2(a,t,n)})}),e.querySelectorAll(".contact-card-sota").forEach(s=>{d(s,"click",o=>{if(o.target.closest(".quick-action-btn")||o.target.closest(".contact-select-checkbox"))return;const i=s.getAttribute("data-id"),r=t.find(c=>String(c.id)===i);r&&(n?.onContactClick?n.onContactClick(r):Vt({mode:"edit",contact:r,onSave:()=>Mt(a,n)}))})}),e.querySelectorAll(".quick-action-btn").forEach(s=>{d(s,"click",async o=>{o.stopPropagation();const i=s.getAttribute("data-action"),r=s.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);c&&(i==="favorite"?n&&await G2(c,s,a,n):i==="edit"&&Vt({mode:"edit",contact:c,onSave:()=>Mt(a,n)}))})})}function U2(e,t,n){const a=document.querySelector(".selection-bar");if(a&&a.remove(),on.size<2)return;const s=x("div",{className:"selection-bar"});s.innerHTML=`
    <span class="selection-bar-count"><span>${on.size}</span> contacts selected</span>
    <button class="selection-bar-btn merge" id="merge-selected-btn">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
      </svg>
      Merge Selected
    </button>
    <button class="selection-bar-btn cancel" id="cancel-selection-btn">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Cancel
    </button>
  `,document.body.appendChild(s);const o=s.querySelector("#merge-selected-btn"),i=s.querySelector("#cancel-selection-btn");d(i,"click",()=>{qc(e)}),d(o,"click",async()=>{const r=Array.from(on),c=t.filter(m=>on.has(m.id));if(await V2(c)){o.disabled=!0,o.textContent="Merging...";try{await ke.mergeContacts(r),u.success(`Merged ${r.length} contacts successfully`),qc(e),await Mt(e,n)}catch(m){const v=m instanceof Error?m.message:"Failed to merge contacts";u.error(v),o.disabled=!1,o.innerHTML=`
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        Merge Selected
      `}}})}function V2(e){return new Promise(t=>{const n=x("div",{className:"merge-confirm-overlay"});e[0],e.slice(1),n.innerHTML=`
      <style>
        .merge-confirm-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(4px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        
        .merge-confirm-modal {
          background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
          border-radius: 16px;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          max-width: 480px;
          width: 90%;
          overflow: hidden;
          animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        
        .merge-confirm-header {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          color: white;
          padding: 20px 24px;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .merge-confirm-header svg {
          width: 24px;
          height: 24px;
        }
        
        .merge-confirm-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
        }
        
        .merge-confirm-body {
          padding: 24px;
        }
        
        .merge-confirm-body p {
          margin: 0 0 16px 0;
          color: #64748b;
          font-size: 14px;
        }
        
        .merge-contact-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 16px;
        }
        
        .merge-contact-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          background: #f8fafc;
          border-radius: 10px;
          border: 1px solid #e2e8f0;
        }
        
        .merge-contact-item.primary {
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          border-color: #f59e0b;
        }
        
        .merge-contact-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 14px;
          flex-shrink: 0;
        }
        
        .merge-contact-avatar img {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
        }
        
        .merge-contact-info {
          flex: 1;
          min-width: 0;
        }
        
        .merge-contact-name {
          font-weight: 600;
          color: #1e293b;
          font-size: 14px;
          margin-bottom: 2px;
        }
        
        .merge-contact-details {
          font-size: 12px;
          color: #64748b;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .merge-contact-badge {
          background: #f59e0b;
          color: white;
          font-size: 10px;
          font-weight: 600;
          padding: 4px 8px;
          border-radius: 6px;
          text-transform: uppercase;
        }
        
        .merge-warning {
          display: flex;
          align-items: flex-start;
          gap: 10px;
          padding: 12px;
          background: #fef3c7;
          border-radius: 10px;
          margin-top: 16px;
        }
        
        .merge-warning svg {
          width: 18px;
          height: 18px;
          color: #d97706;
          flex-shrink: 0;
          margin-top: 1px;
        }
        
        .merge-warning p {
          margin: 0;
          color: #92400e;
          font-size: 13px;
          line-height: 1.5;
        }
        
        .merge-confirm-footer {
          display: flex;
          gap: 12px;
          padding: 16px 24px 24px;
          justify-content: flex-end;
        }
        
        .merge-confirm-btn {
          padding: 10px 20px;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .merge-confirm-btn.cancel {
          background: #f1f5f9;
          border: 1px solid #e2e8f0;
          color: #64748b;
        }
        
        .merge-confirm-btn.cancel:hover {
          background: #e2e8f0;
        }
        
        .merge-confirm-btn.confirm {
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          border: none;
          color: white;
          box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
        }
        
        .merge-confirm-btn.confirm:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
        }
        
        .merge-confirm-btn svg {
          width: 16px;
          height: 16px;
        }
      </style>
      
      <div class="merge-confirm-modal">
        <div class="merge-confirm-header">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
          </svg>
          <h3>Merge Contacts</h3>
        </div>
        
        <div class="merge-confirm-body">
          <p>The following contacts will be merged into one:</p>
          
          <div class="merge-contact-list">
            ${e.map((r,c)=>{const l=r.photoUrl||r.avatarUrl||r.photo_url||r.avatar_url,m=(r.name||"?").split(" ").map(g=>g[0]).join("").substring(0,2).toUpperCase(),v=r.email||r.organization||r.company||"";return`
                <div class="merge-contact-item ${c===0?"primary":""}">
                  <div class="merge-contact-avatar">
                    ${l?`<img src="${l}" alt="${r.name}">`:m}
                  </div>
                  <div class="merge-contact-info">
                    <div class="merge-contact-name">${r.name||"Unknown"}</div>
                    <div class="merge-contact-details">${v}</div>
                  </div>
                  ${c===0?'<span class="merge-contact-badge">Primary</span>':""}
                </div>
              `}).join("")}
          </div>
          
          <div class="merge-warning">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>All information will be combined into the primary contact. Other contacts will be archived. This action cannot be undone.</p>
          </div>
        </div>
        
        <div class="merge-confirm-footer">
          <button class="merge-confirm-btn cancel" id="merge-cancel-btn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Cancel
          </button>
          <button class="merge-confirm-btn confirm" id="merge-confirm-btn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Merge Contacts
          </button>
        </div>
      </div>
    `,document.body.appendChild(n);const a=n.querySelector("#merge-cancel-btn"),s=n.querySelector("#merge-confirm-btn"),o=r=>{n.remove(),t(r)};d(a,"click",()=>o(!1)),d(s,"click",()=>o(!0)),d(n,"click",r=>{r.target===n&&o(!1)});const i=r=>{r.key==="Escape"&&(document.removeEventListener("keydown",i),o(!1))};document.addEventListener("keydown",i)})}function qc(e){on.clear(),e.querySelectorAll(".contact-card-sota.selected").forEach(n=>{n.classList.remove("selected")}),e.querySelectorAll(".contact-select-checkbox.checked").forEach(n=>{n.classList.remove("checked")});const t=document.querySelector(".selection-bar");t&&t.remove()}async function G2(e,t,n,a){const s=!e.isFavorite;try{await p.put(`/api/contacts/${e.id}`,{is_favorite:s}),e.isFavorite=s,t.classList.toggle("active",s);const o=t.querySelector("svg");o&&o.setAttribute("fill",s?"currentColor":"none"),Qd(n,Vd.filter(i=>i.isFavorite||i.id===e.id&&s),a),u.success(s?"Added to favorites":"Removed from favorites")}catch{u.error("Failed to update favorite")}}function Qd(e,t,n){const a=e.querySelector("#favorites-section"),s=e.querySelector("#favorites-grid");if(t.length===0){a.style.display="none";return}a.style.display="block",s.innerHTML=t.map(o=>{const i=hr(o.name),r=!!(o.photoUrl||o.avatarUrl),c=o.photoUrl||o.avatarUrl;return`
      <div class="favorite-card" data-id="${o.id}">
        <div class="favorite-avatar">
          ${r?`<img src="${c}" alt="${Pe(o.name)}">`:i}
        </div>
        <div class="favorite-info">
          <h4>${Pe(o.name)}</h4>
          ${o.organization?`<p>${Pe(o.organization)}</p>`:""}
        </div>
      </div>
    `}).join(""),s.querySelectorAll(".favorite-card").forEach(o=>{d(o,"click",()=>{const i=o.getAttribute("data-id"),r=t.find(c=>String(c.id)===i);r&&Vt({mode:"edit",contact:r,onSave:()=>Mt(e,n)})})})}async function Q2(e){const t=e.querySelector("#contacts-alerts");try{const{duplicates:n}=await ke.getDuplicates();if(n.length>0){t.innerHTML=`
        <div class="alert-sota">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span><strong>${n.length}</strong> potential duplicate contacts found</span>
          <button class="btn-sota secondary" id="review-duplicates-btn">Review Duplicates</button>
        </div>
      `;const a=t.querySelector("#review-duplicates-btn");a&&d(a,"click",()=>{K2(n,e)})}}catch{}}function K2(e,t){const n=x("div",{className:"duplicates-review-overlay"});n.innerHTML=`
    <style>
      .duplicates-review-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .duplicates-modal {
        background: var(--bg-primary);
        border-radius: 16px;
        width: 700px;
        max-width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 60px rgba(0,0,0,0.3);
        animation: slideUp 0.2s ease;
      }
      
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .duplicates-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .duplicates-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .duplicates-header h2 svg {
        width: 24px;
        height: 24px;
        color: #f59e0b;
      }
      
      .duplicates-header .close-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      
      .duplicates-header .close-btn:hover {
        background: var(--bg-tertiary);
        border-color: #e11d48;
      }
      
      .duplicates-header .close-btn svg {
        width: 18px;
        height: 18px;
        color: var(--text-secondary);
      }
      
      .duplicates-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }
      
      .duplicate-group {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .duplicate-group:last-child {
        margin-bottom: 0;
      }
      
      .duplicate-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
      }
      
      .duplicate-group-header h4 {
        margin: 0;
        font-size: 14px;
        color: var(--text-secondary);
      }
      
      .merge-group-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #e11d48, #be123c);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }
      
      .merge-group-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(225,29,72,0.3);
      }
      
      .merge-group-btn svg {
        width: 16px;
        height: 16px;
      }
      
      .duplicate-contacts {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .duplicate-contact-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }
      
      .duplicate-contact-row input[type="radio"] {
        width: 18px;
        height: 18px;
        accent-color: #e11d48;
      }
      
      .duplicate-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e11d48, #be123c);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
      }
      
      .duplicate-info {
        flex: 1;
        min-width: 0;
      }
      
      .duplicate-info h5 {
        margin: 0 0 2px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .duplicate-info p {
        margin: 0;
        font-size: 12px;
        color: var(--text-secondary);
      }
      
      .duplicate-aliases {
        margin-top: 4px;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }
      
      .alias-tag {
        padding: 2px 6px;
        background: rgba(99,102,241,0.1);
        color: #6366f1;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
      }
      
      .duplicates-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .duplicates-footer button {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .duplicates-footer .close-review-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }
      
      .duplicates-footer .close-review-btn:hover {
        background: var(--bg-tertiary);
      }
      
      .no-duplicates-msg {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }
      
      .no-duplicates-msg svg {
        width: 48px;
        height: 48px;
        opacity: 0.4;
        margin-bottom: 12px;
      }
    </style>
    
    <div class="duplicates-modal">
      <div class="duplicates-header">
        <h2>
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Review Duplicate Contacts
        </h2>
        <button class="close-btn" id="close-duplicates-btn">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="duplicates-content" id="duplicates-content">
        ${e.length===0?`
          <div class="no-duplicates-msg">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>No duplicate contacts found</p>
          </div>
        `:e.map((i,r)=>`
          <div class="duplicate-group" data-group-index="${r}">
            <div class="duplicate-group-header">
              <h4>Potential duplicates (${i.length} contacts)</h4>
              <button class="merge-group-btn" data-group-index="${r}">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                Merge All
              </button>
            </div>
            <div class="duplicate-contacts">
              ${i.map((c,l)=>`
                <div class="duplicate-contact-row">
                  <input type="radio" name="primary-${r}" value="${c.id}" ${l===0?"checked":""}>
                  <div class="duplicate-avatar">${hr(c.name)}</div>
                  <div class="duplicate-info">
                    <h5>${Pe(c.name)}${l===0?" (Primary)":""}</h5>
                    <p>${Pe(c.email||"")}${c.organization?` ‚Ä¢ ${Pe(c.organization)}`:""}</p>
                    ${c.aliases&&c.aliases.length>0?`
                      <div class="duplicate-aliases">
                        ${c.aliases.map(m=>`<span class="alias-tag">${Pe(m)}</span>`).join("")}
                      </div>
                    `:""}
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `).join("")}
      </div>
      
      <div class="duplicates-footer">
        <button class="close-review-btn" id="close-review-btn">Close</button>
      </div>
    </div>
  `,document.body.appendChild(n);const a=()=>n.remove(),s=n.querySelector("#close-duplicates-btn"),o=n.querySelector("#close-review-btn");s&&d(s,"click",a),o&&d(o,"click",a),d(n,"click",i=>{i.target===n&&a()}),n.querySelectorAll(".merge-group-btn").forEach(i=>{d(i,"click",async()=>{const r=parseInt(i.getAttribute("data-group-index")||"0"),c=e[r];if(!c||c.length<2)return;const m=n.querySelector(`input[name="primary-${r}"]:checked`)?.value||c[0].id,v=[m,...c.filter(g=>g.id!==m).map(g=>g.id)];i.disabled=!0,i.textContent="Merging...";try{await ke.mergeContacts(v),u.success(`Merged ${c.length} contacts successfully`);const g=n.querySelector(`.duplicate-group[data-group-index="${r}"]`);if(g&&g.remove(),n.querySelectorAll(".duplicate-group").length===0){const b=n.querySelector("#duplicates-content");b&&(b.innerHTML=`
              <div class="no-duplicates-msg">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p>All duplicates have been merged!</p>
              </div>
            `)}await Mt(t)}catch(g){const f=g instanceof Error?g.message:"Failed to merge contacts";u.error(f),i.disabled=!1,i.innerHTML=`
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
          </svg>
          Merge All
        `}})})}function W2(e,t){const n=e.querySelector("#org-filter"),a=[...new Set(t.map(l=>l.organization).filter(Boolean))].sort(),s=n.value;n.innerHTML=`
    <option value="">All Organizations</option>
    ${a.map(l=>`<option value="${Pe(l)}" ${s===l?"selected":""}>${Pe(l)}</option>`).join("")}
  `;const o=e.querySelector("#tag-filter"),i=t.flatMap(l=>l.tags||[]),r=[...new Set(i)].sort(),c=o.value;o.innerHTML=`
    <option value="">All Tags</option>
    ${r.map(l=>`<option value="${Pe(l)}" ${c===l?"selected":""}>${Pe(l)}</option>`).join("")}
  `}async function Y2(){try{await ke.export("json"),u.success("Contacts exported")}catch{u.error("Failed to export contacts")}}function J2(e,t){const n=e.querySelector("#contacts-count");n&&(n.textContent=String(t))}function hr(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function Pe(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Z2=Object.freeze(Object.defineProperty({__proto__:null,createContactsPanel:Gd},Symbol.toStringTag,{value:"Module"}));function Kd(e={}){const t=x("div",{className:"teams-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Teams</h2>
        <span class="panel-count" id="teams-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="add-team-btn">+ Add Team</button>
      </div>
    </div>
    <div class="panel-content" id="teams-content">
      <div class="loading">Loading teams...</div>
    </div>
  `;const n=t.querySelector("#add-team-btn");return n&&d(n,"click",()=>{Zs({mode:"create",onSave:()=>Ei(t,e)})}),Ei(t,e),t}async function Ei(e,t){const n=e.querySelector("#teams-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=await ul.getAll();X2(n,a,t),tw(e,a.length)}catch{n.innerHTML='<div class="error">Failed to load teams</div>'}}function X2(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No teams yet</p>
        <button class="btn btn-primary" id="empty-add-btn">Create Team</button>
      </div>
    `;const a=e.querySelector("#empty-add-btn");a&&d(a,"click",()=>{Zs({mode:"create"})});return}e.innerHTML=`
    <div class="teams-grid">
      ${t.map(a=>ew(a)).join("")}
    </div>
  `,e.querySelectorAll(".team-card").forEach(a=>{d(a,"click",()=>{const s=a.getAttribute("data-id"),o=t.find(i=>String(i.id)===s);o&&(n.onTeamClick?n.onTeamClick(o):Zs({mode:"edit",team:o,onSave:()=>Ei(a.closest(".teams-panel"),n)}))})})}function ew(e){const t=e.memberCount||0,n=e.memberDetails?.find(a=>a.isLead);return`
    <div class="team-card" data-id="${e.id}">
      <div class="team-header">
        <div class="team-color" style="background: ${e.color||"#6366f1"}"></div>
        <div class="team-name">${Es(e.name)}</div>
        ${e.team_type?`<span class="team-type">${e.team_type}</span>`:""}
      </div>
      ${e.description?`<div class="team-description">${Es(e.description)}</div>`:""}
      <div class="team-stats">
        <span class="member-count">${t} member${t!==1?"s":""}</span>
        ${n?`<span class="team-lead">Lead: ${Es(n.name)}</span>`:""}
      </div>
      ${e.memberDetails&&e.memberDetails.length>0?`
        <div class="team-members-preview">
          ${e.memberDetails.slice(0,5).map(a=>`
            <div class="member-avatar" title="${Es(a.name)}">
              ${nw(a.name)}
            </div>
          `).join("")}
          ${e.memberDetails.length>5?`<div class="more-members">+${e.memberDetails.length-5}</div>`:""}
        </div>
      `:""}
    </div>
  `}function tw(e,t){const n=e.querySelector("#teams-count");n&&(n.textContent=String(t))}function nw(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function Es(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const aw=Object.freeze(Object.defineProperty({__proto__:null,createTeamsPanel:Kd},Symbol.toStringTag,{value:"Module"}));function Wd(){return window.vis}function Yd(e={}){const t=x("div",{className:"org-chart"});t.innerHTML=`
    <div class="chart-toolbar">
      <button class="btn btn-sm" id="fit-chart-btn">Fit</button>
      <button class="btn btn-sm" id="refresh-chart-btn">Refresh</button>
    </div>
    <div class="chart-container" id="org-chart-container">
      <div class="loading">Loading org chart...</div>
    </div>
  `;const n=t.querySelector("#fit-chart-btn");n&&d(n,"click",()=>{t._network?.fit()});const a=t.querySelector("#refresh-chart-btn");return a&&d(a,"click",()=>Tc(t,e)),Tc(t,e),t}async function Tc(e,t){const n=e.querySelector("#org-chart-container");n.innerHTML='<div class="loading">Loading...</div>';try{const{contacts:a}=await ke.getAll({});if(a.length===0){n.innerHTML=`
        <div class="empty-state">
          <p>No contacts to display</p>
        </div>
      `;return}const{nodes:s,edges:o}=sw(a);if(!Wd()){iw(n,a,t);return}ow(n,s,o,a,t)}catch{n.innerHTML='<div class="error">Failed to load org chart</div>'}}function sw(e){const t=[],n=[],a=new Map;return e.forEach(s=>{const o=s.relationships?.find(i=>i.type==="reports_to");if(o){const i=a.get(o.contactId)||0;a.set(String(s.id),i+1)}else a.set(String(s.id),0)}),e.forEach(s=>{t.push({id:String(s.id),label:s.name,title:`${s.name}${s.role?`
${s.role}`:""}${s.organization?`
${s.organization}`:""}`,level:a.get(String(s.id))||0,color:s.teams?.[0]?.color})}),e.forEach(s=>{s.relationships?.forEach(o=>{o.type==="reports_to"&&n.push({from:o.contactId,to:String(s.id),arrows:"to"})})}),{nodes:t,edges:n}}function ow(e,t,n,a,s){e.innerHTML="";const o=t.map(l=>({id:l.id,label:l.label,title:l.title,level:l.level,color:{background:l.color||"#6366f1",border:l.color||"#4f46e5",highlight:{background:"#818cf8",border:"#6366f1"}},font:{color:"#ffffff"},shape:"box",margin:10})),i={layout:{hierarchical:{direction:"UD",sortMethod:"directed",levelSeparation:100,nodeSpacing:150}},nodes:{borderWidth:2,shadow:!0},edges:{color:{color:"#9ca3af",highlight:"#6366f1"},width:2,smooth:{type:"cubicBezier"}},physics:!1,interaction:{hover:!0,tooltipDelay:200}},r=Wd(),c=new r.Network(e,{nodes:new r.DataSet(o),edges:new r.DataSet(n)},i);e.closest(".org-chart")._network=c,c.on("click",l=>{if(l.nodes.length>0){const m=l.nodes[0],v=a.find(g=>String(g.id)===m);v&&(s.onNodeClick?s.onNodeClick(v):Vt({mode:"view",contact:v}))}}),c.fit()}function iw(e,t,n){const a={};t.forEach(s=>{const o=s.organization||"Other";a[o]||(a[o]=[]),a[o].push(s)}),e.innerHTML=`
    <div class="fallback-org-chart">
      ${Object.entries(a).map(([s,o])=>`
        <div class="org-group">
          <h4 class="org-name">${Go(s)}</h4>
          <div class="org-members">
            ${o.map(i=>`
              <div class="org-member" data-id="${i.id}">
                <div class="member-avatar">${rw(i.name)}</div>
                <div class="member-info">
                  <div class="member-name">${Go(i.name)}</div>
                  ${i.role?`<div class="member-role">${Go(i.role)}</div>`:""}
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".org-member").forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);i&&(n.onNodeClick?n.onNodeClick(i):Vt({mode:"view",contact:i}))})})}function rw(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function Go(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const cw=Object.freeze(Object.defineProperty({__proto__:null,createOrgChart:Yd},Symbol.toStringTag,{value:"Module"}));let Bs="processed",Is="all",ns="date",Ac="grid",Qa="",ze=new Set,Ka=[];function _i(e={}){const t=x("div",{className:"documents-panel-minimal"});return t.innerHTML=`
    <style>
      .documents-panel-minimal {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--bg-primary);
        padding: 32px;
      }

      /* Header - Minimal */
      .docs-header-minimal {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
      }
      .docs-title-section {
        display: flex;
        align-items: baseline;
        gap: 16px;
      }
      .docs-title-section h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .docs-total-count {
        font-size: 16px;
        color: var(--text-tertiary);
        font-weight: 400;
      }
      .docs-header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      /* View Mode Toggle */
      .view-mode-toggle {
        display: flex;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 4px;
        gap: 2px;
      }
      .view-mode-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-tertiary);
        transition: all 0.15s ease;
      }
      .view-mode-btn:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }
      .view-mode-btn.active {
        background: var(--primary);
        color: white;
      }
      .view-mode-btn svg {
        width: 18px;
        height: 18px;
      }

      .btn-minimal {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      .btn-minimal.primary {
        background: var(--primary);
        color: white;
      }
      .btn-minimal.primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .btn-minimal.secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .btn-minimal.secondary:hover {
        background: var(--bg-tertiary);
      }
      .btn-minimal svg {
        width: 16px;
        height: 16px;
      }

      /* Search and Filters - Single Line */
      .docs-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      .docs-search-minimal {
        flex: 1;
        min-width: 280px;
        max-width: 400px;
        position: relative;
      }
      .docs-search-minimal input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.15s ease;
      }
      .docs-search-minimal input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .docs-search-minimal input::placeholder {
        color: var(--text-tertiary);
      }
      .docs-search-minimal svg {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-tertiary);
        width: 18px;
        height: 18px;
      }

      /* Filter Chips */
      .docs-filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .filter-chip-minimal {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .filter-chip-minimal:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .filter-chip-minimal.active {
        background: var(--primary);
        color: white;
      }

      /* Divider with status */
      .docs-status-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 24px;
      }
      .status-chip {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        background: transparent;
        border: none;
        color: var(--text-secondary);
      }
      .status-chip:hover {
        background: var(--bg-tertiary);
      }
      .status-chip.active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      .status-chip.active.processed { color: #10b981; background: rgba(16, 185, 129, 0.1); }
      .status-chip.active.pending { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
      .status-chip.active.failed { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
      .status-chip.active.deleted { color: #6b7280; background: rgba(107, 114, 128, 0.1); }
      .status-chip .chip-count {
        margin-left: 6px;
        padding: 2px 6px;
        font-size: 10px;
        background: rgba(0,0,0,0.05);
        border-radius: 6px;
      }
      [data-theme="dark"] .status-chip .chip-count {
        background: rgba(255,255,255,0.1);
      }
      .status-chip.active .chip-count {
        background: rgba(0,0,0,0.1);
      }
      .docs-sort-minimal {
        margin-left: auto;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
      }

      /* Documents Grid - Larger Cards */
      .docs-content-minimal {
        flex: 1;
        overflow-y: auto;
      }
      .docs-grid-minimal {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
      }
      
      /* List View Mode */
      .docs-grid-minimal.list-view {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .docs-grid-minimal.list-view .doc-card-minimal {
        flex-direction: row;
        align-items: center;
        padding: 12px 20px;
        gap: 16px;
        border-radius: 12px;
      }
      .docs-grid-minimal.list-view .doc-card-header {
        flex-shrink: 0;
        gap: 12px;
      }
      .docs-grid-minimal.list-view .doc-card-header .doc-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
        border-radius: 8px;
      }
      .docs-grid-minimal.list-view .doc-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 24px;
        min-width: 0;
      }
      .docs-grid-minimal.list-view .doc-filename {
        flex: 1;
        min-width: 0;
        margin: 0;
      }
      .docs-grid-minimal.list-view .doc-meta {
        display: flex;
        gap: 16px;
        color: var(--text-tertiary);
        font-size: 13px;
        flex-shrink: 0;
      }
      .docs-grid-minimal.list-view .doc-status-badge {
        margin: 0;
        flex-shrink: 0;
      }
      .docs-grid-minimal.list-view .doc-summary-section,
      .docs-grid-minimal.list-view .doc-entities-mini,
      .docs-grid-minimal.list-view .doc-card-hover {
        display: none;
      }

      /* Document Card - Clean Design */
      .doc-card-minimal {
        background: var(--bg-secondary);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .doc-card-minimal:hover {
        border-color: rgba(var(--primary-rgb), 0.4);
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        transform: translateY(-2px);
      }
      .doc-card-minimal.selected {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.02);
      }

      /* Card Header */
      .doc-card-top {
        display: flex;
        align-items: flex-start;
        gap: 16px;
      }
      .doc-icon-minimal {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
      }
      .doc-icon-minimal.pdf { background: linear-gradient(135deg, #fef2f2, #fee2e2); }
      .doc-icon-minimal.doc { background: linear-gradient(135deg, #eff6ff, #dbeafe); }
      .doc-icon-minimal.img { background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
      .doc-icon-minimal.txt { background: linear-gradient(135deg, #fefce8, #fef9c3); }
      .doc-icon-minimal.default { background: linear-gradient(135deg, #f5f5f5, #e5e5e5); }
      [data-theme="dark"] .doc-icon-minimal.pdf { background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.doc { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.img { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.txt { background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.1)); }
      [data-theme="dark"] .doc-icon-minimal.default { background: linear-gradient(135deg, rgba(107,114,128,0.15), rgba(107,114,128,0.1)); }

      .doc-info-minimal {
        flex: 1;
        min-width: 0;
      }
      .doc-filename-minimal {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .doc-meta-minimal {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-tertiary);
      }
      .doc-meta-minimal .sep {
        color: var(--border-color);
      }
      .doc-status-badge {
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 6px;
        text-transform: capitalize;
      }
      .doc-status-badge.processed { background: rgba(16, 185, 129, 0.1); color: #10b981; }
      .doc-status-badge.pending { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
      .doc-status-badge.failed { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
      .doc-status-badge.deleted { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

      /* Card Summary */
      .doc-summary-minimal {
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-secondary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Card Footer */
      .doc-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }
      .doc-entities {
        display: flex;
        gap: 16px;
      }
      .doc-entity-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-secondary);
      }
      .doc-entity-item .icon {
        width: 20px;
        height: 20px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
      }
      .doc-entity-item.facts .icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
      .doc-entity-item.decisions .icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
      .doc-entity-item.risks .icon { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

      .doc-actions-minimal {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.15s ease;
      }
      .doc-card-minimal:hover .doc-actions-minimal {
        opacity: 1;
      }
      .doc-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s ease;
        color: var(--text-secondary);
        font-size: 14px;
      }
      .doc-action-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }
      .doc-action-btn.favorite.active {
        color: #f59e0b;
      }
      .doc-action-btn.favorite:hover {
        background: #f59e0b;
        border-color: #f59e0b;
        color: white;
      }

      /* Selection */
      .doc-select-checkbox {
        position: absolute;
        top: 16px;
        left: 16px;
        width: 22px;
        height: 22px;
        border-radius: 6px;
        border: 2px solid var(--border-color);
        background: var(--bg-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.15s ease;
        font-size: 12px;
        color: white;
      }
      .doc-card-minimal:hover .doc-select-checkbox,
      .doc-card-minimal.selected .doc-select-checkbox {
        opacity: 1;
      }
      .doc-card-minimal.selected .doc-select-checkbox {
        background: var(--primary);
        border-color: var(--primary);
      }

      /* Selection Bar */
      .selection-bar-minimal {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        background: #1e293b;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        z-index: 100;
        animation: slideUp 0.25s ease;
      }
      @keyframes slideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
      .selection-bar-minimal.hidden { display: none; }
      .selection-count-minimal {
        color: white;
        font-weight: 600;
        padding-right: 16px;
        border-right: 1px solid rgba(255,255,255,0.2);
      }
      .selection-count-minimal span { color: #60a5fa; }
      .selection-bar-minimal .btn-minimal {
        padding: 8px 16px;
        font-size: 13px;
      }
      .selection-bar-minimal .btn-minimal.secondary {
        background: rgba(255,255,255,0.1);
        color: white;
        border-color: transparent;
      }
      .selection-bar-minimal .btn-minimal.secondary:hover {
        background: rgba(255,255,255,0.2);
      }
      .selection-bar-minimal .btn-minimal.danger {
        background: #ef4444;
        color: white;
        border: none;
      }

      /* Empty State */
      .docs-empty-minimal {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        text-align: center;
        grid-column: 1 / -1;
      }
      .docs-empty-minimal .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 24px;
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin-bottom: 24px;
      }
      .docs-empty-minimal h3 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .docs-empty-minimal p {
        margin: 0 0 24px 0;
        color: var(--text-secondary);
      }

      /* Loading */
      .docs-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px;
        grid-column: 1 / -1;
        color: var(--text-secondary);
        gap: 12px;
      }
      .docs-loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Accessibility: Screen reader only content */
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      
      /* Focus styles for keyboard navigation */
      .doc-card-minimal:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }
      .doc-card-minimal:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }
    </style>
    
    <!-- Header -->
    <div class="docs-header-minimal">
      <div class="docs-title-section">
        <h1>Files</h1>
        <span class="docs-total-count"><span id="total-count">0</span> documents</span>
      </div>
      <div class="docs-header-actions">
        <!-- View Mode Toggle -->
        <div class="view-mode-toggle">
          <button class="view-mode-btn active" data-view="grid" title="Grid view">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
            </svg>
          </button>
          <button class="view-mode-btn" data-view="list" title="List view">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
          </button>
        </div>
        <button class="btn-minimal primary" id="upload-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Upload
        </button>
      </div>
    </div>

    <!-- Controls -->
    <div class="docs-controls" role="search">
      <div class="docs-search-minimal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.3-4.3"/>
        </svg>
        <input type="text" id="docs-search-input" placeholder="Search files..." 
               aria-label="Search files" autocomplete="off">
      </div>
      <div class="docs-filters" role="tablist" aria-label="Filter by document type">
        <button class="filter-chip-minimal active" data-type="all" role="tab" aria-selected="true">All</button>
        <button class="filter-chip-minimal" data-type="documents" role="tab" aria-selected="false">Documents</button>
        <button class="filter-chip-minimal" data-type="transcripts" role="tab" aria-selected="false">Transcripts</button>
        <button class="filter-chip-minimal" data-type="emails" role="tab" aria-selected="false">Emails</button>
        <button class="filter-chip-minimal" data-type="images" role="tab" aria-selected="false">Images</button>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="docs-status-bar" role="tablist" aria-label="Filter by status">
      <button class="status-chip active processed" data-status="processed" role="tab" aria-selected="true">
        Processed <span class="chip-count" id="count-processed" aria-label="count">0</span>
      </button>
      <button class="status-chip pending" data-status="pending" role="tab" aria-selected="false">
        Pending <span class="chip-count" id="count-pending" aria-label="count">0</span>
      </button>
      <button class="status-chip failed" data-status="failed" role="tab" aria-selected="false">
        Failed <span class="chip-count" id="count-failed" aria-label="count">0</span>
      </button>
      <button class="status-chip deleted" data-status="deleted" role="tab" aria-selected="false">
        Deleted <span class="chip-count" id="count-deleted" aria-label="count">0</span>
      </button>
      <label for="sort-select" class="visually-hidden">Sort order</label>
      <select class="docs-sort-minimal" id="sort-select" aria-label="Sort files">
        <option value="date">Newest first</option>
        <option value="name">Name A-Z</option>
        <option value="size">Largest first</option>
      </select>
    </div>

    <!-- Content -->
    <div class="docs-content-minimal" role="main">
      <div class="docs-grid-minimal" id="docs-grid" role="list" aria-label="Document list" tabindex="0">
        <div class="docs-loading" aria-live="polite">Loading files</div>
      </div>
    </div>

    <!-- Selection Bar -->
    <div class="selection-bar-minimal hidden" id="selection-bar" role="toolbar" aria-label="Bulk actions">
      <span class="selection-count-minimal" aria-live="polite"><span id="selected-count">0</span> selected</span>
      <button class="btn-minimal secondary" id="bulk-export-btn" aria-label="Export selected files">Export</button>
      <button class="btn-minimal secondary" id="bulk-reprocess-btn" aria-label="Reprocess selected files">Reprocess</button>
      <button class="btn-minimal danger" id="bulk-delete-btn" aria-label="Delete selected files">Delete</button>
      <button class="btn-minimal secondary" id="cancel-selection-btn" aria-label="Cancel selection">Cancel</button>
    </div>
  `,lw(t,e),Sn(t,e),t}function lw(e,t){e.querySelector("#upload-btn")?.addEventListener("click",async()=>{const{showFileUploadModal:s}=await Y(async()=>{const{showFileUploadModal:o}=await Promise.resolve().then(()=>jd);return{showFileUploadModal:o}},void 0);s({onComplete:()=>Sn(e,t)})});const n=e.querySelector("#docs-search-input");let a;n?.addEventListener("input",()=>{clearTimeout(a),a=setTimeout(()=>{const s=n.value.trim();s!==Qa&&(Qa=s,(Qa.length>=2||Qa.length===0)&&Sn(e,t))},500)}),e.querySelector("#sort-select")?.addEventListener("change",s=>{ns=s.target.value,ji(e,t)}),e.querySelectorAll(".filter-chip-minimal").forEach(s=>{s.addEventListener("click",()=>{e.querySelectorAll(".filter-chip-minimal").forEach(o=>o.classList.remove("active")),s.classList.add("active"),Is=s.getAttribute("data-type"),ji(e,t)})}),e.querySelectorAll(".status-chip").forEach(s=>{s.addEventListener("click",()=>{e.querySelectorAll(".status-chip").forEach(o=>o.classList.remove("active")),s.classList.add("active"),Bs=s.getAttribute("data-status"),Sn(e,t)})}),e.querySelectorAll(".view-mode-btn").forEach(s=>{s.addEventListener("click",()=>{e.querySelectorAll(".view-mode-btn").forEach(i=>i.classList.remove("active")),s.classList.add("active"),Ac=s.getAttribute("data-view");const o=e.querySelector("#docs-grid");o&&(Ac==="list"?o.classList.add("list-view"):o.classList.remove("list-view"))})}),e.querySelector("#bulk-delete-btn")?.addEventListener("click",()=>mw(e,t)),e.querySelector("#bulk-export-btn")?.addEventListener("click",()=>gw()),e.querySelector("#bulk-reprocess-btn")?.addEventListener("click",()=>vw(e,t)),e.querySelector("#cancel-selection-btn")?.addEventListener("click",()=>{ze.clear(),no(e)})}async function Sn(e,t){const n=e.querySelector("#docs-grid");n.innerHTML='<div class="docs-loading" aria-live="polite">Loading files</div>';try{const a=await qn.getAll({status:Bs==="all"?void 0:Bs,type:Is==="all"?void 0:Is,search:Qa||void 0,sort:ns==="date"?"created_at":ns==="name"?"filename":void 0,order:ns==="date"?"desc":"asc",limit:100});Ka=a.documents||[],console.log("%c[DocumentsPanel] Load result:","color: green; font-weight: bold",{total:a.total,docsCount:Ka.length,firstDoc:Ka[0],currentStatus:Bs,currentType:Is});const s=a.statuses||{};e.querySelector("#total-count").textContent=String(a.total||Ka.length),e.querySelector("#count-processed").textContent=String(s.processed||0),e.querySelector("#count-pending").textContent=String((s.pending||0)+(s.processing||0)),e.querySelector("#count-failed").textContent=String(s.failed||0),e.querySelector("#count-deleted").textContent=String(s.deleted||0),ji(e,t)}catch(a){console.error("[DocumentsPanel] Failed to load:",a),n.innerHTML='<div class="docs-empty-minimal"><div class="empty-icon">!</div><h3>Failed to load files</h3><p>Please try again</p></div>'}}function ji(e,t){let n=[...Ka];ns==="size"&&n.sort((a,s)=>(s.size||0)-(a.size||0)),dw(e,n,t)}function dw(e,t,n){const a=e.querySelector("#docs-grid");if(t.length===0){a.innerHTML=`
      <div class="docs-empty-minimal">
        <div class="empty-icon">üìÅ</div>
        <h3>No files found</h3>
        <p>Upload files to get started</p>
        <button class="btn-minimal primary" id="empty-upload-btn">Upload Files</button>
      </div>
    `,a.querySelector("#empty-upload-btn")?.addEventListener("click",async()=>{const{showFileUploadModal:s}=await Y(async()=>{const{showFileUploadModal:o}=await Promise.resolve().then(()=>jd);return{showFileUploadModal:o}},void 0);s({onComplete:()=>Sn(e,n)})});return}a.innerHTML=t.map((s,o)=>pw(s,o)).join(""),a.setAttribute("data-total",String(t.length)),a.querySelectorAll(".doc-card-minimal").forEach(s=>{const o=s.getAttribute("data-id"),i=t.find(r=>String(r.id)===o);s.addEventListener("click",r=>{const c=r.target;c.closest(".doc-select-checkbox")||c.closest(".doc-action-btn")||i&&n.onDocumentClick&&n.onDocumentClick(i)}),s.addEventListener("keydown",r=>{const c=Array.from(a.querySelectorAll(".doc-card-minimal")),l=c.indexOf(s);switch(r.key){case"Enter":case" ":r.preventDefault(),i&&n.onDocumentClick&&n.onDocumentClick(i);break;case"ArrowDown":case"ArrowRight":r.preventDefault(),l<c.length-1&&c[l+1].focus();break;case"ArrowUp":case"ArrowLeft":r.preventDefault(),l>0&&c[l-1].focus();break;case"s":r.preventDefault(),ze.has(o)?ze.delete(o):ze.add(o),no(e);break;case"Delete":case"Backspace":r.preventDefault(),i&&confirm(`Delete "${i.filename}"?`)&&qn.delete(o,{softDelete:!0}).then(()=>{u.success("File deleted"),Sn(e,n)}).catch(()=>u.error("Failed to delete"));break}}),s.querySelector(".doc-select-checkbox")?.addEventListener("click",r=>{r.stopPropagation(),ze.has(o)?ze.delete(o):ze.add(o),no(e)}),s.querySelector(".doc-action-btn.favorite")?.addEventListener("click",async r=>{r.stopPropagation();try{await p.post(`/api/documents/${o}/favorite`),r.target.classList.toggle("active"),u.success("Updated favorites")}catch{u.error("Failed to update favorite")}})})}function pw(e,t=0){const n=uw(e.filename||""),a=fw(e.filename||""),s=ze.has(e.id),o=e.facts_count||0,i=e.decisions_count||0,r=e.risks_count||0,c=[o>0?`${o} facts`:"",i>0?`${i} decisions`:"",r>0?`${r} risks`:""].filter(Boolean).join(", ")||"No entities";return`
    <div class="doc-card-minimal ${s?"selected":""}" 
         data-id="${e.id}"
         data-index="${t}"
         role="listitem"
         tabindex="0"
         aria-label="${Qo(e.filename||"Untitled")}. Status: ${e.status}. ${c}">
      <div class="doc-select-checkbox" role="checkbox" aria-checked="${s}" aria-label="Select document">${s?"‚úì":""}</div>
      
      <div class="doc-card-top">
        <div class="doc-icon-minimal ${n}" aria-hidden="true">${a}</div>
        <div class="doc-info-minimal">
          <div class="doc-filename-minimal">${Qo(e.filename||"Untitled")}</div>
          <div class="doc-meta-minimal">
            <span>${xs(e.file_size||e.size||0)}</span>
            <span class="sep" aria-hidden="true">‚Ä¢</span>
            <span>${J(e.created_at)}</span>
          </div>
        </div>
        <span class="doc-status-badge ${e.status}" aria-label="Status: ${e.status}">${e.status}</span>
      </div>
      
      ${e.summary?`<div class="doc-summary-minimal">${Qo(e.summary)}</div>`:""}
      
      <div class="doc-card-footer">
        <div class="doc-entities" aria-label="Extracted entities">
          ${o>0?`<span class="doc-entity-item facts"><span class="icon" aria-hidden="true">üìã</span> ${o} facts</span>`:""}
          ${i>0?`<span class="doc-entity-item decisions"><span class="icon" aria-hidden="true">‚úì</span> ${i}</span>`:""}
          ${r>0?`<span class="doc-entity-item risks"><span class="icon" aria-hidden="true">‚ö†</span> ${r}</span>`:""}
          ${o===0&&i===0&&r===0?'<span class="doc-entity-item" style="color: var(--text-tertiary);">No entities</span>':""}
        </div>
        <div class="doc-actions-minimal">
          <button class="doc-action-btn favorite ${e.is_favorite?"active":""}" 
                  title="Favorite" aria-label="${e.is_favorite?"Remove from favorites":"Add to favorites"}"
                  aria-pressed="${e.is_favorite?"true":"false"}">‚òÖ</button>
        </div>
      </div>
    </div>
  `}function uw(e){switch(e.split(".").pop()?.toLowerCase()){case"pdf":return"pdf";case"doc":case"docx":return"doc";case"jpg":case"jpeg":case"png":case"gif":return"img";case"txt":case"md":return"txt";default:return"default"}}function no(e){const t=ze.size;e.querySelector("#selection-bar").classList.toggle("hidden",t===0),e.querySelector("#selected-count").textContent=String(t),e.querySelectorAll(".doc-card-minimal").forEach(a=>{const s=a.getAttribute("data-id"),o=ze.has(s);a.classList.toggle("selected",o);const i=a.querySelector(".doc-select-checkbox");i&&(i.textContent=o?"‚úì":"")})}function Jd(e,t){const n=document.createElement("div");n.className="bulk-loading-overlay",n.innerHTML=`
    <div class="bulk-loading-content">
      <div class="bulk-loading-spinner"></div>
      <div class="bulk-loading-message">${t}</div>
      <div class="bulk-loading-progress" id="bulk-progress"></div>
    </div>
  `,n.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(var(--bg-rgb, 255, 255, 255), 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(2px);
  `;const a=n.querySelector(".bulk-loading-content");a.style.cssText="text-align: center;";const s=n.querySelector(".bulk-loading-spinner");return s.style.cssText=`
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  `,e.style.position="relative",e.appendChild(n),n}function Zd(e){e?.remove()}function ao(e,t){e.querySelectorAll("#bulk-delete-btn, #bulk-export-btn, #bulk-reprocess-btn").forEach(a=>{a.disabled=t})}async function mw(e,t){const n=ze.size;if(!confirm(`Delete ${n} files? This action can be undone from the Deleted tab.`))return;const a=Jd(e,`Deleting ${n} files...`);ao(e,!0);try{const s=Array.from(ze),i=(await p.post("/api/documents/bulk/delete",{ids:s})).data;i.errors&&i.errors.length>0?u.warning(`Deleted ${i.deleted} files, ${i.errors.length} failed`):u.success(`Deleted ${i.deleted} files`),ze.clear(),Sn(e,t)}catch(s){console.error("[BulkDelete] Error:",s),u.error("Failed to delete files")}finally{Zd(a),ao(e,!1)}}async function gw(){const e=ze.size;u.info(`Preparing export of ${e} files...`);try{const t=Array.from(ze),a=(await p.post("/api/documents/bulk/export",{ids:t,format:"original"},{responseType:"blob"})).data,s=window.URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=`documents-export-${new Date().toISOString().split("T")[0]}.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(s),u.success(`Exported ${e} files`)}catch(t){console.error("[BulkExport] Error:",t),u.error("Failed to export files")}}async function vw(e,t){const n=ze.size;if(!confirm(`Reprocess ${n} files? This will use AI tokens.`))return;const a=Jd(e,`Queuing ${n} files for reprocessing...`);ao(e,!0);try{const s=Array.from(ze),i=(await p.post("/api/documents/bulk/reprocess",{ids:s})).data;i.failed&&i.failed.length>0?u.warning(`Queued ${i.queued?.length||0} files, ${i.failed.length} failed`):u.success(`Queued ${i.queued?.length||n} files for reprocessing`),ze.clear(),no(e),setTimeout(()=>Sn(e,t),1e3)}catch(s){console.error("[BulkReprocess] Error:",s),u.error("Failed to queue files for reprocessing")}finally{Zd(a),ao(e,!1)}}function fw(e){switch(e.split(".").pop()?.toLowerCase()){case"pdf":return"üìÑ";case"doc":case"docx":return"üìù";case"xls":case"xlsx":return"üìä";case"ppt":case"pptx":return"üìΩÔ∏è";case"txt":case"md":return"üìÉ";case"jpg":case"jpeg":case"png":case"gif":return"üñºÔ∏è";default:return"üìÅ"}}function Qo(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const hw=Object.freeze(Object.defineProperty({__proto__:null,createDocumentsPanel:_i,default:_i},Symbol.toStringTag,{value:"Module"}));function bw(e={}){const t=x("div",{className:"knowledge-panel"});t.innerHTML=`
    <div class="panel-header">
      <h2>Knowledge Base</h2>
    </div>
    <div class="panel-content">
      <div class="knowledge-status" id="knowledge-status">
        <div class="loading">Loading status...</div>
      </div>
      <div class="knowledge-actions">
        <div class="action-group">
          <h4>Export</h4>
          <div class="action-buttons">
            <button class="btn btn-sm" id="export-md-btn">Export Markdown</button>
            <button class="btn btn-sm" id="export-json-btn">Export JSON</button>
          </div>
        </div>
        <div class="action-group">
          <h4>Maintenance</h4>
          <div class="action-buttons">
            <button class="btn btn-sm" id="regenerate-btn">Regenerate Files</button>
            <button class="btn btn-sm" id="synthesize-btn">Synthesize Facts</button>
          </div>
        </div>
      </div>
    </div>
  `;const n=t.querySelector("#export-md-btn");n&&d(n,"click",()=>Ec("md",e));const a=t.querySelector("#export-json-btn");a&&d(a,"click",()=>Ec("json",e));const s=t.querySelector("#regenerate-btn");s&&d(s,"click",()=>xw(t));const o=t.querySelector("#synthesize-btn");return o&&d(o,"click",()=>ww(t)),br(t),t}async function br(e){const t=e.querySelector("#knowledge-status");try{const n=await fa.getStatus();yw(t,n)}catch{t.innerHTML='<div class="error">Failed to load status</div>'}}function yw(e,t){e.innerHTML=`
    <div class="status-grid">
      <div class="status-item">
        <span class="status-label">Documents Embedded</span>
        <span class="status-value">${t.embedded}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Total Chunks</span>
        <span class="status-value">${t.totalChunks}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Embedding Model</span>
        <span class="status-value">${t.model||"Default"}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Last Updated</span>
        <span class="status-value">${t.lastUpdated?kw(t.lastUpdated):"Never"}</span>
      </div>
    </div>
    ${t.available_embedding_models&&t.available_embedding_models.length>0?`
      <div class="available-models">
        <h5>Available Models</h5>
        <div class="model-list">
          ${t.available_embedding_models.map(n=>`
            <span class="model-badge">${n}</span>
          `).join("")}
        </div>
      </div>
    `:""}
  `}async function Ec(e,t){if(t.onExport){t.onExport(e);return}try{e==="md"?await fa.exportMarkdown():await fa.exportJson(),u.success(`Knowledge base exported as ${e.toUpperCase()}`)}catch{u.error("Failed to export knowledge base")}}async function xw(e){if(!confirm("This will regenerate all knowledge files. Continue?"))return;const t=e.querySelector("#regenerate-btn");t.disabled=!0,t.textContent="Regenerating...";try{await fa.regenerate(),u.success("Knowledge files regenerated"),br(e)}catch{u.error("Failed to regenerate knowledge files")}finally{t.disabled=!1,t.textContent="Regenerate Files"}}async function ww(e){if(!confirm("This will consolidate and synthesize facts using AI. This may take a while. Continue?"))return;const t=e.querySelector("#synthesize-btn");t.disabled=!0,t.textContent="Synthesizing...";try{await fa.synthesize(),u.success("Facts synthesized"),br(e)}catch{u.error("Failed to synthesize facts")}finally{t.disabled=!1,t.textContent="Synthesize Facts"}}function kw(e){return new Date(e).toLocaleDateString()}let so="paste";function Di(e={}){const t=document.getElementById("conversation-composer-overlay");t&&t.remove();const n=x("div",{id:"conversation-composer-overlay",className:"composer-overlay"}),a=$w(e);n.appendChild(a),document.body.appendChild(n),d(n,"click",s=>{s.target===n&&(hs(),e.onClose?.())}),requestAnimationFrame(()=>n.classList.add("visible"))}function hs(){const e=document.getElementById("conversation-composer-overlay");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),200))}function $w(e){const t=x("div",{className:"composer-modal"});return t.innerHTML=`
    <style>
      .composer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .composer-overlay.visible {
        opacity: 1;
      }
      .composer-overlay.visible .composer-modal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .composer-modal {
        width: 640px;
        max-width: 95vw;
        max-height: 85vh;
        background: var(--bg-primary);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px) scale(0.98);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .composer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }
      .composer-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .composer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: all 0.15s ease;
      }
      .composer-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .composer-tabs {
        display: flex;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-tab {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        transition: color 0.15s ease;
      }
      .composer-tab:hover { color: var(--text-primary); }
      .composer-tab.active { color: var(--primary); }
      .composer-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        border-radius: 2px 2px 0 0;
      }
      
      .composer-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      .paste-section label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 12px;
      }
      .paste-section textarea {
        width: 100%;
        min-height: 280px;
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      .paste-section textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .paste-section textarea::placeholder { color: var(--text-tertiary); }
      .paste-hint {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-tertiary);
      }
      
      .format-row {
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .format-row label {
        font-size: 13px;
        color: var(--text-secondary);
        white-space: nowrap;
      }
      .format-row select {
        flex: 1;
        max-width: 200px;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 13px;
      }
      
      .upload-section .dropzone {
        border: 2px dashed var(--border-color);
        border-radius: 16px;
        padding: 60px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
      }
      .upload-section .dropzone:hover,
      .upload-section .dropzone.dragover {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.03);
      }
      .dropzone-icon { font-size: 48px; margin-bottom: 16px; }
      .dropzone-title {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 8px;
      }
      .dropzone-hint { font-size: 13px; color: var(--text-tertiary); }
      
      .selected-file {
        display: none;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }
      .selected-file.visible { display: flex; }
      .file-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 70%, white));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      .file-info { flex: 1; min-width: 0; }
      .file-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .file-size { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
      .file-remove {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-tertiary);
        font-size: 18px;
        transition: all 0.15s ease;
      }
      .file-remove:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }
      
      .preview-area {
        margin-top: 20px;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        display: none;
      }
      .preview-area.visible { display: block; }
      .preview-area h4 {
        margin: 0 0 12px 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .preview-stats {
        display: flex;
        gap: 24px;
        font-size: 14px;
      }
      .preview-stats span { color: var(--text-secondary); }
      .preview-stats strong { color: var(--text-primary); }
      
      .composer-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-footer .btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      .composer-footer .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .composer-footer .btn-secondary:hover { background: var(--bg-tertiary); }
      .composer-footer .btn-outline {
        background: transparent;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .composer-footer .btn-outline:hover { background: var(--bg-tertiary); }
      .composer-footer .btn-primary {
        background: var(--primary);
        color: white;
      }
      .composer-footer .btn-primary:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .composer-footer .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
    
    <div class="composer-header">
      <h2>Import Conversation</h2>
      <button class="composer-close" id="close-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="composer-tabs">
      <button class="composer-tab active" data-mode="paste">Paste Text</button>
      <button class="composer-tab" data-mode="upload">Upload File</button>
    </div>
    
    <div class="composer-body" id="composer-body">
      ${Xd()}
    </div>
    
    <div class="composer-footer">
      <button class="btn btn-secondary" id="cancel-btn">Cancel</button>
      <button class="btn btn-outline" id="preview-btn" disabled>Preview</button>
      <button class="btn btn-primary" id="import-btn" disabled>Import</button>
    </div>
  `,t.querySelectorAll(".composer-tab").forEach(n=>{d(n,"click",()=>{t.querySelectorAll(".composer-tab").forEach(a=>a.classList.remove("active")),n.classList.add("active"),so=n.getAttribute("data-mode"),Sw(t)})}),d(t.querySelector("#close-btn"),"click",()=>{hs(),e.onClose?.()}),d(t.querySelector("#cancel-btn"),"click",()=>{hs(),e.onClose?.()}),d(t.querySelector("#preview-btn"),"click",()=>Mw(t)),d(t.querySelector("#import-btn"),"click",()=>qw(t,e)),ep(t),t}function Sw(e){const t=e.querySelector("#composer-body");t.innerHTML=so==="paste"?Xd():Cw(),so==="paste"?ep(e):Lw(e)}function Xd(){return`
    <div class="paste-section">
      <label>Paste conversation or transcript:</label>
      <textarea id="conversation-input" placeholder="Paste your conversation here...

Supported formats:
‚Ä¢ WhatsApp, Slack, Teams, Discord chats
‚Ä¢ Meeting transcripts (Zoom, Google Meet)
‚Ä¢ Email threads
‚Ä¢ Any text with speaker names

Example:
[10:30] John: Hello everyone
[10:31] Jane: Hi John!
[10:32] John: Let's discuss the project..."></textarea>
      <p class="paste-hint">Include timestamps and speaker names for better parsing.</p>
      <div class="format-row">
        <label>Format:</label>
        <select id="format-select">
          <option value="">Auto-detect</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="slack">Slack</option>
          <option value="teams">Microsoft Teams</option>
          <option value="discord">Discord</option>
          <option value="zoom">Zoom Transcript</option>
          <option value="generic">Generic Chat</option>
        </select>
      </div>
    </div>
    <div class="preview-area" id="preview-area"></div>
  `}function ep(e){const t=e.querySelector("#conversation-input"),n=e.querySelector("#preview-btn"),a=e.querySelector("#import-btn");t&&d(t,"input",()=>{const s=t.value.trim().length>10;n.disabled=!s,a.disabled=!s})}function Cw(){return`
    <div class="upload-section">
      <div class="dropzone" id="file-dropzone">
        <div class="dropzone-icon">üí¨</div>
        <p class="dropzone-title">Drop chat file here</p>
        <p class="dropzone-hint">or click to browse ‚Ä¢ .txt, .json</p>
        <input type="file" id="file-input" accept=".txt,.md,.srt,.vtt,.json" hidden>
      </div>
      <div class="selected-file" id="selected-file">
        <div class="file-icon">üìÑ</div>
        <div class="file-info">
          <div class="file-name" id="file-name"></div>
          <div class="file-size" id="file-size"></div>
        </div>
        <button class="file-remove" id="file-remove">√ó</button>
      </div>
    </div>
    <div class="preview-area" id="preview-area"></div>
  `}function Lw(e){const t=e.querySelector("#file-dropzone"),n=e.querySelector("#file-input"),a=e.querySelector("#selected-file"),s=e.querySelector("#preview-btn"),o=e.querySelector("#import-btn");d(t,"click",()=>n.click()),d(t,"dragover",i=>{i.preventDefault(),t.classList.add("dragover")}),d(t,"dragleave",()=>t.classList.remove("dragover")),d(t,"drop",i=>{i.preventDefault(),t.classList.remove("dragover"),i.dataTransfer?.files[0]&&_c(i.dataTransfer.files[0],e)}),d(n,"change",()=>{n.files?.[0]&&_c(n.files[0],e)}),d(e.querySelector("#file-remove"),"click",()=>{a.classList.remove("visible"),e._fileContent=null,s.disabled=!0,o.disabled=!0})}function _c(e,t){const n=t.querySelector("#selected-file"),a=t.querySelector("#preview-btn"),s=t.querySelector("#import-btn");t.querySelector("#file-name").textContent=e.name,t.querySelector("#file-size").textContent=Tw(e.size),n.classList.add("visible");const o=new FileReader;o.onload=()=>{t._fileContent=o.result,a.disabled=!1,s.disabled=!1},o.readAsText(e)}function tp(e){return so==="paste"?e.querySelector("#conversation-input")?.value||"":e._fileContent||""}async function Mw(e){const t=e.querySelector("#preview-btn"),n=e.querySelector("#preview-area"),a=tp(e);if(a){t.disabled=!0,t.textContent="Parsing...";try{const s=await na.parsePreview(a);n.classList.add("visible"),n.innerHTML=`
      <h4>Preview</h4>
      <div class="preview-stats">
        <span>Messages: <strong>${s.message_count||0}</strong></span>
        <span>Participants: <strong>${s.participants?.length||0}</strong></span>
        <span>Format: <strong>${s.format||"Unknown"}</strong></span>
      </div>
    `}catch{u.error("Failed to parse conversation")}finally{t.disabled=!1,t.textContent="Preview"}}}async function qw(e,t){const n=e.querySelector("#import-btn"),a=tp(e),s=e.querySelector("#format-select");if(a){n.disabled=!0,n.textContent="Importing...";try{const o=await na.import(a,{formatHint:s?.value});u.success("Conversation imported"),t.onImport?.(o),hs()}catch{u.error("Failed to import conversation")}finally{n.disabled=!1,n.textContent="Import"}}}function Tw(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}const Aw=Object.freeze(Object.defineProperty({__proto__:null,closeConversationComposer:hs,default:Di,showConversationComposer:Di},Symbol.toStringTag,{value:"Module"}));function Ew(e={}){const t=x("div",{className:"conversations-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Conversations</h2>
        <span class="panel-count" id="conversations-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="import-conv-btn">Import</button>
      </div>
    </div>
    <div class="panel-content" id="conversations-content">
      <div class="loading">Loading conversations...</div>
    </div>
  `;const n=t.querySelector("#import-conv-btn");return n&&d(n,"click",()=>Dw(t,e)),oo(t,e),t}async function oo(e,t){const n=e.querySelector("#conversations-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=await na.getAll();_w(n,a,t),Pw(e,a.length)}catch{n.innerHTML='<div class="error">Failed to load conversations</div>'}}function _w(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No conversations imported</p>
        <p class="text-muted">Import chat transcripts, meeting notes, or message threads</p>
      </div>
    `;return}e.innerHTML=`
    <div class="conversations-list">
      ${t.map(a=>jw(a)).join("")}
    </div>
  `,e.querySelectorAll(".conversation-card").forEach(a=>{d(a,"click",async i=>{if(i.target.closest(".conv-actions"))return;const r=a.getAttribute("data-id"),c=t.find(l=>l.id===r);if(c){try{const l=await na.getById(r);$c(l)}catch{$c(c)}n.onConversationClick&&n.onConversationClick(c)}});const s=a.querySelector(".reembed-btn");s&&d(s,"click",async i=>{i.stopPropagation();const r=a.getAttribute("data-id");if(!r)return;const c=s;c.disabled=!0,c.textContent="Processing...";try{await na.reembed(r),u.success("Conversation re-embedded"),oo(e.closest(".conversations-panel"),n)}catch{u.error("Failed to re-embed conversation"),c.disabled=!1,c.textContent="Re-embed"}});const o=a.querySelector(".delete-conv-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=a.getAttribute("data-id");if(r&&confirm("Delete this conversation?"))try{await na.delete(r),u.success("Conversation deleted"),oo(e.closest(".conversations-panel"),n)}catch{u.error("Failed to delete conversation")}})})}function jw(e){return`
    <div class="conversation-card" data-id="${e.id}">
      <div class="conv-icon">üí¨</div>
      <div class="conv-info">
        <div class="conv-title">${Hw(e.title||"Untitled Conversation")}</div>
        <div class="conv-meta">
          ${e.participants?`<span>${e.participants.length} participants</span>`:""}
          ${e.message_count?`<span>${e.message_count} messages</span>`:""}
          <span>${J(e.created_at)}</span>
        </div>
      </div>
      <div class="conv-status">
        ${e.embedded?'<span class="embedded-badge">Embedded</span>':'<span class="not-embedded-badge">Not embedded</span>'}
      </div>
      <div class="conv-actions">
        <button class="btn btn-sm reembed-btn">Re-embed</button>
        <button class="btn btn-sm btn-danger delete-conv-btn">Delete</button>
      </div>
    </div>
  `}function Dw(e,t){Di({onImport:()=>{oo(e,t)},onClose:()=>{}})}function Pw(e,t){const n=e.querySelector("#conversations-count");n&&(n.textContent=String(t))}function Hw(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let Pi="all",np=!1;function ap(e={}){const t=x("div",{className:"emails-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Emails</h2>
        <span class="panel-count" id="emails-count">0</span>
      </div>
      <div class="panel-actions">
        <select id="direction-filter" class="filter-select">
          <option value="all">All</option>
          <option value="inbound">Inbound</option>
          <option value="outbound">Outbound</option>
          <option value="internal">Internal</option>
        </select>
        <label class="checkbox-label">
          <input type="checkbox" id="needs-response-filter"> Needs Response
        </label>
        <button class="btn btn-primary btn-sm" id="add-email-btn">+ Add Email</button>
      </div>
    </div>
    <div class="panel-content" id="emails-content">
      <div class="loading">Loading emails...</div>
    </div>
  `;const n=t.querySelector("#direction-filter");d(n,"change",()=>{Pi=n.value,Wa(t,e)});const a=t.querySelector("#needs-response-filter");d(a,"change",()=>{np=a.checked,Wa(t,e)});const s=t.querySelector("#add-email-btn");return s&&d(s,"click",async()=>{const{createEmailComposer:o,showEmailComposer:i}=await Y(async()=>{const{createEmailComposer:r,showEmailComposer:c}=await Promise.resolve().then(()=>ip);return{createEmailComposer:r,showEmailComposer:c}},void 0);i({onSave:()=>Wa(t,e)})}),Wa(t,e),t}async function Wa(e,t){const n=e.querySelector("#emails-content");n.innerHTML='<div class="loading">Loading...</div>';try{let a;np?a=await aa.getNeedingResponse():a=(await aa.getAll({direction:Pi==="all"?void 0:Pi})).emails,zw(n,a,t),Rw(e,a.length)}catch{n.innerHTML='<div class="error">Failed to load emails</div>'}}function zw(e,t,n){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No emails found</p>
      </div>
    `;return}e.innerHTML=`
    <div class="emails-list">
      ${t.map(a=>Bw(a)).join("")}
    </div>
  `,e.querySelectorAll(".email-card").forEach(a=>{d(a,"click",async i=>{if(i.target.closest(".email-actions"))return;const r=a.getAttribute("data-id"),c=t.find(l=>String(l.id)===r);if(c){try{const l=await aa.getById(r);Sc(l)}catch{Sc(c)}n.onEmailClick&&n.onEmailClick(c)}});const s=a.querySelector(".mark-responded-btn");s&&d(s,"click",async i=>{i.stopPropagation();const r=a.getAttribute("data-id");if(r)try{await aa.markResponded(r),u.success("Marked as responded"),Wa(e.closest(".emails-panel"),n)}catch{u.error("Failed to update email")}});const o=a.querySelector(".generate-response-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=a.getAttribute("data-id");if(!r)return;const c=o;c.disabled=!0,c.textContent="Generating...";try{const m=(await aa.generateResponse(r))[0]?.response||"";u.success("Response generated");const v=t.find(g=>String(g.id)===r);v&&(v.draft_response=m,gr({mode:"view",email:v}))}catch{u.error("Failed to generate response")}finally{c.disabled=!1,c.textContent="AI Response"}})})}function Bw(e){const t=e.direction==="inbound"?"üì•":e.direction==="outbound"?"üì§":"üîÑ",n=e.requires_response&&!e.response_sent;return`
    <div class="email-card ${n?"needs-response":""}" data-id="${e.id}">
      <div class="email-direction">${t}</div>
      <div class="email-info">
        <div class="email-header">
          <span class="email-from">${Ko(e.from_name||e.from_email||e.from||"")}</span>
          <span class="email-date">${J(e.created_at||e.date||new Date().toISOString())}</span>
        </div>
        <div class="email-subject">${Ko(e.subject||"(No subject)")}</div>
        <div class="email-preview">${Ko(Iw(e.body_text||""))}</div>
      </div>
      <div class="email-badges">
        ${n?'<span class="needs-response-badge">Needs Response</span>':""}
        ${e.response_drafted?'<span class="draft-badge">Draft Ready</span>':""}
        ${e.response_sent?'<span class="responded-badge">Responded</span>':""}
        ${e.ai_summary?'<span class="ai-badge">AI Analyzed</span>':""}
      </div>
      <div class="email-actions">
        ${n?`
          <button class="btn btn-sm generate-response-btn">AI Response</button>
          <button class="btn btn-sm mark-responded-btn">Mark Responded</button>
        `:""}
      </div>
    </div>
  `}function Iw(e,t=100){const n=e.replace(/\s+/g," ").trim();return n.length>t?n.slice(0,t)+"...":n}function Rw(e,t){const n=e.querySelector("#emails-count");n&&(n.textContent=String(t))}function Ko(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Nw=Object.freeze(Object.defineProperty({__proto__:null,createEmailsPanel:ap},Symbol.toStringTag,{value:"Module"}));let yr="paste";function Hi(e={}){const t=document.getElementById("email-composer-overlay");t&&t.remove();const n=x("div",{id:"email-composer-overlay",className:"composer-overlay"}),a=xr(e);n.appendChild(a),document.body.appendChild(n),d(n,"click",s=>{s.target===n&&($a(),e.onClose?.())}),requestAnimationFrame(()=>n.classList.add("visible"))}function $a(){const e=document.getElementById("email-composer-overlay");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),200))}function xr(e={}){const t=x("div",{className:"composer-modal"});return t.innerHTML=`
    <style>
      .composer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .composer-overlay.visible { opacity: 1; }
      .composer-overlay.visible .composer-modal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .composer-modal {
        width: 640px;
        max-width: 95vw;
        max-height: 85vh;
        background: var(--bg-primary);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px) scale(0.98);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .composer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
      }
      .composer-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .composer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--bg-secondary);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: all 0.15s ease;
      }
      .composer-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .composer-tabs {
        display: flex;
        padding: 0 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-tab {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        transition: color 0.15s ease;
      }
      .composer-tab:hover { color: var(--text-primary); }
      .composer-tab.active { color: var(--primary); }
      .composer-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        border-radius: 2px 2px 0 0;
      }
      
      .composer-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }
      
      /* Paste Mode */
      .paste-section label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 12px;
      }
      .paste-section textarea {
        width: 100%;
        min-height: 280px;
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      .paste-section textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .paste-section textarea::placeholder { color: var(--text-tertiary); }
      .paste-hint {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-tertiary);
      }
      
      /* Upload Mode */
      .upload-section .dropzone {
        border: 2px dashed var(--border-color);
        border-radius: 16px;
        padding: 60px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
      }
      .upload-section .dropzone:hover,
      .upload-section .dropzone.dragover {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.03);
      }
      .dropzone-icon { font-size: 48px; margin-bottom: 16px; }
      .dropzone-title {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 8px;
      }
      .dropzone-hint { font-size: 13px; color: var(--text-tertiary); }
      
      .selected-file {
        display: none;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }
      .selected-file.visible { display: flex; }
      .file-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      .file-info { flex: 1; min-width: 0; }
      .file-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .file-size { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
      .file-remove {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-tertiary);
        font-size: 18px;
        transition: all 0.15s ease;
      }
      .file-remove:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }
      
      /* Manual Mode */
      .manual-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .form-row {
        display: flex;
        gap: 16px;
      }
      .form-row > .form-group { flex: 1; }
      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .form-group label .required { color: var(--primary); }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
      }
      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }
      .form-group input::placeholder,
      .form-group textarea::placeholder { color: var(--text-tertiary); }
      
      .composer-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      .composer-footer .btn {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }
      .composer-footer .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      .composer-footer .btn-secondary:hover { background: var(--bg-tertiary); }
      .composer-footer .btn-primary {
        background: var(--primary);
        color: white;
      }
      .composer-footer .btn-primary:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .composer-footer .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
    
    <div class="composer-header">
      <h2>Add Email</h2>
      <button class="composer-close" id="close-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="composer-tabs">
      <button class="composer-tab active" data-mode="paste">Paste Text</button>
      <button class="composer-tab" data-mode="upload">Upload .eml/.msg</button>
      <button class="composer-tab" data-mode="manual">Manual Entry</button>
    </div>
    
    <div class="composer-body" id="composer-body">
      ${sp()}
    </div>
    
    <div class="composer-footer">
      <button class="btn btn-secondary" id="cancel-btn">Cancel</button>
      <button class="btn btn-primary" id="save-btn" disabled>Add Email</button>
    </div>
  `,t.querySelectorAll(".composer-tab").forEach(n=>{d(n,"click",()=>{t.querySelectorAll(".composer-tab").forEach(a=>a.classList.remove("active")),n.classList.add("active"),yr=n.getAttribute("data-mode"),Fw(t)})}),d(t.querySelector("#close-btn"),"click",()=>{$a(),e.onClose?.()}),d(t.querySelector("#cancel-btn"),"click",()=>{$a(),e.onClose?.()}),d(t.querySelector("#save-btn"),"click",()=>Kw(t,e)),op(t),t}function Fw(e){const t=e.querySelector("#composer-body");switch(yr){case"paste":t.innerHTML=sp(),op(e);break;case"upload":t.innerHTML=Ow(),Uw(e);break;case"manual":t.innerHTML=Vw(),Gw(e);break}}function sp(){return`
    <div class="paste-section">
      <label>Paste email content:</label>
      <textarea id="email-paste" placeholder="Paste the full email content here...

Include headers if available:
From: sender@example.com
To: recipient@example.com
Subject: Meeting notes
Date: Jan 31, 2026

Email body text..."></textarea>
      <p class="paste-hint">Include headers (From, To, Subject, Date) for better parsing.</p>
    </div>
  `}function op(e){const t=e.querySelector("#email-paste"),n=e.querySelector("#save-btn");t&&d(t,"input",()=>{n.disabled=t.value.trim().length<10})}function Ow(){return`
    <div class="upload-section">
      <div class="dropzone" id="file-dropzone">
        <div class="dropzone-icon">üìß</div>
        <p class="dropzone-title">Drop email file here</p>
        <p class="dropzone-hint">or click to browse ‚Ä¢ .eml, .msg</p>
        <input type="file" id="file-input" accept=".eml,.msg" hidden>
      </div>
      <div class="selected-file" id="selected-file">
        <div class="file-icon">üìß</div>
        <div class="file-info">
          <div class="file-name" id="file-name"></div>
          <div class="file-size" id="file-size"></div>
        </div>
        <button class="file-remove" id="file-remove">√ó</button>
      </div>
    </div>
  `}function Uw(e){const t=e.querySelector("#file-dropzone"),n=e.querySelector("#file-input"),a=e.querySelector("#selected-file"),s=e.querySelector("#save-btn");d(t,"click",()=>n.click()),d(t,"dragover",o=>{o.preventDefault(),t.classList.add("dragover")}),d(t,"dragleave",()=>t.classList.remove("dragover")),d(t,"drop",o=>{o.preventDefault(),t.classList.remove("dragover"),o.dataTransfer?.files[0]&&jc(o.dataTransfer.files[0],e)}),d(n,"change",()=>{n.files?.[0]&&jc(n.files[0],e)}),d(e.querySelector("#file-remove"),"click",()=>{a.classList.remove("visible"),e._emlFile=null,s.disabled=!0})}function jc(e,t){const n=t.querySelector("#selected-file"),a=t.querySelector("#save-btn");t.querySelector("#file-name").textContent=e.name,t.querySelector("#file-size").textContent=Ww(e.size),n.classList.add("visible"),t._emlFile=e,a.disabled=!1}function Vw(){return`
    <form class="manual-form" id="manual-form">
      <div class="form-row">
        <div class="form-group">
          <label>From <span class="required">*</span></label>
          <input type="email" name="from" placeholder="sender@example.com" required>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="datetime-local" name="date">
        </div>
      </div>
      <div class="form-group">
        <label>To <span class="required">*</span></label>
        <input type="text" name="to" placeholder="recipient@example.com (comma-separated)" required>
      </div>
      <div class="form-group">
        <label>CC</label>
        <input type="text" name="cc" placeholder="cc@example.com (comma-separated)">
      </div>
      <div class="form-group">
        <label>Subject</label>
        <input type="text" name="subject" placeholder="Email subject">
      </div>
      <div class="form-group">
        <label>Body <span class="required">*</span></label>
        <textarea name="body" placeholder="Email content..." required></textarea>
      </div>
    </form>
  `}function Gw(e){const t=e.querySelector("#manual-form"),n=e.querySelector("#save-btn"),a=()=>{const s=t.querySelector('[name="from"]'),o=t.querySelector('[name="to"]'),i=t.querySelector('[name="body"]');n.disabled=!s.value||!o.value||!i.value};t.querySelectorAll("input, textarea").forEach(s=>{d(s,"input",a)})}async function Qw(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>{const s=a.result.split(",")[1];t(s)},a.onerror=n,a.readAsDataURL(e)})}async function Kw(e,t){const n=e.querySelector("#save-btn");n.disabled=!0,n.textContent="Processing...";try{let a;switch(yr){case"paste":{a={emailText:e.querySelector("#email-paste").value};break}case"upload":{const o=e._emlFile;if(!o)throw new Error("No file selected");const i=await Qw(o);o.name.toLowerCase().endsWith(".msg")?a={msgBase64:i,filename:o.name}:a={emlBase64:i,filename:o.name};break}case"manual":{const o=e.querySelector("#manual-form"),i=new FormData(o);a={from:i.get("from"),to:i.get("to").split(",").map(r=>r.trim()),cc:i.get("cc")?i.get("cc").split(",").map(r=>r.trim()):void 0,subject:i.get("subject"),body:i.get("body"),date:i.get("date")||void 0};break}}const s=await p.post("/api/emails/import",a);u.success("Email added successfully"),t.onSave?.(s),$a()}catch(a){u.error("Failed to add email"),console.error("[EmailComposer] Error:",a)}finally{n.disabled=!1,n.textContent="Add Email"}}function Ww(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}const ip=Object.freeze(Object.defineProperty({__proto__:null,closeEmailComposer:$a,createEmailComposer:xr,default:Hi,showEmailComposer:Hi},Symbol.toStringTag,{value:"Module"}));let Ya=!1,Bn=0;function rp(e={}){const t=x("div",{className:"notifications-dropdown"});t.innerHTML=`
    <button class="notifications-trigger" id="notifications-trigger">
      <span class="bell-icon">üîî</span>
      <span class="notification-badge hidden" id="notification-badge">0</span>
    </button>
    <div class="notifications-panel hidden" id="notifications-panel">
      <div class="notifications-header">
        <h3>Notifications</h3>
        <button class="btn-link" id="mark-all-read">Mark all read</button>
      </div>
      <div class="notifications-list" id="notifications-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  `;const n=t.querySelector("#notifications-trigger");n&&d(n,"click",s=>{s.stopPropagation(),Yw(t,e)});const a=t.querySelector("#mark-all-read");return a&&d(a,"click",async()=>{try{await ba.markAllRead(),u.success("All notifications marked as read"),lp(t,e),io(t,0)}catch{u.error("Failed to mark notifications as read")}}),document.addEventListener("click",()=>{cp(t)}),Dc(t),setInterval(()=>Dc(t),6e4),t}function Yw(e,t){Ya=!Ya;const n=e.querySelector("#notifications-panel");n&&(n.classList.toggle("hidden",!Ya),Ya&&lp(e,t))}function cp(e){Ya=!1;const t=e.querySelector("#notifications-panel");t&&t.classList.add("hidden")}async function Dc(e){try{const t=await ba.getUnreadCount();Bn=t,io(e,t)}catch{}}function io(e,t){const n=e.querySelector("#notification-badge");n&&(n.textContent=t>99?"99+":String(t),n.classList.toggle("hidden",t===0))}async function lp(e,t){const n=e.querySelector("#notifications-list");n.innerHTML='<div class="loading">Loading...</div>';try{const a=await ba.getAll({limit:20});Jw(n,a,e,t)}catch{n.innerHTML='<div class="error">Failed to load</div>'}}function Jw(e,t,n,a){if(t.length===0){e.innerHTML='<div class="empty">No notifications</div>';return}e.innerHTML=t.map(s=>`
    <div class="notification-item ${s.read?"":"unread"}" data-id="${s.id}">
      <div class="notification-icon">${Zw(s.type)}</div>
      <div class="notification-content">
        <div class="notification-title">${Pc(s.title)}</div>
        ${s.message?`<div class="notification-message">${Pc(s.message)}</div>`:""}
        <div class="notification-time">${J(s.created_at)}</div>
      </div>
      <button class="btn-icon dismiss-btn" title="Dismiss">√ó</button>
    </div>
  `).join(""),e.querySelectorAll(".notification-item").forEach(s=>{d(s,"click",async i=>{if(i.target.closest(".dismiss-btn"))return;const r=s.getAttribute("data-id"),c=t.find(l=>l.id===r);c&&(c.read||(await ba.markRead(r),s.classList.remove("unread"),Bn=Math.max(0,Bn-1),io(n,Bn)),cp(n),a.onNotificationClick?.(c))});const o=s.querySelector(".dismiss-btn");o&&d(o,"click",async i=>{i.stopPropagation();const r=s.getAttribute("data-id");if(r)try{if(await ba.delete(r),s.remove(),!s.classList.contains("unread"))return;Bn=Math.max(0,Bn-1),io(n,Bn)}catch{}})})}function Zw(e){switch(e){case"question":return"‚ùì";case"risk":return"‚ö†Ô∏è";case"action":return"‚úÖ";case"decision":return"‚öñÔ∏è";case"mention":return"@";case"comment":return"üí¨";case"assignment":return"üë§";default:return"üì£"}}function Pc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function dp(e,t={}){const n=rp(t);return e.appendChild(n),n}function Xw(e){const t=x("div",{className:"comments-thread"});t.innerHTML=`
    <div class="comments-header">
      <h4>Comments</h4>
      <span class="comments-count" id="comments-count">0</span>
    </div>
    <div class="comments-list" id="comments-list">
      <div class="loading">Loading comments...</div>
    </div>
    <div class="comment-form">
      <textarea id="comment-input" placeholder="Add a comment..." rows="2"></textarea>
      <div class="comment-form-actions">
        <button class="btn btn-primary btn-sm" id="submit-comment-btn" disabled>Comment</button>
      </div>
    </div>
  `;const n=t.querySelector("#comment-input"),a=t.querySelector("#submit-comment-btn");return d(n,"input",()=>{a.disabled=!n.value.trim()}),d(a,"click",()=>Hc(t,e,n)),d(n,"keydown",s=>{s.key==="Enter"&&(s.ctrlKey||s.metaKey)&&(s.preventDefault(),n.value.trim()&&Hc(t,e,n))}),as(t,e),t}async function as(e,t){const n=e.querySelector("#comments-list");n.innerHTML='<div class="loading">Loading...</div>';try{const a=await sa.getAll(t.targetType,t.targetId);ek(n,a,e,t),ak(e,a.length)}catch{n.innerHTML='<div class="error">Failed to load comments</div>'}}function ek(e,t,n,a){if(t.length===0){e.innerHTML='<div class="empty">No comments yet</div>';return}const s=t.filter(r=>!r.parent_id),o=t.filter(r=>r.parent_id),i={};o.forEach(r=>{i[r.parent_id]||(i[r.parent_id]=[]),i[r.parent_id].push(r)}),e.innerHTML=s.map(r=>tk(r,i[r.id]||[])).join(""),nk(e,t,n,a)}function tk(e,t,n,a){const s=P.getState().currentUser,o=s?.id===e.user_id;return`
    <div class="comment ${e.resolved?"resolved":""}" data-id="${e.id}">
      <div class="comment-avatar">${zc(e.user_name||"U")}</div>
      <div class="comment-body">
        <div class="comment-header">
          <span class="comment-author">${_s(e.user_name||"Unknown")}</span>
          <span class="comment-time">${J(e.created_at)}</span>
          ${e.resolved?'<span class="resolved-badge">Resolved</span>':""}
        </div>
        <div class="comment-content">${_s(e.content)}</div>
        <div class="comment-actions">
          <button class="btn-link reply-btn">Reply</button>
          ${e.resolved?"":'<button class="btn-link resolve-btn">Resolve</button>'}
          ${o?'<button class="btn-link delete-btn">Delete</button>':""}
        </div>
        <div class="reply-form hidden">
          <textarea class="reply-input" placeholder="Reply..." rows="2"></textarea>
          <div class="reply-actions">
            <button class="btn btn-sm cancel-reply-btn">Cancel</button>
            <button class="btn btn-primary btn-sm submit-reply-btn">Reply</button>
          </div>
        </div>
      </div>
    </div>
    ${t.length>0?`
      <div class="comment-replies">
        ${t.map(i=>`
          <div class="comment reply" data-id="${i.id}">
            <div class="comment-avatar small">${zc(i.user_name||"U")}</div>
            <div class="comment-body">
              <div class="comment-header">
                <span class="comment-author">${_s(i.user_name||"Unknown")}</span>
                <span class="comment-time">${J(i.created_at)}</span>
              </div>
              <div class="comment-content">${_s(i.content)}</div>
              ${s?.id===i.user_id?`
                <div class="comment-actions">
                  <button class="btn-link delete-btn">Delete</button>
                </div>
              `:""}
            </div>
          </div>
        `).join("")}
      </div>
    `:""}
  `}function nk(e,t,n,a){e.querySelectorAll(".reply-btn").forEach(s=>{d(s,"click",()=>{const i=s.closest(".comment")?.querySelector(".reply-form");i&&(i.classList.toggle("hidden"),i.querySelector(".reply-input")?.focus())})}),e.querySelectorAll(".cancel-reply-btn").forEach(s=>{d(s,"click",()=>{const o=s.closest(".reply-form");o&&(o.classList.add("hidden"),o.querySelector(".reply-input").value="")})}),e.querySelectorAll(".submit-reply-btn").forEach(s=>{d(s,"click",async()=>{const o=s.closest(".comment"),i=o?.getAttribute("data-id"),r=o?.querySelector(".reply-input");if(!(!i||!r?.value.trim()))try{await sa.create(a.targetType,a.targetId,r.value.trim(),i),u.success("Reply added"),as(n,a)}catch{u.error("Failed to add reply")}})}),e.querySelectorAll(".resolve-btn").forEach(s=>{d(s,"click",async()=>{const i=s.closest(".comment")?.getAttribute("data-id");if(i)try{await sa.resolve(i),u.success("Comment resolved"),as(n,a)}catch{u.error("Failed to resolve comment")}})}),e.querySelectorAll(".delete-btn").forEach(s=>{d(s,"click",async()=>{const i=s.closest(".comment")?.getAttribute("data-id");if(!(!i||!confirm("Delete this comment?")))try{await sa.delete(i),u.success("Comment deleted"),as(n,a)}catch{u.error("Failed to delete comment")}})})}async function Hc(e,t,n){const a=n.value.trim();if(!a)return;const s=e.querySelector("#submit-comment-btn");s.disabled=!0;try{const o=await sa.create(t.targetType,t.targetId,a);n.value="",u.success("Comment added"),as(e,t),t.onCommentAdded?.(o)}catch{u.error("Failed to add comment"),s.disabled=!1}}function ak(e,t){const n=e.querySelector("#comments-count");n&&(n.textContent=String(t))}function zc(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function _s(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function sk(e={}){const t=x("div",{className:"members-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Team Members</h2>
        <span class="panel-count" id="members-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="invite-member-btn">+ Invite</button>
      </div>
    </div>
    <div class="panel-content" id="members-content">
      <div class="loading">Loading members...</div>
    </div>
    <div class="pending-invites" id="pending-invites"></div>
  `;const n=t.querySelector("#invite-member-btn");n&&d(n,"click",()=>{const s=e.projectId||P.getState().currentProject?.id;if(!s){u.error("No project selected");return}pr({projectId:s})});const a=e.projectId||P.getState().currentProject?.id;return a&&(Rs(t,a,e),ik(t,a)),t}async function Rs(e,t,n){const a=e.querySelector("#members-content");a.innerHTML='<div class="loading">Loading...</div>';try{const s=await ms.getAll(t);ok(a,s,t,n),rk(e,s.length)}catch{a.innerHTML='<div class="error">Failed to load members</div>'}}function ok(e,t,n,a){if(t.length===0){e.innerHTML='<div class="empty">No team members</div>';return}const s=P.getState().currentUser;e.innerHTML=`
    <div class="members-list">
      ${t.map(o=>`
        <div class="member-card" data-id="${o.user_id}">
          <div class="member-avatar">
            ${o.avatar_url?`<img src="${o.avatar_url}" alt="">`:`<span>${ck(o.name||o.email)}</span>`}
          </div>
          <div class="member-info">
            <div class="member-name">${zi(o.name||o.email)}</div>
            <div class="member-email">${zi(o.email)}</div>
          </div>
          <div class="member-role">
            <select class="role-select" data-user-id="${o.user_id}" ${o.user_id===s?.id?"disabled":""}>
              <option value="viewer" ${o.role==="viewer"?"selected":""}>Viewer</option>
              <option value="editor" ${o.role==="editor"?"selected":""}>Editor</option>
              <option value="admin" ${o.role==="admin"?"selected":""}>Admin</option>
              <option value="owner" ${o.role==="owner"?"selected":""}>Owner</option>
            </select>
          </div>
          <button class="btn-icon permissions-btn" data-user-id="${o.user_id}" title="Permissions" style="font-size: 14px;">üîê</button>
          ${o.user_id!==s?.id?`
            <button class="btn-icon remove-member-btn" data-user-id="${o.user_id}" title="Remove">√ó</button>
          `:""}
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".role-select").forEach(o=>{d(o,"change",async()=>{const i=o.getAttribute("data-user-id"),r=o.value;if(i)try{await ms.updateRole(i,r,n),u.success("Role updated")}catch{u.error("Failed to update role"),Rs(e.closest(".members-panel"),n,a)}})}),e.querySelectorAll(".remove-member-btn").forEach(o=>{d(o,"click",async()=>{const i=o.getAttribute("data-user-id");if(!(!i||!confirm("Remove this member from the project?")))try{await ms.remove(n,i),u.success("Member removed"),Rs(e.closest(".members-panel"),n,a)}catch{u.error("Failed to remove member")}})}),e.querySelectorAll(".permissions-btn").forEach(o=>{d(o,"click",()=>{const i=o.getAttribute("data-user-id"),r=t.find(c=>c.user_id===i);r&&Al({projectId:n,userId:r.user_id,userName:r.name||"",userEmail:r.email,avatarUrl:r.avatar_url,currentRole:r.role,currentPermissions:r.permissions,onSave:()=>{Rs(e.closest(".members-panel"),n,a)}})})}),e.querySelectorAll(".member-card").forEach(o=>{d(o,"click",i=>{if(i.target.closest(".role-select, .remove-member-btn"))return;const r=o.getAttribute("data-id"),c=t.find(l=>l.user_id===r);c&&a.onMemberClick&&a.onMemberClick(c)})})}async function ik(e,t){const n=e.querySelector("#pending-invites");try{const a=await ms.getInvites(t);if(a.length===0){n.innerHTML="";return}n.innerHTML=`
      <div class="invites-section">
        <h4>Pending Invites</h4>
        <div class="invites-list">
          ${a.map(s=>`
            <div class="invite-card" data-id="${s.id}">
              <div class="invite-info">
                <span class="invite-email">${zi(s.email)}</span>
                <span class="invite-role">${s.role}</span>
                <span class="invite-time">Sent ${J(s.invited_at||s.created_at||new Date().toISOString())}</span>
              </div>
              <button class="btn btn-sm cancel-invite-btn" data-id="${s.id}">Cancel</button>
            </div>
          `).join("")}
        </div>
      </div>
    `,n.querySelectorAll(".cancel-invite-btn").forEach(s=>{d(s,"click",async()=>{if(s.getAttribute("data-id"))try{u.info("Invite cancellation not implemented")}catch{u.error("Failed to cancel invite")}})})}catch{}}function rk(e,t){const n=e.querySelector("#members-count");n&&(n.textContent=String(t))}function ck(e){return e.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2)}function zi(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function lk(e={}){const t=x("div",{className:"api-keys-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>API Keys</h2>
        <span class="panel-count" id="keys-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="create-key-btn">+ Create Key</button>
      </div>
    </div>
    <div class="panel-content" id="keys-content">
      <div class="loading">Loading API keys...</div>
    </div>
  `;const n=t.querySelector("#create-key-btn");return n&&d(n,"click",()=>pk(t,e)),wr(t,e),t}async function wr(e,t){const n=e.querySelector("#keys-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=await p.get("/api/keys");dk(n,a.data.keys||[],e,t),mk(e,a.data.keys?.length||0)}catch{n.innerHTML='<div class="error">Failed to load API keys</div>'}}function dk(e,t,n,a){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No API keys created yet</p>
        <p class="hint">Create an API key to access the GodMode API programmatically</p>
      </div>
    `;return}e.innerHTML=`
    <div class="keys-list">
      ${t.map(s=>`
        <div class="key-card" data-id="${s.id}">
          <div class="key-info">
            <div class="key-name">${pp(s.name)}</div>
            <div class="key-preview">${s.key_prefix}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            <div class="key-meta">
              Created ${J(s.created_at)}
              ${s.last_used?`‚Ä¢ Last used ${J(s.last_used)}`:"‚Ä¢ Never used"}
              ${s.expires_at?`‚Ä¢ Expires ${J(s.expires_at)}`:""}
            </div>
            ${s.scopes.length>0?`
              <div class="key-scopes">
                ${s.scopes.map(o=>`<span class="scope-badge">${o}</span>`).join("")}
              </div>
            `:""}
          </div>
          <div class="key-actions">
            <button class="btn btn-sm revoke-key-btn" data-id="${s.id}">Revoke</button>
          </div>
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".revoke-key-btn").forEach(s=>{d(s,"click",async o=>{o.stopPropagation();const i=s.getAttribute("data-id");if(!(!i||!confirm("Revoke this API key? This action cannot be undone.")))try{await p.delete(`/api/keys/${i}`),u.success("API key revoked"),wr(n,a)}catch{u.error("Failed to revoke API key")}})})}function pk(e,t){const n=x("div",{className:"modal-overlay"});n.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create API Key</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <form id="create-key-form" class="modal-body">
        <div class="form-group">
          <label for="key-name">Key Name *</label>
          <input type="text" id="key-name" required placeholder="e.g., My Integration">
        </div>
        <div class="form-group">
          <label for="key-expiry">Expires</label>
          <select id="key-expiry">
            <option value="">Never</option>
            <option value="30">30 days</option>
            <option value="90">90 days</option>
            <option value="365">1 year</option>
          </select>
        </div>
        <div class="form-group">
          <label>Scopes</label>
          <div class="scopes-grid">
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="read" checked> Read
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="write"> Write
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="chat"> Chat
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scopes" value="admin"> Admin
            </label>
          </div>
        </div>
      </form>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Cancel</button>
        <button class="btn btn-primary" id="submit-key-btn">Create Key</button>
      </div>
    </div>
  `,document.body.appendChild(n),n.querySelectorAll(".close-modal").forEach(s=>{d(s,"click",()=>n.remove())}),d(n,"click",s=>{s.target===n&&n.remove()});const a=n.querySelector("#submit-key-btn");a&&d(a,"click",async()=>{const s=n.querySelector("#create-key-form"),o=s.querySelector("#key-name"),i=s.querySelector("#key-expiry"),r=s.querySelectorAll('input[name="scopes"]:checked');if(!o.value.trim()){u.error("Key name is required");return}const c=Array.from(r).map(m=>m.value),l=a;l.disabled=!0,l.textContent="Creating...";try{const m=await p.post("/api/keys",{name:o.value.trim(),expires_in_days:i.value?parseInt(i.value):null,scopes:c});uk(m.data.key),n.remove(),wr(e,t)}catch{u.error("Failed to create API key"),l.disabled=!1,l.textContent="Create Key"}})}function uk(e){const t=x("div",{className:"modal-overlay"});t.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>API Key Created</h2>
      </div>
      <div class="modal-body">
        <p class="warning-text">‚ö†Ô∏è Copy this key now! You won't be able to see it again.</p>
        <div class="key-display">
          <code id="new-key-value">${pp(e)}</code>
          <button class="btn btn-sm" id="copy-key-btn">Copy</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary close-modal">Done</button>
      </div>
    </div>
  `,document.body.appendChild(t);const n=t.querySelector("#copy-key-btn");n&&d(n,"click",async()=>{try{await navigator.clipboard.writeText(e),u.success("Key copied to clipboard"),n.textContent="Copied!"}catch{u.error("Failed to copy")}}),t.querySelectorAll(".close-modal").forEach(a=>{d(a,"click",()=>t.remove())})}function mk(e,t){const n=e.querySelector("#keys-count");n&&(n.textContent=String(t))}function pp(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const gk=["question.created","question.updated","question.answered","risk.created","risk.updated","risk.mitigated","action.created","action.completed","decision.created","decision.approved","decision.rejected","document.uploaded","document.processed","chat.message"];function vk(e={}){const t=x("div",{className:"webhooks-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Webhooks</h2>
        <span class="panel-count" id="webhooks-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-primary btn-sm" id="create-webhook-btn">+ Add Webhook</button>
      </div>
    </div>
    <div class="panel-content" id="webhooks-content">
      <div class="loading">Loading webhooks...</div>
    </div>
  `;const n=t.querySelector("#create-webhook-btn");return n&&d(n,"click",()=>up(t,e)),kr(t,e),t}async function kr(e,t){const n=e.querySelector("#webhooks-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=await p.get("/api/webhooks");fk(n,a.data.webhooks||[],e,t),hk(e,a.data.webhooks?.length||0)}catch{n.innerHTML='<div class="error">Failed to load webhooks</div>'}}function fk(e,t,n,a){if(t.length===0){e.innerHTML=`
      <div class="empty-state">
        <p>No webhooks configured</p>
        <p class="hint">Webhooks allow you to receive real-time notifications when events occur</p>
      </div>
    `;return}e.innerHTML=`
    <div class="webhooks-list">
      ${t.map(s=>`
        <div class="webhook-card ${s.active?"":"inactive"}" data-id="${s.id}">
          <div class="webhook-status">
            <span class="status-indicator ${s.active?"active":"inactive"}"></span>
          </div>
          <div class="webhook-info">
            <div class="webhook-name">${ss(s.name)}</div>
            <div class="webhook-url">${ss(s.url)}</div>
            <div class="webhook-events">
              ${s.events.slice(0,3).map(o=>`<span class="event-badge">${o}</span>`).join("")}
              ${s.events.length>3?`<span class="more-events">+${s.events.length-3}</span>`:""}
            </div>
            <div class="webhook-meta">
              Created ${J(s.created_at)}
              ${s.last_triggered?`‚Ä¢ Last triggered ${J(s.last_triggered)} (${s.last_status})`:"‚Ä¢ Never triggered"}
            </div>
          </div>
          <div class="webhook-actions">
            <button class="btn btn-sm test-webhook-btn" data-id="${s.id}">Test</button>
            <button class="btn btn-sm edit-webhook-btn" data-id="${s.id}">Edit</button>
            <button class="btn btn-sm btn-danger delete-webhook-btn" data-id="${s.id}">Delete</button>
          </div>
        </div>
      `).join("")}
    </div>
  `,e.querySelectorAll(".test-webhook-btn").forEach(s=>{d(s,"click",async o=>{o.stopPropagation();const i=s.getAttribute("data-id");if(!i)return;const r=s;r.disabled=!0,r.textContent="Testing...";try{await p.post(`/api/webhooks/${i}/test`),u.success("Test webhook sent")}catch{u.error("Failed to send test webhook")}finally{r.disabled=!1,r.textContent="Test"}})}),e.querySelectorAll(".edit-webhook-btn").forEach(s=>{d(s,"click",o=>{o.stopPropagation();const i=s.getAttribute("data-id"),r=t.find(c=>c.id===i);r&&up(n,a,r)})}),e.querySelectorAll(".delete-webhook-btn").forEach(s=>{d(s,"click",async o=>{o.stopPropagation();const i=s.getAttribute("data-id");if(!(!i||!confirm("Delete this webhook?")))try{await p.delete(`/api/webhooks/${i}`),u.success("Webhook deleted"),kr(n,a)}catch{u.error("Failed to delete webhook")}})})}function up(e,t,n){const a=!!n,s=x("div",{className:"modal-overlay"});s.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>${a?"Edit Webhook":"Create Webhook"}</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <form id="webhook-form" class="modal-body">
        <div class="form-group">
          <label for="webhook-name">Name *</label>
          <input type="text" id="webhook-name" required value="${ss(n?.name||"")}" placeholder="e.g., Slack Notifications">
        </div>
        <div class="form-group">
          <label for="webhook-url">URL *</label>
          <input type="url" id="webhook-url" required value="${ss(n?.url||"")}" placeholder="https://your-endpoint.com/webhook">
        </div>
        <div class="form-group">
          <label for="webhook-secret">Secret (Optional)</label>
          <input type="text" id="webhook-secret" value="${ss(n?.secret||"")}" placeholder="Used to sign payloads">
        </div>
        <div class="form-group">
          <label>Events *</label>
          <div class="events-grid">
            ${gk.map(i=>`
              <label class="checkbox-label">
                <input type="checkbox" name="events" value="${i}" ${n?.events.includes(i)?"checked":""}>
                ${i}
              </label>
            `).join("")}
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="webhook-active" ${n?.active!==!1?"checked":""}>
            Active
          </label>
        </div>
      </form>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Cancel</button>
        <button class="btn btn-primary" id="submit-webhook-btn">${a?"Save":"Create"}</button>
      </div>
    </div>
  `,document.body.appendChild(s),s.querySelectorAll(".close-modal").forEach(i=>{d(i,"click",()=>s.remove())}),d(s,"click",i=>{i.target===s&&s.remove()});const o=s.querySelector("#submit-webhook-btn");o&&d(o,"click",async()=>{const i=s.querySelector("#webhook-form"),r=i.querySelector("#webhook-name"),c=i.querySelector("#webhook-url"),l=i.querySelector("#webhook-secret"),m=i.querySelector("#webhook-active"),v=i.querySelectorAll('input[name="events"]:checked');if(!r.value.trim()||!c.value.trim()){u.error("Name and URL are required");return}const g=Array.from(v).map(w=>w.value);if(g.length===0){u.error("Select at least one event");return}const f={name:r.value.trim(),url:c.value.trim(),secret:l.value.trim()||void 0,events:g,active:m.checked},b=o;b.disabled=!0,b.textContent=a?"Saving...":"Creating...";try{a?(await p.put(`/api/webhooks/${n.id}`,f),u.success("Webhook updated")):(await p.post("/api/webhooks",f),u.success("Webhook created")),s.remove(),kr(e,t)}catch{u.error(`Failed to ${a?"update":"create"} webhook`),b.disabled=!1,b.textContent=a?"Save":"Create"}})}function hk(e,t){const n=e.querySelector("#webhooks-count");n&&(n.textContent=String(t))}function ss(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let zt={},Bt=1;const mp=50;function bk(e={}){const t=x("div",{className:"audit-panel"});t.innerHTML=`
    <div class="panel-header">
      <div class="panel-title">
        <h2>Audit Log</h2>
        <span class="panel-count" id="audit-count">0</span>
      </div>
      <div class="panel-actions">
        <button class="btn btn-sm" id="export-audit-btn">Export</button>
        <button class="btn btn-sm" id="filter-audit-btn">Filter</button>
      </div>
    </div>
    <div class="audit-filters hidden" id="audit-filters">
      <div class="filter-row">
        <select id="filter-action" class="filter-select">
          <option value="">All Actions</option>
          <option value="create">Create</option>
          <option value="update">Update</option>
          <option value="delete">Delete</option>
          <option value="login">Login</option>
          <option value="logout">Logout</option>
          <option value="export">Export</option>
        </select>
        <select id="filter-entity" class="filter-select">
          <option value="">All Entities</option>
          <option value="question">Questions</option>
          <option value="risk">Risks</option>
          <option value="action">Actions</option>
          <option value="decision">Decisions</option>
          <option value="contact">Contacts</option>
          <option value="document">Documents</option>
          <option value="user">Users</option>
          <option value="project">Projects</option>
        </select>
        <input type="date" id="filter-from" class="filter-date" placeholder="From">
        <input type="date" id="filter-to" class="filter-date" placeholder="To">
        <button class="btn btn-sm" id="apply-filters-btn">Apply</button>
        <button class="btn btn-sm" id="clear-filters-btn">Clear</button>
      </div>
    </div>
    <div class="panel-content" id="audit-content">
      <div class="loading">Loading audit logs...</div>
    </div>
    <div class="audit-pagination" id="audit-pagination"></div>
  `;const n=t.querySelector("#filter-audit-btn");n&&d(n,"click",()=>{t.querySelector("#audit-filters")?.classList.toggle("hidden")});const a=t.querySelector("#apply-filters-btn");a&&d(a,"click",()=>{zt={action:t.querySelector("#filter-action").value||void 0,entity_type:t.querySelector("#filter-entity").value||void 0,from_date:t.querySelector("#filter-from").value||void 0,to_date:t.querySelector("#filter-to").value||void 0},Bt=1,os(t,e)});const s=t.querySelector("#clear-filters-btn");s&&d(s,"click",()=>{zt={},Bt=1,t.querySelector("#filter-action").value="",t.querySelector("#filter-entity").value="",t.querySelector("#filter-from").value="",t.querySelector("#filter-to").value="",os(t,e)});const o=t.querySelector("#export-audit-btn");return o&&d(o,"click",()=>$k()),os(t,e),t}async function os(e,t){const n=e.querySelector("#audit-content");n.innerHTML='<div class="loading">Loading...</div>';try{const a=new URLSearchParams;a.set("page",String(Bt)),a.set("limit",String(mp)),zt.action&&a.set("action",zt.action),zt.entity_type&&a.set("entity_type",zt.entity_type),zt.from_date&&a.set("from_date",zt.from_date),zt.to_date&&a.set("to_date",zt.to_date);const s=await p.get(`/api/audit?${a}`);yk(n,s.data.logs||[]),Sk(e,s.data.total),wk(e,s.data.total,t)}catch{n.innerHTML='<div class="error">Failed to load audit logs</div>'}}function yk(e,t){if(t.length===0){e.innerHTML='<div class="empty">No audit logs found</div>';return}e.innerHTML=`
    <div class="audit-table">
      <div class="audit-header">
        <span class="audit-col time">Time</span>
        <span class="audit-col user">User</span>
        <span class="audit-col action">Action</span>
        <span class="audit-col entity">Entity</span>
        <span class="audit-col details">Details</span>
      </div>
      <div class="audit-body">
        ${t.map(n=>`
          <div class="audit-row" data-id="${n.id}">
            <span class="audit-col time" title="${new Date(n.created_at).toLocaleString()}">
              ${J(n.created_at)}
            </span>
            <span class="audit-col user">
              ${n.user_name||n.user_email||"System"}
              ${n.ip_address?`<span class="ip-address">${n.ip_address}</span>`:""}
            </span>
            <span class="audit-col action">
              <span class="action-badge ${xk(n.action)}">${n.action}</span>
            </span>
            <span class="audit-col entity">
              ${n.entity_type}${n.entity_id?` #${n.entity_id.slice(0,8)}`:""}
            </span>
            <span class="audit-col details">
              ${n.details?'<button class="btn-link view-details-btn">View</button>':"-"}
            </span>
          </div>
        `).join("")}
      </div>
    </div>
  `,e.querySelectorAll(".view-details-btn").forEach((n,a)=>{d(n,"click",()=>{const s=t[a];s?.details&&kk(s)})})}function xk(e){return e.includes("create")?"create":e.includes("update")?"update":e.includes("delete")?"delete":e.includes("login")?"login":e.includes("export")?"export":""}function wk(e,t,n){const a=e.querySelector("#audit-pagination"),s=Math.ceil(t/mp);if(s<=1){a.innerHTML="";return}a.innerHTML=`
    <button class="btn btn-sm" id="prev-page" ${Bt===1?"disabled":""}>Previous</button>
    <span class="page-info">Page ${Bt} of ${s}</span>
    <button class="btn btn-sm" id="next-page" ${Bt===s?"disabled":""}>Next</button>
  `;const o=a.querySelector("#prev-page");o&&d(o,"click",()=>{Bt>1&&(Bt--,os(e,n))});const i=a.querySelector("#next-page");i&&d(i,"click",()=>{Bt<s&&(Bt++,os(e,n))})}function kk(e){const t=x("div",{className:"modal-overlay"});t.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Audit Log Details</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <div class="modal-body">
        <div class="detail-row">
          <span class="detail-label">ID:</span>
          <span class="detail-value">${e.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Time:</span>
          <span class="detail-value">${new Date(e.created_at).toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Action:</span>
          <span class="detail-value">${e.action}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Entity:</span>
          <span class="detail-value">${e.entity_type} ${e.entity_id||""}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">User:</span>
          <span class="detail-value">${e.user_name||e.user_email||"System"}</span>
        </div>
        ${e.ip_address?`
          <div class="detail-row">
            <span class="detail-label">IP Address:</span>
            <span class="detail-value">${e.ip_address}</span>
          </div>
        `:""}
        <div class="detail-row">
          <span class="detail-label">Details:</span>
          <pre class="detail-json">${JSON.stringify(e.details,null,2)}</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary close-modal">Close</button>
      </div>
    </div>
  `,document.body.appendChild(t),t.querySelectorAll(".close-modal").forEach(n=>{d(n,"click",()=>t.remove())}),d(t,"click",n=>{n.target===t&&t.remove()})}function $k(e){const t=x("div",{className:"modal-overlay"});t.innerHTML=`
    <div class="modal-content">
      <div class="modal-header">
        <h2>Export Audit Logs</h2>
        <button class="btn-icon close-modal">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Date Range</label>
          <div class="date-range">
            <input type="date" id="export-from" placeholder="From">
            <span>to</span>
            <input type="date" id="export-to" placeholder="To">
          </div>
        </div>
        <div class="form-group">
          <label>Format</label>
          <select id="export-format">
            <option value="csv">CSV</option>
            <option value="json">JSON</option>
          </select>
        </div>
        <div class="form-group">
          <label>Include</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="include" value="details" checked> Details
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="include" value="ip"> IP Addresses
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close-modal">Cancel</button>
        <button class="btn btn-primary" id="export-btn">Export</button>
      </div>
    </div>
  `,document.body.appendChild(t),t.querySelectorAll(".close-modal").forEach(a=>{d(a,"click",()=>t.remove())}),d(t,"click",a=>{a.target===t&&t.remove()});const n=t.querySelector("#export-btn");n&&d(n,"click",async()=>{const a=t.querySelector("#export-from").value,s=t.querySelector("#export-to").value,o=t.querySelector("#export-format").value,i=t.querySelectorAll('input[name="include"]:checked'),r=Array.from(i).map(l=>l.value),c=n;c.disabled=!0,c.textContent="Exporting...";try{const l=new URLSearchParams;l.set("format",o),a&&l.set("from_date",a),s&&l.set("to_date",s),r.forEach(b=>l.append("include",b));const m=await fetch(`/api/audit/export?${l}`);if(!m.ok)throw new Error("Export failed");const v=await m.blob(),g=URL.createObjectURL(v),f=document.createElement("a");f.href=g,f.download=`audit-logs-${new Date().toISOString().split("T")[0]}.${o}`,f.click(),URL.revokeObjectURL(g),u.success("Audit logs exported"),t.remove()}catch{u.error("Failed to export audit logs"),c.disabled=!1,c.textContent="Export"}})}function Sk(e,t){const n=e.querySelector("#audit-count");n&&(n.textContent=String(t))}const gp=[{id:"project",name:"Project",icon:"üìã",examples:"Project Manager, Scrum Master, Product Owner"},{id:"technical",name:"Technical",icon:"üíª",examples:"Developer, Architect, DevOps, QA"},{id:"management",name:"Management",icon:"üëî",examples:"Director, VP, C-Level"},{id:"stakeholder",name:"Stakeholder",icon:"ü§ù",examples:"Client, Sponsor, External Partner"},{id:"custom",name:"Custom",icon:"‚ú®",examples:"Custom roles for your team"}];let ro=[],pa=null;async function vp(e){e.innerHTML=`
    <style>
      .roles-panel-sota {
        padding: 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .roles-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
      }
      
      .roles-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .roles-header h2 svg {
        width: 28px;
        height: 28px;
        color: #e11d48;
      }
      
      .roles-header-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 4px;
        font-weight: 400;
      }
      
      .btn-create-role {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-create-role:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .roles-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
      }
      
      @media (max-width: 900px) {
        .roles-layout {
          grid-template-columns: 1fr;
        }
      }
      
      .roles-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .role-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      
      .role-card:hover {
        border-color: #e11d48;
        transform: translateX(4px);
      }
      
      .role-card.active {
        border-color: #e11d48;
        background: linear-gradient(135deg, rgba(225,29,72,0.08) 0%, rgba(225,29,72,0.03) 100%);
      }
      
      .role-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      
      .role-color-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      
      .role-card-name {
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }
      
      .role-card-badges {
        display: flex;
        gap: 4px;
      }
      
      .role-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
      }
      
      .role-badge.template {
        background: #dbeafe;
        color: #1d4ed8;
      }
      
      .role-badge.system {
        background: #fef3c7;
        color: #92400e;
      }
      
      .role-card-category {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }
      
      .role-card-desc {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      /* Editor Panel */
      .role-editor {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        overflow: hidden;
      }
      
      .role-editor-header {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        padding: 24px;
        color: white;
      }
      
      .role-editor-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
      }
      
      .role-editor-body {
        padding: 24px;
      }
      
      .form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .form-group {
        flex: 1;
      }
      
      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s;
        box-sizing: border-box;
      }
      
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #e11d48;
        box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.1);
      }
      
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
      
      .form-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 6px;
      }
      
      .ai-enhance-section {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        margin-top: 12px;
      }
      
      .ai-enhance-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      
      .ai-enhance-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }
      
      .ai-enhance-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .ai-enhance-btn svg {
        width: 14px;
        height: 14px;
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .spin {
        animation: spin 1s linear infinite;
      }
      
      /* Actions */
      .role-editor-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
      }
      
      .btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }
      
      .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }
      
      .btn-secondary:hover {
        background: var(--bg-tertiary);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(225, 29, 72, 0.3);
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
      }
      
      .btn-danger {
        background: #fee2e2;
        color: #dc2626;
      }
      
      .btn-danger:hover {
        background: #fecaca;
      }
      
      .template-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        padding: 14px 16px;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border: 1px solid #86efac;
        border-radius: 12px;
      }
      
      .template-toggle label {
        margin: 0;
        font-size: 13px;
        color: #166534;
        font-weight: 500;
      }
      
      .template-toggle input {
        accent-color: #16a34a;
        width: 18px;
        height: 18px;
      }
      
      .empty-state {
        text-align: center;
        padding: 48px;
        color: var(--text-muted);
      }
      
      .empty-state svg {
        width: 64px;
        height: 64px;
        opacity: 0.3;
        margin-bottom: 16px;
      }
      
      .info-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #93c5fd;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .info-card h4 {
        margin: 0 0 8px;
        font-size: 14px;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .info-card p {
        margin: 0;
        font-size: 13px;
        color: #3b82f6;
        line-height: 1.5;
      }
    </style>
    
    <div class="roles-panel-sota">
      <div class="roles-header">
        <div>
          <h2>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
            </svg>
            Role Templates
          </h2>
          <div class="roles-header-subtitle">Define roles to assign to team members and contacts. The AI uses role context to adapt responses.</div>
        </div>
        <button class="btn-create-role" id="btn-create-role">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create Role
        </button>
      </div>
      
      <div class="roles-layout">
        <div class="roles-list" id="roles-list">
          <div class="empty-state">Loading roles...</div>
        </div>
        
        <div class="role-editor" id="role-editor" style="display: none;">
          <!-- Editor content will be rendered here -->
        </div>
      </div>
    </div>
  `,await Bi(e);const t=e.querySelector("#btn-create-role");t&&d(t,"click",()=>{pa=null,fp(e,null)})}async function Bi(e){const t=e.querySelector("#roles-list");if(t)try{if(ro=(await p.get("/api/role-templates")).data.roles||[],ro.length===0){t.innerHTML=`
        <div class="empty-state">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197"/>
          </svg>
          <p>No roles defined yet</p>
          <p style="font-size: 13px; opacity: 0.7;">Click "Create Role" to get started</p>
        </div>
      `;return}Ck(t,e)}catch(n){console.error("[RolesPanel] Failed to load roles:",n),t.innerHTML='<div class="empty-state">Failed to load roles</div>'}}function Ck(e,t){const n=Object.fromEntries(gp.map(a=>[a.id,a]));e.innerHTML=ro.map(a=>{const s=n[a.category||"custom"];return`
      <div class="role-card${pa?.id===a.id?" active":""}" data-id="${a.id}">
        <div class="role-card-header">
          <div class="role-color-dot" style="background: ${a.color||"#e11d48"}"></div>
          <div class="role-card-name">${is(a.display_name||a.name)}</div>
          <div class="role-card-badges">
            ${a.is_template?'<span class="role-badge template">Template</span>':""}
            ${a.is_system?'<span class="role-badge system">System</span>':""}
          </div>
        </div>
        <div class="role-card-category">${s?.icon||"‚ú®"} ${s?.name||"Custom"}</div>
        ${a.description?`<div class="role-card-desc">${is(a.description)}</div>`:""}
      </div>
    `}).join(""),e.querySelectorAll(".role-card").forEach(a=>{d(a,"click",()=>{const s=a.getAttribute("data-id"),o=ro.find(i=>i.id===s);o&&(pa=o,e.querySelectorAll(".role-card").forEach(i=>i.classList.remove("active")),a.classList.add("active"),fp(t,o))})})}function fp(e,t){const n=e.querySelector("#role-editor");if(!n)return;n.style.display="block";const a=!t;n.innerHTML=`
    <div class="role-editor-header">
      <h3>${a?"Create New Role":"Edit Role"}</h3>
    </div>
    
    <div class="role-editor-body">
      <div class="info-card">
        <h4>üí° How Role Templates Work</h4>
        <p>Role templates define job titles and context that helps the AI understand each person's perspective. When you assign a role to a team member or contact, the AI adapts its responses to be more relevant to their responsibilities.</p>
      </div>
      
      <form id="role-form">
        <div class="form-row">
          <div class="form-group" style="flex: 2">
            <label>Role Name *</label>
            <input type="text" id="role-name" required value="${is(t?.display_name||t?.name||"")}" placeholder="e.g., Project Manager, Senior Developer">
          </div>
          <div class="form-group" style="flex: 1">
            <label>Category</label>
            <select id="role-category">
              ${gp.map(s=>`
                <option value="${s.id}" ${t?.category===s.id?"selected":""}>${s.icon} ${s.name}</option>
              `).join("")}
            </select>
          </div>
          <div class="form-group" style="width: 80px">
            <label>Color</label>
            <input type="color" id="role-color" value="${t?.color||"#e11d48"}" style="height: 42px; padding: 4px;">
          </div>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="role-description" rows="2" placeholder="Brief description of this role's main responsibilities...">${is(t?.description||"")}</textarea>
          <div class="form-hint">A short summary shown in role lists and dropdowns.</div>
        </div>
        
        <div class="form-group">
          <label>Role Context (for AI)</label>
          <textarea id="role-context" rows="6" placeholder="Describe this role in detail for the AI:&#10;&#10;‚Ä¢ What are their main responsibilities?&#10;‚Ä¢ What decisions do they typically make?&#10;‚Ä¢ What information is most relevant to them?&#10;‚Ä¢ How should the AI adapt its tone and detail level?">${is(t?.role_context||"")}</textarea>
          <div class="form-hint">This context helps the AI provide more relevant and targeted responses when interacting with people in this role.</div>
          <div class="ai-enhance-section">
            <button type="button" class="ai-enhance-btn" id="btn-ai-enhance">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Enhance with AI
            </button>
            <span class="form-hint" style="margin: 0; padding-top: 10px;">Let AI generate or improve the role context based on the role name.</span>
          </div>
        </div>
        
        <div class="template-toggle">
          <input type="checkbox" id="is-template" ${t?.is_template!==!1?"checked":""}>
          <label for="is-template">Save as template (reusable across all projects)</label>
        </div>
        
        <div class="role-editor-actions">
          ${!a&&!t?.is_system?`
            <button type="button" class="btn btn-danger" id="btn-delete-role">Delete</button>
          `:""}
          <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
          <button type="submit" class="btn btn-primary">${a?"Create Role":"Save Changes"}</button>
        </div>
      </form>
    </div>
  `,Lk(e,t)}function Lk(e,t){const n=e.querySelector("#role-editor");if(!n)return;const a=n.querySelector("#btn-cancel");a&&d(a,"click",()=>{n.style.display="none",pa=null;const r=e.querySelector("#roles-list");r&&r.querySelectorAll(".role-card").forEach(c=>c.classList.remove("active"))});const s=n.querySelector("#btn-delete-role");s&&t&&d(s,"click",async()=>{if(confirm(`Are you sure you want to delete "${t.display_name||t.name}"?`))try{await p.delete(`/api/role-templates/${t.id}`),u.success("Role deleted"),n.style.display="none",pa=null,await Bi(e)}catch{u.error("Failed to delete role")}});const o=n.querySelector("#btn-ai-enhance");o&&d(o,"click",async()=>{const r=n.querySelector("#role-name"),c=n.querySelector("#role-context"),l=n.querySelector("#role-description"),m=r.value.trim();if(!m){u.error("Please enter a role name first");return}o.disabled=!0,o.innerHTML='<svg class="spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Enhancing...';try{const v=await p.post("/api/roles/generate",{title:m,currentContext:c.value});v.data.prompt&&(c.value=v.data.prompt),v.data.description&&!l.value&&(l.value=v.data.description),u.success("Role context enhanced with AI")}catch{u.error("Failed to enhance with AI")}finally{o.disabled=!1,o.innerHTML='<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Enhance with AI'}});const i=n.querySelector("#role-form");i&&d(i,"submit",async r=>{r.preventDefault();const c=n.querySelector("#role-name").value.trim(),l=n.querySelector("#role-category").value,m=n.querySelector("#role-color").value,v=n.querySelector("#role-description").value.trim(),g=n.querySelector("#role-context").value.trim(),f=n.querySelector("#is-template").checked,b={name:c.toLowerCase().replace(/\s+/g,"_"),display_name:c,description:v,role_context:g,category:l,color:m,is_template:f};try{t?(await p.put(`/api/role-templates/${t.id}`,b),u.success("Role updated")):(await p.post("/api/role-templates",b),u.success("Role created")),n.style.display="none",pa=null,await Bi(e)}catch{u.error("Failed to save role")}})}function is(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Mk=Object.freeze(Object.defineProperty({__proto__:null,renderRolesPanel:vp},Symbol.toStringTag,{value:"Module"}));let co=[],lo=[],$r=!1,rs=!1,ua=[],ht=null,hp=!1,Ii=!1,Wo=!1,cs="llm",Pt={},Ri=[],po=[],ls=[],Ni=!1,Un={enabled:!0,access:"admin_only"},ma=!1,bs=!1,Zn=[],ta=null,$t=[],Jt=null,Zt=!1,uo=!1;async function bp(){try{const e=await p.get("/api/system/config");if(Pt={},e.data?.llm_pertask){Pt.llm=[];const t=e.data.llm_pertask;t.text&&Pt.llm.push({key:"text_provider",value:t.text,category:"llm"}),t.vision&&Pt.llm.push({key:"vision_provider",value:t.vision,category:"llm"}),t.embeddings&&Pt.llm.push({key:"embeddings_provider",value:t.embeddings,category:"llm"})}e.data?.processing&&(Pt.processing=[{key:"processing",value:e.data.processing,category:"processing"}]),e.data?.graph&&(Pt.graph=[{key:"graph",value:e.data.graph,category:"graph"}]),console.log("[AdminPanel] Loaded system config:",Pt)}catch(e){console.warn("Failed to load system config:",e),Pt={}}}async function qk(){try{Wo=((await p.get("/api/secrets")).data?.secrets||[]).some(n=>n.name==="GRAPH_PASSWORD"),console.log("[AdminPanel] Graph password set:",Wo)}catch(e){console.warn("Failed to load secrets:",e),Wo=!1}}async function Tk(){const e=[{id:"openai",name:"OpenAI",enabled:!1,models:["gpt-4o","gpt-4-turbo","gpt-4","gpt-3.5-turbo"]},{id:"anthropic",name:"Anthropic (Claude)",enabled:!1,models:["claude-3-opus","claude-3-sonnet","claude-3-haiku"]},{id:"google",name:"Google AI (Gemini)",enabled:!1,models:["gemini-2.0-flash","gemini-pro","gemini-pro-vision"]},{id:"xai",name:"xAI (Grok)",enabled:!1,models:["grok-2","grok-beta"]},{id:"deepseek",name:"DeepSeek",enabled:!1,models:["deepseek-chat","deepseek-coder"]},{id:"kimi",name:"Kimi (Moonshot)",enabled:!1,models:["moonshot-v1-8k","moonshot-v1-32k"]},{id:"minimax",name:"MiniMax",enabled:!1,models:["abab5.5-chat","abab6-chat"]},{id:"ollama",name:"Ollama (Local)",enabled:!0,models:["llama2","mistral","codellama","qwen2.5"]}];try{const n=(await p.get("/api/llm/providers")).data?.providers,a=new Map(e.map(o=>[o.id,o])),s=Array.isArray(n)?n.map(o=>{if(typeof o=="string")return a.get(o)||{id:o,name:o,enabled:!1,models:[]};const i=o?.id||o?.provider||o?.key||o?.name,r=i&&a.get(i)||null;return{id:i||r?.id||"unknown",name:o?.name||r?.name||String(i||"Unknown"),enabled:!!(o?.enabled??o?.isConfigured??r?.enabled??!1),models:Array.isArray(o?.models)?o.models:r?.models||[],status:o?.status||void 0}}):[];Ri=s.length>0?s:e}catch(t){console.warn("Failed to load providers, using defaults:",t),Ri=e}}async function yp(){try{const e=await p.get("/api/system/audit?limit=50");po=Array.isArray(e.data?.logs)?e.data.logs:[]}catch(e){console.warn("Failed to load audit logs:",e),po=[]}}async function Fi(){try{const e=await p.get("/api/system/prompts");ls=Array.isArray(e.data?.prompts)?e.data.prompts:[]}catch(e){console.warn("Failed to load system prompts:",e),ls=[{id:"1",key:"document",name:"Document Extraction",description:"Extract information from PDFs and text files",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"2",key:"transcript",name:"Transcript Extraction",description:"Extract information from meeting transcripts",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"3",key:"vision",name:"Vision/Image Extraction",description:"Extract information from images and diagrams",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"4",key:"conversation",name:"Conversation Extraction",description:"Extract information from chat conversations",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"5",key:"email",name:"Email Extraction",description:"Extract information from emails",category:"extraction",prompt_template:"",uses_ontology:!0},{id:"6",key:"summary",name:"Content Summary",description:"Generate concise summaries",category:"analysis",prompt_template:"",uses_ontology:!1}]}}async function Bc(){rs=!0;try{const[e,t]=await Promise.all([p.get("/api/ontology/entities"),p.get("/api/ontology/relations")]);co=e.data?.entityTypes??[],lo=t.data?.relationTypes??[],$r=!0}catch(e){console.warn("Failed to load ontology:",e),co=[],lo=[]}finally{rs=!1}}async function Ic(){Ii=!0;try{const[e,t]=await Promise.all([p.get("/api/graph/list"),p.get("/api/graph/status").catch(()=>({data:{}}))]);ua=e.data?.graphs??[],e.data?.error&&(ua=[]),ht=t.data??null,hp=!0}catch(e){console.warn("Failed to load graph overview:",e),ua=[],ht=null}finally{Ii=!1}}async function vn(e,t,n){try{await p.post("/api/system/config",{key:e,value:t,category:n}),u.success("Configuration saved"),await bp()}catch{u.error("Failed to save configuration")}}async function Ak(e){try{const t=await p.post(`/api/llm/test/${e}`);if(t.data.ok){const n=t.data.models?` (${t.data.models} models)`:"";u.success(`${e} connection successful${n}`)}else u.error(t.data.error?.message||"Connection failed")}catch{u.error("Connection test failed")}}function St(e,t,n=""){const a=Pt[e]||[];if(e==="graph"){const o=a.find(i=>i.key==="graph");if(o?.value&&typeof o.value=="object")return o.value[t]??n}return a.find(o=>o.key===t)?.value??n}function Ek(){return[{id:"llm",label:"LLM Providers",icon:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"},{id:"models",label:"Model Metadata",icon:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"},{id:"queue",label:"LLM Queue",icon:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},{id:"graph",label:"Graph",icon:"M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"},{id:"ontology",label:"Ontology",icon:"M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"},{id:"prompts",label:"Prompts",icon:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"},{id:"processing",label:"Processing",icon:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"},{id:"storage",label:"Storage",icon:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"},{id:"team-analysis",label:"Team Analysis",icon:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"},{id:"billing",label:"Billing",icon:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"},{id:"audit",label:"Audit Log",icon:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"}].map(t=>`
    <button class="admin-nav-btn ${cs===t.id?"active":""}" data-section="${t.id}">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${t.icon}"/>
      </svg>
      <span>${t.label}</span>
    </button>
  `).join("")}function Rc(){const e=["text","vision","embeddings"];return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>LLM Provider Configuration</h3>
        <p>Configure AI providers for different task types</p>
      </div>

      <!-- Provider Status -->
      <div class="admin-card">
        <h4>Provider Health</h4>
        <div class="provider-grid">
          ${Ri.map(t=>`
            <div class="provider-card ${t.enabled?"enabled":"disabled"}">
              <div class="provider-header">
                <span class="provider-name">${t.name}</span>
                <span class="provider-status ${t.status||"unknown"}">${t.status||"unknown"}</span>
              </div>
              <div class="provider-models">${(t.models||[]).slice(0,3).join(", ")}</div>
              <div class="provider-actions">
                <button class="btn-sm" data-test-provider="${t.id}">Test</button>
                <label class="toggle-switch">
                  <input type="checkbox" ${t.enabled?"checked":""} data-toggle-provider="${t.id}">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          `).join("")}
        </div>
      </div>

      <!-- Task Configuration -->
      <div class="admin-card">
        <h4>Task-Specific AI Configuration</h4>
        <p class="text-muted">Configure which provider and model to use for each AI task. These settings apply globally to the platform and are persisted in Supabase.</p>
        
        ${e.map(t=>{const n=St("llm",t+"_provider",{provider:"",model:""}),a={text:"üí¨",vision:"üëÅÔ∏è",embeddings:"üîó"},s={text:"Text / Chat",vision:"Vision / Images",embeddings:"Embeddings"},o={text:"Document analysis, chat, briefings, Q&A, extraction",vision:"Image analysis, scanned documents, diagrams, charts",embeddings:"Semantic search, similarity matching, RAG"},i=a[t]||"‚öôÔ∏è",r=s[t]||t,c=o[t]||"",l=["openai","anthropic","google","deepseek","grok","kimi","minimax","ollama"],m={openai:"OpenAI",anthropic:"Anthropic (Claude)",google:"Google AI (Gemini)",deepseek:"DeepSeek",grok:"xAI (Grok)",kimi:"Kimi (Moonshot)",minimax:"MiniMax",ollama:"Ollama (Local)"};return'<div class="task-config-row" style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;" data-task-row="'+t+'"><div class="task-label" style="margin-bottom: 12px;"><span style="font-size: 20px; margin-right: 8px;">'+i+'</span><strong style="font-size: 16px;">'+r+'</strong><span class="text-muted" style="display: block; margin-top: 4px; margin-left: 32px; font-size: 13px;">'+c+'</span></div><div class="task-selects" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-left: 32px;"><div><label style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px; display: block;">Provider</label><select class="form-select provider-select" data-task="'+t+'" data-field="provider" style="width: 100%;"><option value=""'+(n.provider?"":" selected")+">-- Select Provider --</option>"+l.map(v=>'<option value="'+v+'"'+(n.provider===v?" selected":"")+">"+m[v]+"</option>").join("")+'</select></div><div><label style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px; display: block;">Model</label><select class="form-select model-select" data-task="'+t+'" data-field="model" style="width: 100%;"><option value="">-- Select Provider First --</option>'+(n.model?'<option value="'+n.model+'" selected>'+n.model+"</option>":"")+'</select><span class="model-loading" data-task="'+t+'" style="display: none; font-size: 11px; color: var(--primary); margin-top: 4px;">Loading models...</span></div></div><div class="model-status" data-task="'+t+'" style="margin-top: 8px; margin-left: 32px; font-size: 11px; color: var(--text-tertiary);"></div></div>'}).join("")}
        
        <div style="display: flex; gap: 12px; align-items: center; margin-top: 20px;">
          <button class="btn-primary" id="save-llm-config">Save LLM Configuration</button>
          <span class="text-muted" style="font-size: 12px;">‚ö†Ô∏è Changes apply immediately to all AI processing</span>
        </div>
      </div>

      <!-- API Keys - LLM Providers -->
      <div class="admin-card">
        <h4>LLM API Keys</h4>
        <p class="text-muted">System-level API keys (stored encrypted in Supabase)</p>
        
        <div class="api-keys-grid" id="api-keys-container">
          <div class="form-group" data-secret-name="OPENAI_API_KEY">
            <label>OpenAI <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="openai-key" name="llm_key_openai_${Date.now()}" placeholder="sk-proj-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="openai-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="CLAUDE_API_KEY">
            <label>Anthropic (Claude) <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="anthropic-key" name="llm_key_claude_${Date.now()}" placeholder="sk-ant-api03-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="anthropic-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="GOOGLE_API_KEY">
            <label>Google AI (Gemini) <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="google-key" name="llm_key_google_${Date.now()}" placeholder="AIza..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="google-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="XAI_API_KEY">
            <label>xAI (Grok) <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="xai-key" name="llm_key_xai_${Date.now()}" placeholder="xai-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="xai-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="DEEPSEEK_API_KEY">
            <label>DeepSeek <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="deepseek-key" name="llm_key_deepseek_${Date.now()}" placeholder="sk-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="deepseek-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="KIMI_API_KEY">
            <label>Kimi (Moonshot) <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="kimi-key" name="llm_key_kimi_${Date.now()}" placeholder="sk-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="kimi-key">Show</button>
            </div>
          </div>
          
          <div class="form-group" data-secret-name="MINIMAX_API_KEY">
            <label>MiniMax <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
            <div class="input-group">
              <input type="text" id="minimax-key" name="llm_key_minimax_${Date.now()}" placeholder="MINIMAX-..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
              <button class="btn-icon" data-toggle-visibility="minimax-key">Show</button>
            </div>
          </div>
        </div>
        
        <div id="api-keys-loading" style="text-align: center; padding: 10px; color: var(--text-tertiary);">Loading configured keys...</div>
        <button class="btn-primary mt-4" id="save-api-keys">Save LLM API Keys</button>
      </div>

      <!-- Service API Keys -->
      <div class="admin-card">
        <h4>Service API Keys</h4>
        <p class="text-muted">Keys for email, notifications and other services</p>
        
        <div class="form-group" data-secret-name="RESEND_API_KEY">
          <label>Resend API Key (Email Service) <span class="key-status" style="font-size: 11px; margin-left: 8px;"></span></label>
          <div class="input-group">
            <input type="text" id="resend-key" name="service_key_resend_${Date.now()}" placeholder="re_..." class="form-input api-key-input" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
            <button class="btn-icon" data-toggle-visibility="resend-key">Show</button>
          </div>
        </div>
        
        <button class="btn-primary mt-4" id="save-service-keys">Save Service Keys</button>
      </div>
    </div>
  `}function _k(){const e={enabled:St("graph","enabled",!1),graphName:St("graph","graphName","godmode")};return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Graph Database Configuration</h3>
        <p>Supabase Graph for knowledge graph and GraphRAG</p>
      </div>

      <div class="admin-card">
        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="graph-enabled" ${e.enabled?"checked":""}>
            <span>Enable Graph Database</span>
          </label>
        </div>

        <div class="form-group" style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin: 16px 0;">
          <p style="margin: 0; color: var(--text-secondary);">
            <strong>Provider:</strong> Supabase Graph (PostgreSQL-based)
          </p>
          <p style="margin: 8px 0 0; font-size: 13px; color: var(--text-muted);">
            Uses your existing Supabase connection. No additional configuration needed.
          </p>
        </div>

        <div class="form-group">
          <label>Graph Name</label>
          <input type="text" id="graph-name" value="${e.graphName}" class="form-input" placeholder="godmode">
        </div>

        <div class="btn-group mt-4">
          <button class="btn-primary" id="save-graph-config">Save Configuration</button>
          <button class="btn-secondary" id="test-graph-connection">Test Connection</button>
        </div>
      </div>

      <div class="admin-card" id="graph-overview-card">
        <h4>Graph overview</h4>
        <p class="text-muted">Current graph status. Enable and save configuration above first.</p>
        <div id="graph-overview-content">
          ${Ii?'<p class="text-muted">Loading...</p>':hp?ua.length===0&&!ht?.enabled?'<p class="text-muted">Graph not enabled or not connected. Enable and save configuration.</p><button class="btn-secondary mt-4" id="refresh-graph-overview">Refresh</button>':`
            ${ht?.enabled&&(ht.stats!=null||ht.graphName)?`
              <div class="graph-status-row" style="margin-bottom: 12px;">
                <strong>Current graph:</strong> ${ht.graphName??"‚Äî"}
                ${ht.stats?.nodes!==void 0?` ¬∑ Nodes: ${ht.stats.nodes}`:""}
                ${ht.stats?.relationships!==void 0?` ¬∑ Edges: ${ht.stats.relationships}`:""}
              </div>
            `:""}
            ${ua.length>0?`
              <table class="admin-table" style="width: 100%; margin-top: 8px;">
                <thead><tr><th>Graph name</th><th>Project</th></tr></thead>
                <tbody>
                  ${ua.map(t=>`<tr><td><code>${t.graphName}</code></td><td>${t.projectName??"‚Äî"}</td></tr>`).join("")}
                </tbody>
              </table>
            `:""}
            <div class="btn-group mt-4">
              <button class="btn-secondary" id="open-graph-tab">Open in Graph tab</button>
              <button class="btn-secondary" id="refresh-graph-overview">Refresh</button>
            </div>
          `:'<button class="btn-secondary" id="load-graph-overview">Load overview</button>'}
        </div>
      </div>
    </div>
  `}function jk(){return rs||!$r?`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Ontology</h3>
        <p>Entity types and relation types used by extraction and GraphRAG</p>
      </div>
      <div class="admin-card">
        <p class="text-muted">${rs?"Loading ontology...":"Click Load to fetch entity and relation types from the API."}</p>
        ${rs?"":'<button class="btn-primary" id="load-ontology">Load ontology</button>'}
      </div>
    </div>
    `:`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Ontology</h3>
        <p>Entity types and relation types used by extraction and GraphRAG</p>
      </div>

      <div class="admin-card">
        <h4>Entity types</h4>
        <p class="text-muted">Types of entities that can be extracted and stored in the graph.</p>
        ${co.length===0?'<p class="text-muted">No entity types returned.</p>':`
          <ul class="ontology-list">
            ${co.map(e=>`
              <li><code>${e.name}</code>
                ${e.sharedEntity?' <span class="badge badge-info">shared</span>':""}
                ${e.properties?.length?` ¬∑ properties: ${e.properties.join(", ")}`:""}
              </li>
            `).join("")}
          </ul>
        `}
      </div>

      <div class="admin-card">
        <h4>Relation types</h4>
        <p class="text-muted">Allowed relationships between entity types.</p>
        ${lo.length===0?'<p class="text-muted">No relation types returned.</p>':`
          <ul class="ontology-list">
            ${lo.map(e=>`
              <li><code>${e.name}</code>
                ${e.sourceType?` (${e.sourceType} ‚Üí ${e.targetType})`:""}
              </li>
            `).join("")}
          </ul>
        `}
      </div>

      <div class="btn-group mt-4">
        <button class="btn-secondary" id="reload-ontology">Reload ontology</button>
      </div>
    </div>
  `}function Dk(){const e=ls.filter(s=>s.category==="extraction"),t=ls.filter(s=>s.category==="analysis"),n=ls.filter(s=>s.category==="template"),a=s=>`
    <div class="admin-card prompt-card" data-prompt-id="${s.id}">
      <div class="prompt-header">
        <div>
          <h4>${s.name}</h4>
          <p class="text-muted">${s.description}</p>
        </div>
        <div class="prompt-badges">
          ${s.uses_ontology?'<span class="badge badge-info">Ontology-Aware</span>':""}
          <span class="badge badge-secondary">${s.key}</span>
        </div>
      </div>
      <textarea class="form-textarea prompt-editor" data-prompt-key="${s.key}" rows="12" 
                placeholder="Enter prompt template...

Available placeholders:
{{CONTENT}} - The document/transcript content
{{FILENAME}} - The file/document name
{{TODAY}} - Current date
{{ONTOLOGY_SECTION}} - Ontology context (if uses_ontology=true)
{{ROLE_CONTEXT}} - User role context
{{PROJECT_CONTEXT}} - Project context">${s.prompt_template||""}</textarea>
      <div class="prompt-actions">
        <button class="btn-sm btn-secondary" data-view-versions="${s.key}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12,6 12,12 16,14"/>
          </svg>
          Version History
        </button>
        <span class="prompt-status" id="status-${s.key}"></span>
      </div>
      <div class="version-history hidden" id="versions-${s.key}">
        <div class="version-list"></div>
      </div>
    </div>
  `;return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>AI Prompts Configuration</h3>
        <p>Customize ontology-aware prompts for AI extraction. All prompts support template variables.</p>
      </div>

      <div class="prompt-info admin-card">
        <h4>Template Variables</h4>
        <div class="variables-grid">
          <code>{{CONTENT}}</code> <span>Document/transcript content</span>
          <code>{{FILENAME}}</code> <span>File or document name</span>
          <code>{{TODAY}}</code> <span>Current date (YYYY-MM-DD)</span>
          <code>{{ONTOLOGY_SECTION}}</code> <span>Injected ontology context</span>
          <code>{{ROLE_CONTEXT}}</code> <span>User role context line</span>
          <code>{{PROJECT_CONTEXT}}</code> <span>Project context line</span>
          <code>{{CONTENT_LENGTH}}</code> <span>Content length in characters</span>
        </div>
      </div>

      <h4 class="section-subtitle">Extraction Prompts</h4>
      ${e.length>0?e.map(a).join(""):'<p class="text-muted">Run migration 031 to create default prompts</p>'}

      ${t.length>0?`
        <h4 class="section-subtitle">Analysis Prompts</h4>
        ${t.map(a).join("")}
      `:""}

      ${n.length>0?`
        <h4 class="section-subtitle">Template Sections</h4>
        ${n.map(a).join("")}
      `:""}

      <div class="btn-group mt-4">
        <button class="btn-primary" id="save-prompts">Save All Prompts</button>
        <button class="btn-secondary" id="reload-prompts">Reload from Database</button>
      </div>
    </div>
  `}function Pk(){const e=St("storage","google_drive_rootFolderId","")||"",t=!!St("storage","google_drive_enabled",!1);return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Storage</h3>
        <p>Configure platform-level storage backends</p>
      </div>

      <div class="admin-card">
        <h4>Google Drive (Platform Storage)</h4>
        <p class="text-muted">Configured once by superadmin. Projects will create their own folder structure inside the root folder.</p>

        <div class="form-group">
          <label style="display:block; margin-bottom: 8px;">Enable Google Drive storage</label>
          <button type="button" class="btn ${t?"btn-primary":"btn-secondary"}" id="gdrive-platform-enabled-btn" data-enabled="${t?"1":"0"}">
            ${t?"Enabled":"Disabled"}
          </button>
          <div class="text-muted" style="font-size: 12px; margin-top: 6px;">
            Click to toggle. Remember to press <b>Save</b> to persist.
          </div>
        </div>

        <div class="form-group">
          <label>Root Folder ID</label>
          <input type="text" id="gdrive-platform-root" class="form-input" placeholder="e.g. 1AbCDEFgHijK..." value="${ga(e)}">
          <div class="text-muted" style="font-size: 12px; margin-top: 6px;">
            Share this folder with the Service Account email (Editor).
          </div>
        </div>

        <div class="form-group">
          <label>Service Account JSON</label>
          <div id="gdrive-platform-cred-status" class="text-muted" style="font-size: 12px; margin-bottom: 8px;">Loading credential status...</div>
          <input type="file" id="gdrive-platform-json-file" accept="application/json,.json" class="form-input">
          <textarea id="gdrive-platform-json" class="form-input" placeholder="{ ... }" style="min-height: 140px; margin-top: 8px;"></textarea>
          <div class="text-muted" style="font-size: 12px; margin-top: 6px;">
            This credential is stored securely in Supabase as a system secret. It will not be shown again after saving.
          </div>
        </div>

        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-primary" id="gdrive-platform-save">Save</button>
          <button class="btn-secondary" id="gdrive-platform-test">Test</button>
          <button class="btn-secondary" id="gdrive-platform-bootstrap-all">Bootstrap all projects</button>
        </div>

        <div id="gdrive-platform-status" style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);"></div>
        <div id="gdrive-platform-projects" style="margin-top: 12px;"></div>
      </div>
    </div>
  `}function Hk(){const e={chunkSize:St("processing","chunk_size",1e3),chunkOverlap:St("processing","chunk_overlap",200),maxTokens:St("processing","max_tokens",4096),temperature:St("processing","temperature",.7),autoProcess:St("processing","auto_process",!0),parallelJobs:St("processing","parallel_jobs",3)};return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Document Processing Settings</h3>
        <p>Configure how documents are processed and analyzed</p>
      </div>

      <div class="admin-card">
        <h4>Chunking Settings</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Chunk Size (tokens)</label>
            <input type="number" id="proc-chunk-size" value="${e.chunkSize}" class="form-input" min="100" max="8000">
          </div>
          <div class="form-group">
            <label>Chunk Overlap (tokens)</label>
            <input type="number" id="proc-chunk-overlap" value="${e.chunkOverlap}" class="form-input" min="0" max="1000">
          </div>
        </div>
      </div>

      <div class="admin-card">
        <h4>Generation Settings</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Max Tokens</label>
            <input type="number" id="proc-max-tokens" value="${e.maxTokens}" class="form-input" min="256" max="32000">
          </div>
          <div class="form-group">
            <label>Temperature</label>
            <input type="number" id="proc-temperature" value="${e.temperature}" class="form-input" min="0" max="2" step="0.1">
          </div>
        </div>
      </div>

      <div class="admin-card">
        <h4>Job Settings</h4>
        
        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" id="proc-auto-process" ${e.autoProcess?"checked":""}>
            <span>Auto-process uploaded documents</span>
          </label>
        </div>
        
        <div class="form-group">
          <label>Parallel Jobs</label>
          <input type="number" id="proc-parallel-jobs" value="${e.parallelJobs}" class="form-input" min="1" max="10">
        </div>
      </div>

      <button class="btn-primary" id="save-processing">Save Processing Settings</button>
    </div>
  `}async function xp(){if(!P.getState().currentProject?.id){Un={enabled:!0,access:"admin_only"},ma=!0;return}bs=!0;try{const n=await p.get("/api/team-analysis/config");Un={enabled:n?.config?.enabled??!0,access:n?.config?.access??"admin_only"},ma=!0}catch(n){console.error("[AdminPanel] Error loading team analysis settings:",n),Un={enabled:!0,access:"admin_only"},ma=!0}finally{bs=!1}}async function zk(e,t){if(!P.getState().currentProject?.id){u.error("No project selected");return}try{await p.put("/api/team-analysis/config",{enabled:e,access:t}),Un={enabled:e,access:t},u.success("Team Analysis settings saved")}catch(s){console.error("[AdminPanel] Error saving team analysis settings:",s),u.error("Failed to save settings")}}function Bk(){const e=P.getState(),t=e.currentProject?.id,n=e.currentProject?.name||"Unknown";return t?bs||!ma?(!bs&&!ma&&xp(),`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Team Analysis Settings</h3>
        <p>Configure access control for behavioral analysis features</p>
      </div>
      
      <div class="admin-card">
        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
          <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
          <p>Loading settings...</p>
        </div>
      </div>
    </div>
    `):`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Team Analysis Settings</h3>
        <p>Configure access control for behavioral analysis features</p>
      </div>

      <!-- Current Project Info -->
      <div class="admin-card">
        <h4>Current Project</h4>
        <div style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
          <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
            ${n.charAt(0).toUpperCase()}
          </div>
          <div>
            <div style="font-weight: 500;">${n}</div>
            <div style="font-size: 12px; color: var(--text-tertiary);">ID: ${t}</div>
          </div>
        </div>
      </div>

      <!-- Feature Toggle -->
      <div class="admin-card">
        <h4>Feature Status</h4>
        <p class="text-muted" style="margin-bottom: 16px;">Enable or disable Team Analysis for this project</p>
        
        <div class="form-group">
          <label class="toggle-label" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
            <input type="checkbox" id="team-analysis-enabled" ${Un.enabled?"checked":""} style="width: 20px; height: 20px;">
            <div>
              <span style="font-weight: 500;">Enable Team Analysis</span>
              <p style="font-size: 12px; color: var(--text-tertiary); margin: 4px 0 0 0;">When enabled, users with access can analyze team member behavior from meeting transcripts</p>
            </div>
          </label>
        </div>
      </div>

      <!-- Access Control -->
      <div class="admin-card">
        <h4>Access Control</h4>
        <p class="text-muted" style="margin-bottom: 16px;">Define who can access Team Analysis features</p>
        
        <div class="form-group">
          <label style="font-weight: 500; display: block; margin-bottom: 8px;">Access Level</label>
          <select id="team-analysis-access" class="form-input" style="width: 100%; max-width: 400px;">
            <option value="admin_only" ${Un.access==="admin_only"?"selected":""}>Admins Only - Only project owner and admins can access</option>
            <option value="all" ${Un.access==="all"?"selected":""}>All Members - All project members can access</option>
          </select>
          <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
            <strong>Admins Only:</strong> Restricts access to sensitive behavioral analysis to project owner and administrators.<br>
            <strong>All Members:</strong> Allows all project collaborators to view and run team analysis.
          </p>
        </div>
      </div>

      <!-- Analysis Scope Info -->
      <div class="admin-card">
        <h4>How It Works</h4>
        <div style="display: grid; gap: 16px; margin-top: 12px;">
          <div style="display: flex; gap: 12px; align-items: start;">
            <div style="min-width: 32px; height: 32px; background: var(--info); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">1</div>
            <div>
              <div style="font-weight: 500;">Contact-Based Analysis</div>
              <div style="font-size: 13px; color: var(--text-secondary);">Analysis is performed on contacts defined in the project. Contacts can have aliases to match different name variations in transcripts.</div>
            </div>
          </div>
          <div style="display: flex; gap: 12px; align-items: start;">
            <div style="min-width: 32px; height: 32px; background: var(--info); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">2</div>
            <div>
              <div style="font-weight: 500;">Incremental Learning</div>
              <div style="font-size: 13px; color: var(--text-secondary);">Profiles are refined iteratively as more transcripts are processed, building evidence over time.</div>
            </div>
          </div>
          <div style="display: flex; gap: 12px; align-items: start;">
            <div style="min-width: 32px; height: 32px; background: var(--info); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">3</div>
            <div>
              <div style="font-weight: 500;">Privacy Consideration</div>
              <div style="font-size: 13px; color: var(--text-secondary);">Behavioral analysis may contain sensitive insights. Configure access carefully.</div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-primary" id="save-team-analysis" style="margin-top: 8px;">Save Team Analysis Settings</button>
    </div>
  `:`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Team Analysis Settings</h3>
        <p>Configure access control for behavioral analysis features</p>
      </div>
      
      <div class="admin-card">
        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="48" height="48" style="margin: 0 auto 16px; opacity: 0.5;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p>Please select a project to configure Team Analysis settings.</p>
        </div>
      </div>
    </div>
    `}function Ik(){return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>LLM Processing Queue</h3>
        <p>Monitor and control AI request processing - All requests are persisted in database</p>
      </div>

      <!-- Queue Status -->
      <div class="admin-card" id="queue-status-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>Queue Status</h4>
          <div style="display: flex; gap: 8px;">
            <span id="db-status-badge" class="badge" style="font-size: 11px;">DB: Checking...</span>
            <button class="btn-sm" id="refresh-queue-status">‚Üª Refresh</button>
          </div>
        </div>
        
        <div id="queue-status-content" style="text-align: center; padding: 20px; color: var(--text-tertiary);">
          Loading queue status...
        </div>
      </div>

      <!-- Queue Controls -->
      <div class="admin-card">
        <h4>Queue Controls</h4>
        <p class="text-muted">Control queue processing behavior</p>
        
        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
          <button class="btn-primary" id="queue-pause-btn">‚è∏ Pause Queue</button>
          <button class="btn-primary" id="queue-resume-btn">‚ñ∂ Resume Queue</button>
          <button class="btn-secondary" id="queue-clear-btn" style="background: var(--warning); color: white;">üóë Clear Queue</button>
        </div>
      </div>

      <!-- Statistics -->
      <div class="admin-card">
        <h4>Queue Statistics (Today)</h4>
        <div id="queue-stats-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 16px;">
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="stat-pending">-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Pending</div>
          </div>
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: var(--info);" id="stat-processing">-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Processing</div>
          </div>
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: var(--success);" id="stat-success">-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Completed</div>
          </div>
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: var(--error);" id="stat-failed">-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Failed</div>
          </div>
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: var(--warning);" id="stat-retry">-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Retry Pending</div>
          </div>
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold;" id="stat-avg-time">-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Avg Time (ms)</div>
          </div>
          <div class="stat-box" style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; color: var(--success);" id="stat-cost">$-</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">Cost Today</div>
          </div>
        </div>
      </div>

      <!-- Queue Items -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>Pending Items</h4>
          <span id="pending-count" class="text-muted">0 items</span>
        </div>
        
        <div id="queue-items-content" style="max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
            No items in queue
          </div>
        </div>
      </div>

      <!-- Failed Items (Retryable) -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>Failed Items</h4>
          <div style="display: flex; gap: 8px;">
            <button class="btn-sm btn-primary" id="retry-all-btn">‚Üª Retry All</button>
            <button class="btn-sm" id="refresh-failed-btn">‚Üª Refresh</button>
          </div>
        </div>
        
        <div id="failed-items-content" style="max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
            No failed items
          </div>
        </div>
      </div>

      <!-- Recent History -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>Recent Processing History</h4>
          <button class="btn-sm" id="refresh-queue-history">‚Üª Refresh</button>
        </div>
        
        <div id="queue-history-content" style="max-height: 400px; overflow-y: auto;">
          <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
            Loading history...
          </div>
        </div>
      </div>
    </div>
  `}async function Hn(){console.log("[AdminPanel] loadBillingData() starting...");try{console.log("[AdminPanel] Calling billing API...");const[e,t,n,a]=await Promise.all([kt.getAllProjectsBilling(),kt.getGlobalPricingConfig(),kt.getGlobalPricingTiers(),kt.getExchangeRateConfig()]);console.log("[AdminPanel] API responses:",{projects:e,config:t,tiersData:n,exchangeRate:a}),Zn=e,ta=t,$t=n.tiers,Jt=a,Zt=!0,console.log("[AdminPanel] Loaded billing data:",{projects:e.length,config:!!t,tiers:n.tiers.length,exchangeRate:a?.currentRate})}catch(e){console.error("[AdminPanel] Error loading billing data:",e),u.error("Failed to load billing data")}finally{uo=!1}}function Rk(){return uo&&!Zt?`
      <div class="admin-section">
        <div class="admin-section-header">
          <h3>Billing & Cost Control</h3>
          <p>Manage project balances, pricing, and cost limits</p>
        </div>
        <div class="admin-card" style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
          <p style="margin-top: 16px;">Loading billing data...</p>
        </div>
      </div>
    `:($t.length>0&&$t.map((e,t)=>{const n=t>0?$t[t-1].token_limit:0,a=Fn(n||0),s=e.token_limit?Fn(e.token_limit):"‚àû";return`${e.name||`Tier ${t+1}`}: ${a}-${s} tokens ‚Üí +${e.markup_percent}%`}).join("<br>"),`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Billing & Cost Control</h3>
        <p>Manage project balances, pricing, and cost limits</p>
      </div>

      <!-- Exchange Rate Configuration -->
      <div class="admin-card">
        <h4 style="margin-bottom: 16px;">Exchange Rate (USD to EUR)</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 16px;">
          <div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="exchange-rate-auto" ${Jt?.auto!==!1?"checked":""}>
                <span>Automatic rate from API</span>
              </label>
              <small class="text-muted">Fetches live USD/EUR rate daily</small>
            </div>
            
            <div class="form-group" id="manual-rate-group" style="${Jt?.auto!==!1?"display: none;":""}">
              <label>Manual Rate</label>
              <input type="number" id="exchange-rate-manual" class="form-input" 
                     value="${Jt?.manualRate??.92}" min="0.01" max="2" step="0.001">
            </div>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
            <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px;">Current Rate</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);" id="current-rate-display">
              ${Jt?.currentRate?.toFixed(4)??"0.9200"}
            </div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
              Source: <span id="rate-source">${Jt?.source??"default"}</span>
              ${Jt?.lastUpdated?`<br>Updated: ${new Date(Jt.lastUpdated).toLocaleString()}`:""}
            </div>
            <button class="btn-sm btn-secondary" id="refresh-rate-btn" style="margin-top: 12px;" ${Jt?.auto===!1?"disabled":""}>
              Refresh Rate
            </button>
          </div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
          <button class="btn-primary" id="save-exchange-rate-btn">Save Exchange Rate Settings</button>
        </div>
      </div>

      <!-- Global Pricing Configuration -->
      <div class="admin-card">
        <h4 style="margin-bottom: 16px;">Global Pricing Configuration</h4>
        
        <div class="admin-form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label>Fixed Markup (%)</label>
            <input type="number" id="global-markup-percent" class="form-input" 
                   value="${ta?.fixed_markup_percent??0}" min="0" max="500" step="0.1">
            <small class="text-muted">Applied when no tier matches</small>
          </div>
          
          <div class="form-group">
            <label>Period Type</label>
            <select id="global-period-type" class="form-input">
              <option value="monthly" ${ta?.period_type==="monthly"?"selected":""}>Monthly</option>
              <option value="weekly" ${ta?.period_type==="weekly"?"selected":""}>Weekly</option>
            </select>
            <small class="text-muted">Tier reset period</small>
          </div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 8px;">
          <button class="btn-primary" id="save-global-pricing-btn">Save Global Pricing</button>
        </div>
      </div>
      
      <!-- Pricing Tiers -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <h4>Pricing Tiers (Volume Discount)</h4>
            <p class="text-muted" style="font-size: 13px; margin-top: 4px;">
              Lower markup as projects consume more tokens per period
            </p>
          </div>
          <button class="btn-sm btn-primary" id="add-tier-btn">+ Add Tier</button>
        </div>
        
        <div id="pricing-tiers-list">
          ${$t.length>0?$t.map((e,t)=>`
            <div class="tier-row" data-tier-index="${t}" style="display: grid; grid-template-columns: 150px 150px 120px auto; gap: 12px; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
              <input type="text" class="form-input tier-name" placeholder="Tier Name" value="${e.name||`Tier ${t+1}`}">
              <input type="number" class="form-input tier-limit" placeholder="Token Limit" value="${e.token_limit||""}" min="0" ${e.token_limit===null?"disabled":""}>
              <div style="display: flex; align-items: center; gap: 4px;">
                <input type="number" class="form-input tier-markup" placeholder="Markup %" value="${e.markup_percent}" min="0" step="0.1" style="width: 80px;">
                <span>%</span>
              </div>
              <div style="display: flex; justify-content: flex-end; gap: 8px;">
                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                  <input type="checkbox" class="tier-unlimited" ${e.token_limit===null?"checked":""}>
                  Unlimited
                </label>
                <button class="btn-sm btn-danger remove-tier-btn" data-index="${t}">‚úï</button>
              </div>
            </div>
          `).join(""):`
            <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
              No tiers configured. Using fixed markup of ${ta?.fixed_markup_percent??0}% for all usage.
            </div>
          `}
        </div>
        
        ${$t.length>0?`
          <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px;">
            <button class="btn-primary" id="save-tiers-btn">Save Tiers</button>
          </div>
        `:""}
      </div>

      <!-- Projects Billing Overview -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <h4>Projects Billing</h4>
            <p class="text-muted" style="font-size: 13px; margin-top: 4px;">
              ${Zn.length} projects | 
              ${Zn.filter(e=>e.is_blocked).length} blocked | 
              ${Zn.filter(e=>e.unlimited_balance).length} unlimited
            </p>
          </div>
          <button class="btn-sm" id="refresh-billing-btn">‚Üª Refresh</button>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="data-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--bg-tertiary);">
                <th style="text-align: left; padding: 8px;">Project</th>
                <th style="text-align: right; padding: 8px;">Balance</th>
                <th style="text-align: center; padding: 8px;">Status</th>
                <th style="text-align: right; padding: 8px;">Tokens (Period)</th>
                <th style="text-align: right; padding: 8px;">Cost (Period)</th>
                <th style="text-align: center; padding: 8px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${Zn.length>0?Zn.map(e=>`
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 12px 8px;">
                    <div style="font-weight: 500;">${ga(e.project_name)}</div>
                    ${e.current_tier_name?`<small class="text-muted">Tier: ${e.current_tier_name}</small>`:""}
                  </td>
                  <td style="text-align: right; padding: 8px;">
                    ${e.unlimited_balance?'<span style="color: var(--success-color);">‚àû Unlimited</span>':gs(e.balance_eur)}
                  </td>
                  <td style="text-align: center; padding: 8px;">
                    ${e.is_blocked?'<span class="badge badge-danger">Blocked</span>':e.unlimited_balance?'<span class="badge badge-success">Unlimited</span>':'<span class="badge badge-primary">Active</span>'}
                  </td>
                  <td style="text-align: right; padding: 8px;">${Fn(e.tokens_this_period)}</td>
                  <td style="text-align: right; padding: 8px;">${gs(e.billable_cost_this_period)}</td>
                  <td style="text-align: center; padding: 8px;">
                    <div style="display: flex; justify-content: center; gap: 4px;">
                      <button class="btn-sm add-balance-btn" data-project-id="${e.project_id}" data-project-name="${ga(e.project_name)}" title="Add Balance">üí∞</button>
                      <button class="btn-sm toggle-unlimited-btn" data-project-id="${e.project_id}" data-unlimited="${e.unlimited_balance}" title="${e.unlimited_balance?"Disable Unlimited":"Enable Unlimited"}">
                        ${e.unlimited_balance?"üîì":"üîí"}
                      </button>
                    </div>
                  </td>
                </tr>
              `).join(""):`
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-tertiary);">
                    No projects found
                  </td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `)}function ga(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Nk(){return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>Configuration Audit Log</h3>
        <p>Track all configuration changes</p>
      </div>

      <div class="admin-card">
        <div class="audit-filters">
          <select id="audit-filter-table" class="form-select">
            <option value="">All Tables</option>
            <option value="system_config">System Config</option>
            <option value="project_config">Project Config</option>
            <option value="secrets">Secrets</option>
          </select>
          <button class="btn-secondary" id="refresh-audit">Refresh</button>
        </div>

        <div class="audit-log-list">
          ${po.length===0?`
            <div class="empty-state">
              <p>No audit logs found</p>
            </div>
          `:po.map(e=>`
            <div class="audit-log-item">
              <div class="audit-log-header">
                <span class="audit-operation ${String(e.operation||"").toLowerCase()}">${e.operation||""}</span>
                <span class="audit-table">${e.table_name}</span>
                <span class="audit-time">${new Date(e.changed_at).toLocaleString()}</span>
              </div>
              <div class="audit-log-details">
                <span class="audit-user">${e.changed_by_email||"System"}</span>
                ${e.new_values?`<pre class="audit-values">${JSON.stringify(e.new_values,null,2)}</pre>`:""}
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `}function Fk(){return`
    <div class="admin-section">
      <div class="admin-section-header">
        <h3>LLM Model Metadata</h3>
        <p>Manage model information, pricing, and capabilities from database</p>
      </div>
      
      <!-- Sync Controls -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>Sync Model Metadata</h4>
          <button class="btn btn-primary" id="sync-all-metadata-btn">
            ‚Üª Sync All Providers
          </button>
        </div>
        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
          Fetch the latest model list from each configured provider API and update the database with current models and capabilities.
          Pricing information is updated from known sources.
        </p>
        
        <div id="metadata-sync-status" style="margin-bottom: 16px;">
          <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
            Loading sync status...
          </div>
        </div>
        
        <div id="metadata-sync-result" style="display: none;"></div>
      </div>
      
      <!-- Provider Status -->
      <div class="admin-card">
        <h4 style="margin-bottom: 16px;">Provider Model Count</h4>
        <div id="provider-model-counts">
          <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
            Loading...
          </div>
        </div>
      </div>
      
      <!-- Model Browser -->
      <div class="admin-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>Browse Models</h4>
          <div style="display: flex; gap: 8px;">
            <select id="browse-provider-select" class="form-select" style="min-width: 150px;">
              <option value="">Select Provider</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="google">Google</option>
              <option value="grok">Grok (xAI)</option>
              <option value="deepseek">DeepSeek</option>
            </select>
            <button class="btn btn-secondary" id="browse-models-btn">Load Models</button>
          </div>
        </div>
        
        <div id="models-browser-content">
          <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            Select a provider to browse available models
          </div>
        </div>
      </div>
    </div>
  `}function Ok(){switch(cs){case"llm":return Rc();case"models":return Fk();case"graph":return _k();case"ontology":return jk();case"queue":return Ik();case"prompts":return Dk();case"processing":return Hk();case"storage":return Pk();case"team-analysis":return Bk();case"billing":return Rk();case"audit":return Nk();default:return Rc()}}function Uk(e){e.querySelectorAll(".admin-nav-btn").forEach(h=>{d(h,"click",async()=>{const y=h.getAttribute("data-section")||"llm";cs=y,y==="team-analysis"?(ma=!1,bs=!1,xe(e),await xp(),xe(e)):(y==="billing"&&!Zt&&!uo&&(uo=!0,xe(e),await Hn()),xe(e))})}),e.querySelectorAll("[data-toggle-visibility]").forEach(h=>{d(h,"click",()=>{const y=h.getAttribute("data-toggle-visibility");if(y){const k=e.querySelector(`#${y}`);k&&(k.type=k.type==="password"?"text":"password",h.textContent=k.type==="password"?"Show":"Hide")}})}),e.querySelectorAll("[data-test-provider]").forEach(h=>{d(h,"click",async()=>{const y=h.getAttribute("data-test-provider");y&&(h.textContent="Testing...",await Ak(y),h.textContent="Test")})});const t={};async function n(h,y){const k=e.querySelector(`select.model-select[data-task="${y}"]`),T=e.querySelector(`.model-loading[data-task="${y}"]`),j=e.querySelector(`.model-status[data-task="${y}"]`);if(!k||!h){k&&(k.innerHTML='<option value="">-- Select Provider First --</option>');return}T&&(T.style.display="inline"),k.disabled=!0;try{if(!t[h]){const V=await p.get(`/api/llm/models?provider=${h}`);t[h]={textModels:(V.data.textModels||[]).map(re=>re.id||re.name||"").filter(Boolean),visionModels:(V.data.visionModels||[]).map(re=>re.id||re.name||"").filter(Boolean),embeddingModels:(V.data.embeddingModels||[]).map(re=>re.id||re.name||"").filter(Boolean)}}let D=[];y==="text"?D=t[h].textModels:y==="vision"?D=t[h].visionModels:y==="embeddings"&&(D=t[h].embeddingModels);const G=k.value;k.innerHTML='<option value="">-- Select Model --</option>'+D.map(V=>`<option value="${V}"${V===G?" selected":""}>${V}</option>`).join(""),j&&(j.textContent=D.length>0?`${D.length} model(s) available`:"No models found for this task type. Check provider configuration.",j.style.color=D.length>0?"var(--success)":"var(--warning)")}catch(D){console.error(`Failed to load models for ${h}:`,D),k.innerHTML='<option value="">Error loading models</option>',j&&(j.textContent="Failed to load models. Check API key configuration.",j.style.color="var(--error)")}finally{T&&(T.style.display="none"),k.disabled=!1}}e.querySelectorAll("select.provider-select").forEach(h=>{d(h,"change",async()=>{const T=h.getAttribute("data-task"),j=h.value;T&&await n(j,T)});const y=h.getAttribute("data-task"),k=h.value;y&&k&&n(k,y)});const a=e.querySelector("#save-llm-config");a&&d(a,"click",async()=>{const h={};e.querySelectorAll("select[data-task]").forEach(y=>{const k=y.getAttribute("data-task"),T=y.getAttribute("data-field");h[k]||(h[k]={provider:"",model:""}),h[k][T]=y.value});try{for(const[y,k]of Object.entries(h))k.provider&&await vn(`${y}_provider`,k,"llm");u.success("LLM configuration saved to Supabase")}catch{u.error("Failed to save LLM configuration")}});async function s(){const h=e.querySelector("#api-keys-loading");try{const y=await p.get("/api/secrets");if(y.data?.success&&y.data.secrets)for(const k of y.data.secrets){const T=e.querySelector(`[data-secret-name="${k.name}"]`);if(T){const j=T.querySelector(".key-status"),D=T.querySelector("input");j&&k.masked_value&&(j.textContent="‚úì Configured",j.style.color="var(--success)",D&&(D.placeholder=k.masked_value))}}}catch(y){console.warn("Failed to load API keys status:",y)}finally{h&&(h.style.display="none")}}s();const o=e.querySelector("#save-api-keys");o&&d(o,"click",async()=>{const h=[{id:"openai-key",name:"OPENAI_API_KEY"},{id:"anthropic-key",name:"CLAUDE_API_KEY"},{id:"google-key",name:"GOOGLE_API_KEY"},{id:"xai-key",name:"XAI_API_KEY"},{id:"deepseek-key",name:"DEEPSEEK_API_KEY"},{id:"kimi-key",name:"KIMI_API_KEY"},{id:"minimax-key",name:"MINIMAX_API_KEY"}];try{let y=0;for(const k of h){const T=e.querySelector(`#${k.id}`)?.value;T&&T.trim()&&(await p.post("/api/secrets",{name:k.name,value:T.trim(),scope:"system"}),y++)}y>0?u.success(`${y} API key(s) saved securely`):u.info("No API keys to save")}catch{u.error("Failed to save API keys")}});const i=e.querySelector("#save-service-keys");i&&d(i,"click",async()=>{const h=e.querySelector("#resend-key")?.value;try{h&&h.trim()?(await p.post("/api/secrets",{name:"RESEND_API_KEY",value:h.trim(),scope:"system"}),u.success("Service API key saved securely")):u.info("No service keys to save")}catch{u.error("Failed to save service keys")}});const r=e.querySelector("#gdrive-platform-enabled-btn");r&&d(r,"click",()=>{const y=!(r.getAttribute("data-enabled")==="1");r.setAttribute("data-enabled",y?"1":"0"),r.className=`btn ${y?"btn-primary":"btn-secondary"}`,r.textContent=y?"Enabled":"Disabled"});async function c(){try{const h=await p.get("/api/system/google-drive"),y=e.querySelector("#gdrive-platform-cred-status");y&&(y.textContent=h.data.googleDrive?.hasCredential?"Credential: ‚úì configured":"Credential: not configured",y.style.color=h.data.googleDrive?.hasCredential?"var(--success)":"var(--warning)");const k=e.querySelector("#gdrive-platform-root");k&&!k.value&&(k.value=h.data.googleDrive?.rootFolderId||"");const T=e.querySelector("#gdrive-platform-enabled-btn");if(T){const re=!!h.data.googleDrive?.enabled;T.setAttribute("data-enabled",re?"1":"0"),T.className=`btn ${re?"btn-primary":"btn-secondary"}`,T.textContent=re?"Enabled":"Disabled"}const j=await p.get("/api/system/google-drive/status"),D=e.querySelector("#gdrive-platform-status");if(D){const re=j.data.projects;D.innerHTML=`
          <div><b>Projects:</b> ${re.bootstrapped}/${re.total} bootstrapped ${re.upToDate?'<span style="color: var(--success)">‚úì up to date</span>':`<span style="color: var(--warning)">(${re.missing} missing)</span>`}</div>
          <div style="margin-top: 6px;"><b>Last bootstrap:</b> ${j.data.lastBootstrap?.at?new Date(j.data.lastBootstrap.at).toLocaleString():"‚Äî"}</div>
        `}const G=await p.get("/api/system/google-drive/projects"),V=e.querySelector("#gdrive-platform-projects");if(V){const re=(G.data.projects||[]).slice(0,50);V.innerHTML=`
          <div style="font-weight: 600; margin-bottom: 8px;">Project folders (latest 50)</div>
          <div style="overflow:auto; border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 10px;">
            <table style="width:100%; border-collapse: collapse; font-size: 12px;">
              <thead>
                <tr style="background: var(--bg-secondary);">
                  <th style="text-align:left; padding: 8px;">Owner</th>
                  <th style="text-align:left; padding: 8px;">Project</th>
                  <th style="text-align:left; padding: 8px;">Folder ID</th>
                  <th style="text-align:left; padding: 8px;">Bootstrapped</th>
                </tr>
              </thead>
              <tbody>
                ${re.map($e=>`
                  <tr>
                    <td style="padding: 8px; border-top: 1px solid rgba(148, 163, 184, 0.15);">${ga($e.owner_username||"‚Äî")}</td>
                    <td style="padding: 8px; border-top: 1px solid rgba(148, 163, 184, 0.15);">${ga($e.name)}<div style="color: var(--text-tertiary);">${$e.id}</div></td>
                    <td style="padding: 8px; border-top: 1px solid rgba(148, 163, 184, 0.15); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${$e.projectFolderId?ga($e.projectFolderId):'<span style="color: var(--warning)">missing</span>'}</td>
                    <td style="padding: 8px; border-top: 1px solid rgba(148, 163, 184, 0.15);">${$e.bootstrappedAt?new Date($e.bootstrappedAt).toLocaleString():"‚Äî"}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `}}catch{}}c();const l=e.querySelector("#gdrive-platform-json-file");l&&d(l,"change",async()=>{const h=l.files?.[0],y=e.querySelector("#gdrive-platform-json");if(!(!h||!y))try{y.value=await h.text(),u.success("Google Drive JSON loaded")}catch{u.error("Failed to read JSON file")}});const m=e.querySelector("#gdrive-platform-save");m&&d(m,"click",async()=>{const h=e.querySelector("#gdrive-platform-enabled-btn")?.getAttribute("data-enabled")==="1",y=e.querySelector("#gdrive-platform-root")?.value?.trim(),k=e.querySelector("#gdrive-platform-json")?.value?.trim();if(h&&!y){u.error("Root Folder ID is required when enabled");return}try{await p.post("/api/system/google-drive",{enabled:h,rootFolderId:h?y:null,serviceAccountJson:k||void 0});const T=e.querySelector("#gdrive-platform-json");T&&(T.value=""),u.success("Google Drive platform settings saved"),await c()}catch{u.error("Failed to save Google Drive settings")}});const v=e.querySelector("#gdrive-platform-test");v&&d(v,"click",async()=>{try{await p.post("/api/system/google-drive/test",{}),u.success("Google Drive OK"),await c()}catch{u.error("Google Drive test failed")}});const g=e.querySelector("#gdrive-platform-bootstrap-all");g&&d(g,"click",async()=>{try{g.textContent="Bootstrapping...",await p.post("/api/system/google-drive/bootstrap-all",{}),u.success("Bootstrap completed"),await c()}catch{u.error("Bootstrap-all failed")}finally{g.textContent="Bootstrap all projects"}});async function f(){const h=e.querySelector("#queue-status-content"),y=e.querySelector("#queue-items-content"),k=e.querySelector("#pending-count"),T=e.querySelector("#db-status-badge");try{const D=(await p.get("/api/llm/queue/status")).data;if(T&&(D.database?(T.className="badge badge-success",T.textContent="DB: Connected"):(T.className="badge badge-warning",T.textContent="DB: Memory Only")),h){const Ce=D.isPaused?"var(--warning)":D.isProcessing?"var(--success)":"var(--text-tertiary)",_t=D.isPaused?"‚è∏ PAUSED":D.isProcessing?"üîÑ PROCESSING":"‚úì IDLE";h.innerHTML=`
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <div>
              <div style="font-size: 28px; font-weight: bold; color: ${Ce};">${_t}</div>
              <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Queue Status</div>
            </div>
            <div>
              <div style="font-size: 28px; font-weight: bold;">${D.queueLength}</div>
              <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Items in Queue</div>
            </div>
            <div>
              <div style="font-size: 28px; font-weight: bold; color: var(--primary);">${D.isProcessing?"1":"0"}</div>
              <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Processing Now</div>
            </div>
          </div>
          ${D.currentRequest?`
            <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: left;">
              <strong>Currently Processing:</strong> ${D.currentRequest.context||"Unknown"} 
              <span style="color: var(--text-tertiary);">(Priority: ${D.currentRequest.priority})</span>
              <span style="color: var(--text-tertiary); font-size: 11px; margin-left: 8px;">Started: ${new Date(D.currentRequest.startedAt).toLocaleTimeString()}</span>
            </div>
          `:""}
        `}if(y&&k){const Ce=D.pendingItems?.length||0;k.textContent=`${Ce} items`,Ce>0?y.innerHTML=`
            <table style="width: 100%; font-size: 13px;">
              <thead>
                <tr style="text-align: left; color: var(--text-tertiary); border-bottom: 1px solid var(--border);">
                  <th style="padding: 8px;">Context</th>
                  <th style="padding: 8px;">Priority</th>
                  <th style="padding: 8px;">Queued</th>
                  <th style="padding: 8px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${D.pendingItems.map(_t=>`
                  <tr style="border-bottom: 1px solid var(--border-light);">
                    <td style="padding: 8px;">${_t.context||"Unknown"}</td>
                    <td style="padding: 8px;"><span class="badge badge-${_t.priority}">${_t.priority}</span></td>
                    <td style="padding: 8px;">${new Date(_t.queuedAt).toLocaleTimeString()}</td>
                    <td style="padding: 8px;"><button class="btn-sm btn-danger" data-cancel-item="${_t.id}">Cancel</button></td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:y.innerHTML='<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">No items in queue</div>'}const G=D.database,V=e.querySelector("#stat-pending"),re=e.querySelector("#stat-processing"),$e=e.querySelector("#stat-success"),_e=e.querySelector("#stat-failed"),je=e.querySelector("#stat-retry"),be=e.querySelector("#stat-avg-time"),Te=e.querySelector("#stat-cost");V&&(V.textContent=String(G?.pendingCount||D.queueLength||0)),re&&(re.textContent=String(G?.processingCount||(D.isProcessing?1:0))),$e&&($e.textContent=String(G?.completedToday||D.stats?.successful||0)),_e&&(_e.textContent=String(G?.failedToday||D.stats?.failed||0)),je&&(je.textContent=String(G?.retryPendingCount||0)),be&&(be.textContent=String(Math.round(G?.avgProcessingTimeMs||D.stats?.avgProcessingTime||0))),Te&&(Te.textContent=`$${(G?.totalCostTodayUsd||0).toFixed(4)}`)}catch(j){console.error("Failed to load queue status:",j),h&&(h.innerHTML='<div style="color: var(--error);">Failed to load queue status</div>')}}async function b(){const h=e.querySelector("#queue-history-content");try{const k=(await p.get("/api/llm/queue/history?limit=50")).data?.history||[];h&&(k.length>0?h.innerHTML=`
            <table style="width: 100%; font-size: 12px;">
              <thead>
                <tr style="text-align: left; color: var(--text-tertiary); border-bottom: 1px solid var(--border);">
                  <th style="padding: 6px;">Context</th>
                  <th style="padding: 6px;">Provider/Model</th>
                  <th style="padding: 6px;">Status</th>
                  <th style="padding: 6px;">Tokens</th>
                  <th style="padding: 6px;">Time</th>
                  <th style="padding: 6px;">Completed</th>
                  <th style="padding: 6px;">Details</th>
                </tr>
              </thead>
              <tbody>
                ${k.map(T=>`
                  <tr style="border-bottom: 1px solid var(--border-light);">
                    <td style="padding: 6px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${T.context||""}">${T.context||"Unknown"}</td>
                    <td style="padding: 6px; font-size: 11px; color: var(--text-secondary);">${T.provider||"-"}/${T.model||"-"}</td>
                    <td style="padding: 6px;">
                      <span style="color: ${T.status==="completed"?"var(--success)":"var(--error)"};">
                        ${T.status==="completed"?"‚úì":"‚úó"}
                      </span>
                      ${T.error?`<span style="font-size: 10px; color: var(--error);" title="${T.error}">Error</span>`:""}
                    </td>
                    <td style="padding: 6px; font-size: 11px;">${T.inputTokens||"-"}/${T.outputTokens||"-"}</td>
                    <td style="padding: 6px;">${T.processingTime||"-"}ms</td>
                    <td style="padding: 6px; font-size: 11px;">${T.completedAt?new Date(T.completedAt).toLocaleString():"-"}</td>
                    <td style="padding: 6px;"><button class="btn-sm" data-view-request="${T.id}">View</button></td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:h.innerHTML='<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">No processing history yet</div>')}catch(y){console.error("Failed to load queue history:",y),h&&(h.innerHTML='<div style="color: var(--error);">Failed to load history</div>')}}async function w(h){try{const y=await p.get(`/api/llm/queue/${h}`);if(!y.data.success||!y.data.request){u.error("Request not found");return}const k=y.data.request,T=Ce=>Ce?Ce.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):"",j=Ce=>{const _t=JSON.stringify(Ce,null,2);return T(_t).replace(/"([^"]+)":/g,'<span style="color: #0550ae;">"$1"</span>:').replace(/: "([^"]*)"/g,': <span style="color: #0a3069;">"$1"</span>').replace(/: (\d+)/g,': <span style="color: #0550ae;">$1</span>').replace(/: (true|false|null)/g,': <span style="color: #cf222e;">$1</span>')},D=Ce=>Ce?T(Ce).replace(/\\n/g,`
`).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/^(#{1,3})\s*(.+)$/gm,'<span style="color: var(--accent); font-weight: 600;">$2</span>').replace(/^[-‚Ä¢]\s*(.+)$/gm,"  ‚Ä¢ $1").replace(/---+/g,'<hr style="border: none; border-top: 1px solid var(--border); margin: 8px 0;">'):'<span style="color: var(--text-tertiary);">(No content)</span>',V=(Ce=>({completed:{color:"var(--success)",icon:"‚úì",bg:"rgba(34, 197, 94, 0.1)"},failed:{color:"var(--error)",icon:"‚úó",bg:"rgba(239, 68, 68, 0.1)"},processing:{color:"var(--warning)",icon:"‚ü≥",bg:"rgba(234, 179, 8, 0.1)"},pending:{color:"var(--text-secondary)",icon:"‚óã",bg:"var(--bg-tertiary)"},retry_pending:{color:"var(--warning)",icon:"‚Üª",bg:"rgba(234, 179, 8, 0.1)"},cancelled:{color:"var(--text-tertiary)",icon:"‚äò",bg:"var(--bg-tertiary)"}})[Ce]||{color:"var(--text-primary)",icon:"?",bg:"var(--bg-secondary)"})(k.status),re=k.input_data||{},$e=re.messages,_e=re.prompt||$e?.[0]?.content||"",je=document.getElementById("llm-request-details-modal");je&&je.remove();const be=document.createElement("div");be.id="llm-request-details-modal",be.className="modal open",be.style.cssText="display: flex !important; z-index: 999999 !important;",be.innerHTML=`
        <div class="modal-content" style="max-width: 900px; width: 95%;">
          <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 24px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: ${V.bg}; border-radius: 8px; color: ${V.color};">${V.icon}</span>
              <div>
                <h3 style="margin: 0;">LLM Request Details</h3>
                <span style="font-size: 12px; color: var(--text-tertiary);">ID: ${k.id}</span>
              </div>
            </div>
            <button class="modal-close">&times;</button>
          </div>
          
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Status Bar -->
            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
              <div style="flex: 1; min-width: 120px;">
                <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Context</div>
                <div style="font-weight: 600; font-size: 16px; color: var(--accent);">${k.context||"Unknown"}</div>
              </div>
              <div style="flex: 1; min-width: 120px;">
                <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Provider</div>
                <div style="font-weight: 600; font-size: 16px;">${k.provider||"-"}</div>
              </div>
              <div style="flex: 1; min-width: 120px;">
                <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Model</div>
                <div style="font-weight: 600; font-size: 14px; font-family: monospace;">${k.model||"-"}</div>
              </div>
              <div style="flex: 1; min-width: 100px;">
                <div style="font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Status</div>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: ${V.bg}; border-radius: 12px; color: ${V.color}; font-weight: 600; font-size: 13px;">
                  ${V.icon} ${k.status}
                </div>
              </div>
            </div>
            
            <!-- Metrics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px;">
              <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${k.input_tokens?.toLocaleString()||"-"}</div>
                <div style="font-size: 11px; color: var(--text-tertiary);">Input Tokens</div>
              </div>
              <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${k.output_tokens?.toLocaleString()||"-"}</div>
                <div style="font-size: 11px; color: var(--text-tertiary);">Output Tokens</div>
              </div>
              <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${k.processing_time_ms?`${(k.processing_time_ms/1e3).toFixed(1)}s`:"-"}</div>
                <div style="font-size: 11px; color: var(--text-tertiary);">Duration</div>
              </div>
              <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700; color: ${k.estimated_cost_usd?"var(--success)":"var(--text-tertiary)"};">$${k.estimated_cost_usd?.toFixed(4)||"-"}</div>
                <div style="font-size: 11px; color: var(--text-tertiary);">Est. Cost</div>
              </div>
            </div>
            
            <!-- Timeline -->
            <div style="display: flex; gap: 24px; margin-bottom: 24px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 12px; flex-wrap: wrap;">
              <div><strong style="color: var(--text-tertiary);">Queued:</strong> ${k.queued_at?new Date(k.queued_at).toLocaleString():"-"}</div>
              <div><strong style="color: var(--text-tertiary);">Started:</strong> ${k.started_at?new Date(k.started_at).toLocaleString():"-"}</div>
              <div><strong style="color: var(--text-tertiary);">Completed:</strong> ${k.completed_at?new Date(k.completed_at).toLocaleString():"-"}</div>
            </div>
            
            ${k.last_error?`
              <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="color: var(--error); font-size: 18px;">‚ö†</span>
                  <strong style="color: var(--error);">Error</strong>
                  <span style="font-size: 12px; color: var(--text-tertiary);">(Attempt ${k.attempt_count}/${k.max_attempts})</span>
                </div>
                <div style="font-size: 13px; color: var(--error); font-family: monospace; white-space: pre-wrap;">${T(k.last_error)}</div>
              </div>
            `:""}
            
            <!-- Prompt / Input -->
            <div style="margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 16px;">üìù</span> Prompt / Input
                </h4>
                <button class="btn btn-sm btn-secondary" id="copy-input-btn">Copy</button>
              </div>
              <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; max-height: 250px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap; font-family: inherit;" id="input-display">${D(_e)}</div>
            </div>
            
            <!-- Output -->
            <div style="margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 16px;">ü§ñ</span> Response
                </h4>
                <button class="btn btn-sm btn-secondary" id="copy-output-btn">Copy</button>
              </div>
              <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 16px; max-height: 350px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap;" id="output-display">${D(k.output_text)}</div>
            </div>
            
            <!-- Raw Data Toggle -->
            <details style="margin-bottom: 16px;">
              <summary style="cursor: pointer; font-weight: 600; padding: 12px; background: var(--bg-secondary); border-radius: 8px; user-select: none;">
                <span style="margin-left: 8px;">üìã Raw Data (JSON)</span>
              </summary>
              <div style="margin-top: 12px;">
                <div style="margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">Input Data</span>
                    <button class="btn btn-xs btn-secondary" id="copy-input-json-btn">Copy JSON</button>
                  </div>
                  <pre style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 11px; max-height: 200px; overflow-y: auto; margin: 0;">${j(k.input_data)}</pre>
                </div>
                ${k.output_data?`
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                      <span style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">Output Data</span>
                      <button class="btn btn-xs btn-secondary" id="copy-output-json-btn">Copy JSON</button>
                    </div>
                    <pre style="background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 11px; max-height: 200px; overflow-y: auto; margin: 0;">${j(k.output_data)}</pre>
                  </div>
                `:""}
              </div>
            </details>
          </div>
          
          <div class="modal-footer">
            <button class="btn btn-secondary modal-close-btn">Close</button>
          </div>
        </div>
      `,document.body.appendChild(be),be.querySelector(".modal-close")?.addEventListener("click",()=>be.remove()),be.querySelector(".modal-close-btn")?.addEventListener("click",()=>be.remove()),be.addEventListener("click",Ce=>{Ce.target===be&&be.remove()});const Te=Ce=>{Ce.key==="Escape"&&(be.remove(),document.removeEventListener("keydown",Te))};document.addEventListener("keydown",Te),be.querySelector("#copy-input-btn")?.addEventListener("click",()=>{const Ce=_e||JSON.stringify(k.input_data,null,2);navigator.clipboard.writeText(Ce),u.success("Input copied to clipboard")}),be.querySelector("#copy-output-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(k.output_text||""),u.success("Response copied to clipboard")}),be.querySelector("#copy-input-json-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(JSON.stringify(k.input_data,null,2)),u.success("Input JSON copied to clipboard")}),be.querySelector("#copy-output-json-btn")?.addEventListener("click",()=>{navigator.clipboard.writeText(JSON.stringify(k.output_data,null,2)),u.success("Output JSON copied to clipboard")})}catch(y){console.error("Failed to load request details:",y),u.error("Failed to load request details")}}async function $(){const h=e.querySelector("#failed-items-content");try{const k=(await p.get("/api/llm/queue/retryable?limit=20")).data?.items||[];h&&(k.length>0?h.innerHTML=`
            <table style="width: 100%; font-size: 12px;">
              <thead>
                <tr style="text-align: left; color: var(--text-tertiary); border-bottom: 1px solid var(--border);">
                  <th style="padding: 6px;">Context</th>
                  <th style="padding: 6px;">Provider</th>
                  <th style="padding: 6px;">Attempts</th>
                  <th style="padding: 6px;">Error</th>
                  <th style="padding: 6px;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${k.map(T=>`
                  <tr style="border-bottom: 1px solid var(--border-light);">
                    <td style="padding: 6px;">${T.context||"Unknown"}</td>
                    <td style="padding: 6px; font-size: 11px;">${T.provider||"-"}</td>
                    <td style="padding: 6px;">${T.attemptCount}/${T.maxAttempts}</td>
                    <td style="padding: 6px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--error);" title="${T.error||""}">${T.error||"-"}</td>
                    <td style="padding: 6px;">
                      <button class="btn-sm btn-primary" data-retry-item="${T.id}" ${T.canRetry?"":"disabled"}>‚Üª Retry</button>
                      <button class="btn-sm" data-retry-reset-item="${T.id}" style="margin-left: 4px;">Reset & Retry</button>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:h.innerHTML='<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">No failed items</div>')}catch(y){console.error("Failed to load failed items:",y),h&&(h.innerHTML='<div style="color: var(--error);">Failed to load failed items</div>')}}const M=e.querySelector("#refresh-queue-status");M&&d(M,"click",f);const q=e.querySelector("#refresh-queue-history");q&&d(q,"click",b);const C=e.querySelector("#refresh-failed-btn");C&&d(C,"click",$);const S=e.querySelector("#retry-all-btn");S&&d(S,"click",async()=>{try{const y=((await p.get("/api/llm/queue/retryable?limit=50")).data?.items||[]).filter(T=>T.canRetry);let k=0;for(const T of y)try{await p.post(`/api/llm/queue/${T.id}/retry`,{resetAttempts:!1}),k++}catch{}u.success(`Queued ${k} items for retry`),f(),$()}catch{u.error("Failed to retry items")}});const L=e.querySelector("#queue-pause-btn");L&&d(L,"click",async()=>{try{await p.post("/api/llm/queue/pause"),u.success("Queue paused"),f()}catch{u.error("Failed to pause queue")}});const R=e.querySelector("#queue-resume-btn");R&&d(R,"click",async()=>{try{await p.post("/api/llm/queue/resume"),u.success("Queue resumed"),f()}catch{u.error("Failed to resume queue")}});const Z=e.querySelector("#queue-clear-btn");Z&&d(Z,"click",async()=>{if(confirm("Are you sure you want to clear all pending items from the queue?"))try{await p.post("/api/llm/queue/clear"),u.success("Queue cleared"),f()}catch{u.error("Failed to clear queue")}}),e.addEventListener("click",async h=>{const y=h.target,k=y.closest("[data-view-request]");if(k){h.preventDefault(),h.stopPropagation();const G=k.getAttribute("data-view-request");G&&w(G);return}const T=y.closest("[data-cancel-item]");if(T){const G=T.getAttribute("data-cancel-item");if(G){try{await p.delete(`/api/llm/queue/${G}`),u.success("Item cancelled"),f()}catch{u.error("Failed to cancel item")}return}}const j=y.closest("[data-retry-item]");if(j){const G=j.getAttribute("data-retry-item");if(G){try{await p.post(`/api/llm/queue/${G}/retry`,{resetAttempts:!1}),u.success("Item queued for retry"),f(),$()}catch{u.error("Failed to retry item")}return}}const D=y.closest("[data-retry-reset-item]");if(D){const G=D.getAttribute("data-retry-reset-item");if(G){try{await p.post(`/api/llm/queue/${G}/retry`,{resetAttempts:!0}),u.success("Item queued for retry (attempts reset)"),f(),$()}catch{u.error("Failed to retry item")}return}}});async function ee(){const h=e.querySelector("#metadata-sync-status"),y=e.querySelector("#provider-model-counts");try{const T=(await p.get("/api/llm/metadata/status")).data?.providers||[];if(h&&(T.length>0?h.innerHTML=`
            <table style="width: 100%; font-size: 13px;">
              <thead>
                <tr style="text-align: left; color: var(--text-tertiary); border-bottom: 1px solid var(--border);">
                  <th style="padding: 8px;">Provider</th>
                  <th style="padding: 8px;">Text</th>
                  <th style="padding: 8px;">Vision</th>
                  <th style="padding: 8px;">Embeddings</th>
                  <th style="padding: 8px;">Total</th>
                  <th style="padding: 8px;">Last Synced</th>
                </tr>
              </thead>
              <tbody>
                ${T.map(j=>`
                  <tr style="border-bottom: 1px solid var(--border-light);">
                    <td style="padding: 8px; font-weight: 600; text-transform: capitalize;">${j.provider}</td>
                    <td style="padding: 8px;">${j.text_models||0}</td>
                    <td style="padding: 8px;">${j.vision_models||0}</td>
                    <td style="padding: 8px;">${j.embedding_models||0}</td>
                    <td style="padding: 8px; font-weight: 600;">${j.active_models||0}</td>
                    <td style="padding: 8px; font-size: 11px; color: var(--text-tertiary);">${j.last_synced?new Date(j.last_synced).toLocaleString():"Never"}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          `:h.innerHTML='<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">No metadata found. Click "Sync All Providers" to fetch model data.</div>'),y&&T.length>0){const j=T.reduce((D,G)=>D+(G.active_models||0),0);y.innerHTML=`
          <div style="display: flex; flex-wrap: wrap; gap: 12px;">
            ${T.map(D=>`
              <div style="flex: 1; min-width: 120px; text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                <div style="font-size: 24px; font-weight: 700;">${D.active_models||0}</div>
                <div style="font-size: 12px; color: var(--text-tertiary); text-transform: capitalize;">${D.provider}</div>
              </div>
            `).join("")}
            <div style="flex: 1; min-width: 120px; text-align: center; padding: 16px; background: var(--accent); border-radius: 8px; color: white;">
              <div style="font-size: 24px; font-weight: 700;">${j}</div>
              <div style="font-size: 12px; opacity: 0.9;">Total Models</div>
            </div>
          </div>
        `}}catch(k){console.error("Failed to load metadata status:",k),h&&(h.innerHTML='<div style="color: var(--error);">Failed to load metadata status</div>')}}const le=e.querySelector("#sync-all-metadata-btn");le&&d(le,"click",async()=>{const h=e.querySelector("#metadata-sync-result");le.disabled=!0,le.textContent="Syncing...";try{const y=await p.post("/api/llm/metadata/sync",{});if(h){h.style.display="block";const k=y.data?.providers||{},T=Object.entries(k);h.innerHTML=`
            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
              <div style="font-weight: 600; margin-bottom: 12px;">Sync Results</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${T.map(([j,D])=>`
                  <div style="padding: 8px 12px; background: ${D.status==="success"?"rgba(34, 197, 94, 0.1)":D.status==="skipped"?"var(--bg-secondary)":"rgba(239, 68, 68, 0.1)"}; border-radius: 6px; font-size: 12px;">
                    <span style="font-weight: 600; text-transform: capitalize;">${j}</span>
                    ${D.status==="success"?`<span style="color: var(--success);"> ‚úì ${D.synced} models</span>`:""}
                    ${D.status==="skipped"?`<span style="color: var(--text-tertiary);"> - ${D.reason}</span>`:""}
                    ${D.status==="error"?`<span style="color: var(--error);"> ‚úó ${D.error}</span>`:""}
                  </div>
                `).join("")}
              </div>
              <div style="margin-top: 12px; font-size: 13px; color: var(--success);">
                Total: ${y.data?.totalModels||0} models synced
              </div>
            </div>
          `}u.success(`Synced ${y.data?.totalModels||0} models`),ee()}catch{u.error("Failed to sync metadata"),h&&(h.style.display="block",h.innerHTML='<div style="color: var(--error);">Sync failed. Check console for details.</div>')}finally{le.disabled=!1,le.textContent="‚Üª Sync All Providers"}});const ae=e.querySelector("#browse-models-btn");ae&&d(ae,"click",async()=>{const h=e.querySelector("#browse-provider-select"),y=e.querySelector("#models-browser-content"),k=h?.value;if(!k){u.info("Please select a provider");return}y&&(y.innerHTML='<div style="text-align: center; padding: 20px;">Loading models...</div>');try{const T=await p.get(`/api/llm/metadata/${k}`),{textModels:j=[],visionModels:D=[],embeddingModels:G=[]}=T.data||{};y&&(j.length===0&&G.length===0?y.innerHTML='<div style="text-align: center; padding: 40px; color: var(--text-tertiary);">No models found for this provider. Try syncing first.</div>':y.innerHTML=`
              <div style="display: grid; gap: 16px;">
                ${j.length>0?`
                  <div>
                    <h5 style="margin-bottom: 8px; color: var(--text-secondary);">Text Models (${j.length})</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px;">
                      ${j.map(V=>`
                        <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 12px;">
                          <div style="font-weight: 600; margin-bottom: 4px;">${V.display_name||V.model_id}</div>
                          <div style="color: var(--text-tertiary); font-family: monospace; font-size: 11px;">${V.model_id}</div>
                          <div style="margin-top: 8px; display: flex; gap: 12px; color: var(--text-secondary);">
                            <span title="Context Window">üìè ${V.context_tokens?(V.context_tokens/1e3).toFixed(0)+"K":"-"}</span>
                            <span title="Input Price">üí∞ $${V.price_input?.toFixed(2)||"-"}/1M</span>
                            <span title="Output Price">üíµ $${V.price_output?.toFixed(2)||"-"}/1M</span>
                          </div>
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""}
                ${G.length>0?`
                  <div>
                    <h5 style="margin-bottom: 8px; color: var(--text-secondary);">Embedding Models (${G.length})</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      ${G.map(V=>`
                        <div style="padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px;">
                          ${V.display_name||V.model_id}
                        </div>
                      `).join("")}
                    </div>
                  </div>
                `:""}
              </div>
            `)}catch{y&&(y.innerHTML='<div style="color: var(--error);">Failed to load models</div>')}}),cs==="models"&&ee(),cs==="queue"&&(f(),b(),$());const X=e.querySelector("#save-graph-config");X&&d(X,"click",async()=>{const h={enabled:e.querySelector("#graph-enabled")?.checked??!0,provider:"supabase",graphName:e.querySelector("#graph-name")?.value||"godmode"};try{await vn("graph",h,"graph"),u.success("Graph configuration saved!"),console.log("[AdminPanel] Saved graph config:",h)}catch(y){console.error("[AdminPanel] Error saving graph config:",y),u.error("Failed to save graph configuration")}});const ie=e.querySelector("#test-graph-connection");ie&&d(ie,"click",async()=>{ie.textContent="Testing...";try{const h={provider:"supabase",graphName:e.querySelector("#graph-name")?.value||"godmode"};console.log("[AdminPanel] Testing Supabase graph connection");const y=await p.post("/api/graph/test",h);y.data.success||y.data.ok?u.success("Supabase graph connection successful!"):u.error(y.data.message||y.data.error||"Connection failed")}catch(h){console.error("[AdminPanel] Graph test error:",h),u.error("Graph connection test failed")}ie.textContent="Test Connection"});const U=e.querySelector("#load-graph-overview");U&&d(U,"click",async()=>{await Ic(),xe(e)});const Q=e.querySelector("#refresh-graph-overview");Q&&d(Q,"click",async()=>{await Ic(),xe(e),u.info("Graph overview refreshed")});const te=e.querySelector("#open-graph-tab");te&&d(te,"click",()=>{document.querySelector('.nav-item[data-tab="graph"]')?.dispatchEvent(new MouseEvent("click",{bubbles:!0}))});const de=e.querySelector("#load-ontology");de&&d(de,"click",async()=>{await Bc(),xe(e)});const qe=e.querySelector("#reload-ontology");qe&&d(qe,"click",async()=>{$r=!1,await Bc(),xe(e),u.info("Ontology reloaded")});const Be=e.querySelector("#save-prompts");Be&&d(Be,"click",async()=>{const h=e.querySelectorAll("[data-prompt-key]");let y=0;for(const k of h){const T=k.getAttribute("data-prompt-key"),j=k.value;if(j&&j.trim())try{await p.put(`/api/system/prompts/${T}`,{prompt_template:j.trim()}),y++;const D=e.querySelector(`#status-${T}`);D&&(D.textContent="‚úì Saved",D.className="prompt-status saved")}catch(D){console.warn(`Failed to save prompt ${T}:`,D);const G=e.querySelector(`#status-${T}`);G&&(G.textContent="‚úó Error",G.className="prompt-status error")}}y>0?u.success(`${y} prompt(s) saved successfully`):u.info("No prompts to save")});const N=e.querySelector("#reload-prompts");N&&d(N,"click",async()=>{await Fi(),xe(e),u.info("Prompts reloaded from database")}),e.querySelectorAll("[data-view-versions]").forEach(h=>{d(h,"click",async()=>{const y=h.getAttribute("data-view-versions"),k=e.querySelector(`#versions-${y}`),T=k?.querySelector(".version-list");if(!(!k||!T)){if(!k.classList.contains("hidden")){k.classList.add("hidden");return}T.innerHTML='<p class="text-muted">Loading versions...</p>',k.classList.remove("hidden");try{const j=await p.get(`/api/system/prompts/${y}/versions`),D=j.data?.versions||[],G=j.data?.current_version||1;if(D.length===0){T.innerHTML=`
            <p class="text-muted">No previous versions. Current version: ${G}</p>
            <p class="text-sm text-muted">Versions are saved automatically when you edit a prompt.</p>
          `;return}T.innerHTML=`
          <p class="text-sm"><strong>Current version:</strong> ${G}</p>
          <div class="version-items">
            ${D.map(V=>`
              <div class="version-item">
                <div class="version-info">
                  <span class="version-number">v${V.version}</span>
                  <span class="version-date">${new Date(V.created_at).toLocaleString()}</span>
                </div>
                <div class="version-actions">
                  <button class="btn-sm" data-preview-version="${y}:${V.version}">Preview</button>
                  <button class="btn-sm btn-primary" data-restore-version="${y}:${V.version}">Restore</button>
                </div>
              </div>
            `).join("")}
          </div>
        `,T.querySelectorAll("[data-restore-version]").forEach(V=>{d(V,"click",async()=>{const[re,$e]=V.getAttribute("data-restore-version").split(":"),_e=parseInt($e,10);if(confirm(`Restore prompt "${re}" to version ${_e}? The current version will be saved in history.`))try{await p.post(`/api/system/prompts/${re}/restore`,{version:_e}),u.success(`Restored to version ${_e}`),await Fi(),xe(e)}catch{u.error("Failed to restore version")}})}),T.querySelectorAll("[data-preview-version]").forEach(V=>{d(V,"click",async()=>{const[re,$e]=V.getAttribute("data-preview-version").split(":"),_e=parseInt($e,10);try{const be=(await p.get(`/api/system/prompts/${re}/versions/${_e}`)).data?.version?.prompt_template||"",Te=document.createElement("div");Te.className="modal-overlay",Te.innerHTML=`
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: auto;">
                  <div class="modal-header">
                    <h3>Version ${_e} Preview</h3>
                    <button class="modal-close">&times;</button>
                  </div>
                  <div class="modal-body">
                    <pre style="white-space: pre-wrap; font-size: 12px; background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">${be.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>
                  </div>
                </div>
              `,document.body.appendChild(Te),Te.querySelector(".modal-close")?.addEventListener("click",()=>{Te.remove()}),Te.addEventListener("click",Ce=>{Ce.target===Te&&Te.remove()})}catch{u.error("Failed to load version preview")}})})}catch{T.innerHTML='<p class="text-error">Failed to load version history</p>'}}})});const ne=e.querySelector("#save-processing");ne&&d(ne,"click",async()=>{await vn("chunk_size",parseInt(e.querySelector("#proc-chunk-size")?.value||"1000"),"processing"),await vn("chunk_overlap",parseInt(e.querySelector("#proc-chunk-overlap")?.value||"200"),"processing"),await vn("max_tokens",parseInt(e.querySelector("#proc-max-tokens")?.value||"4096"),"processing"),await vn("temperature",parseFloat(e.querySelector("#proc-temperature")?.value||"0.7"),"processing"),await vn("auto_process",e.querySelector("#proc-auto-process")?.checked,"processing"),await vn("parallel_jobs",parseInt(e.querySelector("#proc-parallel-jobs")?.value||"3"),"processing")});const se=e.querySelector("#save-team-analysis");se&&d(se,"click",async()=>{const h=e.querySelector("#team-analysis-enabled")?.checked??!0,y=e.querySelector("#team-analysis-access")?.value||"admin_only";await zk(h,y),xe(e)});const I=e.querySelector("#exchange-rate-auto");I&&d(I,"change",()=>{const h=I.checked,y=e.querySelector("#manual-rate-group"),k=e.querySelector("#refresh-rate-btn");y&&(y.style.display=h?"none":"block"),k&&(k.disabled=!h)});const O=e.querySelector("#refresh-rate-btn");O&&d(O,"click",async()=>{const h=O;h.disabled=!0,h.textContent="Refreshing...";try{const y=await kt.refreshExchangeRate();if(y.success&&y.rate){const k=e.querySelector("#current-rate-display"),T=e.querySelector("#rate-source");k&&(k.textContent=y.rate.toFixed(4)),T&&(T.textContent=y.source||"api"),u.success(`Rate updated: ${y.rate.toFixed(4)}`)}else u.error(y.error||"Failed to refresh rate")}catch{u.error("Failed to refresh rate")}finally{h.disabled=!1,h.textContent="Refresh Rate"}});const F=e.querySelector("#save-exchange-rate-btn");F&&d(F,"click",async()=>{const h=e.querySelector("#exchange-rate-auto")?.checked??!0,y=parseFloat(e.querySelector("#exchange-rate-manual")?.value||"0.92"),k=await kt.setExchangeRateMode(h,y);k.success?(u.success("Exchange rate settings saved"),Zt=!1,await Hn(),xe(e)):u.error(k.error||"Failed to save")});const W=e.querySelector("#save-global-pricing-btn");W&&d(W,"click",async()=>{const h=parseFloat(e.querySelector("#global-markup-percent")?.value||"0"),y=e.querySelector("#global-period-type")?.value||"monthly",k=await kt.setGlobalPricingConfig({fixed_markup_percent:h,period_type:y});k.success?(u.success("Global pricing saved"),Zt=!1,await Hn(),xe(e)):u.error(k.error||"Failed to save")});const z=e.querySelector("#add-tier-btn");z&&d(z,"click",()=>{$t.push({id:"",pricing_config_id:ta?.id||"",token_limit:1e5,markup_percent:20,name:`Tier ${$t.length+1}`,tier_order:$t.length}),xe(e)}),e.querySelectorAll(".remove-tier-btn").forEach(h=>{d(h,"click",()=>{const y=parseInt(h.getAttribute("data-index")||"0",10);$t.splice(y,1),xe(e)})}),e.querySelectorAll(".tier-unlimited").forEach(h=>{d(h,"change",()=>{const k=h.closest(".tier-row")?.querySelector(".tier-limit");k&&(k.disabled=h.checked,h.checked&&(k.value=""))})});const E=e.querySelector("#save-tiers-btn");E&&d(E,"click",async()=>{const h=[];e.querySelectorAll(".tier-row").forEach(k=>{const T=k.querySelector(".tier-name")?.value||"",j=k.querySelector(".tier-limit")?.value,D=parseFloat(k.querySelector(".tier-markup")?.value||"0"),G=k.querySelector(".tier-unlimited")?.checked;h.push({token_limit:G?null:j?parseInt(j,10):null,markup_percent:D,name:T||void 0})});const y=await kt.setGlobalPricingTiers(h);y.success?(u.success("Pricing tiers saved"),Zt=!1,await Hn(),xe(e)):u.error(y.error||"Failed to save tiers")});const _=e.querySelector("#refresh-billing-btn");_&&d(_,"click",async()=>{Zt=!1,await Hn(),xe(e),u.info("Billing data refreshed")}),e.querySelectorAll(".add-balance-btn").forEach(h=>{d(h,"click",async()=>{const y=h.getAttribute("data-project-id"),k=h.getAttribute("data-project-name");if(!y)return;const T=prompt(`Enter amount in EUR to add to "${k}":`);if(!T||isNaN(parseFloat(T)))return;const j=await kt.creditProjectBalance(y,parseFloat(T));j.success?(u.success(`Added ‚Ç¨${parseFloat(T).toFixed(2)} to ${k}. New balance: ‚Ç¨${j.new_balance?.toFixed(2)}`),Zt=!1,await Hn(),xe(e)):u.error(j.error||"Failed to add balance")})}),e.querySelectorAll(".toggle-unlimited-btn").forEach(h=>{d(h,"click",async()=>{const y=h.getAttribute("data-project-id"),k=h.getAttribute("data-unlimited")==="true";if(!y||!confirm(`Are you sure you want to ${k?"disable unlimited mode":"enable unlimited mode"} for this project?`))return;const j=await kt.setProjectUnlimited(y,!k);j.success?(u.success(`Unlimited mode ${k?"disabled":"enabled"}`),Zt=!1,await Hn(),xe(e)):u.error(j.error||"Failed to update")})});const A=e.querySelector("#refresh-audit");A&&d(A,"click",async()=>{await yp(),xe(e)})}function xe(e){e.innerHTML=`
    <div class="admin-panel">
      <div class="admin-header">
        <div class="admin-header-content">
          <div class="admin-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="32" height="32">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <div class="admin-title">
            <h2>Platform Administration</h2>
            <p>System configuration for superadmins</p>
          </div>
        </div>
      </div>

      <div class="admin-body">
        <nav class="admin-nav">
          ${Ek()}
        </nav>

        <main class="admin-content">
          ${Ni?'<div class="loading-spinner">Loading...</div>':Ok()}
        </main>
      </div>
    </div>
  `,Uk(e)}async function wp(e){if(P.getState().currentUser?.role!=="superadmin"){e.innerHTML=`
      <div class="admin-panel">
        <div class="admin-header">
          <h2>Access Denied</h2>
          <p>You need superadmin privileges to access this section.</p>
        </div>
      </div>
    `;return}Ni=!0,xe(e),await Promise.all([bp(),Tk(),yp(),Fi(),qk()]),Ni=!1,xe(e)}const Vk=Object.freeze(Object.defineProperty({__proto__:null,initAdminPanel:wp},Symbol.toStringTag,{value:"Module"}));let va=[],Xn=1,Sr=!0,Yo=!1,Re={action:"",entityType:"",dateFrom:"",dateTo:""};function kp(e={}){const t=x("div",{className:"history-panel"});return t.innerHTML=`
    <div class="history-filters">
      <select id="history-action-filter" class="filter-select">
        <option value="">All Actions</option>
        <option value="create">Created</option>
        <option value="update">Updated</option>
        <option value="delete">Deleted</option>
        <option value="restore">Restored</option>
        <option value="process">Processed</option>
        <option value="upload">Uploaded</option>
      </select>
      <select id="history-entity-filter" class="filter-select">
        <option value="">All Types</option>
        <option value="document">Documents</option>
        <option value="fact">Facts</option>
        <option value="question">Questions</option>
        <option value="risk">Risks</option>
        <option value="action">Actions</option>
        <option value="decision">Decisions</option>
        <option value="contact">Contacts</option>
        <option value="email">Emails</option>
      </select>
      <input type="date" id="history-date-from" class="filter-date" placeholder="From">
      <input type="date" id="history-date-to" class="filter-date" placeholder="To">
      <button class="btn btn-sm" id="history-clear-filters">Clear</button>
    </div>
    <div class="history-content" id="history-content">
      <div class="loading">Loading history...</div>
    </div>
  `,Gk(t,e),Cr(t,e),t}function Gk(e,t){const n=e.querySelector("#history-action-filter"),a=e.querySelector("#history-entity-filter"),s=e.querySelector("#history-date-from"),o=e.querySelector("#history-date-to"),i=e.querySelector("#history-clear-filters"),r=()=>{Re={action:n.value,entityType:a.value,dateFrom:s.value,dateTo:o.value},va=[],Xn=1,Sr=!0,Cr(e,t)};d(n,"change",r),d(a,"change",r),d(s,"change",r),d(o,"change",r),d(i,"click",()=>{n.value="",a.value="",s.value="",o.value="",r()})}async function Cr(e,t){if(Yo)return;const n=e.querySelector("#history-content");Xn===1&&(n.innerHTML='<div class="loading">Loading history...</div>'),Yo=!0;try{const a=new URLSearchParams({page:String(Xn),limit:"30"});Re.action&&a.set("action",Re.action),Re.entityType&&a.set("entityType",Re.entityType),Re.dateFrom&&a.set("dateFrom",Re.dateFrom),Re.dateTo&&a.set("dateTo",Re.dateTo);const s=await p.get(`/api/history?${a}`);va=Xn===1?s.data.entries:[...va,...s.data.entries],Sr=s.data.hasMore,Xn++,Qk(n,t)}catch{Xn===1&&(n.innerHTML='<div class="error">Failed to load history</div>')}finally{Yo=!1}}function Qk(e,t){if(va.length===0){e.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">üìú</span>
        <p>No history entries found</p>
        <span class="empty-hint">Processing and editing activity will appear here</span>
      </div>
    `;return}const n=Yk(va);e.innerHTML=`
    <div class="history-timeline">
      ${Object.entries(n).map(([s,o])=>`
        <div class="history-date-group">
          <div class="history-date-header">${s}</div>
          <div class="history-items">
            ${o.map(i=>Kk(i,t)).join("")}
          </div>
        </div>
      `).join("")}
    </div>
    ${Sr?`
      <div class="history-load-more">
        <button class="btn btn-secondary" id="load-more-history">Load More</button>
      </div>
    `:`
      <div class="history-end">
        <span>End of history</span>
      </div>
    `}
  `;const a=e.querySelector("#load-more-history");a&&d(a,"click",async()=>{const s=e.closest(".history-panel");await Cr(s,t)}),e.querySelectorAll('[data-action="expand"]').forEach(s=>{d(s,"click",()=>{const o=s.closest(".history-entry")?.querySelector(".history-changes");o&&(o.classList.toggle("expanded"),s.textContent=o.classList.contains("expanded")?"Hide details":"Show details")})}),t.onRestore&&e.querySelectorAll('[data-action="restore"]').forEach(s=>{d(s,"click",()=>{const o=s.getAttribute("data-entry-id"),i=va.find(r=>r.id===o);i&&t.onRestore&&t.onRestore(i)})})}function Kk(e,t){const n={create:"‚ûï",update:"‚úèÔ∏è",delete:"üóëÔ∏è",restore:"‚Ü©Ô∏è",process:"‚öôÔ∏è",upload:"üì§"},a={create:"success",update:"info",delete:"danger",restore:"warning",process:"info",upload:"success"},s=e.changes&&Object.keys(e.changes).length>0;return`
    <div class="history-entry ${a[e.action]||"info"}" data-entry-id="${e.id}">
      <div class="history-icon">${n[e.action]||"üìù"}</div>
      <div class="history-content">
        <div class="history-summary">
          <strong>${Fc(e.actor.name)}</strong>
          ${Wk(e.action)}
          <span class="entity-type">${e.entityType}</span>
          ${e.entityName?`"${Fc(e.entityName)}"`:""}
        </div>
        <div class="history-time">${J(e.timestamp)}</div>
        
        ${s?`
          <div class="history-changes">
            ${Object.entries(e.changes).slice(0,5).map(([o,i])=>`
              <div class="change-item">
                <span class="change-field">${Jk(o)}:</span>
                <span class="change-old">${Nc(i.old)}</span>
                <span class="change-arrow">‚Üí</span>
                <span class="change-new">${Nc(i.new)}</span>
              </div>
            `).join("")}
            ${Object.keys(e.changes).length>5?`<div class="change-more">+${Object.keys(e.changes).length-5} more changes</div>`:""}
          </div>
          <button class="btn-link" data-action="expand">Show details</button>
        `:""}
        
        ${e.action==="delete"&&t.onRestore?`
          <button class="btn btn-sm btn-secondary" data-action="restore" data-entry-id="${e.id}">
            Restore
          </button>
        `:""}
      </div>
    </div>
  `}function Wk(e){return{create:"created",update:"updated",delete:"deleted",restore:"restored",process:"processed",upload:"uploaded"}[e]||e}function Yk(e){const t={},n=new Date().toDateString(),a=new Date(Date.now()-864e5).toDateString();return e.forEach(s=>{const o=new Date(s.timestamp);let i;o.toDateString()===n?i="Today":o.toDateString()===a?i="Yesterday":i=o.toLocaleDateString(void 0,{weekday:"long",month:"long",day:"numeric"}),t[i]||(t[i]=[]),t[i].push(s)}),t}function Jk(e){return e.replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^./,t=>t.toUpperCase())}function Nc(e){if(e==null)return"(empty)";if(typeof e=="boolean")return e?"Yes":"No";if(typeof e=="object"){const n=JSON.stringify(e);return n.length>50?n.substring(0,47)+"...":n}const t=String(e);return t.length>50?t.substring(0,47)+"...":t}function Fc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function $p(e="json"){try{const t=new URLSearchParams({format:e,limit:"1000"});Re.action&&t.set("action",Re.action),Re.entityType&&t.set("entityType",Re.entityType),Re.dateFrom&&t.set("dateFrom",Re.dateFrom),Re.dateTo&&t.set("dateTo",Re.dateTo);const a=await(await fetch(`/api/history/export?${t}`)).blob(),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=`history-export.${e}`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s),u.success("History exported successfully")}catch{u.error("Failed to export history")}}const Zk=Object.freeze(Object.defineProperty({__proto__:null,createHistoryPanel:kp,exportHistory:$p},Symbol.toStringTag,{value:"Module"})),Xk=Object.freeze(Object.defineProperty({__proto__:null,addProcessingStep:Q1,alert:Tl,clearSelection:cr,closeAllModals:Cl,closeAuthModal:ux,closeEmailComposer:$a,closeFactModal:Nd,closeModal:H,closeProcessingModal:wd,closeProfileModal:L2,closeSearch:La,confirm:Ln,createActionsPanel:Vs,createApiKeysPanel:lk,createAuditPanel:bk,createBriefingPanel:Fd,createBulkActionsBar:_1,createBulkCheckbox:B1,createChat:Yi,createCommentsThread:Xw,createContactsPanel:Gd,createConversationsPanel:Ew,createCostsDashboard:md,createDashboard:Fs,createDecisionsPanel:Gs,createDocumentsPanel:_i,createEmailComposer:xr,createEmailsPanel:ap,createFactsPanel:wa,createFileUploader:v0,createHeader:wl,createHealthBadge:s0,createHealthIndicator:a0,createHistoryPanel:kp,createKnowledgeGraph:y0,createKnowledgePanel:bw,createMembersPanel:sk,createModal:fe,createNotificationsDropdown:rp,createOrgChart:Yd,createProjectSelector:yb,createQuestionDetailView:fo,createQuestionsPanel:Zi,createReportsPanel:z2,createRiskMatrix:u0,createRiskSummary:g0,createRisksPanel:Os,createSidebar:kl,createSourceOfTruth:Ul,createStatsCard:sd,createStatsGrid:n0,createSyncIndicator:R1,createSyncStatus:I1,createTeamsPanel:Kd,createThemeToggle:Wi,createTimeline:C0,createTimelinePanel:ld,createToastElement:Sl,createTrendChart:r0,createWebhooksPanel:vk,deselectItem:H1,exportHistory:$p,getHealthColor:o0,getHealthStatus:i0,getSelectedIds:z1,getToastContainer:$l,initAdminPanel:wp,initGlobalSearch:gd,initNotificationsDropdown:dp,initProjectSelector:bb,isModalOpen:Ll,isProcessingModalOpen:W1,isSelected:xi,mountChat:Hl,mountDashboard:Dl,mountHeader:Yh,mountSidebar:tb,mountSourceOfTruth:xy,mountThemeToggle:Dh,openModal:he,openSearch:vd,renderRolesPanel:vp,selectItem:P1,setProcessingSteps:K1,showActionModal:oa,showAuthModal:dr,showCommentModal:h2,showContactModal:Vt,showDecisionModal:Ca,showDeveloperModal:mr,showEmailComposer:Hi,showEmailModal:gr,showExportModal:Tx,showFactModal:vr,showFileUploadModal:ur,showGraphModal:c2,showHistoryModal:u2,showInviteModal:pr,showNotificationsModal:Gx,showProcessingModal:O1,showProfileModal:Rd,showProjectModal:ln,showQuestionModal:ws,showRiskModal:Sa,showRoleModal:_d,showSettingsModal:xd,showShortcutsModal:Dd,showTeamModal:Zs,showToastInContainer:nb,toggleSearch:bi,toggleSelection:bd,updateModalContent:Ml,updateModalTitle:ql,updateProcessingStep:G1,updateStatsCard:t0,updateTabBadge:eb},Symbol.toStringTag,{value:"Module"}));Object.defineProperty(window,"currentProject",{get:()=>P.getState().currentProject,set:e=>P.setCurrentProject(e),configurable:!0});Object.defineProperty(window,"currentProjectId",{get:()=>P.getState().currentProjectId,set:e=>P.setCurrentProjectId(e),configurable:!0});Object.defineProperty(window,"currentUser",{get:()=>P.getState().currentUser,set:e=>P.setCurrentUser(e),configurable:!0});Object.defineProperty(window,"authConfigured",{get:()=>P.getState().authConfigured,set:e=>P.setAuthConfigured(e),configurable:!0});Object.defineProperty(window,"currentTab",{get:()=>ve.getState().currentTab,set:e=>ve.setTab(e),configurable:!0});Object.defineProperty(window,"questions",{get:()=>B.getState().questions,set:e=>B.setQuestions(e),configurable:!0});Object.defineProperty(window,"risks",{get:()=>B.getState().risks,set:e=>B.setRisks(e),configurable:!0});Object.defineProperty(window,"actions",{get:()=>B.getState().actions,set:e=>B.setActions(e),configurable:!0});Object.defineProperty(window,"decisions",{get:()=>B.getState().decisions,set:e=>B.setDecisions(e),configurable:!0});Object.defineProperty(window,"contacts",{get:()=>B.getState().contacts,set:e=>B.setContacts(e),configurable:!0});Object.defineProperty(window,"chatHistory",{get:()=>B.getState().chatHistory,set:e=>B.setChatHistory(e),configurable:!0});window.api=async function(t,n="GET",a){try{let s;switch(n.toUpperCase()){case"GET":s=await p.get(t);break;case"POST":s=await p.post(t,a);break;case"PUT":s=await p.put(t,a);break;case"PATCH":s=await p.patch(t,a);break;case"DELETE":s=await p.delete(t);break;default:s=await Rt(t,{method:n,body:a?JSON.stringify(a):void 0})}return s.data}catch(s){throw console.error("API Error:",s),s}};window.showToast=function(t,n="info"){u[n](t)};window.setTheme=function(t){Ae.set(t)};window.toggleTheme=function(){Ae.toggle()};window.getStorageItem=function(t,n=null){return Xe.get(t,n)};window.setStorageItem=function(t,n){Xe.set(t,n)};window.switchTab=function(t){ve.setTab(t)};window.refreshData=async function(){const t=P.getState().currentProjectId;if(t)try{const[n,a,s,o,i]=await Promise.all([p.get(`/api/projects/${t}/questions`),p.get(`/api/projects/${t}/risks`),p.get(`/api/projects/${t}/actions`),p.get(`/api/projects/${t}/decisions`),p.get(`/api/projects/${t}/contacts`)]);B.setQuestions(n.data),B.setRisks(a.data),B.setActions(s.data),B.setDecisions(o.data),B.setContacts(i.data)}catch(n){console.error("Failed to refresh data:",n)}};window.registerChart=function(e,t,n,a="bar"){Kn.registerChart(e,t,n,a)};window.destroyChart=function(e){Kn.destroyChart(e)};window.getChart=function(e){return Kn.getChart(e)};window.registerShortcut=function(e,t,n={}){Ct.register({key:e,ctrl:n.ctrl,shift:n.shift,alt:n.alt,handler:t,description:n.description||"Custom shortcut"})};window.pushUndoAction=function(e,t,n){wt.push({id:`undo-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,description:e,undo:t,redo:n})};window.undoLastAction=function(){return wt.undo()};window.redoLastAction=function(){return wt.redo()};function e$(){console.log("[GodMode] Legacy bridge initialized"),P.init()}window.godmode={theme:Ae,toast:u,shortcuts:Ct,undo:wt,storage:Xe,http:p,api:Rt,configureApi:Jc,auth:tt,projects:Cn,dashboard:Vi,questions:we,risks:Ke,actions:We,decisions:Le,chat:us,contacts:ke,teams:ul,documents:qn,knowledge:fa,emails:aa,graph:Ki,timeline:hl,costs:ha,notifications:ba,comments:sa,members:ms,profile:en,userSettings:nh,projectSettings:ah,apiKeys:sh,webhooks:oh,audit:ih,facts:Ee,appStore:P,uiStore:ve,dataStore:B,chartsStore:Kn,version:"2.0.0"};Pp(e=>{const t=P.getState().currentProjectId;return t&&e.headers&&(e.headers["X-Project-Id"]=t),e});function t$(){Ct.register({key:"z",ctrl:!0,description:"Undo last action",handler:async()=>{wt.canUndo()&&(await wt.undo(),u.info("Undo: "+(wt.getRedoDescription()||"Action undone")))}}),Ct.register({key:"z",ctrl:!0,shift:!0,description:"Redo last action",handler:async()=>{wt.canRedo()&&(await wt.redo(),u.info("Redo: "+(wt.getUndoDescription()||"Action redone")))}}),Ct.register({key:"t",ctrl:!0,shift:!0,description:"Cycle theme (light/dark/system)",handler:()=>{Ae.cycle(),u.info(`Theme: ${Ae.getLabel()}`)}}),Ct.register({key:"?",description:"Show keyboard shortcuts",handler:()=>{Ct.showHelp()}})}function n$(){Jc({onUnauthorized:()=>{P.setCurrentUser(null),u.error("Session expired. Please log in again."),window.dispatchEvent(new CustomEvent("godmode:auth-required"))},onForbidden:()=>{u.error("You do not have permission to perform this action.")}})}function a$(){const e=document.getElementById("theme-toggle");e&&(e.addEventListener("click",()=>{Ae.cycle(),Vc(),u.info(`Theme: ${Ae.getLabel()}`)}),Vc());const t=document.getElementById("user-avatar"),n=document.getElementById("user-dropdown");t&&n&&(t.addEventListener("click",L=>{L.stopPropagation(),n.classList.toggle("hidden")}),document.addEventListener("click",()=>{n.classList.add("hidden")}));const a=document.getElementById("login-btn");a&&a.addEventListener("click",()=>{dr({onSuccess:()=>{ds(),gt()}})});const s=document.getElementById("logout-btn");s&&s.addEventListener("click",async()=>{await tt.logout(),B.setQuestions([]),B.setRisks([]),B.setActions([]),B.setDecisions([]),B.setContacts([]),B.setProjects([]),P.setCurrentProject(null),P.setCurrentProjectId(null),ds(),Kc(),P.getState().authConfigured?(u.info("Signed out successfully"),window.location.href="/"):u.info("Signed out")});const o=document.getElementById("settings-btn");o&&o.addEventListener("click",()=>{xd()});const i=document.getElementById("shortcuts-btn");i&&i.addEventListener("click",()=>{Dd()});const r=document.getElementById("dev-tools-btn");r&&r.addEventListener("click",()=>{mr()});const c=document.getElementById("profile-btn");c&&c.addEventListener("click",()=>{Rd()});const l=document.getElementById("notifications-container");l&&dp(l,{onNotificationClick:L=>{console.log("Notification clicked:",L),L.entity_type&&L.entity_id&&window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:{type:L.entity_type,id:L.entity_id}}))}}),document.querySelectorAll(".nav-item[data-tab]").forEach(L=>{L.addEventListener("click",()=>{const R=L.getAttribute("data-tab");R&&Ne(R)})});const v=document.querySelectorAll(".sot-tab");v.forEach(L=>{L.addEventListener("click",()=>{const R=L.getAttribute("data-view");R&&(v.forEach(Z=>Z.classList.remove("active")),L.classList.add("active"),ve.setSotView(R),wn(R))})});const g=document.getElementById("menu-toggle"),f=document.getElementById("app-sidebar");g&&f&&g.addEventListener("click",()=>{f.classList.toggle("open")});const b=document.getElementById("new-contact-btn");b&&b.addEventListener("click",()=>{Vt({mode:"create"})}),document.querySelectorAll("#new-upload-btn, #upload-files-btn").forEach(L=>{L.addEventListener("click",()=>{ur()})}),p$();const $=document.getElementById("project-selector"),M=document.getElementById("new-project-btn"),q=document.getElementById("edit-project-btn");$&&($.addEventListener("change",async()=>{const L=$.value;console.log("üîÑ Project selector changed, value:",L),L?(await c$(L),q&&q.classList.remove("hidden")):(console.log("üì≠ Clearing project - starting..."),q&&q.classList.add("hidden"),P.setCurrentProject(null),P.setCurrentProjectId(null),console.log("üì≠ Store cleared"),B.setQuestions([]),B.setRisks([]),B.setActions([]),B.setDecisions([]),B.setContacts([]),console.log("üì≠ Data store cleared"),console.log("üì≠ Calling showNoProjectState..."),Sp(),console.log("üì≠ showNoProjectState called"),Ne("dashboard"),wn(ve.getState().sotCurrentView),p.post("/api/projects/deactivate").catch(()=>{}),console.log("üì≠ Project deselected - ALL DONE"))}),In()),M&&M.addEventListener("click",()=>{ln({mode:"create",onSave:async L=>{await In(),L.id&&$&&($.value=L.id,q&&q.classList.remove("hidden")),await gt()}})}),q&&q.addEventListener("click",()=>{const L=P.getState().currentProject;L&&ln({mode:"edit",project:L,onSave:async()=>{await In()},onDelete:async()=>{await In(),q&&q.classList.add("hidden"),B.setQuestions([]),B.setRisks([]),B.setActions([]),B.setDecisions([]),Kc()}})});const C=document.querySelectorAll("#contacts-subtabs .subtab");C.forEach(L=>{L.addEventListener("click",()=>{C.forEach(Z=>Z.classList.remove("active")),L.classList.add("active");const R=L.getAttribute("data-subtab");document.querySelectorAll('[id^="contacts-subtab-"]').forEach(Z=>{Z.classList.toggle("hidden",Z.id!==`contacts-subtab-${R}`)})})});const S=document.getElementById("refresh-dashboard-btn");S&&S.addEventListener("click",()=>{Oc(),u.info("Dashboard refreshed")}),Oc(),s$()}function Sp(){console.log("üì≠ showNoProjectState() called");const e=document.getElementById("dashboard-container");if(console.log("üì≠ dashboardContainer:",e?"FOUND":"NOT FOUND"),!e)return;console.log("üì≠ Setting innerHTML NOW..."),e.innerHTML=`
    <div class="dashboard" style="padding: 20px;">
      <div class="no-project-state" style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 24px;
        text-align: center;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
        border-radius: 20px;
        border: 2px dashed rgba(225,29,72,0.2);
        min-height: 400px;
      ">
        <svg width="96" height="96" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #e11d48; margin-bottom: 24px; opacity: 0.5;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        <h2 style="margin: 0 0 12px 0; font-size: 28px; font-weight: 700; color: var(--text-primary);">No Project Selected</h2>
        <p style="margin: 0 0 28px 0; font-size: 16px; color: var(--text-secondary); max-width: 480px; line-height: 1.6;">
          Select a project from the dropdown above, or create a new one to get started with your data management.
        </p>
        <button id="create-project-empty-cta" class="btn btn-primary" style="
          padding: 14px 32px;
          font-size: 15px;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          gap: 10px;
          border-radius: 12px;
        ">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create New Project
        </button>
      </div>
    </div>
  `,console.log("üì≠ innerHTML SET! Container visible:",e.offsetParent!==null),console.log("üì≠ Container display:",window.getComputedStyle(e).display);const t=document.getElementById("create-project-empty-cta");t&&t.addEventListener("click",()=>{ln({mode:"create",onSave:async n=>{await In();const a=document.getElementById("project-selector");n.id&&a&&(a.value=n.id),await gt()}})})}async function Oi(){const e=document.getElementById("dashboard-container");if(!e)return;const t=P.getState().currentProject,n=P.getState().currentProjectId;if(!t&&!n){Sp();return}e.innerHTML='<div class="loading-placeholder" style="padding: 40px; text-align: center;">Loading dashboard...</div>';try{const{createDashboard:a}=await Y(async()=>{const{createDashboard:o}=await Promise.resolve().then(()=>Db);return{createDashboard:o}},void 0);e.innerHTML="";const s=a({onStatClick:o=>{console.log("Stat clicked:",o),o==="questions"?Ne("sot"):o==="facts"?(Ne("sot"),ve.setSotView("facts"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="facts")}),wn("facts")):o==="risks"?(Ne("sot"),ve.setSotView("risks"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="risks")}),wn("risks")):o==="actions"?(Ne("sot"),ve.setSotView("actions"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="actions")}),wn("actions")):o==="decisions"?(Ne("sot"),ve.setSotView("decisions"),document.querySelectorAll(".sot-tab").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")==="decisions")}),wn("decisions")):o==="contacts"&&Ne("contacts")}});e.appendChild(s)}catch(a){console.error("Failed to load Dashboard:",a),e.innerHTML='<div class="error">Failed to load dashboard</div>'}}function Oc(){Oi();const e=document.getElementById("chat-panel-container");e&&e.children.length===0&&Y(async()=>{const{createChat:l}=await Promise.resolve().then(()=>Pb);return{createChat:l}},void 0).then(({createChat:l})=>{const m=l({showSources:!0,showSessions:!0});e.appendChild(m)}).catch(l=>{console.error("[Chat] Failed to load Chat:",l),e.innerHTML='<div style="padding: 24px; color: var(--text-secondary);">Failed to load chat</div>'});const t=document.getElementById("emails-panel-container");t&&t.children.length===0&&Y(async()=>{const{createEmailsPanel:l}=await Promise.resolve().then(()=>Nw);return{createEmailsPanel:l}},void 0).then(({createEmailsPanel:l})=>{const m=l();t.appendChild(m)});const n=document.getElementById("contacts-panel-container");n&&n.querySelectorAll(".contacts-panel-sota").length===0&&Y(async()=>{const{createContactsPanel:l}=await Promise.resolve().then(()=>Z2);return{createContactsPanel:l}},void 0).then(({createContactsPanel:l})=>{n.innerHTML="";const m=l();n.appendChild(m)});const a=document.getElementById("teams-panel-container");a&&a.children.length===0&&Y(async()=>{const{createTeamsPanel:l}=await Promise.resolve().then(()=>aw);return{createTeamsPanel:l}},void 0).then(({createTeamsPanel:l})=>{const m=l();a.appendChild(m)});const s=document.getElementById("roles-panel-container");s&&s.children.length===0&&Y(async()=>{const{renderRolesPanel:l}=await Promise.resolve().then(()=>Mk);return{renderRolesPanel:l}},void 0).then(({renderRolesPanel:l})=>{l(s)});const o=document.getElementById("files-panel-container");o&&o.querySelectorAll(".documents-panel-minimal").length===0&&(o.innerHTML="",Y(async()=>{const{default:l}=await Promise.resolve().then(()=>hw);return{default:l}},void 0).then(({default:l})=>{const m=l({onDocumentClick:async v=>{const{showDocumentPreviewModal:g}=await Y(async()=>{const{showDocumentPreviewModal:f}=await import("./DocumentPreviewModal-bm1HEf5x.js");return{showDocumentPreviewModal:f}},__vite__mapDeps([2,1]));g({document:v})}});o.appendChild(m)}).catch(l=>{console.error("[FilesPanel] Failed to load DocumentsPanel:",l),o.innerHTML='<div style="padding: 24px; color: var(--text-secondary);">Failed to load files panel</div>'}));const i=document.getElementById("org-chart-container");i&&i.children.length===0&&Y(async()=>{const{createOrgChart:l}=await Promise.resolve().then(()=>cw);return{createOrgChart:l}},void 0).then(({createOrgChart:l})=>{const m=l();i.appendChild(m)});const r=document.getElementById("costs-container");r&&r.children.length===0&&Y(async()=>{const{createCostsDashboard:l}=await Promise.resolve().then(()=>k1);return{createCostsDashboard:l}},void 0).then(({createCostsDashboard:l})=>{const m=l();r.appendChild(m)});const c=document.getElementById("history-container");c&&c.children.length===0&&Y(async()=>{const{createHistoryPanel:l,exportHistory:m}=await Promise.resolve().then(()=>Zk);return{createHistoryPanel:l,exportHistory:m}},void 0).then(({createHistoryPanel:l,exportHistory:m})=>{const v=l({onRestore:f=>{u.info(`Restoring ${f.entityType} "${f.entityName||f.entityId}"`)}});c.appendChild(v);const g=document.getElementById("export-history-btn");g&&g.addEventListener("click",()=>m("json"))})}function s$(){const e=document.querySelectorAll(".dropzone-card[data-type]");console.log("[DropZones] Found",e.length,"dropzones"),e.forEach(t=>{const n=t.getAttribute("data-type");console.log("[DropZones] Adding click handler for:",n),t.addEventListener("click",async a=>{console.log("[DropZones] Click on:",n),a.preventDefault(),a.stopPropagation();try{switch(n){case"emails":console.log("[DropZones] Opening EmailComposer...");const{showEmailComposer:s}=await Y(async()=>{const{showEmailComposer:c}=await Promise.resolve().then(()=>ip);return{showEmailComposer:c}},void 0);s({onSave:()=>{u.success("Email imported")}});return;case"conversations":console.log("[DropZones] Opening ConversationComposer...");const{showConversationComposer:o}=await Y(async()=>{const{showConversationComposer:c}=await Promise.resolve().then(()=>Aw);return{showConversationComposer:c}},void 0);o({onImport:()=>{u.success("Conversation imported")}});return;case"transcripts":console.log("[DropZones] Opening TranscriptComposer...");const{showTranscriptComposer:i}=await Y(async()=>{const{showTranscriptComposer:c}=await import("./TranscriptComposer-2LIkQTLj.js");return{showTranscriptComposer:c}},__vite__mapDeps([3,1]));i({onImport:()=>{u.success("Transcript imported")}});return;default:console.log("[DropZones] Opening file picker for documents...");const r=document.createElement("input");r.type="file",r.multiple=!0,r.accept=".pdf,.doc,.docx,.txt,.md,.rtf,.odt,.xls,.xlsx,.ppt,.pptx,.csv,.json",r.onchange=()=>{r.files&&r.files.length>0&&Uc(Array.from(r.files),"documents")},r.click();return}}catch(s){console.error("[DropZones] Error:",s),u.error("Failed to open import dialog")}}),t.addEventListener("dragover",a=>{a.preventDefault(),t.classList.add("drag-over")}),t.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),t.addEventListener("drop",a=>{a.preventDefault(),t.classList.remove("drag-over");const s=a.dataTransfer;s?.files&&s.files.length>0&&Uc(Array.from(s.files),n||"documents")})})}async function Uc(e,t){d$(e);const n=e.map(a=>a.name).join(", ");u.info(`Added ${e.length} ${t} to queue: ${n.substring(0,50)}${n.length>50?"...":""}`)}function Vc(){const e=document.getElementById("theme-toggle");e&&(e.textContent=Ae.getIcon(),e.title=`Theme: ${Ae.getLabel()}`)}const o$=["dashboard","chat","sot","timeline","contacts","team-analysis","files","graph","emails","costs","history","roles","admin","org"];function Gc(){const t=window.location.pathname.match(/^\/app\/([^/]+)/);return t&&o$.includes(t[1])?t[1]:"dashboard"}function i$(e,t=!1){const n=e==="dashboard"?"/app":`/app/${e}`;window.location.pathname!==n&&(t?window.history.replaceState({tab:e},"",n):window.history.pushState({tab:e},"",n))}function r$(){window.addEventListener("popstate",t=>{const n=t.state?.tab||Gc();Ne(n,!1)});const e=Gc();e!=="dashboard"&&setTimeout(()=>Ne(e,!0),0)}function Ne(e,t=!0){document.querySelectorAll(".nav-item[data-tab]").forEach(a=>{a.classList.toggle("active",a.getAttribute("data-tab")===e)}),document.querySelectorAll(".tab-content").forEach(a=>{a.classList.toggle("active",a.id===`tab-${e}`),a.classList.toggle("hidden",a.id!==`tab-${e}`)});const n=document.getElementById("app-sidebar");if(n&&n.classList.remove("open"),t&&i$(e),ve.setTab(e),e==="admin"){const a=document.getElementById("tab-admin");a&&Y(async()=>{const{initAdminPanel:s}=await Promise.resolve().then(()=>Vk);return{initAdminPanel:s}},void 0).then(({initAdminPanel:s})=>{s(a)})}if(e==="graph"){const a=document.getElementById("graph-container"),s=a?.querySelector(".graph-explorer");a&&!s&&(console.log("[Graph] Loading GraphExplorer..."),Y(async()=>{const{createGraphExplorer:o}=await import("./GraphExplorer-S4ugv9np.js");return{createGraphExplorer:o}},__vite__mapDeps([4,1])).then(({createGraphExplorer:o})=>{a.innerHTML="";const i=o({onNodeSelect:r=>{console.log("Graph node selected:",r)},onQueryExecute:r=>{console.log("Query executed:",r)}});a.appendChild(i),console.log("[Graph] GraphExplorer loaded successfully")}).catch(o=>{console.error("[Graph] Failed to load GraphExplorer:",o),a.innerHTML='<div style="padding: 24px; text-align: center; color: var(--text-secondary);">Failed to load Graph Explorer</div>'}))}if(e==="timeline"){const a=document.getElementById("timeline-content"),s=a?.querySelector(".timeline-panel");a&&!s&&(console.log("[Timeline] Loading TimelinePanel..."),Y(async()=>{const{createTimelinePanel:o}=await Promise.resolve().then(()=>G0);return{createTimelinePanel:o}},void 0).then(({createTimelinePanel:o})=>{a.innerHTML="";const i=o({onEventClick:r=>{if(console.log("Timeline event clicked:",r),r.entity_type&&r.entity_id){const c=r.entity_type;c==="question"?Y(async()=>{const{createQuestionDetailView:l}=await Promise.resolve().then(()=>Xb);return{createQuestionDetailView:l}},void 0).then(({createQuestionDetailView:l})=>{const m=document.getElementById("timeline-content");if(m){m.innerHTML="";const v=l({questionId:r.entity_id,onBack:()=>Ne("timeline")});m.appendChild(v)}}):c==="decision"?Y(async()=>{const{createDecisionDetailView:l}=await Promise.resolve().then(()=>By);return{createDecisionDetailView:l}},void 0).then(({createDecisionDetailView:l})=>{const m=document.getElementById("timeline-content");if(m){m.innerHTML="";const v=l({decisionId:r.entity_id,onBack:()=>Ne("timeline")});m.appendChild(v)}}):c==="fact"?Y(async()=>{const{createFactDetailView:l}=await Promise.resolve().then(()=>Ky);return{createFactDetailView:l}},void 0).then(({createFactDetailView:l})=>{const m=document.getElementById("timeline-content");if(m){m.innerHTML="";const v=l({factId:r.entity_id,onBack:()=>Ne("timeline")});m.appendChild(v)}}):c==="risk"?Y(async()=>{const{createRiskDetailView:l}=await Promise.resolve().then(()=>$y);return{createRiskDetailView:l}},void 0).then(({createRiskDetailView:l})=>{const m=document.getElementById("timeline-content");if(m){m.innerHTML="";const v=l({riskId:r.entity_id,onBack:()=>Ne("timeline")});m.appendChild(v)}}):c==="action"?Y(async()=>{const{createActionDetailView:l}=await Promise.resolve().then(()=>jy);return{createActionDetailView:l}},void 0).then(({createActionDetailView:l})=>{const m=document.getElementById("timeline-content");if(m){m.innerHTML="";const v=l({actionId:r.entity_id,onBack:()=>Ne("timeline")});m.appendChild(v)}}):u.info(`Event: ${r.title}`)}}});a.appendChild(i),console.log("[Timeline] TimelinePanel loaded successfully")}).catch(o=>{console.error("[Timeline] Failed to load TimelinePanel:",o),a.innerHTML='<div style="padding: 24px; text-align: center; color: var(--text-secondary);">Failed to load Timeline</div>'}))}if(e==="team-analysis"){const a=document.getElementById("team-analysis-container"),s=a?.querySelector(".team-analysis-panel");a&&!s?(console.log("[TeamAnalysis] Loading TeamAnalysis component..."),Y(async()=>{const{createTeamAnalysis:o}=await import("./TeamAnalysis-BKtZPBFt.js");return{createTeamAnalysis:o}},__vite__mapDeps([5,6,1])).then(({createTeamAnalysis:o})=>{a.innerHTML="";const i=o();a.appendChild(i),console.log("[TeamAnalysis] TeamAnalysis loaded successfully"),Qc()}).catch(o=>{console.error("[TeamAnalysis] Failed to load TeamAnalysis:",o),a.innerHTML='<div style="padding: 24px; text-align: center; color: var(--text-secondary);">Failed to load Team Analysis</div>'})):Qc()}}function Qc(){Y(async()=>{const{teamAnalysisStore:e}=await import("./teamAnalysis-b6DZM1KK.js");return{teamAnalysisStore:e}},[]).then(({teamAnalysisStore:e})=>{document.querySelectorAll("#team-analysis-subtabs .subtab").forEach(t=>{const n=t.cloneNode(!0);t.parentNode?.replaceChild(n,t),n.addEventListener("click",a=>{const s=a.target.dataset.subtab;s&&(console.log("[TeamAnalysis] Switching to subtab:",s),document.querySelectorAll("#team-analysis-subtabs .subtab").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-subtab")===s)}),e.setSubtab(s))})})})}async function In(){const e=document.getElementById("project-selector");if(e)try{const t=await Cn.getAll();e.innerHTML='<option value="">Select Project...</option>',t.forEach(s=>{const o=document.createElement("option");o.value=s.id,o.textContent=s.name+(s.isDefault?" (default)":""),e.appendChild(o)});const n=P.getState().currentProjectId,a=document.getElementById("edit-project-btn");if(n)e.value=n,a&&a.classList.remove("hidden");else if(t.length>0){const s=t.find(o=>o.isDefault)||t[0];e.value=s.id,P.setCurrentProject(s),P.setCurrentProjectId(s.id),a&&a.classList.remove("hidden")}else a&&a.classList.add("hidden")}catch(t){console.warn("Projects not available:",t)}}async function c$(e){try{const t=await Cn.activate(e);t&&(u.success(`Switched to: ${t.name}`),await gt())}catch{u.error("Failed to load project")}}async function gt(){try{await In();let e=P.getState().currentProject,t=P.getState().currentProjectId;if(!e&&!t){const r=document.getElementById("project-selector");if(r?.value)try{const c=await Cn.activate(r.value);c&&(P.setCurrentProject(c),P.setCurrentProjectId(c.id),e=c,t=c.id)}catch{}}if(!e&&!t){console.log("üì≠ No project selected - showing empty state"),Ne("dashboard"),B.setQuestions([]),B.setRisks([]),B.setActions([]),B.setDecisions([]),B.setContacts([]),await Oi(),wn(ve.getState().sotCurrentView);return}const[n,a,s,o,i]=await Promise.all([p.get("/api/questions").catch(()=>({data:{questions:[]}})),p.get("/api/risks").catch(()=>({data:{risks:[]}})),p.get("/api/actions").catch(()=>({data:{actions:[]}})),p.get("/api/decisions").catch(()=>({data:{decisions:[]}})),p.get("/api/contacts").catch(()=>({data:{contacts:[]}}))]);B.setQuestions(n.data.questions||[]),B.setRisks(a.data.risks||[]),B.setActions(s.data.actions||[]),B.setDecisions(o.data.decisions||[]),B.setContacts(i.data.contacts||[]),await Oi(),wn(ve.getState().sotCurrentView)}catch{console.error("Failed to refresh data")}}function Kc(){const e=document.getElementById("dashboard-stats"),t=document.getElementById("dashboard-content");if(!e)return;const n=P.getState().currentProject,a=P.getState().currentProjectId;if(!n&&!a){e.innerHTML=`
      <div class="no-project-message" style="
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        text-align: center;
        background: linear-gradient(135deg, rgba(225,29,72,0.05) 0%, rgba(225,29,72,0.02) 100%);
        border-radius: 16px;
        border: 2px dashed rgba(225,29,72,0.2);
      ">
        <svg width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #e11d48; margin-bottom: 16px; opacity: 0.7;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">No Project Selected</h3>
        <p style="margin: 0 0 20px 0; font-size: 14px; color: var(--text-secondary); max-width: 400px;">
          Select an existing project from the dropdown above or create a new one to start managing your data.
        </p>
        <button id="create-project-cta" class="btn btn-primary" style="
          padding: 12px 24px;
          font-size: 14px;
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        ">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create New Project
        </button>
      </div>
    `,t&&(t.style.display="none");const i=document.getElementById("create-project-cta");i&&i.addEventListener("click",()=>{ln({mode:"create",onSave:async r=>{await In(),await gt()}})});return}t&&(t.style.display="");const s=B.getState(),o=s.questions.filter(i=>i.status!=="dismissed"&&i.status!=="resolved"&&i.status!=="answered");e.innerHTML=`
    <div class="stat-card">
      <div class="stat-value">${o.length}</div>
      <div class="stat-label">Questions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${s.risks.length}</div>
      <div class="stat-label">Risks</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${s.actions.length}</div>
      <div class="stat-label">Actions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${s.decisions.length}</div>
      <div class="stat-label">Decisions</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${s.contacts.length}</div>
      <div class="stat-label">Contacts</div>
    </div>
  `}function wn(e){const t=document.getElementById("sot-content");if(t)switch(B.getState(),e){case"questions":t.innerHTML="";const n=Zi({useDetailView:!0,containerElement:t});t.appendChild(n);return;case"facts":t.innerHTML="";const a=wa({useDetailView:!0,containerElement:t});t.appendChild(a);return;case"decisions":t.innerHTML="";const s=Gs({useDetailView:!0,containerElement:t});t.appendChild(s);return;case"risks":t.innerHTML="";const o=Os({useDetailView:!0,containerElement:t});t.appendChild(o);return;case"actions":t.innerHTML="";const i=Vs({useDetailView:!0,containerElement:t});t.appendChild(i);return;default:t.innerHTML='<p class="text-muted">Select a view</p>';return}}function Wc(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const Ft=[];function mo(){const e=document.getElementById("pending-count"),t=document.getElementById("pending-files-list");e&&(e.textContent=`${Ft.length} file${Ft.length!==1?"s":""}`),t&&(Ft.length===0?t.innerHTML='<div class="empty-hint">No files pending</div>':(t.innerHTML=Ft.map((n,a)=>`
        <div class="pending-file-item" data-index="${a}">
          <div class="pending-file-info">
            <div class="pending-file-name" title="${Wc(n.name)}">${Wc(n.name)}</div>
            <div class="pending-file-size">${l$(n.size)}</div>
          </div>
          <button class="pending-file-remove" data-index="${a}" title="Remove">√ó</button>
        </div>
      `).join(""),t.querySelectorAll(".pending-file-remove").forEach(n=>{n.addEventListener("click",a=>{a.stopPropagation();const s=parseInt(n.dataset.index||"0");Ft.splice(s,1),mo()})})))}function l$(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function d$(e){Array.from(e).forEach(t=>{Ft.some(n=>n.name===t.name&&n.size===t.size)||Ft.push(t)}),mo()}function p$(){const e=document.getElementById("process-files-btn");e&&e.addEventListener("click",async()=>{if(Ft.length===0){u.warning("No files to process. Add files first.");return}e.setAttribute("disabled","true"),e.innerHTML='<span class="btn-icon">‚è≥</span> Processing...';try{const c=await qn.upload(Ft);c.success&&(u.success(`Processed ${c.files.length} files successfully`),Ft.length=0,mo(),gt())}catch(c){u.error("Failed to process files"),console.error("Process error:",c)}finally{e.removeAttribute("disabled"),e.innerHTML='<span class="btn-icon">‚ö°</span> Process Files'}});const t=document.getElementById("export-knowledge-btn");t&&t.addEventListener("click",async()=>{try{const c=B.getState(),l={facts:c.facts||[],decisions:c.decisions||[],exportedAt:new Date().toISOString()},m=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),v=URL.createObjectURL(m),g=document.createElement("a");g.href=v,g.download="godmode-knowledge-export.json",g.click(),URL.revokeObjectURL(v),u.success("Knowledge exported")}catch{u.error("Export failed")}});const n=document.getElementById("export-knowledge-clipboard");n&&n.addEventListener("click",async()=>{try{const c=B.getState(),l={facts:c.facts||[],decisions:c.decisions||[]};await navigator.clipboard.writeText(JSON.stringify(l,null,2)),u.success("Copied to clipboard")}catch{u.error("Copy failed")}});const a=document.getElementById("export-questions-btn");a&&a.addEventListener("click",async()=>{try{const l=B.getState().questions||[],m=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),v=URL.createObjectURL(m),g=document.createElement("a");g.href=v,g.download="godmode-questions-export.json",g.click(),URL.revokeObjectURL(v),u.success("Questions exported")}catch{u.error("Export failed")}});const s=document.getElementById("export-questions-clipboard");s&&s.addEventListener("click",async()=>{try{const l=B.getState().questions||[];await navigator.clipboard.writeText(JSON.stringify(l,null,2)),u.success("Copied to clipboard")}catch{u.error("Copy failed")}});const o=document.getElementById("copy-overdue-btn");o&&o.addEventListener("click",async()=>{try{const c=B.getState(),l=new Date,m=(c.actions||[]).filter(f=>{if(f.status==="completed")return!1;const b=f.dueDate;return b?new Date(b)<l:!1}),v=(c.questions||[]).filter(f=>{if(f.status==="resolved")return!1;const b=f.created_at||f.createdAt;if(!b)return!1;const w=new Date(b),$=new Date(l.getTime()-10080*60*1e3);return w<$}),g={actions:m,questions:v,exportedAt:l.toISOString()};await navigator.clipboard.writeText(JSON.stringify(g,null,2)),u.success(`Copied ${m.length} actions and ${v.length} questions`)}catch{u.error("Copy failed")}});const i=document.getElementById("clean-orphan-btn");i&&i.addEventListener("click",async()=>{if(await Ln("This will remove orphaned data entries that are not linked to any documents. Continue?",{title:"Clean Orphan Data",confirmText:"Clean",confirmClass:"btn-warning"}))try{const l=await p.post("/api/cleanup/orphans");u.success("Orphan data cleaned"),gt()}catch{u.error("Cleanup failed")}});const r=document.getElementById("reset-data-btn");r&&r.addEventListener("click",async()=>{if(await Ln("This will clear all knowledge data (facts, decisions, questions, risks, actions, documents, etc.) for the current project. Team, contacts, and cost data will be kept. Continue?",{title:"Reset Project Data",confirmText:"Reset Knowledge Data",confirmClass:"btn-danger"}))try{await p.post("/api/reset"),u.success("Project data reset; team, contacts and cost preserved."),gt()}catch{u.error("Reset failed")}}),mo()}async function Yc(){if(console.log("üöÄ GodMode Frontend initializing..."),e$(),console.log("üîó Legacy bridge initialized"),n$(),console.log("üì° API client configured"),await u$(),console.log("üîê Auth initialized"),console.log(`üìé Theme: ${Ae.getMode()} (effective: ${Ae.getEffective()})`),t$(),console.log("‚å®Ô∏è Keyboard shortcuts registered"),gd({onResultClick:t=>{console.log("Search result clicked:",t),window.dispatchEvent(new CustomEvent("godmode:navigate",{detail:t}))}}),console.log("üîç Global search initialized"),window.addEventListener("godmode:navigate",async t=>{const n=t.detail;if(!n||n.tab!=="files"||!n.documentId)return;Ne("files"),await new Promise(s=>setTimeout(s,400));const a=await qn.get(n.documentId);if(a){const{showDocumentPreviewModal:s}=await Y(async()=>{const{showDocumentPreviewModal:o}=await import("./DocumentPreviewModal-bm1HEf5x.js");return{showDocumentPreviewModal:o}},__vite__mapDeps([2,1]));s({document:a})}}),a$(),console.log("üé® UI initialized"),r$(),console.log("üîÄ Client-side routing initialized"),tt.isAuthenticated())gt(),console.log("üìä Data loading started");else if(P.getState().authConfigured){console.log("üîê Authentication required - redirecting to landing page"),window.location.href="/";return}else console.log("üìä Guest mode - loading data"),gt();const e=document.getElementById("app-loading");e&&(e.classList.add("fade-out"),setTimeout(()=>{e.style.display="none"},300)),console.log("‚úÖ GodMode Frontend ready"),console.log(`üì¶ Version: ${window.godmode.version}`),console.log("üí° Press ? for keyboard shortcuts")}async function u$(){await tt.init(),ds(),tt.onAuthRequired(()=>{dr({required:!0,onSuccess:()=>{ds(),gt(),u.success("Session restored! Refreshing data...")}})}),window.addEventListener("godmode:auth-success",()=>{ds(),gt()})}function ds(){const e=tt.getCurrentUser(),t=document.getElementById("user-avatar"),n=document.getElementById("user-dropdown"),a=document.getElementById("login-btn"),s=document.getElementById("auth-blocker-overlay");s&&e&&s.remove();const o=document.getElementById("nav-admin-btn");if(e){if(t){const i=e.name||e.email.split("@")[0]||"User",r=(e.name?.[0]||e.email[0]).toUpperCase(),c=`https://ui-avatars.com/api/?name=${encodeURIComponent(i)}&background=e11d48&color=fff&size=80&font-size=0.4&bold=true`,l=e.avatar||c;t.innerHTML=`<img src="${l}" alt="${r}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.textContent='${r}';">`,t.title=e.name||e.email,t.classList.remove("hidden")}if(a&&a.classList.add("hidden"),n){const i=n.querySelector(".user-name"),r=n.querySelector(".user-email");i&&(i.textContent=e.name||"User"),r&&(r.textContent=e.email)}o&&(e.role==="superadmin"?(o.classList.remove("hidden"),console.log("üîë Admin nav enabled for superadmin:",e.email)):o.classList.add("hidden"))}else t&&t.classList.add("hidden"),a&&a.classList.remove("hidden"),o&&o.classList.add("hidden")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Yc):Yc();Object.assign(window.godmode,{components:Xk});export{Y as _,J as a,Tn as b,x as c,H as d,fe as e,xs as f,Ki as g,p as h,he as i,k$ as j,Gn as k,b$ as l,w$ as m,_h as n,d as o,y$ as p,C$ as q,L$ as r,f$ as s,u as t,v$ as u,g$ as v,h$ as w,$$ as x,S$ as y,x$ as z};
//# sourceMappingURL=main-DZFGTOOo.js.map
