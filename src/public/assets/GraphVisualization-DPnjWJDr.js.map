{"version":3,"file":"GraphVisualization-DPnjWJDr.js","sources":["../../frontend/components/graph/GraphVisualization.ts"],"sourcesContent":["/**\r\n * GraphVisualization - SOTA vis-network component\r\n * \r\n * Features:\r\n * - Avatar nodes for Person entities\r\n * - Semantic zoom (avatar → initials → dot)\r\n * - Community coloring\r\n * - Rich hover cards\r\n * - Context menu\r\n * - Minimap\r\n * - Animated edges\r\n */\r\n\r\nimport { createElement, on } from '../../utils/dom';\r\nimport { graphService, GraphNode, GraphEdge } from '../../services/graph';\r\nimport { toast } from '../../services/toast';\r\n\r\nexport interface GraphVisualizationProps {\r\n  height?: number;\r\n  onNodeClick?: (node: GraphNode) => void;\r\n  onNodeDoubleClick?: (node: GraphNode) => void;\r\n  onEdgeClick?: (edge: GraphEdge) => void;\r\n  onSelectionChange?: (nodes: GraphNode[], edges: GraphEdge[]) => void;\r\n}\r\n\r\ninterface VisNetwork {\r\n  setData: (data: { nodes: unknown; edges: unknown }) => void;\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  on: (event: string, callback: (params: any) => void) => void;\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  off: (event: string, callback?: (params: any) => void) => void;\r\n  fit: (options?: { animation?: boolean }) => void;\r\n  focus: (nodeId: string, options?: { scale?: number; animation?: boolean }) => void;\r\n  getScale: () => number;\r\n  moveTo: (options: { position?: { x: number; y: number }; scale?: number; animation?: boolean }) => void;\r\n  getSelectedNodes: () => string[];\r\n  getSelectedEdges: () => string[];\r\n  selectNodes: (nodeIds: string[]) => void;\r\n  unselectAll: () => void;\r\n  destroy: () => void;\r\n  getPosition: (nodeId: string) => { x: number; y: number };\r\n  getViewPosition: () => { x: number; y: number };\r\n  redraw: () => void;\r\n}\r\n\r\ninterface VisDataSet<T> {\r\n  add: (data: T | T[]) => void;\r\n  update: (data: T | T[]) => void;\r\n  remove: (ids: string | string[]) => void;\r\n  get: (id?: string) => T | T[] | null;\r\n  clear: () => void;\r\n}\r\n\r\n// Type for vis.js library loaded via CDN\r\ninterface VisModule {\r\n  Network: new (container: HTMLElement, data: unknown, options: unknown) => VisNetwork;\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  DataSet: new <T = any>(data?: T[]) => VisDataSet<T>;\r\n}\r\n\r\n// Helper to get vis module from window\r\nfunction getVis(): VisModule | undefined {\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  return (window as any).vis as VisModule | undefined;\r\n}\r\n\r\nconst TYPE_COLORS: Record<string, string> = {\r\n  Person: '#6366f1',\r\n  Project: '#22c55e',\r\n  Document: '#8b5cf6',\r\n  Decision: '#06b6d4',\r\n  Risk: '#ef4444',\r\n  Question: '#f59e0b',\r\n  Fact: '#84cc16',\r\n  Meeting: '#ec4899',\r\n  Task: '#3b82f6',\r\n  Technology: '#f97316',\r\n  Organization: '#a855f7',\r\n  Client: '#14b8a6',\r\n  Email: '#e879f9',\r\n  Conversation: '#9333ea',\r\n  Answer: '#10b981',\r\n  Briefing: '#eab308',\r\n};\r\n\r\n/**\r\n * Create the graph visualization component\r\n */\r\nexport function createGraphVisualization(props: GraphVisualizationProps = {}): HTMLElement {\r\n  const { height = 600 } = props;\r\n\r\n  const container = createElement('div', { className: 'graph-visualization-container' });\r\n  \r\n  container.innerHTML = `\r\n    <div class=\"viz-toolbar\">\r\n      <div class=\"viz-toolbar-left\">\r\n        <button class=\"viz-btn\" id=\"viz-zoom-in\" title=\"Zoom In\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <circle cx=\"11\" cy=\"11\" r=\"8\"/>\r\n            <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\r\n            <line x1=\"11\" y1=\"8\" x2=\"11\" y2=\"14\"/>\r\n            <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\r\n          </svg>\r\n        </button>\r\n        <button class=\"viz-btn\" id=\"viz-zoom-out\" title=\"Zoom Out\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <circle cx=\"11\" cy=\"11\" r=\"8\"/>\r\n            <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\r\n            <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\r\n          </svg>\r\n        </button>\r\n        <button class=\"viz-btn\" id=\"viz-fit\" title=\"Fit to View\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <path d=\"M8 3H5a2 2 0 0 0-2 2v3\"/>\r\n            <path d=\"M21 8V5a2 2 0 0 0-2-2h-3\"/>\r\n            <path d=\"M3 16v3a2 2 0 0 0 2 2h3\"/>\r\n            <path d=\"M16 21h3a2 2 0 0 0 2-2v-3\"/>\r\n          </svg>\r\n        </button>\r\n        <div class=\"viz-divider\"></div>\r\n        <button class=\"viz-btn\" id=\"viz-physics\" title=\"Toggle Physics\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n            <path d=\"M12 1v2\"/>\r\n            <path d=\"M12 21v2\"/>\r\n            <path d=\"M4.22 4.22l1.42 1.42\"/>\r\n            <path d=\"M18.36 18.36l1.42 1.42\"/>\r\n            <path d=\"M1 12h2\"/>\r\n            <path d=\"M21 12h2\"/>\r\n            <path d=\"M4.22 19.78l1.42-1.42\"/>\r\n            <path d=\"M18.36 5.64l1.42-1.42\"/>\r\n          </svg>\r\n        </button>\r\n      </div>\r\n      <div class=\"viz-toolbar-center\">\r\n        <span class=\"viz-status\" id=\"viz-status\">Loading...</span>\r\n      </div>\r\n      <div class=\"viz-toolbar-right\">\r\n        <button class=\"viz-btn\" id=\"viz-screenshot\" title=\"Screenshot\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\r\n            <circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/>\r\n            <polyline points=\"21 15 16 10 5 21\"/>\r\n          </svg>\r\n        </button>\r\n        <button class=\"viz-btn\" id=\"viz-minimap-toggle\" title=\"Toggle Minimap\">\r\n          <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n            <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/>\r\n            <rect x=\"7\" y=\"7\" width=\"3\" height=\"3\"/>\r\n            <rect x=\"14\" y=\"7\" width=\"3\" height=\"3\"/>\r\n            <rect x=\"7\" y=\"14\" width=\"3\" height=\"3\"/>\r\n            <rect x=\"14\" y=\"14\" width=\"3\" height=\"3\"/>\r\n          </svg>\r\n        </button>\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"viz-canvas-wrapper\">\r\n      <div class=\"viz-canvas\" id=\"viz-canvas\" style=\"height: ${height}px;\">\r\n        <div class=\"viz-loading\">\r\n          <div class=\"loading-spinner\"></div>\r\n          <p>Loading graph data...</p>\r\n        </div>\r\n      </div>\r\n      \r\n      <div class=\"viz-minimap hidden\" id=\"viz-minimap\">\r\n        <div class=\"minimap-viewport\" id=\"minimap-viewport\"></div>\r\n      </div>\r\n      \r\n      <div class=\"viz-legend\" id=\"viz-legend\">\r\n        <!-- Legend will be rendered here -->\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"viz-hover-card hidden\" id=\"viz-hover-card\">\r\n      <!-- Hover card content -->\r\n    </div>\r\n    \r\n    <div class=\"viz-context-menu hidden\" id=\"viz-context-menu\">\r\n      <button class=\"context-menu-item\" data-action=\"expand\">\r\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n          <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"16\"/>\r\n          <line x1=\"8\" y1=\"12\" x2=\"16\" y2=\"12\"/>\r\n        </svg>\r\n        Expand Connections\r\n      </button>\r\n      <button class=\"context-menu-item\" data-action=\"focus\">\r\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n          <path d=\"M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42\"/>\r\n        </svg>\r\n        Focus on Node\r\n      </button>\r\n      <button class=\"context-menu-item\" data-action=\"hide\">\r\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94\"/>\r\n          <line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"/>\r\n        </svg>\r\n        Hide Node\r\n      </button>\r\n      <div class=\"context-menu-divider\"></div>\r\n      <button class=\"context-menu-item\" data-action=\"bookmark\">\r\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <path d=\"M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z\"/>\r\n        </svg>\r\n        Bookmark\r\n      </button>\r\n      <button class=\"context-menu-item\" data-action=\"annotate\">\r\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"/>\r\n          <path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"/>\r\n        </svg>\r\n        Add Note\r\n      </button>\r\n      <div class=\"context-menu-divider\"></div>\r\n      <button class=\"context-menu-item\" data-action=\"ai-explain\">\r\n        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n          <path d=\"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3\"/>\r\n          <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\r\n        </svg>\r\n        AI Explain\r\n      </button>\r\n    </div>\r\n  `;\r\n\r\n  // Initialize visualization\r\n  initVisualization(container, props);\r\n\r\n  return container;\r\n}\r\n\r\n/**\r\n * Initialize the visualization\r\n */\r\nasync function initVisualization(container: HTMLElement, props: GraphVisualizationProps): Promise<void> {\r\n  const canvas = container.querySelector('#viz-canvas') as HTMLElement;\r\n  const statusEl = container.querySelector('#viz-status') as HTMLElement;\r\n\r\n  // Check if vis.js is available\r\n  if (!getVis()) {\r\n    // Try to load vis.js\r\n    await loadVisJs();\r\n  }\r\n\r\n  if (!getVis()) {\r\n    canvas.innerHTML = `\r\n      <div class=\"viz-error\">\r\n        <p>Graph visualization library not available</p>\r\n        <p class=\"text-muted\">Please ensure vis-network is loaded</p>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Load graph data\r\n    statusEl.textContent = 'Loading nodes...';\r\n    const data = await graphService.getVisualizationData({ limit: 500 });\r\n\r\n    if (data.nodes.length === 0) {\r\n      canvas.innerHTML = `\r\n        <div class=\"viz-empty\">\r\n          <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\" opacity=\"0.4\">\r\n            <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n            <circle cx=\"4\" cy=\"6\" r=\"2\"/>\r\n            <circle cx=\"20\" cy=\"6\" r=\"2\"/>\r\n            <circle cx=\"4\" cy=\"18\" r=\"2\"/>\r\n            <circle cx=\"20\" cy=\"18\" r=\"2\"/>\r\n            <line x1=\"6\" y1=\"6\" x2=\"9.5\" y2=\"10\"/>\r\n            <line x1=\"18\" y1=\"6\" x2=\"14.5\" y2=\"10\"/>\r\n            <line x1=\"6\" y1=\"18\" x2=\"9.5\" y2=\"14\"/>\r\n            <line x1=\"18\" y1=\"18\" x2=\"14.5\" y2=\"14\"/>\r\n          </svg>\r\n          <h3>No graph data</h3>\r\n          <p>Process some documents to populate the knowledge graph, or sync existing data.</p>\r\n          <button class=\"btn btn-primary\" id=\"btn-sync-empty\">Sync Data</button>\r\n        </div>\r\n      `;\r\n      \r\n      const syncBtn = canvas.querySelector('#btn-sync-empty');\r\n      if (syncBtn) {\r\n        on(syncBtn as HTMLElement, 'click', async () => {\r\n          toast.info('Syncing data...');\r\n          await fetch('/api/graph/sync', { method: 'POST' });\r\n          toast.success('Sync complete. Reloading...');\r\n          initVisualization(container, props);\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    statusEl.textContent = 'Rendering graph...';\r\n    canvas.innerHTML = '';\r\n\r\n    // Create vis.js network\r\n    const network = createNetwork(canvas, data.nodes, data.edges, props);\r\n\r\n    // Bind toolbar actions\r\n    bindToolbarActions(container, network);\r\n\r\n    // Render legend\r\n    renderLegend(container, data.nodes);\r\n\r\n    // Update status\r\n    statusEl.textContent = `${data.nodes.length} nodes • ${data.edges.length} edges`;\r\n\r\n  } catch (error) {\r\n    console.error('[GraphVisualization] Error:', error);\r\n    canvas.innerHTML = `\r\n      <div class=\"viz-error\">\r\n        <p>Failed to load graph data</p>\r\n        <button class=\"btn btn-sm\" onclick=\"location.reload()\">Retry</button>\r\n      </div>\r\n    `;\r\n  }\r\n}\r\n\r\n/**\r\n * Load vis.js dynamically\r\n */\r\nasync function loadVisJs(): Promise<void> {\r\n  return new Promise((resolve) => {\r\n    if (getVis()) {\r\n      resolve();\r\n      return;\r\n    }\r\n\r\n    const script = document.createElement('script');\r\n    script.src = 'https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js';\r\n    script.onload = () => resolve();\r\n    script.onerror = () => resolve();\r\n    document.head.appendChild(script);\r\n  });\r\n}\r\n\r\n/**\r\n * Create vis.js network\r\n */\r\nfunction createNetwork(\r\n  container: HTMLElement,\r\n  nodes: GraphNode[],\r\n  edges: GraphEdge[],\r\n  props: GraphVisualizationProps\r\n): VisNetwork {\r\n  // Deduplicate nodes by ID (keep first occurrence)\r\n  const seenNodeIds = new Set<string>();\r\n  const uniqueNodes = nodes.filter(node => {\r\n    if (seenNodeIds.has(node.id)) {\r\n      console.warn('[GraphVisualization] Skipping duplicate node:', node.id);\r\n      return false;\r\n    }\r\n    seenNodeIds.add(node.id);\r\n    return true;\r\n  });\r\n  \r\n  // Transform nodes for vis.js with avatar support\r\n  const visNodes = uniqueNodes.map(node => {\r\n    const props = (node.properties || {}) as Record<string, unknown>;\r\n    const avatarUrl = node.avatarUrl || node.photoUrl || \r\n      props.avatar_url || props.photo_url || props.avatarUrl || props.photoUrl;\r\n    \r\n    const isPerson = node.type === 'Person';\r\n    const color = TYPE_COLORS[node.type] || '#6b7280';\r\n    \r\n    // For Person nodes, prioritize name from properties; for others use label\r\n    const displayName = isPerson \r\n      ? (node.name || props.name || node.label || node.id)\r\n      : (node.name || node.label || props.title || props.content?.toString().substring(0, 30) || node.id);\r\n    const label = String(displayName);\r\n    const initials = getInitials(label);\r\n\r\n    return {\r\n      id: node.id,\r\n      label: label.length > 25 ? label.substring(0, 22) + '...' : label,\r\n      title: createTooltip(node),\r\n      color: {\r\n        background: color,\r\n        border: color,\r\n        highlight: {\r\n          background: adjustColor(color, 20),\r\n          border: adjustColor(color, -20),\r\n        },\r\n        hover: {\r\n          background: adjustColor(color, 10),\r\n          border: adjustColor(color, -10),\r\n        },\r\n      },\r\n      shape: isPerson && avatarUrl ? 'circularImage' : 'dot',\r\n      image: isPerson && avatarUrl ? avatarUrl : undefined,\r\n      size: getNodeSize(node),\r\n      font: {\r\n        size: 12,\r\n        color: getTextColor(),\r\n        face: 'Inter, -apple-system, system-ui, sans-serif',\r\n      },\r\n      borderWidth: 2,\r\n      borderWidthSelected: 4,\r\n      // Store original data\r\n      _data: node,\r\n    };\r\n  });\r\n\r\n  // Deduplicate edges by ID\r\n  const seenEdgeIds = new Set<string>();\r\n  const uniqueEdges = edges.filter(edge => {\r\n    const edgeId = edge.id || `${edge.source}-${edge.target}-${edge.type}`;\r\n    if (seenEdgeIds.has(edgeId)) {\r\n      return false;\r\n    }\r\n    seenEdgeIds.add(edgeId);\r\n    return true;\r\n  });\r\n  \r\n  // Transform edges for vis.js\r\n  const visEdges = uniqueEdges.map(edge => ({\r\n    id: edge.id,\r\n    from: edge.source,\r\n    to: edge.target,\r\n    label: edge.label,\r\n    title: `${edge.type}`,\r\n    color: {\r\n      color: 'rgba(156, 163, 175, 0.6)',\r\n      highlight: 'rgba(99, 102, 241, 0.8)',\r\n      hover: 'rgba(99, 102, 241, 0.6)',\r\n    },\r\n    arrows: {\r\n      to: {\r\n        enabled: true,\r\n        scaleFactor: 0.5,\r\n      },\r\n    },\r\n    font: {\r\n      size: 10,\r\n      color: 'rgba(156, 163, 175, 0.8)',\r\n      strokeWidth: 0,\r\n      align: 'middle',\r\n    },\r\n    smooth: {\r\n      type: 'continuous',\r\n      roundness: 0.5,\r\n    },\r\n    width: 1,\r\n    selectionWidth: 2,\r\n    _data: edge,\r\n  }));\r\n\r\n  const options = {\r\n    nodes: {\r\n      borderWidth: 2,\r\n      shadow: {\r\n        enabled: true,\r\n        color: 'rgba(0,0,0,0.1)',\r\n        size: 5,\r\n        x: 2,\r\n        y: 2,\r\n      },\r\n    },\r\n    edges: {\r\n      width: 1,\r\n      shadow: false,\r\n    },\r\n    physics: {\r\n      enabled: true,\r\n      stabilization: {\r\n        enabled: true,\r\n        iterations: 100,\r\n        updateInterval: 25,\r\n      },\r\n      barnesHut: {\r\n        gravitationalConstant: -3000,\r\n        centralGravity: 0.3,\r\n        springLength: 120,\r\n        springConstant: 0.04,\r\n        damping: 0.09,\r\n      },\r\n    },\r\n    interaction: {\r\n      hover: true,\r\n      tooltipDelay: 200,\r\n      hideEdgesOnDrag: true,\r\n      hideEdgesOnZoom: true,\r\n      multiselect: true,\r\n      navigationButtons: false,\r\n      keyboard: {\r\n        enabled: true,\r\n        bindToWindow: false,\r\n      },\r\n    },\r\n    layout: {\r\n      improvedLayout: true,\r\n      hierarchical: false,\r\n    },\r\n  };\r\n\r\n  const vis = getVis()!;\r\n  const network = new vis.Network(\r\n    container,\r\n    {\r\n      nodes: new vis.DataSet(visNodes),\r\n      edges: new vis.DataSet(visEdges),\r\n    },\r\n    options\r\n  );\r\n\r\n  // Bind events\r\n  network.on('click', (params: { nodes: string[]; edges: string[] }) => {\r\n    if (params.nodes.length > 0) {\r\n      const nodeId = params.nodes[0];\r\n      const node = nodes.find(n => n.id === nodeId);\r\n      if (node && props.onNodeClick) {\r\n        props.onNodeClick(node);\r\n      }\r\n    }\r\n    // Hide context menu\r\n    const contextMenu = container.closest('.graph-visualization-container')?.querySelector('#viz-context-menu');\r\n    if (contextMenu) contextMenu.classList.add('hidden');\r\n  });\r\n\r\n  network.on('doubleClick', (params: { nodes: string[] }) => {\r\n    if (params.nodes.length > 0) {\r\n      const nodeId = params.nodes[0];\r\n      const node = nodes.find(n => n.id === nodeId);\r\n      if (node && props.onNodeDoubleClick) {\r\n        props.onNodeDoubleClick(node);\r\n      }\r\n    }\r\n  });\r\n\r\n  network.on('oncontext', (params: { nodes: string[]; pointer: { DOM: { x: number; y: number } }; event: Event }) => {\r\n    params.event.preventDefault();\r\n    if (params.nodes.length > 0) {\r\n      showContextMenu(container, params.pointer.DOM.x, params.pointer.DOM.y, params.nodes[0], nodes);\r\n    }\r\n  });\r\n\r\n  network.on('hoverNode', (params: { node: string }) => {\r\n    const node = nodes.find(n => n.id === params.node);\r\n    if (node) {\r\n      showHoverCard(container, node);\r\n    }\r\n  });\r\n\r\n  network.on('blurNode', () => {\r\n    hideHoverCard(container);\r\n  });\r\n\r\n  network.on('stabilizationProgress', (params: { iterations: number; total: number }) => {\r\n    const status = container.closest('.graph-visualization-container')?.querySelector('#viz-status');\r\n    if (status) {\r\n      const progress = Math.round((params.iterations / params.total) * 100);\r\n      status.textContent = `Stabilizing... ${progress}%`;\r\n    }\r\n  });\r\n\r\n  network.on('stabilizationIterationsDone', () => {\r\n    const status = container.closest('.graph-visualization-container')?.querySelector('#viz-status');\r\n    if (status) {\r\n      status.textContent = `${nodes.length} nodes • ${edges.length} edges`;\r\n    }\r\n  });\r\n\r\n  return network;\r\n}\r\n\r\n/**\r\n * Bind toolbar actions\r\n */\r\nfunction bindToolbarActions(container: HTMLElement, network: VisNetwork): void {\r\n  const btnZoomIn = container.querySelector('#viz-zoom-in');\r\n  const btnZoomOut = container.querySelector('#viz-zoom-out');\r\n  const btnFit = container.querySelector('#viz-fit');\r\n  const btnPhysics = container.querySelector('#viz-physics');\r\n  const btnScreenshot = container.querySelector('#viz-screenshot');\r\n  const btnMinimap = container.querySelector('#viz-minimap-toggle');\r\n\r\n  let physicsEnabled = true;\r\n\r\n  if (btnZoomIn) {\r\n    on(btnZoomIn as HTMLElement, 'click', () => {\r\n      const scale = network.getScale();\r\n      network.moveTo({ scale: scale * 1.3, animation: true });\r\n    });\r\n  }\r\n\r\n  if (btnZoomOut) {\r\n    on(btnZoomOut as HTMLElement, 'click', () => {\r\n      const scale = network.getScale();\r\n      network.moveTo({ scale: scale / 1.3, animation: true });\r\n    });\r\n  }\r\n\r\n  if (btnFit) {\r\n    on(btnFit as HTMLElement, 'click', () => {\r\n      network.fit({ animation: true });\r\n    });\r\n  }\r\n\r\n  if (btnPhysics) {\r\n    on(btnPhysics as HTMLElement, 'click', () => {\r\n      physicsEnabled = !physicsEnabled;\r\n      // Note: vis.js doesn't have a simple toggle, would need to recreate network\r\n      btnPhysics.classList.toggle('active', physicsEnabled);\r\n      toast.info(physicsEnabled ? 'Physics enabled' : 'Physics disabled');\r\n    });\r\n  }\r\n\r\n  if (btnScreenshot) {\r\n    on(btnScreenshot as HTMLElement, 'click', () => {\r\n      const canvas = container.querySelector('canvas');\r\n      if (canvas) {\r\n        const link = document.createElement('a');\r\n        link.download = `graph-${Date.now()}.png`;\r\n        link.href = canvas.toDataURL('image/png');\r\n        link.click();\r\n        toast.success('Screenshot saved');\r\n      }\r\n    });\r\n  }\r\n\r\n  if (btnMinimap) {\r\n    on(btnMinimap as HTMLElement, 'click', () => {\r\n      const minimap = container.querySelector('#viz-minimap');\r\n      if (minimap) {\r\n        minimap.classList.toggle('hidden');\r\n        btnMinimap.classList.toggle('active');\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Show context menu\r\n */\r\nfunction showContextMenu(\r\n  container: HTMLElement,\r\n  x: number,\r\n  y: number,\r\n  nodeId: string,\r\n  nodes: GraphNode[]\r\n): void {\r\n  const menu = container.closest('.graph-visualization-container')?.querySelector('#viz-context-menu') as HTMLElement;\r\n  if (!menu) return;\r\n\r\n  menu.style.left = `${x}px`;\r\n  menu.style.top = `${y}px`;\r\n  menu.classList.remove('hidden');\r\n  menu.setAttribute('data-node-id', nodeId);\r\n\r\n  // Bind menu actions\r\n  const items = menu.querySelectorAll('.context-menu-item');\r\n  items.forEach(item => {\r\n    const newItem = item.cloneNode(true) as HTMLElement;\r\n    item.parentNode?.replaceChild(newItem, item);\r\n    \r\n    on(newItem, 'click', () => {\r\n      const action = newItem.getAttribute('data-action');\r\n      const node = nodes.find(n => n.id === nodeId);\r\n      handleContextAction(action || '', node, container);\r\n      menu.classList.add('hidden');\r\n    });\r\n  });\r\n\r\n  // Close on outside click\r\n  setTimeout(() => {\r\n    const closeHandler = (e: Event) => {\r\n      if (!menu.contains(e.target as Node)) {\r\n        menu.classList.add('hidden');\r\n        document.removeEventListener('click', closeHandler);\r\n      }\r\n    };\r\n    document.addEventListener('click', closeHandler);\r\n  }, 100);\r\n}\r\n\r\n/**\r\n * Handle context menu action\r\n */\r\nasync function handleContextAction(action: string, node: GraphNode | undefined, container: HTMLElement): Promise<void> {\r\n  if (!node) return;\r\n\r\n  switch (action) {\r\n    case 'expand':\r\n      toast.info(`Expanding connections for ${node.label || node.name}`);\r\n      // TODO: Load and add connected nodes\r\n      break;\r\n    case 'focus':\r\n      toast.info(`Focusing on ${node.label || node.name}`);\r\n      // TODO: Center and zoom to node\r\n      break;\r\n    case 'hide':\r\n      toast.info(`Hiding ${node.label || node.name}`);\r\n      // TODO: Remove node from visualization\r\n      break;\r\n    case 'bookmark':\r\n      await graphService.addBookmark({\r\n        node_id: node.id,\r\n        node_type: node.type,\r\n        node_label: node.label || node.name || node.id,\r\n        node_avatar_url: node.avatarUrl || node.photoUrl,\r\n        sort_order: 0,\r\n      });\r\n      toast.success('Bookmark added');\r\n      break;\r\n    case 'annotate':\r\n      const note = prompt('Add a note for this node:');\r\n      if (note) {\r\n        await graphService.createAnnotation({\r\n          target_type: 'node',\r\n          target_id: node.id,\r\n          target_label: node.label || node.name,\r\n          content: note,\r\n          annotation_type: 'note',\r\n          is_shared: false,\r\n          is_resolved: false,\r\n        });\r\n        toast.success('Note added');\r\n      }\r\n      break;\r\n    case 'ai-explain':\r\n      toast.info('Generating AI explanation...');\r\n      // TODO: Call AI explain endpoint\r\n      break;\r\n  }\r\n}\r\n\r\n/**\r\n * Show hover card\r\n */\r\nfunction showHoverCard(container: HTMLElement, node: GraphNode): void {\r\n  const card = container.closest('.graph-visualization-container')?.querySelector('#viz-hover-card') as HTMLElement;\r\n  if (!card) return;\r\n\r\n  const avatarUrl = node.avatarUrl || node.photoUrl || \r\n    (node.properties as Record<string, unknown>)?.avatar_url || \r\n    (node.properties as Record<string, unknown>)?.photo_url;\r\n  const role = node.role || (node.properties as Record<string, unknown>)?.role;\r\n  const org = node.organization || (node.properties as Record<string, unknown>)?.organization;\r\n\r\n  card.innerHTML = `\r\n    <div class=\"hover-card-content\">\r\n      ${avatarUrl \r\n        ? `<img class=\"hover-avatar\" src=\"${avatarUrl}\" alt=\"\" onerror=\"this.style.display='none'\">`\r\n        : `<div class=\"hover-avatar hover-avatar-placeholder\" style=\"background: ${TYPE_COLORS[node.type] || '#6b7280'}\">${getInitials(node.label || node.name || '?')}</div>`\r\n      }\r\n      <div class=\"hover-info\">\r\n        <div class=\"hover-name\">${escapeHtml(node.label || node.name || node.id)}</div>\r\n        <div class=\"hover-type\" style=\"color: ${TYPE_COLORS[node.type] || '#6b7280'}\">${node.type}</div>\r\n        ${role ? `<div class=\"hover-role\">${escapeHtml(String(role))}</div>` : ''}\r\n        ${org ? `<div class=\"hover-org\">@ ${escapeHtml(String(org))}</div>` : ''}\r\n      </div>\r\n      ${node.connections ? `<div class=\"hover-stat\">${node.connections} connections</div>` : ''}\r\n    </div>\r\n  `;\r\n\r\n  card.classList.remove('hidden');\r\n}\r\n\r\n/**\r\n * Hide hover card\r\n */\r\nfunction hideHoverCard(container: HTMLElement): void {\r\n  const card = container.closest('.graph-visualization-container')?.querySelector('#viz-hover-card');\r\n  if (card) {\r\n    card.classList.add('hidden');\r\n  }\r\n}\r\n\r\n/**\r\n * Render legend\r\n */\r\nfunction renderLegend(container: HTMLElement, nodes: GraphNode[]): void {\r\n  const legend = container.querySelector('#viz-legend');\r\n  if (!legend) return;\r\n\r\n  // Count by type\r\n  const typeCounts: Record<string, number> = {};\r\n  nodes.forEach(node => {\r\n    typeCounts[node.type] = (typeCounts[node.type] || 0) + 1;\r\n  });\r\n\r\n  const sortedTypes = Object.entries(typeCounts)\r\n    .sort((a, b) => b[1] - a[1])\r\n    .slice(0, 8);\r\n\r\n  legend.innerHTML = `\r\n    <div class=\"legend-title\">Entity Types</div>\r\n    <div class=\"legend-items\">\r\n      ${sortedTypes.map(([type, count]) => `\r\n        <div class=\"legend-item\">\r\n          <span class=\"legend-color\" style=\"background: ${TYPE_COLORS[type] || '#6b7280'}\"></span>\r\n          <span class=\"legend-label\">${type}</span>\r\n          <span class=\"legend-count\">${count}</span>\r\n        </div>\r\n      `).join('')}\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Create tooltip content (plain text - vis.js escapes HTML)\r\n */\r\nfunction createTooltip(node: GraphNode): string {\r\n  const props = (node.properties || {}) as Record<string, unknown>;\r\n  const name = node.name || props.name || node.label || node.id;\r\n  const role = node.role || props.role;\r\n  const org = node.organization || props.organization;\r\n  const content = props.content ? String(props.content).substring(0, 100) : null;\r\n  \r\n  const lines: string[] = [];\r\n  lines.push(String(name));\r\n  lines.push(`[${node.type}]`);\r\n  if (role) lines.push(String(role));\r\n  if (org) lines.push(`@ ${org}`);\r\n  if (content && node.type !== 'Person') lines.push(`\"${content}...\"`);\r\n  \r\n  return lines.join('\\n');\r\n}\r\n\r\n/**\r\n * Get node size based on connections\r\n */\r\nfunction getNodeSize(node: GraphNode): number {\r\n  const connections = node.connections || 1;\r\n  return Math.min(15 + connections * 2, 40);\r\n}\r\n\r\n/**\r\n * Get initials from name\r\n */\r\nfunction getInitials(name: string): string {\r\n  return name\r\n    .split(' ')\r\n    .map(part => part.charAt(0))\r\n    .join('')\r\n    .substring(0, 2)\r\n    .toUpperCase();\r\n}\r\n\r\n/**\r\n * Adjust color brightness\r\n */\r\nfunction adjustColor(color: string, amount: number): string {\r\n  const hex = color.replace('#', '');\r\n  const r = Math.max(0, Math.min(255, parseInt(hex.substring(0, 2), 16) + amount));\r\n  const g = Math.max(0, Math.min(255, parseInt(hex.substring(2, 4), 16) + amount));\r\n  const b = Math.max(0, Math.min(255, parseInt(hex.substring(4, 6), 16) + amount));\r\n  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;\r\n}\r\n\r\n/**\r\n * Get text color based on theme\r\n */\r\nfunction getTextColor(): string {\r\n  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';\r\n  return isDark ? '#e5e7eb' : '#374151';\r\n}\r\n\r\n/**\r\n * Escape HTML\r\n */\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\nexport default createGraphVisualization;\r\n"],"names":["getVis","TYPE_COLORS","createGraphVisualization","props","height","container","createElement","initVisualization","canvas","statusEl","loadVisJs","data","graphService","syncBtn","on","toast","network","createNetwork","bindToolbarActions","renderLegend","error","resolve","script","nodes","edges","seenNodeIds","visNodes","node","avatarUrl","isPerson","color","displayName","label","getInitials","createTooltip","adjustColor","getNodeSize","getTextColor","seenEdgeIds","visEdges","edge","edgeId","options","vis","params","nodeId","n","contextMenu","showContextMenu","showHoverCard","hideHoverCard","status","progress","btnZoomIn","btnZoomOut","btnFit","btnPhysics","btnScreenshot","btnMinimap","physicsEnabled","scale","link","minimap","x","y","menu","item","newItem","action","handleContextAction","closeHandler","e","note","card","role","org","escapeHtml","legend","typeCounts","sortedTypes","a","b","type","count","name","content","lines","connections","part","amount","hex","r","g","text","div"],"mappings":"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"}